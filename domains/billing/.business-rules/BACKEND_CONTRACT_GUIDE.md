# Billing Backend Contract Guide

**Version:** 1.0 (CAP:092 - OpenAPI validated)
**Audience:** Backend developers, Frontend developers, API consumers
**Last Updated:** 2026-02-07
**Status:** Confirmed from pos-invoice OpenAPI specification

---

## Overview

This guide defines the backend contracts for **Billing Rules** (CAP:092).

**Service topology (current intent):**

- **System of record:** `pos-invoice` owns billing rules and persistence.
- **Facade/provider:** `pos-customer` reads billing rules for a party/customer and exposes them under the CRM namespace.
- **Consumer:** `pos-workorder` (WorkExec) calls the CRM facade when enforcing billing-related constraints (e.g., PO requirement at estimate approval).

This guide is derived from CAP:092 story endpoint definitions (no OpenAPI is available for `pos-invoice` yet).

---

## Conventions

- **API Gateway base URL:** `http://api-gateway.local/invoice`
- **Versioning:** `/v1/billing/...`
- **Error envelope:** `{ code, message, correlationId, fieldErrors[] }`
- **Idempotency:** Mutations accept `Idempotency-Key` header (recommended)
- **Authentication:** Bearer JWT token (Authorization header)
- **Gateway routing:** `/invoice/**` with StripPrefix=1 filter
- **Field naming:** camelCase for JSON properties
- **Timestamps:** ISO 8601 date-time format

---

## Domain Model

### BillingRules

Billing rules are authored per party/customer (commercial account) and consumed by downstream domains.

```ts
interface BillingRulesDTO {
  id?: string;                              // UUID (read-only, generated by server)
  partyId: string;                          // Party/Customer ID (required)
  purchaseOrderRequired: boolean;           // Default: false
  paymentTermsCode: string;                 // e.g., NET30, NET60, DUE_ON_RECEIPT (required)
  invoiceDeliveryMethod: InvoiceDeliveryMethod;  // Required
  invoiceGroupingStrategy: InvoiceGroupingStrategy;  // Required
  version?: number;                         // Optimistic locking version (read-only)
  createdAt?: string;                       // ISO 8601 timestamp (read-only)
  updatedAt?: string;                       // ISO 8601 timestamp (read-only)
  updatedBy?: string;                       // User ID who last updated (read-only)
}

type InvoiceDeliveryMethod = "EMAIL" | "PORTAL" | "MAIL";
type InvoiceGroupingStrategy = "PER_WORKORDER" | "PER_VEHICLE" | "SINGLE_INVOICE";
```

Notes:

- Downstream domains MUST treat billing rules as **authoritative** when present.
- If no rules exist, consumers SHOULD fall back to safe defaults (see WorkExec addendum for CAP:092).
- The `version` field enables optimistic locking for concurrent updates.
- Read-only fields (`id`, `version`, `createdAt`, `updatedAt`, `updatedBy`) are managed by the server.

---

## API Endpoints (Draft)

### GET http://api-gateway.local/invoice/v1/billing/rules/{partyId}

**Summary:** Get billing rules for a party/customer.

**Description:** Retrieve the current billing rules configuration for a commercial account.

**Operation ID:** `getBillingRules`

**Path params:**
- `partyId` (string, required) — Party/Customer ID

**Headers:**
- `Authorization: Bearer <token>` (required) — JWT authentication

**Responses:**
- `200 OK`: Returns `BillingRulesDTO`
  ```json
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "partyId": "12345",
    "purchaseOrderRequired": true,
    "paymentTermsCode": "NET30",
    "invoiceDeliveryMethod": "EMAIL",
    "invoiceGroupingStrategy": "PER_WORKORDER",
    "version": 1,
    "createdAt": "2026-01-15T10:30:00Z",
    "updatedAt": "2026-02-01T14:20:00Z",
    "updatedBy": "admin-user"
  }
  ```
- `404 Not Found`: No billing rules configured for this party

---

### PUT http://api-gateway.local/invoice/v1/billing/rules/{partyId}

**Summary:** Create or update billing rules.

**Description:** Idempotent upsert of billing rules for a commercial account. Creates new rules if none exist, or updates existing rules.

**Operation ID:** `upsertBillingRules`

**Path params:**
- `partyId` (string, required) — Party/Customer ID

**Headers:**
- `Authorization: Bearer <token>` (required) — JWT authentication
- `X-User-Id` (optional, default: "api-user") — User ID performing the operation
- `Idempotency-Key` (optional but recommended) — For idempotent retries

**Request body:** `BillingRulesDTO` (required)
```json
{
  "partyId": "12345",
  "purchaseOrderRequired": true,
  "paymentTermsCode": "NET30",
  "invoiceDeliveryMethod": "EMAIL",
  "invoiceGroupingStrategy": "PER_WORKORDER"
}
```

**Required fields:**
- `partyId`
- `paymentTermsCode`
- `invoiceDeliveryMethod`
- `invoiceGroupingStrategy`

**Note:** Server may ignore/override `partyId` in body and use the path parameter value. Read-only fields (`id`, `version`, timestamps) are ignored in request body.

**Responses:**
- `200 OK`: Billing rules updated (returns updated `BillingRulesDTO`)
- `201 Created`: Billing rules created (returns new `BillingRulesDTO`)
- `400 Bad Request`: Invalid billing rules data (validation error)

---

## Cross-Domain Dependency

### CRM Facade Contract

The CRM domain exposes a facade for billing rules under:

- `GET http://api-gateway.local/customer/v1/crm/accounts/parties/{partyId}/billingRules`

This endpoint is documented in the CRM contract guide and is expected to call `pos-invoice` internally.

### WorkExec Integration

The WorkExec domain (`pos-workorder`) consumes billing rules through the CRM facade when enforcing billing-related constraints:

- **Purchase order requirement validation** at estimate approval time
- **Payment terms** for commercial accounts
- **Invoice grouping** strategy enforcement

---

## Validation Rules (Confirmed from OpenAPI)

### Required Fields

The following fields are required for billing rules:
- `partyId` — Must be a valid party/customer identifier
- `paymentTermsCode` — Must be a recognized payment terms code (e.g., NET30, NET60, DUE_ON_RECEIPT)
- `invoiceDeliveryMethod` — Must be one of: EMAIL, PORTAL, MAIL
- `invoiceGroupingStrategy` — Must be one of: PER_WORKORDER, PER_VEHICLE, SINGLE_INVOICE

### Optional Fields

- `purchaseOrderRequired` — Defaults to `false` if not provided

### Read-Only Fields

The following fields are managed by the server and ignored in request bodies:
- `id` — Generated UUID
- `version` — Optimistic locking version number
- `createdAt` — Timestamp when rules were created
- `updatedAt` — Timestamp when rules were last updated
- `updatedBy` — User ID who last updated the rules

---

## Gateway Routing

The API Gateway routes billing requests to `pos-invoice` service:

- **Gateway path:** `/invoice/**`
- **Filter:** StripPrefix=1
- **Service discovery:** `lb://INVOICE` (Eureka service name)
- **Transformation:** `/invoice/v1/billing/rules/{partyId}` → service receives `/v1/billing/rules/{partyId}`

---

## Status

✅ **Backend discovery complete** — OpenAPI specification validated from pos-invoice service (February 7, 2026)
