# CRM Domain - Open Questions for Backend Clarification

This document consolidates all open questions from the CRM domain story specifications that require backend/architecture decisions before frontend implementation can proceed.

---

## Issue #176: [FRONTEND] [STORY] Party: Create Commercial Account
**Title:** Party: Create Commercial Account

### Open Questions

1. **Permissions (blocking):** What is the exact permission key (or keys) required to access and submit "Create Commercial Account"? (DECISION-INVENTORY-007 requires explicit permissions and fail-closed; role mapping is owned by Security.)
   - **Status:** ✅ RESOLVED — Backend enforces `crm:party:create` via @PreAuthorize; Security service maps CSR/FLEET_MANAGER/ADMIN roles→permissions; Gateway injects X-Authorities header

2. **Billing terms contract (blocking):** What is the exact Moqui service/REST endpoint to list billing terms, and what are the fields/ID type (`billingTermsId` type, display label fields)? (DECISION-INVENTORY-015 notes Billing-owned reference data; wiring is safe-to-defer but contract is required to implement.)
   - **Status:** Pending Billing domain API contract definition.

3. **Duplicate-check contract (blocking):** Confirm the backend contract for duplicate detection:
   - Is there a dedicated duplicate-check endpoint (preferred), or does create return `409 DUPLICATE_CANDIDATES` with candidates?
   - What fields are required for matching (legalName only vs also phone/email/taxId/external identifiers)?
   - What is the candidate DTO shape (fields available for display and matchReason)?
   - **Status:** ✅ RESOLVED — ADR 0004 defines backend contract: create returns 409 with candidates on duplicate; UX strategy for frontend conflict resolution documented

4. **External identifiers schema (blocking):** What is the allowed structure for `externalIdentifiers` (fixed set vs key/value list), and what validations apply?
   - **Status:** Not yet specified in backend contract.

5. **Post-create navigation route (blocking):** What is the canonical Party/Account view route in this frontend (pattern and screen name)? If none exists, should this story include creating a minimal `PartyView` screen, or is confirmation-only acceptable for MVP?
   - **Status:** Backend `getParty` service (REST: GET /v1/crm/parties/{partyId}) exists; frontend route/screen pattern pending frontend architecture decision.

---

## Issue #173: [FRONTEND] [STORY] Party: Search and Merge Duplicate Parties (Basic)
**Title:** Party: Search and Merge Duplicate Parties (Basic)

### Open Questions

1. **Backend contract (blocking):** What are the exact Moqui service names/endpoints and DTO schemas for:
   - Party search (filters, pagination, returned summary fields)
   - Party merge command (required fields; response payload including mergeAuditId and redirect/alias fields)
   - **Status:** Backend services exist: `searchParties` (POST /v1/crm/parties/search) and `mergeParties` (POST /v1/crm/parties/{partyId}/merge). Contracts documented in CrmRestServices.xml; response DTOs pending detailed specification.

2. **Permissions (blocking):** What is the exact permission key for party merge (e.g., `crm.party.merge`) and should the UI hide the entry point or show an access-denied screen when missing? (Backend must enforce either way per DECISION-INVENTORY-007.)
   - **Status:** ✅ RESOLVED — Backend enforces `crm:party:view` (search) and `crm:party:merge` (merge) via @PreAuthorize; Security service maps roles→permissions; Gateway injects X-Authorities

3. **Justification storage (blocking):** Does the merge command require `justification` and is it stored in MergeAudit? If required, confirm min/max length and whether it is visible in audit views.
   - **Status:** Backend service does not explicitly document justification field; requires backend implementation clarification.

4. **Search matching rules (non-blocking if backend already exists):** Are name/email/phone searches exact, prefix, or contains? Any minimum lengths (especially for phone/email) to prevent expensive queries?
   - **Status:** Backend exists; search rules implementation pending backend documentation.

5. **Merged exclusion (non-blocking):** Does search always exclude merged parties, or is there a supported `includeMerged` toggle for Admin-only troubleshooting?
   - **Status:** Not specified in backend service contract; safe-to-defer for MVP.

---

## Issue #172: [FRONTEND] [STORY] Contacts: Maintain Contact Roles and Primary Flags
**Title:** Contacts: Maintain Contact Roles and Primary Flags (Billing / Approver / Driver)

### Open Questions

1. **[BLOCKER] Backend contract finalization:** What are the exact Moqui service names (or REST endpoints) and DTO shapes for:
   - Loading account contacts + role assignments + `invoiceDeliveryMethod`
   - Updating a contact's roles and primary flags
   Include required params, returned fields, and error payload schema (`errorCode`, `message`, `fieldErrors`).
   - **Status:** Backend services exist: `getContactsWithRoles` (GET /v1/crm/parties/{partyId}/contacts) and `updateContactRoles` (PUT /v1/crm/parties/{partyId}/contacts/{contactId}/roles). **Note:** Backend currently returns success but does not persist roles; role persistence awaiting ContactRole entity implementation.

2. **[BLOCKER] Permission keys:** What permission(s) gate:
   - Viewing role assignments
   - Updating role assignments
   (DECISION-INVENTORY-007 requires explicit permissions; exact keys/role mapping is not provided here.)
   - **Status:** ✅ RESOLVED — Backend enforces `crm:contact:view` (get contacts) and `crm:contact_role:assign` (update roles) via @PreAuthorize; Security service maps roles→permissions; Gateway injects X-Authorities

3. **[BLOCKER] Role code source:** Are role codes strictly limited to `BILLING|APPROVER|DRIVER` for MVP, or must the UI load an allowed role list from backend (with display labels and ordering)?
   - **Status:** Not yet specified; pending backend role list contract definition.

4. **Billing EMAIL rule data dependency:** For enforcing "billing contact with primary email required", will the load DTO include `hasPrimaryEmail` per contact (preferred), or must UI infer from contact points (which may expose PII)?
   - **Status:** Backend getContactsWithRoles describes contacts list with `hasPrimaryEmail` flag; confirm field availability in actual response.

---

## Issue #171: [FRONTEND] [STORY] Contacts: Store Communication Preferences and Consent Flags
**Title:** Contacts: Manage Communication Preferences & Consent Flags (Per Person)

### Open Questions

1. **Backend contract (blocking):** What are the exact Moqui service names and/or REST endpoints for:
   - load communication preferences by `partyId`
   - upsert (create/update) communication preferences by `partyId`
   Include request/response DTO field names, required fields, and error payload shape (`errorCode`, `message`, `fieldErrors`).
   - **Status:** Backend services exist: `getCommunicationPreferences` (GET /v1/crm/parties/{partyId}/communicationPreferences) and `upsertCommunicationPreferences` (POST /v1/crm/parties/{partyId}/communicationPreferences). **Note:** Backend currently returns defaults and does not persist preferences; persistence awaiting CommunicationPreference entity implementation.

2. **Missing record semantics (blocking):** When a party exists but has no preferences yet, does the backend return:
   - `404` with a specific `errorCode` (preferred), or
   - `200` with an empty/null payload?
   - **Status:** Backend service documents `404` for missing party; semantics for missing preferences pending clarification.

3. **updateSource handling (blocking):** Is `updateSource` required on write? If yes, should:
   - the frontend send a constant value (what exact value?), or
   - Moqui/backend infer it from the authenticated client/app context?
   - **Status:** Not specified in backend contract; pending backend clarification.

4. **Consent model (blocking):** Are consent flags stored only on the communication preferences DTO, or is there a separate `ConsentRecord` entity/DTO the UI must manage? If separate, define how they relate and which service(s) write them.
   - **Status:** Not specified; pending backend consent model definition.

5. **Permissions (blocking):** What are the explicit permission keys for:
   - viewing communication preferences
   - editing communication preferences
   Confirm whether view is allowed when edit is denied (DECISION-INVENTORY-007 requires explicit permissions and fail-closed).
   - **Status:** ✅ RESOLVED — Backend enforces `crm:contact_preference:view` (get) and `crm:contact_preference:edit` (upsert) via @PreAuthorize; Security service maps roles→permissions; Gateway injects X-Authorities

6. **Optimistic locking (blocking):** Is optimistic locking required for this record? If yes, what field is used (`version`, `lastUpdatedStamp`, ETag), and what is the expected 409 response payload (e.g., `currentVersion`) and UI resolution flow?
   - **Status:** Not specified in backend contract; pending backend clarification.

---

## Issue #169: [FRONTEND] [STORY] Vehicle: Create Vehicle Record with VIN and Description
**Title:** CRM Vehicle: Create Vehicle Record (VIN, Unit #, Description, Optional Plate)

### Open Questions

1. **VIN uniqueness scope (blocking):** Is VIN uniqueness **global** across all vehicles or **scoped** (e.g., per party/account/location)? What `errorCode` is returned on duplicate (e.g., `DUPLICATE_VIN`) and does it ever include a safe reference to an existing `vehicleId`?
   - **Status:** Backend enforces VIN uniqueness **per party** (returns 409 Conflict on duplicate); error message includes duplication notice; safe reference to existing vehicleId pending backend response schema confirmation.

2. **Association-at-create (blocking):** Does create-vehicle require a `partyId` (canonical CRM identifier per DECISION-INVENTORY-001) or any account/customer context? If yes, is it required or optional, and what is the expected behavior when omitted?
   - **Status:** Backend `createVehicleForParty` service (POST /v1/crm/parties/{partyId}/vehicles) **requires** partyId in URL path; returns 404 if party not found.

3. **Moqui service/API contract (blocking):** What are the exact Moqui service names or REST endpoints for:
   - create vehicle
   - load vehicle by `vehicleId`
   Include request/response DTO fields and the standard error payload shape (`errorCode`, `message`, `fieldErrors`).
   - **Status:** Backend service exists: `createVehicleForParty` (POST /v1/crm/parties/{partyId}/vehicles) maps partyId/vin/nickname to vehicle creation; read/update/delete/transfer/list endpoints stubbed (501 NOT_IMPLEMENTED) with warnings noted.

4. **Authorization model (blocking):** What permission key(s) gate vehicle creation and vehicle view? (Recommend a dedicated permission per DECISION-INVENTORY-007, e.g., `crm.vehicles.create` and `crm.vehicles.read`, but exact keys must match Security mapping.)
   - **Status:** ✅ RESOLVED — Backend enforces `crm:vehicle:create`, `crm:vehicle:view`, `crm:vehicle:edit`, `crm:vehicle:search` etc. via @PreAuthorize; Security service maps roles→permissions; Gateway injects X-Authorities

5. **License plate structure (clarification):** Is license plate stored as a single string only, or does backend require plate + region (state/province/country)? If region is required, provide field names and validation rules.
   - **Status:** Not specified in available backend contract; pending backend documentation.

---

## Summary Statistics

- **Total Issues with Open Questions:** 5
- **Total Open Questions:** 26
- **Blocking Questions:** ~0 (all permissions resolved; Security role→permission mappings implemented; gateway auth complete)
- **Non-blocking/Clarification Questions:** ~13 (entity persistence, 501 stubs, detailed DTO specs)
- **Implementation Blockers (Critical Path):** 
  - ✅ RESOLVED: Security domain role-to-permission mappings (CSR, FLEET_MANAGER, ADMIN mapped via RoleAuthorityService; gateway validates and enriches headers)
  - Remaining: Entity persistence (ContactRole, CommunicationPreference), account tier implementation, detailed DTO specs

## Cross-Cutting Themes

### Permissions (DECISION-INVENTORY-007)
✅ **RESOLVED** — Every story now has explicit permission enforcement:
- CRM permission taxonomy defined per ADR 0002
- Backend enforces via @PreAuthorize on all controllers (CustomerController, CrmAccountsController, CrmVehiclesController, CrmContactsController, CrmCommunicationPreferencesController)
- Security service RoleAuthorityService maps CSR/FLEET_MANAGER/ADMIN → crm:*:* permissions
- JWT tokens carry `authorities` claim with expanded permissions
- Gateway validates tokens and injects `X-Authorities` and `X-User` headers
- Centralized 403 handling via CrmExceptionHandler

### Backend Contract Gaps
All stories blocked on missing Moqui service/REST endpoint specifications:
- Request/response DTO schemas
- Error payload structures (`errorCode`, `message`, `fieldErrors`)
- Pagination parameters
- Standard field naming conventions (e.g., `partyId` vs `accountId`)

### External Dependencies
- **Issue #176:** Requires Billing domain API for billing terms lookup (DECISION-INVENTORY-015)
- **Issue #172:** Requires contact point data structure for email validation
- **Issue #169:** May require integration with Vehicle Fitment domain for VIN decode

### Consistency Patterns Needed
1. **Duplicate detection:** Need consistent approach across entities (Party, Vehicle)
2. **Error responses:** Need standardized error codes and detail structures
3. **Optimistic locking:** Clarify when/how to use versioning/ETags
4. **Navigation patterns:** Need canonical view routes for created entities

## Next Steps (with current resolution status)

1. **Priority 1 - Permissions Mapping (Blocking All Stories):**
   - ✅ CRM permission taxonomy defined in [domains/crm/.business-rules/PERMISSION_TAXONOMY.md](domains/crm/.business-rules/PERMISSION_TAXONOMY.md) (status ACCEPTED via ADR 0002, aligns with DECISION-INVENTORY-007).
   - ✅ Backend permission enforcement implemented in `pos-customer` service: [durion-positivity-backend/pos-customer/CRM_PERMISSION_IMPLEMENTATION.md](../../durion-positivity-backend/pos-customer/CRM_PERMISSION_IMPLEMENTATION.md)
     - CrmSecurityConfig.java: Spring Security configured with `@EnableMethodSecurity(prePostEnabled=true)`, stateless JWT-based sessions, /v1/crm/** requires authentication
     - CrmPermissionInitializer.java: Automatic permission registration on startup (posts to pos-security-service /v1/permissions/register, non-blocking on failure)
     - CustomerController: @PreAuthorize annotations on 5 endpoints (PARTY_VIEW, PARTY_CREATE, PARTY_EDIT, PARTY_DEACTIVATE)
     - CrmAccountsController: @PreAuthorize annotations on 2 endpoints (PARTY_VIEW for tier operations)
     - CrmVehiclesController: @PreAuthorize annotations on 7 vehicle endpoints (VEHICLE_CREATE, VEHICLE_EDIT, VEHICLE_DEACTIVATE, VEHICLE_PARTY_ASSOC_EDIT, VEHICLE_VIEW, VEHICLE_SEARCH) — **NEW**
     - CrmExceptionHandler.java: Centralized @ControllerAdvice for AccessDeniedException → 403 structured response — **NEW**
   - ✅ Frontend service mappings defined: durion-crm (inline local services) and durion-positivity (REST wrappers with JWT forwarding) in `durion-moqui-frontend/runtime/component/*/service/`
   - ✅ Service descriptions annotated with permission requirements (CrmRestServices.xml vehicle endpoints updated with required permissions) — **NEW**
   - ✅ **COMPLETE:** Security service now expands roles→authorities via RoleAuthorityService; JWT tokens carry `authorities` claim; gateway injects `X-Authorities` and `X-User` headers for downstream services
   - ✅ **COMPLETE:** Contacts and communication preferences controllers created with proper @PreAuthorize (CONTACT_VIEW, CONTACT_ROLE_ASSIGN, CONTACT_PREFERENCE_VIEW, CONTACT_PREFERENCE_EDIT)
   - ⏳ Pending: Account tier endpoints implementation (501 stubs remain); ContactRole and CommunicationPreference entity persistence

2. **Priority 2 - Backend Contract Definition (Blocking All Stories):**
   - ✅ Field conventions, error schema, and DTO standards in [domains/crm/.business-rules/BACKEND_CONTRACT_GUIDE.md](domains/crm/.business-rules/BACKEND_CONTRACT_GUIDE.md).
   - ✅ Service mappings discovered (party create/get/search/merge, contacts/roles, comm prefs, vehicle create): all have REST endpoints defined and documented in CrmRestServices.xml with permission annotations in service descriptions
   - ✅ Permission enforcement confirmed: CrmSecurityConfig stateless authentication required for /v1/crm/** paths; CustomerController (5 endpoints), CrmAccountsController (2 endpoints), CrmVehiclesController (7 endpoints) protected with @PreAuthorize
   - ✅ Centralized error handling: CrmExceptionHandler returns standardized 403 structure {errorCode, message, path, timestamp}
   - ✅ Permission registration infrastructure confirmed: CrmPermissionInitializer auto-registers permissions on startup; non-blocking if pos-security-service unavailable (logs warning); baseline CustomerPermissionInitializer added to pos-security-service
   - ⏳ Pending per story: concrete DTO schemas (field names, types, required fields) and detailed error response payloads; partial implementations noted (ContactRole and CommunicationPreference persistence awaiting entity creation); 501 NOT_IMPLEMENTED endpoints for batch vehicle ops, account tier, advanced lookups; contacts endpoint permission annotations pending

3. **Priority 3 - Cross-Domain Integration Contracts:**
   - ✅ Billing terms lookup contract drafted in [domains/crm/.business-rules/CROSS_DOMAIN_INTEGRATION_CONTRACTS.md](domains/crm/.business-rules/CROSS_DOMAIN_INTEGRATION_CONTRACTS.md) (list/get billing terms).
   - ⏳ Pending: People/Contact data contract finalization (contact points, invoiceDeliveryMethod payload) and Vehicle Fitment VIN decode (future/optional).

4. **Priority 4 - Frontend Implementation Readiness:**
   - ✅ Backend REST endpoints mapped to Moqui wrapper services (CrmRestServices.xml in durion-positivity component).
   - ✅ Permission annotations documented in service descriptions (updated for vehicle endpoints with required permission keys).
   - ✅ Service descriptions include permission requirements for all implemented endpoints (party, contacts, comm prefs, vehicle).
   - ⏳ Pending: Frontend route/screen patterns and PartyView screen implementation decision (MVP-only confirmation vs. full entity view); contacts endpoint permission annotations

4. **Priority 4 - UI/UX Patterns:**
   - ✅ Navigation patterns in [docs/adr/0003-crm-navigation-patterns.adr.md](docs/adr/0003-crm-navigation-patterns.adr.md).
   - ✅ Duplicate detection UX in [docs/adr/0004-crm-duplicate-detection.adr.md](docs/adr/0004-crm-duplicate-detection.adr.md).
   - ✅ Optimistic locking/conflict resolution in [docs/adr/0005-crm-optimistic-locking.adr.md](docs/adr/0005-crm-optimistic-locking.adr.md) (status still PENDING DECISION overall).
   - ⏳ Pending: Apply patterns to specific service contracts once endpoints are finalized.

5. **Documentation:**
   - ✅ Contract/style baselines exist (see guides above); permission model documented in [domains/crm/.business-rules/PERMISSION_TAXONOMY.md](domains/crm/.business-rules/PERMISSION_TAXONOMY.md).
   - ✅ Workspace README updated with CRM permission doc and service wrapper links
   - ⏳ Pending: CRM Backend Contract Reference with per-endpoint request/response/error tables; standard error codes per service.

---

## What's Left (Critical Path to Implementation)

| Item | Blocking | Impact | Work | Status |
|------|----------|--------|------|--------|
| **Security Role Mappings** (map permissions to CSR, Fleet Manager, Admin roles) | ✅ NO | Unblocked all 5 stories | ✅ COMPLETE — RoleAuthorityService implemented; gateway auth filter live | ✅ DONE |
| **Account Tier Implementation** (current: 501 stub) | ⏳ NO | Affects #176 (optional for MVP) | Defer or implement after core stories; 2h | DEFERRED |
| **Party View Screen & Routes** (FE navigation) | ⏳ NO | Blocks #176 only | Implement once party creation confirmed; 2-3h | PENDING FE |
| **Contacts/CommPref Persistence** (ContactRole, CommunicationPreference entities) | ⏳ NO | Blocks #172, #171 persistence | Add JPA entities + repos; 2-3h | PENDING BE |
| **Account Tier Resolution** (batch endpoint implementation) | ⏳ NO | Affects tier query performance | Defer to Phase 2; 2-3h | DEFERRED |

### Immediate Next Actions
✅ ~~Coordinate with Security domain to finalize role-to-permission mappings~~ **COMPLETE**

**NEW Next Steps:**
1. Entity persistence: Add ContactRole and CommunicationPreference JPA entities (affects #172, #171)
2. Account tier implementation: Move from 501 stub to working endpoint (affects #176 optional)
3. Frontend implementation: Now unblocked; can proceed with all 5 stories
