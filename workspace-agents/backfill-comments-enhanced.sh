#!/bin/bash

echo "üí¨ **ENHANCED COMMENT BACKFILL SCRIPT**"
echo "======================================"
echo ""

# Check if GITHUB_TOKEN is set
if [ -z "$GITHUB_TOKEN" ]; then
    echo "‚ùå GITHUB_TOKEN environment variable is not set"
    echo "   Please set it with: export GITHUB_TOKEN=your_token_here"
    exit 1
fi

echo "üîß Compiling Comment Backfill Agents..."
mvn compile -q

if [ $? -ne 0 ]; then
    echo "‚ùå Compilation failed"
    exit 1
fi

echo "‚úÖ Compilation successful"
echo ""

echo "üìã **COMMENT BACKFILL OPTIONS**"
echo "==============================="
echo ""
echo "Choose which backfill agent to run:"
echo ""
echo "1) üöÄ Simple Backfill Agent"
echo "   ‚Ä¢ Faster execution"
echo "   ‚Ä¢ Adds comments with search instructions for implementation issues"
echo "   ‚Ä¢ Recommended for quick backfill"
echo ""
echo "2) üîç Enhanced Backfill Agent"
echo "   ‚Ä¢ Searches for actual implementation issues"
echo "   ‚Ä¢ Includes direct links to frontend/backend issues when found"
echo "   ‚Ä¢ Takes longer but provides better comments"
echo ""
echo "3) üìä Check Status Only"
echo "   ‚Ä¢ Shows how many issues were processed"
echo "   ‚Ä¢ Shows current backfill status"
echo "   ‚Ä¢ No comments added"
echo ""

read -p "Enter your choice (1-3): " choice

case $choice in
    1)
        echo ""
        echo "üöÄ **SIMPLE BACKFILL AGENT SELECTED**"
        echo "====================================="
        echo ""
        echo "This will:"
        echo "  ‚Ä¢ Load processed issues from .github/orchestration/processed-issues.txt"
        echo "  ‚Ä¢ Add processing comments to all processed story issues"
        echo "  ‚Ä¢ Include search instructions for implementation issues"
        echo "  ‚Ä¢ Use 5 second delays between comments to prevent rate limits"
        echo ""
        
        read -p "Continue with Simple Backfill? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Cancelled by user"
            exit 0
        fi
        
        echo ""
        echo "üîÑ Running Simple Comment Backfill Agent..."
        java -cp target/classes CommentBackfillAgent $GITHUB_TOKEN
        ;;
        
    2)
        echo ""
        echo "üîç **ENHANCED BACKFILL AGENT SELECTED**"
        echo "======================================"
        echo ""
        echo "This will:"
        echo "  ‚Ä¢ Load processed issues from .github/orchestration/processed-issues.txt"
        echo "  ‚Ä¢ Search frontend and backend repositories for implementation issues"
        echo "  ‚Ä¢ Add processing comments with direct links when issues are found"
        echo "  ‚Ä¢ Use 5 second delays between comments to prevent rate limits"
        echo ""
        echo "‚ö†Ô∏è  Note: This takes longer due to repository searches"
        echo ""
        
        read -p "Continue with Enhanced Backfill? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Cancelled by user"
            exit 0
        fi
        
        echo ""
        echo "üîÑ Running Enhanced Comment Backfill Agent..."
        java -cp target/classes EnhancedCommentBackfillAgent $GITHUB_TOKEN
        ;;
        
    3)
        echo ""
        echo "üìä **CHECKING BACKFILL STATUS**"
        echo "==============================="
        echo ""
        
        if [ -f ".github/orchestration/processed-issues.txt" ]; then
            processed_count=$(wc -l < .github/orchestration/processed-issues.txt)
            echo "üìÇ Processed issues file found"
            echo "üìä Total processed issues: $processed_count"
            echo ""
            echo "üìã Recent processed issues:"
            tail -10 .github/orchestration/processed-issues.txt | while read issue; do
                echo "   ‚Ä¢ Issue #$issue"
            done
            echo ""
            echo "üí° To add comments to these issues, run this script again and choose option 1 or 2"
        else
            echo "‚ùå No processed issues file found at .github/orchestration/processed-issues.txt"
            echo "   This means no stories have been processed yet, or the file was moved/deleted"
        fi
        ;;
        
    *)
        echo "‚ùå Invalid choice. Please run the script again and choose 1, 2, or 3."
        exit 1
        ;;
esac

echo ""
echo "üèÅ Comment backfill script complete!"
echo ""
echo "üí° **Tips:**"
echo "   ‚Ä¢ If some comments failed, you can run this script again to retry"
echo "   ‚Ä¢ The agents automatically handle rate limits and wait appropriately"
echo "   ‚Ä¢ Comments include links to coordination documents"
echo "   ‚Ä¢ All comments are marked as generated by the Durion Workspace Agent"