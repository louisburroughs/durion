‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #260: [FRONTEND] [STORY] Cost: Store Supplier/Vendor Cost Tiers (Optional)
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Cost: Store Supplier/Vendor Cost Tiers (Optional)

### Primary Persona
Inventory Manager (or Purchasing Admin responsible for supplier purchasing costs)

### Business Value
Enable storing supplier-specific volume cost breaks for inventory items so downstream purchasing can select an accurate unit cost by ordered quantity, improving procurement decisions and cost accuracy.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Inventory Manager  
- **I want to** create, view, update, and delete optional supplier/vendor cost tiers for a specific inventory item  
- **So that** purchasing workflows can use quantity-based unit costs (price breaks) when building purchase orders and reporting.

### In-scope
- Frontend screens and forms to manage a supplier-item cost record and its tier rows (min/max quantity + unit cost).
- Client-side validation for tier structure (contiguous, non-overlapping, starts at 1) and numeric rules (positive costs, integer quantities).
- Moqui screen/actions wiring to backend endpoints via Moqui proxy (no direct Vue ‚Üí backend calls).
- Deterministic error mapping to field-level and form-level messages.
- Basic audit metadata display if returned by API (created/updated timestamps and user ids).

### Out-of-scope
- Purchase Order creation and selecting tier cost during PO line pricing (consumer behavior).
- Defining suppliers/vendors or inventory items (assumed existing).
- Cost valuation methods (WAC, etc.) beyond storing tiered purchase costs.
- Import/bulk upload of tiers.
- Any approval workflow for cost changes.

---

## 3. Actors & Stakeholders
- **Inventory Manager (Primary)**: maintains supplier/item purchasing costs and tiers.
- **Purchasing Users/System (Consumer)**: uses stored tier data when creating POs (separate story).
- **Accounting/Reporting (Downstream)**: benefits from more accurate purchase cost inputs.
- **System Admin/Security**: ensures only authorized users can edit purchasing cost data.

---

## 4. Preconditions & Dependencies
- User is authenticated (Moqui session).
- Authorization model exists in the app to:
  - determine whether the current user can view/edit cost tiers (permission string(s) TBD; see Open Questions).
- Supplier/Vendor exists in the system (source-of-truth is not defined in Inventory domain docs; assumed external to this story).
- Inventory Item (SKU) exists (product master is out of Inventory domain per Inventory rules).
- Backend provides APIs/services (via Moqui proxy) for:
  - listing supplier-item cost records for an item
  - loading a supplier-item cost record with tiers
  - creating/updating/deleting supplier-item cost record and tiers
- Currency handling:
  - Currency source-of-truth is not defined by Inventory domain rules; story assumes supplier currency determines display currency but requires confirmation (see Open Questions).
- Observability:
  - Requests should propagate `X-Correlation-Id` and show it in error technical details (DECISION-INVENTORY-012).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Inventory Item detail** screen: action ‚ÄúSupplier Costs‚Äù / ‚ÄúVendor Costs‚Äù.
- Optional secondary entry point: from **Supplier detail** screen: ‚ÄúItem Costs‚Äù (only if a Supplier module exists in this frontend; otherwise out-of-scope for v1 of this story).

### Screens to create/modify
1. **Modify** Inventory Item detail screen to include navigation to supplier costs list (contextual).
2. **New Screen**: `InventoryItemSupplierCostList`
   - Context: `itemId` (or `productSku` if that is the canonical identifier in the app; must be consistent across routes‚Äîsee Open Questions).
   - Shows supplier cost configurations for the item.
3. **New Screen**: `SupplierItemCostDetail`
   - Context: `itemId` + `supplierId` (or a single `supplierItemCostId` if backend uses that as primary key; see Open Questions).
   - View/edit tiers and optional base cost (if supported).

> Moqui pattern: list screen ‚Üí detail screen with transitions for create/update/delete; use forms with server-side actions and validation feedback.

### Navigation context
- Breadcrumb example: Inventory > Items > {item} > Supplier Costs > {supplier}
- Deep-linkable by IDs (exact route/query param names TBD; must follow app routing conventions).

### User workflows (happy + alternate)

**Happy path: create tiers**
1. User opens an item, navigates to Supplier Costs.
2. User clicks ‚ÄúAdd Supplier Cost‚Äù.
3. User selects a supplier from a picker (no free-text UUID entry).
4. User adds one or more tier rows (min/max quantity + unit cost).
5. User saves; UI shows success and returns to detail view.

**Alternate paths**
- Edit existing tiers: load tiers, modify rows, save.
- Delete supplier-item cost: delete record (and associated tiers).
- Read-only view: user can view but cannot edit if lacking permission.
- Validation assistance: UI auto-sorts tiers by `minQuantity` before save (if enabled) and shows structural validation errors inline.

---

## 6. Functional Behavior

### Triggers
- Enter `InventoryItemSupplierCostList` (load list for item).
- Click ‚ÄúAdd Supplier Cost‚Äù (open create flow).
- Enter `SupplierItemCostDetail` (load header + tiers).
- Click Save (create/update).
- Click Delete (delete supplier-item cost).

### UI actions
- Add tier row.
- Remove tier row.
- Edit tier row fields: `minQuantity`, `maxQuantity`, `unitCost`.
- Optional: ‚ÄúAuto-sort tiers‚Äù action (or auto-sort on save).
- Save.
- Cancel/back.

### State changes (UI)
- `idle` ‚Üí `loading` when fetching.
- `ready` ‚Üí `editing` when user changes any field.
- `editing` ‚Üí `saving` during submit (disable inputs and actions).
- `saving` ‚Üí `ready` on success (show toast).
- Any ‚Üí `error` on failure (show error banner; keep user inputs).

### Service interactions (via Moqui proxy; DECISION-INVENTORY-002)
- Load list: fetch supplier-item cost summaries for an item.
- Load detail: fetch supplier-item cost header + tiers.
- Save:
  - Prefer atomic create/update of the full tier set to avoid partial updates.
  - UI sends tiers as an ordered array; backend remains authoritative for validation.
- Delete:
  - Delete supplier-item cost record; backend deletes tiers as part of cascade.

---

## 7. Business Rules (Translated to UI Behavior)

> Note: Inventory domain rules provided do not define supplier cost tier policies. The tier rules below remain **blocking** until confirmed by the owning domain/back-end contract. UI will implement these rules only once confirmed. Until then, UI should rely on backend validation and show deterministic errors.

### Validation
**Client-side (only when confirmed by backend contract; otherwise minimal validation):**
- Required:
  - Supplier selection required.
  - Item context required (from route).
- Tier row field rules:
  - `minQuantity`: integer, >= 1
  - `maxQuantity`: integer, >= `minQuantity`, or null for open-ended final tier
  - `unitCost`: decimal > 0
- Tier set structural rules:
  - First tier must start at `minQuantity = 1`
  - Tiers must be contiguous (no gaps)
  - Tiers must not overlap
  - At most one open-ended tier, and it must be the last tier
- Uniqueness:
  - Only one supplier-item cost record per supplier+item pair.

**Minimal validation (safe to implement now):**
- Trim and require non-empty supplier selection.
- Require at least one tier row if tiers are mandatory; if tiers are optional, allow zero tiers only if backend supports baseCost-only (TBD).
- Validate numeric parsing and basic constraints (min >= 1, max >= min when present, unitCost > 0).

### Enable/disable rules
- Save disabled while:
  - required identifiers missing
  - form has client-side validation errors
  - request is in-flight
- If user lacks edit permission:
  - inputs disabled
  - hide Save/Delete
  - show ‚ÄúRead only‚Äù banner

### Visibility rules
- Currency display:
  - `currencyCode` displayed read-only if returned by API.
  - If currency is not returned, show ‚ÄúCurrency: ‚Äî‚Äù and rely on backend formatting rules (TBD).
- Base cost:
  - Show base cost field only if API returns/supports it (feature-detect by presence in payload or explicit metadata).

### Error messaging expectations (deterministic mapping; DECISION-INVENTORY-003, DECISION-INVENTORY-012)
- Field-level errors:
  - Map backend validation errors to specific tier row/field when backend provides a `field` path (e.g., `tiers[1].minQuantity`).
- Form-level errors:
  - `INVALID_TIER_STRUCTURE` (or equivalent) ‚Üí show banner: ‚ÄúTier ranges must start at 1, be contiguous, and not overlap.‚Äù
- Auth:
  - `401` ‚Üí redirect to login/session refresh per app convention; preserve return URL.
  - `403` ‚Üí show forbidden state: ‚ÄúYou do not have permission to manage supplier costs.‚Äù
- Not found:
  - `404` ‚Üí show ‚ÄúSupplier or item not found (may have been removed).‚Äù
- Conflict:
  - `409` ‚Üí show ‚ÄúThis record was modified by another user. Reload to continue.‚Äù and offer Reload.

---

## 8. Data Requirements

### Entities involved (frontend-facing)
> Names are conceptual; actual API field names must match backend contract (TBD).

- `Supplier` (reference, read-only):
  - `supplierId` (uuid/string)
  - `name` (string)
  - `currencyCode` (string, ISO-4217) (TBD source-of-truth)
- `InventoryItem` / `Product` (reference, read-only):
  - `itemId` or `productId` (uuid/string) (TBD)
  - `sku` or `productSku` (string) (TBD canonical identifier)
  - `description` (string)
- `SupplierItemCost`:
  - `supplierItemCostId` (uuid/string) (preferred)
  - `supplierId` (required)
  - `itemId` or `productId` (required)
  - `currencyCode` (required, read-only)
  - `baseCost` (decimal, optional; only if supported)
  - `createdAt`, `updatedAt` (timestamps, read-only)
  - `createdByUserId`, `updatedByUserId` (optional, read-only)
- `CostTier`:
  - `costTierId` (uuid/string) (optional if tiers are replaced atomically)
  - `minQuantity` (int, required)
  - `maxQuantity` (int|null, optional)
  - `unitCost` (decimal, required)

### Fields (type, required, defaults)
- `minQuantity`: integer; required; default for first row = 1 (UI convenience only).
- `maxQuantity`: integer|null; optional; default null for last row (UI convenience only).
- `unitCost`: decimal; required; no default.
- `baseCost`: decimal; optional; no default.

### Read-only vs editable by state/role
- Editable (with manage permission):
  - tiers fields
  - baseCost (if supported)
- Read-only:
  - supplier and item identifiers once record exists (to preserve uniqueness)
  - currencyCode
  - audit fields

### Derived/calculated fields
- Display-only tier range label:
  - If `maxQuantity` present: `${minQuantity}‚Äì${maxQuantity}`
  - Else: `${minQuantity}+`
- Validation summary list:
  - gaps/overlaps/start-at-1 issues (only if structural validation is implemented).

---

## 9. Service Contracts (Frontend Perspective)

> Inventory domain docs mandate Moqui proxy usage and deterministic error schema, but do not define cost-tier endpoints. Endpoint paths below are **TBD** and blocking.

### Load/view calls
- List supplier costs for an item:
  - `GET <TBD>` with `itemId` (or `productSku`) as query/path param
  - Response: list of supplier-item cost summaries (supplier name/id, currency, tier count, updatedAt)
- Load detail:
  - `GET <TBD>` by `supplierItemCostId` OR by composite key (`supplierId` + `itemId`)
  - Response: supplier-item cost header + `tiers[]`

### Create/update calls
- Create:
  - `POST <TBD>`
  - Body includes: `supplierId`, `itemId` (or `productSku`), optional `baseCost`, `tiers[]`
- Update:
  - `PUT <TBD>` (preferred: full replace) OR `PATCH <TBD>` (partial) ‚Äî **must be confirmed**
  - If full replace: backend treats `tiers[]` as authoritative replacement set.

### Delete calls
- Delete:
  - `DELETE <TBD>` by `supplierItemCostId` OR composite key

### Error handling expectations (DECISION-INVENTORY-003, DECISION-INVENTORY-012)
- All responses are plain JSON (no `{data: ...}` envelope).
- Deterministic error schema:
  - `code` (string)
  - `message` (string, safe to display)
  - optional `fieldErrors[]` with `field` and `message`
  - correlation id available via `X-Correlation-Id` header (echoed on errors)
- Status handling:
  - `400/422` validation errors map to fields when possible
  - `401` login redirect
  - `403` forbidden state
  - `404` not found
  - `409` conflict (optimistic locking) if supported
  - `5xx` generic error with retry

---

## 10. State Model & Transitions

### Allowed states
CRUD-only:
- `NotCreated` (no supplier-item cost exists for supplier+item)
- `Exists` (record exists)
- `Deleted` (after delete)

### Role-based transitions
- With manage permission:
  - `NotCreated` ‚Üí Create
  - `Exists` ‚Üí Update
  - `Exists` ‚Üí Delete
- Without manage permission:
  - View only

### UI behavior per state
- `NotCreated`:
  - show create form (supplier picker + tier editor)
  - Save enabled only when valid
- `Exists`:
  - show detail; allow edit/delete if authorized
- `Deleted`:
  - navigate back to list; show success toast

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- If structural validation is enabled:
  - Gap detected ‚Üí block save; show ‚ÄúTiers must be contiguous starting at 1.‚Äù
  - Overlap detected ‚Üí block save; show ‚ÄúTier ranges must not overlap.‚Äù
  - Max < Min ‚Üí field error on max.
  - Unit cost <= 0 ‚Üí field error on unit cost.

### Backend validation failures
- Backend returns `INVALID_TIER_STRUCTURE` (or equivalent):
  - keep user inputs intact
  - show banner with backend message
  - if backend provides field paths, highlight corresponding row/field

### Concurrency conflicts
- If backend returns `409`:
  - show modal with options:
    - Reload (discard local edits and refetch)
    - Cancel (keep local edits; remain in error state)
  - do not auto-merge

### Unauthorized access
- `403` on load:
  - show forbidden state; do not render sensitive data beyond what response already contained
- `403` on save/delete:
  - show forbidden toast/banner; keep user on page

### Empty states
- List empty:
  - show ‚ÄúNo supplier costs configured for this item.‚Äù
  - show ‚ÄúAdd Supplier Cost‚Äù if authorized; otherwise show read-only empty state

### Timeout / network failure
- Show loading indicator within 100ms.
- At 8 seconds without response, show timeout message with Retry (DECISION-INVENTORY-004 UX target; applied as a general UX pattern here).

---

## 12. Acceptance Criteria

### Scenario 1: View supplier cost list for an item
**Given** I am an authenticated user  
**And** I navigate to Supplier Costs for an existing item  
**When** the list loads successfully  
**Then** I see a list of suppliers with configured costs (or an empty state)  
**And** the UI does not require a total count to paginate (cursor pagination if provided).

### Scenario 2: Create a valid cost tier structure (when authorized)
**Given** I am an authenticated user with permission to manage supplier-item costs  
**And** an item exists  
**When** I create a supplier-item cost for a supplier with tiers that satisfy backend validation  
**Then** the system saves successfully  
**And** when I reload the detail view I see the saved tiers.

### Scenario 3: Prevent invalid numeric tier inputs before submit
**Given** I am editing supplier-item cost tiers  
**When** I enter a tier with `minQuantity < 1` or `unitCost <= 0` or `maxQuantity < minQuantity`  
**Then** the Save action is blocked  
**And** I see field-level validation messages for the invalid inputs.

### Scenario 4: Backend rejects invalid tier structure and UI preserves edits
**Given** I attempt to save tier data  
**And** the backend responds with a validation error code indicating invalid tier structure  
**When** the response is received  
**Then** the UI shows a non-destructive error banner  
**And** my entered tiers remain on screen for correction  
**And** the UI displays the `X-Correlation-Id` in technical details.

### Scenario 5: Read-only access without permission
**Given** I am authenticated but do not have permission to manage supplier-item costs  
**When** I open an existing supplier-item cost record  
**Then** I can view tiers and currency (if returned)  
**And** I cannot edit fields or save/delete changes  
**And** if I attempt a save/delete and receive 403, the UI shows a forbidden message without leaking additional data.

### Scenario 6: Delete a supplier-item cost (when authorized)
**Given** a supplier-item cost exists for a supplier and item  
**And** I have permission to manage supplier-item costs  
**When** I delete the supplier-item cost and confirm the action  
**Then** the record is removed  
**And** returning to the list no longer shows that supplier-item combination.

### Scenario 7: 401 handling
**Given** my session is expired  
**When** I attempt to load the supplier cost list or detail  
**Then** the UI routes me to login/session refresh per app convention  
**And** after re-authentication I can return to the same page.

---

## 13. Audit & Observability

### User-visible audit data
- On detail screen, display if present:
  - `createdAt`, `updatedAt`
  - `createdByUserId`, `updatedByUserId` (or display names if provided)
- No separate audit-log screen is required in this story.

### Status history
- Not applicable (no lifecycle state machine).

### Traceability expectations
- All requests include/propagate `X-Correlation-Id` and error UI surfaces it (DECISION-INVENTORY-012).
- Client telemetry/logging must avoid sensitive payloads:
  - Do not log full request/response bodies for cost tiers unless explicitly approved by security policy (not provided here).
  - Log only: endpoint name, success/failure, status code, correlation id, and timing.

---

## 14. Non-Functional UI Requirements
- **Performance**:
  - Show loading indicator within 100ms.
  - Timeout state at 8 seconds with Retry; no auto-retry loops.
- **Accessibility (WCAG 2.1)**:
  - Tier editor supports keyboard navigation.
  - Errors are associated with inputs via accessible descriptions.
  - Confirmation dialogs are focus-trapped and screen-reader friendly.
- **Responsiveness**:
  - Tier editor usable on tablet widths; rows may stack fields on narrow screens.
- **i18n/timezone/currency**:
  - Display costs formatted with `currencyCode` when available.
  - Submit numeric values as raw decimals (no localized separators).
  - Display timestamps in user timezone per app standard.

---

## 15. Applied Safe Defaults
- SF-UI-EMPTY-STATE: Added explicit empty state copy and CTA gating by permission; safe UI ergonomics that does not change domain logic. Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- SF-UI-LOADING-STATE: Standardized `idle/loading/saving/error` states with disabled actions to prevent double-submit; safe UX behavior. Impacted sections: Functional Behavior, Alternate / Error Flows, Non-Functional UI Requirements.
- SF-OBS-CORRELATION-ID: Surface `X-Correlation-Id` in error technical details; aligns with platform observability convention and does not change business policy. Impacted sections: Service Contracts, Acceptance Criteria, Audit & Observability.

---

## 16. Open Questions
1. **Domain ownership confirmation (blocking):** Supplier/vendor cost tiers appear to be a **Pricing/Procurement/Costing** capability rather than Inventory per the provided Inventory domain rules. Should this story remain `domain:inventory`, or be reassigned to `domain:pricing` (or another domain)?  
2. **Backend contract (blocking):** What are the exact Moqui proxy endpoints (paths), request/response schemas, and identifiers for:
   - list by item
   - load detail
   - create
   - update (PUT replace vs PATCH)
   - delete  
3. **Permissions (blocking):** What is the canonical permission string(s) to gate:
   - view list/detail
   - create/update/delete  
4. **Identifier model (blocking):** What is the canonical item identifier for this feature in the frontend and backend:
   - `itemId` vs `productId` vs `productSku`?  
5. **Currency rules (blocking):** Is `currencyCode` strictly derived from supplier configuration and read-only, or can supplier-item cost override currency?  
6. **Base cost support (blocking):** Is `baseCost` supported? If yes:
   - Can a record exist with baseCost and zero tiers?
   - If tiers exist, does baseCost act as fallback or is it ignored?  
7. **Precision/rounding (blocking):** What precision is required for `unitCost`/`baseCost` (e.g., 4 decimal places) and what rounding rules apply for display vs submission?  
8. **Optimistic locking (blocking):** Is there ETag/version/`updatedAt` concurrency control? If yes, what status code and error shape are returned on conflict, and what header/body fields must be sent back on update?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #244: [FRONTEND] [STORY] Fulfillment: Mechanic Executes Picking (Scan + Confirm)
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Fulfillment: Mechanic Executes Picking (Scan + Confirm)

### Primary Persona
Mechanic / Technician (shop-floor user fulfilling parts for a work order)

### Business Value
Reduce picking errors and improve fulfillment traceability by enabling mechanics to scan items/locations, confirm picked quantities, and record an auditable pick confirmation tied to a work order.

---

## 2. Story Intent

### Narrative (As a / I want / So that)
- **As a** Mechanic
- **I want** to pick required parts for a work order by scanning and confirming items
- **So that** the system records an accurate, auditable ‚Äúpicked‚Äù confirmation and downstream steps (consumption/installation) can proceed with correct inventory state.

### In-Scope
- Moqui UI flow to:
  - Load a work order‚Äôs pick list (or equivalent fulfillment task)
  - Guide picking via scan inputs
  - Confirm quantities per line
  - Submit ‚Äúpick confirmation‚Äù to backend
- Client-side validation and error handling for common scan/quantity issues
- Display of pick status per line and overall task status as returned by backend

### Out-of-Scope
- Reservation/allocation logic, substitution rules, backorders (must be defined elsewhere)
- Inventory consumption (decrement) and costing
- Creating/maintaining work orders, parts lists, or storage locations
- Permissions model definition (only enforcement based on backend responses)

---

## 3. Actors & Stakeholders

### Actors
- **Mechanic (Primary):** performs scan + confirm.
- **Inventory Manager (Secondary):** cares about accuracy/audit but not primary UI user here.
- **System:** validates scans, updates pick state, emits any events.

### Stakeholders
- **Work Execution domain** (work order lifecycle; dependency for task/line states)
- **Inventory domain** (item identity, quantities, location associations if applicable)
- **Audit/Security domains** (audit trails; authorization)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- A work order exists with parts to pick (a ‚Äúpick list‚Äù or ‚Äúfulfillment task‚Äù exists).

### Dependencies
- **Domain ownership conflict (blocking):** This story describes a Work Order fulfillment workflow (‚Äúpick list‚Äù, ‚Äúpick task‚Äù, ‚Äúpick line‚Äù, ‚Äúcomplete picking‚Äù) which is primarily owned by **Work Execution** (work order lifecycle and fulfillment task state machine). Inventory domain rules provided cover availability/ledger/topology/feed ops and do not define picking task contracts or states.
- **Backend API contract is not provided in the inputs (blocking):** This story cannot be fully buildable without confirming:
  - endpoints, payloads, identifiers, and state model for picking (see Open Questions)
- Scanner input method (keyboard wedge vs device integration) must align with existing frontend patterns in the repo.
- Inventory domain integration constraint (non-blocking but mandatory if inventory endpoints are used): UI must call **Moqui proxy endpoints** only; no direct Vue ‚Üí backend calls. (DECISION-INVENTORY-002)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order detail screen: action/button **‚ÄúPick Parts‚Äù** opens picking execution screen for that work order.
- Optional: from a Fulfillment/Picking queue list (if exists) -> open specific task.

### Screens to create/modify (Moqui)
1. **Modify** existing Work Order detail screen to add navigation to picking:
   - `screen: WorkOrderDetail` (name TBD by repo conventions)
   - Add transition to `PickExecute` with parameter `workOrderId` (or `pickTaskId`)
2. **Create** new picking execution screen:
   - `screen: Fulfillment/PickExecute.xml` (path/name TBD)
   - Contains:
     - Header: work order reference + status
     - Scan input form
     - Pick lines grid/list with per-line confirm controls
     - Submit/Complete action

### Navigation context
- Breadcrumb: Work Orders ‚Üí Work Order {id} ‚Üí Pick Parts
- Back action returns to Work Order detail, preserving state if possible.

### User workflows (happy + alternate paths)

#### Happy path
1. Mechanic opens ‚ÄúPick Parts‚Äù
2. UI loads pick lines (required part, qty required, qty already picked, pick location if provided)
3. Mechanic scans an item barcode (and optionally location/bin barcode)
4. UI matches scan to a pick line (single match) and focuses that line
5. Mechanic confirms quantity picked (default behavior is **blocking** until clarified; see Open Questions)
6. UI submits confirmation (per-line or batch) and refreshes line status
7. Mechanic completes picking task when all required quantities are picked

#### Alternate paths
- Scan matches multiple lines ‚Üí UI prompts user to select the intended line
- Scan doesn‚Äôt match any line ‚Üí show error and allow retry/manual search
- Partial pick allowed ‚Üí user can save progress without completing (must confirm)
- Over-pick attempt ‚Üí block with validation error (exact rule is **blocking**; see Open Questions)
- Network/API error ‚Üí show retry, keep unsent changes locally in-memory

---

## 6. Functional Behavior

### Triggers
- Enter picking screen with `workOrderId` (or `pickTaskId`) in URL parameters.
- Scan submitted (Enter key or ‚ÄúProcess Scan‚Äù action).
- Quantity confirmation action (per line).
- Complete/submit action (batch).

### UI actions
- **On load:**
  - Call load service to retrieve pick task and lines
  - Render list with statuses
- **On scan:**
  - Capture scan string
  - Call backend ‚Äúresolve scan‚Äù (or attempt client-side match if backend provides normalized codes list; prefer backend)
  - If match: select line; prefill qty to pick; optionally auto-confirm if configured (not assumed)
- **On confirm qty:**
  - Validate qty is > 0 and <= remaining required (unless partial rules differ; **blocking**)
  - Submit pick confirmation for the line
  - Update UI with returned line state (picked qty, status, version)
- **On complete:**
  - Validate all required lines satisfied (unless partial completion allowed; **blocking**)
  - Submit ‚Äúcomplete picking‚Äù transition
  - Navigate back to Work Order detail with success message

### State changes (frontend-observable)
- Pick line: `remainingQty` decreases; `pickedQty` increases; status changes (e.g., OPEN ‚Üí PICKED/PARTIAL)
- Pick task: status changes (e.g., IN_PROGRESS ‚Üí COMPLETED)

### Service interactions (Moqui)
- Use `transition` actions wired to backend REST via Moqui services (or direct HTTP if that‚Äôs the repo pattern).
- If any inventory-domain endpoints are called as part of scan resolution (e.g., location/bin lookup), they MUST be via Moqui proxy (DECISION-INVENTORY-002).
- Each mutating action must pass correlation/request id (observability) if supported.

---

## 7. Business Rules (Translated to UI Behavior)

> Many fulfillment rules are domain-policy and not provided. Only enforce what is explicit; otherwise defer to backend and surface errors.

### Validation
- Scan input is required and trimmed.
- Quantity input:
  - Must be numeric
  - Must be > 0
  - Must not exceed remaining required quantity **unless backend explicitly supports over-pick/backorder/substitution** (**blocking**; cannot be safely defaulted)

### Enable/disable rules
- Confirm actions disabled when:
  - Line is already fully picked (backend indicates)
  - Task is completed/cancelled (backend indicates)
- Complete action disabled when:
  - Task not in completable state
  - Outstanding required qty remains (unless partial completion allowed; **blocking**)

### Visibility rules
- If backend provides ‚Äúexpected pick location‚Äù show it as read-only reference.
- Show ‚Äúalready picked‚Äù qty if any.

### Error messaging expectations
- Display backend validation error messages verbatim when safe (no sensitive data).
- Use consistent error banner/toast pattern used in repo.
- For scan mismatch: ‚ÄúScan not recognized for this pick list‚Äù (exact text TBD).

---

## 8. Data Requirements

> Entities are described conceptually; exact Moqui entities depend on backend contract.

### Entities involved (conceptual)
- `WorkOrder` (reference only)
- `PickTask` / `FulfillmentTask`
- `PickLine`
- `Product` / `InventoryItem` reference
- `StorageLocation` reference (optional)

### Fields (type, required, defaults)

#### Screen parameters
- `workOrderId` (string/UUID, required) **OR** `pickTaskId` (string/UUID, required) ‚Äî **blocking**: must choose one canonical route parameter.

#### PickTask (read-only)
- `pickTaskId` (id, required)
- `workOrderId` (id, required)
- `status` (enum/string, required)
- `version` (number/string, required for optimistic locking if used)

#### PickLine (read-only + editable qty input)
- `pickLineId` (id, required)
- `productId` (id, required)
- `productDisplayName` (string, required)
- `requiredQty` (decimal, required)
- `pickedQty` (decimal, required; default 0)
- `uom` (string, required)
- `suggestedLocationId` (id, optional)
- `suggestedLocationLabel` (string, optional)
- `lineStatus` (enum/string, required)
- `version` (required if optimistic locking)

#### User inputs
- `scanValue` (string, required)
- `confirmQty` (decimal, required at confirm time)

### Read-only vs editable by state/role
- Mechanic can edit/enter `confirmQty` only when task/line is open/in-progress.
- All identifiers/status fields are read-only.

### Derived/calculated fields
- `remainingQty = requiredQty - pickedQty` (display only; source-of-truth backend)
- `isComplete = remainingQty <= 0` (display only)

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking**: no backend endpoints are defined in provided inputs. Below are placeholders and MUST be aligned with the WorkExec/Fulfillment backend contract. Inventory domain endpoint decisions provided do not define picking.

### Load/view calls (placeholders)
- `GET /api/v1/workorders/{workOrderId}/pick-task` ‚Üí returns pick task + lines  
  **OR**
- `GET /api/v1/pick-tasks/{pickTaskId}` ‚Üí returns pick task + lines

### Create/update calls
- None (no creation in UI; task exists already)

### Submit/transition calls (placeholders)
1. Resolve scan:
   - `POST /api/v1/pick-tasks/{pickTaskId}:resolve-scan`
   - Request: `{ scanValue: string }`
   - Response: either matched `pickLineId` or list of candidates + normalized info
2. Confirm pick line:
   - `POST /api/v1/pick-tasks/{pickTaskId}/lines/{pickLineId}:confirm-pick`
   - Request: `{ qty: decimal, scanValue?: string, version?: ... }`
   - Response: updated line + task summary
3. Complete pick task:
   - `POST /api/v1/pick-tasks/{pickTaskId}:complete`
   - Request: `{ version?: ... }`
   - Response: updated task status

### Error handling expectations
- `400/422` validation errors: show field-level error where possible + banner summary.
- `401`: redirect to login per app standard. (Aligns with DECISION-INVENTORY-012 behavior if shared across app)
- `403`: show ‚ÄúNot authorized to pick‚Äù and disable actions.
- `404`: show not found empty state with back link.
- `409` conflict (optimistic locking): prompt user to refresh; discard local staged values after user confirms refresh.

---

## 10. State Model & Transitions

> **Blocking**: actual states are not specified. Define UI to be driven by backend statuses.

### Allowed states (expected)
- Pick task: `OPEN`, `IN_PROGRESS`, `COMPLETED`, `CANCELLED` (names TBD)
- Pick line: `OPEN`, `PARTIAL`, `PICKED` (names TBD)

### Role-based transitions
- Mechanic can:
  - move task to `IN_PROGRESS` implicitly on first confirm (if backend does)
  - confirm picks on lines
  - complete task
- If backend restricts completion to certain roles, UI must honor `403`.

### UI behavior per state
- `COMPLETED/CANCELLED`: all inputs disabled; show summary only.
- `OPEN/IN_PROGRESS`: scan input enabled; lines actionable depending on remaining qty.

---

## 11. Alternate / Error Flows

### Validation failures
- Qty invalid ‚Üí inline error on qty field; no API call.
- Scan empty ‚Üí inline error on scan input.

### Concurrency conflicts
- Backend returns 409/version mismatch after confirm:
  - UI shows dialog: ‚ÄúThis pick list changed. Refresh to continue.‚Äù
  - On refresh: reload task/lines; clear current scan value; retain no unsubmitted qty edits.

### Unauthorized access
- 403 on load: show access denied state; no line data rendered.

### Empty states
- No pick lines: show ‚ÄúNo parts to pick for this work order‚Äù with back link.
- All lines complete but task not completed: show prompt to ‚ÄúComplete Picking‚Äù if allowed.

---

## 12. Acceptance Criteria

### Scenario 1: Load pick list for a work order
Given I am an authenticated Mechanic  
And a work order with an associated pick task exists  
When I navigate to ‚ÄúPick Parts‚Äù for that work order  
Then the system loads and displays the pick task header (work order reference and status)  
And the system displays all pick lines with required quantity and picked quantity  
And actions are enabled/disabled based on the task status returned by the backend

### Scenario 2: Scan matches a single pick line and confirm quantity
Given I am on the picking screen for a pick task in an actionable state  
And a pick line exists for product ‚ÄúP1‚Äù with remaining quantity > 0  
When I scan a barcode that the backend resolves to that pick line  
And I confirm a quantity less than or equal to the remaining quantity  
Then the UI submits the confirm request for that line  
And the UI updates the line‚Äôs picked quantity and remaining quantity based on the response  
And the UI shows a success confirmation state for that line

### Scenario 3: Scan does not match any pick line
Given I am on the picking screen  
When I scan a value that does not resolve to any pick line in the task  
Then the UI displays an error message indicating the scan is not recognized for this pick list  
And no quantities are changed  
And I can retry scanning

### Scenario 4: Attempt to confirm invalid quantity
Given I am on the picking screen with a selected pick line  
When I enter a non-numeric quantity or a quantity <= 0  
Then the UI shows a field-level validation error  
And the confirm action does not call the backend

### Scenario 5: Backend rejects confirm due to business rule (e.g., over-pick)
Given I am on the picking screen  
When I attempt to confirm a quantity that the backend rejects  
Then the UI displays the backend validation error message  
And the line quantities remain unchanged in the UI after refresh/reload

### Scenario 6: Complete picking successfully
Given I am on the picking screen  
And the backend indicates the pick task is completable  
When I click ‚ÄúComplete Picking‚Äù  
Then the UI calls the complete endpoint  
And the UI reflects the task status as completed  
And the UI disables further scan/confirm actions

### Scenario 7: Concurrency conflict on confirm
Given I am on the picking screen  
And the pick line has been modified by another user/session  
When I submit a confirm request and the backend returns a 409 conflict  
Then the UI prompts me to refresh  
And after refresh the UI shows the latest task/line quantities from the backend

---

## 13. Audit & Observability

### User-visible audit data
- Display (read-only) ‚ÄúLast updated‚Äù timestamp for the pick task if provided.
- Optionally show ‚ÄúConfirmed by‚Äù per line if backend returns it (not assumed).

### Status history
- If backend provides status history, show a collapsible ‚ÄúHistory‚Äù section (read-only). Otherwise out of scope.

### Traceability expectations
- All confirm/complete calls include:
  - `pickTaskId`, `pickLineId` (as applicable)
  - correlationId/requestId header if standard in repo (align with DECISION-INVENTORY-012 if shared platform-wide)
- UI logs (frontend console) must not include sensitive tokens; only IDs and error codes.

---

## 14. Non-Functional UI Requirements

- **Performance:** initial load renders first meaningful content within 2s on typical shop network; avoid N+1 calls (single load call for lines).
- **Accessibility:** WCAG 2.1 AA; scan input and confirm controls keyboard-navigable; error messages announced to screen readers.
- **Responsiveness:** usable on tablet and narrow handheld widths; list view supports scrolling.
- **i18n:** all user-facing strings in i18n keys (per repo conventions).
- **Timezone:** display timestamps in site/user locale per existing app behavior (no new rules invented).

---

## 15. Applied Safe Defaults
- none

---

## 16. Open Questions

1. **Domain ownership (blocking):** Is this story owned by **domain:workexec** (fulfillment/picking task lifecycle) rather than **domain:inventory**? If inventory owns the picking confirmation workflow, provide the inventory decision/contract that defines pick tasks/lines and their state machine.

2. **Backend contract (blocking):** What are the exact backend endpoints and payloads for:
   - loading pick task/lines
   - resolving a scan
   - confirming a pick line
   - completing the pick task  
   Provide URL paths, request/response JSON, deterministic error schema, and idempotency/locking mechanism.

3. **Identifier to route by (blocking):** Should the frontend route use `workOrderId` or `pickTaskId` as the primary parameter? If both are supported, define canonical route + deep-link params.

4. **Scan semantics (blocking):** What can be scanned?
   - product barcode only, or also storage location/bin barcode, or both?
   - if both are allowed, what is the expected sequence and matching behavior?

5. **Multi-match handling (blocking):** If a scan matches multiple pick lines (same SKU appears multiple times), what is the correct disambiguation key (location, lot, work step)?

6. **Quantity rules (blocking):** Are partial picks allowed? Is completion allowed with remaining quantities? Are over-picks ever allowed (with approval), or must UI hard-block before calling backend?

7. **Serial/lot control (blocking):** Are items serialized or lot-controlled in this workflow? If yes, what additional capture is required at pick time?

8. **Permissions (blocking):** What permission(s) gate picking actions (view pick list, confirm picks, complete task), and how are they surfaced to the frontend (claims/permissions endpoint)? If unknown, confirm that UI should rely solely on backend 403.

9. **Task/line state model (blocking):** What are the canonical statuses for pick tasks and pick lines, and what transitions are allowed?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Fulfillment: Mechanic Executes Picking (Scan + Confirm)  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/244  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ü§ñ Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #235 - Fulfillment: Mechanic Executes Picking (Scan + Confirm)  
**URL**: https://github.com/louisburroughs/durion/issues/235  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---  
*Generated by Missing Issues Audit System - 2025-12-26T17:36:39.200600573*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #243: [FRONTEND] [STORY] Fulfillment: Issue/Consume Picked Items to Workorder
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

**Title:** Fulfillment: Issue/Consume Picked Items to Workorder (Frontend, Moqui)

**Primary Persona:** Parts Manager / Technician (POS user issuing parts to a workorder)

**Business Value:** Ensure picked parts are formally consumed against a workorder so on-hand inventory is decremented, inventory ledger is updated, and downstream job costing/accounting is accurate and auditable.

---

## 2. Story Intent

**As a** Parts Manager or Technician  
**I want** to review picked items for a workorder and submit a ‚ÄúConsume/Issue‚Äù action for specified quantities  
**So that** inventory is decremented and the workorder is accurately charged with consumed parts.

### In-scope
- Moqui UI flow to:
  - load a workorder‚Äôs picked items
  - enter/confirm consumption quantities (up to picked quantity / remaining)
  - submit consumption to backend via **Moqui proxy** (no direct Vue ‚Üí backend) (DECISION-INVENTORY-002)
  - show success/failure outcomes and updated state
- Frontend validation aligned to backend rules (no over-consumption, only picked items, etc.)
- Basic audit visibility in UI (confirmation + server timestamp and correlation id when available)

### Out-of-scope
- Picking/staging parts for a workorder (assumed already done elsewhere)
- Returning consumed items to stock (handled by separate ‚ÄúReturn to Stock‚Äù flow/story; also listed as a ‚Äúnew movement‚Äù flow that must block inactive/pending locations) (DECISION-INVENTORY-009)
- Editing inventory costs (standard/last/average) and cost policy decisions
- Implementing backend inventory ledger/event emission (frontend only calls services)
- Any UI-side computation of availability/ATP/on-hand (inventory backend is authoritative) (DECISION-INVENTORY-004, DECISION-INVENTORY-016)

---

## 3. Actors & Stakeholders
- **Primary users:** Parts Manager, Technician
- **Secondary users:** Service Advisor (visibility), Inventory Manager (accuracy), Accounting (downstream consumption/cost attribution)
- **Systems:** Inventory service (authoritative movement/ledger), Work Execution / Workorder service (workorder identity and picked lines)

---

## 4. Preconditions & Dependencies

### Preconditions
- Workorder exists and is in a backend-allowed state for consumption (exact states are WorkExec-owned; UI must tolerate backend denial).
- One or more items have been ‚ÄúPicked‚Äù for the workorder (picked items associated to workorder).
- User is authenticated (Moqui session).
- User has permission to consume inventory for a workorder (permission string is not defined in Inventory domain docs; must be confirmed).

### Dependencies
- **Moqui proxy integration** for all calls (DECISION-INVENTORY-002).
- Backend endpoint(s) to:
  - load ‚Äúpicked items for workorder‚Äù (contract TBD; likely WorkExec-owned)
  - submit consumption/issue transaction (contract TBD; likely Inventory-owned movement command)
- Deterministic error schema and correlation id propagation:
  - requests include `X-Correlation-Id`
  - errors show correlation id in UI technical details (DECISION-INVENTORY-003, DECISION-INVENTORY-012)
- Sensitive data handling:
  - do not log quantities or payloads in client telemetry/console (DECISION-INVENTORY-011)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Workorder detail screen: action button/link ‚ÄúConsume Picked Items‚Äù
- Optional: from Fulfillment/Picking module menu, search/select workorder then ‚ÄúConsume‚Äù

### Screens to create/modify
1. **Modify**: `WorkorderDetail` screen  
   - Add action: `Consume Picked Items`
   - Visibility:
     - visible when user can view the workorder
     - enabled when backend indicates consumption is allowed (if such a flag is available); otherwise allow navigation and handle denial on consume attempt gracefully
2. **Create**: `WorkorderConsumePickedItems` screen (new)
   - Shows list of picked items with:
     - SKU / description (if available)
     - picked quantity
     - already consumed quantity (if available)
     - remaining consumable quantity (derived only when `qtyConsumed` is provided)
     - input: quantity to consume now (default behavior defined below)
   - Actions:
     - `Consume` (submits selected lines)
     - `Cancel` (back to workorder)

### Navigation context
- Route pattern (proposed, must align with repo conventions): `/workorders/:workorderId/fulfillment/consume-picked`
- Breadcrumb: Workorders ‚Üí Workorder #{id} ‚Üí Fulfillment ‚Üí Consume Picked Items

### User workflows (happy + alternate paths)

**Happy path**
1. User opens workorder ‚Üí selects ‚ÄúConsume Picked Items‚Äù
2. Screen loads picked items
3. User enters quantities (often ‚Äúconsume all remaining‚Äù)
4. User submits
5. UI shows success confirmation and reloads picked items (or navigates back to workorder detail after reload)

**Alternate paths**
- Partial consumption: user consumes some lines and leaves others at 0
- Backend rejects due to invalid workorder state or stale picked quantities:
  - UI shows error banner with correlation id
  - UI offers ‚ÄúReload picked items‚Äù and re-validates inputs

---

## 6. Functional Behavior

### Triggers
- Entering `WorkorderConsumePickedItems` triggers:
  - load picked items list for `workorderId`
  - (optional) load workorder header/status if not already available in navigation context

### UI actions
- Per picked line:
  - numeric input `qtyToConsume`
  - convenience action ‚ÄúMax‚Äù sets to:
    - `qtyRemaining` if available
    - else `qtyPicked`
- Global:
  - `Consume` submits only lines with `qtyToConsume > 0`
  - No ‚ÄúConsume All‚Äù unless explicitly added (not required for v1)

### State changes (frontend-visible)
- After successful submit:
  - show confirmation summary (count of lines submitted; do **not** log or display aggregate quantities in telemetry; displaying to user is allowed)
  - reload picked list to reflect updated consumed/remaining/status
  - keep user on screen by default; provide ‚ÄúBack to Workorder‚Äù action

### Service interactions
- Load picked items for workorder (read)
- Submit consumption (write)
- On submit success: reload picked items (read)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `workorderId` is required (from route param).
- For each line:
  - `qtyToConsume` must be numeric
  - `qtyToConsume` must be > 0 to be included in request
  - `qtyToConsume` must not exceed:
    - `qtyRemaining` when `qtyConsumed` is provided
    - else `qtyPicked`
- Fractional vs integer quantities:
  - **UI must accept decimals** (do not enforce integer-only) unless the picked item provides a `uom`/`quantityPrecision` contract to enforce.  
  - Rationale: Inventory domain docs do not define UOM/precision rules; enforcing integer-only would be an unsafe business default. (SAFE_DEFAULTS_MODE denylist: business formula/policy)

### Enable/disable rules
- Disable `Consume` when:
  - no lines with `qtyToConsume > 0`
  - any line has a validation error
  - submit is in progress (prevent double-submit)
- Disable line input when:
  - line is not eligible (if eligibility/status is provided by backend)
  - backend indicates line is fully consumed (if `qtyRemaining <= 0`)

### Visibility rules
- Screen requires authentication; 401 triggers login/session refresh per app convention (DECISION-INVENTORY-012).
- If load returns 403: show forbidden state (no data leakage) (DECISION-INVENTORY-012).
- If backend indicates workorder state disallows consumption:
  - show message and disable submit
  - keep list visible if already loaded (read-only)

### Error messaging expectations
- Use deterministic error schema when present (DECISION-INVENTORY-003):
  - Field-level errors should map to the specific line input when backend provides an identifier (e.g., `pickedItemId`).
  - Otherwise show a banner message.
- HTTP handling:
  - 400/422: validation error (show banner + inline where possible)
  - 401: redirect/refresh session
  - 403: forbidden state
  - 404: not found (workorder or picked items)
  - 409: conflict/stale state; prompt reload
  - 5xx/timeout: show retry affordance; show correlation id in technical details (DECISION-INVENTORY-012)

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- Workorder (read-only identity/state; WorkExec-owned)
- PickedItem (picked line associated to workorder; WorkExec-owned read model)
- Consumption command payload (Inventory-owned movement command)
- Optional: consumption result summary / transaction identifiers (read-only response)

### Fields (type, required, defaults)

**Workorder (read)**
- `workorderId` (string, required)
- `status` (string, optional for UI gating; backend remains authoritative)

**PickedItem (read)**
- `pickedItemId` (string, required)
- `productSku` (string, optional but preferred for display; canonical inventory/product identifier is `productSku` per inventory deep-link conventions) (DECISION-INVENTORY-014)
- `description` (string, optional)
- `qtyPicked` (number, required)
- `qtyConsumed` (number, optional)
- `status` (string/enum, optional)
- `uom` (string, optional)
- Linkage fields (optional, if provided):
  - `workOrderId` / `workOrderLineId` (string) for traceability (DECISION-INVENTORY-005)

**UI Input (editable)**
- `qtyToConsume` (number, default 0)

**Derived/calculated fields (frontend)**
- `qtyRemaining = qtyPicked - qtyConsumed` (only when `qtyConsumed` is provided)
- `lineEligible`:
  - if `status` provided: eligible when status indicates picked/issuable
  - else assume eligible and rely on backend validation (do not guess status taxonomy)

### Read-only vs editable by state/role
- Workorder fields: read-only
- Picked item identity fields: read-only
- Quantity input: editable only when screen is not in forbidden state and line is eligible (as above)

---

## 9. Service Contracts (Frontend Perspective)

> Inventory domain decisions define proxy pattern, error schema expectations, and correlation/auth behavior. The **specific WorkExec ‚Äúpicked items‚Äù contract and the Inventory ‚Äúconsume‚Äù contract are not provided** in the inventory domain docs; they must be confirmed.

### Load/view calls

1. **Get picked items for workorder (Moqui proxy)**
   - **TBD endpoint** (must be same-origin Moqui route; no direct backend calls) (DECISION-INVENTORY-002)
   - Request:
     - `GET <TBD>/workorders/{workorderId}/picked-items` (placeholder)
     - Headers: `X-Correlation-Id: <uuid>`
   - Response (minimum required fields):
     ```json
     {
       "workorderId": "WO-123",
       "items": [
         {
           "pickedItemId": "PICK-1",
           "productSku": "SKU-123",
           "description": "Optional",
           "qtyPicked": 2,
           "qtyConsumed": 0,
           "uom": "EA",
           "status": "PICKED"
         }
       ]
     }
     ```
   - Errors: 401/403/404/5xx with deterministic schema when possible (DECISION-INVENTORY-003, DECISION-INVENTORY-012)

2. **(Optional) Get workorder header/status (Moqui proxy)**
   - **TBD endpoint** (likely already exists in Workorder screens)
   - Used only for display/gating; backend remains authoritative.

### Create/update calls
- none

### Submit/transition calls

1. **Consume/Issue picked items (Moqui proxy)**
   - **TBD endpoint** (placeholder: `POST /inventory/workorders/consume-picked` or similar; must be confirmed)
   - Headers:
     - `X-Correlation-Id: <uuid>` (DECISION-INVENTORY-012)
   - Request body (frontend-generated; include only lines with `qtyToConsume > 0`):
     ```json
     {
       "workorderId": "WO-123",
       "items": [
         { "pickedItemId": "PICK-1", "quantity": 2 }
       ]
     }
     ```
   - Notes:
     - Do **not** require `sku` client-side unless backend contract explicitly requires it (unknown).
     - Do **not** log request quantities (DECISION-INVENTORY-011).
   - Success response (minimum required):
     ```json
     {
       "result": "SUCCESS",
       "consumptionId": "uuidv7",
       "serverTimestamp": "2026-01-21T12:34:56Z"
     }
     ```
     (Exact schema TBD; UI must tolerate additional fields.)
   - Errors:
     - 400/422 validation (line-level if possible)
     - 403 forbidden
     - 409 conflict (stale picked quantities or invalid workorder state)
     - 5xx

### Error handling expectations
- Deterministic error schema parsing (DECISION-INVENTORY-003):
  - If error includes `fieldErrors[]` with `field` and `message`, map to form fields.
  - If error includes `itemErrors[]` with `pickedItemId`, map to that row.
  - Otherwise show banner with safe message and correlation id.
- Timeout UX:
  - show loading indicator within 100ms
  - show timeout at 8 seconds with retry (DECISION-INVENTORY-004)

---

## 10. State Model & Transitions

### Allowed states
**Workorder states**
- WorkExec-owned; exact allowed/disallowed values are **unknown**.
- UI behavior:
  - if status is provided and clearly indicates non-consumable, disable submit
  - always rely on backend enforcement and handle 409/422 gracefully

**Picked item states**
- WorkExec-owned; exact values unknown.
- UI behavior:
  - if status indicates ineligible, disable that row input
  - otherwise allow input and rely on backend validation

### Role-based transitions
- Permission string(s) for ‚Äúconsume/issue to workorder‚Äù are **unknown** and must be confirmed.
- UI should:
  - hide/disable action when permission data is available
  - still handle backend 403 on submit (DECISION-INVENTORY-012)

### UI behavior per state
- Disallowed workorder state: show message + disable submit
- Ineligible line: disable input and exclude from submit
- All lines ineligible or none returned: show empty/none-eligible state

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- `qtyToConsume` > max allowed:
  - inline error on that row
  - disable submit
- `qtyToConsume` <= 0:
  - treat as not selected (no error) except negative values:
    - negative values show inline error and disable submit

### Concurrency conflicts
- Backend returns 409 (picked quantities changed, already consumed, or workorder state changed):
  - show conflict banner: ‚ÄúPicked quantities or workorder state changed. Reload and try again.‚Äù
  - provide `Reload picked items` action
  - After reload:
    - **do not attempt to preserve quantities automatically** unless a deterministic rule is specified (currently unknown); default to resetting all `qtyToConsume` to 0 to avoid accidental over-issue.

### Unauthorized access
- 401:
  - redirect to login/session refresh (DECISION-INVENTORY-012)
- 403:
  - show forbidden state; do not render previously cached sensitive data

### Empty states
- No picked items:
  - show ‚ÄúNo picked items available to consume for this workorder.‚Äù
  - provide navigation back to workorder

---

## 12. Acceptance Criteria

### Scenario 1: Load consume screen with picked items
**Given** I am an authenticated user  
**And** I have access to workorder `WO-123`  
**And** `WO-123` has 2 picked items associated to it  
**When** I navigate to `/workorders/WO-123/fulfillment/consume-picked`  
**Then** the system loads picked items via a **Moqui proxy** endpoint (no direct backend calls)  
**And** the system displays the picked items list including `qtyPicked` for each line  
**And** each line has an input to enter a consume quantity  
**And** the Consume action is disabled until at least one line has a quantity > 0

### Scenario 2: Successfully consume quantities for selected lines
**Given** workorder `WO-123` is currently consumable by backend rules  
**And** item line `PICK-1` has `qtyPicked = 2` and `qtyConsumed = 0`  
**When** I enter `qtyToConsume = 2` for `PICK-1` and click ‚ÄúConsume‚Äù  
**Then** the frontend submits a request containing `workorderId = WO-123` and `pickedItemId = PICK-1` with quantity 2  
**And** the request includes an `X-Correlation-Id` header  
**And** I see a success confirmation that includes the server timestamp when provided  
**And** the picked items list is reloaded after success

### Scenario 3: Prevent consuming more than remaining (client-side)
**Given** item line `PICK-1` shows `qtyPicked = 1` and `qtyConsumed = 0`  
**When** I enter `qtyToConsume = 2`  
**Then** the line shows a validation error indicating the quantity exceeds the allowed amount  
**And** the Consume action remains disabled

### Scenario 4: Backend rejects because workorder is not consumable (409)
**Given** I am on the consume screen for `WO-999`  
**And** I enter a valid positive quantity for at least one picked line  
**When** I click ‚ÄúConsume‚Äù  
**And** the backend responds with HTTP `409`  
**Then** the frontend displays an error message that the workorder/items changed or the workorder is not in a valid state for consumption  
**And** the error UI displays the correlation id in ‚ÄúTechnical details‚Äù when available  
**And** the user can click ‚ÄúReload picked items‚Äù to refresh

### Scenario 5: Backend validation error (400/422) maps to a line when possible
**Given** I am on the consume screen for `WO-123`  
**When** the backend responds `400` or `422` with an item-level error referencing `pickedItemId = PICK-1`  
**Then** the frontend displays an inline error on the `PICK-1` row  
**And** the user remains on the consume screen with inputs preserved for other rows

### Scenario 6: Unauthorized submit (403)
**Given** I can view the workorder but do not have permission to consume inventory  
**When** I click ‚ÄúConsume‚Äù  
**Then** the backend responds with `403 Forbidden`  
**And** the frontend shows a forbidden state without leaking additional data  
**And** no success confirmation is shown

### Scenario 7: Timeout behavior is bounded
**Given** I am on the consume screen for `WO-123`  
**When** a load or consume request takes longer than 8 seconds  
**Then** the UI stops showing an indefinite spinner  
**And** shows a timeout message with a Retry action  
**And** does not auto-retry the request

---

## 13. Audit & Observability

### User-visible audit data
- On success, show:
  - server timestamp if returned
  - consumption/transaction id if returned (do not assume name; display generically as ‚ÄúReference ID‚Äù)
- Do not display or store raw payload blobs.

### Status history
- Not required to render full ledger here.
- Must reload picked items after success to reflect updated consumed/remaining/status.

### Traceability expectations
- All requests include `X-Correlation-Id` (DECISION-INVENTORY-012).
- Error UI surfaces correlation id in technical details (DECISION-INVENTORY-012).
- Client logs/telemetry must **not** emit numeric quantities or raw payloads (DECISION-INVENTORY-011).

---

## 14. Non-Functional UI Requirements
- **Performance:** initial load should render a loading indicator within 100ms; handle up to 50 picked lines without UI jank; use pagination/virtualization if larger (implementation choice).
- **Accessibility:** WCAG 2.1 AA; keyboard-navigable list and inputs; inline errors announced to screen readers.
- **Responsiveness:** usable on tablet resolutions common in shop floors.
- **i18n/timezone/currency:** timestamps shown in user locale/timezone when displayed; quantities shown as provided (no UOM conversions).

---

## 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE**
  - **Assumed:** Explicit empty state messaging when no picked items exist.
  - **Why safe:** Pure UI ergonomics; does not change business rules.
  - **Impacted sections:** UX Summary, Alternate/Empty states.
- **SD-ERR-HTTP-MAP**
  - **Assumed:** Standard mapping for 400/401/403/404/409/422/5xx to banner + inline errors when identifiable; 401 triggers login/session refresh; 403 forbidden state.
  - **Why safe:** Aligns with deterministic error handling and auth behavior conventions without inventing domain policy. (DECISION-INVENTORY-003, DECISION-INVENTORY-012)
  - **Impacted sections:** Business Rules, Service Contracts, Alternate/Error flows, Acceptance Criteria.
- **SD-OBS-CORRELATION-ID**
  - **Assumed:** Frontend generates a UUID per request for `X-Correlation-Id` when not already provided by platform client.
  - **Why safe:** Observability boilerplate; does not alter business logic. (DECISION-INVENTORY-012)
  - **Impacted sections:** Service Contracts, Audit & Observability, Acceptance Criteria.
- **SD-UX-TIMEOUT-8S**
  - **Assumed:** Client-side timeout state at 8 seconds with retry affordance; no auto-retry loops.
  - **Why safe:** Explicitly specified UX target for inventory-related calls; UX-only behavior. (DECISION-INVENTORY-004)
  - **Impacted sections:** Service Contracts, Error Flows, Acceptance Criteria, Non-Functional UI Requirements.

---

## 16. Open Questions

1. What is the **authoritative route/screen naming and placement** in `durion-moqui-frontend` for workorder subflows (exact URL path, screen file location, and how WorkorderDetail links to it)?
2. What is the Moqui proxy endpoint (path + response schema) to **load picked items for a workorder**, and which system is the SoR for that list (WorkExec vs Inventory)?
3. What is the Moqui proxy endpoint (path + request/response schema) to **consume/issue picked items**, and is this an Inventory-owned command that posts ledger entries immediately?
4. What permission string(s) gate:
   - viewing the consume screen/action
   - submitting consumption  
   (Inventory docs define topology/feedops permissions only; consumption permission taxonomy must be confirmed.)
5. Quantity precision rules:
   - Are quantities always integer for these picked items, or can they be fractional?
   - If fractional, what precision/step should the UI enforce per line (e.g., from `uom` metadata)?
6. On success, what identifiers should be displayed to the user (e.g., `consumptionId`, resulting `ledgerEntryId`s, or a workorder transaction reference), and which are safe to display?
7. Should the UI attempt to preserve user-entered `qtyToConsume` values after a 409 reload, and if so what is the deterministic rule to avoid accidental over-issue?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Fulfillment: Issue/Consume Picked Items to Workorder ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/243

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #242: [FRONTEND] [STORY] Fulfillment: Return Unused Items to Stock with Reason
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] Fulfillment: Return Unused Items to Stock with Reason

**Primary Persona:** Warehouse Manager (primary); Service Advisor (secondary)

**Business Value:** Enables returning unused, saleable items from completed/closed work orders back into inventory with a mandatory reason per item, improving inventory accuracy and traceability for operations and downstream accounting.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Warehouse Manager or Service Advisor,  
- **I want to** return unused items from a completed/closed work order back into stock while providing a reason for each returned item,  
- **So that** inventory on-hand is accurate, returned items are available for future work, and returns are auditable with standardized reason codes.

### In-scope
- A Moqui/Vue/Quasar UI flow to:
  - Enter from a Work Order detail view and initiate ‚ÄúReturn Items to Stock‚Äù
  - Display items consumed by that work order and the max-returnable quantities (backend-authoritative)
  - Enter return quantities (<= returnable and > 0) for one or more items
  - Select a **mandatory** return reason per returned line
  - Submit a single atomic ‚Äúreturn to stock‚Äù transaction (single request)
  - Display a success confirmation including a return transaction identifier
- Frontend validation and server error handling consistent with deterministic error schema expectations (DECISION-INVENTORY-003)
- Use Moqui proxy integration pattern (no direct Vue ‚Üí inventory backend) (DECISION-INVENTORY-002)
- Enforce location selection rules via pickers (no free-text UUID entry) (DECISION-INVENTORY-001)
- Enforce inactive/pending location blocking for new movement flows (Return-to-stock is explicitly in-scope for blocking) (DECISION-INVENTORY-009)

### Out-of-scope
- Financial reconciliation / accounting adjustments beyond emitting/consuming the return result (Accounting consumes emitted event; frontend does not implement accounting)
- Defining or managing reason codes (assumed preconfigured)
- Changing work order state or consumed quantities from this screen
- Any costing/valuation calculations (Inventory domain remains authoritative; frontend only displays returned values)
- Any ledger mutation UI (ledger is append-only/immutable; corrections are new entries) (DECISION-INVENTORY-005)

---

## 3. Actors & Stakeholders
- **Warehouse Manager (Actor):** Processes return-to-stock transactions.
- **Service Advisor (Actor):** May process returns for their work orders.
- **Inventory System (System):** Validates eligibility, enforces rules, posts ledger entries, updates on-hand.
- **Work Execution System (System/Dependency):** System of record for work order state and consumed lines; provides identifiers used to query returnable items.
- **Accounting (Stakeholder):** Depends on accurate inventory and emitted events (not directly interacted with by UI).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend.
- User has permission to create inventory movements/returns (exact permission string TBD; must follow canonical naming convention) (DECISION-INVENTORY-010)
- Target work order exists and is in **Completed** or **Closed** state (WorkExec-owned state).
- Work order has at least one **consumed** item line eligible for return (may be zero; UI must handle empty state).
- Backend provides a list of valid return reason codes (non-empty is expected for usability; if empty, UI must block submission and show an actionable error).

### Dependencies (Blocking where unclear)
- **Backend API contract via Moqui proxy** for:
  - Loading work order consumed/returnable items and max-returnable quantities (backend-authoritative; frontend must not compute availability/returnability) (DECISION-INVENTORY-004)
  - Listing return reason codes
  - Submitting return-to-stock transaction and receiving `inventoryReturnId` (or equivalent)
- **Location context contract** to determine which `locationId` / optional `storageLocationId` receives returned items, and whether user can override it (must use pickers; must block INACTIVE/PENDING) (DECISION-INVENTORY-001, DECISION-INVENTORY-009)
- **Deterministic error schema** for mapping field errors to line items (DECISION-INVENTORY-003)
- **Correlation ID** propagation and display in error UI technical details (DECISION-INVENTORY-012)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a Work Order detail view (Completed/Closed): action button/link **‚ÄúReturn Items to Stock‚Äù**
- Optional secondary entry: Inventory/Fulfillment menu ‚Üí ‚ÄúReturns‚Äù ‚Üí ‚ÄúReturn from Work Order‚Äù (only if consistent with existing navigation conventions; otherwise omit)

### Screens to create/modify (Moqui)
1. **Modify Work Order Detail screen** to include the entry action when eligible:
   - Show action only when work order state ‚àà {Completed, Closed} and user has create permission.
   - If user lacks permission, hide action (do not show disabled action unless app convention requires it).
2. **New screen:** `apps/pos/screen/workorder/ReturnItems.xml` (indicative; final path must match repo conventions)
   - **Required parameter:** `workOrderId`
   - **Optional query params (deep-linking if supported by app router):**
     - `locationId` (if backend supports overriding return location)
     - `storageLocationId` (if backend supports bin-level returns)
     - Note: canonical deep-link params are defined for availability screens (DECISION-INVENTORY-014). This story may reuse the same param names for consistency, but must not introduce new canonical names without confirmation.
   - Loads (via Moqui proxy services):
     - work order header (id, state)
     - returnable items list with consumed qty and max returnable qty
     - reason codes list
     - location picker data (LocationRef list; StorageLocation list filtered by locationId) (DECISION-INVENTORY-001, DECISION-INVENTORY-007, DECISION-INVENTORY-008)
   - Form/table to enter return quantities + reasons per line
   - Submit transition to a Moqui service that proxies the backend return command (DECISION-INVENTORY-002)

### Navigation context
- Breadcrumb/back navigation returns to Work Order detail.
- On successful submission:
  - Default: navigate back to Work Order detail and show a confirmation banner including `inventoryReturnId`.
  - If repo convention prefers a confirmation screen, implement `ReturnItemsConfirm.xml` and transition there.
  - **Blocking:** repo pattern is unknown; must be confirmed.

### User workflows (happy + alternate)
**Happy path**
1. User opens a completed/closed work order.
2. Clicks ‚ÄúReturn Items to Stock‚Äù.
3. Screen loads returnable lines and reason codes.
4. User selects destination location/bin (if required/allowed) using pickers; inactive/pending locations are not selectable for movement (DECISION-INVENTORY-009).
5. User enters return quantity for one or more lines and selects a reason per selected line.
6. User submits; UI disables submit while in-flight.
7. UI shows success with `inventoryReturnId` and returns user to Work Order detail (or confirmation screen).

**Alternate paths**
- Work order has no returnable items ‚Üí empty state; no submit allowed.
- User tries to return > allowed ‚Üí inline validation errors.
- User omits a reason for a returned line ‚Üí inline validation errors.
- Backend rejects due to state change, location ineligible, or permissions ‚Üí show message and guide user to reload/back.

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúReturn Items to Stock‚Äù action from a work order.
- Screen load triggers data fetch for work order eligibility, returnable items, reason codes, and picker data as needed.
- Submit triggers a single backend ‚Äúreturn to stock‚Äù request via Moqui proxy.

### UI actions
- Destination selection:
  - `locationId` picker (LocationRef) is required unless backend provides an immutable default and does not allow override.
  - Optional `storageLocationId` picker filtered by `locationId` if backend supports bin-level returns.
  - Pickers must not allow free-text UUID entry in v1 user-facing flows (DECISION-INVENTORY-001).
  - Pickers must exclude `LocationRef.status IN {INACTIVE, PENDING}` for movement flows (DECISION-INVENTORY-009).
- Per line item:
  - Quantity input (integer, min 0; only >0 lines are included)
  - Reason dropdown (required when quantity > 0)
- Submit:
  - Disabled until at least one line has quantity > 0 and all such lines have reasons selected, destination is valid, and no validation errors exist.
- Cancel:
  - Returns to prior screen without changes.

### State changes (frontend)
- Local form state:
  - `returnLines[]` derived from backend returnable items response
  - `dirty` tracking for unsaved changes prompt (optional; safe default)
- Post-submit:
  - Show confirmation and prevent duplicate submit (in-flight lock)
  - If navigating back to Work Order detail, optionally trigger a refresh of work order data (if the detail screen supports refresh) but do not auto-loop refresh.

### Service interactions
- Load:
  - Returnable items for work order (includes max-returnable quantities)
  - Reason codes
  - LocationRef list and StorageLocation list (if destination selection is required/allowed)
- Submit:
  - Create return-to-stock transaction with selected lines and reasons
- Error handling:
  - Parse deterministic error schema; map field errors to specific line fields when possible (DECISION-INVENTORY-003)
  - Handle 401/403 per standard behavior (DECISION-INVENTORY-012)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Work order state must be **Completed** or **Closed**:
  - UI hides entry action when ineligible.
  - If user deep-links directly, show ineligible message and do not allow submit.
- Return quantity rules per line:
  - Integer
  - > 0 to be included
  - <= `maxReturnableQty` (backend-authoritative; frontend validates against returned value)
- Return reason rules:
  - Mandatory for each line with quantity > 0
  - Selected from backend-provided list (no free-text)
- Destination rules:
  - Must use pickers (no free-text UUID entry) (DECISION-INVENTORY-001)
  - Must not allow INACTIVE/PENDING locations for movement (DECISION-INVENTORY-009)
  - If `storageLocationId` is provided, it must belong to selected `locationId` (DECISION-INVENTORY-001)

### Enable/disable rules
- Submit disabled until:
  - At least one line selected (qty > 0)
  - All selected lines have a reason
  - Destination selection is valid (if required)
  - Not currently submitting
- Quantity input disabled for lines with `maxReturnableQty = 0`
- If reason codes list is empty or fails to load:
  - Disable submit and show an error banner ‚ÄúReturn reasons are unavailable. Try again or contact support.‚Äù

### Visibility rules
- Show consumed qty and max returnable qty read-only per line.
- Show empty state when no eligible items.
- Show forbidden state on 403 and hide form.

### Error messaging expectations
- Inline per-line errors:
  - quantity exceeds max returnable
  - missing reason
- Page-level errors:
  - work order not eligible
  - destination location ineligible (inactive/pending)
  - network/server failure
  - unauthorized (403)
- Error UI must show correlation ID in technical details when available (DECISION-INVENTORY-012).
- Do not log quantities or payloads to console/telemetry (DECISION-INVENTORY-011).

---

## 8. Data Requirements

### Entities involved (conceptual; frontend consumes via API)
- WorkOrder (WorkExec-owned; referenced)
- Work order consumption lines / returnable lines (WorkExec/Inventory integration read model)
- Inventory return command/result (Inventory-owned)
- InventoryLedger entries (Inventory-owned side-effect; UI does not create directly)
- ReturnReasonCode (Inventory-owned lookup or shared lookup; exact ownership TBD)
- LocationRef (Inventory read model of HR locations) (DECISION-INVENTORY-008)
- StorageLocation (Inventory-owned bins) (DECISION-INVENTORY-007)

### Fields (type, required, defaults)

**Route params**
- `workOrderId` (string/uuid, required)

**Screen input model (frontend)**
- `destination`:
  - `locationId` (string/uuid, required if backend requires/permits destination selection)
  - `storageLocationId` (string/uuid, optional; only if backend supports bin-level returns)
- `returnLines[]`:
  - `workOrderLineId` (string/uuid, optional but strongly preferred for stable mapping; if absent, must use `sku` as key)
  - `sku` (string, required, read-only)
  - `description` (string, optional read-only)
  - `consumedQty` (number, read-only)
  - `maxReturnableQty` (number, read-only)
  - `quantityToReturn` (number/integer, editable; default 0)
  - `returnReasonCode` (string, editable; required when `quantityToReturn > 0`)

**Reason code model**
- `code` (string, required)
- `label` (string, required for display)
- `active` (boolean, optional; if provided, UI filters to active only)

**Response fields to display on success**
- `inventoryReturnId` (string/uuid, required)
- `processedAt` (timestamp UTC, required)
- `processedByUserId` (string/uuid, optional)
- returned line summary (sku/workOrderLineId, qty, reason)

### Read-only vs editable by state/role
- Editable only if:
  - work order eligible
  - user has create permission
- Always read-only:
  - consumedQty, maxReturnableQty, sku/description
- Post-submission:
  - navigate away or render read-only confirmation

### Derived/calculated fields (frontend)
- `selectedLines = returnLines.filter(l => l.quantityToReturn > 0)`
- Validation flags based on `maxReturnableQty`
- Submit payload derived from `selectedLines`
- **Do not compute** max returnable or availability client-side (DECISION-INVENTORY-004)

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking:** This story cannot be implemented without confirmed Moqui proxy endpoints and payload shapes for ‚Äúreturnable items‚Äù, ‚Äúreason codes‚Äù, and ‚Äúsubmit return‚Äù. Inventory domain docs provide proxy patterns and error schema expectations, but do not define this specific return-to-stock contract.

### Load/view calls (via Moqui proxy; no direct backend calls) (DECISION-INVENTORY-002)
1. **Load work order & returnable lines**
   - **TBD Moqui proxy endpoint**, example shape:
     - Request: `GET /inventory/workorders/{workOrderId}/returnable-items`
     - Response (minimum):
       ```json
       {
         "workOrder": { "workOrderId": "uuid", "status": "COMPLETED" },
         "defaultDestination": { "locationId": "uuid", "storageLocationId": "uuid|null" },
         "items": [
           {
             "workOrderLineId": "uuid",
             "sku": "SKU-123",
             "description": "string",
             "consumedQty": 5,
             "maxReturnableQty": 5
           }
         ]
       }
       ```
   - Notes:
     - `maxReturnableQty` must already account for prior returns (backend-authoritative).

2. **Load return reason codes**
   - **TBD Moqui proxy endpoint**, example:
     - `GET /inventory/return-reasons`
     - Response:
       ```json
       [ { "code": "NOT_NEEDED", "label": "Not needed", "active": true } ]
       ```

3. **Load pickers (if destination selection required/allowed)**
   - LocationRef list: `GET /inventory/locations` (DECISION-INVENTORY-008)
   - StorageLocation list filtered by location: `GET /inventory/storage-locations?locationId=...` (DECISION-INVENTORY-007)

### Create/update calls
- None (no draft saving)

### Submit/transition calls
1. **Submit return transaction**
   - **TBD Moqui proxy endpoint**, example:
     - `POST /inventory/returns`
   - Request (minimum):
     ```json
     {
       "workOrderId": "uuid",
       "destination": { "locationId": "uuid", "storageLocationId": "uuid|null" },
       "items": [
         {
           "workOrderLineId": "uuid",
           "sku": "SKU-123",
           "quantityToReturn": 2,
           "returnReasonCode": "NOT_NEEDED"
         }
       ]
     }
     ```
   - Response (success 200/201):
     ```json
     {
       "inventoryReturnId": "uuid",
       "workOrderId": "uuid",
       "destination": { "locationId": "uuid", "storageLocationId": "uuid|null" },
       "processedAt": "2026-01-01T12:00:00Z",
       "processedByUserId": "uuid",
       "items": [
         {
           "workOrderLineId": "uuid",
           "sku": "SKU-123",
           "quantityToReturn": 2,
           "returnReasonCode": "NOT_NEEDED"
         }
       ]
     }
     ```

### Error handling expectations (deterministic schema) (DECISION-INVENTORY-003)
- 401:
  - Follow standard session refresh/login redirect behavior (DECISION-INVENTORY-012)
- 403:
  - Render forbidden state; do not leak partial data (DECISION-INVENTORY-012)
- 404:
  - Work order not found ‚Üí not found state with back link
- 409:
  - Concurrency/state change ‚Üí show conflict banner and offer reload
- 422:
  - Validation errors (e.g., inactive/pending destination, quantity exceeds returnable) ‚Üí map to fields/lines when possible
- 5xx / timeout:
  - Show generic error with retry; show correlation ID when available; do not auto-retry mutations

---

## 10. State Model & Transitions

### Allowed states (work order eligibility)
- Eligible: `Completed`, `Closed`
- Ineligible: any other state

### Role-based transitions
- This UI does not change work order state.
- Return submission allowed only for users with the create permission (exact string TBD; must follow naming convention) (DECISION-INVENTORY-010)

### UI behavior per state
- Eligible:
  - Show entry action
  - Allow form interaction
- Ineligible:
  - Hide entry action; direct navigation shows ineligible message and disables submit
- After successful return:
  - Show success confirmation; prevent duplicate submit via in-flight lock
  - Do not auto-refresh in a loop

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Quantity > maxReturnableQty:
  - Inline error; submit disabled
- Missing reason when qty > 0:
  - Inline error; submit disabled; focus missing field on submit attempt
- No items selected:
  - Submit disabled; helper text ‚ÄúEnter a quantity to return.‚Äù
- Destination missing (if required):
  - Inline error on destination picker; submit disabled
- Destination is inactive/pending (should be prevented by picker):
  - If backend returns 422 anyway, show banner and highlight destination field

### Concurrency conflicts
- Work order becomes ineligible after load:
  - Backend returns 409/422; UI shows banner ‚ÄúWork order is no longer eligible for returns. Reload to view current status.‚Äù
- Returnable quantities changed:
  - Backend returns 422 with line-level errors; UI offers ‚ÄúReload returnable quantities‚Äù action

### Unauthorized access
- 403 on load:
  - Show access denied state; hide form
- 403 on submit:
  - Show access denied banner; keep form but disable submit

### Empty states
- No returnable items:
  - Show message ‚ÄúNo consumed items are eligible to return to stock.‚Äù
  - Hide/disable submit

### Timeout behavior (bounded UX)
- Show loading indicator within 100ms; if request exceeds 8 seconds, show timeout state with retry (DECISION-INVENTORY-004)
- For submit timeouts, do not auto-retry; user must explicitly retry

---

## 12. Acceptance Criteria

### Scenario 1: Successful return of unused items with reason
**Given** a work order in `Completed` state with a returnable line for `SKU-123` with `maxReturnableQty = 5`  
**And** the user has permission to create inventory returns  
**And** the return reason codes list includes `NOT_NEEDED`  
**And** the destination `locationId` is ACTIVE and selectable via picker  
**When** the user opens ‚ÄúReturn Items to Stock‚Äù for that work order  
**And** selects the destination location (and optional bin if supported) using pickers  
**And** enters `quantityToReturn = 2` for `SKU-123`  
**And** selects return reason `NOT_NEEDED` for `SKU-123`  
**And** submits the return  
**Then** the frontend sends a single submit request via Moqui proxy containing `workOrderId`, destination, and the selected line(s) with quantity and reason  
**And** the UI displays a success confirmation containing `inventoryReturnId`  
**And** the submit control is disabled while the request is in flight to prevent duplicate submission.

### Scenario 2: Attempt to return more than allowed (client-side)
**Given** a work order returnable line for `SKU-123` with `maxReturnableQty = 5`  
**When** the user enters `quantityToReturn = 6`  
**Then** the UI shows an inline validation error indicating the quantity exceeds the returnable amount  
**And** the submit action is disabled.

### Scenario 3: Attempt to submit without a reason
**Given** a work order returnable line for `SKU-123` with `maxReturnableQty = 5`  
**When** the user enters `quantityToReturn = 1` for `SKU-123`  
**And** does not select a return reason  
**Then** the UI shows an inline validation error for missing reason  
**And** the submit action is disabled  
**Or** if submit is attempted, the UI blocks submission and focuses the missing reason field.

### Scenario 4: Destination location is inactive/pending (movement blocked)
**Given** the user is on the return screen  
**When** the user attempts to select a destination location with status `INACTIVE` or `PENDING`  
**Then** the location picker does not allow selecting that location for this movement flow  
**And** if the backend still returns a validation error indicating the destination is ineligible  
**Then** the UI shows an actionable error and prevents submission.  

### Scenario 5: Work order not eligible (state changed)
**Given** the user opens the return screen for a work order that is `Completed`  
**When** the work order becomes not `Completed` or `Closed` before submission  
**And** the user submits a return  
**Then** the backend responds with an error indicating the work order is not eligible  
**And** the UI displays a non-field error ‚ÄúReturns can only be processed for completed or closed work orders.‚Äù  
**And** the UI offers a reload/back action.

### Scenario 6: Unauthorized user
**Given** the user lacks permission to create inventory returns  
**When** the user navigates to the return screen URL  
**Then** the UI shows an access denied state  
**And** does not display an editable return form.

### Scenario 7: Timeout on load and submit
**Given** the user opens the return screen  
**When** the load request exceeds 8 seconds  
**Then** the UI shows a timeout message with a retry action and does not crash  
**When** the submit request exceeds 8 seconds  
**Then** the UI shows a timeout message with a retry action and does not auto-retry the mutation.  

---

## 13. Audit & Observability

### User-visible audit data
- On success, show:
  - `inventoryReturnId`
  - `processedAt` (displayed in user locale, sourced from UTC)
  - Summary of returned items (sku/workOrderLineId, qty, reason)
- If backend provides: processed by user display name/id

### Status history / traceability expectations
- The return transaction must be traceable by `inventoryReturnId` for support.
- UI must surface `X-Correlation-Id` in error technical details when present (DECISION-INVENTORY-012).
- **Sensitive data policy:** do not log quantities or raw payloads to console/telemetry (DECISION-INVENTORY-011). Telemetry may include timing, HTTP status, and correlation ID only.

---

## 14. Non-Functional UI Requirements
- **Performance:** Initial load should avoid N+1 calls; target ‚â§ 3 calls (returnable items + reason codes + locations; storage locations only after location selection if needed). Use cursor pagination for pickers if lists are large (DECISION-INVENTORY-003).
- **Accessibility:** WCAG 2.1 AA; form fields have labels; errors are announced (aria-live) and associated with inputs.
- **Responsiveness:** Works on tablet widths typical for warehouse/parts counter.
- **i18n/timezone:** Display `processedAt` using user timezone; reason labels display from backend-provided label. Currency not applicable.
- **Security:** 401 redirects to login/session refresh; 403 shows forbidden state without data leakage (DECISION-INVENTORY-012).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty state when no returnable items are available; qualifies as safe UI ergonomics. Impacted sections: UX Summary, Alternate/Error Flows.
- SD-UX-INFLIGHT-GUARD: Disable submit button and show loading indicator during submit to prevent accidental double submission; safe because it does not change domain rules. Impacted sections: Functional Behavior, Acceptance Criteria.
- SD-ERR-STD-MAP: Map HTTP 401/403/404/409/422/5xx to standard inline/page error presentation; safe because it follows backend semantics without inventing policy. Impacted sections: Service Contracts, Alternate/Error Flows.
- SD-OBS-TIMEOUT-8S: Client shows timeout state at 8 seconds with retry affordance; safe because it is a UX target from inventory domain guidance and does not change business rules. Impacted sections: Alternate/Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Backend contract (blocking):** What are the exact Moqui proxy endpoints and payload shapes for:
   - loading returnable items for a work order (including stable line identifiers like `workOrderLineId`)
   - listing return reason codes
   - submitting a return-to-stock transaction and receiving `inventoryReturnId`
   - deterministic error schema details for line-level mapping (field paths / identifiers)
2. **Destination semantics (blocking):** For return-to-stock, what is the required destination model?
   - Is destination always the work order‚Äôs site `locationId` (immutable), or user-selectable?
   - Is `storageLocationId` supported/required for returns, or is site-level (`locationId` only) sufficient?
3. **Permission strings (blocking):** What are the canonical permission string(s) for:
   - viewing/using the return screen action
   - submitting a return-to-stock transaction  
   (Must align with `DECISION-INVENTORY-010` naming conventions.)
4. **Post-success navigation (non-blocking but required for implementation):** Should success:
   - return to Work Order detail with a banner, or
   - navigate to a dedicated confirmation/details screen for `inventoryReturnId`?
5. **Idempotency (blocking for safe retry guidance):** Does the submit endpoint support idempotency keys for `POST`? If yes, what header/field should the UI send, and what is the retry guidance after a timeout?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Fulfillment: Return Unused Items to Stock with Reason ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/242

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #241: [FRONTEND] [STORY] Counts: Plan Cycle Counts by Location/Zone
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Counts: Plan Cycle Counts by Location/Zone

### Primary Persona
Inventory Manager

### Business Value
Enable Inventory Managers to schedule targeted cycle count plans by storage location and zone to improve inventory accuracy and operational planning.

---

## 2. Story Intent

### As a / I want / So that
**As an** Inventory Manager,  
**I want** to create a Cycle Count Plan by selecting a Location and one or more Zones and a future scheduled date,  
**so that** warehouse staff can execute planned counts and the organization can maintain accurate stock records.

### In-scope
- UI flow to create a new Cycle Count Plan:
  - Select **Location** (Inventory `LocationRef` / `locationId`)
  - Select **one or more Zones** belonging to the selected Location
  - Choose **scheduled date** (must not be in the past; see Open Questions for ‚Äútoday‚Äù and timezone)
  - Optional **plan name/description** (field name TBD)
- Frontend validation + backend validation error display using deterministic error schema conventions (DECISION-INVENTORY-003)
- Successful creation confirmation and navigation to view/list
- Read-only visibility of plan ‚Äúcreated‚Äù metadata after submit (as returned by API)

### Out-of-scope
- Executing the count (starting plan, entering count results, adjustments)
- Editing plan scope after creation (location/zones) unless explicitly supported by backend
- Recurring plans
- Defining how SKUs are selected for inclusion (scope logic) beyond displaying what backend returns
- Location/Zone administration (creating zones/locations)
- Any inventory movement/ledger mutation (Inventory ledger is append-only; not part of counts planning) (DECISION-INVENTORY-005)

---

## 3. Actors & Stakeholders
- **Inventory Manager (primary):** creates scheduled cycle count plans.
- **Warehouse Staff (downstream):** will execute counts generated from plans (not in scope).
- **Auditor / Ops Manager (stakeholder):** expects traceable history of created plans (display only, if available).
- **System (Moqui app):** enforces permissions, validation, and persists plan via services/APIs.

---

## 4. Preconditions & Dependencies
- User is authenticated (401 behavior per DECISION-INVENTORY-012).
- User has permission to view counts planning screens and create cycle count plans (permission string(s) TBD; must follow canonical colon-separated convention once confirmed) (DECISION-INVENTORY-010).
- At least one Location exists (Inventory `LocationRef` list is available via Moqui proxy) (DECISION-INVENTORY-002, DECISION-INVENTORY-008).
- Selected Location has one or more Zones (or UI must handle empty zones).
- Backend endpoints/services exist (via Moqui proxy; Vue must not call inventory backend directly) (DECISION-INVENTORY-002) for:
  - Listing Locations (existing: `GET /inventory/locations`) (DECISION-INVENTORY-008)
  - Listing Zones for a Location (endpoint TBD)
  - Creating a Cycle Count Plan (endpoint TBD)
  - (Optional) Fetching a Cycle Count Plan by id for detail view (endpoint TBD)
- Backend returns deterministic error schema for validation and authorization failures (DECISION-INVENTORY-003) and includes/echoes `X-Correlation-Id` (DECISION-INVENTORY-012).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Left-nav or menu entry: **Inventory ‚Üí Counts ‚Üí Cycle Count Plans**
- Primary CTA on list screen: **‚ÄúNew Cycle Count Plan‚Äù** (visible only when user has create permission; otherwise hidden/disabled with explanation) (DECISION-INVENTORY-010)

### Screens to create/modify (Moqui)
1. **Screen:** `apps/pos/inventory/counts/PlanList.xml` (path must match repo conventions)
   - Lists existing cycle count plans (minimum columns: plan name/description (if present), location, scheduled date, status, createdAt)
   - CTA navigates to create screen
2. **Screen:** `apps/pos/inventory/counts/PlanCreate.xml`
   - Form to create plan
   - Loads locations on entry
   - Loads zones dynamically after location selection
3. **Screen (optional but recommended):** `apps/pos/inventory/counts/PlanDetail.xml`
   - After create, navigate to detail view for created `planId` **only if** backend supports fetch-by-id; otherwise navigate back to list with a success banner.

> Integration pattern: screens call Moqui transitions/services that proxy to inventory/counts backend; no direct Vue ‚Üí backend calls. (DECISION-INVENTORY-002)

### Navigation context
- Breadcrumb example: Inventory > Counts > Cycle Count Plans > New Plan
- Back action returns to Plan List preserving filters (safe default)

### User workflows (happy + alternate paths)

**Happy path**
1. User opens Cycle Count Plans list
2. Clicks ‚ÄúNew Cycle Count Plan‚Äù
3. Selects Location
4. Selects one or more Zones for that Location
5. Sets scheduled date (not in the past; ‚Äútoday‚Äù rule TBD)
6. Optionally enters plan name/description
7. Submits
8. Sees success message and is redirected to Plan Detail (if supported) or Plan List with the new plan visible

**Alternate paths**
- Location selected but has no zones ‚Üí show empty state + disable submit
- Scheduled date in past ‚Üí inline validation; on submit show backend error mapping if returned
- Backend 403 ‚Üí show forbidden state; disable/hide submit and do not leak any plan data (DECISION-INVENTORY-012)
- Network/timeout ‚Üí show bounded timeout message with retry (DECISION-INVENTORY-004)

---

## 6. Functional Behavior

### Triggers
- User visits Plan List screen
- User visits Plan Create screen
- User selects a Location
- User submits create form

### UI actions
- **On Plan List load**:
  - Call list plans endpoint (TBD) with cursor pagination if list is server-paged (preferred)
- **On Plan Create load**:
  - Fetch Locations via Moqui proxy
- **On location change**:
  - Clear any previously selected zones
  - Fetch Zones for chosen location
- **On submit**:
  - Validate required fields client-side
  - Call create plan endpoint via Moqui transition/service
  - On success:
    - Show success toast/banner
    - Navigate to Plan Detail if supported, else back to Plan List
  - On failure:
    - Map deterministic field errors to fields when possible
    - Otherwise show page-level error with correlation id in ‚ÄúTechnical details‚Äù (DECISION-INVENTORY-012)

### State changes (frontend)
- Plan Create form state: `idle ‚Üí loadingLocations ‚Üí ready ‚Üí loadingZones ‚Üí ready ‚Üí submitting ‚Üí success|error`
- Disable submit while `submitting`
- Disable zone multi-select until zones loaded
- Prevent double-submit: submit button disabled while in-flight; no auto-retry of mutations (STORY_VALIDATION_CHECKLIST: Events & Idempotency)

### Service interactions (Moqui)
- Use Moqui `transition` invoking a `service-call` (preferred) or `rest-call` (if proxy is implemented as REST) for:
  - `GET /inventory/locations` (known) (DECISION-INVENTORY-008)
  - Zones list endpoint (TBD)
  - Create cycle count plan endpoint (TBD)
  - Optional plan list/detail endpoints (TBD)
- Ensure transitions capture and render errors in the screen messages area consistent with Moqui patterns.
- Ensure `X-Correlation-Id` is sent and surfaced on errors (DECISION-INVENTORY-012).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Location is required**
  - If missing: block submit; show message ‚ÄúLocation is required.‚Äù
- **At least one Zone is required**
  - If none selected: block submit; show message ‚ÄúSelect at least one zone.‚Äù
- **Scheduled date cannot be in the past**
  - Client-side: if date < ‚Äútoday‚Äù (timezone rule TBD), show inline error and block submit
  - Server-side: display returned error message; do not override with different wording
- **Plan name/description optional**
  - Do not enforce a max length client-side until backend limit is confirmed; rely on backend validation and surface field error deterministically (DECISION-INVENTORY-003)

### Enable/disable rules
- Zone selector disabled until a Location is selected and zones are loaded.
- Submit disabled until all required fields valid and zones loaded.
- If user lacks create permission (known via app permission model or inferred after 403), hide/disable submit and show explanation (DECISION-INVENTORY-010, DECISION-INVENTORY-012).

### Visibility rules
- If user lacks create permission:
  - Plan List: hide/disable ‚ÄúNew Cycle Count Plan‚Äù CTA
  - Plan Create: show forbidden state or inline ‚ÄúYou do not have permission‚Ä¶‚Äù and disable inputs
- If zones list is empty:
  - Show ‚ÄúNo zones configured for this location.‚Äù and keep submit disabled

### Error messaging expectations
- Deterministic error schema (DECISION-INVENTORY-003):
  - Field-level errors displayed adjacent to corresponding field when backend identifies a field
  - Unknown error shapes fall back to generic message without crashing
- 401: redirect to login/session refresh per app convention (DECISION-INVENTORY-012)
- 403: render forbidden state without leaking data (DECISION-INVENTORY-012)
- Include correlation id in technical details when available (DECISION-INVENTORY-012)

---

## 8. Data Requirements

### Entities involved (conceptual; frontend-facing)
- `CycleCountPlan` (counts domain concept; owned within Inventory area for UI routing in this repo)
- `LocationRef` (Inventory read model of HR locations) (DECISION-INVENTORY-008)
- `Zone` (counts topology concept; endpoint/schema TBD)

### Fields (type, required, defaults)

**CycleCountPlan (create payload) ‚Äî schema TBD**
- `locationId` (string UUIDv7 likely, required)
- `zoneIds` (array of string UUIDs, required, min 1)
- `scheduledDate` (date string, required; format TBD)
- Optional free-text field: `planName` or `description` (string, optional; naming/limits TBD)

**CycleCountPlan (response/display) ‚Äî minimum expected**
- `planId` (string UUID)
- `status` (string enum; at least `PLANNED` expected)
- `createdBy` (string/userId; display if returned)
- `createdAt` (timestamp; display if returned)
- `updatedAt` (timestamp; display if returned)

**LocationRef (picker/list)**
- `locationId` (string UUIDv7)
- Display label field: `name`/`locationName` (exact field name TBD; must map from `GET /inventory/locations` response)

**Zone (picker/list)**
- `zoneId` (string UUID)
- `zoneName` (string)

### Read-only vs editable by state/role
- On Create screen: all inputs editable (subject to permission)
- After creation: details are read-only in this story (no edit requirements provided)
- Status is always read-only in this story

### Derived/calculated fields
- None calculated in frontend.
- If backend returns ‚Äúitems included in plan‚Äù counts, display as read-only metadata; do not compute client-side.

---

## 9. Service Contracts (Frontend Perspective)

> Counts planning endpoints are **not defined** in the provided Inventory domain decisions. Only the Moqui proxy pattern, error schema conventions, and locations endpoint are authoritative here. Therefore, contracts below are **partially specified** and require clarification before implementation.

### Load/view calls

1. **List Locations (authoritative)**
   - Method: `GET`
   - Path: `/inventory/locations` (Moqui proxy) (DECISION-INVENTORY-008, DECISION-INVENTORY-002)
   - Response: plain JSON (DECISION-INVENTORY-003)
     - Shape: **TBD** (must include `locationId` and a display name field)
   - Errors: 401/403 with deterministic error schema; include `X-Correlation-Id` (DECISION-INVENTORY-012)

2. **List Zones by Location (TBD)**
   - Method: `GET`
   - Path: **TBD** (must be Moqui proxy; no direct backend calls) (DECISION-INVENTORY-002)
   - Query/params: must accept `locationId`
   - Response: plain JSON list of zones with `zoneId`, `zoneName` (exact shape TBD)
   - Errors: 401/403; 404 if location not found (if backend chooses); 422 if location invalid (if backend chooses)

3. **List Cycle Count Plans (TBD, for PlanList screen)**
   - Method: `GET`
   - Path: **TBD**
   - Pagination: if list can be large, must use cursor pagination (`pageSize`, `pageToken`, `nextPageToken`) consistent with DECISION-INVENTORY-003
   - Filters: optional `locationId`, date range (TBD)

4. **Get Cycle Count Plan Detail (optional, TBD)**
   - Method: `GET`
   - Path: **TBD** (e.g., `/inventory/cycle-count-plans/{planId}` but not assumed)
   - Response: plain JSON plan object

### Create/update calls

5. **Create Cycle Count Plan (TBD)**
   - Method: `POST`
   - Path: **TBD** (Moqui proxy) (DECISION-INVENTORY-002)
   - Request (conceptual):
     ```json
     {
       "locationId": "uuid",
       "zoneIds": ["uuid"],
       "scheduledDate": "YYYY-MM-DD",
       "planName": "string (optional)"
     }
     ```
   - Success: 201/200 with body including `planId`, `status`, and echo fields (exact status code TBD)
   - Errors (expected):
     - 400/422 validation (missing zoneIds, past date, etc.) with deterministic schema (DECISION-INVENTORY-003)
     - 404 invalid location/zone (if backend uses 404)
     - 401/403 authz/authn (DECISION-INVENTORY-012)

### Submit/transition calls (Moqui)
- `transition name="createPlan"` calls the create service and on success transitions to detail/list.
- All calls must include `X-Correlation-Id` header; UI surfaces it on error (DECISION-INVENTORY-012).

### Error handling expectations
- Parse deterministic error schema (DECISION-INVENTORY-003):
  - Map field errors to `locationId`, `zoneIds`, `scheduledDate`, and optional name/description field
- Unknown errors:
  - Show: ‚ÄúCould not create cycle count plan. Try again or contact support.‚Äù
  - Show correlation id in technical details if present (DECISION-INVENTORY-012)
- Timeout UX:
  - Show loading indicator within 100ms
  - Surface timeout at 8 seconds with retry affordance
  - Do not auto-refresh loops (DECISION-INVENTORY-004)

---

## 10. State Model & Transitions

### Allowed states (minimum known)
- `PLANNED`
- `IN_PROGRESS`
- `COMPLETED`
- `CANCELLED`

> Note: These states are not defined in Inventory domain decisions; they remain **assumptions from the original story** and must be confirmed by the counts backend contract.

### Role-based transitions
- Create action allowed only for users with create permission (permission string(s) TBD; must follow DECISION-INVENTORY-010 convention once confirmed).
- No other transitions are implemented in this story.

### UI behavior per state
- Create screen creates a plan in `PLANNED` (assumed; must be confirmed by backend).
- List/Detail screens show status as read-only label.
- Status rendering must be tolerant of unknown enums (display raw value safely).

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required fields: prevent submit client-side.
- Past scheduled date:
  - If caught client-side: show inline error
  - If server rejects: display server message and keep user inputs intact

### Concurrency conflicts
- If zones list changes after selection and submit returns 404/422:
  - Show error and prompt user to re-select location/zones; keep scheduled date and plan name/description

### Unauthorized access
- 401:
  - Redirect to login/session refresh per app convention (DECISION-INVENTORY-012)
- 403:
  - Show forbidden state
  - Disable create CTA and/or form submit
  - Do not display any sensitive payloads (none expected here) (DECISION-INVENTORY-012)

### Empty states
- No locations: show ‚ÄúNo locations available. Contact an administrator.‚Äù and disable form.
- Location has zero zones: show ‚ÄúNo zones configured for this location.‚Äù and disable submit.
- Plan created but includes no items:
  - Behavior **TBD**; do not invent a status or warning without backend signal (SAFE_DEFAULTS_MODE denylist: business policy).

### Network/timeout
- At 8 seconds without response: show timeout message with Retry; keep form inputs intact (DECISION-INVENTORY-004).

---

## 12. Acceptance Criteria

### Scenario 1: Create plan successfully
**Given** I am logged in as an Inventory Manager with permission to create cycle count plans  
**And** at least one Location exists with at least one Zone  
**When** I navigate to Inventory > Counts > Cycle Count Plans and choose ‚ÄúNew Cycle Count Plan‚Äù  
**And** I select a Location  
**And** I select one or more Zones for that Location  
**And** I set a scheduled date that is not in the past  
**And** I submit the form  
**Then** the system creates the Cycle Count Plan successfully  
**And** I see a success confirmation  
**And** I am navigated to the created plan‚Äôs detail view **if supported**, otherwise to the plans list where the new plan is visible.

### Scenario 2: Prevent submit when no zones selected
**Given** I am on the New Cycle Count Plan screen  
**When** I select a Location  
**And** I do not select any Zones  
**Then** the Submit action is disabled or blocked  
**And** I see a validation message indicating at least one zone is required.

### Scenario 3: Reject scheduled date in the past (client-side)
**Given** I am on the New Cycle Count Plan screen  
**When** I enter a scheduled date that is in the past (per the app‚Äôs defined timezone rule)  
**Then** I see an inline validation error  
**And** I cannot submit the plan until the date is corrected.

### Scenario 4: Handle backend validation error for past date
**Given** I am on the New Cycle Count Plan screen  
**And** I submit the form with a scheduled date the backend deems invalid  
**When** the backend responds with a deterministic validation error for `scheduledDate`  
**Then** the UI displays the backend error message on the scheduled date field  
**And** the form remains populated for correction.

### Scenario 5: Handle stale location/zone selection
**Given** I selected a Location and Zone that later becomes invalid  
**When** I submit the plan and the backend responds with an error indicating the location or zone is invalid (e.g., 404 or 422)  
**Then** I see an error message indicating the selected location or zone is no longer valid  
**And** I can reselect Location/Zones and resubmit.

### Scenario 6: Unauthorized user cannot create plan
**Given** I am logged in without permission to create cycle count plans  
**When** I navigate to the New Cycle Count Plan screen or attempt to submit  
**Then** I receive a forbidden state (403 handling)  
**And** the create/submit controls are disabled or hidden  
**And** no plan data is displayed.

### Scenario 7: 401 redirects to login/session refresh
**Given** I am on the New Cycle Count Plan screen  
**When** any required API call responds with 401  
**Then** I am redirected to login/session refresh per app convention  
**And** after re-authentication I can return and retry.

### Scenario 8: Timeout shows retry without losing inputs
**Given** I am on the New Cycle Count Plan screen with valid inputs entered  
**When** I submit and the request does not complete within 8 seconds  
**Then** I see a timeout message with a Retry action  
**And** my entered inputs remain intact  
**And** no automatic retry occurs.

---

## 13. Audit & Observability

### User-visible audit data
- After creation, display (when returned by API): `createdBy`, `createdAt`, `status`.
- If not available, omit without placeholder fields.

### Status history
- Not required to implement unless an endpoint exists; no requirements provided.

### Traceability expectations
- All requests include `X-Correlation-Id`; on error, show correlation id in ‚ÄúTechnical details‚Äù (DECISION-INVENTORY-012).
- Client telemetry/events (if present in app conventions):
  - Record attempt/success/failure with timing and correlation id
  - Do **not** log sensitive quantities (not applicable here) and do not log full payloads (DECISION-INVENTORY-011)
  - Do not log free-text description content if it may contain sensitive notes; if logged at all, log only presence/length (security-safe default aligned with DECISION-INVENTORY-011).

---

## 14. Non-Functional UI Requirements
- **Performance:** Show loading indicator within 100ms; timeout at 8 seconds with retry; no auto-refresh loops. (DECISION-INVENTORY-004)
- **Accessibility:** WCAG 2.1 AA; all form controls labeled; validation errors announced to screen readers.
- **Responsiveness:** Usable on tablet form factor typical for warehouse/POS operations.
- **i18n/timezone:** Date handling must respect the defined timezone rule for ‚Äúpast‚Äù validation (TBD). Display dates in local format; send in API-required format (TBD).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for ‚Äúno locations‚Äù and ‚Äúno zones‚Äù; qualifies as safe because it does not change domain behavior, only improves UX clarity. (Impacted: UX Summary, Alternate / Error Flows)
- SD-UX-LOADING-STATES: Show loading indicators and disable dependent controls while fetching; safe as it only affects ergonomics. (Impacted: Functional Behavior, Alternate / Error Flows)
- SD-ERR-GENERIC: For unexpected 5xx/network errors, show a generic retry message while preserving form inputs; safe because it doesn‚Äôt alter business logic. (Impacted: Error Flows, Service Contracts)
- SD-OBS-CORRELATION-ID: Surface `X-Correlation-Id` in error technical details; safe because it is an observability convention and does not change business policy. (Impacted: Service Contracts, Audit & Observability, Error Flows)

---

## 16. Open Questions
1. **Counts API contracts (blocking):** What are the exact Moqui proxy endpoints (paths), request/response schemas, and deterministic error schema fields for:
   - list zones by location
   - create cycle count plan
   - list plans (for PlanList)
   - get plan by id (for PlanDetail, if desired)
2. **Permission name(s) (blocking):** What permission string(s) gate:
   - viewing counts planning screens
   - creating a plan  
   Must follow canonical colon-separated convention (DECISION-INVENTORY-010). Confirm the exact strings (the story currently references `INVENTORY_PLAN_CREATE`, which conflicts with the convention).
3. **Field naming + limits (blocking):** Is the optional free-text field `planName`, `description`, or both? What are max lengths and allowed characters?
4. **Scheduled date rule (blocking):** Is ‚Äútoday‚Äù allowed, or must it be strictly future? Align backend validation message and UI copy.
5. **Timezone definition (blocking):** Is ‚Äúpast‚Äù evaluated in user timezone, site/location timezone, or UTC?
6. **Empty zones/items behavior (blocking):** If selected zones contain no inventory items:
   - Should creation be allowed?
   - Should UI show a warning on success?
   - Is there a distinct status or flag returned?
7. **Post-create navigation (blocking):** Should we navigate to a Plan Detail screen (requires GET by `planId`) or back to list only? If detail is required, confirm endpoint and minimum fields.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #121: [FRONTEND] [STORY] Master: Create Product Record (Part/Tire) with Identifiers and Attributes
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:inventory-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Inventory: Availability Lookup (by Product SKU + Location/Bin) with Deep Links (Moqui Screens)

## Primary Persona
Inventory Staff (counter/warehouse user needing quick availability answers)

## Business Value
Provide a fast, bookmarkable, backend-authoritative availability view (on-hand/allocated/ATP) for a product at a site or bin so staff can answer ‚Äúdo we have it?‚Äù without manual calculations, while preserving security (no quantity logging) and traceability (correlation IDs).

---

# 2. Story Intent

## As a / I want / So that
- **As an** Inventory Staff user  
- **I want** to look up availability for a product SKU at a location (and optionally a storage location/bin)  
- **So that** I can make operational decisions quickly using authoritative inventory data.

## In-scope
- Moqui UI screens for:
  - Availability lookup form with pickers for `locationId` and optional `storageLocationId`
  - Results view showing availability fields returned by the backend (read-only)
  - Deep-link support via query params: `productSku`, `locationId`, `storageLocationId` (optional) with auto-run once per load
- Client-side validation for required inputs (trimmed non-empty `productSku`, required `locationId`, storage location must belong to selected location when possible)
- Integration via **Moqui proxy endpoint** only (no direct Vue ‚Üí inventory backend)
- Deterministic error handling and UX for 401/403/422/5xx including correlation ID display
- Empty-state behavior: ‚Äúno inventory history‚Äù is success-with-zeros

## Out-of-scope
- Any client-side computation of on-hand/allocated/ATP (backend is authoritative)
- Any inventory movement creation (receipt/transfer/adjustment/etc.)
- Ledger browsing (separate story)
- Reservation/allocation service calls from the frontend (frontend does not call them directly)
- Auto-refresh loops or polling

---

# 3. Actors & Stakeholders
- **Inventory Staff (Primary):** Uses availability to answer customer/internal questions.
- **Inventory Manager (Stakeholder):** Wants consistent, auditable, supportable behavior.
- **Support/IT (Stakeholder):** Needs correlation IDs to trace errors without exposing sensitive data.
- **Security/Audit (Stakeholder):** Requires no logging of sensitive quantities and correct 401/403 handling.
- **System (Moqui + Inventory services):** Enforces auth, permissions, and returns authoritative availability.

---

# 4. Preconditions & Dependencies
- User is authenticated in the POS/Moqui session.
- Moqui proxy routes are available same-origin:
  - `GET /inventory/availability` (DECISION-INVENTORY-002, DECISION-INVENTORY-004)
  - `GET /inventory/locations` for LocationRef picker (DECISION-INVENTORY-008)
  - `GET /inventory/storage-locations?locationId=...` for StorageLocation picker (DECISION-INVENTORY-007)
- Deterministic error schema is returned on failures (DECISION-INVENTORY-003).
- Correlation ID header `X-Correlation-Id` is supported and echoed on errors (DECISION-INVENTORY-012).
- Permission model for viewing availability is not specified in provided inventory decisions (must be clarified).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Backoffice navigation: **Inventory ‚Üí Availability**
- Deep links (canonical query params; DECISION-INVENTORY-014):
  - `/inventory/availability?productSku=...&locationId=...`
  - `/inventory/availability?productSku=...&locationId=...&storageLocationId=...`

## Screens to create/modify (Moqui)
Create a screen tree under an inventory namespace consistent with repo conventions, e.g.:
- `inventory/Availability.xml` (screen with form + results section)
- Reusable components:
  - `components/LocationRefPicker.xml` (LocationRef picker; active-only by default)
  - `components/StorageLocationPicker.xml` (filtered by `locationId`; operational-only by default)

> If the repository already has an Inventory menu/screen tree, add this as a subscreen and reuse existing picker components rather than duplicating.

## Navigation context
- Availability screen is a single-page workflow: inputs at top, results below.
- When arriving via deep link with required params present, the lookup auto-runs once and populates results.
- Changing inputs clears ‚Äústale‚Äù results until the user re-runs (or auto-run triggers on initial load only).

## User workflows (happy + alternate paths)

### Happy path: Manual lookup (site-level)
1. User opens Inventory ‚Üí Availability.
2. Enters `productSku`.
3. Selects a `locationId` via picker.
4. Leaves `storageLocationId` empty to aggregate across bins.
5. Clicks ‚ÄúCheck availability‚Äù.
6. Results render.

### Happy path: Manual lookup (bin-level)
1. User selects `locationId`.
2. Selects `storageLocationId` filtered by that location.
3. Runs lookup and sees bin-scoped results.

### Happy path: Deep link auto-run
1. User opens a bookmarked URL with `productSku` and `locationId` (and optional `storageLocationId`).
2. Screen loads, validates params, and auto-runs once.
3. Results render; user may adjust inputs and run again manually.

### Alternate path: ‚ÄúNo inventory history‚Äù
- Backend returns success with zeros; UI shows a clear empty-state message while still rendering the numeric fields (if provided) as zeros. (DECISION-INVENTORY-004)

---

# 6. Functional Behavior

## Triggers
- Screen load:
  - Parse query params `productSku`, `locationId`, `storageLocationId` into form state (DECISION-INVENTORY-014)
  - If `productSku` and `locationId` are present and valid, auto-run lookup **once per load**
- User clicks ‚ÄúCheck availability‚Äù
- User changes `locationId`:
  - Clear `storageLocationId` selection
  - Clear results and errors

## UI actions
- Form inputs:
  - `productSku` (text; trimmed; required)
  - `locationId` (picker; required; no free-text UUID entry in normal flow; DECISION-INVENTORY-001)
  - `storageLocationId` (picker; optional; filtered by `locationId`; DECISION-INVENTORY-001, DECISION-INVENTORY-007)
- Primary action:
  - ‚ÄúCheck availability‚Äù (disabled until required inputs valid; disabled while request in-flight)
- Secondary actions:
  - ‚ÄúClear‚Äù resets form and results
  - ‚ÄúCopy link‚Äù copies current URL with canonical query params (no additional params)

## State changes
- UI-only state machine:
  - `idle` ‚Üí `loading` ‚Üí `success` | `error`
  - `success` may include ‚Äúzeros‚Äù (still success)

## Service interactions
- Availability lookup:
  - `GET /inventory/availability?productSku=...&locationId=...&storageLocationId=...` (storageLocationId omitted when not selected)
  - Plain JSON response (no `{data: ...}` envelope; DECISION-INVENTORY-002, DECISION-INVENTORY-003)
- Picker data:
  - `GET /inventory/locations` for LocationRef list (DECISION-INVENTORY-008)
  - `GET /inventory/storage-locations?locationId=...` for StorageLocation list (DECISION-INVENTORY-007)

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- `productSku`:
  - Trim whitespace
  - Reject empty/whitespace-only with inline error: ‚ÄúProduct SKU is required.‚Äù
- `locationId`:
  - Required; must be selected via picker (no free-text UUID entry in v1 user-facing flows; DECISION-INVENTORY-001)
- `storageLocationId`:
  - Optional
  - If selected, must belong to selected `locationId`:
    - Enforced by filtering picker options by `locationId`
    - If deep link provides a mismatched `storageLocationId`, show inline error and do not auto-run until corrected
- Location eligibility for movement is not applicable here (read-only screen), but selection lists should still default to operationally relevant locations:
  - Location picker defaults to ACTIVE locations only; provide an ‚ÄúInclude inactive‚Äù toggle for historical lookup if supported by endpoint response (DECISION-INVENTORY-009 allows historical display read-only; selection rules for read-only screens are not fully specified‚Äîsee Open Questions).

## Enable/disable rules
- Disable ‚ÄúCheck availability‚Äù when:
  - `productSku` invalid OR `locationId` missing OR request in-flight
- Disable ‚ÄúCopy link‚Äù when required params missing (since link would not auto-run)

## Visibility rules
- Results section:
  - Hidden in `idle` state
  - Visible in `success` state (including zeros)
  - In `error` state, show an error panel with retry button and correlation ID (if available)
- ‚ÄúTechnical details‚Äù accordion shows:
  - Correlation ID (if present)
  - HTTP status / error code (if provided by deterministic schema)
  - No sensitive quantities or payloads

## Error messaging expectations
- 401: redirect to login/session refresh per app convention (DECISION-INVENTORY-012)
- 403: show forbidden state ‚ÄúYou do not have access to view inventory availability.‚Äù with no data leakage (DECISION-INVENTORY-012)
- 422 (validation/business rule from backend): show banner ‚ÄúUnable to fetch availability. Please verify inputs.‚Äù and map field errors if provided (DECISION-INVENTORY-003)
- 404: treat as not-found for referenced IDs only if backend uses it; otherwise show generic error with correlation ID
- 5xx/timeout:
  - Show timeout at 8 seconds with ‚ÄúRetry‚Äù (DECISION-INVENTORY-004 UX target)
  - Do not auto-retry

---

# 8. Data Requirements

## Entities involved (frontend perspective)
- `LocationRef` (read model; list/detail via inventory endpoints; DECISION-INVENTORY-008)
- `StorageLocation` (inventory-managed bins; DECISION-INVENTORY-007)
- `AvailabilityView` (read-only response; DECISION-INVENTORY-004)

## Fields (type, required, defaults)

### Form inputs
- `productSku` (string, required; trimmed)
- `locationId` (UUIDv7 string, required; selected via picker)
- `storageLocationId` (UUIDv7 string, optional; selected via picker filtered by `locationId`)

### LocationRef (for picker display)
Minimum fields needed:
- `locationId` (UUIDv7)
- `name` (string)
- `status` (enum: `ACTIVE` | `INACTIVE` | `PENDING` if present; DECISION-INVENTORY-009)
Optional:
- `code`/`externalRef` if provided for disambiguation

### StorageLocation (for picker display)
Minimum fields needed:
- `storageLocationId` (UUIDv7)
- `locationId` (UUIDv7)
- `name` (string)
- `barcode` (string, optional)
- `status` (enum: `ACTIVE` | `INACTIVE` if present)

### AvailabilityView (results)
Backend-authoritative; UI must render whatever numeric fields are returned without computing derived values.
Minimum expected conceptual fields (names must match backend response; see Open Questions):
- `productSku` (string)
- `locationId` (UUIDv7)
- `storageLocationId` (UUIDv7, nullable/omitted)
- Quantity fields (numbers) such as:
  - `onHandQty`
  - `allocatedQty`
  - `availableToPromiseQty` (ATP)
- Optional metadata:
  - `asOf` timestamp
  - `uom` string

## Read-only vs editable by state/role
- Entire AvailabilityView is read-only.
- Form inputs editable for any user who can access the screen; action availability may be permission-gated (see Open Questions).

## Derived/calculated fields
- None computed client-side.
- UI may display a derived label like ‚ÄúSite total‚Äù when `storageLocationId` is empty (pure presentation, not calculation).

---

# 9. Service Contracts (Frontend Perspective)

## Load/view calls

### Availability
- **Method/Path:** `GET /inventory/availability`
- **Query params (canonical; DECISION-INVENTORY-014):**
  - `productSku` (required)
  - `locationId` (required)
  - `storageLocationId` (optional)
- **Response:** plain JSON object (DECISION-INVENTORY-002, DECISION-INVENTORY-003)
- **Success-with-zeros:** valid success response may contain zero quantities when no history exists (DECISION-INVENTORY-004)

### LocationRef list (picker)
- **Method/Path:** `GET /inventory/locations`
- **Response:** plain JSON list (or paged list if backend does so; if paged, must use cursor pagination per DECISION-INVENTORY-003)

### StorageLocation list (picker)
- **Method/Path:** `GET /inventory/storage-locations`
- **Query params:** `locationId` (required)
- **Response:** plain JSON list (or paged list with cursor pagination)

## Create/update calls
- None (read-only story)

## Submit/transition calls
- None (read-only story)

## Error handling expectations
- Deterministic error schema (DECISION-INVENTORY-003):
  - Map field errors to `productSku`, `locationId`, `storageLocationId` when provided
  - Unknown shapes fall back to generic error banner with correlation ID
- Correlation ID:
  - Send `X-Correlation-Id` header on request; display echoed value on error (DECISION-INVENTORY-012)
- Sensitive data:
  - Do not log quantities or full response payloads to console/telemetry (DECISION-INVENTORY-011)

---

# 10. State Model & Transitions

## Allowed states
UI state only:
- `idle`
- `loading`
- `success`
- `error`

## Role-based transitions
- If user lacks permission to view availability (permission string unknown):
  - Screen should render forbidden state (403) and not show results (DECISION-INVENTORY-012)

## UI behavior per state
- `idle`: show form; no results
- `loading`: show spinner within 100ms; disable submit; keep form visible (DECISION-INVENTORY-004 UX target)
- `success`: show results; if zeros, show ‚ÄúNo inventory history found for this selection‚Äù message (DECISION-INVENTORY-004)
- `error`: show error panel with retry; show correlation ID in technical details (DECISION-INVENTORY-012)

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- Empty `productSku`:
  - Inline error; do not call backend
- Missing `locationId`:
  - Inline error; do not call backend
- Deep link includes invalid/mismatched `storageLocationId`:
  - Do not auto-run; show inline error and require user correction

## Concurrency conflicts
- Not applicable (read-only)

## Unauthorized access
- 401:
  - Redirect to login/session refresh (DECISION-INVENTORY-012)
- 403:
  - Render forbidden state; do not display cached/stale results; do not leak prior results

## Empty states
- Success-with-zeros:
  - Show empty-state copy but still render returned fields as zeros (DECISION-INVENTORY-004)
- Picker empty:
  - If no locations available, show ‚ÄúNo locations available‚Äù and disable lookup

## Timeout / network failure
- At 8 seconds:
  - Show timeout message and ‚ÄúRetry‚Äù button (DECISION-INVENTORY-004)
  - Do not auto-retry; do not loop

---

# 12. Acceptance Criteria

## Scenario 1: Manual availability lookup (site-level) success
**Given** I am authenticated  
**And** I can access Inventory ‚Üí Availability  
**When** I enter a non-empty `productSku` and select a `locationId`  
**And** I click ‚ÄúCheck availability‚Äù  
**Then** the UI calls `GET /inventory/availability` via the Moqui proxy with `productSku` and `locationId`  
**And** the UI renders the returned availability response as read-only results  
**And** the UI does not compute or modify quantities client-side.

## Scenario 2: Manual availability lookup (bin-level) success
**Given** I have selected a `locationId`  
**When** I select a `storageLocationId` from a picker filtered to that `locationId`  
**And** I run the lookup  
**Then** the UI calls `GET /inventory/availability` including `storageLocationId`  
**And** results reflect the bin-scoped response.

## Scenario 3: Deep link auto-run once
**Given** I open `/inventory/availability?productSku=SKU1&locationId=L1`  
**When** the screen loads  
**Then** the form is prefilled from query params  
**And** the lookup auto-runs exactly once without user interaction  
**And** subsequent re-renders do not trigger additional automatic calls unless I manually submit.

## Scenario 4: Success-with-zeros empty state
**Given** the backend returns a successful availability response with zero quantities for my selection  
**When** results render  
**Then** the UI shows a message indicating no inventory history/availability for the selection  
**And** the UI still treats the response as success (no error state).

## Scenario 5: Client-side validation blocks submit
**Given** I am on the Availability screen  
**When** `productSku` is empty or whitespace-only  
**Or** `locationId` is not selected  
**Then** ‚ÄúCheck availability‚Äù is disabled or submission is blocked  
**And** inline validation messages are shown  
**And** no request is sent.

## Scenario 6: 401 handling
**Given** my session is expired  
**When** I attempt to run an availability lookup and the server responds 401  
**Then** the UI follows the app convention to redirect to login/session refresh  
**And** it does not display partial results.

## Scenario 7: 403 handling (forbidden)
**Given** I am authenticated but not authorized  
**When** the server responds 403 to an availability request  
**Then** the UI shows a forbidden state without displaying any availability data  
**And** it provides the correlation ID (if present) in technical details.

## Scenario 8: Timeout handling
**Given** the availability request does not complete within 8 seconds  
**When** the timeout threshold is reached  
**Then** the UI shows a timeout message and a ‚ÄúRetry‚Äù action  
**And** it does not auto-retry.

## Scenario 9: Sensitive data is not logged
**Given** an availability request succeeds  
**When** the UI renders results  
**Then** no numeric quantities from the response are written to console logs or client telemetry.

---

# 13. Audit & Observability

## User-visible audit data
- Not an audit screen; however, error UI must show:
  - `X-Correlation-Id` (DECISION-INVENTORY-012)
  - Deterministic error code/message (when provided; DECISION-INVENTORY-003)

## Status history
- Not applicable (read-only availability view)

## Traceability expectations
- Every request includes `X-Correlation-Id` header.
- Client-side telemetry (if present) records:
  - screen name, request duration, HTTP status, correlation ID
  - MUST NOT include quantities or raw payloads (DECISION-INVENTORY-011)

---

# 14. Non-Functional UI Requirements
- **Performance:** show loading indicator within 100ms; do not block typing while loading (DECISION-INVENTORY-004).
- **Reliability:** timeout at 8 seconds with retry; no auto-refresh loops (DECISION-INVENTORY-004).
- **Accessibility:** form fields labeled; errors announced; keyboard operable pickers.
- **Responsiveness:** usable on tablet widths; results section scrolls without breaking layout.
- **i18n/timezone:** display timestamps (e.g., `asOf`) in user locale/timezone if present; no currency.

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a success empty-state message for zero-quantity responses; qualifies as safe because backend defines success-with-zeros and UI only improves clarity. Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- SD-UX-TIMEOUT-RETRY: Implement an 8-second timeout with a retry button and no auto-retry; qualifies as safe because it is explicitly specified as a UX target in inventory decisions. Impacted sections: Business Rules, Alternate / Error Flows, Non-Functional UI Requirements, Acceptance Criteria.
- SD-ERR-STANDARD-MAPPING: Standard mapping for 401/403/422/5xx to UI states with correlation ID display; qualifies as safe because deterministic error handling and 401/403 behavior are defined by inventory decisions. Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows, Acceptance Criteria.

---

# 16. Open Questions

1. **Domain conflict (blocking):** This issue‚Äôs original content is about **Product Master / Catalog** (create/manage products), which is explicitly *not* owned by Inventory per the provided Inventory domain boundaries. Should this story be re-labeled to `domain:product` and rewritten under the Product domain agent instead? If yes, confirm the correct domain label taxonomy to use in this repo.
2. **Availability permission (blocking):** What permission string gates viewing the Availability screen and calling `GET /inventory/availability` (e.g., `inventory:availability:view`)? Inventory decisions define permissions for topology/feedops but not availability.
3. **Availability response schema (blocking):** What are the exact JSON field names returned by `GET /inventory/availability` (e.g., `onHandQty`, `allocatedQty`, `atpQty`, `uom`, `asOf`)? The UI must render fields deterministically without guessing names.
4. **Locations endpoint shape (blocking):** Does `GET /inventory/locations` return all statuses by default, and does it support filtering (e.g., `status=ACTIVE`)? This affects whether the UI can implement an ‚ÄúInclude inactive‚Äù toggle without client-side filtering of unbounded lists.
5. **Storage locations endpoint paging (blocking):** Is `GET /inventory/storage-locations?locationId=...` paginated with cursor tokens (per DECISION-INVENTORY-003), and if so what is the exact response shape (`items` + `nextPageToken` vs top-level array + token)?
6. **Deterministic error schema details (blocking):** What is the exact error payload structure for field errors (e.g., `{errors:[{field,message,code}]}`)? Needed to map backend validation to inline field messages consistently.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #120: [FRONTEND] [STORY] Master: Manage UOM and Pack/Case Conversions
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] Master: Manage UOM and Pack/Case Conversions

**Primary Persona:** Product Administrator (a.k.a. Product Admin)

**Business Value:** Ensures pack/case vs each quantities transact consistently across POS, Inventory stock moves, and Work Execution lines by maintaining a single authoritative set of UOM conversions with validation and auditability.

---

## 2. Story Intent

### As a / I want / So that
**As a** Product Administrator,  
**I want** to create, view, update, and deactivate Unit of Measure (UOM) conversion rules (e.g., Case ‚Üí Each),  
**So that** the system can correctly convert quantities between packaging units (each/pack/case) for inventory movements and operational transactions, with enforced validation and audit trails.

### In-scope
- A Master Data UI to:
  - List/query UOM conversions
  - Create a new conversion (fromUom ‚Üí toUom with factor)
  - Update an existing conversion‚Äôs factor (with constraints)
  - Deactivate a conversion (no hard delete)
  - View audit metadata for conversions (created/updated by/at); link or panel for audit entries if available
- Frontend validation mirroring backend rules:
  - Factor must be > 0
  - Prevent duplicates for same from/to pair
  - Prevent invalid self-conversion (unless factor = 1)
- Moqui screen(s), forms, transitions, and service calls wiring for the above

### Out-of-scope
- Creating/editing UnitOfMeasure master records themselves (unless backend explicitly supports it)
- Applying conversions in sales pricing/tax calculations
- Designing inventory reservation/allocation logic (downstream consumers)
- Bulk import/export of conversions
- Defining conversion ‚Äúper product‚Äù vs ‚Äúglobal‚Äù beyond what backend supports (see Open Questions)

---

## 3. Actors & Stakeholders
- **Primary Actor:** Product Administrator
- **Stakeholders / Consumers:**
  - Inventory operations (stock moves use UOM conversions)
  - Work Execution (work order/parts lines use UOM conversions)
  - Audit/Compliance reviewer (needs change traceability)
- **System Components:**
  - Moqui backend services/entities for `UnitOfMeasure`, `UomConversion`, `AuditLog` (or equivalent)

---

## 4. Preconditions & Dependencies
- User is authenticated.
- User has permission to manage UOM conversions (permission name not provided; see Open Questions).
- Base UOMs exist (e.g., EA/PK/CS) and are queryable for selection in the UI.
- Backend endpoints/services exist to:
  - Query UnitOfMeasure list
  - Query UomConversion list
  - Create/update/deactivate UomConversion
  - Provide audit fields and/or audit log entries (contract TBD)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Master / Admin navigation entry: **Master Data ‚Üí Units of Measure ‚Üí Conversions** (exact menu path may vary; implement consistent with existing Master screens).

### Screens to create/modify
1. **Screen:** `master/UomConversionList` (new)
   - Purpose: search/list conversions; access create/edit/deactivate.
2. **Screen:** `master/UomConversionDetail` (new or embedded in list as dialog)
   - Purpose: create or edit a conversion; show audit metadata; deactivate action.
3. (Optional if conventions exist) **Component/section:** `master/AuditLogPanel` (reuse if present) to display audit entries for the selected conversion.

### Navigation context
- From Master landing ‚Üí conversions list
- From list row ‚Üí detail screen (or side panel/dialog)
- ‚ÄúCreate Conversion‚Äù opens create mode

### User workflows (happy + alternate paths)

**Happy path (create)**
1. User opens conversions list
2. Clicks ‚ÄúCreate Conversion‚Äù
3. Selects From UOM, To UOM, enters conversion factor
4. Submits; sees success; new conversion appears active in list

**Happy path (update factor)**
1. User opens an existing conversion
2. Changes conversion factor
3. Submits; sees updated factor; audit metadata updated

**Happy path (deactivate)**
1. User opens an existing conversion
2. Clicks ‚ÄúDeactivate‚Äù
3. Confirms; conversion becomes inactive; list reflects status

**Alternate paths**
- Duplicate pair attempt rejected with inline error + toast/banner
- Invalid factor rejected (<=0, non-numeric)
- Self conversion rejected unless factor is exactly 1
- Unauthorized user sees forbidden and cannot access actions

---

## 6. Functional Behavior

### Triggers
- Entering conversions list screen triggers loading:
  - UOM options (for filters and create form)
  - UomConversion list (paged)
- Selecting a row triggers loading detail if not already present
- Submitting forms triggers create/update service call
- Clicking deactivate triggers transition/service call

### UI actions
- List controls:
  - Filter by From UOM, To UOM, Active status (Active/Inactive/All)
  - Text filter (optional) by UOM code/name (safe default)
- Row actions:
  - View/Edit
  - Deactivate (only if active)
- Create/Edit form:
  - From UOM (required select)
  - To UOM (required select)
  - Conversion factor (required decimal input)
  - Active (read-only on create default true; editable only via deactivate/activate if supported‚Äîsee Open Questions)

### State changes
- Create: new `UomConversion` record created `isActive=true`
- Update: existing record updated (at minimum factor)
- Deactivate: record `isActive=false` (no deletion)

### Service interactions
- `GET` list of UnitOfMeasure for selects
- `GET` list/query of UomConversion with filters/paging
- `POST` create UomConversion
- `POST/PUT` update UomConversion (factor only)
- `POST` deactivate UomConversion (or update isActive=false)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **R-UOM-01:** `conversionFactor` must be a positive, non-zero decimal
  - UI: numeric input with min > 0; reject 0/negative; show message ‚ÄúConversion factor must be a positive number.‚Äù
- **R-UOM-02:** unique (fromUomId, toUomId) pair
  - UI: on submit, if backend returns duplicate violation, show message ‚ÄúA conversion for this From/To pair already exists.‚Äù
  - (Optional pre-check is not required; avoid race conditions)
- **R-UOM-03:** implicitly reversible
  - UI: No separate reverse record required; show informational hint: ‚ÄúReverse conversion is computed implicitly.‚Äù (informational only)
- **R-UOM-04:** no hard delete
  - UI: no ‚ÄúDelete‚Äù action; only ‚ÄúDeactivate‚Äù

### Enable/disable rules
- Deactivate button enabled only when conversion `isActive=true`
- Update form:
  - If backend disallows changing From/To, UI must render them read-only in edit mode (or disable selects) and only allow factor edit
- Self conversion:
  - If From == To then factor must equal 1; otherwise block submit with inline error

### Visibility rules
- Inactive conversions are either hidden by default (filter Active only) or shown with status badge (safe default: show Active only with toggle ‚ÄúShow inactive‚Äù).

### Error messaging expectations
- Validation errors shown inline at field level when possible; otherwise show page-level banner with backend message.
- Forbidden shows ‚ÄúYou do not have permission to manage UOM conversions.‚Äù

---

## 8. Data Requirements

### Entities involved
- `UnitOfMeasure` (reference data)
- `UomConversion` (managed by this UI)
- `AuditLog` (or `ItemCostAudit`-like equivalent; actual name TBD)

### Fields
**UnitOfMeasure**
- `uomId` (UUID/string): required
- `uomCode` (string): required (display)
- `uomName` (string): optional (display)

**UomConversion**
- `id` (UUID): required
- `fromUomId` (UUID): required
- `toUomId` (UUID): required
- `conversionFactor` (decimal): required; > 0
- `isActive` (boolean): required; default true
- Audit fields (if present on entity):
  - `createdAt`, `createdBy`, `updatedAt`, `updatedBy`

**AuditLog** (if exposed)
- `auditId`
- `entityName`
- `entityId`
- `action` (CREATE/UPDATE/DEACTIVATE)
- `changedBy`, `changedAt`
- `beforeJson`, `afterJson` (or field diffs)

### Read-only vs editable
- Create mode: editable `fromUomId`, `toUomId`, `conversionFactor`
- Edit mode: `conversionFactor` editable; `fromUomId/toUomId` read-only (per backend reference)
- `isActive` toggled only by deactivate action (unless backend supports re-activate; see Open Questions)

### Derived/calculated fields
- Optional derived display: ‚ÄúInverse factor‚Äù = `1 / conversionFactor` for informational display only (do not persist).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not provided for Moqui services/REST paths. The frontend must integrate with whichever mechanism exists (Moqui REST, screen services, or JSON RPC). The following describes required operations and payload shapes.

### Load/view calls
1. **List UOMs**
   - Request: `GET UnitOfMeasure` (filter active if applicable)
   - Response: array of `{uomId, uomCode, uomName}`
2. **Query conversions**
   - Request params:
     - `fromUomId?`, `toUomId?`, `isActive?`, `pageIndex`, `pageSize`, `sortBy`
   - Response:
     - `data[]` conversions
     - `totalCount`

### Create/update calls
3. **Create conversion**
   - Request body: `{fromUomId, toUomId, conversionFactor}`
   - Response: created conversion including `id` and audit fields
4. **Update conversion factor**
   - Request body: `{id, conversionFactor}`
   - Response: updated conversion

### Submit/transition calls
5. **Deactivate conversion**
   - Request body: `{id}` (or `{id, isActive:false}`)
   - Response: updated conversion with `isActive=false`

### Error handling expectations
- `400` validation errors: map to field errors when keys match (e.g., `conversionFactor`)
- Duplicate constraint: surfaced as `400`/`409` (TBD); show friendly duplicate message
- `403`: show forbidden; disable actions
- Network/server error: show generic ‚ÄúUnable to save conversion. Try again.‚Äù with request correlation if available

---

## 10. State Model & Transitions

### Allowed states (for UomConversion)
- `Active` (`isActive=true`)
- `Inactive` (`isActive=false`)

### Role-based transitions
- Product Administrator can:
  - Create Active conversions
  - Update factor (Active and possibly Inactive‚ÄîTBD; default: Active only)
  - Deactivate Active conversions
- Non-authorized users:
  - Read-only access (TBD) or no access

### UI behavior per state
- Active: editable (factor), deactivate available
- Inactive: read-only; deactivate hidden/disabled; optionally show ‚ÄúInactive‚Äù badge

---

## 11. Alternate / Error Flows

### Validation failures
- Factor <= 0 ‚Üí block submit; show inline error
- From/To missing ‚Üí required errors
- From == To and factor != 1 ‚Üí block submit; show message ‚ÄúWhen converting a UOM to itself, factor must be 1.‚Äù

### Concurrency conflicts
- If backend returns optimistic lock/conflict (409):
  - UI shows ‚ÄúThis conversion was updated by another user. Reload to continue.‚Äù
  - Provide ‚ÄúReload‚Äù action to refetch detail/list

### Unauthorized access
- If list endpoint returns 403:
  - Show forbidden state page; no data displayed
- If action endpoints return 403:
  - Show forbidden toast and keep form unchanged

### Empty states
- No conversions match filters:
  - Show ‚ÄúNo conversions found‚Äù and CTA ‚ÄúCreate Conversion‚Äù
- No UOMs available:
  - Block create with message ‚ÄúNo Units of Measure available. Create UOMs first.‚Äù (link if screen exists; otherwise informational)

---

## 12. Acceptance Criteria

### Scenario 1: List and filter UOM conversions
**Given** I am authenticated as a Product Administrator  
**When** I open the UOM Conversions list screen  
**Then** I can view a paged list of existing conversions including From UOM, To UOM, conversion factor, and Active/Inactive status  
**And** I can filter the list by From UOM, To UOM, and Active status

### Scenario 2: Create a valid conversion
**Given** I am authenticated as a Product Administrator  
**And** UnitOfMeasure ‚ÄúCS‚Äù (Case) and ‚ÄúEA‚Äù (Each) exist  
**When** I create a conversion from ‚ÄúCS‚Äù to ‚ÄúEA‚Äù with factor ‚Äú24‚Äù  
**Then** the system saves the conversion successfully  
**And** the conversion appears in the list as Active  
**And** viewing the conversion shows createdBy/createdAt populated (if provided by backend)

### Scenario 3: Reject zero or negative conversion factor
**Given** I am authenticated as a Product Administrator  
**And** UnitOfMeasure ‚ÄúPK‚Äù (Pack) and ‚ÄúEA‚Äù (Each) exist  
**When** I attempt to create a conversion from ‚ÄúPK‚Äù to ‚ÄúEA‚Äù with factor ‚Äú0‚Äù  
**Then** the UI prevents submission or the backend rejects the request  
**And** I see an error stating the conversion factor must be a positive number  
**And** no conversion is created

### Scenario 4: Reject duplicate From/To conversion
**Given** I am authenticated as a Product Administrator  
**And** a conversion from ‚ÄúCS‚Äù to ‚ÄúEA‚Äù already exists  
**When** I attempt to create another conversion from ‚ÄúCS‚Äù to ‚ÄúEA‚Äù  
**Then** the system rejects the request  
**And** I see an error indicating that this conversion already exists

### Scenario 5: Update conversion factor
**Given** I am authenticated as a Product Administrator  
**And** a conversion from ‚ÄúCS‚Äù to ‚ÄúEA‚Äù exists with factor ‚Äú12‚Äù  
**When** I edit the conversion and change the factor to ‚Äú24‚Äù and save  
**Then** the system saves the updated factor  
**And** the list and detail view show factor ‚Äú24‚Äù  
**And** updatedBy/updatedAt are updated (if provided)

### Scenario 6: Deactivate a conversion (no delete)
**Given** I am authenticated as a Product Administrator  
**And** a conversion exists and is Active  
**When** I deactivate the conversion and confirm  
**Then** the conversion is marked Inactive  
**And** it is not removed from the system (still queryable when filtering to include inactive)  
**And** the UI does not offer a hard-delete action anywhere

### Scenario 7: Unauthorized user cannot manage conversions
**Given** I am authenticated as a user without permission to manage UOM conversions  
**When** I attempt to access the create or edit actions  
**Then** the UI blocks the action or the backend returns 403  
**And** I see a ‚Äúnot authorized‚Äù message  
**And** no changes are persisted

---

## 13. Audit & Observability

### User-visible audit data
- Show on detail view:
  - createdAt/createdBy, updatedAt/updatedBy (if available)
- If an audit log endpoint exists:
  - Provide an ‚ÄúAudit History‚Äù panel listing create/update/deactivate entries with timestamp + actor and before/after (or diff summary)

### Status history
- Deactivation should produce an audit event/log entry so the change is traceable.

### Traceability expectations
- All create/update/deactivate calls should include a correlation/request ID if the frontend framework supports it; display it in an error details drawer (optional).

---

## 14. Non-Functional UI Requirements
- **Performance:** list loads within 2s for up to 1,000 conversions with paging; avoid N+1 by loading UOM options once per session/page.
- **Accessibility:** all form controls labeled; validation errors announced; keyboard navigable; sufficient contrast for status badges.
- **Responsiveness:** usable on tablet widths; list may collapse columns but must keep core actions accessible.
- **i18n/timezone:** display timestamps in user locale/timezone; do not assume currency.

---

## 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE**
  - Assumed: Provide standard empty state with CTA to create conversion.
  - Why safe: UI-only ergonomics; does not affect domain logic.
  - Impacted sections: UX Summary, Alternate / Error Flows.
- **SD-UX-PAGINATION**
  - Assumed: Server-backed paging with default page size (e.g., 25) and sorting.
  - Why safe: Presentation concern; does not change business rules.
  - Impacted sections: UX Summary, Service Contracts, Non-Functional.
- **SD-ERR-MAP-VALIDATION**
  - Assumed: Map backend 400 validation responses to inline field errors when possible, else banner.
  - Why safe: Standard error-handling; does not alter policy.
  - Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows.

---

## 16. Open Questions
1. **Domain ownership (blocking):** This story is labeled `domain:inventory` here, but the issue context classifies it as ‚ÄúDomain: Product / Parts Management‚Äù and ‚ÄúDomain: user‚Äù. Confirm the system-of-record and owning domain for `UnitOfMeasure` and `UomConversion` (Product vs Inventory). This story cannot be finalized without a single owning domain label.
2. **Backend contract (blocking):** Provide the actual Moqui REST paths or service names for:
   - listing UnitOfMeasure
   - querying UomConversion (including pagination shape)
   - create/update/deactivate UomConversion
   - retrieving AuditLog entries for a conversion (if supported)
3. **Permissions (blocking):** Provide exact permission string(s) for:
   - viewing conversions
   - creating/updating conversions
   - deactivating conversions
   - viewing audit history (if separately gated)
4. **Scope of conversions (blocking):** Are conversions global (UOM‚ÜîUOM) or product-specific (Product + From/To)? If product-specific, define the product identifier field and required UI picker.
5. **Edit constraints:** Are `fromUomId` / `toUomId` immutable after creation? If mutable, define validation and whether changes require creating a new record instead.
6. **Re-activation:** Is re-activating an inactive conversion allowed in v1? If yes, define the endpoint/transition and audit expectations.
7. **Audit UI:** Is there an existing audit log viewer component/screen convention in this repo to reuse, and what is the audit endpoint contract?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Master: Manage UOM and Pack/Case Conversions ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/120

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #119: [FRONTEND] [STORY] Master: Set Product Lifecycle State (Active/Discontinued) with Effective Dates
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:inventory-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Master: Manage Product Lifecycle State (Active/Inactive/Discontinued) with Effective Dates + Replacement Suggestions

## Primary Persona
Product Admin (or Inventory Admin)

## Business Value
Ensure discontinued/unsellable products are clearly flagged and enforced in downstream selling workflows (quotes/work orders) while maintaining an auditable history of lifecycle changes and providing replacement suggestions to prevent quoting unsourceable items.

---

# 2. Story Intent

## As a / I want / So that
**As a** Product Admin,  
**I want** to set a product‚Äôs lifecycle state (Active/Inactive/Discontinued) with an effective date (date-only or timestamp) and optionally manage replacement products,  
**So that** selling/quoting workflows can avoid unsourceable items, and lifecycle changes are auditable and enforceable.

## In-Scope
- A ‚ÄúLifecycle‚Äù section on a Product Master / Product Detail screen:
  - View current lifecycle state and its effective timestamp.
  - Change lifecycle state with an effective date/time input.
  - If setting to `DISCONTINUED`, require override permission and require/collect an override reason when applicable (per backend rules).
  - Display lifecycle change metadata (last changed by/at, effective at).
- Manage replacement suggestions for discontinued products:
  - Add one or more replacement products with priority order, optional notes, and effectiveAt.
  - List existing replacements sorted by priority.
- Frontend enforcement behaviors (UI-level gating) consistent with backend:
  - Disable/guard invalid transitions (e.g., reactivating discontinued).
  - Surface backend validation/permission errors clearly.
- Audit visibility:
  - Show lifecycle-related audit history entries (at minimum: state changes; ideally also replacement add/edit/remove if supported by backend).

## Out-of-Scope
- Defining/assigning security roles/permissions (security domain).
- Implementing downstream quote/work order enforcement screens (separate stories), except for displaying lifecycle state where already shown by shared product search components.
- Product master creation/edit outside lifecycle fields.
- Any inventory valuation/costing behavior.

---

# 3. Actors & Stakeholders
- **Primary Actor:** Product Admin / Inventory Admin (edits lifecycle state, sets replacements)
- **Secondary Actor:** Service Advisor (consumes lifecycle info during quoting/WO; may be blocked elsewhere)
- **System Stakeholders:**
  - Authorization/Permission subsystem (enforces `product:lifecycle:update` and `product:lifecycle:override_discontinued`)
  - Work Execution / Pricing & Availability consumers (must receive lifecycle status via existing responses)
- **Compliance Stakeholder:** Audit/Reporting consumer (needs traceability)

---

# 4. Preconditions & Dependencies
- Product exists and is viewable in Product Master UI.
- Backend story #55 is implemented and deployed (or equivalent services exist) providing:
  - Read product lifecycle fields (`lifecycleState`, `lifecycleStateEffectiveAt`, `lastStateChangedBy`, `lastStateChangedAt`, `lifecycleOverrideReason` where applicable).
  - Update lifecycle state with permission enforcement and validation (irreversibility, effective date validation).
  - CRUD for `ProductReplacement` records (at least create/list; update/delete if supported).
  - Audit/event publication for lifecycle change (frontend displays audit log if an endpoint exists).
- Authentication is in place; frontend can detect permission-based errors (403) and validation errors (400).
- **Integration constraint:** Inventory domain rules require Moqui-proxy integration for inventory endpoints (DECISION-INVENTORY-002), but this story references Product lifecycle endpoints/permissions. Domain ownership and integration pattern must be confirmed before implementation.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Product Master list ‚Üí Product Detail ‚Üí **Lifecycle** tab/section.
- Direct route to Product Detail (deep link) including Lifecycle section anchor.

## Screens to create/modify (Moqui)
- **Modify**: `apps/durion/screen/product/ProductDetail.xml` (name illustrative; must align to repo conventions)
  - Add a `subscreens` entry or a `section` for `Lifecycle`.
- **Create** (if not existing): `apps/durion/screen/product/ProductLifecycle.xml` as a subscreen:
  - Display current state panel (read-only fields + effective timestamp).
  - State change form.
  - Replacement list + add form (and optional edit/delete if supported).
  - Audit log view section (if supported).

## Navigation context
- Breadcrumb: Product Master ‚Üí Product {productId or displayName} ‚Üí Lifecycle
- Preserve current product context (`productId` parameter in URL).

## User workflows (happy + alternate paths)

### Happy path A ‚Äî Set product to INACTIVE with effective date
1. User opens Lifecycle section.
2. User selects `INACTIVE`.
3. User enters effective date/time (date-only allowed).
4. User submits.
5. UI shows success and updated lifecycle metadata.

### Happy path B ‚Äî Set product to DISCONTINUED (requires override permission)
1. User selects `DISCONTINUED`.
2. UI prompts for override reason if required by backend rule.
3. User submits.
4. UI refreshes state; replacements section becomes available/encouraged.

### Happy path C ‚Äî Add replacement product(s)
1. For a discontinued product, user clicks ‚ÄúAdd Replacement‚Äù.
2. User searches/selects replacement product (product picker).
3. User sets priorityOrder (integer) and optional notes/effectiveAt.
4. UI saves and refreshes list.

### Alternate path ‚Äî Attempt to reactivate DISCONTINUED
- UI should prevent selection/submit for invalid transition, and if attempted via stale UI, backend error is shown verbatim with mapped friendly message.

---

# 6. Functional Behavior

## Triggers
- Screen load with `productId`
- User submits lifecycle change form
- User submits add replacement form
- (Optional) User edits/deletes replacement (only if backend supports)

## UI actions
- **On load**:
  - Fetch product lifecycle details + replacement list (+ audit entries if available).
  - If permission discovery is available in the app shell, compute UI gating (view-only vs editable; discontinued override).
- **On state selection**:
  - If state == `DISCONTINUED`, show override permission hint and show ‚ÄúOverride Reason‚Äù input (visibility may depend on current state and permission).
  - If current state is `DISCONTINUED`, disable selecting `ACTIVE` or `INACTIVE` (hard disable) and show explanatory text.
- **On submit**:
  - Validate required inputs locally (presence, type) before calling backend.
  - Call backend update service; on success, refresh the product lifecycle details and audit section.

## State changes (domain state)
- `ACTIVE` ‚áÑ `INACTIVE` allowed (per backend).
- Transition to `DISCONTINUED` allowed only with override permission.
- `DISCONTINUED` ‚Üí `ACTIVE/INACTIVE` is not allowed (irreversible).

## Service interactions (Moqui)
- Use Moqui transitions for form submits.
- Use Moqui services (or REST via `service-call` if project pattern uses REST) to:
  - Load product lifecycle data
  - Update lifecycle state
  - List/create replacement records
  - Load audit log entries (if endpoint exists)
- **Decision rationale note:** Inventory domain decisions define Moqui-proxy integration and deterministic error handling for inventory endpoints (DECISION-INVENTORY-002, DECISION-INVENTORY-003, DECISION-INVENTORY-012). This story‚Äôs endpoints are not defined as inventory endpoints; therefore these decisions cannot be applied as binding contracts until domain ownership and endpoint namespace are confirmed.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Effective date/time:
  - Must be present (unless backend defaults ‚Äúimmediately‚Äù; see Open Questions).
  - Must not be in the past (backend rule); UI should pre-check using client time **but treat backend as source of truth**.
- When setting to `DISCONTINUED`:
  - User must have permission `product:lifecycle:override_discontinued` or the submit will fail with 403.
  - Override reason:
    - If backend requires reason for discontinued and/or for overrides, UI must require non-empty text and show inline validation.
- Replacement records:
  - `replacementProductId` required.
  - `priorityOrder` required; must be integer >= 1 (backend constraints unknown; enforce minimally as integer).
  - `effectiveAt` optional unless backend requires.

## Enable/disable rules
- If current state is `DISCONTINUED`:
  - Disable state selection for `ACTIVE` and `INACTIVE`.
  - Lifecycle change submit disabled unless backend allows adding only replacements without changing state.
- DISCONTINUED selection enabled only if user has override permission **or** allow selection but expect 403; prefer disabling with a ‚Äúpermission required‚Äù message if permission info is available.

## Visibility rules
- Replacement management section visible when product is `DISCONTINUED` (or always visible but disabled with guidance; prefer conditional visibility).
- Override reason input visible when selecting `DISCONTINUED` (and/or when an override is being performed per backend response).

## Error messaging expectations
- If backend returns the known message:
  - `"Discontinued products cannot be reactivated. Specify a replacement product instead."`
  UI must surface it prominently near the lifecycle form.
- For 403: show ‚ÄúYou do not have permission to perform this action: <permissionName if provided>‚Äù.
- For 400: show field-level errors when possible; otherwise show top-of-form error summary.

---

# 8. Data Requirements

## Entities involved (frontend perspective)
- `Product` (or product master view)
- `ProductReplacement` (originalProductId ‚Üí replacementProductId)
- `AuditLog` / lifecycle event stream (if exposed)

## Fields

### Product lifecycle fields (read-only except via form submit)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| productId | UUID/string | yes | n/a | route param |
| lifecycleState | enum(`ACTIVE`,`INACTIVE`,`DISCONTINUED`) | yes | n/a | displayed + edited via form |
| lifecycleStateEffectiveAt | Timestamp (UTC) | yes* | backend | *may be null for legacy products; UI must handle |
| lastStateChangedBy | UserRef | no | null | display if present |
| lastStateChangedAt | Timestamp (UTC) | no | null | display if present |
| lifecycleOverrideReason | string | no/conditional | null | display last override reason if present |

### Replacement fields (create/list)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| replacementId | UUID/string | no (create) | n/a | assigned by backend |
| originalProductId | UUID/string | yes | from context | discontinued product |
| replacementProductId | UUID/string | yes | n/a | selected via picker |
| priorityOrder | integer | yes | 1 | UI may suggest next available |
| notes | string | no | null | textarea |
| effectiveAt | Timestamp (UTC) or date | no | null | UI supports date-only if backend supports |

## Read-only vs editable by state/role
- Users without `product:lifecycle:update`: all lifecycle and replacement forms read-only (view-only).
- Users with `product:lifecycle:update` but without `product:lifecycle:override_discontinued`:
  - Can set ACTIVE/INACTIVE (if allowed) but cannot set DISCONTINUED.
  - Can add replacements? (unclear‚ÄîOpen Question; backend story suggests `product:lifecycle:update` sufficient for replacements.)

## Derived/calculated fields
- Display ‚ÄúSellable: Yes/No‚Äù derived from lifecycleState:
  - `ACTIVE` => Yes
  - `INACTIVE`/`DISCONTINUED` => No

---

# 9. Service Contracts (Frontend Perspective)

> Note: Exact service names/paths are not provided in inputs; this story defines required contracts and flags as blocking where unknown.

## Load/view calls
- **Get Product Detail (including lifecycle fields)**
  - Input: `productId`
  - Output: product fields including lifecycle state + effectiveAt + last changed metadata
- **List replacements**
  - Input: `originalProductId`
  - Output: array of `ProductReplacement` sorted by `priorityOrder` ascending

## Create/update calls
- **Update lifecycle state**
  - Input:
    - `productId`
    - `lifecycleState`
    - `effectiveAt` (timestamp or date-only)
    - `overrideReason` (conditional)
  - Output: updated product lifecycle fields
- **Create ProductReplacement**
  - Input:
    - `originalProductId`
    - `replacementProductId`
    - `priorityOrder`
    - `notes?`
    - `effectiveAt?`
  - Output: created replacement

## Submit/transition calls (Moqui screens)
- Lifecycle form submit transition:
  - On success: redirect back to same screen with success message and refreshed data.
  - On error: stay on page, show errors.

## Error handling expectations
- 400: validation errors; map to inline fields when possible
- 403: permission denied; show action blocked message; do not retry automatically
- 409 (if used): concurrency conflict; prompt to reload (see Error Flows)

---

# 10. State Model & Transitions

## Allowed states
- `ACTIVE`
- `INACTIVE`
- `DISCONTINUED`

## Role-/permission-based transitions
- `ACTIVE` ‚Üí `INACTIVE`: requires `product:lifecycle:update`
- `INACTIVE` ‚Üí `ACTIVE`: requires `product:lifecycle:update`
- `ACTIVE|INACTIVE` ‚Üí `DISCONTINUED`: requires `product:lifecycle:override_discontinued` (and possibly `product:lifecycle:update` as baseline; backend to confirm)

## UI behavior per state
- **ACTIVE**: lifecycle form allows selecting INACTIVE or DISCONTINUED (if permitted)
- **INACTIVE**: allow selecting ACTIVE or DISCONTINUED (if permitted)
- **DISCONTINUED**:
  - lifecycle state selector locked (read-only)
  - replacement management enabled (if permitted)
  - show banner: ‚ÄúDiscontinued products cannot be reactivated.‚Äù

---

# 11. Alternate / Error Flows

## Validation failures
- Missing effective date/time (if required) ‚Üí inline error
- Effective date in past ‚Üí inline error (and backend error shown if backend rejects)
- Missing override reason when required ‚Üí inline error

## Concurrency conflicts
- If backend indicates product lifecycle changed since load (e.g., optimistic lock):
  - Show message: ‚ÄúThis product‚Äôs lifecycle was updated by another user. Reload to continue.‚Äù
  - Provide reload action.

## Unauthorized access
- User lacking permission attempts submit:
  - Show 403 error and keep form values (do not clear).
  - If permission names provided by backend, display them.

## Empty states
- No replacements exist:
  - Show ‚ÄúNo replacement products configured.‚Äù
  - If discontinued, prompt to add one.

---

# 12. Acceptance Criteria

## Scenario 1: View lifecycle state on Product Detail
**Given** I am an authenticated user with access to view products  
**And** a product exists with lifecycleState `ACTIVE`  
**When** I open the Product Lifecycle section for that product  
**Then** I see the current lifecycle state and the effective timestamp (or ‚ÄúNot set‚Äù if null)  
**And** I see last changed by/at if provided by the backend  

## Scenario 2: Set a product to INACTIVE with a future effective date
**Given** a product is currently `ACTIVE`  
**And** I have permission `product:lifecycle:update`  
**When** I select lifecycle state `INACTIVE`  
**And** I enter an effective date of `2023-11-01` (date-only)  
**And** I submit the lifecycle change  
**Then** the frontend sends an update request including the entered effective date  
**And** the screen refreshes showing lifecycleState `INACTIVE` and a stored UTC effective timestamp returned by backend  
**And** a success confirmation is shown  

## Scenario 3: Discontinue a product requires override permission
**Given** a product is currently `ACTIVE`  
**And** I do not have permission `product:lifecycle:override_discontinued`  
**When** I attempt to set lifecycle state to `DISCONTINUED` and submit  
**Then** the frontend prevents submission OR the backend responds `403`  
**And** the UI shows an error indicating the action requires `product:lifecycle:override_discontinued`  

## Scenario 4: Discontinue a product with override reason
**Given** a product is currently `ACTIVE`  
**And** I have permission `product:lifecycle:override_discontinued`  
**When** I select lifecycle state `DISCONTINUED`  
**And** I enter override reason `End of Life`  
**And** I submit  
**Then** the product shows lifecycleState `DISCONTINUED` after refresh  
**And** the UI shows a discontinued banner indicating it cannot be reactivated  
**And** the override reason is displayed if returned by backend  

## Scenario 5: Prevent reactivation of discontinued product
**Given** a product is `DISCONTINUED`  
**When** I attempt to change it to `ACTIVE` or `INACTIVE`  
**Then** the UI prevents the action  
**And** if a backend error is returned, the UI displays: ‚ÄúDiscontinued products cannot be reactivated. Specify a replacement product instead.‚Äù  

## Scenario 6: Add a replacement product suggestion
**Given** a product is `DISCONTINUED`  
**And** I have permission to manage lifecycle (`product:lifecycle:update`)  
**When** I add replacement product `PROD-E` with priority `1` and optional notes  
**Then** the frontend creates a replacement record via backend  
**And** the replacement appears in the replacement list sorted by priority  

---

# 13. Audit & Observability

## User-visible audit data
- Display an ‚ÄúLifecycle History‚Äù list showing at minimum:
  - timestamp
  - actor (user)
  - oldState ‚Üí newState
  - effectiveAt
  - reason (if present)
- If audit endpoint not available, show ‚ÄúAudit history unavailable‚Äù and log a console warning only in dev mode.

## Status history
- Show current lifecycle + effectiveAt and last changed metadata (from product fields).
- Prefer to derive history from audit log rather than guessing.

## Traceability expectations
- All lifecycle update submissions include:
  - productId
  - proposed new state
  - effectiveAt input value (as entered)
- Frontend should include correlation/request id if project has standard header injection (per repo conventions).

---

# 14. Non-Functional UI Requirements
- **Performance:** Product lifecycle section should load within 1s on typical broadband once product detail is loaded; replacement list paginates if large (client-side minimal).
- **Accessibility:** All form controls labeled; errors announced via ARIA live region; keyboard navigable.
- **Responsiveness:** Works on tablet widths used on shop floor.
- **i18n/timezone/currency:**
  - Date/time inputs must clarify timezone handling; effectiveAt stored in UTC.
  - Display effectiveAt in user‚Äôs local timezone with UTC tooltip (or dual display) if conventions support.

---

# 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE**
  - Assumed: Standard empty-state messaging for no replacement products.
  - Why safe: Pure UI ergonomics; does not change domain logic.
  - Impacted sections: UX Summary, Alternate/Empty states.
- **SD-UX-ERROR-MAP-HTTP**
  - Assumed: Map 400/403/409 to inline+banner errors using common patterns.
  - Why safe: Error mapping is presentation-only and reversible.
  - Impacted sections: Service Contracts, Alternate/Error Flows.

---

# 16. Open Questions

1. **Domain ownership conflict (blocking):** This story is labeled `domain:inventory`, but it is fundamentally about Product Master lifecycle state and product replacement suggestions (Product/Catalog domain concepts). Confirm the correct owning domain label (`domain:product` vs `domain:inventory`) and whether Inventory is actually the system-of-record for lifecycle state. If Inventory is not SoR, this story must be re-labeled and re-authored under the Product domain agent.  
2. **Backend contract (blocking):** Provide the exact Moqui proxy endpoints or Moqui service names for:
   - Load product lifecycle fields (and whether it is part of existing product detail endpoint)
   - Update lifecycle state (inputs, validation error schema)
   - List/create/update/delete `ProductReplacement`
   - Load lifecycle audit history (endpoint, pagination, fields)
3. **Effective date semantics (blocking):**
   - Is `effectiveAt` required or optional? If optional, what is the server default (request time in UTC vs start-of-day in governing timezone)?
   - Is date-only accepted, and how is it converted to a timestamp (midnight in governing timezone vs UTC)?
4. **‚ÄúPast‚Äù rule definition (blocking):** How is ‚Äúeffective date cannot be in the past‚Äù evaluated (server time vs governing timezone), and is there any tolerance window?
5. **Permissions (blocking):**
   - Confirm required permissions and canonical strings for: view lifecycle, update lifecycle, discontinue override, manage replacements, view audit history.
   - Confirm whether replacement management requires `product:lifecycle:update` or a separate permission.
6. **Replacement constraints (blocking):**
   - Are `priorityOrder` values required to be unique per original product?
   - Are multiple replacements allowed with same priority?
   - Are update/delete supported, and what validations apply?
7. **Governing timezone source (blocking):** Where does ‚Äúproduct‚Äôs governing timezone‚Äù come from (product field vs org/site setting), and what is the fallback?
8. **Downstream enforcement integration (non-blocking for this story if explicitly out-of-scope):** Identify which existing quote/work order flows must enforce ‚Äúcannot add discontinued item unless override permission‚Äù and whether those are separate stories already planned.

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Master: Set Product Lifecycle State (Active/Discontinued) with Effective Dates ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/119

Labels: frontend, story-implementation, user

### Story Description

/kiro
# User Story
## Narrative
As a **Product Admin**, I want lifecycle states with effective dates so that quoting avoids unsourceable items.

## Details
- States: Active, Inactive, Discontinued, Replaced.
- Optional replacement product link.

## Acceptance Criteria
- Discontinued items blocked from new quotes unless override permission.
- Replacement suggested.
- Audited.

## Integrations
- Workexec receives lifecycle status in pricing/availability responses.

## Data / Entities
- ProductLifecycle, ReplacementLink, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Product / Parts Management

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #108: [FRONTEND] [STORY] Rules: Store Fitment Hints and Vehicle Applicability Tags (Basic)
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] Inventory Rules: Store Fitment Hints and Vehicle Applicability Tags (Basic) ‚Äî Domain Ownership & Contract Clarification Needed

### Primary Persona
Product Administrator (Product Admin)

### Business Value
Enable Service Advisors (and downstream Work Execution) to quickly narrow candidate parts/tires to those likely compatible with a customer vehicle, reducing incorrect part selection while keeping the system ‚Äúhint-based‚Äù (not a strict fitment engine).

---

## 2. Story Intent

### As a / I want / So that
**As a** Product Administrator,  
**I want** to create, edit, remove, and search products by vehicle applicability ‚Äúfitment hint‚Äù tags (make/model/year range/tire size/axle position),  
**so that** advisors and downstream flows can filter and suggest likely-compatible products for a vehicle.

### In-scope
- Admin UI to manage Vehicle Applicability Hints for a product (CRUD).
- Admin UI to search/filter products by vehicle attributes / tags.
- Display of existing hints/tags on product detail.
- User-visible audit history display for hint changes (read-only).
- Moqui screen/form/service wiring for these flows (transitions, validations, error handling).

### Out-of-scope
- A full fitment/compatibility rules engine or VIN decoding.
- Blocking sales/workorder flows based on fitment (this is advisory only).
- Defining/owning the Product master entity itself (assumed exists).
- Importing tags from external catalogs.
- Any inventory valuation/costing logic.
- Any inventory availability/ledger/topology/feed-ops functionality (explicitly not part of this story).

---

## 3. Actors & Stakeholders
- **Product Administrator:** creates/maintains applicability hints.
- **Service Advisor:** consumes filtered results elsewhere (not primary UI in this story, but stakeholder).
- **Work Execution system / module:** passes vehicle attributes to filter candidates (integration consumer).
- **Auditor / Manager:** reviews change history for compliance/traceability.
- **System Admin/Security:** ensures only authorized users can edit hints.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the Moqui frontend.
- Product/SKU records exist and are viewable in the admin UI.

### Dependencies (Blocking)
- **Domain ownership / SoR decision (blocking):** This story‚Äôs entities (`VehicleApplicabilityHint`, `FitmentTag`) are described as ‚ÄúProduct / Parts Management‚Äù in the original issue context, but this issue is routed to `domain:inventory`. Inventory domain rules provided do not define these entities or endpoints. A single SoR must be confirmed to avoid cross-domain drift.
- **Backend API/service contracts (blocking):** Exact Moqui proxy endpoints (or Moqui services) for CRUD/search/audit are not defined in the provided Inventory domain rules.
- **Permissions (blocking):** Permission strings and how the frontend discovers them for this feature are not defined in the provided Inventory domain rules.

### Decision rationale (why blocked)
- Inventory domain authoritative docs provided (DECISION-INVENTORY-###) cover availability, ledger, topology, HR sync, and feed ops. They do **not** define fitment hints/tags. Under SAFE_DEFAULTS_MODE, we must not guess SoR, permission scope, or event contracts.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Product Admin area:
  - Product search/list screen ‚Üí open Product detail.
  - Product detail screen ‚Üí ‚ÄúVehicle Applicability (Hints)‚Äù section.

### Screens to create/modify
1. **Modify existing Product Detail screen** (or create if missing):
   - Add a related panel/section: ‚ÄúVehicle Applicability Hints‚Äù.
   - Include list of existing hints for the product and their tags.
   - Provide actions: Add Hint, Edit Hint, Delete Hint, View Audit.
2. **Create/Edit Hint screen/dialog**:
   - Form to add/edit hint and manage its tags (add/remove rows).
3. **Product Search with Fitment Filter screen enhancements**:
   - Search input set for vehicle attributes (make/model/year/tire size/axle position).
   - Results list of matching products.
4. **Audit Log viewer screen/dialog** scoped to a product and hint:
   - Read-only list of audit events for hint CRUD.

### Navigation context
- All screens under an Admin route namespace (exact route TBD by project conventions).
- Breadcrumb: Admin ‚Üí Products ‚Üí {Product} ‚Üí Vehicle Applicability Hints.
- Transitions return to Product detail after create/update/delete.

### User workflows (happy + alternate)
**Happy path (create):**
1. Product Admin opens a Product.
2. In ‚ÄúVehicle Applicability Hints‚Äù, clicks ‚ÄúAdd Hint‚Äù.
3. Adds tag rows (e.g., MAKE=Subaru, MODEL=Outback, YEAR_RANGE=2020-2023).
4. Saves.
5. Sees new hint in list and audit entry visible in Audit screen.

**Alternate paths:**
- Add multiple hints to same product (if allowed).
- Edit existing hint to change tags.
- Delete hint (confirmation required).
- Search products by vehicle attributes and get empty results state.

---

## 6. Functional Behavior

### Triggers
- User navigates to product detail ‚Üí frontend loads hints for product.
- User opens search screen and enters vehicle attributes ‚Üí frontend requests filtered product list.
- User submits create/update/delete hint ‚Üí frontend calls corresponding backend service and refreshes view.
- User opens audit viewer ‚Üí frontend loads audit entries.

### UI actions
- Add/remove tag row in a hint form.
- Save (create/update) hint.
- Delete hint with confirmation.
- Apply filters / clear filters in product search.

### State changes
- Form state: dirty/pristine; disable submit until valid.
- Loading indicators while services run.
- Upon successful write: show confirmation and refresh hint list.
- On errors: show field-level validation messages and/or global error banner.

### Service interactions (to be confirmed)
- Load product hints by `productId`.
- Create hint for `productId` with tags.
- Update hint by `hintId` with tags.
- Delete hint by `hintId`.
- Search products by vehicle attribute filters (tag intersection semantics are owned by backend).
- Load audit log by `productId` and/or `hintId`.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (client-side, non-policy)
- Trim whitespace for all string inputs before validation and submit.
- Tag entries are key/value pairs (or `tagType`/`tagValue`).
- Prevent submitting a hint with:
  - any blank tag type/key or blank tag value
  - duplicate tag rows that are identical (same type+value) within a single hint (UI-only dedupe; backend remains authoritative)

### Validation (policy-dependent; blocking)
- Whether a hint may be saved with **zero tags** is unknown.
- YEAR_RANGE format and validation rules are unknown (single string vs min/max fields; inclusive/exclusive).

### Enable/disable rules
- Save disabled while:
  - form invalid
  - request in-flight (double-submit protection)
- Edit/Delete actions hidden or disabled if user lacks permission (permission discovery mechanism TBD).

### Visibility rules
- ‚ÄúVehicle Applicability Hints‚Äù section visible only to users with appropriate read permission (TBD).
- Audit viewer visible only to users with audit-view permission (TBD).

### Error messaging expectations (standard)
- 400/422 validation errors: show actionable messages; map to fields when possible (including tag row index + field).
- 401: follow app convention (redirect to login/session refresh).
- 403: show forbidden state without leaking data.
- 404: show not-found and navigate back to product list if appropriate.
- 409: prompt user to refresh and retry.

---

## 8. Data Requirements

### Entities involved (frontend-facing; ownership TBD)
- **VehicleApplicabilityHint**
  - `hintId` (string/UUID; read-only)
  - `productId` (string/UUID; read-only in edit)
  - `fitmentTags` (array of FitmentTag; editable)
  - (optional) `createdAt`, `createdBy`, `updatedAt`, `updatedBy` (read-only; if provided)
- **FitmentTag**
  - `tagType` (enum/string; required)
  - `tagValue` (string; required)
- **AuditLog / AuditEvent**
  - `eventType` (e.g., VEHICLE_HINT_CREATED/UPDATED/DELETED)
  - `timestamp`
  - `actorUserId` / actor display name (if available)
  - `entityRef` (productId, hintId)
  - `delta` (before/after snapshot or change summary)

### Fields (type, required, defaults)
- `tagType`: required; UI offers a controlled list for ‚Äúbasic tags‚Äù:
  - MAKE, MODEL, YEAR_RANGE, TIRE_SIZE, AXLE_POSITION
- `tagValue`: required string; trimming whitespace on submit.

> Blocking: Whether additional free-form tag types are allowed is unknown and must be confirmed by the owning domain/backend contract.

### Read-only vs editable
- IDs always read-only.
- Tag list editable in create/edit.
- Audit fields read-only.

### Derived/calculated fields
- Optional display-only ‚ÄúHuman readable hint summary‚Äù assembled client-side (not persisted).

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking**: Inventory domain decisions define Moqui proxy patterns and error handling for inventory endpoints, but do not define fitment hint endpoints. The below is a required contract shape; exact routes/services must be confirmed by the owning domain.

### Load/view calls
1. **Get hints by product**
   - Input: `productId`
   - Output: `[{ hintId, productId, fitmentTags: [{tagType, tagValue}], createdAt?, createdBy?, updatedAt?, updatedBy? }]`

2. **Get audit log for hints**
   - Input: `productId` (and optional `hintId`)
   - Output: `[{ eventType, timestamp, actorUserId?, actorDisplayName?, entityRef, delta? }]` sorted desc by timestamp

### Create/update calls
1. **Create hint**
   - Input: `productId`, `fitmentTags[]`
   - Output: created hint with `hintId`

2. **Update hint**
   - Input: `hintId`, `fitmentTags[]`
   - Output: updated hint

3. **Delete hint**
   - Input: `hintId`
   - Output: success acknowledgement

### Search/filter calls
1. **Search products by vehicle attributes**
   - Input: filter object or list of tags (make/model/year/tire size/axle position)
   - Output: product list (minimum: `productId`, `sku`, `name/description`)

### Error handling expectations
- Deterministic error schema required (field errors when possible).
- 401/403 behavior should follow platform convention (see DECISION-INVENTORY-012 for pattern; apply only if platform-wide).
- Do not log sensitive payloads; for this story, no inventory quantities are involved, but audit deltas/payloads may still require safe rendering if JSON blobs are returned.

---

## 10. State Model & Transitions

### Allowed states
- VehicleApplicabilityHint lifecycle in this story is CRUD-only (no explicit workflow states provided).

### Role-based transitions
- Product Admin:
  - can create/update/delete hints (permission-gated; exact permission keys TBD).
- Read-only users:
  - can view hints (if allowed) and may view audit (if allowed).

### UI behavior per state
- Create mode: blank form with at least one empty tag row.
- Edit mode: populated tag rows.
- Delete: confirmation modal; on confirm call delete; on success refresh list.

---

## 11. Alternate / Error Flows

### Validation failures
- User adds a tag row but leaves `tagValue` blank ‚Üí inline error; prevent submit.
- User enters malformed year range ‚Üí inline error; prevent submit (blocking: needs exact rule).

### Concurrency conflicts
- If backend returns 409 on update:
  - show message ‚ÄúThis hint changed since you opened it. Refresh to get the latest.‚Äù
  - provide ‚ÄúRefresh‚Äù action that reloads hint and resets form.

### Unauthorized access
- User without permission attempts to open create/edit/delete:
  - hide actions if permissions are available client-side
  - if attempted and backend returns 403, show forbidden error and remain on page.

### Empty states
- Product has no hints ‚Üí show ‚ÄúNo applicability hints yet‚Äù with ‚ÄúAdd Hint‚Äù action (if permitted).
- Product search by vehicle attributes returns none ‚Üí show empty results (not an error).

---

## 12. Acceptance Criteria

### Scenario 1: View existing applicability hints on a product
**Given** I am logged in as a Product Administrator  
**And** I am viewing an existing product detail page  
**When** the page loads the ‚ÄúVehicle Applicability Hints‚Äù section  
**Then** I see the list of existing hints for the product  
**And** each hint displays its tags (type and value)

### Scenario 2: Create a new applicability hint with basic tags
**Given** I am logged in as a Product Administrator with permission to manage hints  
**And** I am viewing an existing product  
**When** I add a new hint with tags MAKE=Subaru, MODEL=Outback, YEAR_RANGE=2020-2023  
**And** I click Save  
**Then** the hint is persisted via the backend create service  
**And** the product detail page refreshes to show the new hint  
**And** an audit entry is visible in the audit viewer indicating a create event

### Scenario 3: Update an existing hint
**Given** a product has an existing hint with YEAR_RANGE=2020-2023  
**And** I am editing that hint  
**When** I change YEAR_RANGE to 2020-2024 and save  
**Then** the backend update service is called with the updated tags  
**And** the updated tag is displayed after save  
**And** an audit entry is visible indicating an update event

### Scenario 4: Delete an existing hint
**Given** a product has an existing applicability hint  
**And** I have permission to delete hints  
**When** I choose Delete and confirm  
**Then** the backend delete service is called  
**And** the hint no longer appears in the product‚Äôs hint list  
**And** an audit entry is visible indicating a delete event

### Scenario 5: Prevent invalid hint submission
**Given** I am creating a hint  
**When** I attempt to save with a tag missing a type or value  
**Then** the UI blocks submission  
**And** I see an inline validation message identifying the missing field(s)

### Scenario 6: Search products by vehicle attributes
**Given** Product A has tags MAKE=Ford and MODEL=F-150  
**And** Product B has tags MAKE=Toyota and MODEL=Camry  
**When** I search products with filters MAKE=Ford and MODEL=F-150  
**Then** the results include Product A  
**And** the results do not include Product B

### Scenario 7: Search returns empty list (not an error)
**Given** no products have MAKE=Tesla  
**When** I search products with filter MAKE=Tesla  
**Then** I see an empty results state  
**And** no error is shown

### Scenario 8: Forbidden access is handled safely
**Given** I am logged in without permission to manage fitment hints  
**When** I attempt to create, edit, or delete a hint  
**Then** the UI does not allow the action (hidden/disabled where possible)  
**And** if the backend returns 403, I see a forbidden message without any hint data leakage

---

## 13. Audit & Observability

### User-visible audit data
- Provide an ‚ÄúAudit‚Äù view showing:
  - event type (created/updated/deleted)
  - timestamp
  - actor (user)
  - change summary (before/after or tag delta if provided)
- Audit is read-only.

### Status history
- Not applicable (no explicit state machine), but change history must be viewable.

### Traceability expectations
- If the platform supports correlation IDs (pattern referenced in DECISION-INVENTORY-012), show correlation ID in error technical details when present.
- Do not log full audit deltas/payloads to console/telemetry; treat as potentially sensitive operational data.

---

## 14. Non-Functional UI Requirements

- **Performance:** Product detail should load hints with one request; avoid per-hint N+1 calls.
- **Accessibility:** All form inputs labeled; validation messages associated to inputs; keyboard navigable tag rows; confirmation dialogs accessible.
- **Responsiveness:** Works on tablet widths used in-store; tag editor usable without horizontal scrolling where possible.
- **i18n/timezone:** Audit timestamps displayed in user locale/timezone; no currency handling required.
- **Safe rendering:** If any tag metadata or audit delta is returned as JSON, render safely (escape + truncate in lists + expand/copy) and do not persist to `localStorage` (pattern aligned with DECISION-INVENTORY-015, applied as a general frontend safety practice).

---

## 15. Applied Safe Defaults
- Default ID: UI-EMPTY-STATE-001  
  - Assumed: Standard empty state messaging + ‚ÄúAdd Hint‚Äù CTA when no hints exist.  
  - Why safe: Pure UX; does not affect domain rules or persisted data.  
  - Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- Default ID: UI-LOADING-INDICATOR-001  
  - Assumed: Show loading spinners/disabled actions during service calls.  
  - Why safe: UX ergonomics only; no business policy inferred.  
  - Impacted sections: Functional Behavior, Alternate / Error Flows.
- Default ID: UI-ERROR-MAP-HTTP-001  
  - Assumed: Standard handling for 400/401/403/404/409/422/5xx with field mapping when provided, otherwise banner + technical details.  
  - Why safe: Standard error-handling mapping; does not define backend policy or permissions.  
  - Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows.

---

## 16. Open Questions

1. **Domain ownership / SoR (blocking, domain conflict):** Which domain owns `VehicleApplicabilityHint` and `FitmentTag` as system of record (Product domain vs Inventory vs another)? This issue is labeled `domain:inventory`, but the original classification says ‚ÄúProduct / Parts Management.‚Äù Confirm the correct `domain:*` label and owning backend.
2. **Backend contract mapping (blocking):** What are the exact Moqui proxy endpoints (preferred) or Moqui service names and payload schemas for:
   - list hints by `productId`, create/update/delete hint, search products by vehicle attributes, and load audit log?
3. **Permissions (blocking):** What permission strings gate:
   - viewing hints, creating/updating/deleting hints, and viewing audit logs?
   - How does the frontend discover permissions (existing session/user-permissions endpoint, screen authz, etc.)?
4. **Tag model (blocking):** Are tags constrained to an enum `tagType` list, or can admins create arbitrary keys? If enum, what is the authoritative list and display labels?
5. **Year range validation (blocking):** What formats are accepted (single string like `2020-2023` vs separate min/max fields), and are bounds inclusive?
6. **Cardinality & uniqueness (blocking):** Can a product have multiple hints, or exactly one hint with multiple tags? Are there uniqueness constraints (e.g., no duplicate `tagType` within a hint; uniqueness across hints)?
7. **Audit payload/display (blocking unless minimal metadata-only is acceptable):** Will the audit API return deltas/before-after snapshots, and are they safe to display to all audit viewers? If payload is large/JSON, confirm truncation/expand behavior expectations and any permission gating.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #99: [FRONTEND] [STORY] Receiving: Create Receiving Session from PO/ASN
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## Title
[FRONTEND] Receiving: Create Receiving Session from PO/ASN

## Primary Persona
Receiver (warehouse/store receiving clerk)

## Business Value
Enables fast, accurate check-in by creating an auditable receiving session pre-populated from an existing PO or ASN, reducing manual entry and setup time.

---

# 2. Story Intent

## As a / I want / So that
**As a** Receiver,  
**I want** to create a receiving session by entering or scanning a PO/ASN identifier,  
**so that** expected items and quantities are pre-loaded and I can begin check-in.

## In-scope
- UI flow to create a new Receiving Session using **exact-match** PO/ASN identifier.
- Support two entry methods:
  - Manual text entry
  - Barcode scan into the same input (scanner acts as keyboard input)
- Validation feedback for:
  - Not found
  - Not receivable (closed/fully received)
  - Missing identifier (blind receiving blocked)
- Creation of session shell + pre-populated lines from source
- Navigate to session detail view after creation
- Display auditable metadata available from create response (session id, source doc, entry method, timestamps/creator when returned)

## Out-of-scope (explicit)
- Counting/confirming received quantities and line-by-line matching workflow
- Capturing variances (over/under/wrong item) and variance approval
- Lot/serial capture (not implemented in v1 here; only tolerate fields if returned)
- Search/browse for POs/ASNs (identifier must be entered/scanned)
- Blind receiving (creating session without PO/ASN)

---

# 3. Actors & Stakeholders

- **Receiver (primary user):** creates sessions during physical receiving.
- **Inventory Manager:** cares about traceability/auditability and operational correctness.
- **Purchasing Manager:** cares about PO receiving progression accuracy.
- **External system (Positivity):** may be source of ASN data (frontend consumes via Moqui/backend APIs; no direct integration UI here).

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in the frontend.
- User is authorized to create receiving sessions (permission string must be confirmed; UI must handle 403 per platform convention).

## Dependencies
- Moqui proxy integration pattern is used for all calls (no direct Vue ‚Üí backend calls). (DECISION-INVENTORY-002)
- Backend capability to:
  - Validate a PO/ASN identifier for receivability (exact match)
  - Create a ReceivingSession tied to exactly one source document (PO or ASN)
  - Return created session and its expected lines
- Product master mapping exists for items on PO/ASN (backend responsibility; frontend renders lines returned)

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Primary navigation: Receiving module landing screen (e.g., `/receiving`)
- Action: ‚ÄúCreate New Receiving Session‚Äù

## Screens to create/modify
1. **Screen:** `apps/pos/screen/receiving/CreateReceivingSession.xml` (new)
   - Purpose: enter/scan identifier and submit session creation
2. **Screen:** `apps/pos/screen/receiving/ReceivingSessionDetail.xml` (new or existing if already present)
   - Purpose: show created session header + expected lines (read-only for this story)
3. **Menu/Navigation update:** add route/link from receiving landing screen to create screen

## Navigation context
- Breadcrumb: Receiving ‚Üí Create Session
- After successful creation: redirect to Receiving ‚Üí Session ‚Üí Detail (with `receivingSessionId` parameter)

## User workflows (happy + alternate paths)

### Happy path (manual)
1. Receiver opens Create Session screen
2. Enters identifier (e.g., `PO-123`)
3. Clicks ‚ÄúCreate Session‚Äù
4. Sees Session Detail with header (supplier, shipment ref if any, source doc) and expected lines

### Happy path (scan)
1. Receiver focuses identifier input
2. Scans barcode; value populates input
3. User confirms by clicking Create (no auto-submit in v1)
4. Redirect to Session Detail

### Alternate paths
- Not found ‚Üí inline error; stay on create screen
- Not receivable ‚Üí inline error; stay on create screen
- Missing identifier ‚Üí blocking message; stay on create screen
- Cancel ‚Üí back to receiving landing screen; no changes persisted

---

# 6. Functional Behavior

## Triggers
- User presses ‚ÄúCreate Session‚Äù (primary trigger)
- User presses Enter while in identifier field (treated as Create if non-empty)

## UI actions
- Input field for `sourceDocumentIdentifier` (string)
- Buttons:
  - **Create Session** (primary)
  - **Cancel** (secondary)
- Loading state while calling service
- Disable Create while request in-flight

## State changes
- No local state persistence required beyond in-screen form state
- On success: route transition to detail screen with returned `receivingSessionId`

## Service interactions (Moqui)
- UI calls Moqui proxy endpoint(s) only. (DECISION-INVENTORY-002)
- Create flow:
  1. Submit create request with identifier and entry method
  2. Receive created session payload (including lines) OR receive deterministic error payload
  3. Navigate to detail screen using returned `receivingSessionId`
- Detail load:
  - Load session header + lines by `receivingSessionId`

## Entry method capture (resolution + rationale)
- **Resolution:** v1 records `entryMethod=MANUAL` for all creates unless the frontend has an existing, explicit scanner-input utility that can reliably classify scan input.
- **Rationale:** Scan detection heuristics (timing-based keystrokes) are not a safe default and can misclassify; do not invent a new detection policy without an explicit platform decision (SAFE_DEFAULTS denylist: policy/identifiers). If a scanner utility exists in the repo, it may be used, but this story cannot assume it without confirmation.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Identifier is required:
  - If empty/blank on submit ‚Üí show blocking error: **‚ÄúReceiving requires a valid PO or ASN. Blind receiving is not supported.‚Äù**
  - No request is sent when blank.
- Exact match required:
  - Backend returns not found ‚Üí show: **‚ÄúSource document <id> not found.‚Äù** (or backend-provided message)
- Must be receivable:
  - If PO/ASN is Closed/Fully Received ‚Üí show: **‚Äú<id> has already been fully received.‚Äù** (prefer backend message when provided)

## Enable/disable rules
- Create button disabled when identifier is blank or request is in-flight
- Identifier field disabled during in-flight request (prevents concurrent submits)

## Visibility rules
- Error banner/inline message visible only when last submit failed
- Session detail screen displays:
  - Header fields (supplier/distributor, shipment reference, source doc id/type, status)
  - Expected lines list (read-only here)

## Error messaging expectations
- Prefer backend error messages when safe and user-actionable.
- Fallback to standard mapped messages by HTTP status (deterministic mapping):
  - 400/422: validation error (show message; map field errors if present)
  - 401: route to login/session refresh per app convention (DECISION-INVENTORY-012)
  - 403: ‚ÄúYou do not have permission to create receiving sessions.‚Äù
  - 404: not found (if used by backend)
  - 409: conflict (e.g., already fully received) show message
  - 5xx: ‚ÄúSomething went wrong creating the receiving session. Try again or contact support.‚Äù

---

# 8. Data Requirements

## Entities involved (conceptual; frontend reads/writes via services)
- `ReceivingSession`
- `ReceivingLine`
- `SupplierRef` (read-only display via session header)
- `VarianceRecord` (mentioned in original, but **out-of-scope** in this story)

## Fields (type, required, defaults)

### Create request (frontend ‚Üí service)
- `sourceDocumentId` (String, **required**) ‚Äî value user entered/scanned (trimmed)
- `sourceDocumentType` (Enum `PO|ASN`, **optional/derived**) ‚Äî only send if backend requires it (see Open Questions)
- `entryMethod` (Enum `MANUAL|SCAN`, **required**)
  - v1 default: `MANUAL` unless scanner utility exists and is explicitly used (see Open Questions)

### Create response (service ‚Üí frontend)
- `receivingSessionId` (String/UUID, required)
- `sourceDocumentId` (String, required)
- `sourceDocumentType` (Enum `PO|ASN`, required)
- `supplierId` (String, required)
- `supplierName` (String, recommended for UI display)
- `shipmentReference` (String, nullable)
- `status` (Enum; expected initial `Open`, required)
- `createdAt` (Timestamp, optional if returned)
- `createdByUserId` (String, optional if returned)
- `lines[]` (required)
  - `receivingLineId` (String/UUID, required)
  - `productId` (String, required)
  - `productName`/`sku` (String, optional if returned)
  - `expectedQuantity` (Decimal, required)
  - `receivedQuantity` (Decimal, required; default 0)

## Read-only vs editable
- Create screen: only `sourceDocumentId` editable
- Detail screen (this story): all fields read-only (no editing of quantities/lines)

## Derived/calculated fields
- Display-only: total expected lines count, total expected quantity (optional UI convenience)

---

# 9. Service Contracts (Frontend Perspective)

## Integration pattern (binding)
- All calls are to **Moqui proxy** endpoints/services; Vue must not call inventory/positivity backends directly. (DECISION-INVENTORY-002)
- Responses are **plain JSON** (no `{data: ...}` envelope) and errors follow a deterministic schema. (DECISION-INVENTORY-003)

## Load/view calls
- `GET /receiving/sessions/{receivingSessionId}`
  - **Input:** path param `receivingSessionId`
  - **Output:** session header + lines (fields listed in Data Requirements)
  - **Use:** Session Detail screen load/refresh

## Create/update calls
- `POST /receiving/sessions`
  - **Input (JSON body):**
    - `sourceDocumentId` (required)
    - `entryMethod` (required; see Functional Behavior)
    - `sourceDocumentType` (optional; only if required by backend)
  - **Output:** created session object including `receivingSessionId` and `lines[]`

## Submit/transition calls
- None in this story (no state transitions beyond creation)

## Error handling expectations
- Deterministic error schema (aligned to inventory conventions; applied here as a frontend expectation):
  - `message` (string, required)
  - `errorCode` (string, optional but recommended)
  - `fieldErrors` (optional array of `{ field, message }`)
  - `correlationId` (optional; otherwise read from `X-Correlation-Id` header)
- Frontend mapping:
  - If `fieldErrors` includes `sourceDocumentId` ‚Üí show inline helper text on identifier input
  - Otherwise show page-level alert with `message`
  - Always show correlation ID in ‚ÄúTechnical details‚Äù section when available (DECISION-INVENTORY-012)

---

# 10. State Model & Transitions

## Allowed states (as displayed)
- `Open` (expected initial)
- `InProgress`, `Completed`, `Cancelled` (may exist; displayed if returned)

## Role-based transitions
- None implemented in UI for this story

## UI behavior per state
- Detail screen:
  - Always read-only in this story regardless of state
  - If session is not found or access denied, show appropriate error state

---

# 11. Alternate / Error Flows

## Validation failures
- Empty identifier ‚Üí show blind receiving blocked message; no request sent
- Backend 400/422 with field error ‚Üí show inline; remain on create screen

## Concurrency conflicts
- If backend returns 409 because a session was created concurrently or PO became fully received between validation and create:
  - Show backend message; remain on create screen
  - Allow retry with a different identifier

## Unauthorized access
- 401:
  - Route to login/session refresh per app convention (DECISION-INVENTORY-012)
- 403:
  - Show forbidden state/message
  - Do not retry automatically
  - Provide navigation back to Receiving landing

## Empty states
- Detail screen loads but `lines[]` is empty:
  - Show message: ‚ÄúNo expected lines were provided for this source document.‚Äù
  - Still display session header for auditability

## Timeout behavior (UX target alignment)
- If request exceeds 8 seconds:
  - Show timeout message with Retry
  - Do not auto-retry
  - Keep correlation ID if available (DECISION-INVENTORY-004, DECISION-INVENTORY-012)

---

# 12. Acceptance Criteria

## Scenario 1: Create session from PO via manual entry
**Given** the Receiver is authenticated  
**And** a Purchase Order with identifier `PO-123` exists and is receivable (Open or Partially Received)  
**When** the Receiver navigates to Receiving ‚Üí Create Session  
**And** enters `PO-123` in the identifier field  
**And** clicks ‚ÄúCreate Session‚Äù  
**Then** the system creates a receiving session with status `Open`  
**And** the created session is tied to source document `PO-123`  
**And** the session detail screen is shown for the returned `receivingSessionId`  
**And** expected lines are displayed with `receivedQuantity = 0` for each line  
**And** the create request includes `entryMethod=MANUAL`

## Scenario 2: Create session from ASN via scan (no auto-submit)
**Given** the Receiver is authenticated  
**And** an ASN with identifier `ASN-ABC-789` exists and is receivable  
**When** the Receiver navigates to the Create Session screen  
**And** scans a barcode that inputs `ASN-ABC-789` into the identifier field  
**And** clicks ‚ÄúCreate Session‚Äù  
**Then** a receiving session is created and displayed  
**And** the session is tied to `ASN-ABC-789`  
**And** the session lines are pre-populated from ASN expected lines  
**And** the create request includes `entryMethod=MANUAL` **unless** an existing scanner-input utility is confirmed and used to set `SCAN` (see Open Questions)

## Scenario 3: Identifier not found
**Given** the Receiver is on the Create Session screen  
**When** the Receiver enters `PO-999`  
**And** clicks ‚ÄúCreate Session‚Äù  
**Then** the system shows an error message ‚ÄúSource document PO-999 not found.‚Äù (or backend-provided equivalent)  
**And** no navigation to session detail occurs  
**And** no receiving session is created

## Scenario 4: Source document already fully received/closed
**Given** the Receiver is on the Create Session screen  
**And** a Purchase Order `PO-456` exists but is Closed/Fully Received  
**When** the Receiver enters `PO-456` and submits  
**Then** the system shows an error message indicating it has already been fully received  
**And** no session is created

## Scenario 5: Blind receiving blocked
**Given** the Receiver is on the Create Session screen  
**When** the Receiver leaves the identifier blank  
**And** clicks ‚ÄúCreate Session‚Äù  
**Then** the system shows ‚ÄúReceiving requires a valid PO or ASN. Blind receiving is not supported.‚Äù  
**And** no request is sent to create a session

## Scenario 6: Unauthorized user
**Given** the user lacks permission to create receiving sessions  
**When** they attempt to create a session for a valid identifier  
**Then** the system shows a forbidden/permission error message  
**And** no session detail is shown

## Scenario 7: 401 requires re-authentication
**Given** the Receiver‚Äôs session is expired  
**When** they submit a valid identifier  
**Then** the UI follows the standard 401 behavior to prompt login/session refresh  
**And** does not display receiving data

## Scenario 8: Timeout shows retry
**Given** the Receiver submits a valid identifier  
**When** the create request takes longer than 8 seconds  
**Then** the UI shows a timeout message with a Retry action  
**And** does not auto-retry the request

---

# 13. Audit & Observability

## User-visible audit data
- On Session Detail screen, display (if returned by service):
  - `createdAt`
  - `createdBy` (user id or name)
  - `sourceDocumentType` + `sourceDocumentId`
  - `entryMethod`
  - `receivingSessionId` (copyable)

## Status history
- Out-of-scope to display full history unless backend already exposes it; do not implement new timeline here.

## Traceability expectations
- Include `X-Correlation-Id` on requests and surface it in error UI ‚ÄúTechnical details‚Äù when present. (DECISION-INVENTORY-012)
- Do not log sensitive payloads; for this story, avoid logging full response bodies in console/telemetry by default.

---

# 14. Non-Functional UI Requirements

- **Performance/UX targets:** show loading indicator within 100ms; show timeout at 8 seconds with retry; no auto-refresh loops. (DECISION-INVENTORY-004)
- **Accessibility:** Identifier input has label; errors announced via aria-live; buttons keyboard accessible; Enter submits when focus in input.
- **Responsiveness:** Works on tablet form factor; no reliance on hover interactions.
- **i18n/timezone/currency:** Timestamps displayed in user locale/timezone if available; no currency handling required.

---

# 15. Applied Safe Defaults

- SD-UX-ENTER-SUBMIT: Allow Enter key in identifier field to trigger Create when non-empty; qualifies as safe ergonomic default; impacts UX Summary, Functional Behavior, Acceptance Criteria.
- SD-UX-LOADING-DISABLE: Disable inputs/buttons during in-flight request and show loading indicator; safe to prevent duplicate submissions; impacts Functional Behavior, Error Flows.
- SD-ERR-HTTP-MAP: Standard mapping of 400/401/403/404/409/422/5xx to user-actionable messages when backend message not provided; safe as generic error handling; impacts Business Rules, Service Contracts, Error Flows.
- SD-OBS-CORRELATION-ID: Propagate and display `X-Correlation-Id` in error technical details; safe observability boilerplate consistent with platform conventions; impacts Service Contracts, Audit & Observability, Error Flows.

---

# 16. Open Questions

1. **Domain ownership confirmation (blocking):** Is ‚ÄúReceiving Session from PO/ASN‚Äù owned by **Inventory** in this codebase, or by a separate **Purchasing/Receiving** domain/module? This story is labeled `domain:inventory`, but the capability is not covered by the provided Inventory domain decisions and may represent a different bounded context.

2. **Backend/Moqui proxy contract (blocking):** What are the exact Moqui proxy endpoints and schemas for:
   - Create receiving session from source (request/response fields, status codes, error schema)
   - Load receiving session detail  
   The `/receiving/...` paths in this story are placeholders and must be confirmed.

3. **Authorization (blocking):** What is the canonical permission string (or set) to:
   - View Create Session screen
   - Create a session
   - View session detail  
   Inventory domain provides permission conventions for inventory features (DECISION-INVENTORY-010) but does not define receiving permissions.

4. **Source document type inference (blocking):** Will the backend infer `sourceDocumentType` from `sourceDocumentId`, or must the UI supply it? If UI must supply it, what is the required UX (toggle, prefix rule, barcode format)?

5. **Scan detection (non-blocking if `MANUAL` acceptable):** Does the frontend already have a scanner-input utility/pattern that can reliably set `entryMethod=SCAN`? If yes, what is the approved approach/component to use? If not, confirm that recording `MANUAL` for all creates is acceptable for v1.

6. **Session detail screen existence (non-blocking):** Is there already a receiving session detail screen/route in `durion-moqui-frontend` that should be extended instead of created anew? If yes, provide its path and parameter naming.

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Receiving: Create Receiving Session from PO/ASN ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/99

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #97: [FRONTEND] [STORY] Receiving: Direct-to-Workorder Receiving (Cross-dock) from Distributor
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] Receiving: Direct-to-Workorder Receiving (Cross-dock) from Distributor

### Primary Persona
Inventory Manager

### Business Value
Enable urgent parts to be received from a distributor and immediately issued to a specific workorder (cross-dock), reducing job lead time by bypassing put-away/pick while preserving an auditable receive+issue trail and notifying Work Execution.

---

## 2. Story Intent

### As a / I want / So that
**As an** Inventory Manager,  
**I want** to receive items from a supplier shipment and link them directly to a workorder line with immediate issue allocation,  
**so that** urgent jobs can be fulfilled without standard put-away and picking delays.

### In-scope
- Frontend screens/flows to:
  - Select an inbound shipment/receipt to receive.
  - Enter/confirm received quantities per receiving line.
  - Link a receiving line to `workOrderId` and `workOrderLineId` (note casing aligned to Inventory decision docs for ledger linkage fields; UI must map to backend contract exactly once known).
  - Execute a ‚Äúcross-dock receive + issue‚Äù action as a single user flow.
  - Display result (receipt + issue created) and audit-relevant references (supplier shipment ref, workorder refs, issue mode, confirmer, correlation id).
- Error/alternate flows surfaced to user (mismatch, closed WO, permission denied, concurrency conflict, timeout).
- Moqui screen/form/transition wiring consistent with project conventions.
- Integration constraint: UI calls **Moqui proxy endpoints only** (no direct Vue ‚Üí inventory backend). (DECISION-INVENTORY-002)

### Out-of-scope
- Defining or changing backend domain logic (ledger posting rules, costing formula, event emission internals).
- Put-away/bin assignment for these lines (explicitly bypassed).
- Creating/editing workorders or workorder demand lines (WorkExec-owned).
- Any ledger mutation UI (ledger is append-only and immutable). (DECISION-INVENTORY-005)
- Accounting UI or job-cost UI.

---

## 3. Actors & Stakeholders
- **Primary user:** Inventory Manager (receives shipments, confirms issuance)
- **Secondary users:** Service Advisor (visibility only), Technician (downstream beneficiary)
- **External systems:**
  - **WorkExec** (workorders/demand; must be notified when issue completes ‚Äî notification mechanism is backend-owned)
  - **Distributor/Supplier** (shipment reference)
- **Internal systems:**
  - Inventory services (receipt + issue transaction; inventory ledger)
  - Moqui proxy layer (auth/session, correlation propagation, error mapping) (DECISION-INVENTORY-002, DECISION-INVENTORY-012)
  - AuthN/AuthZ (permissions to issue/override if applicable)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend (Moqui session).
- A target workorder exists in WorkExec with at least one line demanding a product/SKU.
- An inbound shipment/receiving document exists in inventory/receiving context with at least one line to receive.

### Dependencies (blocking where contract unknown)
- **Moqui proxy endpoints** (or Moqui services backing them) for:
  - Listing/loading receiving shipments and lines (inventory-owned receiving read model; endpoint names not provided in Inventory domain decisions)
  - Searching/selecting workorders and workorder lines (WorkExec-owned; must be exposed via Moqui proxy)
  - Performing cross-dock ‚Äúreceive+issue‚Äù transaction atomically (inventory-owned command)
- Deterministic error schema for validation and conflicts (plain JSON; field errors supported). (DECISION-INVENTORY-003)
- Correlation ID propagation via `X-Correlation-Id` and consistent 401/403 behavior. (DECISION-INVENTORY-012)
- Permission naming convention uses stable colon-separated strings; exact permission strings for this flow are not defined in Inventory decisions and must be confirmed. (DECISION-INVENTORY-010)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Receiving** ‚Üí **Inbound Shipments** (or existing receiving entry in the app)
- From a shipment detail: per-line action **Cross-dock to Workorder**

### Screens to create/modify
1. **Modify** existing receiving shipment detail screen (if present):
   - Add per-line action ‚ÄúCross-dock to Workorder‚Äù
   - If line already cross-docked/linked, show read-only linkage summary and disable action (exact ‚Äúalready linked‚Äù semantics depend on receiving model contract)
2. **Create** `Receiving/CrossDockReceive` screen (or sub-screen under shipment detail):
   - Workorder picker + workorder line picker
   - Quantity receive input
   - Review/confirm step (always available; may be skipped only if backend explicitly returns `issueMode=AUTO_ON_RECEIPT` eligibility)
   - Result summary with references and correlation id

> Moqui artifacts expected (implementation-oriented)
- `screen` with:
  - `parameters`: `shipmentId`, `receivingLineId` (names TBD), optional deep-link params if supported by receiving module
  - `actions`: load shipment/line context; load workorder lines after selection
  - `transitions`:
    - `selectWorkOrder` (updates context)
    - `review` (validates client-side; may call server-side validate if available)
    - `submit` (POST command)
    - `done` (return to shipment detail)
- `forms`:
  - `CrossDockForm` (workOrderId, workOrderLineId, quantityReceived, override flags/reason if supported)
  - `ConfirmForm` (read-only summary + confirm action)

### Navigation context
- Breadcrumb: Receiving ‚Üí Shipment `<supplierShipmentRef|shipmentNumber>` ‚Üí Line `<productSku>` ‚Üí Cross-dock
- ‚ÄúBack‚Äù returns to shipment detail; on success, shipment detail reloads to reflect updated line.

### User workflows (happy + alternate)
#### Happy path (manual confirm)
1. Open shipment detail, choose a line, click **Cross-dock to Workorder**
2. Search/select **Workorder**
3. Select **Workorder Line** (filtered to selected workorder)
4. Enter **received quantity**
5. Review summary (shipment ref, product, qty, workorder/line)
6. Confirm ‚Üí system posts receive+issue
7. Show success summary and return to shipment detail

#### Happy path (auto-issue)
1‚Äì4 same as above  
5. UI indicates ‚ÄúAuto-issue will occur‚Äù based on backend-provided eligibility  
6. Submit without manual confirm (or confirm step becomes informational and auto-submits once)

#### Alternate paths
- Workorder is closed/cancelled ‚Üí blocked with message
- Product mismatch between receiving line and WO line ‚Üí blocked or override (only if backend supports and user has permission)
- Timeout/network error ‚Üí show correlation id; allow retry with explicit warning about possible duplicate posting unless idempotency is confirmed

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúCross-dock to Workorder‚Äù on a receiving line.
- User submits cross-dock transaction (manual confirm or auto-submit).

### UI actions
- **Load context**: shipment header + receiving line details (productSku, remaining qty, supplierShipmentRef)
- **Search Workorder**:
  - Query by workorder number/id (and optionally customer name only if WorkExec proxy supports it)
  - Results paginated (cursor or offset per WorkExec contract; do not assume totals)
- **Select Workorder Line**:
  - Show line identifier, productSku, remaining demand/qty (if provided), line status
- **Enter Received Quantity**:
  - Decimal input; display UoM read-only (no UoM conversion in UI)
- **Review & Confirm**:
  - Always available; required when override is used (if supported)
- **Submit**:
  - Calls Moqui proxy command to perform atomic receive+issue
  - Disables inputs while in-flight; prevents double-submit

### State changes (frontend-visible)
- Receiving line becomes linked to `workOrderId` and `workOrderLineId` (persisted by backend).
- Inventory ledger records receive and issue (append-only; UI only displays references if returned). (DECISION-INVENTORY-005)
- UI displays `issueMode` and `confirmedBy` after completion (if returned).

### Service interactions (high level)
- Load shipment + lines (Moqui proxy)
- Search workorders + load workorder lines (Moqui proxy to WorkExec)
- Submit cross-dock receive+issue (Moqui proxy to Inventory command)
- Reload shipment detail after submit if response does not include updated line model

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Received quantity**
  - Required; must parse as decimal; must be `> 0`
  - If receiving line provides `quantityRemainingToReceive`, quantity must be `<= remaining`
- **Workorder eligibility**
  - Workorder must be in an issuable state; if backend returns a non-issuable status, block submit and show message
- **Product match**
  - Default: receiving line productSku must match selected workorder line productSku
  - UI may do best-effort client-side mismatch detection **only when both SKUs are present** to provide immediate feedback; backend remains source of truth and must validate on submit (do not rely solely on client-side). (DECISION-INVENTORY-003 deterministic validation errors)
  - Override path is only shown if backend indicates override is allowed for the user/session (do not assume). (SAFE_DEFAULTS denylist: permissions/policy)

### Enable/disable rules
- Submit/Confirm disabled until:
  - workorder selected
  - workorder line selected
  - quantity valid
  - no blocking validation errors
- While submitting:
  - Disable all inputs and actions; show progress indicator
- Override controls:
  - Hidden unless mismatch exists AND backend indicates override is permitted
  - If override selected, require `overrideReasonCode` before enabling confirm

### Visibility rules
- Show supplier shipment reference on review/confirm and result (audit requirement).
- Show ‚ÄúAuto-issue will occur‚Äù indicator only when backend explicitly returns eligibility/selected mode (do not infer).
- Show correlation id in error technical details (DECISION-INVENTORY-012).

### Error messaging expectations
- Deterministic error schema:
  - Map field errors to fields when provided (DECISION-INVENTORY-003)
  - Show a top-level banner with a user-safe message and correlation id
- 401 ‚Üí route to login/session refresh per app convention (DECISION-INVENTORY-012)
- 403 ‚Üí forbidden state; do not leak shipment/workorder data beyond what is already loaded (DECISION-INVENTORY-012)
- 409 ‚Üí concurrency conflict; prompt reload
- Timeout at 8 seconds: show timeout state with retry (DECISION-INVENTORY-004 UX target applied as a general inventory UX standard)

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Receiving Shipment** (inventory-owned receiving read model; entity name TBD)
- **ReceivingLine** (must include or be able to display):
  - `receivingLineId` (string)
  - `productSku` (string) and optional display fields (name/description may be product-domain; treat as display-only)
  - `uom` (string, display-only)
  - `quantityOrdered` (decimal, optional)
  - `quantityReceivedToDate` (decimal, optional)
  - `quantityRemainingToReceive` (decimal, optional)
  - Link fields: `workOrderId` (nullable), `workOrderLineId` (nullable)
- **Workorder summary + lines** (WorkExec-owned via Moqui proxy):
  - `workOrderId` (string)
  - `workOrderNumber` (string, display)
  - `status` (string)
  - `workOrderLineId` (string)
  - `productSku` (string)
  - `quantityDemanded` (decimal, optional)
  - `quantityIssuedToDate` or `quantityRemaining` (decimal, optional)
- **Cross-dock transaction result** (inventory command response):
  - `receiptId` (string, optional)
  - `issueLedgerEntryId` or `ledgerEntryIds` (string/list, optional)
  - `issueMode` (`MANUAL_CONFIRM` | `AUTO_ON_RECEIPT` | other backend-defined)
  - `confirmedBy` (`SYSTEM` or user identifier)
  - Optional `warnings[]` (e.g., notification queued/failed) ‚Äî only if backend provides

### Fields (type, required, defaults)
- Input fields:
  - `workOrderId` (string) **required**
  - `workOrderLineId` (string) **required**
  - `quantityReceived` (decimal) **required**
  - `overridePartMismatch` (boolean) optional, default `false`
  - `overrideReasonCode` (string) required only if `overridePartMismatch=true`
- Read-only vs editable
  - Workorder selection: editable until submit; after submit, read-only in result
  - Quantity: editable until submit; locked during submission
  - UoM: read-only always

### Derived/calculated fields (frontend-only)
- `quantityRemainingOnWorkorderLine` derived only when backend provides enough fields; otherwise omit
- `isAutoIssueEligible` must come from backend response/flags; do not infer (SAFE_DEFAULTS denylist: policy)

---

## 9. Service Contracts (Frontend Perspective)

> Inventory domain decisions define proxy pattern, error schema, correlation behavior, but do **not** define receiving/cross-dock endpoints. This story requires explicit Moqui proxy contracts to be implementable.

### Load/view calls
1. **Get shipment detail + lines** (Moqui proxy; endpoint TBD)
   - Input: `shipmentId`
   - Output: shipment header (incl. supplier shipment ref) + receiving lines
2. **Search workorders** (Moqui proxy to WorkExec; endpoint TBD)
   - Input: `query`, pagination params (TBD), optional filters
   - Output: list of workorders with status
3. **Get workorder lines** (Moqui proxy to WorkExec; endpoint TBD)
   - Input: `workOrderId`
   - Output: list of lines with productSku and remaining qty/status

### Create/update calls
- **None required** unless backend requires pre-linking; prefer single atomic submit to avoid partial linkage (but must follow backend contract once known).

### Submit/transition calls (atomic)
- **Cross-dock receive+issue** (Moqui proxy; endpoint TBD)
  - Input:
    - `receivingLineId`
    - `workOrderId`, `workOrderLineId`
    - `quantityReceived`
    - Optional: `overrideReasonCode` (only when overriding)
    - Optional: `clientRequestId`/idempotency key (only if backend supports; unknown)
  - Output:
    - success status
    - updated receiving line linkage fields
    - `issueMode`, `confirmedBy`
    - identifiers (receiptId, ledgerEntryIds) if available
    - optional warnings

### Error handling expectations
- Plain JSON errors with deterministic schema (DECISION-INVENTORY-003)
- Expected status handling:
  - `400/422` validation errors (field errors + `errorCode`)
  - `401` unauthenticated (redirect/refresh) (DECISION-INVENTORY-012)
  - `403` forbidden (render forbidden state) (DECISION-INVENTORY-012)
  - `409` conflict (concurrency)
  - `5xx` server error (generic message + correlation id)
- Sensitive data policy:
  - Do not log quantities or payloads in client telemetry/console (DECISION-INVENTORY-011)

---

## 10. State Model & Transitions

### Allowed states (frontend-level)
- **Draft:** selecting workorder/line and entering quantity
- **Review:** manual confirmation step (also used when override selected)
- **Submitting:** request in-flight; disable inputs
- **Completed:** show result summary
- **Failed:** show error; allow retry or return

### Role-based transitions
- User with issue permission:
  - Draft ‚Üí Review ‚Üí Submitting ‚Üí Completed
  - Draft ‚Üí Submitting ‚Üí Completed (auto-issue path only when backend indicates)
- User without issue permission:
  - Draft ‚Üí (submit) ‚Üí Failed (403), remain in Draft with error messaging
- Override permission (if supported):
  - Draft (mismatch) ‚Üí Review (forced manual) when override selected

### UI behavior per state
- Draft: editable; inline validation; mismatch warning if detectable
- Review: read-only summary; confirm/cancel
- Submitting: spinner/progress; disable all actions; prevent double-submit
- Completed: show references and ‚ÄúReturn to shipment‚Äù
- Failed: show banner + field errors; show correlation id; allow retry

---

## 11. Alternate / Error Flows

1. **Part mismatch**
   - If mismatch detectable client-side: show warning and block proceed unless override is available
   - On submit, backend may return `PART_MISMATCH_WITH_WORKORDER` (or equivalent); map to banner and highlight selection fields
   - If override supported and permitted: show override controls requiring reason; force Review step

2. **Workorder not issuable**
   - If workorder status indicates closed/cancelled: block selection or block submit with clear message
   - Do not proceed to submission

3. **Quantity invalid**
   - Inline error; disable submit/confirm

4. **Concurrency conflict (409)**
   - Show ‚ÄúThis line was updated by another user. Reload to continue.‚Äù
   - Provide ‚ÄúReload shipment‚Äù action that reloads shipment detail and returns user to Draft with refreshed data

5. **Unauthorized (401/403)**
   - 401: redirect/session refresh (DECISION-INVENTORY-012)
   - 403: forbidden state; do not show additional data; provide ‚ÄúBack to shipment list‚Äù navigation (DECISION-INVENTORY-012)

6. **Timeout / network / server error**
   - After 8 seconds: show timeout message with Retry (DECISION-INVENTORY-004 UX target)
   - Retry behavior:
     - If idempotency is not confirmed, show a warning: ‚ÄúRetry may create a duplicate transaction if the previous request succeeded.‚Äù (cannot assume idempotency support)
   - Always show correlation id if available (DECISION-INVENTORY-012)

---

## 12. Acceptance Criteria

### Scenario 1: Manual confirmation cross-dock succeeds
**Given** an inbound supplier shipment has a receiving line for productSku `P-ABC` with `quantityRemainingToReceive = 2`  
**And** a workorder `WO-123` exists in an issuable state with a line demanding productSku `P-ABC` and remaining quantity `2`  
**And** the backend indicates manual confirmation is required (no auto-issue eligibility flag returned)  
**When** the Inventory Manager selects ‚ÄúCross-dock to Workorder‚Äù on the receiving line  
**And** selects workorder `WO-123` and the matching workorder line  
**And** enters received quantity `2` and proceeds to review  
**Then** the UI shows a confirmation summary including productSku, quantity, supplier shipment reference, workorder number/id, and workorder line id  
**When** the user confirms issuance  
**Then** the UI submits the cross-dock transaction via Moqui proxy  
**And** on success the UI shows `issueMode = MANUAL_CONFIRM` and `confirmedBy = <currentUser>` when provided by the response  
**And** returning to shipment detail shows the receiving line linked to `workOrderId` and `workOrderLineId`

### Scenario 2: Partial quantity cross-dock
**Given** a receiving line for `P-ABC` has `quantityRemainingToReceive = 1`  
**And** workorder `WO-123` has remaining demand `2` for `P-ABC`  
**When** the user cross-docks quantity `1` to `WO-123` and confirms  
**Then** the UI shows success for issuing `1`  
**And** the receiving line linkage is persisted and visible on shipment detail after reload

### Scenario 3: Auto-issue path
**Given** the backend response indicates the selection is eligible for auto-issue and returns `issueMode = AUTO_ON_RECEIPT` (or an explicit `autoIssueEligible=true`)  
**When** the user selects the matching workorder line and enters a valid quantity  
**Then** the UI indicates auto-issue will occur  
**And** submitting completes without a manual confirmation step (or the confirmation step is informational and auto-submits once)  
**And** the result shows `issueMode = AUTO_ON_RECEIPT` and `confirmedBy = SYSTEM` when provided by the response

### Scenario 4: Workorder not issuable (closed/cancelled)
**Given** a workorder `WO-456` is in a non-issuable status returned by WorkExec (e.g., `CLOSED`)  
**When** the user attempts to select `WO-456` or proceed to submit with it selected  
**Then** the UI blocks the action with a clear message indicating the workorder cannot receive issued parts  
**And** no cross-dock submit request is performed

### Scenario 5: Product mismatch blocked (no override)
**Given** a receiving line is for productSku `P-BBB`  
**And** the selected workorder line demands productSku `P-AAA`  
**And** the backend indicates override is not permitted for the current user/session  
**When** the user attempts to proceed to review or submit  
**Then** the UI blocks the action and displays an error with code `PART_MISMATCH_WITH_WORKORDER` when provided by the backend  
**And** the submit/confirm controls remain disabled

### Scenario 6: Product mismatch override requires permission and reason (if supported)
**Given** a product mismatch exists between receiving line and workorder line  
**And** the backend indicates override is permitted for the current user/session  
**When** the user selects ‚ÄúOverride mismatch‚Äù  
**Then** the UI requires a reason code before enabling confirmation  
**And** the flow forces the Review step (no auto-issue)  
**When** the user confirms  
**Then** the UI submits the transaction including the override reason code  
**And** on success the UI shows success and displays the override reason if returned by the backend

### Scenario 7: Permission denied to issue
**Given** the current user lacks the required permission to issue parts for cross-dock  
**When** the user attempts to submit/confirm the cross-dock issuance  
**Then** the backend returns 403  
**And** the UI displays a forbidden error state (no data leakage)  
**And** the UI remains on the cross-dock screen (Draft/Review) without marking the line as completed

### Scenario 8: Timeout shows retry with correlation id
**Given** the user submits a cross-dock transaction  
**And** the request exceeds 8 seconds without a response  
**When** the timeout threshold is reached  
**Then** the UI shows a timeout message with a Retry action  
**And** the UI shows `X-Correlation-Id` in technical details if available  
**And** the UI does not auto-retry the mutation

---

## 13. Audit & Observability

### User-visible audit data
- Show in result summary (and optionally on shipment line detail after reload):
  - supplier shipment reference
  - workorder/workorder line reference
  - quantity issued (displayed to user; but must not be logged to telemetry) (DECISION-INVENTORY-011)
  - issue mode (`MANUAL_CONFIRM` vs `AUTO_ON_RECEIPT`)
  - confirmed by (user vs SYSTEM)
  - timestamp (from backend if available)

### Status history
- If backend returns ledger entry ids, show a read-only ‚ÄúView ledger entry‚Äù link (to existing Inventory Ledger detail screen if present; ledger is immutable). (DECISION-INVENTORY-005)

### Traceability expectations
- Include `X-Correlation-Id` on requests and surface it on error UI technical details. (DECISION-INVENTORY-012)
- Frontend telemetry/logging:
  - Allowed: screen opened, submit attempted, submit success/failure, HTTP status, correlation id
  - Forbidden: logging quantities or raw payloads (DECISION-INVENTORY-011)

---

## 14. Non-Functional UI Requirements
- **Performance/UX timing:** show loading indicator within 100ms; show timeout state at 8 seconds with retry; do not auto-refresh loops. (DECISION-INVENTORY-004)
- **Accessibility:** labeled inputs; validation errors announced; keyboard navigable review/confirm.
- **Responsiveness:** usable on tablet (receiving dock).
- **i18n/timezone:** dates/times shown in site/user timezone; no currency.

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Provide empty-state messaging for ‚Äúno workorders found‚Äù and ‚Äúno lines available‚Äù as UI ergonomics only. (Impacted: UX Summary, Alternate/Error Flows, Acceptance Criteria)
- SD-UI-PAGINATION: Paginate workorder search results with a standard page size to avoid large payloads; does not change business policy. (Impacted: UX Summary, Service Contracts)
- SD-ERR-MAP-HTTP: Map 400/401/403/409/422/5xx to inline + banner errors with retry action; standard error-handling mapping consistent with deterministic error schema. (Impacted: Business Rules, Alternate/Error Flows, Acceptance Criteria)
- SD-OBS-CORRELATION-ID: Include/display correlation id when available for supportability; observability boilerplate aligned to `X-Correlation-Id`. (Impacted: Audit & Observability, Alternate/Error Flows)
- SD-UX-TIMEOUT-8S: Apply 8-second timeout UX with retry affordance as an inventory UX standard (does not alter backend behavior). (Impacted: Alternate/Error Flows, Non-Functional UI Requirements, Acceptance Criteria)

---

## 16. Open Questions

1. **Receiving module contracts (blocking):** What are the exact Moqui proxy REST endpoints (preferred) or Moqui service names for:
   - listing/loading shipment + receiving lines,
   - loading a single receiving line context by `receivingLineId`,
   - reloading shipment detail after submit?
2. **Cross-dock command contract (blocking):** What is the exact Moqui proxy endpoint/service for the atomic ‚Äúreceive + issue to workorder line‚Äù action, including:
   - request field names/casing (`workorderId` vs `workOrderId`, etc.),
   - response shape (receiptId, ledgerEntryIds, issueMode, confirmedBy, warnings)?
3. **WorkExec proxy contracts (blocking):** What are the Moqui proxy endpoints/services for:
   - searching workorders (query fields + pagination shape),
   - loading workorder lines (fields guaranteed: productSku, remaining qty, status)?
4. **Permissions (blocking):** What are the exact permission strings for:
   - viewing/using cross-dock receiving,
   - issuing parts via cross-dock,
   - overriding part mismatch (if supported)?
   (Inventory decisions define naming convention but not these specific permissions.) (DECISION-INVENTORY-010)
5. **Auto-issue policy exposure (blocking):** How does the backend communicate whether auto-issue is eligible/selected?
   - explicit `autoIssueEligible` flag, `issueMode` returned pre-submit, or submit-time decision only?
6. **Idempotency (blocking):** Does the cross-dock submit endpoint support idempotency keys to prevent duplicate receive+issue postings on retry after timeout?
   - If yes, what header/field name should the frontend send and what is the dedupe window?
7. **Notification status (non-blocking if omitted):** Does the submit response include a warning/status for WorkExec notification publication (queued/failed), or is it always asynchronous with no UI feedback?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #96: [FRONTEND] [STORY] Putaway: Generate Put-away Tasks from Staging
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Putaway: Generate Put-away Tasks from Staging

## Primary Persona
Stock Clerk (with supporting personas: Warehouse Manager)

## Business Value
Ensure items received into staging are promptly routed into correct storage locations via generated put-away tasks, improving inventory accuracy, throughput, and auditability.

---

# 2. Story Intent

## As a / I want / So that
**As a** Stock Clerk,  
**I want** to view and claim system-generated put-away tasks created from completed receipts (with suggested destinations and fallback indicators),  
**so that** I can move items from staging to appropriate storage locations efficiently and consistently.

## In-scope
- Frontend screens to:
  - List put-away tasks generated from completed receipts
  - View a put-away task‚Äôs details (source staging, qty, suggested destination, fallback context)
  - Claim / assign tasks (based on permissions)
  - Handle tasks that require manual destination selection by routing to a destination selection UI entry point (minimal picker is acceptable if no dedicated story exists)
- Moqui screen/actions wiring to call **Moqui proxy** services/endpoints (no direct Vue ‚Üí inventory backend). (DECISION-INVENTORY-002)
- Cursor pagination for list screens (`pageSize`, `pageToken`, `nextPageToken`) and deterministic error handling. (DECISION-INVENTORY-003)
- Correlation ID propagation and 401/403 UI behavior. (DECISION-INVENTORY-012)

## Out-of-scope
- Implementing the backend generation of tasks on GoodsReceipt completion (assumed provided by backend).
- Executing put-away (confirming actual movement/completing tasks) unless already supported elsewhere.
- Put-away rule configuration UI (PutawayRule CRUD).
- Designing storage topology management UI beyond using existing pickers/endpoints.

---

# 3. Actors & Stakeholders
- **Stock Clerk:** views/claims tasks; may select destination when required (if permitted).
- **Warehouse Manager:** assigns/reassigns tasks; monitors task pool.
- **Inventory Controller/Auditor:** expects traceability (who claimed/assigned, what was suggested vs final).
- **System (Inventory backend via Moqui proxy):** generates tasks and provides suggested/fallback metadata.

---

# 4. Preconditions & Dependencies
- Backend generates `PutawayTask` records when `GoodsReceipt` transitions to `COMPLETED` (per backend story reference).
- **Integration constraint:** UI calls **Moqui proxy endpoints** only; no direct calls to inventory backends. (DECISION-INVENTORY-002)
- **Error/response constraint:** Plain JSON responses; deterministic error schema; list endpoints use cursor pagination. (DECISION-INVENTORY-003)
- **Correlation/auth behavior:** Use `X-Correlation-Id`; 401 triggers login/session refresh; 403 shows forbidden state without leaking data. (DECISION-INVENTORY-012)
- Storage locations exist; task payload includes IDs resolvable to display names/barcodes via inventory topology endpoints.
- Permissions are enforced server-side and reflected in UI gating when permission info is available. Permission naming must follow stable colon-separated strings. (DECISION-INVENTORY-010)

**Decision rationale applied**
- Moqui proxy requirement and plain JSON/error schema are mandated by Inventory domain decisions to centralize auth/error mapping and keep contracts deterministic. (DECISION-INVENTORY-002, DECISION-INVENTORY-003)
- Cursor pagination is required for scalability and consistency under writes. (DECISION-INVENTORY-003)
- Correlation ID and 401/403 behavior are standardized for supportability and security. (DECISION-INVENTORY-012)

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Main navigation: **Inventory ‚Üí Put-away Tasks**
- Contextual link from a completed Goods Receipt detail screen (if exists): ‚ÄúView Put-away Tasks‚Äù filtered by `sourceReceiptId`.

## Screens to create/modify (Moqui)
1. **Screen:** `Inventory/PutawayTaskList`
   - Lists tasks in shared pool with filters and actions (claim/assign).
2. **Screen:** `Inventory/PutawayTaskDetail`
   - Shows task details and provides claim/assign actions.
3. **Screen/dialog:** `Inventory/PutawayTaskSelectDestination`
   - Used only for status `REQUIRES_LOCATION_SELECTION`.
   - Uses **StorageLocation picker filtered by `locationId`** (site) and blocks invalid selections. (DECISION-INVENTORY-001)

## Navigation context
- `PutawayTaskList` ‚Üí `PutawayTaskDetail` via `taskId`.
- From `PutawayTaskDetail`:
  - ‚ÄúSelect destination‚Äù (only if status requires and user permitted)
  - Return to list preserving filters (query params).

## User workflows
### Happy path (Stock Clerk claims)
1. Clerk opens Put-away Tasks list.
2. Filters to `UNASSIGNED`.
3. Opens a task; reviews source staging + qty + suggested destination.
4. Clicks **Claim**.
5. Task updates to `ASSIGNED` to the clerk; list and detail reflect assignment.

### Alternate path (Manager assigns)
1. Manager opens list; selects a task.
2. Clicks **Assign** and chooses a user.
3. Task updates; assignee shown.

### Alternate path (Requires destination selection)
1. Clerk opens task in `REQUIRES_LOCATION_SELECTION`.
2. If permitted, clicks **Select Destination**.
3. Chooses a destination storage location using a picker filtered by the task‚Äôs site (`locationId`).
4. Saves; task now has destination and is eligible for downstream execution flow (completion handled elsewhere).

---

# 6. Functional Behavior

## Triggers
- User navigates to task list/detail screens.
- User initiates claim/assign/select-destination actions.

## UI actions
### Putaway Task List
- Search/filter (server-side):
  - Status (multi-select)
  - Assignee (Me / Unassigned / specific user if permitted)
  - Source Receipt ID (optional)
  - Product query (optional; only if backend supports)
- Pagination:
  - Uses cursor pagination: `pageSize`, `pageToken` ‚Üí `nextPageToken`. (DECISION-INVENTORY-003)
- Row actions (enabled by permission + state):
  - **Claim** (if `status=UNASSIGNED` and user has claim permission)
  - **Assign** (if user has assign permission; opens assignee picker)

### Putaway Task Detail
- Displays:
  - Product (display name + SKU if provided)
  - Quantity (read-only)
  - Source staging location (site + bin if provided)
  - Suggested destination (if present)
  - Original suggested destination + fallback reason when present
  - Status
  - Assignee
  - Links: source receipt (if route exists), locations (if route exists)
  - Technical details (collapsed): `taskId`, `sourceReceiptId`
- Actions:
  - Claim (UNASSIGNED)
  - Assign/Reassign (manager)
  - Select destination (only when `REQUIRES_LOCATION_SELECTION` and permitted)

### Select Destination (dialog/screen)
- Inputs:
  - Site (`locationId`) is read-only and derived from task context (no free-text UUID entry). (DECISION-INVENTORY-001)
  - Destination storage location picker filtered by `locationId`. (DECISION-INVENTORY-001)
- Submit:
  - Calls backend to set destination for the task; disables submit while in-flight (no double-submit).

## State changes (frontend-observed)
- `UNASSIGNED` ‚Üí `ASSIGNED` upon claim/assign
- `REQUIRES_LOCATION_SELECTION` ‚Üí backend-defined next state upon destination selection (UI must refetch and render returned state)
- No frontend-driven transitions to `IN_PROGRESS/COMPLETED` in this story.

## Service interactions
- On list load: call Moqui proxy list/query with filters + cursor paging. (DECISION-INVENTORY-002, DECISION-INVENTORY-003)
- On detail load: call Moqui proxy get-by-id.
- On claim: call Moqui proxy claim; refresh detail + list row.
- On assign: call Moqui proxy assign; refresh.
- On select destination: call Moqui proxy destination selection; refresh.
- On errors: show correlation ID when available; do not log sensitive payloads. (DECISION-INVENTORY-011, DECISION-INVENTORY-012)

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Claim action enabled only when:
  - task `status == UNASSIGNED`
  - user has claim permission (see Open Questions for exact permission string; must follow `inventory:*` convention). (DECISION-INVENTORY-010)
- Assign action enabled only when:
  - user has assign permission (exact string TBD; must follow `inventory:*` convention). (DECISION-INVENTORY-010)
  - task is not terminal (`CANCELLED`, `COMPLETED`) if those exist in payload
- Select destination enabled only when:
  - task `status == REQUIRES_LOCATION_SELECTION`
  - user has destination-selection permission (exact string TBD; must follow `inventory:*` convention). (DECISION-INVENTORY-010)
  - destination picker selection is non-empty
  - selected `storageLocationId` belongs to the task‚Äôs `locationId` (site); UI prevents cross-site selection by filtering picker. (DECISION-INVENTORY-001)

## Enable/disable rules
- While an action request is in-flight (claim/assign/select destination), disable the initiating control and prevent duplicate submissions.
- If backend returns `401`: route to login/session refresh per app convention. (DECISION-INVENTORY-012)
- If backend returns `403`: show forbidden state; do not display returned data beyond safe generic messaging. (DECISION-INVENTORY-012)
- If backend returns deterministic validation error (typically `400` or `422`):
  - Show message from backend (sanitized) and keep user on the same screen
  - For claim/assign, refetch task detail to resolve stale status

## Visibility rules
- Fallback indicators:
  - If `fallbackReason` present, show ‚ÄúFallback applied‚Äù and display original vs final suggested destinations.
- Suggested destination display:
  - If destination is null/empty and status is `REQUIRES_LOCATION_SELECTION`, show ‚ÄúDestination selection required‚Äù.
- Sensitive data handling:
  - Do not log quantities or raw payloads to console/telemetry. (DECISION-INVENTORY-011)

## Error messaging expectations
- Error UI includes:
  - Human message (generic + backend message if safe)
  - ‚ÄúTechnical details‚Äù section showing `X-Correlation-Id` when present. (DECISION-INVENTORY-012)
- Field-level errors:
  - If deterministic error schema includes field errors (e.g., `assigneeId` invalid), map to the form field; otherwise show banner/dialog error. (DECISION-INVENTORY-003)

---

# 8. Data Requirements

## Entities involved (frontend consumption)
- `PutawayTask` (inventory-owned)
- `LocationRef` (site) and `StorageLocation` (bin) references for display/pickers. (DECISION-INVENTORY-001)
- `GoodsReceipt` reference (read-only link; owned elsewhere)
- `User` (assignee display/picker; owned elsewhere)

## Fields (type, required, defaults)
### PutawayTask (minimum UI fields)
**Identifiers**
- `taskId` (string/UUID, required)
- `sourceReceiptId` (string/UUID, required)

**Product**
- `productSku` (string, required for filtering/deep-linking if supported; otherwise optional)
- `productDisplayName` (string, required for UI unless resolvable)

**Quantity**
- `quantity` (string/decimal, required) ‚Äî **sensitive**; must not be logged. (DECISION-INVENTORY-011)
- `uom` (string, optional; display only if provided)

**Source (staging)**
- `locationId` (string/UUID, required) ‚Äî site
- `storageLocationId` (string/UUID, optional) ‚Äî bin within site
- `sourceLocationDisplay` (string, optional; if absent, UI resolves via topology endpoints)

**Destination (suggested/final)**
- `suggestedDestinationLocationId` (string/UUID, nullable when requires selection) ‚Äî storageLocationId
- `suggestedDestinationDisplay` (string, nullable)
- `originalSuggestedLocationId` (string/UUID, nullable)
- `originalSuggestedLocationDisplay` (string, nullable)
- `finalSuggestedLocationId` (string/UUID, nullable)
- `finalSuggestedLocationDisplay` (string, nullable)
- `fallbackReason` (string/enum, nullable)

**Assignment/Status**
- `status` (string/enum, required)
- `assigneeId` (string/UUID, nullable)
- `assigneeDisplayName` (string, nullable)

**Timestamps**
- `createdAt` (datetime string, required)
- `updatedAt` (datetime string, required)

### Assign action input
- `taskId` (required)
- `assigneeId` (required)

### Select destination input
- `taskId` (required)
- `destinationStorageLocationId` (required)

## Read-only vs editable by state/role
- Read-only always: product, qty, source location, receipt ref, created/updated.
- Editable only via actions:
  - Assignee via claim/assign permissions
  - Destination only when status requires selection and permission granted

## Derived/calculated fields
- ‚ÄúFallback applied‚Äù derived from `fallbackReason != null`.
- ‚ÄúUnassigned‚Äù derived from `assigneeId == null` and `status==UNASSIGNED`.

---

# 9. Service Contracts (Frontend Perspective)

> Inventory integration must use Moqui proxy endpoints/services; Vue must not call inventory backends directly. (DECISION-INVENTORY-002)  
> Responses are plain JSON; list endpoints use cursor pagination; errors follow deterministic schema. (DECISION-INVENTORY-003)

## Load/view calls
1. **List tasks**
   - **Endpoint/service:** **TBD (blocking)** ‚Äî must be a Moqui proxy route (e.g., `GET /inventory/putaway-tasks`)
   - Query params (conceptual; exact names TBD):
     - `status` (repeatable or comma-separated)
     - `assigneeId` (optional; support `me` shortcut optional)
     - `sourceReceiptId` (optional)
     - `productQuery` (optional)
     - `pageSize` (int)
     - `pageToken` (string, optional)
     - `sort` (string, optional)
   - Response (required shape):
     - `items: PutawayTask[]` (or summary objects)
     - `nextPageToken: string|null` (DECISION-INVENTORY-003)

2. **Get task detail**
   - **Endpoint/service:** **TBD (blocking)** ‚Äî Moqui proxy route (e.g., `GET /inventory/putaway-tasks/{taskId}`)
   - Response: `PutawayTask` (full detail)

3. **Topology endpoints for display/pickers**
   - Sites: `GET /inventory/locations` (for `LocationRef` picker) (DECISION-INVENTORY-008)
   - Storage locations: `GET /inventory/storage-locations?locationId=...` (for destination picker) (DECISION-INVENTORY-007)

## Create/update calls
- None (task creation is system-triggered by receipt completion)

## Submit/transition calls
1. **Claim task**
   - **Endpoint/service:** **TBD (blocking)** ‚Äî Moqui proxy route (e.g., `POST /inventory/putaway-tasks/{taskId}/claim`)
   - Input: `taskId` (path or body)
   - Server determines assignee = current user
   - Output: updated task or `{taskId}` + refetch

2. **Assign/Reassign task**
   - **Endpoint/service:** **TBD (blocking)** ‚Äî Moqui proxy route (e.g., `POST /inventory/putaway-tasks/{taskId}/assign`)
   - Input: `assigneeId`
   - Output: updated task or `{taskId}` + refetch

3. **Select destination**
   - **Endpoint/service:** **TBD (blocking)** ‚Äî Moqui proxy route (e.g., `POST /inventory/putaway-tasks/{taskId}/destination`)
   - Input: `destinationStorageLocationId`
   - Output: updated task; status may change (backend-defined)

## Error handling expectations
- Must support deterministic error schema parsing. (DECISION-INVENTORY-003)
- `401`: redirect to login/session refresh. (DECISION-INVENTORY-012)
- `403`: forbidden state; do not leak data. (DECISION-INVENTORY-012)
- `404`: show ‚ÄúTask not found‚Äù with link back to list.
- `409` or `422`: concurrency/validation; show message and refetch task.
- Timeout UX:
  - Show loading indicator quickly; show timeout at ~8 seconds with Retry; do not auto-refresh loop. (DECISION-INVENTORY-004)

---

# 10. State Model & Transitions

## Allowed states (display + filtering)
- `UNASSIGNED`
- `ASSIGNED`
- `IN_PROGRESS` (display-only in this story)
- `COMPLETED` (display-only)
- `CANCELLED` (display-only)
- `REQUIRES_LOCATION_SELECTION`

## Role-based transitions (frontend-initiated)
- Stock Clerk:
  - `UNASSIGNED` ‚Üí `ASSIGNED` via Claim (permission-gated; exact permission string TBD but must follow `inventory:*`). (DECISION-INVENTORY-010)
- Warehouse Manager:
  - `UNASSIGNED/ASSIGNED` ‚Üí `ASSIGNED` via Assign/Reassign (permission-gated; exact permission string TBD but must follow `inventory:*`). (DECISION-INVENTORY-010)
- Destination selector:
  - `REQUIRES_LOCATION_SELECTION` ‚Üí (backend-defined next state) via Select Destination (permission-gated; exact permission string TBD but must follow `inventory:*`). (DECISION-INVENTORY-010)

## UI behavior per state
- `UNASSIGNED`: show ‚ÄúClaim‚Äù (if permitted).
- `ASSIGNED`: show assignee; show ‚ÄúReassign‚Äù for managers.
- `REQUIRES_LOCATION_SELECTION`: show warning; show ‚ÄúSelect destination‚Äù if permitted; destination fields may be empty.
- Terminal (`COMPLETED`, `CANCELLED`): actions disabled/hidden; read-only.

---

# 11. Alternate / Error Flows

## Validation failures
- Claim fails because task is no longer UNASSIGNED:
  - UI shows ‚ÄúTask already updated. Refreshing‚Ä¶‚Äù then refetches detail and updates list row.
- Assign fails due to invalid assignee:
  - UI shows field-level error (if provided) and keeps dialog open.

## Concurrency conflicts
- Two users attempt to claim:
  - One succeeds; the other receives `409/422` and task refresh shows assignee.

## Unauthorized access
- User without permission:
  - Action buttons hidden/disabled when permission info is available.
  - If attempted and backend returns `403`, show forbidden state and keep task read-only.

## Empty states
- No tasks match filters:
  - Show empty state with ‚ÄúClear filters‚Äù and guidance: ‚ÄúIf you just completed a receipt, allow a moment for tasks to generate, then refresh.‚Äù

---

# 12. Acceptance Criteria

## Scenario 1: View generated put-away tasks after receipt completion
**Given** a Goods Receipt has transitioned to `COMPLETED` and backend generated put-away tasks in `UNASSIGNED`  
**When** a Stock Clerk navigates to Inventory ‚Üí Put-away Tasks  
**Then** the list displays the generated tasks including product, quantity, source staging location, and suggested destination (if present)  
**And** the list uses cursor pagination and can load the next page using `nextPageToken` when available. (DECISION-INVENTORY-003)  
**And** the Stock Clerk can open a task detail screen by selecting a row.

## Scenario 2: Display fallback metadata when destination was adjusted
**Given** a put-away task has a non-null `fallbackReason`  
**And** the task includes original and final suggested destinations  
**When** the user views the task detail  
**Then** the UI displays the fallback indicator and shows both original and final suggested destinations.

## Scenario 3: Claim an unassigned task
**Given** a put-away task is in `UNASSIGNED` status  
**And** the current user has the claim permission for put-away tasks (exact permission string per inventory permission convention) (DECISION-INVENTORY-010)  
**When** the user clicks ‚ÄúClaim‚Äù from the list or detail  
**Then** the UI calls the Moqui proxy claim endpoint for that `taskId` (DECISION-INVENTORY-002)  
**And** on success the task is shown as `ASSIGNED` to the current user in both list and detail.

## Scenario 4: Prevent claim when unauthorized
**Given** a put-away task is `UNASSIGNED`  
**And** the current user does not have the claim permission  
**When** the user views the task list or detail  
**Then** the ‚ÄúClaim‚Äù action is not displayed (when permission info is available)  
**And** if the user attempts a direct claim action and receives `403`  
**Then** the UI shows a forbidden state and does not change the task state. (DECISION-INVENTORY-012)

## Scenario 5: Manual destination selection required
**Given** a put-away task is in `REQUIRES_LOCATION_SELECTION`  
**When** a user opens the task detail  
**Then** the UI indicates that destination selection is required  
**And** if the user has destination-selection permission, a ‚ÄúSelect destination‚Äù action is available  
**And** when the user opens destination selection, the destination picker is filtered to storage locations within the task‚Äôs `locationId` (site) and does not allow free-text UUID entry. (DECISION-INVENTORY-001)  
**And** if the user selects a destination and saves successfully, the UI refreshes and displays the updated destination and status returned by backend.

## Scenario 6: Concurrency on claim
**Given** a put-away task is `UNASSIGNED` and visible to two users  
**When** User A claims the task successfully  
**And** User B attempts to claim the same task afterward  
**Then** User B sees an error indicating the task is no longer available  
**And** the UI refresh shows the task as assigned to User A.

## Scenario 7: Correlation ID shown on errors
**Given** the backend returns an error response that includes/echoes `X-Correlation-Id`  
**When** the UI shows the error state for list load or an action  
**Then** the UI displays the correlation ID in a ‚ÄúTechnical details‚Äù section. (DECISION-INVENTORY-012)

---

# 13. Audit & Observability

## User-visible audit data
- Display created/updated timestamps on detail.
- Display current assignee and status.
- Do not imply full history unless backend provides it.

## Status history
- If backend exposes a task history endpoint, render a read-only ‚ÄúHistory‚Äù section (most-recent-first) with:
  - timestamp, actor (if provided), fromStatus ‚Üí toStatus, notes (if safe)
- Otherwise, omit history and rely on timestamps.

## Traceability expectations
- Task detail shows `sourceReceiptId` and links to receipt screen if available.
- Error UI surfaces `X-Correlation-Id` for support traceability. (DECISION-INVENTORY-012)
- Client telemetry/logging must not include quantities or raw payloads. (DECISION-INVENTORY-011)

---

# 14. Non-Functional UI Requirements

- **Performance:** List uses server-side cursor pagination; do not fetch unbounded datasets. (DECISION-INVENTORY-003)
- **Timeout UX:** Show loading indicator quickly; show timeout at ~8 seconds with Retry; no auto-refresh loops. (DECISION-INVENTORY-004)
- **Accessibility:** All actions keyboard-navigable; dialogs have proper focus management; labels for form controls.
- **Responsiveness:** Works on tablet-sized screens used in warehouse.
- **i18n/timezone:** Display timestamps in user locale/timezone per app standard.
- **Security:** Never rely on frontend-only permission checks; always handle 401/403 per standard behavior. (DECISION-INVENTORY-012)
- **Sensitive data:** Do not log quantities or raw payloads to console/telemetry. (DECISION-INVENTORY-011)

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a standard empty-state message and ‚ÄúClear filters‚Äù action when no tasks are returned; safe because it does not alter domain logic. (Impacted: UX Summary, Alternate/Empty states)
- SD-UX-PAGINATION: Default page size 25 with cursor-based server paging; safe UI ergonomics only and aligns with cursor pagination requirement. (Impacted: UX Summary, Service Contracts, Acceptance Criteria)
- SD-ERR-MAP-HTTP: Standard mapping of 401/403/404/409/422/5xx to banner/dialog errors with correlation ID display; safe because it is generic error presentation and mandated auth behavior. (Impacted: Business Rules, Error Flows, Observability)

---

# 16. Open Questions
1. **Blocking ‚Äî API contracts:** What are the exact **Moqui proxy** endpoint paths (and methods) for:
   - list put-away tasks (cursor pagination params and response shape),
   - get task detail,
   - claim,
   - assign/reassign,
   - select destination?
   Include request/response JSON and deterministic error schema examples. (Must align with DECISION-INVENTORY-002, DECISION-INVENTORY-003)
2. **Blocking ‚Äî Permission strings:** What are the canonical permission strings for:
   - viewing put-away tasks,
   - claiming,
   - assigning,
   - selecting destination?
   They must follow the `inventory:*` naming convention, but the exact strings are not provided in the inventory decision set. (DECISION-INVENTORY-010)
3. **Blocking ‚Äî Task location model:** Does `PutawayTask` include:
   - `locationId` (site) and `storageLocationId` (staging bin) for the source, and
   - destination as `destinationStorageLocationId` (bin) within a `locationId`?
   Confirm field names so the UI can correctly filter the destination picker by site. (DECISION-INVENTORY-001)
4. **Non-blocking ‚Äî Receipt deep link:** Is there an existing Goods Receipt detail screen/route in this frontend to deep-link from `sourceReceiptId`? If yes, provide the screen path and parameter name.
5. **Non-blocking ‚Äî Assignee picker source:** What is the approved way in this frontend to search/select users for assignment (existing People/HR picker screen/service), and what fields are available for display?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #94: [FRONTEND] [STORY] Putaway: Replenish Pick Faces from Backstock (Optional)
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Putaway: Replenish Pick Faces from Backstock (Optional) ‚Äî Replenishment Task List + Execute Move

### Primary Persona
Warehouse Associate (secondary: Inventory Manager)

### Business Value
Keeps pick faces stocked by surfacing system-generated replenishment tasks and enabling associates to complete inventory moves with auditability, reducing mechanic stockouts and pick delays.

---

## 2. Story Intent

### As a / I want / So that
**As a** Warehouse Associate,  
**I want** to view replenishment tasks and execute the backstock ‚Üí pick face move,  
**so that** pick locations stay stocked and the system records an auditable inventory transfer.

### In-scope
- View a list of open replenishment tasks (PENDING / IN_PROGRESS).
- View task details (item, qty, source, destination, trigger metadata).
- Start work on a task (mark IN_PROGRESS).
- Complete a task by confirming quantities moved and submitting a transfer.
- See success confirmation and updated task status.
- View audit/status history for a task (read-only).
- Enforce Inventory domain location selection guardrails for movement execution:
  - Block completing a task if its `LocationRef` is `INACTIVE` or `PENDING` (treat PENDING like INACTIVE). (DECISION-INVENTORY-009)

### Out-of-scope
- Defining/editing `ReplenishmentPolicy` (min/max) UI.
- Automatically generating tasks (event/batch logic) ‚Äî backend responsibility.
- Complex picking UX (batch picking routes, cart optimization).
- Inventory valuation/costing display or edits.
- Substitution, backorders, or multi-SKU fulfillment.
- Any ledger mutation/edit/delete (ledger is append-only). (DECISION-INVENTORY-005)
- Any UI-side computation of availability/ATP (inventory backend is authoritative). (DECISION-INVENTORY-004)

---

## 3. Actors & Stakeholders
- **Warehouse Associate (Primary user):** executes replenishment tasks.
- **Inventory Manager:** monitors replenishment workload/compliance.
- **Mechanic/Technician (Indirect beneficiary):** faster picks; fewer stockouts.
- **System/Inventory Services (Backend):** provides tasks, enforces idempotency, records ledger transfers and audits.

---

## 4. Preconditions & Dependencies
1. Backend exposes Moqui-proxied APIs to:
   - Query replenishment tasks and task details.
   - Transition task statuses (PENDING ‚Üí IN_PROGRESS ‚Üí COMPLETED; optional CANCELLED).
   - Execute/record inventory transfer for a task (creates immutable ledger entry; no edits). (DECISION-INVENTORY-005)
2. Integration pattern: Vue/Quasar UI calls **Moqui proxy endpoints only** (same-origin), not inventory backends directly. (DECISION-INVENTORY-002)
3. Deterministic error schema is returned as plain JSON (no `{data: ...}` envelope). (DECISION-INVENTORY-003)
4. User authentication exists via Moqui session; UI follows standard 401/403 behavior and surfaces `X-Correlation-Id` in error technical details. (DECISION-INVENTORY-012)
5. Locations use canonical model:
   - `locationId` = `LocationRef` (site)
   - `storageLocationId` = `StorageLocation` (bin) (DECISION-INVENTORY-001)
6. Inventory quantities and payloads are sensitive-by-default; UI must not log quantities or raw payload blobs. (DECISION-INVENTORY-011)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Inventory ‚Üí Putaway/Replenishment ‚Üí Replenishment Tasks**
- Deep links:
  - List: `/inventory/replenishment/tasks`
  - Detail: `/inventory/replenishment/tasks/<taskId>`

### Screens to create/modify
1. **Screen:** `apps/pos/screen/inventory/ReplenishmentTaskList.xml`
2. **Screen:** `apps/pos/screen/inventory/ReplenishmentTaskDetail.xml`
3. **Reusable components (screenlets/widgets)**
   - Task status chip + assigned-to display
   - Safe JSON viewer (if trigger metadata includes JSON blobs; must follow safe rendering rules). (DECISION-INVENTORY-015)
   - Location display helper (renders label; falls back to IDs)

### Navigation context
- Inventory module ‚Üí Replenishment Tasks list ‚Üí Task detail
- Task detail actions:
  - Start Task ‚Üí stays on detail (now IN_PROGRESS)
  - Complete Task ‚Üí stays on detail (now COMPLETED) with success banner and ledger reference (if provided)
  - Back to list preserves filters via query params (UI ergonomics)

### User workflows (happy + alternate)
**Happy path**
1. Associate opens Task List; default filter shows PENDING and IN_PROGRESS.
2. Associate opens a task detail.
3. Clicks **Start Task** ‚Üí task becomes IN_PROGRESS.
4. Completes task by confirming `quantityMoved` (defaults to task quantity) and submitting.
5. UI shows success and any returned ledger reference; task becomes COMPLETED.

**Alternate paths**
- Task already completed/cancelled ‚Üí detail is read-only; actions hidden/disabled.
- Task already in-progress by another user ‚Üí Start/Complete returns 409; UI refreshes and shows current state with guidance.
- Task completion blocked due to inactive/pending location ‚Üí UI blocks if it can detect from loaded `LocationRef.status`; otherwise surfaces backend 422 with clear message. (DECISION-INVENTORY-009)
- Network timeout (8s) ‚Üí show timeout state with Retry; do not auto-refresh loops. (DECISION-INVENTORY-004)

---

## 6. Functional Behavior

### Triggers
- Enter list screen ‚Üí load tasks (first page).
- Enter detail screen ‚Üí load task detail (and optionally history).
- User actions:
  - Start Task
  - Complete Task
  - Refresh (manual)

### UI actions
**Task List**
- Filters:
  - `status` multi-select (default: PENDING, IN_PROGRESS)
  - Search: `productSku` (or `itemSku`) and/or `taskId` (exact/contains per backend support)
  - Optional: `locationId` (site) filter (if backend supports)
- Sorting:
  - Default: oldest first (createdAt ascending) unless backend only supports a fixed sort.
- Pagination:
  - Cursor-based: `pageSize`, `pageToken` ‚Üí `nextPageToken`. No total count required. (DECISION-INVENTORY-003)
- Row click ‚Üí navigate to detail.

**Task Detail**
- Displays:
  - Status, SKU, requested quantity, source/destination (site/bin), createdAt, assignedTo (if present), trigger metadata (read-only)
- Actions:
  - Start Task button (only when status=PENDING)
  - Complete Task form (only when status=IN_PROGRESS)
  - Refresh button (always)
- Complete Task form fields:
  - `quantityMoved` (required integer; default = task.quantity)
  - `completionNote` (optional; only if backend supports)
- Double-submit protection:
  - Disable Start/Complete buttons while request in-flight; do not auto-retry mutations. (Checklist: Events & Idempotency)

### State changes (frontend-observed)
- `PENDING` ‚Üí `IN_PROGRESS` after successful start response.
- `IN_PROGRESS` ‚Üí `COMPLETED` after successful completion response.
- `*` ‚Üí `CANCELLED` only if backend supports and user is authorized (not implemented unless confirmed; see Open Questions).

### Service interactions (Moqui proxy)
- Read:
  - List tasks (paged)
  - Task detail
  - Optional: task history/audit
  - Optional: location lookups for display labels (sites/bins)
- Write:
  - Start task transition
  - Complete task (preferred atomic: transfer + status update in one call)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `quantityMoved`
  - Required
  - Integer
  - Must be > 0
  - Must be ‚â§ `task.quantity` **unless backend explicitly supports partial completion semantics** (not assumed).  
  - Error message:
    - If ‚â§0: ‚ÄúQuantity moved must be greater than 0.‚Äù
    - If > task.quantity: ‚ÄúQuantity moved cannot exceed the task quantity.‚Äù
- Task SKU and locations are read-only in UI (sourcing is backend-owned).
- Location eligibility for movement:
  - If UI has `LocationRef.status` for the involved site(s), block completion when status is `INACTIVE` or `PENDING` and show: ‚ÄúThis location is not active; inventory movements are not allowed.‚Äù (DECISION-INVENTORY-009)
  - If UI cannot load status, rely on backend validation and surface 422 deterministically.

### Enable/disable rules
- **Start Task** enabled only when:
  - `task.status == PENDING`
  - user has required permission(s) (exact strings unknown; see Open Questions)
- **Complete Task** enabled only when:
  - `task.status == IN_PROGRESS`
  - `quantityMoved` passes client validation
  - If `assignedTo` is present and backend enforces assignee-only completion, UI should disable when `assignedTo != currentUser` once confirmed (not assumed; see Open Questions)

### Visibility rules
- Assigned-to section shown only if `assignedTo` exists.
- Audit/history section shown only if history endpoint exists; otherwise omit.
- Any JSON metadata (trigger/decision payloads) must render via safe JSON viewer:
  - escaped, truncated in list/preview, explicit expand/copy, never persisted to localStorage. (DECISION-INVENTORY-015)

### Error messaging expectations
- Deterministic error schema mapping (plain JSON). (DECISION-INVENTORY-003)
- 401: route to login/session refresh per app convention. (DECISION-INVENTORY-012)
- 403: show forbidden state for the action/screen; do not leak data. (DECISION-INVENTORY-012)
- 409: show ‚ÄúThis task was updated by another user. Refresh to continue.‚Äù with Refresh action.
- 422: show backend validation message; map to field errors when applicable (e.g., quantityMoved, inactive location).
- 5xx/timeout: show transient error with Retry; preserve form input.

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `ReplenishmentTask` (inventory-owned operational command/read model; exact backend entity name may differ)
- `InventoryLedgerEntry` (reference only; immutable) (DECISION-INVENTORY-005)
- `LocationRef` and `StorageLocation` (for display/eligibility checks) (DECISION-INVENTORY-001, DECISION-INVENTORY-009)

### Fields (type, required, defaults)
**ReplenishmentTask (expected UI model; exact field names must match backend)**
- `taskId` (uuid, required, read-only)
- `productSku` (string, required, read-only)  
  - Note: story previously used `itemSKU`; canonical param naming elsewhere uses `productSku`. (DECISION-INVENTORY-014)
- `quantity` (integer, required, read-only)
- `sourceLocationId` (uuid, required, read-only) ‚Äî site (`LocationRef.locationId`)
- `sourceStorageLocationId` (uuid, optional, read-only) ‚Äî bin (`StorageLocation.storageLocationId`)
- `destinationLocationId` (uuid, required, read-only)
- `destinationStorageLocationId` (uuid, optional, read-only)
- `status` (enum, required, read-only except via transitions): `PENDING | IN_PROGRESS | COMPLETED | CANCELLED?`
- `createdAt` (timestamp, read-only)
- `assignedTo` (string/uuid, optional, read-only)
- `triggerType` (string/enum, optional, read-only)
- `decisionReason` (string/enum, optional, read-only)
- `sourcingReason` (string/enum, optional, read-only)
- `metadata` (object/json, optional, read-only; render safely) (DECISION-INVENTORY-015)

**Complete form (UI model)**
- `quantityMoved` (integer, required; default = `task.quantity`)
- `completionNote` (string, optional; only if backend supports)

### Read-only vs editable by state/role
- All task fields are read-only always.
- Only actions (Start/Complete) are available depending on state and permissions.

### Derived/calculated fields
- Location display labels:
  - If location lookup endpoints are available, show human-friendly labels (e.g., site name, bin name/barcode).
  - Otherwise show IDs with copy-to-clipboard.
- No UI-side calculation of on-hand/ATP/availability. (DECISION-INVENTORY-004)

---

## 9. Service Contracts (Frontend Perspective)

> **Integration constraint:** UI calls Moqui proxy endpoints only. (DECISION-INVENTORY-002)  
> **Contract constraint:** plain JSON responses; deterministic error schema; cursor pagination for lists. (DECISION-INVENTORY-003)

### Load/view calls
1. **List replenishment tasks**
   - `GET /inventory/replenishment/tasks`
   - Query params (proposed; must match backend):
     - `status` (repeatable or comma-separated)
     - `pageSize`
     - `pageToken`
     - Optional filters: `productSku`, `taskId`, `locationId`
     - Optional `sort`
   - Response (proposed):
     ```json
     { "items": [ /* ReplenishmentTask summary */ ], "nextPageToken": "..." }
     ```
2. **Task detail**
   - `GET /inventory/replenishment/tasks/{taskId}`
   - Response: `ReplenishmentTask` detail (including source/destination IDs)
3. **Task history (optional)**
   - `GET /inventory/replenishment/tasks/{taskId}/history`
   - Response (proposed):
     ```json
     { "items": [ { "fromStatus":"", "toStatus":"", "changedAt":"", "changedBy":"" } ] }
     ```

4. **Location lookups (for labels/eligibility)**
   - Sites: `GET /inventory/locations` (LocationRef list) (DECISION-INVENTORY-008)
   - Storage locations by site: `GET /inventory/storage-locations?locationId=...` (DECISION-INVENTORY-007)
   - Note: these are inventory topology endpoints and may be permission-gated; UI must tolerate 403 and fall back to IDs.

### Create/update calls
- None (tasks are system-generated).

### Submit/transition calls
1. **Start task**
   - `POST /inventory/replenishment/tasks/{taskId}/start`
   - Response: updated task (status=IN_PROGRESS; may include `assignedTo`)
2. **Complete task (preferred atomic)**
   - `POST /inventory/replenishment/tasks/{taskId}/complete`
   - Body:
     ```json
     { "quantityMoved": 5, "completionNote": "..." }
     ```
   - Response (proposed):
     ```json
     { "task": { /* updated task */ }, "ledgerEntryId": "uuid" }
     ```
   - If backend cannot be atomic, this story is blocked pending contract decision (see Open Questions); UI should not implement a two-step transfer+complete without explicit compensation rules.

### Error handling expectations
- Deterministic error schema (example shape; must match inventory standard):
  - `code` (string), `message` (string), optional `fieldErrors` map, optional `correlationId`
- HTTP mapping:
  - 400/422 ‚Üí validation (fieldErrors when possible)
  - 401 ‚Üí login/session refresh (DECISION-INVENTORY-012)
  - 403 ‚Üí forbidden state (DECISION-INVENTORY-012)
  - 404 ‚Üí not found
  - 409 ‚Üí conflict (stale task / already claimed)
  - 5xx/timeout ‚Üí transient error with retry
- Always display `X-Correlation-Id` (from response header or error payload) in ‚ÄúTechnical details‚Äù section. (DECISION-INVENTORY-012)
- Do not log quantities or payloads to console/telemetry. (DECISION-INVENTORY-011)

---

## 10. State Model & Transitions

### Allowed states
- `PENDING`
- `IN_PROGRESS`
- `COMPLETED`
- `CANCELLED` (only if backend supports; not assumed)

### Role-based transitions (UI enforcement; backend authoritative)
- Warehouse Associate:
  - `PENDING ‚Üí IN_PROGRESS` (Start)
  - `IN_PROGRESS ‚Üí COMPLETED` (Complete)
- Inventory Manager:
  - View all tasks (assumed), but cancel/override is **not implemented unless confirmed**.

### UI behavior per state
- `PENDING`
  - Show Start button (if authorized)
  - Hide completion form
- `IN_PROGRESS`
  - Show completion form + Complete button (if authorized)
- `COMPLETED`
  - Read-only; show completion summary and ledger reference (if provided)
- `CANCELLED`
  - Read-only; show cancellation info (if provided)

---

## 11. Alternate / Error Flows

1. **Empty list**
   - Show ‚ÄúNo replenishment tasks found‚Äù with guidance to adjust filters.
2. **Concurrency conflict on Start/Complete (409)**
   - Show conflict banner + Refresh button.
   - On refresh, render current state; if now COMPLETED/CANCELLED, disable actions.
3. **Unauthorized (401/403)**
   - 401: redirect to login/session refresh. (DECISION-INVENTORY-012)
   - 403: show forbidden state; do not display sensitive task details if the detail call itself is forbidden. (DECISION-INVENTORY-012)
4. **Inactive/Pending location blocks movement**
   - If UI can detect location status from `LocationRef`, block Complete with inline message. (DECISION-INVENTORY-009)
   - If backend returns 422, show message and keep task in current state; allow user to back out.
5. **Validation failure (400/422)**
   - Map `quantityMoved` errors to the field; keep user input.
6. **Network failure / timeout**
   - After 8 seconds, show timeout state with Retry. (DECISION-INVENTORY-004)
   - Do not auto-retry mutations; user must click Retry.

---

## 12. Acceptance Criteria

```gherkin
Scenario: View open replenishment tasks (cursor pagination)
  Given I am an authenticated Warehouse Associate
  When I navigate to Inventory > Putaway/Replenishment > Replenishment Tasks
  Then the UI requests the first page of tasks using pageSize and no pageToken
  And the default status filter includes PENDING and IN_PROGRESS
  And I see a list of tasks
  And if the response includes nextPageToken, I can load more tasks using that token
  And the UI does not require or display a totalCount

Scenario: View replenishment task details
  Given a replenishment task exists with status PENDING
  When I open the task detail page
  Then I see the task‚Äôs productSku, quantity, source and destination location identifiers, and status
  And I see trigger metadata fields if provided
  And any JSON metadata is rendered safely (escaped and not logged)

Scenario: Start a replenishment task
  Given a replenishment task exists with status PENDING
  And I have permission to start replenishment tasks
  When I click "Start Task"
  Then the UI calls the Moqui proxy start endpoint for that task
  And the task status becomes IN_PROGRESS
  And the completion form is shown with quantityMoved defaulted to the task quantity

Scenario: Complete a replenishment task successfully (atomic completion)
  Given a replenishment task exists with status IN_PROGRESS
  And the task‚Äôs involved locations are ACTIVE (not INACTIVE or PENDING)
  When I enter quantityMoved equal to the task quantity
  And I click "Complete Task"
  Then the UI calls the Moqui proxy complete endpoint once
  And the system records an inventory transfer (ledger entry is created server-side)
  And the task status becomes COMPLETED
  And I see a success message
  And if a ledgerEntryId is returned, it is displayed on the success state

Scenario: Prevent completion with invalid quantity (client-side)
  Given a replenishment task exists with status IN_PROGRESS
  When I enter quantityMoved as 0 or a negative number
  And I click "Complete Task"
  Then I see a validation error on quantityMoved
  And no request to complete the task is submitted

Scenario: Block completion when quantity exceeds requested quantity
  Given a replenishment task exists with status IN_PROGRESS
  When I enter quantityMoved greater than the task quantity
  And I click "Complete Task"
  Then I see a validation error indicating the quantity cannot exceed the task quantity
  And no request to complete the task is submitted

Scenario: Handle permission error on start/complete
  Given a replenishment task exists with status PENDING or IN_PROGRESS
  When I attempt to Start or Complete the task without sufficient permission
  Then I receive a 403 response
  And the UI displays a forbidden state for the action
  And write actions are disabled for that task

Scenario: Handle concurrency conflict during completion
  Given a replenishment task exists with status IN_PROGRESS
  And another user completes the task before I submit
  When I click "Complete Task"
  Then I receive a 409 conflict response
  And the UI prompts me to refresh
  And after refresh the task status is shown as COMPLETED and actions are disabled

Scenario: Handle inactive or pending location blocking movement
  Given a replenishment task exists with status IN_PROGRESS
  And the source or destination LocationRef status is INACTIVE or PENDING
  When I attempt to complete the task
  Then the UI blocks completion or surfaces a deterministic 422 error from the backend
  And the UI explains that inventory movements are not allowed for inactive/pending locations
```

---

## 13. Audit & Observability

### User-visible audit data
- On task detail, show if provided:
  - `createdAt`
  - `assignedTo`
  - status history entries: `fromStatus`, `toStatus`, `changedAt`, `changedBy`
  - trigger/decision metadata (read-only)

### Status history
- Display chronological transitions when history endpoint exists.
- If history is not available, display current status and createdAt only.

### Traceability expectations
- All mutation requests include/propagate `X-Correlation-Id`; on errors, show correlation ID in UI technical details. (DECISION-INVENTORY-012)
- On successful completion, display:
  - `taskId`
  - `ledgerEntryId` (if returned)
- Client telemetry/logging must not include quantities or raw payload blobs. (DECISION-INVENTORY-011)

---

## 14. Non-Functional UI Requirements
- **Performance/UX timing:** show a loading indicator within 100ms; show a timeout state at 8 seconds with Retry; no auto-refresh loops. (DECISION-INVENTORY-004)
- **Accessibility:** keyboard navigable; buttons and fields labeled; status not conveyed by color alone.
- **Responsiveness:** usable on tablet widths; long IDs/SKUs truncate with copy affordance.
- **i18n/timezone:** timestamps rendered in user locale/timezone; IDs/SKUs not localized.
- **Security:** safe JSON rendering for any JSON fields; never persist payloads to localStorage. (DECISION-INVENTORY-015)

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide deterministic empty-state messaging for no tasks; safe UI ergonomics; impacts UX Summary, Alternate / Error Flows.
- SD-UX-PAGINATION: Default cursor-based pagination UI pattern (Load more) when `nextPageToken` is present; safe because it does not change domain logic; impacts UX Summary, Service Contracts, Acceptance Criteria.
- SD-ERR-HTTP-MAP: Standard mapping of 400/401/403/404/409/422/5xx to inline/banner/forbidden states; safe because it is presentation-layer only; impacts Business Rules, Alternate / Error Flows, Acceptance Criteria.
- SD-OBS-CORRELATION-ID: Display correlation ID in error technical details and propagate header when supported by client; safe observability boilerplate; impacts Service Contracts, Audit & Observability, Error Flows.

---

## 16. Open Questions
1. **Backend contract (blocking):** What are the exact Moqui proxy endpoints and request/response shapes for:
   - list tasks (filters + cursor pagination),
   - task detail,
   - start,
   - complete,
   - optional history?
2. **Atomic completion (blocking):** Is completion guaranteed to be a single atomic backend operation (transfer + task status update)? If not, what is the required two-step sequence and compensation behavior on partial failure?
3. **Permissions (blocking):** What are the canonical permission strings for:
   - viewing the task list/detail,
   - starting a task,
   - completing a task,
   - (optional) cancelling a task?
   (Inventory domain defines permission naming convention but does not provide replenishment-specific strings in the provided decisions.) (DECISION-INVENTORY-010)
4. **Assignment semantics (blocking):** When a task is started, is `assignedTo` set? If set, is completion restricted to the assignee, and what is the expected 409/403 behavior for non-assignees?
5. **Partial completion policy (blocking):** Are partial moves allowed (`quantityMoved < task.quantity`)? If yes, what is the resulting task behavior (remain IN_PROGRESS with remaining qty, revert to PENDING, split into a new task, or mark COMPLETED with shortfall recorded)?
6. **Location label resolution (non-blocking if IDs acceptable):** Should the UI resolve `locationId`/`storageLocationId` to human labels using `GET /inventory/locations` and `GET /inventory/storage-locations`, and are those endpoints permitted for warehouse associates? If not permitted, confirm that displaying raw IDs is acceptable for v1.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #93: [FRONTEND] [STORY] Fulfillment: Reserve/Allocate Stock to Workorder Lines
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] Fulfillment: View Inventory Availability & Ledger for a Work Order Line (Inventory-Authoritative; Deep-Linkable)

### Primary Persona
- **Parts Manager / Service Advisor** (human user) interacting in POS UI
- **Work Execution System** (system actor) as the source of workorder line context (IDs/SKU/required qty)

### Business Value
- Enable advisors and parts staff to quickly answer ‚Äúdo we have it and where did it go?‚Äù for a work order line using **inventory-authoritative** availability and movement history, without introducing reservation/allocation workflows that are not owned/defined in Inventory v1.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Parts Manager / Service Advisor,
- **I want** to open an inventory view from a work order line that shows current availability and recent inventory movements related to that line,
- **So that** I can make operational decisions (order parts, transfer, adjust, communicate ETA) with traceable, inventory-authoritative data.

### In-scope
- Moqui screens/forms to:
  - Display **Availability** for a `productSku` at a selected `locationId` and optional `storageLocationId` (bin), using inventory backend as authority. (DECISION-INVENTORY-004, DECISION-INVENTORY-016)
  - Display **Inventory Ledger** entries filtered by `workOrderLineId` (and optionally `workOrderId`) when present on ledger entries. (DECISION-INVENTORY-005)
  - Support **deep-linking** via canonical query params and auto-run once per load. (DECISION-INVENTORY-014)
  - Use **pickers** for `locationId` and `storageLocationId` (no free-text UUID entry). (DECISION-INVENTORY-001)
- Standard error handling and auth behavior:
  - 401 ‚Üí login/session refresh; 403 ‚Üí forbidden state with no data leakage; show correlation ID in technical details. (DECISION-INVENTORY-012)

### Out-of-scope
- Any **reservation/allocation** creation, promotion (SOFT/HARD), cancellation, or pick-task workflows (not defined as Inventory v1 contracts in provided rules).
- Any client-side computation of on-hand/ATP beyond display-only derived fields (e.g., backorder display from required vs ATP is display-only).
- Inventory ledger mutation (append-only; no edits/deletes). (DECISION-INVENTORY-005)
- Product master data management (names/UOM) beyond displaying SKU and any labels returned by inventory endpoints.

---

## 3. Actors & Stakeholders
- **Parts Manager / Service Advisor (primary UI user):** views availability and movement history for a work order line.
- **Technician (optional):** may view read-only availability/history.
- **Inventory System (SoR):** authoritative source for availability and ledger. (DECISION-INVENTORY-004, DECISION-INVENTORY-005)
- **Work Execution System (external SoR for work orders):** provides `workOrderId`, `workOrderLineId`, `productSku`, `requiredQty` context for deep-linking and display.

---

## 4. Preconditions & Dependencies
- WorkExec provides stable identifiers and SKU context:
  - `workOrderId` (optional)
  - `workOrderLineId` (required for ‚Äúline context‚Äù mode)
  - `productSku` (required to query availability)
  - `requiredQty` (optional; display-only)
- Inventory Moqui proxy endpoints exist and are same-origin:
  - `GET /inventory/availability` (DECISION-INVENTORY-002, DECISION-INVENTORY-004)
  - `GET /inventory/ledger` and `GET /inventory/ledger/{ledgerEntryId}` (DECISION-INVENTORY-003, DECISION-INVENTORY-005)
  - `GET /inventory/locations` and `GET /inventory/storage-locations?locationId=...` for pickers (DECISION-INVENTORY-007, DECISION-INVENTORY-001)
- Permission discovery mechanism exists per app convention to gate read-only screens/actions (exact permission strings are an open question for availability/ledger view).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Work Order detail** (WorkExec area) ‚Üí per-line action ‚ÄúInventory‚Äù (or ‚ÄúAvailability & History‚Äù) that deep-links into Inventory screen with:
  - `productSku`
  - `workOrderId` (optional)
  - `workOrderLineId`
  - `locationId` (if WorkExec has a current shop/site context; otherwise user selects)
- From **Inventory** module menu ‚Üí ‚ÄúAvailability‚Äù and ‚ÄúLedger‚Äù screens remain accessible independently (if already present); this story adds a **Work Order Line context** entry.

### Screens to create/modify
1. **WorkExec Work Order detail/line component (existing)**
   - Add link/action to Inventory screen with query params (DECISION-INVENTORY-014).
2. **Inventory Availability screen (create or extend)**
   - Screen ID suggestion: `Inventory/Availability.xml`
   - Must support deep-link params and pickers.
3. **Inventory Ledger list/detail screens (create or extend)**
   - Screen ID suggestion: `Inventory/Ledger/List.xml` and `Inventory/Ledger/Detail.xml`
   - Must support filtering by `workOrderLineId` and cursor pagination.

### Navigation context
- Breadcrumb: Work Order ‚Üí Line ‚Üí Inventory (Availability & History)
- Provide ‚ÄúBack to Work Order‚Äù navigation preserving `workOrderId` and `workOrderLineId`.

### User workflows (happy + alternate)

**Happy path: open from work order line and view availability**
1. User clicks ‚ÄúInventory‚Äù on a work order line.
2. Inventory screen loads with `productSku` and `workOrderLineId` prefilled; `locationId` prefilled if provided, otherwise required selection.
3. If required params present (`productSku`, `locationId`), availability auto-runs once and renders results. (DECISION-INVENTORY-014)
4. User optionally selects a `storageLocationId` (bin) to scope availability.

**Happy path: view movement history for the line**
1. User switches to ‚ÄúHistory‚Äù (ledger) tab/section.
2. UI queries ledger filtered by `workOrderLineId` (and optionally `locationId` if user selected a site filter).
3. User opens a ledger entry detail.

**Alternate: no inventory history**
- Availability returns success with zeros; UI shows ‚ÄúNo inventory history for this item/location yet‚Äù (not an error). (DECISION-INVENTORY-004)

**Alternate: location is INACTIVE/PENDING**
- Location picker excludes INACTIVE/PENDING for operational selection by default; if user arrives via deep-link to an inactive location, show read-only banner and block movement actions (none in this story) while still allowing historical viewing. (DECISION-INVENTORY-009)

---

## 6. Functional Behavior

### Triggers
- Screen load:
  - Parse query params: `productSku`, `locationId`, `storageLocationId`, `workOrderId`, `workOrderLineId`. (DECISION-INVENTORY-014)
  - Load picker data as needed (locations; storage locations after location selection).
  - Auto-run availability once per load when `productSku` and `locationId` are present. (DECISION-INVENTORY-014)
- User actions:
  - Select location (picker)
  - Select storage location (picker filtered by location)
  - Click ‚ÄúCheck Availability‚Äù (manual run)
  - Open ‚ÄúHistory‚Äù and paginate ledger
  - Open ledger entry detail
  - Refresh (re-run current query)

### UI actions
- **LocationRef picker**:
  - Backed by `GET /inventory/locations`.
  - Exclude `INACTIVE` and `PENDING` by default; optional ‚ÄúInclude inactive‚Äù toggle only for historical viewing contexts (safe default is OFF). (DECISION-INVENTORY-009)
- **StorageLocation picker**:
  - Backed by `GET /inventory/storage-locations?locationId=...`.
  - Must be disabled until `locationId` selected.
  - Must prevent selecting a storage location not belonging to selected `locationId`. (DECISION-INVENTORY-001)
- **Availability query**:
  - Calls Moqui proxy `GET /inventory/availability` with `productSku`, `locationId`, optional `storageLocationId`. (DECISION-INVENTORY-002, DECISION-INVENTORY-004)
  - Displays backend-returned quantities; frontend does not compute on-hand/ATP. (DECISION-INVENTORY-004)
- **Ledger list**:
  - Calls `GET /inventory/ledger` with cursor pagination (`pageSize`, `pageToken`) and filters:
    - `workOrderLineId` (primary in this story)
    - optional `locationId` (note: location filter semantics are OR across from/to; see Business Rules) (DECISION-INVENTORY-005)
- **Ledger detail**:
  - Calls `GET /inventory/ledger/{ledgerEntryId}`.

### State changes
- Read-only screens; no inventory mutations.
- UI state transitions: `idle ‚Üí loading ‚Üí success | empty | error`.
- Cursor pagination state: `pageToken`, `nextPageToken`, `isLoadingMore`.

### Service interactions (Moqui)
- All calls go through Moqui proxy endpoints; Vue does not call inventory backend directly. (DECISION-INVENTORY-002)
- Moqui screens use transitions/actions to invoke REST calls and bind results to screen context.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `productSku`:
  - Trim whitespace; must be non-empty to run availability.
- `locationId`:
  - Required to run availability.
- `storageLocationId`:
  - Optional; if provided, must belong to selected `locationId` (enforced by picker; still handle backend validation errors). (DECISION-INVENTORY-001)
- Ledger filters:
  - `workOrderLineId` must be non-empty to run ‚Äúline context‚Äù history.
  - If date range filters are present in UI (optional), enforce `from <= to`.

### Enable/disable rules
- ‚ÄúCheck Availability‚Äù enabled only when `productSku` and `locationId` are present and valid.
- Storage location picker enabled only when `locationId` selected.
- ‚ÄúLoad more‚Äù enabled only when `nextPageToken` present and not currently loading.

### Visibility rules
- Availability results:
  - If backend returns zeros with success, show empty-state copy (not an error). (DECISION-INVENTORY-004)
- Ledger list:
  - Show a helper note when `locationId` filter is applied: ‚ÄúLocation filter matches entries where From OR To equals this location.‚Äù (DECISION-INVENTORY-005)
- Technical details panel on errors:
  - Show correlation ID if present. (DECISION-INVENTORY-012)

### Error messaging expectations
- Use deterministic error schema parsing; map field errors to inputs when possible. (DECISION-INVENTORY-003)
- Auth:
  - 401 ‚Üí redirect to login/session refresh per app convention. (DECISION-INVENTORY-012)
  - 403 ‚Üí forbidden state; do not render partial data. (DECISION-INVENTORY-012)
- Do not log quantities or raw payloads to console/telemetry. (DECISION-INVENTORY-011)

---

## 8. Data Requirements

### Entities involved
- **LocationRef** (picker + display) (DECISION-INVENTORY-001, DECISION-INVENTORY-008)
- **StorageLocation** (picker + display) (DECISION-INVENTORY-007)
- **AvailabilityView** (read-only response) (DECISION-INVENTORY-004)
- **InventoryLedgerEntry** (list + detail; immutable) (DECISION-INVENTORY-005)

### Fields (type, required, defaults)

**Route/query params (inputs)**
- `productSku` (string, optional on entry; required to query availability)
- `locationId` (UUID string, optional on entry; required to query availability)
- `storageLocationId` (UUID string, optional)
- `workOrderId` (string/UUID, optional; navigation only)
- `workOrderLineId` (string/UUID, optional for generic screens; required for ‚Äúline context‚Äù history)

**LocationRef (picker row)**
- `locationId` (UUIDv7 string, required)
- `name` (string, required for display)
- `status` (`ACTIVE`|`INACTIVE`|`PENDING`, required) (DECISION-INVENTORY-009)

**StorageLocation (picker row)**
- `storageLocationId` (UUIDv7 string, required)
- `locationId` (UUIDv7 string, required)
- `name` (string, required)
- `barcode` (string, optional)
- `status` (`ACTIVE`|`INACTIVE`, required)

**AvailabilityView (response; exact shape TBD by backend, but UI must support at least)**
- `productSku` (string, required)
- `locationId` (string, required)
- `storageLocationId` (string, optional)
- Quantity fields (numbers, optional but expected):
  - `onHandQty`
  - `allocatedQty`
  - `availableToPromiseQty` (ATP)
- Optional metadata:
  - `asOf` (timestamp)
  - `uom` (string)
  - `notes` (string)

**InventoryLedgerEntry (list row; exact shape TBD, but UI must support at least)**
- `ledgerEntryId` (string/UUID, required)
- `timestamp` (timestamp, required)
- `productSku` (string, required)
- `quantityChange` (number, required)
- `fromLocationId` / `toLocationId` (string, optional)
- `fromStorageLocationId` / `toStorageLocationId` (string, optional)
- Linkage fields (optional but important for this story):
  - `workOrderId` (string)
  - `workOrderLineId` (string)
  - `sourceTransactionId` (string) (DECISION-INVENTORY-005)

### Read-only vs editable by state/role
- All fields are read-only in this story.
- Pickers are selectable; no entity edits.

### Derived/calculated fields
- Display-only:
  - `shortageQty = max(requiredQty - availableToPromiseQty, 0)` if `requiredQty` is provided by WorkExec; do not use for decisions or logging.

---

## 9. Service Contracts (Frontend Perspective)

> All endpoints are Moqui proxy endpoints; responses are plain JSON (no `{data: ...}` envelope). (DECISION-INVENTORY-002, DECISION-INVENTORY-003)

### Load/view calls

1. **Locations (picker)**
- `GET /inventory/locations`
- Query params (optional): `status=ACTIVE` (if supported), otherwise filter client-side for picker display only.
- Response: list of `LocationRef` rows.

2. **Storage locations (picker)**
- `GET /inventory/storage-locations?locationId={locationId}`
- Response: list of `StorageLocation` rows for the site.

3. **Availability**
- `GET /inventory/availability?productSku={productSku}&locationId={locationId}&storageLocationId={storageLocationId?}`
- Response: plain JSON `AvailabilityView`
- ‚ÄúNo history‚Äù returns success with zeros (not 404). (DECISION-INVENTORY-004)

4. **Ledger list**
- `GET /inventory/ledger`
- Query params (all optional unless noted):
  - `workOrderLineId` (primary for this story; required in line-context mode)
  - `workOrderId` (optional)
  - `productSku` (optional)
  - `locationId` (optional; matches from OR to) (DECISION-INVENTORY-005)
  - `pageSize` (number)
  - `pageToken` (string)
  - `sort` (string; optional)
- Response:
  - `items: InventoryLedgerEntry[]`
  - `nextPageToken: string|null` (DECISION-INVENTORY-003)

5. **Ledger detail**
- `GET /inventory/ledger/{ledgerEntryId}`
- Response: `InventoryLedgerEntry` (full detail)

### Create/update calls
- none (read-only story)

### Submit/transition calls
- none (read-only story)

### Error handling expectations
- Deterministic error schema (DECISION-INVENTORY-003):
  - Parse `code`, `message`, optional `errors[]` with field-level mapping.
- HTTP handling:
  - 401: redirect to login/session refresh (DECISION-INVENTORY-012)
  - 403: show forbidden state; do not render cached sensitive results (DECISION-INVENTORY-012)
  - 404:
    - For ledger detail: show ‚ÄúEntry not found‚Äù with correlation ID.
    - For availability: should not be used for ‚Äúno history‚Äù; treat 404 as unexpected and show error. (DECISION-INVENTORY-004)
  - 422: show validation message (e.g., invalid location/bin relationship).
  - Timeout: at 8 seconds show timeout state with Retry. (DECISION-INVENTORY-004)

---

## 10. State Model & Transitions

### Allowed states
- Screen state:
  - `IDLE`
  - `LOADING`
  - `SUCCESS`
  - `EMPTY` (success-with-zeros for availability; empty list for ledger)
  - `ERROR`
  - `FORBIDDEN` (403)
- LocationRef status (for selection rules):
  - `ACTIVE`, `INACTIVE`, `PENDING` (DECISION-INVENTORY-009)

### Role-based transitions
- Read-only viewing requires view permissions (exact strings TBD; see Open Questions).
- No mutation transitions in this story.

### UI behavior per state
- `FORBIDDEN`: show forbidden panel; hide results; show correlation ID if present.
- `EMPTY`:
  - Availability: show ‚ÄúNo inventory history for this SKU at this location yet.‚Äù
  - Ledger: show ‚ÄúNo movements found for this work order line.‚Äù

---

## 11. Alternate / Error Flows

### Validation failures
- Missing `productSku` or `locationId`:
  - Do not call availability; show inline guidance.
- `storageLocationId` selected but does not belong to `locationId` (should be prevented by picker):
  - If backend returns 422, clear storage selection and show message: ‚ÄúSelected bin is not in the selected site.‚Äù

### Concurrency conflicts
- Not applicable (read-only). If ledger pagination token becomes invalid (backend 400/409), show message and offer ‚ÄúRefresh list‚Äù.

### Unauthorized access
- 401: redirect to login/session refresh.
- 403: forbidden state; do not show partial data; keep navigation back to Work Order available.

### Empty states
- Availability success-with-zeros is treated as empty state (DECISION-INVENTORY-004).
- Ledger list empty is a normal empty state.

---

## 12. Acceptance Criteria

### Scenario 1: Deep-link auto-runs availability once when required params present
**Given** the user opens the Inventory Availability screen with query params `productSku=SKU-1` and `locationId=LOC-1`  
**When** the screen loads  
**Then** the UI auto-runs exactly one availability request to `GET /inventory/availability` with `productSku=SKU-1` and `locationId=LOC-1`  
**And** the UI does not re-run automatically unless the user changes inputs or clicks ‚ÄúCheck Availability‚Äù. (DECISION-INVENTORY-014)

### Scenario 2: Location and storage location are selected via pickers (no free-text UUID)
**Given** the user is on the Availability screen  
**When** the user selects a site  
**Then** the site is chosen from a LocationRef picker backed by `GET /inventory/locations`  
**And** the storage location picker is disabled until a site is selected  
**And** the storage location picker only shows bins from `GET /inventory/storage-locations?locationId={selectedLocationId}`. (DECISION-INVENTORY-001, DECISION-INVENTORY-007)

### Scenario 3: Availability ‚Äúno history‚Äù returns success-with-zeros and renders empty state
**Given** the user queries availability for `productSku=SKU-2` at `locationId=LOC-2`  
**When** the backend returns success with quantity fields equal to zero  
**Then** the UI renders a ‚ÄúNo inventory history for this item/location yet‚Äù empty state  
**And** the UI does not show an error toast for this response. (DECISION-INVENTORY-004)

### Scenario 4: Ledger list filters by workOrderLineId and paginates with cursor tokens
**Given** the user opens the History section with `workOrderLineId=WOL-1`  
**When** the UI loads the ledger list  
**Then** it calls `GET /inventory/ledger` with `workOrderLineId=WOL-1` and `pageSize`  
**And** when the user clicks ‚ÄúLoad more‚Äù and `nextPageToken` is present, the UI calls `GET /inventory/ledger` with `pageToken={nextPageToken}`  
**And** the UI does not require or display a total count. (DECISION-INVENTORY-003)

### Scenario 5: Ledger location filter semantics are disclosed
**Given** the user applies a `locationId` filter on the ledger list  
**When** results are shown  
**Then** the UI displays helper text stating the filter matches entries where `fromLocationId == locationId OR toLocationId == locationId`. (DECISION-INVENTORY-005)

### Scenario 6: Auth handling for 401 and 403
**Given** the user is not authenticated  
**When** any inventory endpoint returns 401  
**Then** the UI redirects to login/session refresh per app convention. (DECISION-INVENTORY-012)

**Given** the user lacks permission to view ledger  
**When** `GET /inventory/ledger` returns 403  
**Then** the UI shows a forbidden state without rendering any ledger data  
**And** shows the `X-Correlation-Id` in technical details if present. (DECISION-INVENTORY-012)

### Scenario 7: Sensitive data is not logged
**Given** the UI receives an availability response containing numeric quantities  
**When** the UI renders the results  
**Then** the UI does not log numeric quantities to console or client telemetry. (DECISION-INVENTORY-011)

---

## 13. Audit & Observability

### User-visible audit data
- Availability:
  - Display `asOf` timestamp if provided.
- Ledger:
  - Display immutable entry timestamps and linkage fields (`sourceTransactionId`, `workOrderLineId`) when present. (DECISION-INVENTORY-005)

### Status history
- Not applicable (no state machine in UI; ledger is the history). (DECISION-INVENTORY-005)

### Traceability expectations
- Include/propagate `X-Correlation-Id` on requests; surface it in error technical details. (DECISION-INVENTORY-012)
- Do not emit sensitive payloads/quantities in logs. (DECISION-INVENTORY-011)

---

## 14. Non-Functional UI Requirements

- **Performance:** show loading indicator within 100ms; show timeout at 8 seconds with Retry; no auto-refresh loops. (DECISION-INVENTORY-004)
- **Accessibility:** keyboard navigable pickers/tabs; status and empty states announced; no color-only meaning.
- **Responsiveness:** usable on tablet; tables support horizontal scroll.
- **i18n/timezone:** timestamps rendered in user locale/timezone per app defaults.
- **Security:** do not persist raw JSON payloads to `localStorage`; safe rendering for any JSON fields if present in responses. (DECISION-INVENTORY-015)

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit empty states for availability (success-with-zeros) and ledger (no items). Safe as UX ergonomics; does not change domain behavior. Impacted sections: UX Summary, Error Flows, Acceptance Criteria.
- SD-UX-PAGINATION-CURSOR: Use ‚ÄúLoad more‚Äù with `nextPageToken` and no total count. Safe as standard list ergonomics aligned to domain contract. Impacted sections: Functional Behavior, Service Contracts, Acceptance Criteria.
- SD-ERR-STD-MAPPING: Standard mapping for 401/403/404/422/5xx and timeout retry without inventing business policy. Safe as generic error handling. Impacted sections: Business Rules, Service Contracts, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Story scope confirmation (blocking):** The original issue describes ‚ÄúReserve/Allocate SOFT/HARD + Promote/Cancel‚Äù, but Inventory domain rules provided here only define availability/ledger/adjustments/topology/feedops contracts. Is reservation/allocation a separate domain/service with defined endpoints, or should this issue be split and the reservation workflow moved to the owning domain?  
2. **Permissions (blocking):** What are the exact permission strings to view:
   - availability screen
   - ledger list/detail  
   (Inventory domain provides permission naming conventions but not these specific strings in the provided decisions.)
3. **Ledger filter contract (blocking):** Does `GET /inventory/ledger` support `workOrderLineId` and/or `workOrderId` as query parameters in the Moqui proxy contract? If not, what is the supported linkage filter (e.g., `sourceTransactionId` only)? (DECISION-INVENTORY-005 mentions fields exist; query support is not explicitly specified.)
4. **Availability response shape (non-blocking if UI is schema-flexible):** Confirm the exact field names for quantity outputs (`onHandQty`, `allocatedQty`, `availableToPromiseQty`) and whether `asOf`/`uom` are present, so UI bindings and tests match the contract.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #92: [FRONTEND] [STORY] Fulfillment: Create Pick List / Pick Tasks for Workorder
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Fulfillment: View & Print Pick List / Pick Tasks for Workorder (Generated on Reservation Confirmation)

### Primary Persona
Dispatcher (primary); Mechanic (secondary consumer on mobile)

### Business Value
Provide a deterministic, actionable pick list for a work order so shop staff can pull correct parts quickly, reduce picking errors, and improve on-time job starts.

---

## 2. Story Intent

### As a / I want / So that
**As a** Dispatcher,  
**I want** to view a generated pick list (pick tasks) for a work order, ordered by storage layout, with a printable and mobile-friendly view,  
**so that** Mechanics know what to pull and when, without manual coordination.

### In-scope
- Frontend screens to:
  - Locate and open the pick list associated with a work order
  - Display pick tasks (product, qty, suggested storage location, priority, due time, status)
  - Show list status (Draft/ReadyToPick/‚Ä¶)
  - Print-friendly rendering and mobile-friendly rendering
- Frontend calls to **Moqui proxy** services to load pick list + tasks (no direct Vue ‚Üí backend calls) (DECISION-INVENTORY-002)
- Empty/needs-review handling for tasks without actionable locations
- Deterministic ordering as provided by backend (frontend does not compute route optimization)

### Out-of-scope
- Generating pick lists purely in the frontend (must be backend/inventory domain)
- Route optimization beyond deterministic sort keys
- Picking execution flows (mark picked, partial picks, substitutions), unless explicitly provided by backend contract
- Inventory allocation/reservation logic (frontend treats inventory availability/allocations as backend-authoritative when displayed elsewhere) (DECISION-INVENTORY-016)

---

## 3. Actors & Stakeholders
- **Dispatcher:** initiates/monitors fulfillment readiness; prints pick list.
- **Mechanic:** consumes pick tasks on a mobile device; may print if needed.
- **Inventory Domain (backend):** system of record for pick list/task generation, ordering, and suggested locations.
- **Work Execution Domain (backend):** system of record for work order context (priority, scheduled start, due time).
- **Shop Manager (optional stakeholder):** operational oversight.

---

## 4. Preconditions & Dependencies
1. A **Work Order** exists (`workOrderId` known).
2. Parts reservation has been **confirmed** (trigger for backend generation; generation itself is out-of-scope for frontend unless an explicit endpoint exists).
3. Backend provides an API (via Moqui proxy) to retrieve the pick list and tasks for a work order (**contract is currently undefined in provided inventory rules; blocking**).
4. AuthN is working via existing Moqui/POS session; UI follows 401/403 behavior conventions (DECISION-INVENTORY-012).
5. AuthZ rules for viewing/printing pick lists are defined (**permissions currently undefined; blocking**).
6. If storage locations are shown, they must follow canonical `locationId` (site) and `storageLocationId` (bin) model; pickers must be used where selection is required (DECISION-INVENTORY-001). (This story is view-only; selection is only relevant if a ‚Äúfilter by location/bin‚Äù is added later.)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a Work Order screen: ‚ÄúPick List‚Äù action/tab (preferred).
- Direct route by work order: `/fulfillment/workorders/:workOrderId/pick-list`
- Direct route by pick list id (optional if backend supports): `/fulfillment/pick-lists/:pickListId`

### Screens to create/modify (Moqui)
Create/modify Moqui screens (names indicative; align to repo conventions):
1. **WorkOrderDetail** (existing, WorkExec area): add navigation link/button ‚ÄúPick List‚Äù
2. **PickListView** (new): view pick list header + tasks list
3. **PickListPrint** (new): print-optimized screen/view (minimal chrome)
4. **PickListMobile** (optional): may be the same screen with responsive behavior; do not fork unless necessary

### Navigation context
- Breadcrumb: Work Orders ‚Üí Work Order {id or reference} ‚Üí Pick List
- Keep workOrder context visible (work order reference, priority, scheduledStart/dueAt if provided by backend)

### User workflows (happy + alternate paths)

**Happy path (view + print)**
1. Dispatcher opens Work Order.
2. Clicks ‚ÄúPick List‚Äù.
3. System loads pick list for `workOrderId`.
4. If pick list exists and status indicates it is actionable (e.g., `ReadyToPick`), show tasks in backend-provided deterministic order.
5. Dispatcher clicks ‚ÄúPrint‚Äù to open print view and prints.

**Alternate path: pick list not yet created**
- If backend indicates ‚Äúnot found / not generated yet‚Äù, UI shows ‚ÄúPick list not available yet‚Äù and a refresh action.
- No ‚ÄúGenerate/Rebuild‚Äù button is shown unless an explicit backend endpoint + permission is defined (blocked).

**Alternate path: Draft / NeedsReview**
- If pick list status is `Draft` and tasks include `NeedsReview`, show callout listing issues and highlight those tasks.
- Printing behavior for Draft is policy-dependent (blocked).

**Alternate path: mobile consumption**
- Mechanic opens same route on mobile; tasks render in a stacked/condensed format; print action may still be available if permitted.

---

## 6. Functional Behavior

### Triggers
- Route navigation to PickListView with `workOrderId` (required).
- User-initiated refresh.
- User selects Print view.

### UI actions
- **Load pick list** on screen entry.
- **Refresh**: re-fetch pick list and tasks.
- **Print**: open print route/view. Print view must enforce authz independently (no ‚Äúprint from cached data‚Äù if the print route is accessed directly).
- **Client-side find/filter** within already-loaded tasks is allowed as UI ergonomics only; it must not change backend ordering or imply route optimization.

### State changes (frontend-local)
- Loading states: `idle ‚Üí loading ‚Üí loaded | error | empty`
- No domain state changes in this story (view/print only).

### Service interactions
- Call Moqui proxy to:
  - fetch pick list by `workOrderId` (primary)
  - fetch tasks for pick list (if not embedded)
  - optionally fetch work order summary (if needed for header and not included)

**Decision rationale applied**
- All calls must go through Moqui proxy (DECISION-INVENTORY-002).
- Error handling must surface correlation ID and follow 401/403 conventions (DECISION-INVENTORY-012).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `workOrderId` must be present in route params; otherwise show a 400-style page message ‚ÄúMissing work order id‚Äù and do not call backend.
- If a task quantity is non-positive (should not happen), display ‚ÄúInvalid quantity‚Äù and flag row as error (display-only; do not correct).
- If timestamps are present, render them as timestamps; do not attempt to infer missing due times.

### Enable/disable rules
- ‚ÄúPrint‚Äù enabled only when pick list is loaded successfully.
- Printing when pick list is `Draft` is **blocked pending policy**:
  - If allowed: show warning banner ‚ÄúDraft pick list‚Äîmay be incomplete‚Äù and require a confirm step before opening print view.
  - If disallowed: disable Print and show tooltip/help text ‚ÄúPrinting is available when the pick list is Ready to Pick.‚Äù

### Visibility rules
- If any task `status = NeedsReview`, show a top-level warning summary and visually mark those tasks.
- If no tasks: show empty state ‚ÄúNo pick tasks available yet.‚Äù
- If backend provides storage location identifiers, display them as read-only fields; do not allow user edits.

### Error messaging expectations
- 401: redirect to login/session refresh per app convention (DECISION-INVENTORY-012)
- 403: show ‚ÄúYou don‚Äôt have access to view pick lists for this work order.‚Äù Do not render partial data.
- 404 (no pick list): show empty state ‚ÄúPick list not generated yet.‚Äù
- 409: show ‚ÄúPick list changed; refresh to see latest.‚Äù
- 422: show validation-style message (e.g., ‚ÄúPick list cannot be displayed due to missing required data‚Äù) and include correlation ID in technical details.
- 5xx/network: show retryable error with ‚ÄúRetry‚Äù action; show timeout state at 8 seconds with retry (DECISION-INVENTORY-004 UX target)

---

## 8. Data Requirements

### Entities involved (frontend perspective; SoR is backend)
- `PickList` (inventory-owned)
- `PickTask` (inventory-owned)
- `StorageLocation` (inventory-owned bin; may be embedded on task)
- `LocationRef` (inventory read model of HR location; may be embedded for display)
- `WorkOrder` summary (workexec-owned; optional display context)

### Fields (type, required, defaults)

**PickList (required to render header)**
- `pickListId` (UUIDv7 or UUID; required)
- `workOrderId` (UUID; required)
- `status` (string enum; required)
- `createdAt` (timestamp; required for display)
- Optional display context (if provided by inventory response or separate call):
  - `workOrderReference` (string)
  - `workOrderPriority` (number)
  - `scheduledStartAt` (timestamp)
  - `dueAt` (timestamp)

**PickTask (required per row/item)**
- `pickTaskId` (UUID; required)
- `pickListId` (UUID; required)
- `productSku` (string; **preferred identifier for display and deep-linking patterns in inventory**) (DECISION-INVENTORY-014)
- `productDisplayName` (string; strongly preferred for UI; otherwise requires Product lookup which is out-of-scope and would create cross-domain dependency)
- `quantityRequired` (number/decimal; required)
- `uom` (string; required if fractional quantities exist; otherwise optional)
- Suggested pick location (read-only):
  - `locationId` (UUID; site) (DECISION-INVENTORY-001)
  - `storageLocationId` (UUID; bin; nullable if NeedsReview) (DECISION-INVENTORY-001)
  - `storageLocationCode` (string; nullable)
- `priority` (number; optional unless backend guarantees it)
- `dueAt` (timestamp; optional unless backend guarantees it)
- Deterministic ordering:
  - `sortOrder` (number; required **or** backend must return tasks already ordered deterministically)

**Layout / grouping fields**
- Frontend must not invent layout ordering rules. If backend does not provide `sortOrder` or pre-sorted tasks, the story is blocked because ‚Äúordered by storage layout‚Äù cannot be implemented deterministically without a contract.

### Read-only vs editable by state/role
- All fields are **read-only** in this story (view/print only), regardless of pick list/task status.

### Derived/calculated fields
- ‚ÄúOverdue‚Äù indicator: only if `dueAt` is present and task status is not terminal (terminal statuses are currently undefined; if unknown, do not compute overdue).
- Group headers (e.g., by `locationId` or `storageLocationCode`) are optional UI ergonomics; must not change ordering.

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking:** Inventory domain rules provided do not define pick list endpoints. This story requires explicit Moqui proxy endpoints and response shapes to be buildable.

### Load/view calls (required)

1. **Get pick list by work order (Moqui proxy)**
   - Method/Path: **TBD** (must be same-origin Moqui proxy; plain JSON) (DECISION-INVENTORY-002, DECISION-INVENTORY-003)
   - Inputs: `workOrderId` (path or query)
   - Response (plain JSON): `PickList` including either:
     - `tasks: PickTask[]` embedded, **or**
     - a `pickListId` to fetch tasks separately
   - Error handling:
     - 401/403/404/409/422/5xx per deterministic error schema (DECISION-INVENTORY-003, DECISION-INVENTORY-012)
   - Observability:
     - include/echo `X-Correlation-Id` (DECISION-INVENTORY-012)

2. **(If tasks not embedded) Get pick tasks for pick list (Moqui proxy)**
   - Method/Path: **TBD**
   - Inputs: `pickListId`
   - Response: `PickTask[]` in deterministic order **or** include `sortOrder` field
   - Pagination: If tasks can be large, contract must specify cursor pagination (`pageSize`, `pageToken`, `nextPageToken`) (DECISION-INVENTORY-003). If tasks are always bounded, backend may return full list; must be stated.

3. **(Optional) Work order summary (Moqui proxy)**
   - Method/Path: **TBD** (workexec-owned; would be a separate proxy namespace)
   - Only required if pick list response does not include display context fields.

### Create/update calls
- None in this story.

### Submit/transition calls
- None in this story unless a manual ‚Äúgenerate/rebuild pick list‚Äù endpoint is explicitly provided (blocked).

### Error handling expectations
- Responses are plain JSON (no `{data: ...}` envelope) (DECISION-INVENTORY-003).
- Deterministic error schema must support:
  - a user-safe message
  - optional field errors (not expected for view-only, but must not crash)
  - correlation ID surfaced in UI technical details (DECISION-INVENTORY-012)
- Client telemetry/logging must not log sensitive quantities if they appear in payloads (treat quantities as sensitive-by-default per inventory guidance) (DECISION-INVENTORY-011)

---

## 10. State Model & Transitions

### Allowed states
**PickList.status** (backend-defined; UI must be forward-compatible)
- Known examples (not authoritative): `Draft`, `ReadyToPick`, `InProgress`
- UI must render unknown statuses as a neutral badge (string)

**PickTask.status** (backend-defined; UI must be forward-compatible)
- Known examples (not authoritative): `Pending`, `NeedsReview`, `Picked`
- UI must render unknown statuses as a neutral badge (string)

### Role-based transitions
- None implemented in this story (view/print only).
- UI must not expose ‚Äúmark picked‚Äù or ‚Äústart picking‚Äù actions unless a separate story defines transitions and permissions.

### UI behavior per state
- `Draft`: show banner ‚ÄúDraft: some tasks may require review‚Äù; highlight NeedsReview tasks.
- `ReadyToPick`: normal display; emphasize due times/priority if present.
- Unknown: display as text badge without special behavior.

---

## 11. Alternate / Error Flows

1. **Pick list not found (not generated yet)**
   - Backend returns 404 (or equivalent deterministic error code).
   - UI shows empty state:
     - ‚ÄúPick list is created when reservation is confirmed.‚Äù
     - Actions: Refresh; Back to Work Order
   - No manual generate action unless contract + permission exists (blocked).

2. **Tasks include NeedsReview**
   - Show warning summary.
   - For each NeedsReview task:
     - show missing actionable information (e.g., ‚ÄúNo suggested storage location‚Äù)
     - keep row printable (unless printing Draft is disallowed; blocked).

3. **Concurrency / stale data**
   - If backend returns 409:
     - Show ‚ÄúPick list updated; refresh‚Äù
     - Provide refresh action

4. **Unauthorized**
   - 401: redirect to login/session refresh (DECISION-INVENTORY-012)
   - 403: show forbidden state; do not reveal pick list/task details (DECISION-INVENTORY-012)
   - Print route must enforce the same checks (no cached rendering if unauthorized)

5. **Timeout / network / server errors**
   - Show loading indicator within 100ms.
   - At 8 seconds without response, show timeout state with Retry (DECISION-INVENTORY-004 UX target).
   - Do not auto-refresh in a loop.

---

## 12. Acceptance Criteria

### Scenario 1: View pick list for a work order (success)
**Given** I am authenticated as a Dispatcher with permission to view pick lists  
**And** a work order `{workOrderId}` has an associated pick list  
**When** I navigate to `/fulfillment/workorders/{workOrderId}/pick-list`  
**Then** the system calls the Moqui proxy endpoint to load the pick list for `{workOrderId}`  
**And** the system displays the pick list header including `pickListId`, `status`, and `createdAt`  
**And** the system displays all returned pick tasks including product identifier/display name, quantity, suggested storage location (if present), and task status  
**And** tasks are presented in the backend-provided deterministic order (either already ordered or by `sortOrder`)

### Scenario 2: Pick list not generated yet (404 empty state)
**Given** I am authenticated as a Dispatcher with permission to view pick lists  
**And** `{workOrderId}` has no pick list generated yet  
**When** I open `/fulfillment/workorders/{workOrderId}/pick-list`  
**Then** the system shows an empty state indicating the pick list is not available yet  
**And** the empty state includes a ‚ÄúRefresh‚Äù action  
**When** I click ‚ÄúRefresh‚Äù  
**Then** the system retries the Moqui proxy load call

### Scenario 3: NeedsReview tasks are highlighted
**Given** I am authenticated as a Dispatcher with permission to view pick lists  
**And** the pick list for `{workOrderId}` contains at least one task with `status = NeedsReview`  
**When** I view the pick list  
**Then** I see a warning banner indicating some tasks need review  
**And** each `NeedsReview` task is visually distinguished  
**And** each `NeedsReview` task shows that it is missing actionable pick location information when `storageLocationId`/`storageLocationCode` is absent

### Scenario 4: Print view renders pick list content (authorized)
**Given** I have successfully loaded a pick list for `{workOrderId}`  
**When** I click ‚ÄúPrint‚Äù  
**Then** the system navigates to the print route/view  
**And** the print view loads (or reuses) the same pick list data and renders the same header and tasks in the same deterministic order  
**And** the print view does not include application navigation chrome

### Scenario 5: Unauthorized access is blocked (403)
**Given** I am authenticated without permission to view pick lists for `{workOrderId}`  
**When** I navigate to `/fulfillment/workorders/{workOrderId}/pick-list`  
**Then** the system shows an access denied message  
**And** no pick list/task data is rendered  
**And** the print route/view also shows access denied when accessed directly

### Scenario 6: Timeout shows retry (8 seconds)
**Given** I am authenticated as a Dispatcher with permission to view pick lists  
**And** the pick list load call does not return within 8 seconds  
**When** I open the pick list screen  
**Then** I see a timeout state with a ‚ÄúRetry‚Äù action  
**When** I click ‚ÄúRetry‚Äù and the backend succeeds  
**Then** the pick list is displayed

---

## 13. Audit & Observability

### User-visible audit data
- Display `createdAt` and current `status` for the pick list.
- If backend provides status history fields or an endpoint, show a ‚ÄúHistory‚Äù section; otherwise omit (do not invent).

### Status history
- Not required unless backend supplies an endpoint/fields.

### Traceability expectations
- Include `X-Correlation-Id` on requests and surface it in error UI ‚ÄúTechnical details‚Äù when present (DECISION-INVENTORY-012).
- Client-side logging/telemetry must not include inventory quantities or raw payload blobs (DECISION-INVENTORY-011).

---

## 14. Non-Functional UI Requirements
- **Performance/UX:** show loading indicator within 100ms; show timeout at 8 seconds with retry; no auto-refresh loops (DECISION-INVENTORY-004).
- **Accessibility:** keyboard navigable; headings/landmarks for screen readers; sufficient contrast; print view readable.
- **Responsiveness:** usable on mobile screens; tasks list adapts (stacked rows or condensed columns).
- **i18n/timezone:** display timestamps in the app‚Äôs standard user/site timezone; do not transform backend values beyond formatting.
- **Printing:** CSS `@media print` styling to avoid cut-off columns and ensure sensible page breaks.

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Provide standard empty-state with explanation + refresh/back actions; safe because it does not alter domain behavior. Impacted sections: UX Summary, Alternate/Error Flows.
- SD-UI-LOADING-SKELETON: Use skeleton/loading indicator during async fetch; safe UI ergonomics. Impacted sections: Functional Behavior, Non-Functional.
- SD-ERR-MAP-HTTP: Standard mapping of 401/403/404/409/422/5xx to UI states; safe because it is generic transport handling aligned to deterministic error schema expectations. Impacted sections: Business Rules, Error Flows, Service Contracts.
- SD-UI-RESPONSIVE: Responsive layout adaptations for mobile/print without changing data; safe. Impacted sections: UX Summary, Non-Functional.

---

## 16. Open Questions
1. **Moqui proxy endpoint contracts (blocking):** What are the exact Moqui proxy endpoints (paths, params) and response shapes to:
   - fetch pick list by `workOrderId`
   - fetch pick tasks (embedded vs separate)
   - and do responses include `productSku`, `productDisplayName`, `uom`, and either `sortOrder` or pre-sorted tasks?
2. **Deterministic ordering contract (blocking):** For ‚Äúordered by storage layout,‚Äù will backend:
   - return tasks already ordered deterministically, or
   - provide a required `sortOrder` field?
   If neither is true, what exact location layout fields and ordering rules are guaranteed?
3. **Authorization model (blocking):** What permission(s)/roles control:
   - viewing pick lists
   - printing pick lists
   - (if applicable later) generating/regenerating pick lists
4. **Printing Draft lists (blocking):** Is printing allowed when `PickList.status = Draft` and/or when tasks include `NeedsReview`?
5. **Work order context fields:** Should the pick list view display `scheduledStartAt`, `dueAt`, and `workOrderPriority`‚Äîand which service supplies them (inventory response vs workexec summary)?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #91: [FRONTEND] [STORY] Counts: Execute Cycle Count and Record Variances
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Counts: Execute Cycle Count and Record Variances

### Primary Persona
Auditor

### Business Value
Enable auditors to record blind cycle counts per bin, producing immutable count entries and system-calculated variances so inventory discrepancies can be reviewed, recounted within policy, and escalated when unresolved.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Auditor  
- **I want** to select a cycle count task for a bin and submit an actual counted quantity (with a bounded ability to recount)  
- **So that** the system computes variance against expected quantity, retains an immutable audit trail, and supports escalation to investigation when counts don‚Äôt reconcile.

### In-scope
- View a list of assigned/available cycle count tasks relevant to the auditor.
- Execute a **blind count** for a selected `CycleCountTask` (expected qty not shown during entry).
- Submit initial count and (if allowed) trigger/submit recounts, each creating a new immutable `CountEntry`.
- Display variance results **after submission** (and/or in a review state) in a manner consistent with blind-count policy.
- Display count entry history for a task (read-only).
- Handle validation, authorization, and cap enforcement errors from backend.
- Show state/status of the task and guide user actions accordingly.

### Out-of-scope
- Manager review/approval UI beyond triggering recount if manager persona uses same screens (requires explicit story).
- Performing inventory adjustments, posting to accounting, or emitting accounting events.
- Creating cycle count plans/tasks (assumed pre-existing).
- Advanced variance report aggregation across tasks (only task-level variance visibility unless backend provides report endpoints).
- Scanner/barcode-driven bin navigation (unless already standard in repo; not specified here).

---

## 3. Actors & Stakeholders
- **Auditor (primary):** Executes counts, submits quantities, may trigger recounts if permitted by backend policy.
- **Inventory Manager (stakeholder):** May trigger additional recounts and handles investigation escalation (may be via separate story).
- **System (Inventory domain):** Computes expected quantity and variance; enforces recount caps; stores immutable entries and status history.
- **Accounting (future downstream):** May consume variance/adjustment signals later; not in current UI scope.

---

## 4. Preconditions & Dependencies
- User is authenticated in the frontend (Moqui session).
- Moqui frontend calls **Moqui proxy endpoints only** (no direct Vue ‚Üí inventory backend). (DECISION-INVENTORY-002)
- Backend provides APIs (via Moqui proxy) to:
  - List/view `CycleCountTask` records accessible to the user.
  - Submit initial count and recounts, creating immutable `CountEntry` records.
  - Return task status, latest entry pointer, total count entries, and whether recount is allowed.
- A `CycleCountTask` exists with:
  - product reference and location/bin reference (`locationId`, `storageLocationId`),
  - an internal `expectedQuantity` (not shown during entry),
  - a state machine that indicates whether the task is countable/recountable and whether it requires investigation.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Inventory ‚Üí Cycle Counts ‚Üí My Tasks** (route must exist; exact menu placement may vary).
- Deep link: `/inventory/counts/tasks/<cycleCountTaskId>` to open a specific task.

### Screens to create/modify (Moqui screens)
1. **`Inventory/Counts/TaskList`** (new or extend existing)
   - Shows tasks assigned/available to the current user.
2. **`Inventory/Counts/TaskDetail`** (new)
   - Displays task context (site/bin, SKU) and count entry form.
3. **`Inventory/Counts/TaskHistory`** (embedded section on TaskDetail)
   - Read-only list of `CountEntry` rows for the task (including recount sequence and timestamps).
4. **Optional**: **`Inventory/Counts/VarianceView`**
   - Only if policy requires variance to be shown on a separate post-submit view.

### Navigation context
- Breadcrumbs: Inventory ‚Üí Cycle Counts ‚Üí Task List ‚Üí Task Detail.
- From Task List, selecting a row transitions to Task Detail with `cycleCountTaskId`.
- From Task Detail, ‚ÄúBack to list‚Äù returns to Task List preserving filters (safe default).

### User workflows (happy + alternate paths)

#### Happy path: initial blind count
1. Auditor opens Task List and selects a task in a countable status.
2. Task Detail loads task context **without expectedQuantity**.
3. Auditor enters `actualQuantity`.
4. Auditor submits count.
5. UI shows submission success, updated task status, and the recorded entry in history.
6. UI shows variance information only after submission (see Open Questions for exact reveal policy).

#### Alternate path: recount (auditor/manager)
1. After initial submission, if backend indicates recount is allowed for this user and task:
2. User triggers recount mode and submits a new `actualQuantity`.
3. UI shows new entry appended with incremented sequence and proper linkage.

#### Alternate path: cap reached / investigation
1. Task is no longer recountable (cap reached or status changed).
2. Any attempt to trigger recount results in backend error and/or status `REQUIRES_INVESTIGATION`.
3. UI shows status and blocks recount UI.

#### Alternate path: inactive/pending site/bin
1. Task references a `LocationRef` with status `INACTIVE` or `PENDING`.
2. UI must treat the task as **read-only** for new movement-like actions; count submission is blocked and user is guided to contact a manager/admin. (DECISION-INVENTORY-009)

---

## 6. Functional Behavior

### Triggers
- Route entry to Task List or Task Detail.
- User submits count form.
- User clicks ‚ÄúTrigger recount‚Äù (if allowed) then submits recount form.

### UI actions

#### Task List
- Load tasks with cursor pagination.
- Filter by status and assignment (if supported by backend).
- Select task row ‚Üí navigate to Task Detail.

#### Task Detail
- Load task detail and history.
- Display:
  - Task identifiers
  - Site (`locationId`) and bin (`storageLocationId`) labels/barcodes if provided
  - Product SKU and description if provided
  - UOM label if provided
- Input:
  - `actualQuantity` numeric input (validation described below)
- Actions (backend-driven gating preferred):
  - `Submit Count` (initial) when task is countable and user is authorized
  - `Trigger Recount` when backend indicates recount is allowed
  - `Submit Recount` when recount mode is active
- History:
  - Read-only list of immutable `CountEntry` entries
- Status:
  - Read-only status indicator for task status and recount eligibility

### State changes (frontend-visible)
- After successful submit:
  - Task status updates per backend (commonly `COUNTED_PENDING_REVIEW` or equivalent).
  - `latestCountEntryId` updates.
  - `totalCountEntries` increments.
- When recount cap exceeded or task escalated:
  - Backend sets task status to `REQUIRES_INVESTIGATION` (or equivalent); UI reflects this and disables count inputs.

### Service interactions (Moqui)
- Use Moqui screen transitions/forms to call Moqui services that proxy to inventory backend. (DECISION-INVENTORY-002)
- All responses are **plain JSON** (no `{data: ...}` envelope). (DECISION-INVENTORY-003)
- All list endpoints use cursor pagination (`pageSize`, `pageToken` ‚Üí `nextPageToken`). (DECISION-INVENTORY-003)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `actualQuantity`:
  - Required (trim and reject empty).
  - Must be numeric.
  - Must be **>= 0**.
  - Decimal precision: enforce only if backend provides UOM/precision metadata; otherwise validate numeric format and defer precision enforcement to backend with deterministic field errors. (SAFE_DEFAULTS_MODE allows UI ergonomics but not inventing UOM policy)
- Do not allow empty submission; show inline error: ‚ÄúQuantity is required.‚Äù
- If backend rejects with field errors (400/422), map to the form field and show a summary message.

### Enable/disable rules
- Disable `Submit Count` / `Submit Recount` if:
  - task is not in a countable/recountable state (as indicated by backend flags or status),
  - user lacks permission (backend 403 and/or permission discovery),
  - site/bin is `INACTIVE` or `PENDING` (block new movement-like actions). (DECISION-INVENTORY-009)
- Show `Trigger Recount` only if backend indicates recount is allowed for this user and task (prefer backend-driven booleans to avoid duplicating policy).

### Visibility rules (blind count)
- `expectedQuantity` must **never be displayed** during count entry.
- Variance display timing:
  - Variance may be displayed only after submission and/or in history view; exact reveal policy is a blocking clarification (see Open Questions).

### Error messaging expectations
- Unauthorized (403): ‚ÄúYou do not have permission to perform this action.‚Äù
- Recount not allowed: ‚ÄúRecount is not allowed for this task.‚Äù
- Cap reached / investigation: ‚ÄúRecount limit reached. Task requires investigation.‚Äù
- Concurrency (409): ‚ÄúThis task was updated by another user. Refresh and try again.‚Äù
- Auth expired (401): follow app convention to redirect to login/session refresh. (DECISION-INVENTORY-012)

---

## 8. Data Requirements

### Entities involved (frontend view)
- `CycleCountTask` (inventory-owned)
- `CountEntry` (inventory-owned, immutable)
- `LocationRef` (inventory read model of HR locations; used for status display/eligibility) (DECISION-INVENTORY-008, DECISION-INVENTORY-009)
- `StorageLocation` (inventory-owned bins) (DECISION-INVENTORY-001)
- (Optional/future) `VarianceReport`
- (Optional) `AuditLog` / status history if backend exposes it

### Fields (type, required, defaults)

#### `CycleCountTask` (read + state indicators)
- `cycleCountTaskId` (string/UUID, required)
- `status` (string/enum, required)
- `productId` (string/UUID, required)
- `productSku` (string, required for UX; if not available, show productId)
- `productName`/`internalName` (string, optional)
- `locationId` (string/UUID, required) ‚Äî site (LocationRef) (DECISION-INVENTORY-001)
- `storageLocationId` (string/UUID, required) ‚Äî bin (StorageLocation) (DECISION-INVENTORY-001)
- `binLabel` / `barcode` (string, optional)
- `uomId` / `uomLabel` (string, optional)
- `latestCountEntryId` (string/UUID, optional)
- `totalCountEntries` (integer, optional but recommended)
- Backend-driven flags (preferred to avoid duplicating policy):
  - `canSubmitCount` (boolean, optional)
  - `canTriggerRecount` (boolean, optional)
  - `canSubmitRecount` (boolean, optional)
  - `maxCountsAllowed` (integer, optional)
  - `locationStatus` (string enum `ACTIVE|PENDING|INACTIVE`, optional but recommended for UI gating) (DECISION-INVENTORY-009)

#### `CountEntry` (read-only list + post-submit display)
- `countEntryId` (string/UUID, required)
- `cycleCountTaskId` (string/UUID, required)
- `auditorId` (string/UUID, optional)
- `auditorDisplayName` (string, optional)
- `actualQuantity` (number/decimal, required)
- `expectedQuantity` (number/decimal, optional in response; **must not display during entry**)
- `variance` (number/decimal, optional)
- `countedAt` (timestamp ISO-8601, required)
- `recountSequenceNumber` (integer, required; 1-based)
- `recountOfCountEntryId` (string/UUID, nullable)

### Read-only vs editable
- Editable: only `actualQuantity` in the submission form.
- Read-only: all other fields including variance, expected qty, and audit fields.

### Derived/calculated fields
- Variance is computed by backend: `variance = actualQuantity - expectedQuantity`.
- UI must not compute variance except to display backend-provided value.

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking note:** Inventory domain docs provided do not define cycle count endpoints. This story requires explicit Moqui proxy endpoints and response schemas for counts. Until confirmed, keep this story in draft and blocked.

### Load/view calls
- `GET /inventory/counts/tasks`
  - Query params (proposed, must be confirmed):
    - `status` (optional, repeatable or comma-separated)
    - `assignedToMe` (optional boolean)
    - `pageSize` (optional int)
    - `pageToken` (optional string)
  - Response (proposed):
    - `{ "items": [CycleCountTaskSummary...], "nextPageToken": "..." }` (cursor pagination pattern) (DECISION-INVENTORY-003)

- `GET /inventory/counts/tasks/{cycleCountTaskId}`
  - Response (proposed):
    - `CycleCountTaskDetail` (includes backend flags if available)

- `GET /inventory/counts/tasks/{cycleCountTaskId}/entries`
  - Query params:
    - `pageSize`, `pageToken`
  - Response:
    - `{ "items": [CountEntry...], "nextPageToken": "..." }`

### Create/update calls
- None (no editing tasks here)

### Submit/transition calls
- `POST /inventory/counts/tasks/{cycleCountTaskId}/entries`
  - Body:
    - `{ "actualQuantity": <number> }`
  - Response:
    - `{ "countEntry": <CountEntry>, "task": <CycleCountTaskDetail> }` (or equivalent)

- Optional recount trigger (only if backend models a separate step):
  - `POST /inventory/counts/tasks/{cycleCountTaskId}/recount`
  - Response:
    - updated task flags/status

### Error handling expectations
- Error schema must be deterministic and plain JSON. (DECISION-INVENTORY-003)
- `400/422` validation errors: include field-level details; UI maps to `actualQuantity`.
- `401` unauthenticated: redirect to login/session refresh. (DECISION-INVENTORY-012)
- `403` forbidden: show forbidden state; do not leak expected qty/variance. (DECISION-INVENTORY-012)
- `404` not found or not accessible: show ‚ÄúTask not found or access denied‚Äù and link back to list.
- `409` concurrency/state change: prompt refresh; allow user to reload task detail.
- `5xx`/network timeout: show retry; include correlation ID if present. (DECISION-INVENTORY-012)

---

## 10. State Model & Transitions

### Allowed states (minimum required for UI)
> **Blocking:** exact state machine is not defined in provided inventory domain rules; UI must treat statuses as backend-owned strings and rely on backend flags where possible.

Minimum statuses the UI must handle if present:
- `ACTIVE` (or equivalent ‚Äúready to count‚Äù)
- `COUNTED_PENDING_REVIEW` (or equivalent)
- `REQUIRES_INVESTIGATION` (or equivalent)
- `FINALIZED` / `CLOSED` (if backend uses it)

### Role-based transitions
- Auditor:
  - Can submit initial count when task is countable.
  - Can trigger/submit recount only when backend indicates allowed (policy enforced server-side).
- Inventory Manager:
  - May have additional recount permissions; UI must rely on backend flags/403 responses.

### UI behavior per state
- `ACTIVE`: show count entry form; hide expected qty.
- `COUNTED_PENDING_REVIEW`: show history; allow recount only if backend says yes.
- `REQUIRES_INVESTIGATION`: disable all count inputs; show guidance to contact manager.
- `FINALIZED/CLOSED`: read-only.

---

## 11. Alternate / Error Flows

### Validation failures
- Negative quantity submitted ‚Üí inline error; prevent submit.
- Non-numeric input ‚Üí inline error.
- Excess decimal precision ‚Üí if backend returns field error, show it inline and keep value for correction.

### Concurrency conflicts
- Task status changed since load (e.g., another auditor counted) ‚Üí backend returns 409; UI shows refresh prompt and reloads task.

### Unauthorized access
- User without permission tries to submit ‚Üí 403; disable form and show message.

### Empty states
- Task list empty ‚Üí show ‚ÄúNo cycle count tasks available‚Äù with suggestion to adjust filters.
- Task history empty:
  - If task is `ACTIVE`: expected; show ‚ÄúNo counts submitted yet.‚Äù
  - Otherwise: show error banner ‚ÄúCounts missing; refresh or contact support.‚Äù

### Timeout / offline
- If request exceeds 8 seconds, show timeout state with Retry; do not auto-retry. (DECISION-INVENTORY-004)

---

## 12. Acceptance Criteria

### Scenario 1: Auditor submits initial blind count and system records variance
**Given** an Auditor has access to a cycle count task in a countable state  
**And** the task has an internal expected quantity (not shown during entry)  
**When** the Auditor enters an actual quantity of `102` and submits  
**Then** the UI calls the Moqui proxy endpoint to create a count entry for that task  
**And** the backend returns a newly created immutable CountEntry (sequence 1)  
**And** the UI refreshes and shows the task status as `COUNTED_PENDING_REVIEW` (or backend equivalent)  
**And** the UI shows the recorded count entry in history  
**And** the UI does not display expected quantity prior to submission.

### Scenario 2: Auditor attempts to submit a negative quantity
**Given** an Auditor is on a cycle count task detail screen  
**When** they enter `-1` and attempt to submit  
**Then** the UI blocks submission  
**And** displays ‚ÄúQuantity must be zero or a positive number.‚Äù

### Scenario 3: Auditor triggers a recount (when allowed) and submits a second entry
**Given** a task has an initial CountEntry  
**And** the backend indicates the current user can trigger a recount for the task  
**When** the user triggers recount and submits a new actual quantity  
**Then** the backend creates a new immutable CountEntry with incremented recount sequence  
**And** the UI shows both entries in history in sequence order.

### Scenario 4: User attempts recount when not allowed
**Given** a task is not recountable for the current user (by policy or status)  
**When** the user attempts to trigger a recount  
**Then** the backend returns `403` or a deterministic domain error indicating recount not allowed  
**And** the UI displays a policy/permission message  
**And** the UI does not allow submission of another recount.

### Scenario 5: Recount cap reached escalates to investigation
**Given** a task has reached the maximum number of allowed count entries  
**When** the user attempts to trigger or submit another recount  
**Then** the backend blocks the request and returns status `REQUIRES_INVESTIGATION` (or returns an error indicating escalation)  
**And** the UI refreshes to show `REQUIRES_INVESTIGATION`  
**And** all count submission controls are disabled.

### Scenario 6: Unauthorized user cannot submit counts
**Given** a user without cycle count execution permission opens a task  
**When** they attempt to submit a count  
**Then** the backend returns `403 Forbidden`  
**And** the UI shows ‚ÄúYou do not have permission to perform this action‚Äù  
**And** the UI keeps the task in read-only mode.

### Scenario 7: Auth expired redirects to login
**Given** a user‚Äôs session is expired  
**When** they load the task list or submit a count  
**Then** the backend returns `401`  
**And** the UI follows the standard login/session refresh flow. (DECISION-INVENTORY-012)

---

## 13. Audit & Observability

### User-visible audit data
- Task history shows:
  - `countedAt` timestamp
  - `recountSequenceNumber`
  - `actualQuantity`
  - `variance` (only if permitted by blind-count reveal policy; otherwise hidden/redacted)
  - performer (auditor display name/ID if available)

### Status history
- If backend exposes status transitions, show status history (timestamp + from/to + actor). If not exposed, omit.

### Traceability expectations
- Every submission success message includes `countEntryId` (and optionally `cycleCountTaskId`) for support.
- Requests include `X-Correlation-Id` and error UI shows correlation ID in ‚ÄúTechnical details‚Äù when present. (DECISION-INVENTORY-012)
- Do not log quantities or expected/variance values to console/telemetry (treat as sensitive inventory data). (DECISION-INVENTORY-011)

---

## 14. Non-Functional UI Requirements
- **Performance:** Task detail should load with minimal round trips; avoid N+1 calls when rendering history.
- **Accessibility:** All form controls labeled; validation errors announced; keyboard navigable submit actions.
- **Responsiveness:** Task list and detail usable on tablet-sized screens typical for warehouse/auditor usage.
- **i18n/timezone:** Display timestamps in user locale/timezone while storing/using UTC from backend.
- **Timeout UX:** Show loading indicator within 100ms; surface timeout at 8 seconds with Retry; do not auto-refresh loops. (DECISION-INVENTORY-004)
- **Sensitive data handling:** Do not log numeric quantities or raw payloads. (DECISION-INVENTORY-011)

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide clear empty states for task list/history; safe because it does not change domain logic. Impacted sections: UX Summary, Alternate / Error Flows.
- SD-UX-PAGINATION: Use cursor pagination controls with a standard `pageSize` default; safe because it only affects presentation and load behavior and aligns with inventory list conventions. Impacted sections: UX Summary, Service Contracts.
- SD-ERR-MAP-STD: Map backend 400/401/403/404/409/422/5xx to standard UI messages and field errors; safe because it follows HTTP semantics and deterministic error schema expectations. Impacted sections: Business Rules, Alternate / Error Flows, Service Contracts.

---

## 16. Open Questions
1. **Backend contract (blocking):** What are the exact Moqui proxy endpoints, request/response schemas, and deterministic error codes for:
   - task list,
   - task detail,
   - task entries/history,
   - submit initial count,
   - trigger recount (if separate),
   - submit recount (if separate)?
2. **Blind-count reveal policy (blocking):** After submission, may the Auditor see `expectedQuantity` and `variance` immediately, or only Inventory Manager/review screens? If restricted, should the UI show only ‚ÄúCount recorded‚Äù without variance?
3. **UOM / precision policy (blocking):** Are counted quantities always integers, or can they be decimals by item/UOM? If decimals are allowed, what precision rules should the UI enforce (if any) vs defer to backend?
4. **Task state machine (blocking):** What are the authoritative task statuses and which are countable/recountable/final? Prefer backend-provided `canSubmitCount/canTriggerRecount` flags‚Äîare these available?
5. **Authorization mapping (blocking):** What permission strings gate:
   - viewing task list/detail,
   - submitting counts,
   - triggering recount (self vs manager),
   and how does the frontend discover permissions (existing Moqui user context vs endpoint flags)?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #90: [FRONTEND] [STORY] Counts: Approve and Post Adjustments from Cycle Count
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Counts: Approve and Post Adjustments from Cycle Count

### Primary Persona
Inventory Manager (Tier-1 Approver) and Inventory Controller/Director (Tier-2 Approver)

### Business Value
Ensure cycle-count variances are posted to inventory on-hand only with appropriate approvals, producing immutable ledger entries and a complete audit trail.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Inventory Manager (and authorized approver),
- **I want** to review, approve (post), or reject cycle-count-generated inventory adjustments before they are posted when they exceed policy thresholds,
- **So that** shrink/corrections are controlled, auditable, and posted accurately to on-hand inventory.

### In-scope
- Frontend screens to:
  - List adjustments requiring approval (approval queue)
  - View adjustment details (including computed variances and required tier)
  - Approve (post) or reject (with reason) adjustments when authorized
  - View posted outcome (ledger reference) and audit/status history
- Permission-aware UI gating (hide/disable actions when unauthorized)
- Error handling and user feedback for validation/authorization/concurrency failures
- In-app pending approvals indicator entry point (minimal v1; optional if a host screen exists)

### Out-of-scope
- Creating cycle counts, computing variances, and generating adjustments
- Defining/configuring threshold policies (admin/config screens)
- Email digests/escalations
- Any ledger mutation (ledger is append-only; corrections are new entries)
- Any client-side computation of approval thresholds/tiers (backend is authoritative)

---

## 3. Actors & Stakeholders
- **Inventory Manager (Tier 1 Approver)**: Reviews and approves/rejects adjustments requiring Tier 1.
- **Inventory Controller/Director (Tier 2 Approver)**: Approves higher-risk adjustments requiring Tier 2.
- **Inventory Clerk (Read-only)**: May view adjustments but cannot approve/reject.
- **System (Inventory domain via Moqui proxy)**: Enforces thresholds, required tier, state transitions, ledger posting, audit.
- **Accounting (Downstream)**: May consume events; UI only surfaces that posting occurred (no accounting logic).

---

## 4. Preconditions & Dependencies
- Cycle count flow has produced one or more **InventoryAdjustment** records in a state requiring approval.
- Moqui frontend must call **Moqui proxy endpoints** only (no direct Vue ‚Üí inventory backend). (DECISION-INVENTORY-002)
- Backend (via Moqui proxy) must provide:
  - List adjustments requiring approval
  - Adjustment detail (including status/audit fields; ledger reference when posted)
  - Approve/post action
  - Reject action (requires rejection reason)
- Authentication and authorization are enforced by Moqui/session; UI must handle 401/403 consistently and show correlation IDs on errors. (DECISION-INVENTORY-012)
- Sensitive data handling: do not log quantities/amounts or raw payload blobs in client logs/telemetry. (DECISION-INVENTORY-011)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Inventory ‚Üí Counts ‚Üí Adjustment Approvals**
- Optional secondary entry: link/badge ‚ÄúPending approvals (N)‚Äù from an Inventory landing screen **only if** such a screen exists and a count endpoint is available (otherwise omit).

### Screens to create/modify (Moqui)
1. **`Inventory/Count/AdjustmentApprovalQueue.xml`** (new)
   - List/table of adjustments in `PENDING_APPROVAL`
   - Cursor pagination (pageSize/pageToken) if supported by backend list endpoint; no reliance on total counts. (DECISION-INVENTORY-003)
   - Filters (UI-only; must map to backend-supported query params):
     - locationId (picker; optional)
     - productSku (text; optional)
     - requiredApprovalTier (optional)
     - createdAt date range (optional; validate from<=to)
     - status (default `PENDING_APPROVAL`; optional ‚ÄúAll statuses‚Äù only if backend supports)
2. **`Inventory/Count/AdjustmentApprovalDetail.xml`** (new)
   - Read-only adjustment details
   - Action panel: Approve/Post, Reject (with rejectionReason), Back
   - Status/audit history panel (read-only)
3. Optional: add a navigation link from existing Counts menu screen if present (do not create a new dashboard in this story unless already in repo).

### Navigation context
- Queue row click navigates to detail for `adjustmentId`.
- After action:
  - Approve/Post: remain on detail, refresh, show status `POSTED` and ledger reference (if returned), disable further actions.
  - Reject: remain on detail, refresh, show status `REJECTED`, display rejection reason, disable further actions.
- If user deep-links to detail for an adjustment not pending, detail remains read-only and shows current status.

### User workflows (happy + alternate)
- **Happy path (Tier 1)**: Open queue ‚Üí open adjustment ‚Üí review ‚Üí Approve/Post ‚Üí see posted confirmation + ledger reference.
- **Happy path (Tier 2)**: Same, but only Tier 2 can approve when required tier is Tier 2.
- **Alternate**: Reject with reason ‚Üí see rejected status.
- **Alternate**: Unauthorized user views but cannot act ‚Üí actions hidden/disabled; 403 handled if attempted.
- **Alternate**: Concurrency conflict ‚Üí show message and refresh detail.
- **Alternate**: Backend rejects due to invalid state or policy ‚Üí show deterministic error and refresh.

---

## 6. Functional Behavior

### Triggers
- User navigates to approval queue.
- User selects an adjustment to view.
- User clicks Approve/Post or Reject.

### UI actions
**Queue**
- Load pending adjustments list from Moqui proxy.
- Support filtering and cursor pagination.
- Row click navigates to detail.

**Detail**
- Load adjustment by ID.
- Display read-only fields (see Data Requirements).
- Actions:
  - **Approve/Post**: submits approve/post transition.
  - **Reject**: requires `rejectionReason` input; submits reject transition.
- After successful mutation, refresh detail and update queue (remove item if no longer pending).

### State changes (UI perspective)
- `PENDING_APPROVAL` ‚Üí (Approve/Post) ‚Üí `POSTED` (or backend may return a terminal failure state)
- `PENDING_APPROVAL` ‚Üí (Reject) ‚Üí `REJECTED`
- Non-pending states are read-only in UI.

### Service interactions (Moqui proxy only)
- All reads and mutations are performed via same-origin Moqui proxy endpoints/services. (DECISION-INVENTORY-002)
- Requests include/propagate `X-Correlation-Id`; UI surfaces it on error. (DECISION-INVENTORY-012)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Reject requires rejectionReason**:
  - Trimmed, non-empty string required.
  - Client blocks submit if empty; server validation errors map to field.
- **Approve/Post requires**:
  - Current status is `PENDING_APPROVAL` (client checks; backend authoritative).
  - User is authorized for the required approval tier (client gates when possible; backend authoritative).

### Enable/disable rules
- Approve/Post enabled only when:
  - status = `PENDING_APPROVAL`
  - user has permission for requiredApprovalTier (if permission info is available; otherwise enable and rely on 403 handling)
- Reject enabled only when:
  - status = `PENDING_APPROVAL`
  - user has permission to reject (see Open Questions: whether same as approve or separate)
- Disable all mutation actions while request is in-flight (double-submit guard).
- If status in (`POSTED`, `REJECTED`, `FAILED`, `AUTO_APPROVED`), all mutation actions disabled.

### Visibility rules
- Queue:
  - Default filter is `PENDING_APPROVAL`.
  - ‚ÄúAll statuses‚Äù toggle is shown only if backend supports status filtering; otherwise omit.
- Detail:
  - Always show read-only fields.
  - Show action panel only when status is `PENDING_APPROVAL` and user has at least one actionable permission.

### Error messaging expectations
- 401: route to login/session refresh per app convention. (DECISION-INVENTORY-012)
- 403: show forbidden message without leaking data; keep detail read-only.
- 409: show ‚ÄúUpdated by another user; refreshing‚Ä¶‚Äù then reload detail.
- 422/400 invalid state/validation: show deterministic message; map field errors to `rejectionReason` when applicable.
- 5xx/unknown: generic error + correlation ID in technical details.

**Decision rationale applied**
- Deterministic error schema and correlation ID handling are required for supportability. (DECISION-INVENTORY-003, DECISION-INVENTORY-012)

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `InventoryAdjustment` (primary; approval workflow object)
- `InventoryLedgerEntry` (read-only reference after posting; ledger is immutable/append-only) (DECISION-INVENTORY-005)
- Optional: `ApprovalHistory` / status history records (if backend exposes; otherwise derive from timestamps)

### Fields (type, required, defaults)

**InventoryAdjustment (summary + detail; read-only unless noted)**
- Identifiers
  - `adjustmentId` (UUID, required)
  - `productSku` (string, required) *(if backend uses stockItemId instead, backend must also provide productSku for UX; see Open Questions)*
  - `locationId` (UUID, required) *(use LocationRef model; display name if provided)* (DECISION-INVENTORY-001)
  - `storageLocationId` (UUID, optional) *(if adjustment is bin-scoped; display name/barcode if provided)* (DECISION-INVENTORY-001)
- Quantities/values (sensitive: do not log)
  - `varianceQty` (decimal, required)
  - `onHandQtyAtProposal` (decimal, optional/required per backend)
  - `unitCost` (decimal money, optional/required per backend)
  - Derived fields (prefer backend-provided; if absent, UI may display only what is provided):
    - `valueVariance` (decimal money, optional)
    - `percentVariance` (decimal, optional)
- Approval/workflow
  - `status` (enum, required)
  - `requiredApprovalTier` (enum, required when status is pending)
  - `policyVersion` (string, optional)
- Audit
  - `createdByUserId` (UUID, optional)
  - `createdAt` (timestamp, required)
  - `updatedAt` (timestamp, required)
  - `approvedByUserId` (UUID, optional)
  - `approvedAt` / `postedAt` (timestamp, optional)
  - `rejectedByUserId` (UUID, optional)
  - `rejectedAt` (timestamp, optional)
  - `rejectionReason` (string, required only when rejected; **editable input only during reject action**)
  - `failureMessage` / `errorCode` (string, optional; only if backend returns a terminal failure state)

**InventoryLedgerEntry reference (read-only)**
- `ledgerEntryId` (UUID, optional)
- `entryType` (string/enum, optional)
- `postedAt` (timestamp, optional)

### Read-only vs editable by state/role
- All fields are read-only except:
  - `rejectionReason` input is editable only when:
    - status = `PENDING_APPROVAL`
    - user is authorized to reject

### Derived/calculated fields
- UI must not compute approval thresholds/tiers.
- If backend does not provide derived monetary/percent fields, UI must not invent them; display only provided fields.

---

## 9. Service Contracts (Frontend Perspective)

> Inventory domain docs provided do not define cycle-count approval endpoints. This story requires explicit Moqui proxy contracts; until provided, implementation is blocked.

### Load/view calls (required)
- **List adjustments requiring approval**
  - Method/path: **TBD (Moqui proxy)**
  - Query params (as supported): `status`, `locationId`, `productSku`, `requiredApprovalTier`, `fromDate`, `toDate`, `pageSize`, `pageToken`, `sort`
  - Response shape:
    - Plain JSON
    - Cursor pagination: `{ items: [...], nextPageToken: "..." }` (or equivalent) (DECISION-INVENTORY-003)
- **Get adjustment detail**
  - Method/path: **TBD (Moqui proxy)**
  - Input: `adjustmentId`
  - Output: plain JSON adjustment object; may include `ledgerEntryId` when posted; may include `history[]`

### Create/update calls
- None (this story does not create adjustments)

### Submit/transition calls (required)
- **Approve/Post adjustment**
  - Method/path: **TBD (Moqui proxy)**
  - Input: `adjustmentId` (and optionally an idempotency token if platform uses one; otherwise none)
  - Output: updated adjustment object (status updated) and ledger reference if posted
- **Reject adjustment**
  - Method/path: **TBD (Moqui proxy)**
  - Input: `adjustmentId`, `rejectionReason` (string)
  - Output: updated adjustment object (status `REJECTED`)

### Error handling expectations (deterministic)
- Errors follow deterministic schema (field errors, message, code) and are plain JSON. (DECISION-INVENTORY-003)
- 401/403 behavior per correlation/auth rules. (DECISION-INVENTORY-012)
- UI must not log sensitive numeric fields from responses. (DECISION-INVENTORY-011)

---

## 10. State Model & Transitions

### Allowed states (as displayed)
- `PENDING_APPROVAL`
- `AUTO_APPROVED` *(if backend uses; otherwise omit)*
- `POSTED`
- `REJECTED`
- `FAILED` *(only if backend uses a terminal failure state; otherwise treat failures as error responses without state change)*

### Role-based transitions
- From `PENDING_APPROVAL`:
  - Approve/Post: allowed only for users authorized for `requiredApprovalTier`
  - Reject: allowed only for users authorized to reject (permission model TBD)
- No UI transitions from terminal states.

### UI behavior per state
- `PENDING_APPROVAL`: show action panel (permission gated)
- `AUTO_APPROVED`: informational; no actions
- `POSTED`: show ledger reference; no actions
- `REJECTED`: show rejection reason; no actions
- `FAILED`: show failure message if provided; no retry unless backend explicitly supports a retry transition

---

## 11. Alternate / Error Flows

### Validation failures
- Reject without rejectionReason:
  - Client blocks submit; if server returns 400/422, show field error.

### Concurrency conflicts
- If another user posts/rejects while viewing:
  - Approve/Reject returns 409 or invalid-state error
  - UI reloads detail and informs user it is no longer pending.

### Unauthorized access
- If user lacks permissions:
  - UI hides/disables actions when permission info is available.
  - If backend returns 403, show forbidden state/message and do not display additional sensitive details.

### Empty states
- Queue has zero items:
  - Show ‚ÄúNo adjustments pending approval‚Äù and last refreshed time.

### Backend posting failure
- If approve returns an error response:
  - Show error banner with correlation ID.
  - Refresh detail to reflect current status (in case it changed).
- If backend uses `FAILED` state:
  - Show `failureMessage` (if provided) and disable actions.

### Timeout
- If request exceeds 8 seconds:
  - Show timeout message with Retry button (no auto-retry loops). (DECISION-INVENTORY-004)

---

## 12. Acceptance Criteria

### Scenario 1: View pending approval queue
**Given** I am an authenticated user with access to Inventory Counts  
**When** I navigate to ‚ÄúAdjustment Approvals‚Äù  
**Then** the UI requests the pending-approval adjustments list via Moqui proxy  
**And** I see a list of adjustments in status `PENDING_APPROVAL`  
**And** each row shows product identifier, location, variance, required approval tier, and created time  
**And** if there are none, I see ‚ÄúNo adjustments pending approval‚Äù.

### Scenario 2: Tier 1 approver can approve Tier 1 adjustment
**Given** an adjustment exists with status `PENDING_APPROVAL` and `requiredApprovalTier = TIER_1`  
**And** I have the Tier 1 approval permission  
**When** I open the adjustment detail and click ‚ÄúApprove/Post‚Äù  
**Then** the UI calls the approve/post endpoint via Moqui proxy  
**And** on success the UI refreshes to status `POSTED`  
**And** the UI displays the ledger entry reference if returned  
**And** approve/reject actions are disabled.

### Scenario 3: Tier 1 approver cannot approve Tier 2 adjustment
**Given** an adjustment exists with status `PENDING_APPROVAL` and `requiredApprovalTier = TIER_2`  
**And** I do not have Tier 2 approval permission  
**When** I open the adjustment detail  
**Then** the ‚ÄúApprove/Post‚Äù action is not available (hidden or disabled)  
**And** if I attempt to approve, the backend responds 403  
**And** the UI shows a forbidden message and does not change the adjustment state.

### Scenario 4: Reject requires a reason
**Given** an adjustment exists with status `PENDING_APPROVAL`  
**And** I am authorized to reject it  
**When** I click ‚ÄúReject‚Äù without entering a rejection reason  
**Then** the UI prevents submission and shows ‚ÄúRejection reason is required‚Äù  
**And** no request is sent.

### Scenario 5: Authorized reject transitions to REJECTED
**Given** an adjustment exists with status `PENDING_APPROVAL`  
**And** I am authorized to reject it  
**When** I enter a rejection reason and submit reject  
**Then** the UI calls the reject endpoint via Moqui proxy  
**And** the UI refreshes to status `REJECTED`  
**And** the rejection reason is displayed read-only  
**And** the adjustment no longer appears in the pending approval queue.

### Scenario 6: Concurrency conflict on approve
**Given** I am viewing a `PENDING_APPROVAL` adjustment  
**And** another approver posts it before I do  
**When** I click ‚ÄúApprove/Post‚Äù  
**Then** the backend responds with 409 or invalid-state error  
**And** the UI informs me it was updated by someone else  
**And** the UI reloads detail showing the current status (e.g., `POSTED`).

### Scenario 7: Correlation ID is shown on error without leaking sensitive data
**Given** an approve/post request fails with a 5xx error  
**And** the response includes `X-Correlation-Id`  
**When** the UI shows the error banner  
**Then** the banner includes the correlation ID in ‚ÄúTechnical details‚Äù  
**And** the UI does not log or display raw response payloads containing sensitive quantities beyond what is already rendered on-screen. (DECISION-INVENTORY-011)

---

## 13. Audit & Observability

### User-visible audit data
- Detail screen shows:
  - createdBy/createdAt
  - approvedBy/postedAt when posted
  - rejectedBy/rejectedAt and rejectionReason when rejected
  - policyVersion (if provided)
  - status history list if provided by backend; otherwise show current status + timestamps.

### Status history
- If backend provides `history[]` (or equivalent), render chronological transitions with actor and timestamp.
- Do not attempt to synthesize missing history beyond timestamps.

### Traceability expectations
- Propagate and display `X-Correlation-Id` on errors. (DECISION-INVENTORY-012)
- Do not emit sensitive quantities/amounts in client logs/telemetry. (DECISION-INVENTORY-011)

---

## 14. Non-Functional UI Requirements
- **Performance:** Queue uses cursor pagination; do not fetch unbounded datasets; show loading indicator within 100ms. (DECISION-INVENTORY-003, DECISION-INVENTORY-004)
- **Timeout UX:** Surface a timeout at 8 seconds with Retry; no auto-refresh loops. (DECISION-INVENTORY-004)
- **Accessibility:** Keyboard navigable table; labeled inputs; focus moves to first error on validation failure.
- **Responsiveness:** Works on tablet viewport.
- **i18n/timezone:** Display timestamps in user locale/timezone; treat backend timestamps as UTC/ISO.
- **Security:** 401 routes to login/session refresh; 403 shows forbidden state without data leakage. (DECISION-INVENTORY-012)

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging for zero pending approvals; safe because it doesn‚Äôt affect domain logic; impacts UX Summary, Alternate / Error Flows.
- SD-UX-PAGINATION: Use cursor pagination UI patterns (pageSize/pageToken/nextPageToken) and do not rely on totalCount; safe because it is a list UX pattern aligned to inventory list conventions; impacts UX Summary, Service Contracts, Non-Functional UI Requirements.
- SD-ERR-MAP-STD: Map 400/401/403/409/422/5xx to standard error banner + field errors; safe because it is presentation-layer handling; impacts Business Rules, Service Contracts, Alternate / Error Flows.
- SD-OBS-CORRELATION-ID: Display correlation ID when present; safe observability boilerplate; impacts Audit & Observability, Alternate / Error Flows.

---

## 16. Open Questions
1. **Backend/Moqui proxy endpoints (blocking):** What are the exact Moqui proxy routes (or Moqui service names invoked by screens) for:
   - listing adjustments requiring approval
   - fetching adjustment detail
   - approve/post action
   - reject action  
   (This story cannot be implemented without concrete contracts; inventory domain docs do not define these endpoints.)
2. **Permission strings (blocking):** What are the canonical permission names for:
   - viewing the approval queue/detail
   - approving Tier 1 vs Tier 2
   - rejecting (same as approve or separate)  
   (Inventory permission naming convention exists, but specific strings for this workflow are not defined in provided decisions. (DECISION-INVENTORY-010))
3. **Product identifier fields (blocking):** Will adjustment APIs provide `productSku` (preferred for UX) or only `stockItemId`? If only `stockItemId`, what Moqui proxy endpoint should the UI call to resolve it to SKU/name (Product domain dependency)?
4. **State taxonomy (blocking):** Confirm the exact adjustment status enum values used by backend for this workflow (e.g., `PENDING_APPROVAL`, `POSTED`, `REJECTED`, optional `AUTO_APPROVED`, optional `FAILED`) and whether failures are represented as a state or only as error responses.
5. **Audit/history shape (blocking):** Does backend provide explicit status/approval history records? If yes, what is the response shape and which fields are safe to display?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Counts: Approve and Post Adjustments from Cycle Count ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/90

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #88: [FRONTEND] [STORY] Allocations: Reallocate Reserved Stock When Schedule Changes
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Inventory Availability: View On-hand/Allocated/ATP by SKU + Location (Deep-linkable, Moqui Proxy, No Client Computation)

### Primary Persona
Dispatcher

### Business Value
Enable dispatchers to quickly verify whether required parts are available at a specific site/bin, using backend-authoritative availability (on-hand/allocated/ATP) with bookmarkable links and safe handling of sensitive quantity data.

---

## 2. Story Intent

### As a / I want / So that
**As a** Dispatcher,  
**I want** to search inventory availability by `productSku` and `locationId` (optionally `storageLocationId`) and share/bookmark the result via URL,  
**so that** I can make scheduling/dispatch decisions using authoritative ATP without manual calculations or stale assumptions.

### In-scope
- Availability query UI with required pickers:
  - `productSku` input (trimmed, non-empty)
  - `locationId` picker (LocationRef)
  - optional `storageLocationId` picker filtered by `locationId` (StorageLocation)
- Deep-linking via canonical query params: `productSku`, `locationId`, optional `storageLocationId` (auto-run once per load when present). (DECISION-INVENTORY-014)
- Display backend-authoritative availability fields (read-only; no client-side computation). (DECISION-INVENTORY-004, DECISION-INVENTORY-016)
- Empty-state behavior: ‚Äúno inventory history‚Äù is success-with-zeros, not an error. (DECISION-INVENTORY-004)
- Standard error handling and correlation ID display. (DECISION-INVENTORY-003, DECISION-INVENTORY-012)
- Sensitive data handling: do not log quantities/payloads in client logs/telemetry. (DECISION-INVENTORY-011)

### Out-of-scope
- Any allocation/reallocation/reservation mutation workflows (including ‚Äúreallocate reserved stock‚Äù). (DECISION-INVENTORY-016)
- Ledger mutation or adjustment creation.
- Product master data management (names/descriptions/UOM definitions).
- Work order lifecycle/scheduling changes.
- Any frontend computation of on-hand/ATP/allocated.

---

## 3. Actors & Stakeholders
- **Dispatcher (primary):** needs fast, trustworthy availability to schedule/dispatch.
- **Inventory Manager (secondary):** may use the same view for spot checks.
- **Support/Ops (indirect):** needs correlation IDs for troubleshooting.
- **System (Inventory services via Moqui proxy):** authoritative availability computation and response.
- **System (HR/Location upstream):** source of LocationRef lifecycle; Inventory stores read model.

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend. (DECISION-INVENTORY-012)
- Moqui provides proxy endpoints (same-origin) for inventory:
  - `GET /inventory/availability` (plain JSON). (DECISION-INVENTORY-002, DECISION-INVENTORY-004)
  - `GET /inventory/locations` for LocationRef picker. (DECISION-INVENTORY-008)
  - `GET /inventory/storage-locations?locationId=...` for StorageLocation picker. (DECISION-INVENTORY-007)
- Permission model exists for viewing availability (permission string TBD; see Open Questions). (DECISION-INVENTORY-010)
- Location eligibility rules:
  - `LocationRef.status INACTIVE|PENDING` must be blocked for new movement flows; for availability viewing, read-only display is allowed (no movement occurs here). (DECISION-INVENTORY-009)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Inventory menu: `Inventory ‚Üí Availability`
- Deep link from tickets/SOPs: `/inventory/availability?productSku=...&locationId=...&storageLocationId=...`

### Screens to create/modify
1. **New Screen:** `Inventory/Availability/Availability.xml`
   - Form for `productSku`, `locationId`, `storageLocationId`
   - Results panel for availability response
2. **Reusable Picker Subscreens/Widgets (if not already present):**
   - `Inventory/Components/LocationRefPicker.xml` (backed by `GET /inventory/locations`)
   - `Inventory/Components/StorageLocationPicker.xml` (backed by `GET /inventory/storage-locations?locationId=...`)
3. **Optional:** `Inventory/Availability/AvailabilityHelp.xml` (static help text for semantics and deep-link params)

### Navigation context
- Inventory namespace; no dependency on WorkExec navigation.

### User workflows (happy + alternate paths)

**Happy path (manual query):**
1. User opens Inventory ‚Üí Availability.
2. Selects `locationId` via picker.
3. Optionally selects `storageLocationId` (picker filtered by location).
4. Enters `productSku`.
5. Clicks ‚ÄúSearch‚Äù.
6. UI calls Moqui proxy and renders availability results.

**Deep-link path (auto-run once):**
1. User opens a URL containing `productSku` and `locationId` (and optional `storageLocationId`).
2. UI pre-fills the form and auto-runs the search once.
3. User may adjust inputs and re-run manually.

**Alternate path (no history / zeros):**
1. User searches for a SKU with no inventory history at that location.
2. UI shows a success state with zeros and an explanatory empty-state message.

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúSearch‚Äù.
- Screen load with deep-link params present triggers exactly one auto-run. (DECISION-INVENTORY-014)

### UI actions
- Input/selection:
  - `productSku` text input (trim on blur/submit)
  - `locationId` picker (required)
  - `storageLocationId` picker (optional; disabled until `locationId` selected)
- Actions:
  - ‚ÄúSearch‚Äù (enabled only when required fields valid)
  - ‚ÄúCopy link‚Äù (copies current URL with canonical query params)
  - ‚ÄúClear‚Äù (resets form and clears results)

### State changes (UI-local)
- `idle` ‚Üí `loading` ‚Üí `success|error`
- `autoRunConsumed` boolean to prevent auto-run loops on reactive param updates. (DECISION-INVENTORY-014)

### Service interactions
- `GET /inventory/availability?productSku=...&locationId=...&storageLocationId=...`
- Picker loads:
  - `GET /inventory/locations` (cursor pagination if needed)
  - `GET /inventory/storage-locations?locationId=...` (cursor pagination if needed)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `productSku`:
  - Trim whitespace; reject empty/whitespace-only. (Checklist)
- `locationId`:
  - Required; must be selected via picker (no free-text UUID entry in user flow). (DECISION-INVENTORY-001)
- `storageLocationId`:
  - Optional; if provided must belong to selected `locationId` (enforced by filtered picker; also handle backend validation errors). (DECISION-INVENTORY-001)
- Deep-link params:
  - If required params missing/invalid, do not auto-run; show form with validation hints. (DECISION-INVENTORY-014)

### Enable/disable rules
- ‚ÄúSearch‚Äù disabled when:
  - `productSku` invalid OR `locationId` missing
  - request in-flight (double-submit guard)
- `storageLocationId` picker disabled until `locationId` selected.
- If `locationId` changes, clear `storageLocationId` selection automatically.

### Visibility rules
- Results panel hidden until first successful search or error.
- Success-with-zeros:
  - Render zeros and show message: ‚ÄúNo inventory history for this SKU at this location; showing 0 available.‚Äù (DECISION-INVENTORY-004)
- Technical details accordion in error state shows correlation ID if available. (DECISION-INVENTORY-012)

### Error messaging expectations
- Follow deterministic error schema mapping. (DECISION-INVENTORY-003)
- 401: redirect to login/session refresh per app convention. (DECISION-INVENTORY-012)
- 403: show forbidden state (no data leakage). (DECISION-INVENTORY-012)
- 422: show validation errors (e.g., storageLocationId not in locationId) as field errors when possible.
- Timeout: after 8 seconds show timeout message with Retry. (DECISION-INVENTORY-004)

---

## 8. Data Requirements

### Entities involved
- `LocationRef` (read model; picker)
- `StorageLocation` (picker)
- `AvailabilityView` (read-only response)

### Fields (type, required, defaults)

**Availability query (input)**
- `productSku` (string, required; trimmed)
- `locationId` (uuidv7 string, required)
- `storageLocationId` (uuidv7 string, optional)

**Availability response (display; backend-authoritative)**
Minimum required fields to render:
- `productSku` (string)
- `locationId` (uuid)
- `storageLocationId` (uuid|null)
- `onHand` (decimal)
- `allocated` (decimal)
- `availableToPromise` (decimal)
Optional (render if present; do not compute if absent):
- `asOfAt` (timestamp)
- `uom` (string)
- `notes` (string)

**LocationRef (picker display)**
- `locationId` (uuid, required)
- `name` (string, required)
- `status` (`ACTIVE|INACTIVE|PENDING`, required)

**StorageLocation (picker display)**
- `storageLocationId` (uuid, required)
- `locationId` (uuid, required)
- `name` (string, required)
- `barcode` (string, optional)
- `status` (`ACTIVE|INACTIVE`, required)

### Read-only vs editable by state/role
- All availability quantities are read-only. (DECISION-INVENTORY-004)
- Pickers are selection-only; no create/update of locations/bins in this story.

### Derived/calculated fields
- None for quantities/ATP (must not compute client-side). (DECISION-INVENTORY-004, DECISION-INVENTORY-016)
- Derived UI-only:
  - `scopeLabel`: ‚ÄúSite‚Äù when `storageLocationId` empty, else ‚ÄúBin‚Äù.

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls

1. **Availability**
- `GET /inventory/availability`
- Query params:
  - `productSku` (required)
  - `locationId` (required)
  - `storageLocationId` (optional)
- Response: plain JSON object (no `{data: ...}` envelope). (DECISION-INVENTORY-002, DECISION-INVENTORY-003)
- Success-with-zeros is valid and must be treated as success. (DECISION-INVENTORY-004)

2. **LocationRef list (picker)**
- `GET /inventory/locations`
- Cursor pagination:
  - request: `pageSize`, `pageToken`
  - response: `items`, `nextPageToken` (shape may be `{ items: [...], nextPageToken: "..." }`; see Open Questions if different). (DECISION-INVENTORY-003)

3. **StorageLocation list (picker)**
- `GET /inventory/storage-locations?locationId=...`
- Cursor pagination as above. (DECISION-INVENTORY-003, DECISION-INVENTORY-007)

### Create/update calls
- none

### Submit/transition calls
- none

### Error handling expectations
- Deterministic error schema (plain JSON). (DECISION-INVENTORY-003)
- Correlation ID:
  - Send `X-Correlation-Id` header on requests; display echoed value on errors. (DECISION-INVENTORY-012)
- Sensitive data:
  - Do not log response payloads containing quantities. (DECISION-INVENTORY-011)

---

## 10. State Model & Transitions

### Allowed states
UI state machine:
- `idle`
- `loading`
- `success`
- `error`
- `timeout`

### Role-based transitions
- Viewing availability requires authentication; authorization enforced by backend and reflected in UI (403 forbidden state). (DECISION-INVENTORY-012)

### UI behavior per state
- `idle`: show form only
- `loading`: show spinner within 100ms; disable Search. (DECISION-INVENTORY-004)
- `success`: render results; allow Copy link
- `error`: render error banner + technical details (correlation ID)
- `timeout`: render timeout message + Retry (no auto-retry loops). (DECISION-INVENTORY-004)

---

## 11. Alternate / Error Flows

1. **Deep-link missing required params**
   - If `productSku` or `locationId` absent: do not auto-run; show form with hint ‚ÄúProvide SKU and Location to search.‚Äù (DECISION-INVENTORY-014)

2. **Storage location mismatch**
   - If deep-link includes `storageLocationId` not belonging to `locationId`:
     - Prefer client prevention by loading storage locations for the selected location and validating membership.
     - If backend returns 422, show field error on `storageLocationId` and clear invalid selection.

3. **No inventory history**
   - Backend returns success with zeros; UI shows zeros and explanatory empty state. (DECISION-INVENTORY-004)

4. **Unauthorized / Forbidden**
   - 401: route to login/session refresh.
   - 403: show forbidden state; do not render stale results. (DECISION-INVENTORY-012)

5. **Timeout**
   - After 8 seconds: show timeout state with Retry; do not auto-refresh. (DECISION-INVENTORY-004)

---

## 12. Acceptance Criteria

### Scenario 1: Manual availability search (site scope)
**Given** I am logged in  
**And** I have access to Inventory Availability  
**When** I select a `locationId` via the Location picker  
**And** I enter a non-empty `productSku`  
**And** I click ‚ÄúSearch‚Äù  
**Then** the UI calls `GET /inventory/availability` via the Moqui proxy with `productSku` and `locationId`  
**And** the UI renders backend-returned `onHand`, `allocated`, and `availableToPromise` without client-side computation.

### Scenario 2: Manual availability search (bin scope)
**Given** I am on the Availability screen with a selected `locationId`  
**When** I select a `storageLocationId` from the Storage Location picker  
**And** I click ‚ÄúSearch‚Äù  
**Then** the UI calls `GET /inventory/availability` including `storageLocationId`  
**And** the results are clearly labeled as bin-scoped.

### Scenario 3: Deep-link auto-run once
**Given** I open `/inventory/availability?productSku=SKU123&locationId=LOC1&storageLocationId=BIN9`  
**When** the screen loads  
**Then** the form is pre-filled from the query params  
**And** the UI automatically runs exactly one availability request  
**And** subsequent reactive updates do not cause repeated auto-runs unless I click ‚ÄúSearch‚Äù again. (DECISION-INVENTORY-014)

### Scenario 4: Success-with-zeros for no history
**Given** the backend returns a successful availability response with `onHand=0`, `allocated=0`, `availableToPromise=0`  
**When** the UI renders the results  
**Then** the UI shows a success state (not an error)  
**And** displays an empty-state message indicating no inventory history at that scope. (DECISION-INVENTORY-004)

### Scenario 5: Validation prevents bad requests
**Given** I have not entered a `productSku` (or it is whitespace-only)  
**When** I attempt to click ‚ÄúSearch‚Äù  
**Then** the UI blocks the request and shows a validation message on the SKU field.

### Scenario 6: Auth and forbidden handling
**Given** my session is expired  
**When** I search availability  
**Then** a 401 response routes me to login/session refresh. (DECISION-INVENTORY-012)

**Given** I lack permission to view availability  
**When** I navigate to the Availability screen or attempt a search  
**Then** the UI shows a forbidden state and does not display any availability data. (DECISION-INVENTORY-012)

### Scenario 7: Sensitive data is not logged
**Given** an availability request succeeds  
**When** the UI records telemetry/logs for the request  
**Then** no numeric quantities from the response are written to console logs or client telemetry. (DECISION-INVENTORY-011)

---

## 13. Audit & Observability

### User-visible audit data
- Error states show `X-Correlation-Id` (if present) in a ‚ÄúTechnical details‚Äù section. (DECISION-INVENTORY-012)

### Status history
- Not applicable (read-only query screen).

### Traceability expectations
- All requests include `X-Correlation-Id`.
- Client-side observability records:
  - route name, timing, HTTP status, correlation ID
  - MUST NOT include quantities or raw payloads. (DECISION-INVENTORY-011)

---

## 14. Non-Functional UI Requirements
- **Performance/UX SLA:** show loading indicator within 100ms; show timeout at 8 seconds with Retry; no auto-refresh loops. (DECISION-INVENTORY-004)
- **Accessibility:** keyboard navigable pickers; form errors announced; focus management on validation errors.
- **Responsiveness:** usable on tablet widths; results layout must remain readable without horizontal scrolling where possible.
- **i18n/timezone:** timestamps (if present) displayed in user locale/timezone; do not alter backend values.

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Standard empty states for ‚Äúno results‚Äù and ‚Äúno history‚Äù; safe because it does not change domain logic. (Impacted: UX Summary, Alternate/Error Flows, Acceptance Criteria)
- SD-UI-DOUBLE-SUBMIT-GUARD: Disable Search while request in-flight; safe UX guardrail. (Impacted: Functional Behavior, State Model)
- SD-ERR-MAP-HTTP: Standard mapping for 401/403/422/5xx and timeout; safe because it follows transport semantics and domain decisions. (Impacted: Business Rules, Error Flows, Observability)
- SD-UI-PAGINATION: Cursor-based pagination UI for pickers when lists are large; safe UI ergonomics only. (Impacted: Service Contracts, UX Summary)

---

## 16. Open Questions

1. **Domain conflict / story mismatch (blocking):** The provided issue content describes ‚ÄúAllocations: Reallocate Reserved Stock‚Ä¶‚Äù, but Inventory domain rules state the frontend must not call allocation/reservation services directly and must treat availability as authoritative (DECISION-INVENTORY-016). Confirm whether this issue should be:
   - (A) rewritten as this Availability view story (current rewrite), **or**
   - (B) moved to a different domain/epic where allocation/reallocation is owned and exposed via inventory endpoints.
2. **Permissions (blocking):** What is the canonical permission string for viewing availability (e.g., `inventory:availability:view`), and how does the frontend discover permissions (existing Moqui user context contract)?
3. **Exact response shapes (blocking for contract tests):**
   - `GET /inventory/availability` exact JSON fields and types (especially naming: `allocated` vs `totalAllocated`, `availableToPromise` vs `atp`).
   - Picker list response shape for cursor pagination (`items` key name, `nextPageToken` key name).

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #87: [FRONTEND] [STORY] Security: Define Inventory Roles and Permission Matrix
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:inventory-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Inventory Security Admin UI + Permission-Gated Inventory Actions (Moqui RBAC Integration)

### Primary Persona
System Administrator (Admin)

### Business Value
Ensure only authorized staff can access inventory administrative security functions and sensitive inventory operations by enforcing permission-based UI gating, and provide auditable visibility into role assignments for compliance and incident review.

---

## 2. Story Intent

### As a / I want / So that
As a System Administrator, I want the frontend to (1) display inventory roles and their permissions, (2) allow assigning/unassigning inventory roles to users where authorized, and (3) gate inventory UI actions based on permissions, so that inventory operations follow least-privilege and are auditable.

### In-scope
- Inventory security administration UI surfaces:
  - View inventory roles and the permission matrix (role ‚Üí permission mapping) (read-only)
  - Assign/unassign roles to users (only if supported by Moqui/security backend contract)
  - View audit history of role assignment changes (who changed what, when), including correlation ID when available
- Frontend permission-aware UI behavior for Inventory screens:
  - Hide/disable protected actions based on effective permissions
  - Handle `401`/`403` consistently (per platform convention)
- Moqui screen(s), forms, transitions, and service calls required for the above, using Moqui as the integration point (no direct Vue ‚Üí external security backend calls).

### Out-of-scope
- Defining or changing backend RBAC framework behavior (server-side enforcement remains authoritative).
- Implementing identity provider (OIDC/HR) integration UI beyond selecting existing users.
- Designing new inventory operational flows beyond gating their existing entry points/actions.
- Creating/maintaining product master data.
- Any inventory quantity/availability computation in the UI.

---

## 3. Actors & Stakeholders
- **System Administrator (primary):** Manages role assignments and reviews audit.
- **Inventory Manager / Controller:** Stakeholder for separation-of-duties expectations.
- **Auditor / Compliance:** Needs audit visibility and traceability.
- **Inventory Users (Receiver, Stock Clerk, Mechanic Picker):** Impacted by UI gating (view vs action).
- **Moqui Security/RBAC services (system actor):** Source of truth for effective permissions, roles, assignments, and audit events.

---

## 4. Preconditions & Dependencies
- User is authenticated via existing Moqui/POS session.
- Frontend can call Moqui endpoints/services same-origin.
- Moqui provides (or will provide) services/endpoints for:
  - Current user effective permissions (or equivalent permission-check mechanism)
  - Roles and role ‚Üí permission mappings (scoped to inventory)
  - User search/lookup
  - User role assignments (read and mutate)
  - Audit log entries for role assignment changes
- Inventory domain permission naming convention is authoritative for inventory-owned permissions (DECISION-INVENTORY-010). This story must not invent new permission strings for inventory operations; it may only reference permissions that exist in the backend contract.
- Cross-domain dependency: Security domain owns RBAC/role assignment/audit event schemas. Inventory domain only defines inventory permission naming conventions and inventory screen gating expectations. This story is therefore **blocked for domain conflict resolution** (see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Inventory ‚Üí Security** (visible only when user has permission to view this admin area; permission key is currently undefined and must be provided by Security domain).
- Deep link route: `/inventory/security` with subroutes:
  - `/inventory/security/role-matrix`
  - `/inventory/security/user-roles`
  - `/inventory/security/role-audit`

### Screens to create/modify
1. **New Screen Tree (Moqui):** `apps/durion/screen/inventory/security/InventorySecurity.xml`
   - Subscreens:
     - `RoleMatrix.xml` (read-only role ‚Üí permission matrix)
     - `UserRoles.xml` (user search + role assignment management)
     - `RoleAudit.xml` (audit log list/detail)
2. **Modify existing Inventory screens** (as needed, limited to inventory domain screens in this repo):
   - Add permission gating to action buttons/menus for inventory-owned actions using canonical permission strings (DECISION-INVENTORY-010) once the permission catalog is confirmed.
   - Ensure consistent `401`/`403` behavior and correlation ID display on errors (DECISION-INVENTORY-012).

### Navigation context
- Inventory Security is an administrative area; it must not appear to users lacking the required permission(s).
- Subscreens must not partially render sensitive data if unauthorized; show a forbidden state.

### User workflows (happy + alternate paths)
**Happy path: View role-permission matrix**
1. Admin opens Inventory ‚Üí Security ‚Üí Role Matrix
2. UI loads roles and their permissions via Moqui service
3. Admin can filter/search roles and permissions (client-side filter only; no domain logic)
4. Admin can open a role detail panel to view full permission keys and descriptions (if provided)

**Happy path: Assign a role to a user**
1. Admin opens User Roles
2. Admin searches for a user
3. Admin selects a user and views assigned roles
4. Admin adds one or more roles and submits
5. UI confirms success and refreshes assignments
6. Admin can navigate to Role Audit and see the change event

**Alternate path: Unauthorized access**
- User without permission visits `/inventory/security` directly ‚Üí show ‚ÄúAccess denied‚Äù and do not load role/assignment/audit data.

**Alternate path: Backend denies action**
- Admin attempts assign/unassign but backend returns 403 ‚Üí show error, refresh assignments, and keep UI consistent.

---

## 6. Functional Behavior

### Triggers
- Route entry to `/inventory/security/*`
- Click actions:
  - ‚ÄúAssign Role‚Äù, ‚ÄúRemove Role‚Äù
  - Audit filter submit
  - Pagination ‚ÄúLoad more‚Äù on audit list
- Inventory operational screens rendering action toolbars/menus (permission gating evaluation)

### UI actions
- Permission bootstrap:
  - On entering Inventory module (or first inventory screen load), load effective permissions (or permission claims) for the current user.
  - Cache in memory for the session; refresh on successful role assignment changes (for the target user view only; current user permissions may not change unless the admin is editing themselves).
- Conditional rendering:
  - Inventory Security nav entry and routes require a ‚Äúsecurity admin view‚Äù permission (exact key TBD by Security domain).
  - Inventory operational actions require inventory permission keys (DECISION-INVENTORY-010) (exact mapping TBD by backend contract).
- Forms:
  - User search form (query string)
  - Role assignment form (multi-select roles, confirm)
  - Role removal action (confirm)
  - Audit filter form (date range, actor, target user, role, outcome)

### State changes
- Client-side state:
  - `effectivePermissions: Set<string>`
  - `roles: Role[]`
  - `rolePermissions: RolePermission[]`
  - `selectedUser: UserSummary | null`
  - `selectedUserRoles: Role[]`
  - `auditFilters`
  - `auditPageToken/nextPageToken` (preferred cursor paging; see Open Questions if backend uses offset)
- No inventory operational state machines are introduced.

### Service interactions
All calls are to Moqui (proxy/integration point), consistent with the platform pattern (DECISION-INVENTORY-002 applied as an integration constraint: UI does not call external services directly).
- Load effective permissions
- Load role-permission matrix
- Search users
- Load user role assignments
- Assign/unassign roles
- Load audit logs (cursor pagination preferred)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- User search:
  - `query` trimmed; if empty, disable submit and show ‚ÄúEnter a name, username, or email‚Äù.
- Role assignment:
  - Target user required.
  - At least one role required for ‚ÄúAssign‚Äù.
  - For removal, role must be currently assigned.
- Date range filters:
  - Enforce `from <= to`; block submit when invalid (per checklist pattern).
- Authoritative validation comes from backend; UI maps field errors when provided.

### Enable/disable rules
- Inventory Security navigation:
  - Visible only if user has the Security-domain-defined permission to view inventory security admin screens (permission key TBD).
- Inventory operational screens:
  - Hide or disable actions when the user lacks the required permission key(s) (DECISION-INVENTORY-010).
  - If hidden vs disabled is not standardized, default to **hide** for destructive actions and **disable with tooltip** for viewable-but-not-allowed actions (UI ergonomics only; does not change backend enforcement).

### Visibility rules
- Do not render role/permission/assignment/audit data if the route is unauthorized.
- Audit payload/details:
  - Show only fields provided by backend; do not attempt to infer or enrich.
  - Correlation ID is displayed when present (DECISION-INVENTORY-012).

### Error messaging expectations
- `401 Unauthorized`: follow app convention (redirect to login/session refresh) (DECISION-INVENTORY-012).
- `403 Forbidden`: show ‚ÄúAccess denied‚Äù (route-level) or ‚ÄúYou don‚Äôt have permission to perform this action.‚Äù (action-level) without leaking data (DECISION-INVENTORY-012).
- `409 Conflict`: show ‚ÄúThis changed since you loaded it. Refresh and try again.‚Äù and reload.
- `422 Validation`: show inline field errors when possible; otherwise show message summary.
- `5xx/network/timeout`: show generic error with retry; timeout UX at 8 seconds with retry affordance (Inventory UX target pattern; DECISION-INVENTORY-004 applied as a general UX constraint).

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Role** (security domain)
- **Permission** (security domain; inventory permission strings follow DECISION-INVENTORY-010)
- **RolePermission** (security domain mapping)
- **UserRole** (security domain mapping)
- **AuditLog / SecurityAuditEvent** (security/audit domain)

> Note: Exact entity names in Moqui may differ; UI binds to Moqui services/view-entities.

### Fields (minimum required for UI)
**Permission**
- `permissionKey` (string, required) e.g., `inventory:ledger:view`
- `description` (string, optional)

**Role**
- `roleId` (string, required)
- `roleName` (string, required)
- `description` (string, optional)

**RolePermission**
- `roleId` (string, required)
- `permissionKey` (string, required)

**UserSummary**
- `userId` (string, required)
- `displayName` (string, required)
- `username` (string, optional)
- `email` (string, optional)

**UserRole**
- `userId` (string, required)
- `roleId` (string, required)
- `fromDate` (datetime, optional)
- `thruDate` (datetime, optional)

**RoleAssignmentAuditEvent**
- `auditId` (string, required)
- `eventType` (string, required) e.g., `security.userRole.assigned`, `security.userRole.removed`
- `actorUserId` (string, required)
- `targetUserId` (string, required)
- `roleId` (string, required)
- `timestamp` (datetime, required)
- `outcome` (string/enum, required)
- `message` (string, optional)
- `correlationId` (string, optional)

### Read-only vs editable by state/role
- Role-permission matrix: read-only.
- User role assignments:
  - Editable only if user has Security-domain-defined permission to manage role assignments (permission key TBD).
- Audit log: read-only.

### Derived/calculated fields
- `hasPermission(permissionKey)` derived from loaded effective permissions list (client-side set membership).
- ‚ÄúEffective permissions‚Äù display is server-calculated; UI does not compute from roles unless backend explicitly provides only roles (Open Question).

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: Security/RBAC service contracts are not provided in the inventory domain rules. Inventory rules only define permission naming conventions and 401/403/correlation behavior. The following contracts are required and must be confirmed by the Security domain / backend story.

### Load/view calls (Moqui endpoints/services)
1. **Get current user effective permissions**
   - Endpoint/service (TBD): `GET /security/me/permissions` or Moqui service equivalent
   - Response (required): `{ permissions: string[] }`
   - Notes:
     - Must support inventory permission keys (DECISION-INVENTORY-010).
     - Must include correlation ID header handling (DECISION-INVENTORY-012).

2. **Get inventory roles + permissions (matrix)**
   - Endpoint/service (TBD): `GET /security/roles?domain=inventory` (or `permissionPrefix=inventory:`)
   - Response (required): `{ roles: Role[], permissions: Permission[], rolePermissions: RolePermission[] }`
   - UI must treat response as read-only.

3. **Search users**
   - Endpoint/service (TBD): `GET /security/users?query=...&pageSize=...&pageToken=...` (cursor preferred) OR offset paging if that is the platform standard
   - Response (required): `{ users: UserSummary[], nextPageToken?: string }` (preferred) OR `{ users: UserSummary[], total?: number }`

4. **Get roles for a user**
   - Endpoint/service (TBD): `GET /security/users/{userId}/roles`
   - Response (required): `{ roles: Role[] }`

5. **Get role assignment audit logs**
   - Endpoint/service (TBD): `GET /security/audit/role-assignments?fromTs=&toTs=&targetUserId=&actorUserId=&roleId=&outcome=&pageSize=&pageToken=`
   - Response (required): `{ audits: RoleAssignmentAuditEvent[], nextPageToken?: string }` (cursor preferred)

### Create/update calls
1. **Assign roles to user**
   - Endpoint/service (TBD): `POST /security/users/{userId}/roles`
   - Request (required): `{ roleIds: string[] }`
   - Response: `200/201` with either updated roles `{ roles: Role[] }` or acknowledgement.

2. **Remove role from user**
   - Endpoint/service (TBD): `DELETE /security/users/{userId}/roles/{roleId}` OR `POST .../remove`
   - Response: acknowledgement.

### Submit/transition calls
- None.

### Error handling expectations
- Deterministic error schema is required for robust field mapping (inventory domain defines deterministic errors for inventory endpoints; for security endpoints this must be confirmed).
- `401`: redirect/session refresh (DECISION-INVENTORY-012).
- `403`: forbidden state; no data leakage (DECISION-INVENTORY-012).
- `409`: show conflict message; reload.
- `422`: map field errors to form fields when possible.
- Timeout at 8 seconds: show retry (DECISION-INVENTORY-004 UX target applied).

---

## 10. State Model & Transitions

### Allowed states
- Security admin UI states (client-side):
  - `idle` ‚Üí `loading` ‚Üí (`success` | `error`)
  - For mutations: `editing` ‚Üí `submitting` ‚Üí (`success` | `error`)

### Role-based transitions
- Not applicable (no workflow state machine). Role assignment is a mutation with audit trail.

### UI behavior per state
- **Loading:** show loader within 100ms; disable submit buttons while in-flight.
- **Success:** render data; show confirmation on mutations.
- **Empty:** show ‚ÄúNo roles found‚Äù, ‚ÄúNo users match your search‚Äù, ‚ÄúNo audit entries match filters‚Äù.
- **Error:** show error summary with correlation ID when available; provide retry.

---

## 11. Alternate / Error Flows

1. **Unauthorized route access**
   - If user lacks required permission for Inventory Security:
     - Do not call role/assignment/audit services.
     - Render forbidden state with link back to Inventory home.

2. **Backend denies assign/unassign (403)**
   - Show denial message.
   - Reload user roles to reflect actual state.

3. **User search returns empty**
   - Show empty state and tips to refine search.

4. **Concurrency conflict (409)**
   - Inform user, reload current roles, require re-apply changes.

5. **Audit service unavailable**
   - Show error on Audit tab only; other tabs remain usable if their calls succeed.

6. **Session expired (401)**
   - Redirect to login/session refresh; after re-auth, return to the attempted route if app convention supports it.

---

## 12. Acceptance Criteria

```gherkin
Scenario: Inventory Security menu is hidden when user lacks admin-view permission
  Given a logged-in user without the permission required to view Inventory Security
  When the user views the Inventory module navigation
  Then the "Security" entry is not shown
  And direct navigation to "/inventory/security" shows "Access denied"
  And no role/assignment/audit data is fetched

Scenario: Role-permission matrix loads for authorized admin
  Given a logged-in Admin with permission to view Inventory Security
  When the Admin opens "/inventory/security/role-matrix"
  Then the UI loads roles and permissions from Moqui services
  And the UI displays roles and their granted permission keys
  And the UI does not allow editing role-permission mappings

Scenario: Assign role to user succeeds and is reflected in UI
  Given a logged-in Admin authorized to assign roles to users
  And a target user exists
  And the role "Inventory Controller" exists
  When the Admin assigns the role "Inventory Controller" to the target user
  Then the UI disables the submit button while the request is in-flight
  And the UI shows the role as assigned after the save completes
  And the UI shows a success confirmation

Scenario: Assign role to user is denied without permission
  Given a logged-in user who can view the role matrix but cannot assign roles
  When the user attempts to assign a role to a target user
  Then the backend returns 403
  And the UI displays an authorization error
  And the UI reloads the target user's roles
  And the UI does not show the role as assigned

Scenario: Protected inventory action is not available without required permission
  Given a logged-in user without permission "inventory:topology:sync:trigger"
  When the user opens the Inventory Topology screen where "Sync now" is available
  Then the "Sync now" action is not shown or is disabled
  And if the user invokes the action and the backend returns 403
  Then the UI shows an authorization error without leaking data

Scenario: Role assignment changes are visible in audit log
  Given an Admin authorized to view role assignment audit logs
  And a role assignment change occurred for a target user
  When the Admin opens "/inventory/security/role-audit" and filters by the target user
  Then the UI lists an audit entry including actor, target, role, timestamp, and outcome
  And if a correlationId is present it is displayed in "Technical details"

Scenario: 401 behavior follows session refresh/login convention
  Given a logged-in user whose session has expired
  When the user opens "/inventory/security/role-matrix"
  Then the backend returns 401
  And the UI routes to login/session refresh per app convention
```

---

## 13. Audit & Observability

### User-visible audit data
- Audit tab shows role assignment events with:
  - Actor identity (userId and displayName if provided)
  - Target user
  - Role
  - Timestamp (rendered in user locale; stored UTC)
  - Outcome/status
  - Correlation ID when provided (DECISION-INVENTORY-012)

### Status history
- For a selected user, show current assigned roles.
- If backend supports it, show role assignment history filtered by `targetUserId` (read-only).

### Traceability expectations
- All requests include/propagate `X-Correlation-Id` header and display it on error states (DECISION-INVENTORY-012).
- Client telemetry/logging must not include sensitive inventory quantities; while this story is security-focused, it must not introduce logging of sensitive payloads (DECISION-INVENTORY-011 applied as a general logging constraint).

---

## 14. Non-Functional UI Requirements
- **Performance:** Initial role matrix render within 2s for up to 200 roles and 500 permissions; if larger, UI must support filtering and avoid rendering huge payloads eagerly.
- **Accessibility:** Keyboard navigable tables/forms; proper labels; focus management for dialogs/confirmations.
- **Responsiveness:** Usable on tablet widths; tables support horizontal scroll.
- **i18n/timezone:** Audit timestamps rendered in local timezone; backend timestamps assumed UTC.
- **Reliability:** Show loading indicator within 100ms; timeout at 8 seconds with retry; no auto-refresh loops (DECISION-INVENTORY-004 UX target).

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Provide standard empty-state messaging for no search results/audit rows; safe because it doesn‚Äôt alter domain logic. (Impacted: UX Summary, Alternate / Error Flows)
- SD-UI-CURSOR-PAGINATION: Prefer cursor pagination (`pageSize`, `pageToken`, `nextPageToken`) for lists; safe because it is a UI ergonomics/performance pattern and aligns with inventory list conventions, but requires backend confirmation for security endpoints. (Impacted: Service Contracts, UX Summary)
- SD-ERR-401-403-MAP: Map HTTP 401 to login/session refresh and 403 to forbidden state without data leakage; safe because it reflects authoritative backend enforcement and is mandated by DECISION-INVENTORY-012. (Impacted: Business Rules, Alternate / Error Flows, Acceptance Criteria)
- SD-OBS-CORRELATION-ID: Display `X-Correlation-Id` in error technical details when present; safe because it is observability-only and mandated by DECISION-INVENTORY-012. (Impacted: Audit & Observability, Error Flows)

---

## 16. Open Questions

1. **Domain ownership conflict (blocking):** This story is labeled `domain:inventory` but the primary capability is RBAC/role assignment/audit (Security domain). Confirm whether:
   - This should be re-labeled to `domain:security`, OR
   - Inventory owns an ‚ÄúInventory Security Admin‚Äù feature area with Security providing services, and inventory is the correct routing label for frontend work.

2. **Permission keys for admin UI (blocking):** What are the exact permission strings that authorize:
   - Viewing Inventory Security screens (role matrix, user roles, audit)?
   - Assigning/unassigning roles?
   - Viewing role assignment audit logs?
   Inventory domain defines inventory permission naming conventions (DECISION-INVENTORY-010) but does not define security-admin permissions.

3. **Moqui service/endpoints contract (blocking):** Provide the actual Moqui endpoints/services and request/response shapes (including pagination and deterministic error schema) for:
   - Current user effective permissions
   - Role-permission matrix (scoped to inventory)
   - User search
   - User role assignments (get/assign/remove)
   - Role assignment audit logs

4. **Role catalog source of truth (blocking):** Are the roles enumerated in the original issue (InventoryManager, Receiver, StockClerk, MechanicPicker, Auditor) canonical, or must the UI support arbitrary roles returned by backend? If both exist, which are assignable vs display-only?

5. **Inventory action gating scope (blocking):** Provide the definitive mapping of inventory UI actions/routes in this repo to permission keys (e.g., which screens/buttons correspond to which `inventory:*` permissions). Without this, gating risks being incomplete or inconsistent.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #81: [FRONTEND] [STORY] Catalog: Search Catalog by Keyword/SKU and Filter
LABELS: domain:inventory,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:inventory-domain-agent
BODY:
## As a / I want / So that
**As a** POS Clerk,  
**I want** to search the catalog by keyword, SKU/MPN, and category and refine results using common filters,  
**So that** I can quickly find and add the correct items during checkout.

## In-scope
- A Moqui screen for catalog search with:
  - Search input supporting keyword, SKU, and MPN entry
  - Category selection (only if a category list contract exists in this frontend; otherwise hidden)
  - Filters: tire size/spec, manufacturer, price range
  - Results list rendering `ProductSummary` including `availabilityHint` (as provided by backend; UI does not compute availability)
  - Cursor-based pagination using `pageToken`/`nextPageToken` (cursor pagination; no total-count dependency)
- Frontend validation for obviously invalid inputs (e.g., negative prices; malformed numeric tire spec fields)
- Handling of empty results, validation errors, unauthorized responses, and service unavailability
- Integration pattern: UI calls Moqui proxy endpoints only (no direct Vue ‚Üí downstream services). (DECISION-INVENTORY-002)

## Out-of-scope
- Adding items to cart/work order/ticket (handled by another story)
- Editing product master data or inventory quantities/costs
- Advanced search syntax (quotes, boolean operators) unless explicitly supported by backend
- Multi-site inventory availability breakdowns (only `availabilityHint` as provided)
- Any inventory ledger/availability screens (separate inventory stories)

---

# 3. Actors & Stakeholders

- **Primary Actor:** POS Clerk
- **System Actors:**
  - Moqui Frontend (Moqui screens + Vue/Quasar components)
  - Moqui proxy layer (same-origin endpoints; session/auth handled by Moqui) (DECISION-INVENTORY-002)
- **Stakeholders:**
  - Product/Catalog domain (SoR for product definitions/categories; consumed by search)
  - Inventory domain (may enrich results with `availabilityHint`; UI treats it as read-only and sensitive if it implies quantities)
  - Work Execution domain (downstream consumer of selected product)

---

# 4. Preconditions & Dependencies

- User is authenticated in the POS frontend.
- A Moqui proxy endpoint exists for catalog search (exact route/service name TBD; see Open Questions).
- Permission/authorization model for accessing catalog search is defined (permission string(s) TBD; see Open Questions).
- Backend search API supports cursor pagination using `pageSize`, `pageToken`, and returns `nextPageToken` (cursor pagination convention). (DECISION-INVENTORY-003)
- Error responses follow deterministic error schema (plain JSON; no `{data: ...}` envelope). (DECISION-INVENTORY-003)
- Correlation ID convention is supported: `X-Correlation-Id` request/response header; UI surfaces it in error technical details. (DECISION-INVENTORY-012)

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Primary: POS navigation menu item ‚ÄúCatalog Search‚Äù.
- Secondary: Deep-link into the same screen with query params prefilled (see Routing below).

## Screens to create/modify
- **Create** a Moqui screen (path/name must follow repo conventions; illustrative only):
  - `apps/pos/screen/catalog/CatalogSearch.xml`
- **Create** a Vue/Quasar component for the search form + results list, embedded in the Moqui screen (consistent with existing frontend architecture).
- **Modify** POS navigation/menu to add a link to the Catalog Search screen.

## Navigation context
- Preserve search state in URL query parameters for refresh/back navigation:
  - `q` (query term)
  - `categoryId` (if supported)
  - `manufacturer` (if supported)
  - `priceMin`, `priceMax`
  - `tireWidth`, `tireAspectRatio`, `tireDiameter`
- Cursor tokens (`pageToken`) MUST NOT be stored in the URL (opaque, potentially long, and can create confusing back/forward behavior). Store cursor in component state only.

## User workflows (happy + alternate paths)

### Happy path (search + paginate)
1. Clerk opens Catalog Search.
2. Clerk enters a query term (keyword or SKU/MPN) and optionally sets filters.
3. Clerk clicks ‚ÄúSearch‚Äù (or presses Enter).
4. UI calls Moqui proxy search endpoint; shows loading state within 100ms.
5. UI renders results list.
6. If `nextPageToken` is present, Clerk clicks ‚ÄúLoad more‚Äù to append results.

### Alternate paths
- Clerk changes filters and clicks ‚ÄúApply/Search‚Äù again:
  - UI resets results and cursor and runs a fresh search.
- Clerk clears filters:
  - UI resets form fields to defaults and clears results (or reruns search if `q` is still present; see Open Questions).
- Empty results:
  - UI shows a ‚ÄúNo results found‚Äù empty state after a successful response with empty items.

---

# 6. Functional Behavior

## Triggers
- Submit search:
  - Enter key in query input OR click ‚ÄúSearch‚Äù.
- Apply filters:
  - Explicit ‚ÄúApply/Search‚Äù action (no auto-apply on every change in v1 to avoid excessive requests; see Open Questions if product wants auto-apply).
- Pagination:
  - Click ‚ÄúLoad more‚Äù when `nextPageToken` is present.

## UI actions
- Inputs:
  - `queryTerm` (free text)
  - `categoryId` (single select; only rendered if category contract exists)
  - `manufacturer` (free text OR select; depends on contract availability)
  - `priceMin`, `priceMax`
  - Tire specs (numeric):
    - `tireWidth`
    - `tireAspectRatio`
    - `tireDiameter`
- Buttons:
  - Search / Apply
  - Clear
  - Load more
  - Retry (shown on error state)
- Result item actions:
  - Optional ‚ÄúView details‚Äù deep-link if a product detail screen exists; otherwise omit.

## State changes (frontend)
- Maintain component state:
  - `form`: current query/filters
  - `results`: `items[]`, `nextPageToken`
  - `loading`: boolean
  - `error`: structured error (message + correlationId + status)
  - `hasSearched`: boolean (to control empty-state visibility)
- On fresh search submit:
  - Validate inputs client-side
  - Set `loading=true`, clear `error`
  - Reset `results.items=[]` and `results.nextPageToken=null`
  - Call search endpoint with `pageToken` omitted
- On ‚ÄúLoad more‚Äù:
  - Validate `nextPageToken` exists
  - Set `loading=true`, clear `error`
  - Call search endpoint with `pageToken=results.nextPageToken`
  - Append returned `items` to existing list
  - Replace `nextPageToken` with returned `nextPageToken`

## Service interactions
- All calls go to Moqui proxy endpoints (same-origin), not directly to downstream services. (DECISION-INVENTORY-002)
- Include `X-Correlation-Id` header on requests; if response includes it, store for display in error technical details. (DECISION-INVENTORY-012)
- Do not log sensitive result data (see Business Rules / Observability). (DECISION-INVENTORY-011)

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Query term:
  - Trim whitespace.
  - Allow empty query term only if at least one filter is provided (category/manufacturer/price/tire specs). If neither query nor filters are provided, block submit with ‚ÄúEnter a search term or choose at least one filter.‚Äù (UI ergonomics; does not change backend semantics.)
- Price range:
  - `priceMin` and `priceMax` must be valid decimals when provided.
  - Must be `>= 0`.
  - If both provided, `priceMin <= priceMax`.
- Tire specs:
  - If provided, must be positive integers.
  - Do not enforce domain ranges/enums (not provided); only syntax-level validation.
- Pagination:
  - Default `pageSize=25`.
  - Cap `pageSize` at 100 client-side if exposed; otherwise keep fixed at 25.
  - Do not depend on `totalItems` being present/accurate; cursor pagination is authoritative. (DECISION-INVENTORY-003)

## Enable/disable rules
- Disable Search/Apply while a request is in-flight.
- Disable Load more when:
  - `loading=true`, OR
  - `nextPageToken` is null/empty.

## Visibility rules
- Empty state (‚ÄúNo results found‚Äù) is shown only when:
  - `hasSearched=true`, `loading=false`, `error=null`, and `results.items.length==0`.
- Category filter is hidden if category list contract is not available (to avoid broken UI).

## Error messaging expectations
- Deterministic error handling:
  - 400/422: show banner ‚ÄúPlease correct the highlighted fields.‚Äù and map field errors if provided by backend error schema. (DECISION-INVENTORY-003)
  - 401: follow app convention for session refresh/login redirect. (DECISION-INVENTORY-012)
  - 403: show forbidden state without leaking any results; do not retry automatically. (DECISION-INVENTORY-012)
  - 5xx/timeout: show ‚ÄúCatalog search is temporarily unavailable. Try again.‚Äù with Retry.
- Correlation ID:
  - If present, show `X-Correlation-Id` in a ‚ÄúTechnical details‚Äù expandable section on error screens. (DECISION-INVENTORY-012)

---

# 8. Data Requirements

## Entities involved (frontend view models)
- `CatalogSearchRequest` (frontend request DTO; maps to backend search contract)
- `CatalogSearchResponse` (frontend response DTO)
- `ProductSummary` (response item)

> Note: Inventory domain decisions define cursor pagination and error schema conventions, but catalog search ownership appears to be Product/Catalog. This story is labeled `domain:inventory` per instruction, but the capability is primarily catalog/product search. See Open Questions / Domain Conflict.

## Fields (type, required, defaults)

### CatalogSearchRequest (frontend ‚Üí Moqui proxy)
- `queryTerm` (string, optional; trimmed)
- `categoryId` (string, optional)
- `filters` (object, optional)
  - `manufacturer` (string, optional; trimmed)
  - `priceMin` (decimal, optional)
  - `priceMax` (decimal, optional)
  - `tireSpecs` (object, optional)
    - `width` (int, optional)
    - `aspectRatio` (int, optional)
    - `diameter` (int, optional)
- `pageSize` (int, optional; default 25; max 100)
- `pageToken` (string, optional; for pagination)

### CatalogSearchResponse (Moqui proxy ‚Üí frontend)
- `items[]` (array<ProductSummary>, required)
- `nextPageToken` (string|null, required)
- `pageSize` (int, optional)
- `warnings[]` (array<string>, optional) ‚Äî if backend provides non-fatal warnings (e.g., availability enrichment degraded)

### ProductSummary (read-only)
- `productId` (string/UUID, required)
- `sku` (string, required)
- `mpn` (string, optional)
- `name` (string, required)
- `descriptionShort` (string, optional)
- `listPrice` (decimal, optional)
- `manufacturer` (string, optional)
- `availabilityHint` (string/enum, optional)

## Read-only vs editable by state/role
- All `ProductSummary` fields are read-only.
- Search inputs are editable in all states except while request is in-flight (disabled to prevent double-submit).

## Derived/calculated fields
- `availabilityBadge` derived from `availabilityHint` mapping (display-only; no computation of quantities/ATP).
- `resultCountLabel` derived from `results.items.length` only (do not rely on `totalItems`).

---

# 9. Service Contracts (Frontend Perspective)

> Inventory domain decisions provide the integration pattern and error/pagination conventions. Exact catalog search endpoint(s) are not defined in the provided inventory docs and must be confirmed.

## Load/view calls
- Optional: categories list (only if contract exists)
  - `GET <TBD>` returning list of `{categoryId, categoryName}` at minimum.

## Create/update calls
- None.

## Submit/transition calls
- Catalog search:
  - `POST <TBD>` (preferred for complex filters) OR `GET <TBD>` (if existing)
  - Request: `CatalogSearchRequest` (plain JSON)
  - Response: `CatalogSearchResponse` (plain JSON)
  - Pagination:
    - First page: omit `pageToken`
    - Next page: send `pageToken` from prior response `nextPageToken`
- Headers:
  - Send `X-Correlation-Id` (generated client-side if not already present in app request wrapper); display returned value on errors. (DECISION-INVENTORY-012)

## Error handling expectations
- Error schema: deterministic JSON error payload (shape TBD but must support message + optional field errors). (DECISION-INVENTORY-003)
- Status handling:
  - 400/422: validation errors (map to fields when possible)
  - 401: session expired ‚Üí login/refresh flow (DECISION-INVENTORY-012)
  - 403: forbidden ‚Üí forbidden state (DECISION-INVENTORY-012)
  - 429: show ‚ÄúToo many requests. Please wait and try again.‚Äù; no auto-retry
  - 5xx/timeout: retryable error UI with manual retry

---

# 10. State Model & Transitions

## Allowed states (screen-level)
- `Idle` (no search executed yet)
- `Loading` (request in-flight)
- `Loaded` (results available; may be empty)
- `Error` (last request failed)

## Role-based transitions
- Authenticated user with required permission(s):
  - `Idle ‚Üí Loading ‚Üí Loaded/Error`
  - `Loaded ‚Üí Loading ‚Üí Loaded/Error` (new search)
  - `Loaded ‚Üí Loading ‚Üí Loaded/Error` (load more)
- Unauthorized/forbidden:
  - `Idle/Loaded ‚Üí Error` with 401/403 handling; no automatic retries

## UI behavior per state
- Idle: show inputs; no empty-state message.
- Loading: show spinner/skeleton; disable submit and load-more.
- Loaded: show results; show load-more only if `nextPageToken` present.
- Error: show error banner/state; keep inputs available; show Retry.

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- `priceMin > priceMax`:
  - Block submit; show inline error on both fields.
- Negative price:
  - Block submit; show inline error.
- Tire spec non-integer or <= 0:
  - Block submit; show inline error on the specific field.
- Empty query and no filters:
  - Block submit; show inline error near query input.

## Validation failures (server-side 400/422)
- If backend returns field errors:
  - Map to corresponding fields (`queryTerm`, `categoryId`, `manufacturer`, `priceMin`, `priceMax`, `tireSpecs.width/aspectRatio/diameter`).
- If backend returns only a message:
  - Show banner with message; keep form state intact.

## Concurrency conflicts
- Not applicable (read-only search).

## Unauthorized access
- 401:
  - Trigger standard session refresh/login redirect per app convention; after re-auth, user can retry.
- 403:
  - Show forbidden state; do not display cached results from prior searches in the same session after a 403 response.

## Empty states
- Successful response with `items=[]`:
  - Show ‚ÄúNo results found. Try a different keyword or clear filters.‚Äù
- Categories unavailable:
  - Hide category filter (do not show a broken dropdown).

---

# 12. Acceptance Criteria

## Scenario: Keyword search returns matching products
**Given** the POS Clerk is on the Catalog Search screen and is authorized to use it  
**When** the Clerk enters a keyword and submits the search  
**Then** the UI calls the Moqui proxy catalog search endpoint with the trimmed keyword  
**And** the UI renders returned `items` as `ProductSummary` rows/cards

## Scenario: Exact SKU search returns an exact match (backend-defined ordering)
**Given** the POS Clerk is on the Catalog Search screen and is authorized to use it  
**When** the Clerk enters an exact SKU and submits the search  
**Then** the UI renders a result list that includes a product with that SKU  
**And** the UI does not implement client-side re-ordering of results

## Scenario: Manufacturer filter restricts results
**Given** the POS Clerk is on the Catalog Search screen and is authorized to use it  
**When** the Clerk sets `manufacturer` and submits the search  
**Then** the UI sends `filters.manufacturer` in the request  
**And** the UI renders only the items returned by the backend without additional client-side filtering

## Scenario: Price range validation prevents invalid submission
**Given** the POS Clerk entered `priceMin` greater than `priceMax`  
**When** the Clerk submits the search  
**Then** the UI blocks the request  
**And** displays an inline validation error indicating the range is invalid

## Scenario: Cursor-based pagination loads next page
**Given** a successful search response includes a non-null `nextPageToken`  
**When** the Clerk clicks ‚ÄúLoad more‚Äù  
**Then** the UI calls the search endpoint with `pageToken=nextPageToken`  
**And** appends the returned `items` to the existing results  
**And** updates `nextPageToken` to the new value from the response

## Scenario: Default page size is applied
**Given** the POS Clerk submits a search without changing page size  
**When** the UI calls the search endpoint  
**Then** the request uses `pageSize=25` (either explicitly or by omitting it if backend defaults to 25)  
**And** the UI renders up to 25 items for the first page

## Scenario: No results displays empty state
**Given** the POS Clerk submits a valid search  
**When** the response returns `items=[]` and `nextPageToken=null`  
**Then** the UI displays a ‚ÄúNo results found‚Äù empty state  
**And** does not show ‚ÄúLoad more‚Äù

## Scenario: Backend validation error is actionable
**Given** the POS Clerk submits a search request the backend rejects  
**When** the backend responds with HTTP 400 or 422 and a deterministic error payload  
**Then** the UI displays the error message  
**And** maps any field errors to the corresponding inputs when present  
**And** keeps the form values for correction

## Scenario: Unauthorized and forbidden responses follow platform behavior
**Given** the POS Clerk submits a search  
**When** the backend responds with 401  
**Then** the UI triggers the standard login/session refresh flow per app convention  
**When** the backend responds with 403  
**Then** the UI shows a forbidden state and does not leak prior results

## Scenario: Timeout/5xx shows retryable error with correlation ID
**Given** the POS Clerk submits a search  
**When** the request times out (8 seconds) or the backend returns HTTP 5xx  
**Then** the UI displays a retryable error state  
**And** shows the `X-Correlation-Id` in technical details when available  
**And** does not log result quantities or raw payloads

---

# 13. Audit & Observability

## User-visible audit data
- Not required (read-only search).

## Status history
- Not required.

## Traceability expectations
- Correlation:
  - Include `X-Correlation-Id` on requests and surface it on error UI. (DECISION-INVENTORY-012)
- Client telemetry/logging:
  - Do **not** log returned availability quantities (if any) or any raw payload blobs. (DECISION-INVENTORY-011)
  - Log only:
    - request start/end timestamps
    - HTTP status class (2xx/4xx/5xx)
    - correlation ID
    - pagination actions (fresh search vs load more)
  - Treat `queryTerm` as potentially sensitive; do not log it until policy is confirmed (see Open Questions).

---

# 14. Non-Functional UI Requirements

- **Performance:**
  - Show loading indicator within 100ms of submission.
  - Timeout UX at 8 seconds with Retry; no auto-refresh loops. (DECISION-INVENTORY-004 UX target applied as general POS behavior)
- **Accessibility:**
  - All inputs have labels.
  - Keyboard submit supported.
  - Loading state announced (ARIA).
  - Results list navigable via keyboard.
- **Responsiveness:**
  - Works on standard POS resolutions; filters usable on narrower widths (collapse/accordion allowed).
- **i18n/timezone/currency:**
  - Format `listPrice` using app locale/currency defaults; do not assume currency code.

---

# 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE-01**: Standard ‚ÄúNo results found‚Äù empty state after successful search with 0 items; safe UI ergonomics. Impacted sections: UX Summary, Alternate/Error Flows, Acceptance Criteria.  
- **SD-UX-PAGINATION-02**: Cursor pagination uses `pageToken`/`nextPageToken` and avoids `totalCount`; safe because inventory domain mandates cursor pagination conventions for list endpoints. Impacted sections: Data Requirements, Service Contracts, Acceptance Criteria.  
- **SD-ERR-MAP-01**: Standard mapping for 400/401/403/5xx/timeout to banner/forbidden/retry UX; safe generic error handling. Impacted sections: Business Rules, Error Flows, Acceptance Criteria.  
- **SD-UX-DOUBLE-SUBMIT-01**: Disable submit/load-more while in-flight to prevent duplicate requests; safe UX ergonomics. Impacted sections: Functional Behavior, State Model.  

---

# 16. Open Questions

1. **STOP (Blocking / Domain Conflict): Which domain owns ‚ÄúCatalog Search‚Äù in this repo (Product/Catalog vs Inventory)?** The story is labeled `domain:inventory` but the capability is catalog search; inventory decisions only cover proxy/error/pagination conventions. Confirm correct `domain:*` label and owning agent.  
2. **STOP (Blocking): What is the exact Moqui proxy route and/or service name for catalog search (method + path), and the exact request/response JSON shapes?** This is required to implement Moqui `transition` wiring and frontend API client calls.  
3. **STOP (Blocking): What permission string(s) gate access to Catalog Search and any related endpoints?** Inventory permissions are defined for topology/feedops/ledger, but not for catalog search.  
4. **STOP (Blocking): Category filter contract:** Is there an endpoint/service to list categories? What fields are returned (`categoryId`, `name`), and is hierarchy required? If not available, confirm category filter should be omitted in v1.  
5. **Tire specs filter contract:** Are `width/aspectRatio/diameter` the only supported fields? If more exist (load index, speed rating, season, run-flat), provide allowed values/ranges/enums so UI can validate and render controls.  
6. **Logging policy for search terms:** Should `queryTerm` be treated as sensitive and excluded from client logs/telemetry? (Inventory domain already treats quantities/payloads as sensitive; confirm for search terms.)

