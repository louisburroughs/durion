════════════════════════════════════════
ISSUE #236: [FRONTEND] [STORY] Estimate: Calculate Taxes and Totals on Estimate
LABELS: type:story,status:draft,blocked:clarification,risk:incomplete-requirements,domain:pricing,agent:story-authoring,agent:pricing
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Estimate: Calculate Taxes and Totals on Estimate

### Primary Persona
Service Advisor (POS user) viewing and editing an Estimate

### Business Value
Ensure estimates always display accurate, up-to-date subtotal, taxes, fees, discounts, and grand total with an auditable calculation snapshot, preventing approval when required tax configuration is missing.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** estimate totals (subtotal, taxes, fees, discounts, grand total) to recalculate automatically whenever estimate line items change,  
**so that** I can confidently present correct pricing to customers and the system can retain a reproducible calculation snapshot for disputes and downstream processes.

### In-Scope
- Frontend behavior to trigger totals/tax recalculation when estimate line items are created/modified/deleted (parts/labor/fees/discounts).
- Display of calculated totals and per-line tax/taxability feedback **as returned by backend**.
- Display and navigation to view the latest **Calculation Snapshot** (read-only) associated to the estimate.
- Frontend blocking behavior to prevent proceeding to “Approval” (or equivalent) when backend indicates missing required tax configuration (per policy and error codes).
- Clear error states for missing tax code / missing jurisdiction configuration.
- Idempotency handling for user-triggered mutations (line item save/delete; approval submit) via `Idempotency-Key` header (DECISION-INVENTORY-012).

### Out-of-Scope
- Implementing the tax/fee/discount calculation logic itself (owned by backend pricing/tax services).
- Creating or editing TaxRule/FeeRule configuration.
- Defining rounding policy, default tax code policy, or tax-inclusive vs tax-exclusive behavior (must be provided by backend contract/policy).
- Invoice generation/accounting posting.
- Workexec estimate lifecycle/state machine definition (consumed, not defined here).

---

## 3. Actors & Stakeholders
- **Primary User Actor:** Service Advisor
- **System Actor:** Pricing/Tax calculation service (invoked via Moqui service calls from frontend screens)
- **Stakeholders:**
  - Store Manager (needs reliable totals before approval)
  - Accounting/Audit stakeholders (need snapshot traceability)
  - Workexec domain owners (estimate lifecycle and transitions)
  - Security domain owners (capabilities/permissions signaling; enforced server-side)

---

## 4. Preconditions & Dependencies

### Preconditions
- An Estimate exists and is open in a mutable state (e.g., Draft).
- Estimate has a location/jurisdiction context (directly or indirectly via location on the estimate).
- Estimate has 0..N line items.

### Dependencies (Blocking if undefined)
- A backend endpoint/service to “calculate totals” for an estimate and return:
  - Updated totals (subtotal, taxTotal, feeTotal, discountTotal, grandTotal, roundingAdjustment)
  - Per-line tax info (at minimum taxAmount and/or taxCode/taxability result)
  - A `calculationSnapshotId` (or equivalent) for audit
  - Deterministic error codes for missing configuration (e.g., `ERR_CONFIG_JURISDICTION_MISSING`, `ERR_MISSING_TAX_CODE`)
  - Standard error envelope: `{ code, message, correlationId, fieldErrors?, existingResourceId? }` (DECISION-INVENTORY-011)
- A backend read endpoint/service to load calculation snapshot details for display.
- Estimate state transition endpoint/service for “Proceed to Approval” (or equivalent) that will fail if tax configuration is missing.
- Capability/permission signaling source (user context endpoint or session claims) to gate UI actions; backend remains authoritative with 403 (DECISION-INVENTORY-013).

---

## 5. UX Summary (Moqui-Oriented)

### Entry Points
- From Estimate edit/detail screen where line items are added/edited (parts/labor/fees/discounts).
- From Estimate totals summary section.

### Screens to Create/Modify
1. **Modify:** `durion-workexec/EstimateEdit.xml` (canonical per DECISION-INVENTORY-002)
   - Add/extend totals summary region to show:
     - Subtotal
     - Discount total
     - Fee total
     - Tax total
     - Rounding adjustment (visibility rule below)
     - Grand total
     - “Last calculated at” timestamp (if provided) and “Snapshot ID” link
     - “Totals status”: Up-to-date / Recalculating / Needs attention
   - Hook line item create/update/delete actions to trigger recalculation.
2. **Create (if not existing):** `durion-workexec/EstimateCalculationSnapshotView.xml`
   - Read-only view of the latest snapshot associated with the estimate.
   - If backend supports historical snapshots, show a selectable list; otherwise show latest only.

### Navigation Context
- `EstimateEdit` includes a link/button “View Calculation Details” which routes to:
  - `EstimateCalculationSnapshotView?estimateId=<id>&snapshotId=<id>`
- If `snapshotId` is absent, the link is disabled and a tooltip/help text indicates “No calculation snapshot available yet”.

### User Workflows (Happy + Alternate Paths)
#### Happy Path
1. User adds/edits/removes a line item.
2. UI saves the line item change (existing workexec estimate item service).
3. UI triggers totals recalculation for the estimate.
4. UI refreshes totals and displays new values + snapshot link.

#### Alternate Paths
- User changes multiple line items quickly:
  - UI serializes recalculation requests and shows “Recalculating…” state.
  - UI ensures the totals displayed correspond to the latest successful calculation response.
- Backend returns a configuration error:
  - UI shows a blocking banner and disables “Proceed to Approval”.
  - UI keeps line item editing available (unless estimate state is non-editable).
- Backend returns 409 conflict:
  - UI prompts user to reload estimate and retries calculation after reload.

---

## 6. Functional Behavior

### Triggers
- After successful create/update/delete of any Estimate line item (parts/labor/fees/discounts), trigger a totals recalculation for that estimate.
- On initial load of `EstimateEdit`, load and display current totals and the latest snapshot reference (if any).
- On explicit user action “Recalculate totals” (optional UI affordance), trigger recalculation even if no line item changed (useful after resolving configuration).

### UI Actions
- Line item form submit (create/update):
  - Send mutation with `Idempotency-Key`.
  - On success: trigger recalculation.
- Line item delete:
  - Confirm delete.
  - Send delete with `Idempotency-Key`.
  - On success: trigger recalculation.
- “Proceed to Approval” action:
  - Calls the estimate transition/submit service with `Idempotency-Key`.
  - If backend indicates missing tax config or totals invalid, show actionable error and remain in current state.

### State Changes (Frontend-visible)
- Totals panel state machine:
  - `idle` → `recalculating` → `updated`
  - `recalculating` → `blocked_config` (missing config)
  - `recalculating` → `error` (other errors)
- Approval readiness indicator:
  - `ready` only when latest calculation succeeded and backend indicates no blocking config errors
  - `blocked` when latest calculation failed with blocking config errors
  - `unknown/stale` when calculation has not yet run in this session and no totals are loaded (should be rare if totals are loaded on screen entry)

### Service Interactions
- After line item change: call backend “calculate totals” service with `estimateId`.
- After calculation: refresh estimate view model with returned totals and snapshot id.
- Snapshot view: call backend “get snapshot details” service by `snapshotId` (and/or `estimateId`).

---

## 7. Business Rules (Translated to UI Behavior)

> Monetary/tax logic is authoritative in backend; frontend enforces workflow gating and messaging based on backend responses.

### Validation
- UI must treat totals as **backend-derived** and must not compute taxes/totals client-side.
- If backend returns `ERR_CONFIG_JURISDICTION_MISSING`:
  - UI displays a blocking banner stating tax configuration is missing for the estimate’s jurisdiction/location.
  - UI disables “Proceed to Approval” until a successful recalculation occurs.
- If backend returns `ERR_MISSING_TAX_CODE`:
  - UI displays a blocking banner and (if backend provides per-line field errors) highlights affected line(s).
  - UI disables “Proceed to Approval” until resolved and recalculation succeeds.
- If backend returns field-level validation errors for line items (e.g., quantity/unitPrice invalid):
  - UI shows inline field errors when possible; otherwise show a banner with `code` and `correlationId`.

### Enable/Disable Rules
- Disable “Proceed to Approval” when:
  - Totals recalculation is in progress.
  - Latest calculation attempt failed due to missing tax configuration or missing tax code.
  - User lacks capability to submit estimate for approval (capability flag; backend enforces with 403).
- Disable “View Calculation Details” when no `calculationSnapshotId` is available.

### Visibility Rules
- Show “Rounding adjustment” row only when non-zero **and** backend returns the field (do not invent).
- Show per-line tax amount only when backend provides it (do not derive).
- Show “Totals status” indicator whenever totals are not in `updated` state.

### Error Messaging Expectations
- Errors must display:
  - A concise title
  - Backend-provided `code`
  - `correlationId` (for support)
  - User action guidance (e.g., “Contact admin to configure tax jurisdiction for this location.”)
- Do not expose stack traces or sensitive details.

---

## 8. Data Requirements

### Entities Involved (Frontend-consumed)
- `Estimate` (workexec-owned estimate lifecycle; pricing consumes for calculation)
- `EstimateItem` (parts/labor/fees/discounts)
- `CalculationSnapshot` (read-only view)
- (Referenced configuration entities like `TaxRule`, `FeeRule` are not edited here)

### Fields (Type, Required, Defaults)

#### Identifier handling (binding)
- All IDs are **opaque strings**; UI must not validate as UUID/numeric (DECISION-INVENTORY-003).

#### Estimate (view model)
- `estimateId` (string/id, required)
- `locationId` (string/id, required for tax jurisdiction context; may be implicit but must be present in loaded model)
- `subtotal` (decimal, required display when available)
- `taxTotal` (decimal, required display when available)
- `feeTotal` (decimal, required display when available)
- `discountTotal` (decimal, required display when available)
- `roundingAdjustment` (decimal, optional display)
- `grandTotal` (decimal, required display when available)
- `calculationSnapshotId` (string/id, optional)
- `totalsCalculatedAt` (datetime, optional)
- `currencyUomId` or `currencyCode` (string, **blocking**: must be confirmed if provided/required)

#### EstimateItem (minimum for triggering calc and display)
- `estimateItemId` (string/id, required)
- `itemType` (enum: PART|LABOR|FEE|DISCOUNT, required)
- `quantity` (decimal, required; UI must not assume integer-only)
- `unitPrice` (decimal, required)
- `taxCode` (string, optional/required depends on policy)
- `taxAmount` (decimal, optional—backend-derived)
- `isTaxable` (boolean, optional—backend-derived)

#### CalculationSnapshot (read-only)
- `snapshotId` (string/id, required)
- `estimateId` (string/id, required)
- `calculationTimestamp` (datetime, required)
- `inputLineItems` (structured/JSON, required)
- `appliedRules` (structured/JSON, required)
- `outputSubtotal`, `outputTaxTotal`, `outputFeeTotal`, `outputDiscountTotal`, `outputGrandTotal`, `outputRoundingAdjustment` (decimal, required)

### Read-only vs Editable by State/Role
- All totals fields are **read-only** in UI (backend-calculated).
- Calculation snapshot is **read-only**.
- Line items editable only in estimate mutable states (exact states are workexec-owned; dependency).

### Derived/Calculated Fields
- All totals and tax amounts are derived from backend calculation results; frontend must not compute.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui naming is provisional; exact service names/paths must align to implemented Moqui services or REST resources. Errors must conform to standard envelope (DECISION-INVENTORY-011). UI must send `Idempotency-Key` for mutations (DECISION-INVENTORY-012).

### Load/View Calls
- Load estimate edit model (screen auto-load or REST):
  - Input: `estimateId`
  - Output: estimate header, line items, latest totals, `calculationSnapshotId`, `totalsCalculatedAt`, and currency indicator if applicable.
- Load calculation snapshot:
  - Input: `snapshotId` (and optionally `estimateId` for authorization scoping)
  - Output: snapshot detail DTO.

### Create/Update Calls
- Estimate item create/update/delete (existing workexec services):
  - Must accept `Idempotency-Key` header for create/update/delete.
  - On success, UI triggers recalculation.

### Submit/Transition Calls
- Calculate totals:
  - Request: `{ estimateId }` (plus optional flags like `includeLineTaxBreakdown=true` if supported)
  - Response: totals + `calculationSnapshotId` + optional per-line tax breakdown + `totalsCalculatedAt`
  - Errors (examples; exact codes must be confirmed):
    - `ERR_CONFIG_JURISDICTION_MISSING` (blocking)
    - `ERR_MISSING_TAX_CODE` (blocking unless policy says default)
    - `VALIDATION_ERROR` with `fieldErrors[]`
    - `CONFLICT` (409) with `code=CONFLICT` and `correlationId`
- Proceed to approval:
  - Request: `{ estimateId }` (and any required transition params)
  - Must fail with blocking error if tax config missing or totals invalid.

### Error Handling Expectations
- Normalize all errors to the standard envelope:
  - `code` (string)
  - `message` (string)
  - `correlationId` (string)
  - `fieldErrors[]` (optional: `{ field, message, code? }`)
  - `existingResourceId` (optional; used for duplicates where applicable)
- UI mapping:
  - 400 with `fieldErrors` → inline errors + banner summary
  - 409 → reload prompt
  - 401 → login
  - 403 → not authorized screen/message
  - 5xx → retry banner with `correlationId`

---

## 10. State Model & Transitions

### Allowed States (Estimate)
- Workexec owns estimate lifecycle; UI must respect backend-provided editability flags or status.
- Minimum assumed states from customer approval workflow doc (backend reference; must be confirmed in Moqui workexec):
  - `DRAFT` (editable)
  - `APPROVED` (likely non-editable)
  - `DECLINED` (may be editable via reopen)
  - `EXPIRED` (non-editable)
- **Blocking:** exact Moqui status IDs and transition names must be confirmed for this frontend repo.

### Role-based Transitions
- Service Advisor can trigger “Proceed to Approval” from editable state(s) only.
- If user lacks permission/capability, UI hides/disables the action and backend enforces with 403 (DECISION-INVENTORY-013).

### UI Behavior per State
- Editable states:
  - Line items editable
  - Recalculation auto-triggers after mutations
- Non-editable states:
  - Line items read-only
  - Totals read-only
  - Snapshot view remains accessible if `calculationSnapshotId` exists

---

## 11. Alternate / Error Flows

### Validation failures
- Backend rejects line item save:
  - Keep user on edit form
  - Show field-level errors when provided
  - Do not trigger recalculation
- Backend rejects recalculation:
  - Totals panel shows `blocked_config` or `error` state
  - “Proceed to Approval” disabled when blocking

### Concurrency conflicts
- If recalculation returns 409:
  - Show banner: “Estimate changed elsewhere. Reload to continue.”
  - Provide “Reload” action that refreshes estimate + line items + totals
  - After reload, UI may auto-trigger recalculation once (optional) to ensure freshness

### Unauthorized access
- 401:
  - Redirect to login
- 403:
  - Show not-authorized message and hide privileged actions
  - Do not reveal tax configuration details beyond generic “Not authorized”

### Empty states
- Estimate with zero line items:
  - Show “No items yet”
  - Totals display as returned by backend (if provided) or as placeholders until first calculation
  - Snapshot link disabled

---

## 12. Acceptance Criteria

### Scenario 1: Totals recalculate after adding a taxable part line
**Given** an Estimate in an editable state is open in the Estimate Edit screen  
**When** the user adds a new PART line item and saves successfully  
**Then** the UI triggers a totals calculation for that estimate  
**And** the totals panel updates to display the returned subtotal, tax total, fee total, discount total, rounding adjustment (if provided), and grand total  
**And** the UI displays a link to the returned `calculationSnapshotId`

### Scenario 2: Totals recalculate after modifying an existing labor line
**Given** an Estimate with existing line items is open  
**When** the user edits a LABOR line item and saves successfully  
**Then** the UI triggers a totals calculation  
**And** the totals panel reflects the updated totals returned by the backend

### Scenario 3: Mixed taxable and non-taxable items display backend totals without client computation
**Given** an Estimate contains at least two line items  
**And** the backend determines one line is taxable and one line is non-taxable  
**When** recalculation completes successfully  
**Then** the UI displays the tax total exactly as returned by the backend  
**And** the UI does not compute or override tax values locally

### Scenario 4: Missing jurisdiction configuration blocks approval
**Given** an Estimate is associated with a location/jurisdiction with no configured tax rules  
**When** the user saves a line item and recalculation is triggered  
**And** the backend responds with `code=ERR_CONFIG_JURISDICTION_MISSING`  
**Then** the UI shows a blocking banner indicating tax configuration is missing  
**And** the “Proceed to Approval” action is disabled with a clear reason  
**And** the banner includes the backend `correlationId`

### Scenario 5: Calculation snapshot is viewable and read-only
**Given** an Estimate has a `calculationSnapshotId` displayed  
**When** the user selects “View Calculation Details”  
**Then** the system navigates to the snapshot view screen  
**And** the snapshot screen loads and displays calculation timestamp, inputs, applied rules, and output totals as read-only data

### Scenario 6: Missing tax code blocks approval and highlights affected lines when provided
**Given** a line item requires a tax code but none is present  
**When** recalculation is triggered  
**And** the backend responds with `code=ERR_MISSING_TAX_CODE`  
**Then** the UI shows a blocking banner including the error code and `correlationId`  
**And** if the backend provides `fieldErrors` referencing specific line items/fields, the UI highlights those fields/lines  
**And** “Proceed to Approval” remains disabled until a successful recalculation occurs

### Scenario 7: Idempotency prevents duplicate submits on double-click
**Given** the user double-clicks “Save” on a line item quickly  
**When** the UI sends the save request with an `Idempotency-Key` and retries with the same key  
**Then** the backend returns a single logical outcome  
**And** the UI triggers recalculation at most once for the successful outcome

---

## 13. Audit & Observability

### User-visible audit data
- Display `calculationSnapshotId` and `totalsCalculatedAt` (if provided) on `EstimateEdit`.
- Snapshot view provides read-only breakdown sufficient for disputes.

### Status history
- If backend provides historical snapshots, show them in chronological order; otherwise show latest only.

### Traceability expectations
- Every successful recalculation must return a snapshot id and the UI must surface it.
- UI must surface `correlationId` from error envelope in banners/modals.
- UI must not log sensitive rule payloads; only log `correlationId`, `estimateId`, and `snapshotId` at debug level (if client logging exists).

---

## 14. Non-Functional UI Requirements

- **Performance:** Recalculation must not block editing; totals panel shows loading state. Serialize recalculation calls to avoid races.
- **Accessibility:** Error banners use `aria-live="polite"`; disabled actions include accessible reason text.
- **Responsiveness:** Works on tablet and desktop.
- **i18n/timezone/currency:** Monetary values must be formatted using the estimate currency indicator when provided; timestamps displayed in user timezone (DECISION-INVENTORY-016 for user-display semantics).

---

## 15. Applied Safe Defaults
- SD-UX-1 (Empty State): Show “No items yet” and disable snapshot link when no snapshot exists; safe as presentational only. Impacted sections: UX Summary, Alternate/Empty States.
- SD-UX-2 (Serialize Requests): Serialize recalculation calls and ignore out-of-order responses; safe as it prevents UI races without changing business logic. Impacted sections: Functional Behavior, Non-Functional Performance.
- SD-ERR-1 (Standard Error Mapping): Map 401→login, 403→not authorized, 409→reload prompt, 5xx→generic retry banner; safe as transport-level handling aligned to standard envelope. Impacted sections: Error Flows, Service Contracts.

---

## 16. Open Questions

1. **Domain ownership/label correction (blocking):** This story is primarily pricing/tax calculation behavior and UI gating; confirm it should be `domain:pricing` (not `domain:workexec`). If workexec must own the screen change, confirm cross-domain ownership expectations and whether to split into two stories (workexec screen wiring vs pricing calculation contract).
2. **Exact Moqui artifacts (blocking):** Confirm the actual screen names/paths in this repo for estimate editing and where totals panel should live (expected: `durion-workexec/EstimateEdit.xml` per DECISION-INVENTORY-002, but must be verified).
3. **Backend contract (blocking):** Provide exact service names/REST endpoints and DTO schemas for:
   - calculate totals for estimate
   - load calculation snapshot details
   - proceed-to-approval transition  
   Include definitive error `code` list and `fieldErrors` shape.
4. **Missing tax code policy (blocking):** Is the policy to fail calculation (`ERR_MISSING_TAX_CODE`) or apply a default tax code? If defaulting is allowed, how is it represented in snapshot/audit and UI (warning vs silent)?
5. **Tax-inclusive vs tax-exclusive (blocking):** Which modes must frontend support now, and how does backend indicate the mode for an estimate/location?
6. **Currency source (blocking if multi-currency):** Does estimate payload include `currencyUomId/currencyCode`? If not, what is the authoritative source for currency formatting?

════════════════════════════════════════
ISSUE #161: [FRONTEND] [STORY] Promotions: Create Promotion Offer (Basic)
LABELS: type:story,status:draft,blocked:clarification,risk:incomplete-requirements,domain:pricing,agent:story-authoring,agent:pricing-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Promotions Admin: Create Promotion Offer (Basic)

### Primary Persona
Account Manager

### Business Value
Enable Account Managers to create and manage simple promotions with valid date ranges and unique codes so downstream estimate/work order flows can retrieve applicable active promotions deterministically and auditably.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Account Manager  
- **I want** to create a basic Promotion Offer with code, discount type, discount value, validity window, and optional usage limit; and activate/deactivate it  
- **So that** eligible customers can have that promotion applied to estimates/work orders when the promotion is active and within its valid dates

### In-scope
- Promotion Offer create (initially non-active)
- Promotion Offer view (details)
- Promotion Offer activate / deactivate actions
- Frontend validations that are deterministic from Pricing rules (code constraints, date range, required fields, non-negative numeric values)
- Handling backend uniqueness errors for promotion code
- Moqui screen/form/service wiring for the UI (screens, transitions, service calls)

### Out-of-scope
- Defining or editing promotion eligibility rules (DECISION-PRICING-009 governs evaluation, but authoring is out of scope)
- Applying promotions to estimates/work orders (consumption use-case)
- Promotion stacking/combination logic beyond “single promotion per estimate” (DECISION-PRICING-008)
- Approval workflows/guardrails for promotions
- Bulk import/export of promotions
- Editing an existing promotion’s fields (separate story)

---

## 3. Actors & Stakeholders
- **Account Manager (primary user):** creates and manages promotions.
- **Pricing domain maintainers:** ensure promotions are created with correct constraints and are auditable.
- **Work Execution (downstream consumer):** queries/uses active promotions (integration point; not implemented here).
- **Store/Location managers (stakeholder):** care about store-scoped promotions.
- **Compliance/Audit (stakeholder):** expects status changes and code uniqueness to be traceable.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend.
- User has permission to manage promotions (**blocking**: exact permission strings must be confirmed; see Open Questions).

### Dependencies
- Pricing backend endpoints/services exist (or will be implemented) to:
  - Create `PromotionOffer`
  - Fetch `PromotionOffer` by ID
  - Activate/deactivate (or end-date) a promotion
  - Enforce unique `promotionCode` (case-insensitive) and code immutability (DECISION-PRICING-007)
  - Validate date range and numeric constraints server-side

### Cross-domain dependencies (read-only)
- Store/location reference data for scoping promotions (**blocking**: source-of-truth and shape for “store scope” selection; see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- POS backoffice → Admin → Pricing → Promotions → “Create Promotion”
- Promotions list → “New Promotion”

### Screens to create/modify
1. **PromotionOfferList** (create if missing)
   - Lists existing PromotionOffers with basic filters (code, status, effective window).
2. **PromotionOfferCreate** (new)
   - Form to create a new PromotionOffer.
3. **PromotionOfferDetail** (new)
   - Read-only details + Activate/Deactivate actions + audit/history section (if available).

> Routing/screen location must follow the nearest existing admin screen convention in the repo (DECISION-PRICING-015). If no Pricing admin section exists, add a “Pricing” admin menu section and place Promotions under it.

### Navigation context
- After successful create: redirect to `PromotionOfferDetail?promotionOfferId=<id>`
- From detail: “Back to Promotions” link to list

### User workflows (happy + alternate paths)

#### Happy path: create (initially non-active)
1. Account Manager opens Create Promotion screen.
2. Enters: code, description, scope (store/location), validity window, discount type, discount value, optional usage limit.
3. Clicks “Create”.
4. System creates promotion (initial status returned by backend; UI does not assume).
5. UI navigates to detail screen.

#### Happy path: activate
1. On detail screen, user clicks “Activate”.
2. Backend transitions promotion to active (or returns validation error if not allowed).
3. UI refreshes and reflects updated status; buttons update.

#### Happy path: deactivate
1. On detail screen, user clicks “Deactivate”.
2. Backend deactivates (prefer end-dating semantics where applicable; DECISION-PRICING-016 is normative for effective-dated entities, but promotion deactivation mechanism must match backend contract).
3. UI refreshes and reflects updated status.

#### Alternate: duplicate code
- Backend rejects create; UI shows field error on code and keeps user-entered values.

#### Alternate: invalid date window
- UI blocks submit client-side; if backend rejects, UI maps field errors.

---

## 6. Functional Behavior

### Triggers
- Navigate to Promotions list
- Navigate to Create Promotion
- Submit Create form
- Navigate to Promotion detail (load by ID)
- Click Activate / Deactivate on detail

### UI actions

#### PromotionOfferList
- “New Promotion” navigates to create screen.
- Selecting a row navigates to detail screen.

#### PromotionOfferCreate
- “Create” submits form.
- “Cancel” returns to list without saving.

#### PromotionOfferDetail
- “Activate” calls activate transition.
- “Deactivate” calls deactivate transition.
- “Refresh” reloads details (optional).

### State changes (UI-observed; backend authoritative)
- Create returns a PromotionOffer with a status (do not hardcode `DRAFT` unless backend contract guarantees it).
- Activate transitions to `ACTIVE` if allowed.
- Deactivate transitions to `INACTIVE` (or sets `effectiveEndAt` if that is the backend model; DECISION-PRICING-016 preference).

### Service interactions (Moqui)
- Each screen uses Moqui screen actions to call REST endpoints under `/pricing/v1/...` (DECISION-PRICING-002) via a service facade.
- Create form posts to a create endpoint; on success, transition to detail with returned `promotionOfferId`.
- Activate/deactivate buttons call transition endpoints; on success, reload detail.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (client-side; backend remains authoritative)

#### Promotion code constraints (DECISION-PRICING-007)
- Required.
- Trim leading/trailing whitespace before validation and submit.
- Must match:
  - Length: **1–32**
  - Charset: **`[A-Z0-9_-]`**
- UI behavior:
  - Convert input to uppercase for display and submit **OR** preserve user casing but validate case-insensitively and submit trimmed value. (**blocking**: confirm backend expects uppercase normalization vs case-insensitive uniqueness only; see Open Questions.)
- Code is immutable after creation:
  - On detail screen, code is read-only.
  - No edit flow in scope.

#### Validity window
- `effectiveStartAt` and `effectiveEndAt`:
  - Required.
  - Must satisfy `effectiveStartAt < effectiveEndAt` for half-open interval semantics `[start, end)` (DECISION-PRICING-003).
  - UI uses **date-time pickers** and displays the **store-local timezone** used for interpretation (DECISION-PRICING-003).
  - If backend uses date-only fields instead of timestamps, UI must follow backend contract; do not invent conversions. (**blocking**: confirm promotion uses timestamp-effective fields; see Open Questions.)

#### Discount type and value
- `promotionType` required; supported values for this story:
  - `PERCENT_LABOR`
  - `PERCENT_PARTS`
  - `FIXED_INVOICE`
- `promotionValue` required:
  - Must be > 0 (non-zero) for all types (prevents no-op promotions).
  - For percent types, UI should allow decimal percentages (e.g., `10.5` means 10.5%) consistent with Pricing percent representation guidance (DECISION-PRICING-006).
  - UI must not compute discount amounts; it only captures the value.

> Rationale: Pricing domain requires deterministic, backend-owned pricing math (AGENT_GUIDE invariants). UI only validates shape and basic constraints.

#### Usage limit
- Optional.
- If present: integer >= 0.
- Display null as “Unlimited”.

#### Scope (store/location)
- UI must not guess scope semantics. It must follow backend contract for scope fields and allowed values. (**blocking**: see Open Questions.)

### Enable/disable rules
- Create button disabled until required fields are valid.
- Activate button enabled only when backend indicates activation is allowed:
  - Preferred: backend returns a capability flag (pattern used for promotions apply gating; DECISION-PRICING-008).  
  - If no capability flag exists, enable based on status only and handle backend rejection gracefully. (**blocking**: confirm capability flags for promotion admin; see Open Questions.)
- Deactivate button enabled only when backend indicates deactivation is allowed (same approach as above).

### Visibility rules
- Show status prominently on detail.
- Show validity window with timezone label (store timezone).
- If backend returns eligibility rules or internal metadata, do not render unless explicitly required (out of scope).

### Error messaging expectations
- Duplicate code: field error on `promotionCode`: “Promotion code must be unique.”
- Invalid code format: field error describing constraints (length + allowed characters).
- Invalid date window: field errors on start/end.
- Activation/deactivation failure: show banner with backend message; do not assume state changed.

---

## 8. Data Requirements

### Entities involved
- `PromotionOffer` (Pricing domain system of record)

### Fields (type, required, defaults)

> Money representation decision (DECISION-PRICING-001) applies to pricing endpoints, but this story captures promotion value, not money totals. For `FIXED_INVOICE`, the value is a money amount and must include currency in the backend contract; UI must not assume currency.

| Field | Frontend Type | Required (Create) | Default | Notes |
|---|---|---:|---|---|
| promotionOfferId | string (opaque id) | no | n/a | Assigned by backend |
| promotionCode | string | yes | none | Constraints per DECISION-PRICING-007; immutable after create |
| description | string | yes | none | Internal description |
| scope | object | **TBD** | **TBD** | Store/location scope model is blocking |
| effectiveStartAt | string (ISO-8601 local date-time) | yes | none | Interpreted in store-local timezone (DECISION-PRICING-003) |
| effectiveEndAt | string (ISO-8601 local date-time) | yes | none | Half-open interval end (DECISION-PRICING-003) |
| promotionType | enum string | yes | none | `PERCENT_LABOR` \| `PERCENT_PARTS` \| `FIXED_INVOICE` |
| promotionValue | string/number | yes | none | Percent is decimal percent; fixed amount requires currency (blocking) |
| currencyUomId | string | **TBD** | **TBD** | Required for fixed-amount promotions if backend models as Money (DECISION-PRICING-001) |
| usageLimit | number (int) \| null | no | null | Null = unlimited |
| status | enum string | no | backend | Backend authoritative (do not hardcode) |
| createdAt | string (ISO-8601) | no | backend | For audit display if provided |
| createdBy | string | no | backend | For audit display if provided |
| lastUpdatedAt | string (ISO-8601) | no | backend | For audit display if provided |
| lastUpdatedBy | string | no | backend | For audit display if provided |

### Read-only vs editable by state/role
- This story supports **create + activate/deactivate only**.
- Detail screen is read-only for all fields except status transitions.
- `promotionCode` is always read-only after create (DECISION-PRICING-007).

### Derived/calculated fields
- `isCurrentlyWithinWindow` (UI-only informational): computed from effective window and store timezone; must not be used as the sole enforcement gate (backend authoritative).

---

## 9. Service Contracts (Frontend Perspective)

> All endpoints must be under `/pricing/v1/...` (DECISION-PRICING-002). Exact endpoint names below are proposed and must be aligned to backend implementation (**blocking** if backend differs).

### Load/view calls

1. **List Promotion Offers**
   - `GET /pricing/v1/promotions`
   - Query params (optional): `query` (code/description), `status`, `asOf` (optional)
   - Response: `{ items: PromotionOfferSummary[], pageIndex, pageSize, totalCount }`
   - Errors:
     - 403 → show unauthorized state
     - 5xx/timeouts → show retry

2. **Get Promotion Offer**
   - `GET /pricing/v1/promotions/{promotionOfferId}`
   - Response: `PromotionOffer` (full detail)
   - Errors:
     - 404 → “Promotion not found” + link back to list
     - 403 → unauthorized state

3. **Get Promotion Audit History (optional, if backend supports DECISION-PRICING-015 contract)**
   - `GET /pricing/v1/promotions/{promotionOfferId}/audit`
   - Response: `{ items: [{ changedAt, changedBy, action, summary }] }`
   - UI must render safely without assuming deep diffs.

### Create/update calls

4. **Create Promotion Offer**
   - `POST /pricing/v1/promotions`
   - Request body (proposed):
     ```json
     {
       "promotionCode": "LABOR15",
       "description": "15% off labor in February",
       "scope": { "...": "..." },
       "effectiveStartAt": "2026-02-01T00:00:00",
       "effectiveEndAt": "2026-03-01T00:00:00",
       "promotionType": "PERCENT_LABOR",
       "promotionValue": "15",
       "currencyUomId": "USD",
       "usageLimit": 100
     }
     ```
   - Response: `{ promotionOfferId, ...optionalPromotionOffer }`
   - Errors:
     - 400 validation → fieldErrors map (preferred)
     - 409 conflict for duplicate code (or 400 with fieldErrors) → map to `promotionCode`
     - 403 unauthorized

### Submit/transition calls

5. **Activate Promotion Offer**
   - `POST /pricing/v1/promotions/{promotionOfferId}:activate`
   - Response: updated PromotionOffer (or `{ status }`)
   - Errors:
     - 400 validation (e.g., invalid window) → show banner + field hints if provided
     - 409 conflict (concurrent change) → reload detail and show “Promotion updated by another user.”
     - 403 unauthorized

6. **Deactivate Promotion Offer**
   - `POST /pricing/v1/promotions/{promotionOfferId}:deactivate`
   - Response: updated PromotionOffer (or `{ status }`)
   - Errors: same handling as activate.

### Error handling expectations
- Map backend validation errors to field-level messages when `fieldErrors` present.
- For 409 conflicts, reload entity and show non-blocking message.
- Preserve correlation/request ID headers if provided; show request ID in error details panel (support-friendly), but do not log sensitive payloads.

---

## 10. State Model & Transitions

### Allowed states
- Backend-defined; UI must not hardcode beyond what it needs to render actions.
- If backend provides these states, UI supports:
  - `DRAFT` (or equivalent non-active)
  - `ACTIVE`
  - `INACTIVE`
  - `EXPIRED` (if present)

### Role-based transitions
- Users with manage permission can activate/deactivate.
- Users with view permission can view list/detail (blocking: confirm permission split; see Open Questions).

### UI behavior per state
- If status is `ACTIVE`: show Deactivate enabled; hide/disable Activate.
- If status is not `ACTIVE`: show Activate enabled only if backend indicates allowed; otherwise disabled with reason if provided.
- If status is `EXPIRED`: Activate disabled; Deactivate hidden/disabled.

---

## 11. Alternate / Error Flows

### Validation failures
- Code invalid (length/charset): block submit; show inline error.
- Date window invalid: block submit; show inline error.
- Usage limit invalid: block submit; show inline error.

### Concurrency conflicts
- Activate/deactivate returns 409:
  - UI reloads PromotionOffer detail.
  - UI shows message: “Promotion was updated by another user. Review current status and try again.”

### Unauthorized access
- If user lacks manage permission:
  - Create screen: show access denied and do not render submit actions.
  - Detail screen: hide/disable Activate/Deactivate; still allow view if permitted.
- If user lacks view permission:
  - List/detail: show access denied.

### Empty states
- List returns zero items:
  - Show empty state with CTA “Create Promotion”.

### Backend dependency failures
- Network timeout/5xx:
  - Show retry action.
  - Do not assume create/activate/deactivate succeeded; on retry, reload detail/list.

---

## 12. Acceptance Criteria

### Scenario 1: Create a new promotion with a valid code and window
**Given** I am authenticated as an Account Manager with permission to manage promotions  
**And** I am on the Create Promotion screen  
**When** I enter promotion code `"LABOR15"`  
**And** the code is 1–32 characters and matches `[A-Z0-9_-]` after trimming whitespace  
**And** I enter a description  
**And** I select promotion type `"PERCENT_LABOR"` with promotion value `"15"`  
**And** I set `effectiveStartAt` and `effectiveEndAt` such that `effectiveStartAt < effectiveEndAt`  
**When** I submit the form  
**Then** the backend creates a PromotionOffer and returns a `promotionOfferId`  
**And** I am navigated to the PromotionOffer detail screen for that `promotionOfferId`  
**And** the promotion code is displayed read-only on the detail screen

### Scenario 2: Reject create when date window is invalid (client-side)
**Given** I am on the Create Promotion screen  
**When** I set `effectiveStartAt` to a time that is on/after `effectiveEndAt`  
**Then** the UI shows a validation message indicating the end must be after the start  
**And** the Create action is blocked until corrected

### Scenario 3: Reject create when promotion code violates constraints (client-side)
**Given** I am on the Create Promotion screen  
**When** I enter a promotion code containing lowercase letters or spaces (e.g., `"summer 10"`)  
**Then** the UI shows a validation message stating allowed characters are `[A-Z0-9_-]`  
**And** the Create action is blocked until corrected

### Scenario 4: Reject create when promotion code is not unique (server-side)
**Given** a PromotionOffer already exists with promotionCode `"SUMMER2024"` (case-insensitive uniqueness)  
**And** I am on the Create Promotion screen  
**When** I submit a new promotion with promotionCode `"SUMMER2024"`  
**Then** the backend rejects the request with a duplicate/constraint error  
**And** the UI shows a field error on `promotionCode` stating the code must be unique  
**And** no promotion is created

### Scenario 5: Activate a non-active promotion
**Given** a PromotionOffer exists and is not `ACTIVE`  
**And** I am on its PromotionOffer detail screen  
**When** I click “Activate”  
**Then** the UI calls the activate endpoint  
**And** on success the UI reloads the PromotionOffer  
**And** the status is displayed as `ACTIVE`  
**And** the Activate action is hidden/disabled and Deactivate is enabled

### Scenario 6: Deactivate an active promotion
**Given** a PromotionOffer exists with status `ACTIVE`  
**And** I am on its PromotionOffer detail screen  
**When** I click “Deactivate”  
**Then** the UI calls the deactivate endpoint  
**And** on success the UI reloads the PromotionOffer  
**And** the status is displayed as not `ACTIVE`  
**And** the Activate action becomes available (subject to backend allowance)

### Scenario 7: Handle concurrency conflict on activation/deactivation
**Given** I am on a PromotionOffer detail screen  
**And** another user changes the promotion status before I click Activate/Deactivate  
**When** I click Activate/Deactivate  
**And** the backend responds with HTTP 409 conflict  
**Then** the UI reloads the PromotionOffer detail  
**And** the UI shows a message indicating the promotion was updated by another user  
**And** the UI does not show a success state for my attempted action

---

## 13. Audit & Observability

### User-visible audit data
- On detail screen, display if provided by backend:
  - `createdBy`, `createdAt`
  - `lastUpdatedBy`, `lastUpdatedAt`
- If backend provides audit history per DECISION-PRICING-015:
  - Render a read-only “Change History” list with `changedAt`, `changedBy`, `action`, `summary`.

### Status history
- If audit endpoint exists, status changes must appear as audit entries.
- If no audit endpoint exists, do not fabricate history; show “History not available”.

### Traceability expectations
- Frontend must propagate correlation/request IDs per repo convention on all `/pricing/v1/...` calls.
- Frontend logs (structured, non-sensitive):
  - `pricing.promotion.create.submit|success|failure`
  - `pricing.promotion.activate.submit|success|failure`
  - `pricing.promotion.deactivate.submit|success|failure`
- Do not log full request bodies; promotionCode may be logged, but avoid description text if it may contain sensitive info.

---

## 14. Non-Functional UI Requirements

- **Performance:** List and detail screens render loading states; avoid blocking UI thread during fetch.
- **Accessibility:** All fields have labels; validation errors are announced; modal dialogs (if any) trap focus.
- **Responsiveness:** Admin screens usable on tablet widths.
- **i18n/timezone/currency:**
  - Effective dating uses store-local timezone semantics and date-time pickers (DECISION-PRICING-003).
  - For fixed-amount promotions, currency must be displayed from backend-provided `currencyUomId` (DECISION-PRICING-001); UI must not assume USD.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide an empty-state message and CTA on promotions list when no records exist; safe because it does not change domain behavior; impacts UX Summary, Alternate/Empty states.
- SD-UX-PAGINATION: Use standard list pagination controls with page size default (e.g., 25) and server-driven totalCount; safe because it is a UI ergonomics default; impacts UX Summary, Service Contracts.
- SD-ERR-MAP-VALIDATION: Map backend validation errors to field-level messages when field key is present, otherwise show form-level error banner; safe because it is standard error presentation without altering rules; impacts Business Rules, Service Contracts, Error Flows.

---

## 16. Open Questions

1. **Permissions (blocking):** Confirm exact permission strings for:
   - View promotions list/detail (e.g., `pricing:promotion:view`)
   - Manage promotions create/activate/deactivate (e.g., `pricing:promotion:manage`)
   Also confirm whether UI should hide actions vs show disabled with “no permission”.
2. **Scope model (blocking):** What is the backend contract for promotion scope?
   - Is it `storeCode`, `locationId`, both, or a structured `scope` object?
   - Is “all stores/locations” supported, and how is it represented (null vs explicit flag)?
3. **Effective dating fields (blocking):** Are promotions effective-dated with timestamp fields (`effectiveStartAt/effectiveEndAt`) interpreted in store-local timezone (preferred per DECISION-PRICING-003), or are they date-only (`startDate/endDate`)? Provide exact field names and formats.
4. **Fixed amount currency (blocking):** For `FIXED_INVOICE`, does backend require a Money object `{ amount, currencyUomId }` (DECISION-PRICING-001), or separate `promotionValue` + `currencyUomId` fields? Which currency applies (store currency vs tenant default)?
5. **Activation/deactivation mechanism (blocking):** For promotions specifically, is deactivation performed by:
   - status transition (`ACTIVE` → `INACTIVE`), or
   - setting `effectiveEndAt` (DECISION-PRICING-016 preference), or
   - both supported?
   Provide the authoritative backend behavior and response payload.
6. **Code normalization (blocking):** Should the UI uppercase codes on input/submit, or only validate charset and rely on backend case-insensitive uniqueness (DECISION-PRICING-007)? Provide expected backend behavior for mixed-case input.

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] Promotions: Create Promotion Offer (Basic)  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/161  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Promotions: Create Promotion Offer (Basic)

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Account Manager**, I want **to create a simple promotion (discount amount/percent) with start/end dates** so that **I can apply it to estimates for eligible customers**.

## Details
- Offer types: % off labor, % off parts, fixed amount off invoice.
- Store code, description, active dates, optional usage limit.

## Acceptance Criteria
- Create/activate/deactivate offer.
- Validate date range.
- Unique code enforced.

## Integration Points (Workorder Execution)
- Workorder Execution can query active offers for a customer.

## Data / Entities
- PromotionOffer

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

════════════════════════════════════════
ISSUE #115: [FRONTEND] [STORY] Workexec: Price Product for Estimate Line (Location + Customer Tier)
LABELS: frontend,story-implementation,user,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,domain:pricing
BODY:
## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] Workexec: Price Product for Estimate Line (Location + Customer Tier) — URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/115

════════════════════════════════════════
ISSUE #84: [FRONTEND] [STORY] Order: Apply Price Override with Permission and Reason
LABELS: type:story,status:draft,blocked:clarification,risk:incomplete-requirements,domain:pricing,agent:story-authoring,agent:pricing-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Order: Apply Line Price Override (Permission + Reason + Idempotency)

## Primary Persona
Service Advisor (POS user)

## Business Value
Enable compliant exception handling by allowing authorized users to request a line price override with required reason capture and deterministic backend evaluation, while ensuring auditability and preventing duplicate application via idempotency.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor  
- **I want** to request an override for an order line’s unit price by entering a new price and selecting a reason (and optionally providing a manager approval token if available)  
- **So that** I can resolve pricing exceptions while remaining compliant, auditable, and consistent with backend pricing policy.

## In-scope
- POS frontend UI to initiate a line price override for an existing Order Line.
- Permission-gated override entry, with reason code required.
- Deterministic backend outcome handling:
  - immediate apply vs pending approval vs rejected/blocked
- Display of override status and metadata (who/why/when/approval) on the line item.
- Idempotent submission behavior (client-generated idempotency key).
- Defensive error handling for 403/409/422/5xx.
- Observability hooks: correlation/request ID propagation (where supported by project conventions).

## Out-of-scope
- Defining/authoring override thresholds, guardrails, or policy (Pricing backend-owned).
- Building a manager approval workflow UI (approve/reject screens); this story only supports passing an existing `managerApprovalId` if the POS already has one.
- Promotion stacking rules, pricing formulas, or any recomputation of totals (backend-owned).
- Cross-document lifecycle rules (order finalization/payment/refund) beyond honoring backend-provided eligibility flags and errors.

---

# 3. Actors & Stakeholders

- **Service Advisor (primary):** requests override at POS.
- **Manager / Approver:** may approve overrides; may provide an approval token/record consumed by backend.
- **Pricing services (backend, SoR):** owns override policy decisions, reason code catalog, and authoritative money normalization/rounding (DECISION-PRICING-001, -011, -012).
- **Order/Checkout domain (backend, SoR for order):** persists order/line state and totals; exposes line eligibility and current pricing snapshot/override references to UI.
- **Security/Access Control:** enforces permissions; UI must handle 403 safely.
- **Finance/Support:** relies on captured reason + audit metadata for dispute resolution.

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in POS and has an active session.
- An **Order** exists with at least one **Line Item** that has a current unit price and currency.
- UI can read the order currency and line identifiers (`orderId`, `orderLineId`/`lineItemId`).
- UI can determine whether the current user has override capability via:
  - permissions in session context, and/or
  - backend 403 handling as authoritative.

## Dependencies (must exist or be implemented in parallel)
- Backend must expose (or already exposes) endpoints/services for:
  1) **Reason code catalog** (Pricing-owned): `GET /pricing/v1/restrictions/override-reasons` exists for restriction overrides (DECISION-PRICING-011), but **this story needs a price override reason catalog** for price overrides. If the same endpoint is reused, backend must confirm semantics and codes.
  2) **Create price override request** (Order or Pricing-owned; unclear): must accept `orderId`, `lineItemId`, requested unit price money, reason code, optional `managerApprovalId`, and `idempotencyKey`; must return override status and updated order/line pricing subtree.
  3) **Load order context** including per-line override summary and eligibility flags (e.g., `canOverridePrice`, `overrideStatus`, `overrideId`).
- Backend error payloads must be stable enough for UI mapping:
  - 403 forbidden
  - 409 conflict (optimistic lock/version mismatch)
  - 422/400 validation errors with field-level details
- Moqui security permission strings for override must be defined and consistent between UI and backend (exact strings are currently unclear).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From **Order Detail / Cart / Checkout** screen, on each line item:
  - Action: **“Override Price”** (shown/enabled only when allowed; see rules)

## Screens to create/modify
- **Modify existing screen:** `OrderDetail` (or equivalent POS order screen)
  - Add per-line “Override Price” action
  - Add per-line override status/metadata display
- **New modal/screenlet:** `OrderLinePriceOverrideDialog`
  - Form inputs:
    - requested unit price (money amount as decimal string)
    - reason code (select)
    - optional manager approval token/id (if available in POS context; see Open Questions)
  - Read-only context:
    - current unit price + currency
    - line description (SKU/name) if available

> Moqui implementation note: implement as a screenlet with `form-single` in a modal; submit via a `transition` calling a service (or REST call via a facade service), then refresh the order screen context.

## Navigation context
- User remains within the Order context; dialog opens atop current order screen.
- On success, UI refreshes line and totals in-place (no full page navigation).

## User workflows (happy + alternate)

### Happy path: immediate apply
1. Service Advisor clicks “Override Price” on a line.
2. Dialog loads reason codes (if not already cached) and shows current unit price.
3. User enters requested unit price and selects reason code.
4. User submits.
5. Backend returns status `APPLIED` (or equivalent) and updated order pricing subtree.
6. UI updates the line unit price display and shows “Override Applied” metadata.

### Alternate path: pending approval
1. Same as above.
2. Backend returns status `PENDING_APPROVAL`.
3. UI shows “Override Pending Approval” on the line and does not assume totals changed unless backend returns updated totals explicitly.

### Alternate path: manager approval token provided
1. User provides `managerApprovalId` (if the POS has a mechanism).
2. Backend validates token and either applies immediately (`APPLIED`) or rejects (`REJECTED`/403/422).
3. UI reflects returned status and messages.

---

# 6. Functional Behavior

## Triggers
- Click “Override Price” on a line item.
- Submit override form.

## UI actions
- Open override dialog for selected `orderId` + `lineItemId`.
- Load reason codes (Pricing-owned catalog; do not hardcode).
- Client-side validate required fields and basic money syntax.
- Submit override request with:
  - `idempotencyKey` (client-generated UUID per submission attempt; reused on retries)
  - requested unit price as Money `{ amount: "<decimal-string>", currencyUomId: "<orderCurrency>" }` (DECISION-PRICING-001)
- After success, refresh order context (either by using response payload or reloading order).

## State changes (frontend-visible)
- Line shows override status badge:
  - `APPLIED` / `PENDING_APPROVAL` / `REJECTED` (exact enum strings must be treated as backend-owned; UI maps known values and falls back to “Unknown” with raw status for support).
- When `APPLIED`, line’s displayed unit price updates to backend-provided value.
- When `PENDING_APPROVAL`, line remains priced as backend indicates (do not assume unchanged; display backend-provided current price).

## Service interactions (Moqui)
- Load order + line pricing context (current unit price, currency, override summary, eligibility flags).
- Load reason code list (Pricing catalog).
- Submit override request (Order/Pricing service).
- Refresh order summary totals and line items.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- **Requested unit price is required**.
  - UI accepts decimal string input; must not compute rounding; backend is authoritative (DECISION-PRICING-001).
  - UI blocks negative values and non-numeric formats.
- **Reason code is required** and must be selected from backend-provided catalog (DECISION-PRICING-011 principle: do not hardcode catalogs).
- **Currency is read-only** and derived from the order/line currency; UI must submit `currencyUomId` with the money object (DECISION-PRICING-001).
- **Idempotency key is required** on submit; retries must reuse the same key to prevent duplicate application.

## Enable/disable rules
- “Override Price” action is:
  - hidden/disabled when backend indicates line is not override-eligible (preferred: `canOverridePrice=false` on line), OR
  - disabled when order/line is in a non-editable state as indicated by backend capability flags (do not hardcode order statuses).
- Submit button disabled until:
  - requested unit price is syntactically valid
  - reason code selected
- If reason codes cannot be loaded, submission is blocked.

## Visibility rules
- Override metadata is visible on the line when an override exists, subject to backend redaction/omission rules.
- UI must not display any sensitive pricing internals not explicitly returned (e.g., cost).

## Error messaging expectations
- 403: “You don’t have permission to override prices.”
- 422/400 validation: show field-level errors (requested price invalid, reason invalid, approval token invalid).
- 409: “This order was updated by another user. Refresh and try again.”
- 5xx/503: “Pricing service unavailable; cannot apply override right now.” Provide retry action.

---

# 8. Data Requirements

## Entities involved (conceptual; UI reads/writes via services)
- `Order` (SoR: Order/Checkout domain)
- `OrderLineItem` (SoR: Order/Checkout domain)
- `PriceOverride` (SoR unclear: Pricing vs Order; UI treats as backend-owned record)
- `ApprovalRecord` / `ManagerApproval` (SoR: Security/People or Order; referenced by token/id)
- `OverrideReasonCode` catalog (SoR: Pricing; must be fetched, not hardcoded)

## Fields (type, required, defaults)

### UI input model: `LinePriceOverrideRequest`
- `orderId` (string/UUID, required)
- `lineItemId` (string/UUID, required)
- `requestedUnitPrice` (Money, required)
  - `amount` (decimal-string, required)
  - `currencyUomId` (string, required; from order)
- `reasonCode` (string, required)
- `notes` (string, optional; only if backend supports it—otherwise omit)
- `managerApprovalId` (string/UUID, optional)
- `idempotencyKey` (string/UUID, required)

### UI display model: `LinePriceOverrideSummary`
- `overrideId` (string/UUID, optional)
- `status` (string enum, required when override exists)
- `reasonCode` (string, optional)
- `requestedBy` (string/userId, optional)
- `requestedAt` (datetime, optional)
- `approvedBy` (string/userId, optional)
- `approvedAt` (datetime, optional)
- `message` (string, optional; backend-provided human-readable status message)

### Order line pricing display (authoritative)
- `unitPrice` (Money, required)
- `extendedPrice` (Money, optional if backend provides; UI must not compute)
- `currencyUomId` (string, required)

## Read-only vs editable by state/role
- Editable only at creation time: requested unit price, reason code, optional manager approval id.
- Read-only always: currency, audit metadata.
- If an override exists with status `PENDING_APPROVAL` or `APPLIED`, UI must not allow editing that override; it may allow creating a new override request only if backend indicates allowed (see Open Questions).

## Derived/calculated fields
- UI may display a “before/after” delta using backend-provided money values only; must not use it for policy decisions.

---

# 9. Service Contracts (Frontend Perspective)

> All Pricing-domain endpoints must use `/pricing/v1/...` (DECISION-PRICING-002). This story includes at least one non-pricing endpoint (order override apply) whose base path is unknown; do not guess.

## Load/view calls
1) **Load order context**
- Input: `orderId`
- Output (minimum per line):
  - `lineItemId`
  - `unitPrice` as Money `{amount, currencyUomId}`
  - `canOverridePrice` boolean (preferred capability flag)
  - `priceOverride` summary (if exists): `overrideId`, `status`, `reasonCode`, `requestedBy`, `requestedAt`, `approvedBy`, `approvedAt`

2) **Load override reason codes (catalog)**
- Preferred: Pricing-owned catalog endpoint under `/pricing/v1/...`
- Output:
  - `reasonCodes: [{ code, description, activeFlag }]`
- UI behavior:
  - filter to `activeFlag=true` for selection
  - if none active, block submission

## Create/update calls
3) **Create line price override request**
- Input: `LinePriceOverrideRequest`
- Output:
  - `priceOverride` summary (including `overrideId` and `status`)
  - updated order pricing subtree OR enough data to refresh (e.g., `orderVersion` + line pricing)
- Error handling:
  - 403 forbidden
  - 409 conflict (order version mismatch)
  - 400/422 validation with field errors

> Idempotency: backend must treat `(orderId, lineItemId, idempotencyKey)` as idempotent for create; UI must reuse the same key on retry.

## Submit/transition calls
4) **(Optional) Apply approved override**
- Only if backend requires a separate apply step after approval.
- Input: `{ overrideId, idempotencyKey }`
- Output: updated override status + updated order pricing subtree

## Error handling expectations
- UI must:
  - map 403/409/validation/5xx to user-visible messages
  - avoid logging sensitive fields (e.g., cost) if present in payloads (DECISION-PRICING-014 principle)
  - include correlation/request IDs in logs/headers if project standard exists

---

# 10. State Model & Transitions

## Allowed states
Backend-owned; UI must support at minimum:
- `APPLIED`
- `PENDING_APPROVAL`
- `REJECTED`

UI may also receive:
- `REQUESTED`
- `APPROVED`

UI must render unknown statuses as “Unknown” and still show metadata safely.

## Role-based transitions
- Service Advisor:
  - can request override if permitted and line is eligible.
- Manager/Approver:
  - approval is out-of-scope; UI only reflects approved/rejected when order is refreshed.

## UI behavior per state
- `PENDING_APPROVAL`:
  - show pending indicator
  - disable “Override Price” action for that line unless backend indicates `canOverridePrice=true` even with pending (capability flag must drive)
- `APPLIED`:
  - show applied indicator and metadata
  - allow new override request only if backend indicates allowed (capability flag)
- `REJECTED`:
  - show rejected indicator and message (if provided)
  - allow new request only if backend indicates allowed

---

# 11. Alternate / Error Flows

## Validation failures
- Missing reason code → inline error; no submit call.
- Invalid price format or negative → inline error; no submit call.
- Currency mismatch (should not happen if derived) → treat as fatal UI bug; block submit and prompt refresh.

## Concurrency conflicts
- On 409:
  - show refresh prompt
  - on confirm, reload order context
  - if line still exists and eligible, allow retry

## Unauthorized access
- If action is invoked but backend returns 403:
  - show permission error
  - keep dialog open for user to cancel; do not update UI state optimistically

## Empty states
- Reason code list empty/unavailable:
  - show “No override reasons available; contact admin.”
  - disable submit
- Line missing currency/unitPrice:
  - hide/disable override action and show “Pricing not available for this line.”

---

# 12. Acceptance Criteria

## Scenario 1: Authorized immediate override applies and updates line
**Given** a Service Advisor is viewing an Order with a line item that is override-eligible (`canOverridePrice=true`)  
**And** the user has permission to request overrides (either via session permissions or backend authorization)  
**When** the user opens “Override Price”, enters a requested unit price, selects a reason code, and submits  
**Then** the UI sends a request containing `orderId`, `lineItemId`, `requestedUnitPrice.amount` (decimal-string), `requestedUnitPrice.currencyUomId`, `reasonCode`, and `idempotencyKey`  
**And** the UI does not compute rounding or totals client-side  
**And** when the backend returns status `APPLIED`, the UI updates the line’s displayed unit price using backend-provided money values  
**And** the UI displays override metadata (reason, requestedBy/requestedAt, and approvedBy/approvedAt if present).

## Scenario 2: Override blocked without permission
**Given** a user without override permission is viewing an override-eligible line  
**When** they submit a price override request without a valid manager approval token  
**Then** the backend responds 403  
**And** the UI shows “You don’t have permission to override prices.”  
**And** the order and line prices remain as last loaded from backend.

## Scenario 3: Override requires approval and becomes pending
**Given** a Service Advisor submits an override that requires approval per backend policy  
**When** the override request is submitted without manager approval  
**Then** the backend returns status `PENDING_APPROVAL`  
**And** the UI displays “Override Pending Approval” on the line  
**And** the UI does not assume totals changed unless backend returns updated totals explicitly  
**And** the UI disables further override attempts for that line unless backend indicates it is allowed via capability flag.

## Scenario 4: Client-side required-field validation prevents submit
**Given** the override dialog is open  
**When** the user leaves reason code empty and attempts to submit  
**Then** the UI shows a required-field validation error  
**And** the UI does not call the create override service.

## Scenario 5: Concurrency conflict handling
**Given** the override dialog is open for a line item  
**When** the user submits and the backend responds with 409 conflict  
**Then** the UI prompts the user to refresh  
**And** upon refresh, the UI reloads the order context  
**And** the UI allows the user to retry if the line remains override-eligible.

## Scenario 6: Idempotent retry does not double-apply
**Given** the user submits an override and a network timeout occurs after submission  
**When** the UI retries submission with the same `idempotencyKey`  
**Then** the backend returns the original result (same `overrideId` and status)  
**And** the UI shows only one override record and one applied price outcome.

## Scenario 7: Reason code catalog is required and not hardcoded
**Given** the override dialog is opened  
**When** the reason code catalog endpoint returns an empty list or fails  
**Then** the UI disables submission  
**And** the UI displays an error indicating override reasons are unavailable  
**And** the UI does not present any hardcoded fallback reason codes.

---

# 13. Audit & Observability

## User-visible audit data
- On the line item (or line details panel), display backend-provided fields:
  - override status
  - reason code
  - requestedBy/requestedAt
  - approvedBy/approvedAt (if present)
  - backend message (if present)

## Status history
- If backend provides a history array, UI renders it chronologically in a collapsible section.
- If not provided, UI renders only the current summary.

## Traceability expectations
- Frontend generates `idempotencyKey` per submission attempt and reuses it for retries.
- Frontend propagates correlation/request IDs if the project standard exists (do not invent header names).
- Frontend logs only safe identifiers: `orderId`, `lineItemId`, `overrideId`, correlationId; do not log money breakdown internals beyond the requested amount.

---

# 14. Non-Functional UI Requirements

- **Performance:** Dialog opens immediately using cached order data; reason codes may be cached per session with a refresh option.
- **Accessibility:** Modal must trap focus; form errors must be announced via accessible helper text; all actions keyboard operable.
- **Responsiveness:** Must work on tablet widths commonly used in POS.
- **i18n/timezone/currency:** Currency formatting uses `currencyUomId` from backend; timestamps displayed in user locale/timezone (display-only).

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging for missing reason codes; UI-only ergonomics, no policy change. Impacted sections: UX Summary, Alternate/Error Flows, Acceptance Criteria.
- SD-ERR-STD-MAPPING: Standard mapping of 403/409/validation/5xx to notifications and field errors; implied by backend contract patterns. Impacted sections: Business Rules, Service Contracts, Alternate/Error Flows, Acceptance Criteria.
- SD-OBS-CORRELATION: Generate idempotency key client-side and propagate correlation identifiers when available; observability boilerplate. Impacted sections: Service Contracts, Audit & Observability, Acceptance Criteria.

---

# 16. Open Questions

1) **System-of-record + endpoint ownership (blocking):** Is the “line price override” API owned by Pricing (`/pricing/v1/...`) or by Order/Checkout (non-pricing base path)? Provide exact REST paths or Moqui service names and the request/response payloads required for:
   - create override request
   - (optional) apply approved override
   - load per-line `canOverridePrice` capability flag and override summary

2) **Permission strings (blocking):** What are the exact permission identifiers used by backend for:
   - requesting a price override (advisor)
   - applying an override (if separate)
   - manager approval validation (if token-based)
   UI must not guess permission strings.

3) **Reason code catalog for *price overrides* (blocking):** What endpoint provides the authoritative reason codes for price overrides?
   - If it reuses `GET /pricing/v1/restrictions/override-reasons`, confirm that codes apply to price overrides and provide field names (`code`, `description`, `activeFlag`).
   - If separate, provide the correct endpoint and response shape.

4) **Manager approval token acquisition (blocking):** How does POS obtain `managerApprovalId`?
   - re-auth modal (manager credentials)
   - scanned token
   - selection from pending approvals
   Provide the UX entry point and the data shape passed to this story.

5) **Multiple overrides per line (blocking):** If a line already has an override in `PENDING_APPROVAL` or `APPLIED`, can a new override request be created?
   - If yes: does it supersede the prior override, or are multiple kept with “active” pointer?
   - What capability flag or error code indicates “cannot create new override”?

