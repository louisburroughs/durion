════════════════════════════════════════
ISSUE #76: [FRONTEND] [STORY] Appointment: Create Appointment from Estimate or Order
LABELS: domain:shopmgmt,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:shopmgmt-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] Appointment: Create Appointment from Estimate or Work Order (Shop Scheduler)

**Primary Persona:** Scheduler (Service Advisor / Dispatcher)

**Business Value:** Enables schedulers to convert an eligible estimate or work order into a scheduled appointment with server-authoritative policy enforcement (operating hours, eligibility, conflicts), immutable source linkage, and idempotent submission—reducing manual entry and preventing double-booking.

---

## 2. Story Intent

### As a / I want / So that
As a **Scheduler**, I want to **create an appointment from an estimate or work order** so that **the work is scheduled in the facility timezone with conflicts/policies enforced and the appointment is immutably linked to its source document**.

### In-scope
- Entry flow to create an appointment from:
  - an **Estimate** (eligible statuses: **APPROVED, QUOTED**; DECISION-SHOPMGMT-013), or
  - a **Work Order** (eligible unless **COMPLETED, CANCELLED**; DECISION-SHOPMGMT-013)
- Pre-population of appointment create draft from backend read model:
  - source summary (non-PII where possible)
  - backend-provided scheduling defaults/hints (duration/skills/bay/mobile eligibility if provided)
  - facility timezone identifier and timestamp semantics (DECISION-SHOPMGMT-015)
- Interactive scheduling selection:
  - choose **scheduledStartDateTime** (required)
- Submit-time conflict handling (DECISION-SHOPMGMT-011):
  - backend returns conflicts on submit (409) with HARD vs SOFT (DECISION-SHOPMGMT-002)
  - HARD conflicts are **not overridable** (DECISION-SHOPMGMT-002)
  - SOFT conflicts may be overridden only with permission + reason and are audited (DECISION-SHOPMGMT-007)
  - render suggestedAlternatives[] (time slots only) when present (DECISION-SHOPMGMT-011)
- Idempotent create submission using **clientRequestId** (DECISION-SHOPMGMT-014)
- Successful create confirmation and navigation to appointment detail

### Out-of-scope
- Rescheduling an existing appointment (separate story)
- Post-create assignment editing (bay/mobile/mechanic/notes) beyond what appointment detail already supports
- Any UI that defines facility operating hours, bays, mobile units, or staffing rules (Location/People domains)
- Customer notification toggle UI (DECISION-SHOPMGMT-016)
- Any “pre-check conflicts” call required for correctness (optional enhancement only; DECISION-SHOPMGMT-011)

---

## 3. Actors & Stakeholders
- **Primary user:** Scheduler
- **Secondary users:** Shop Manager (may have override permissions), Dispatcher
- **Systems (SoR boundaries):**
  - **shopmgmt** backend: appointment creation, eligibility checks, conflict detection/classification, operating-hours enforcement, audit (DECISION-SHOPMGMT-001/002/008/017)
  - **Location** domain: operating hours source of truth (consumed by shopmgmt; DECISION-SHOPMGMT-008)
  - **People** domain: mechanic profile SoR; shopmgmt may expose minimal derived mechanic display fields but UI must not require People calls (DECISION-SHOPMGMT-009)
  - **Notification** domain: delivery; shopmgmt may return outcome summary (DECISION-SHOPMGMT-016)

---

## 4. Preconditions & Dependencies
- User is authenticated in POS.
- User has permission `CREATE_APPOINTMENT` (exact permission string **CLARIFY** if different in repo).
- Facility scoping:
  - **All write requests include facilityId explicitly** (DECISION-SHOPMGMT-012).
- Source exists and is eligible:
  - Estimate status in **APPROVED** or **QUOTED** (DECISION-SHOPMGMT-013)
  - Work order status not **COMPLETED** or **CANCELLED** (DECISION-SHOPMGMT-013)
- Backend contracts must exist (DECISION-SHOPMGMT-011):
  - Load “create-from-source” model (source summary + defaults + eligibility)
  - Create appointment from source (submit-time conflicts returned on 409)
- UI route/screen patterns must follow `durion-moqui-frontend` conventions (**CLARIFY exact screen paths/params**).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Estimate Detail**: action “Create Appointment”
- From **Work Order Detail**: action “Create Appointment”

### Screens to create/modify
1. **Modify**: Estimate detail screen — add transition/action to appointment create
2. **Modify**: Work order detail screen — add transition/action to appointment create
3. **Create**: Appointment Create screen (source-driven)
4. **Modify/Use existing**: Appointment Detail screen for post-create navigation

**Moqui implementation expectation**
- Appointment Create is a Moqui screen with:
  - a form for scheduledStartDateTime and any backend-allowed optional inputs
  - a transition for submit (create)
  - conditional rendering for conflict results returned from submit (409)
  - idempotency handling (clientRequestId stored in screen state)

### Navigation context
- Breadcrumb: Source (Estimate/Work Order) → Create Appointment
- On success: navigate to Appointment Detail with `appointmentId`

### User workflows (happy + alternate)
**Happy path**
1. Scheduler clicks “Create Appointment” on eligible source.
2. Create screen loads backend model including facilityTimeZoneId.
3. Scheduler selects scheduledStartDateTime (displayed/entered in facility timezone).
4. Scheduler submits “Create Appointment”.
5. Backend returns success with appointmentId.
6. UI shows confirmation and navigates to Appointment Detail.

**Alternate paths**
- Ineligible source (422): show eligibility error and disable submit.
- Submit returns conflicts (409):
  - HARD conflicts present: show blocking conflicts; no override action (DECISION-SHOPMGMT-002).
  - SOFT conflicts only: if user has override permission, allow “Override & Create” with required overrideReason; otherwise block with permission message (DECISION-SHOPMGMT-007).
  - Render suggestedAlternatives[] time slots when present (DECISION-SHOPMGMT-011).
- Network timeout after submit: UI offers retry using the **same clientRequestId** (DECISION-SHOPMGMT-014).

---

## 6. Functional Behavior

### Triggers
- User opens create screen from a source document.
- User edits scheduledStartDateTime.
- User submits create.
- User retries after timeout/failure.

### UI actions
- **Load**
  - Call backend to load create model for (sourceType, sourceId).
  - Display eligibility state and any server-provided guidance.
- **Edit inputs**
  - scheduledStartDateTime (required)
  - No other editable fields are assumed unless backend explicitly supports them (SAFE_DEFAULTS_MODE denylist: do not guess policy-owned fields).
- **Submit create**
  - Generate `clientRequestId` once per user-initiated submit attempt; persist it in screen state for retries until success/final failure (DECISION-SHOPMGMT-014).
  - Send facilityId explicitly (DECISION-SHOPMGMT-012).
  - If user is overriding SOFT conflicts, include overrideReason and overrideSoftConflicts=true (DECISION-SHOPMGMT-007).
  - Handle responses:
    - 200/201 success: navigate to Appointment Detail.
    - 409 conflicts: render conflicts and suggested alternatives; gate override UI.
    - 422 policy/eligibility: render blocking message.
    - 400 validation: field-level errors.
    - 403/404: access denied/not found without leaking cross-facility existence (DECISION-SHOPMGMT-012).

### State changes (frontend-observable)
- Client-only UI state:
  - `idle` → `loading` → `ready`
  - `submitting` → (`success` | `conflict_blocked` | `policy_blocked` | `error`)
- Server-authoritative state returned on success:
  - appointmentId
  - appointmentStatus (opaque string; UI displays as returned; DECISION-SHOPMGMT-013)
  - facilityTimeZoneId (DECISION-SHOPMGMT-015)

### Service interactions
- Load create model (read)
- Create appointment (write; returns conflicts on submit when applicable)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
**Client-side (non-authoritative)**
- scheduledStartDateTime is required.
- scheduledStartDateTime must be a valid ISO-8601 datetime with offset when sent (DECISION-SHOPMGMT-015).
- If override UI is shown and user chooses override:
  - overrideReason required (non-empty).
  - notes: do not log overrideReason client-side (sensitive operational text; DECISION-SHOPMGMT-017 guidance).

**Server-side (authoritative)**
- Eligibility:
  - Estimate not eligible → 422 with code `ESTIMATE_NOT_ELIGIBLE` (DECISION-SHOPMGMT-013).
  - Work order not eligible → 422 with code `WORK_ORDER_NOT_ELIGIBLE` (DECISION-SHOPMGMT-013).
- Operating hours:
  - Outside operating hours / holiday closure returns a **HARD conflict** (DECISION-SHOPMGMT-008).
- Conflicts:
  - HARD conflicts block and are not overridable (DECISION-SHOPMGMT-002).
  - SOFT conflicts may be overridden only with permission + reason; always audited (DECISION-SHOPMGMT-007).
- Error semantics:
  - 422 for policy/business rule failures; 400 for syntactic validation (DECISION-SHOPMGMT-011).

### Enable/disable rules
- Disable submit until:
  - load completes successfully AND
  - scheduledStartDateTime is present AND
  - source is eligible (if backend provides eligibility flag; otherwise rely on submit response).
- When conflicts returned:
  - If any HARD conflicts: disable “Create” and hide override action.
  - If only SOFT conflicts:
    - If user lacks override permission: disable “Override & Create” and show permission message.
    - If user has override permission: enable “Override & Create” only when overrideReason is non-empty.

### Visibility rules
- Show eligibility banner if backend indicates ineligible or submit returns 422.
- Show conflicts section only after a 409 conflict response.
- Show suggested alternatives list only when present in conflict payload.
- Show override inputs only when:
  - conflicts are SOFT-only AND
  - backend indicates overridable=true for those conflicts AND
  - user has override permission (permission name **CLARIFY**; DECISION-SHOPMGMT-007).

### Error messaging expectations
- Use backend-provided safeMessage/message for conflicts; do not invent conflict text.
- For 403/404: “You don’t have access to this facility or item.” (avoid confirming existence; DECISION-SHOPMGMT-012).
- For 422 eligibility: show deterministic guidance based on errorCode (e.g., “Estimate is not eligible for scheduling.”).

---

## 8. Data Requirements

### Entities involved (frontend view models)
- `AppointmentCreateModel` (read model for create screen; backend-owned contract)
- `CreateAppointmentRequest`
- `CreateAppointmentResponse` (success)
- `ConflictResponse` (409)
- `ApiError` (400/422/403/404)

### Fields (types, required, defaults)

**AppointmentCreateModel (response)**
- `sourceType` (string: `ESTIMATE` | `WORK_ORDER`) required
- `sourceId` (string/UUID) required
- `facilityId` (string/UUID) required
- `facilityTimeZoneId` (IANA TZ string, e.g., `America/New_York`) required (DECISION-SHOPMGMT-015)
- `sourceStatus` (string) required
- `isEligible` (boolean) required
- `ineligibilityCode` (string) optional (e.g., `ESTIMATE_NOT_ELIGIBLE`)
- `ineligibilityMessage` (string, safe) optional
- `defaults` (object) optional:
  - `suggestedDurationMinutes` (number) optional
  - `requiredSkills[]` (string[]) optional
  - `preferredSkills[]` (string[]) optional
  - `serviceSummary` (string) optional (must be PII-safe)
- `existingAppointmentId` (string/UUID) optional (if source already linked and backend chooses to reveal; permission-gated server-side)

**CreateAppointmentRequest (submit)**
- `facilityId` (string/UUID) **required** (DECISION-SHOPMGMT-012)
- `sourceType` (string) **required**
- `sourceId` (string/UUID) **required**
- `scheduledStartDateTime` (string, ISO-8601 with offset) **required** (DECISION-SHOPMGMT-015)
- `clientRequestId` (string, UUID recommended) **required** (DECISION-SHOPMGMT-014)
- `overrideSoftConflicts` (boolean) optional, default false
- `overrideReason` (string) conditionally required when overrideSoftConflicts=true (DECISION-SHOPMGMT-007)

**CreateAppointmentResponse (success)**
- `appointmentId` required
- `appointmentStatus` (string) required (opaque; DECISION-SHOPMGMT-013)
- `scheduledStartDateTime` (string, ISO-8601 with offset) required
- `facilityTimeZoneId` required
- `estimateId` optional (when sourceType=ESTIMATE)
- `workOrderId` optional (when sourceType=WORK_ORDER)
- `notificationOutcomeSummary` optional (DECISION-SHOPMGMT-016)

**ConflictResponse (409)**
- `errorCode` = `SCHEDULING_CONFLICT` (string) required (DECISION-SHOPMGMT-011)
- `conflicts[]` required:
  - `severity` (`HARD`|`SOFT`) required (DECISION-SHOPMGMT-002)
  - `code` (string) required
  - `message` (string, safe) required
  - `overridable` (boolean) required
- `suggestedAlternatives[]` optional (DECISION-SHOPMGMT-011):
  - `startDateTime` (ISO-8601 with offset) required
  - `endDateTime` (ISO-8601 with offset) required

### Read-only vs editable by state/role
- On create screen:
  - Editable: scheduledStartDateTime
  - Editable only when allowed by permissions and conflict state: overrideSoftConflicts + overrideReason
  - Read-only: sourceType/sourceId/facilityId, any defaults/hints

### Derived/calculated fields
- Conflict counts by severity (derived from conflicts[])
- “Display time” rendered in facilityTimeZoneId (derived from timestamps + facilityTimeZoneId; DECISION-SHOPMGMT-015)

---

## 9. Service Contracts (Frontend Perspective)

> Contract naming is intentionally conservative; exact service names/paths must match repo conventions (DECISION-SHOPMGMT-011). This story requires the backend contract to be documented before implementation.

### Load/view calls
- **Operation:** Load create model from source  
  **Inputs:** `sourceType`, `sourceId` (and optionally `facilityId` if required by backend for reads)  
  **Returns:** `AppointmentCreateModel` (includes facilityTimeZoneId, eligibility)

### Create/update calls
- **Operation:** Create appointment from source (submit-time conflict detection)  
  **Inputs:** `CreateAppointmentRequest`  
  **Success:** `CreateAppointmentResponse`  
  **Errors:**
  - `400 VALIDATION_ERROR` with `fieldErrors[]`
  - `422` with `errorCode` in `{ESTIMATE_NOT_ELIGIBLE, WORK_ORDER_NOT_ELIGIBLE, OUTSIDE_OPERATING_HOURS, RESCHEDULE_APPROVAL_REQUIRED (N/A for create unless backend uses it)}` (DECISION-SHOPMGMT-011/013)
  - `409 SCHEDULING_CONFLICT` with `conflicts[]` and optional `suggestedAlternatives[]` (DECISION-SHOPMGMT-011)
  - `403/404` for unauthorized/not found without leaking cross-facility existence (DECISION-SHOPMGMT-012)

### Submit/transition calls
- None beyond create in this story.

### Error handling expectations
- Map `fieldErrors[]` to form fields; focus first invalid field.
- For 409 conflicts:
  - Render conflicts list.
  - If any HARD: block; do not show override.
  - If SOFT-only and user has permission: show overrideReason input and “Override & Create” action.
- For timeouts:
  - Offer “Retry” that reuses the same clientRequestId (DECISION-SHOPMGMT-014).
- Correlation:
  - Send `X-Request-Id` header on all calls (DECISION-SHOPMGMT-011).
  - Do not include free-text overrideReason in client logs (DECISION-SHOPMGMT-017).

---

## 10. State Model & Transitions

### Allowed states
- Appointment status is backend-owned; UI treats as opaque string (DECISION-SHOPMGMT-013).
- Create flow states (client-only):
  - `READY` → `SUBMITTING` → `SUCCESS`
  - `SUBMITTING` → `CONFLICTS_RETURNED` (409)
  - `SUBMITTING` → `POLICY_BLOCKED` (422)
  - `SUBMITTING` → `VALIDATION_ERROR` (400)

### Role-based transitions
- `CREATE_APPOINTMENT` required to submit create.
- `OVERRIDE_SCHEDULING_CONFLICT` required to override SOFT conflicts and must provide overrideReason (DECISION-SHOPMGMT-007).
- HARD conflicts have no override path (DECISION-SHOPMGMT-002).

### UI behavior per state
- `CONFLICTS_RETURNED`:
  - Show conflicts and alternatives.
  - If SOFT-only and permitted: show override controls.
- `POLICY_BLOCKED`:
  - Show policy/eligibility message; keep user on screen.
- `SUCCESS`:
  - Navigate to Appointment Detail.

---

## 11. Alternate / Error Flows

- **Ineligible source (422)**
  - Show ineligibility message/code.
  - If `existingAppointmentId` provided, show link to Appointment Detail; otherwise link back to source.
- **Operating hours violation**
  - Presented as HARD conflict (DECISION-SHOPMGMT-008); block create; show suggested alternatives if provided.
- **Conflicts present (409)**
  - HARD present: block; no override.
  - SOFT-only:
    - Without permission: block with message “Manager override required.”
    - With permission: require overrideReason; resubmit with overrideSoftConflicts=true.
- **Idempotent retry after timeout**
  - User retries; UI reuses same clientRequestId; backend returns original success response (DECISION-SHOPMGMT-014).
- **Unauthorized / cross-facility**
  - Show generic access denied; do not reveal whether source exists (DECISION-SHOPMGMT-012).
- **Empty states**
  - No suggestedAlternatives: show “No alternative times provided. Choose a different time.”

---

## 12. Acceptance Criteria

### Scenario 1: Create appointment from eligible estimate with no conflicts
Given I am a Scheduler with `CREATE_APPOINTMENT` for facility F  
And an estimate in status APPROVED or QUOTED exists for facility F  
When I open “Create Appointment” from the estimate  
Then the create screen loads and displays facilityTimeZoneId  
When I enter a scheduledStartDateTime and submit with a clientRequestId  
Then the backend returns success with appointmentId  
And the appointment response includes the estimateId and facilityTimeZoneId  
And I am navigated to Appointment Detail for that appointmentId.

### Scenario 2: Create appointment from ineligible estimate is blocked with 422
Given I am a Scheduler with `CREATE_APPOINTMENT` for facility F  
And an estimate exists with a status other than APPROVED or QUOTED  
When I attempt to create an appointment from that estimate  
Then the backend returns 422 with errorCode ESTIMATE_NOT_ELIGIBLE  
And the UI shows a blocking eligibility message  
And the UI does not navigate to Appointment Detail.

### Scenario 3: HARD conflicts returned on submit block creation and cannot be overridden
Given I am a Scheduler with `CREATE_APPOINTMENT` for facility F  
When I submit create for a scheduledStartDateTime that violates operating hours or a hard scheduling constraint  
Then the backend returns 409 with conflicts including at least one severity=HARD and overridable=false  
And the UI renders the conflict list and any suggestedAlternatives  
And the UI does not render an override action  
And the UI prevents submission until the scheduledStartDateTime is changed.

### Scenario 4: SOFT conflicts require permission and reason to override
Given I am a Scheduler with `CREATE_APPOINTMENT` for facility F  
And the backend returns 409 with conflicts where all are severity=SOFT and overridable=true  
When I do not have `OVERRIDE_SCHEDULING_CONFLICT`  
Then the UI shows that an override is required and blocks “Override & Create”  
When I have `OVERRIDE_SCHEDULING_CONFLICT`  
And I enter a non-empty overrideReason  
And I resubmit with overrideSoftConflicts=true  
Then the backend returns success with appointmentId  
And the UI navigates to Appointment Detail.

### Scenario 5: Idempotent retry does not create duplicates
Given I am a Scheduler with `CREATE_APPOINTMENT` for facility F  
When I submit create with clientRequestId R  
And the request times out in the UI  
And I retry submission using the same clientRequestId R  
Then the backend returns the original success response (same appointmentId)  
And only one appointment exists for that clientRequestId operation.

### Scenario 6: Facility scoping is enforced for writes
Given I am a Scheduler  
When I submit create without facilityId  
Then the backend returns 400 with a field error for facilityId  
And the UI shows the field error and does not submit again automatically.

---

## 13. Audit & Observability
- UI must not display or log customer PII or free-text overrideReason unless explicitly authorized (DECISION-SHOPMGMT-017).
- UI should display, when returned by backend:
  - createdAt/createdBy (if included)
  - a non-sensitive indicator that an override occurred (e.g., “Override applied”) without echoing overrideReason unless backend explicitly returns a safe summary.
- Observability requirements:
  - Send `X-Request-Id` on load and submit calls (DECISION-SHOPMGMT-011).
  - Record client-side telemetry events (non-PII):
    - screen_opened (sourceType, sourceId, facilityId)
    - create_submitted (clientRequestId)
    - create_conflicts_returned (counts hard/soft)
    - create_succeeded (appointmentId)
    - create_failed (errorCode)

---

## 14. Non-Functional UI Requirements
- **Performance:** Create screen load and submit should complete within 2s p95 under normal conditions (frontend target; backend may vary).
- **Accessibility:** All inputs labeled; conflict list is keyboard navigable; focus moves to first error on validation failure.
- **Responsiveness:** Usable on tablet widths; form controls must not require hover.
- **i18n/timezone:** Display and input in facility timezone using facilityTimeZoneId; submit ISO-8601 with offset (DECISION-SHOPMGMT-015).
- **Security:** Do not log free-text fields (overrideReason). Handle 403/404 without leaking existence across facilities (DECISION-SHOPMGMT-012).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-01: Provide empty-state copy when no suggestedAlternatives are returned; qualifies as UI ergonomics; impacts UX Summary, Alternate / Error Flows.
- SD-UX-ERRORMAP-01: Map backend fieldErrors to field-level messages and non-field errors to a page banner; qualifies as standard error-handling; impacts Service Contracts, Alternate / Error Flows.
- SD-OBS-BOILER-01: Emit basic non-PII telemetry and propagate X-Request-Id; qualifies as observability boilerplate; impacts Audit & Observability, Service Contracts.

---

## 16. Open Questions
1. What are the **exact Moqui screen paths and parameter names** in this repo for:
   - Estimate Detail
   - Work Order Detail
   - Appointment Create
   - Appointment Detail  
   (DECISION-SHOPMGMT-011 requires documenting routes per story.)
2. What are the **exact backend service names/endpoints and payload schemas** for:
   - Load AppointmentCreateModel from source
   - Create appointment from source (including 409 conflict payload shape, 422 codes, and success response fields)  
   (This is required to implement Moqui transitions/forms without guessing; DECISION-SHOPMGMT-011.)
3. What are the **exact permission identifiers** used by the POS security model for:
   - CREATE_APPOINTMENT
   - OVERRIDE_SCHEDULING_CONFLICT  
   (Do not guess permission strings; SAFE_DEFAULTS_MODE denylist: security boundaries.)
4. Does the backend return `existingAppointmentId` when a source is already linked, and is that field permission-gated? If not returned, what is the expected UI behavior (message only vs link)?
5. Does the backend require `facilityId` for the **load** call as well, or only for writes (DECISION-SHOPMGMT-012 allows reads to derive facilityId but does not mandate it)?

