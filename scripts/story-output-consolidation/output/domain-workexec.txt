‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #271: [FRONTEND] [STORY] Approval: Capture Digital Customer Approval
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Approval: Capture Digital Customer Approval (Estimate + Work Order)

### Primary Persona
Service Advisor (POS user)

### Business Value
Capture a non-repudiable, auditable digital approval (signature) for an Estimate or Work Order so the business can proceed with authorized work and retain legally defensible proof of consent.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** a POS UI flow to collect a customer‚Äôs digital signature and submit it as a digital approval for an Estimate or Work Order,  
**so that** the entity transitions to Approved and we retain an immutable approval record for audit and dispute resolution.

### In-scope
- UI entry points from Estimate and Work Order views when an approval is required.
- Signature capture UX (strokes + rendered image) and submission to backend approval endpoints.
- Validation + error handling for invalid state, missing fields, authorization failures.
- Display of approval result (approvalId, timestamp, approver metadata if returned).
- Basic audit visibility: show ‚ÄúApproved‚Äù status and an Approval summary section when API provides it.

### Out-of-scope
- Backend implementation (assumed provided by backend story).
- PDF signing / PDF rendering in frontend (only display reference if returned).
- Configuring approval methods (location/customer policy screens).
- Notifications (SMS/email) for electronic signature workflows.
- Editing estimate line items / versioning flows (covered elsewhere).

---

## 3. Actors & Stakeholders
- **Service Advisor (primary actor):** initiates approval capture in POS, guides customer.
- **Customer (external actor):** signs on device.
- **Audit/Compliance stakeholder:** requires immutable traceability and metadata.
- **Billing stakeholder (downstream):** relies on Approved state to proceed.

---

## 4. Preconditions & Dependencies
- User is authenticated in POS.
- A target **Estimate** or **Work Order** exists and is retrievable in the frontend.
- Target entity is in a backend-defined ‚Äúapproval required‚Äù state.
- Backend APIs available (exact canonical paths must be confirmed; see Open Questions):
  - `POST /api/v1/estimates/{estimateId}/approvals`
  - `POST /api/v1/work-orders/{workOrderId}/approvals`
- Frontend has (or will add) a signature capture component capable of:
  - capturing stroke vectors (x/y/timestamp)
  - producing a PNG image encoded as Base64
- Routing exists to view Estimate and Work Order details.
- **Idempotency:** UI must send `Idempotency-Key` for submit operations and reuse it on retry for the same attempt (DECISION-INVENTORY-012).
- **Error envelope:** Backend errors should conform to standard envelope with `code`, `message`, `correlationId`, optional `fieldErrors[]` (DECISION-INVENTORY-011).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Estimate Edit/Detail** screen: action ‚ÄúCapture Digital Approval‚Äù visible only when estimate status indicates approval is required.
- From **Work Order Edit/Detail** screen: action ‚ÄúCapture Digital Approval‚Äù visible only when work order status indicates approval is required.

### Screens to create/modify
1. **Modify** `component://durion-workexec/screen/workexec/EstimateEdit.xml`
   - Add action to open approval capture screen/modal.
2. **Modify** `component://durion-workexec/screen/workexec/WorkOrderEdit.xml`
   - Add action to open approval capture screen/modal.
3. **Create** reusable approval capture screen (workexec-owned):
   - `component://durion-workexec/screen/workexec/approval/DigitalApprovalCapture.xml`
   - Reused for both entity types via parameters: `targetType`, `targetId`.

### Navigation context
- Approval capture screen must preserve context:
  - ‚ÄúBack to Estimate‚Äù or ‚ÄúBack to Work Order‚Äù
  - On success, return to originating screen and refresh entity data.

### User workflows (happy + alternate)
**Happy path (Estimate):**
1. Advisor opens Estimate edit/detail in ‚Äúawaiting customer approval‚Äù.
2. Clicks ‚ÄúCapture Digital Approval‚Äù.
3. Customer signs on device; advisor reviews ‚ÄúYou are approving‚Äù summary.
4. Advisor submits approval.
5. UI shows success and refreshes estimate; status shows Approved.

**Happy path (Work Order):**
Same flow via Work Order edit/detail.

**Alternate paths:**
- Clear signature and re-sign.
- Cancel approval capture and return without changes.
- Submission rejected due to state change (409) ‚Üí show message and refresh entity; if no longer eligible, return to detail.

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúCapture Digital Approval‚Äù from Estimate/WorkOrder screen.

### UI actions
- Render signature capture area and controls:
  - ‚ÄúClear‚Äù
  - ‚ÄúSubmit Approval‚Äù
  - ‚ÄúCancel‚Äù
- Display a read-only ‚ÄúYou are approving‚Äù summary derived from the loaded entity (see Data Requirements).
- On submit:
  - Validate signature is not empty.
  - Generate Base64 PNG from canvas.
  - Build request payload expected by backend (minimum fields only; do not invent business payload keys).
  - Send `Idempotency-Key` header (UUID) for the submit attempt; reuse same key if user retries after a network error/time-out for the same captured signature attempt.
  - Call correct endpoint based on `targetType`.

### State changes (frontend)
- While submitting: show loading state; disable inputs to prevent double submit.
- On success:
  - Show confirmation (toast + inline summary).
  - Navigate back to originating detail screen and refresh entity data.
- On failure:
  - Keep user on capture screen (unless 404/not found) and show actionable error message.
  - If 409, offer ‚ÄúRefresh status‚Äù which reloads entity and exits capture if no longer eligible.

### Service interactions
- Load entity detail (Estimate/WorkOrder) to:
  - determine eligibility
  - populate approval summary
  - provide any concurrency token if required (unknown; see Open Questions)
- Submit approval via POST endpoint.
- Optional: if submit response includes approval summary, display it immediately; otherwise rely on refreshed entity.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Signature required:** ‚ÄúSubmit Approval‚Äù disabled until signature canvas contains strokes and PNG generation succeeds.
- **Backend authoritative eligibility:** UI hides entry points when entity is not eligible, but backend remains authoritative; handle 409/400 gracefully (DECISION-INVENTORY-007 principle: server authoritative gating).
- **Immutable approval:** after success, UI must not allow editing the approval artifact; only view summary.
- **Idempotent submit:** UI must prevent duplicates via disabled submit + `Idempotency-Key` reuse on retry (DECISION-INVENTORY-012).

### Enable/disable rules
- Disable ‚ÄúSubmit Approval‚Äù when:
  - signature empty
  - submit in progress
- Disable ‚ÄúClear‚Äù and signature input while submit in progress.

### Visibility rules
- ‚ÄúCapture Digital Approval‚Äù action visible only when entity status indicates ‚Äúawaiting customer approval‚Äù.
- If user deep-links to capture screen and entity is not eligible:
  - show blocking message ‚ÄúThis item is not awaiting customer approval.‚Äù
  - provide navigation back to the entity screen.

### Error messaging expectations (standard envelope aware)
- Parse standard error envelope when present:
  - show `message` to user when safe and non-technical
  - log/display `correlationId` in an expandable ‚ÄúDetails‚Äù section for support
- 400: ‚ÄúApproval could not be submitted. Please complete required fields and try again.‚Äù
- 403: ‚ÄúYou don‚Äôt have permission to record approvals.‚Äù
- 404: ‚ÄúThis estimate/work order could not be found.‚Äù
- 409: ‚ÄúThis estimate/work order is no longer awaiting approval (it may have been approved or changed). Please refresh.‚Äù

---

## 8. Data Requirements

### Entities involved
- **Estimate** (read; SoR outside this story, consumed by workexec UI)
  - `estimateId` (opaque string; DECISION-INVENTORY-003)
  - `statusId` (string enum)
  - optional display fields for summary: `customerName`, `vehicleSummary`, `totalAmount`, `currencyUomId`, `updatedDate`
  - optional concurrency token: `version`/`lastUpdatedStamp`/`documentDigest` (unknown; see Open Questions)
- **Work Order** (read; workexec SoR for execution lifecycle)
  - `workOrderId` (opaque string; DECISION-INVENTORY-003)
  - `statusId` (string enum)
  - optional display fields for summary: `appointmentId`, `totalAmount`, `currencyUomId`, `updatedDate`
  - optional concurrency token: `version`/`lastUpdatedStamp`/`documentDigest` (unknown; see Open Questions)
- **Approval** (write; read optional)
  - `approvalId` (opaque string)
  - `approvedAt` timestamp
  - `approvalMethod` (display label ‚ÄúDigital Signature‚Äù)
  - optional: `approvalSummary` returned by API

### Fields captured in UI (types, required)
- Route params:
  - `targetType`: enum `{ESTIMATE, WORK_ORDER}` (required)
  - `targetId`: string (required; opaque)
  - `returnUrl`: string (optional; if absent, compute default back link)
- Signature capture:
  - `signatureImageBase64Png`: string (required)
  - `signatureStrokes`: array (optional unless backend requires)
    - each stroke point: `{ x:number, y:number, t:number }` (t = milliseconds since epoch or since capture start; must be confirmed)
- Approval submission payload (minimum; schema must be confirmed):
  - `customerSignatureData.signatureImage` (required)
  - `customerSignatureData.signatureStrokes` (optional)
  - `approvalPayload` (required but schema unknown; see Open Questions)

### Read-only vs editable
- Entity identifiers and summary fields: read-only.
- Signature: editable until submit.
- After successful submit: screen navigates away; no edits allowed.

### Derived/calculated fields
- Rendered PNG derived from strokes/canvas.
- ‚ÄúYou are approving‚Äù summary derived from loaded entity (amount/currency/status/last updated).

---

## 9. Service Contracts (Frontend Perspective)

> Contract paths are currently inconsistent across provided docs (`/api/...` vs `/api/v1/...` vs `/api/workorders/...`). This story requires confirmation of canonical paths before implementation (Open Questions).

### Load/view calls
- Estimate detail (required):
  - `GET <ESTIMATE_DETAIL_ENDPOINT>` (must return at least `id/status` and summary fields)
- Work order detail (required):
  - `GET <WORK_ORDER_DETAIL_ENDPOINT>` (must return at least `id/status` and summary fields)

### Create/update calls (approval capture)
- Estimate approval submit:
  - `POST <ESTIMATE_APPROVAL_ENDPOINT>`
  - Headers:
    - `Idempotency-Key: <uuid>` (required; DECISION-INVENTORY-012)
  - Request body (minimum):
    ```json
    {
      "customerSignatureData": {
        "signatureImage": "<base64-png>",
        "signatureStrokes": []
      },
      "approvalPayload": {}
    }
    ```
  - Response:
    - `201 Created` (preferred) or `200 OK` (acceptable if existing pattern)
    - Body should include at least `approvalId` and `approvedAt` OR enough to refresh entity.

- Work order approval submit:
  - `POST <WORK_ORDER_APPROVAL_ENDPOINT>`
  - Same header/body expectations.

### Submit/transition calls
- The approval POST implicitly transitions entity status to Approved on success.

### Error handling expectations
- Errors should conform to standard envelope (DECISION-INVENTORY-011):
  ```json
  {
    "code": "CONFLICT",
    "message": "‚Ä¶",
    "correlationId": "‚Ä¶",
    "fieldErrors": [{"field":"‚Ä¶","message":"‚Ä¶"}]
  }
  ```
- UI behavior by status:
  - 400: show validation message; highlight missing signature if applicable
  - 403: show permission error; disable submit
  - 404: show not found; provide back navigation
  - 409: show conflict; provide refresh action
  - 5xx/network: show retry option; reuse same `Idempotency-Key` on retry for same attempt

---

## 10. State Model & Transitions

### Allowed states (minimum for this story)
**Estimate** (from provided customer approval workflow doc):
- `DRAFT` (approval action may be available depending on policy; unclear)
- `APPROVED` (not eligible for capture)
- `DECLINED` (not eligible)
- `EXPIRED` (not eligible)

**Work Order** (workexec taxonomy varies across docs; must confirm exact statuses used in Moqui UI):
- A state representing ‚Äúawaiting customer approval‚Äù (eligible)
- A state representing ‚Äúapproved‚Äù (not eligible)

### Role-based transitions
- Service Advisor initiates approval capture.
- Backend enforces authorization; UI may hide action based on capability signal if available (DECISION-INVENTORY-013), but must still handle 403.

### UI behavior per state
- Eligible (‚Äúawaiting approval‚Äù): show capture action.
- Not eligible: hide capture action; deep-link shows blocking message.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Empty signature ‚Üí inline error ‚ÄúSignature is required.‚Äù
- PNG generation failure ‚Üí block submit; show ‚ÄúUnable to capture signature. Please clear and try again.‚Äù

### Backend validation failures
- 400 with `fieldErrors` ‚Üí show field-level messages; keep user on screen.
- 400 integrity mismatch (if backend validates payload digest) ‚Üí show ‚ÄúApproval validation failed. Please reload and try again.‚Äù and provide ‚ÄúReload‚Äù action.

### Concurrency conflicts
- If entity changes while signing:
  - POST returns 409
  - UI shows conflict message and offers ‚ÄúRefresh status‚Äù
  - After refresh, if no longer eligible, return to detail.

### Unauthorized access
- 403 ‚Üí show permission error; provide back navigation; do not mark approved locally.

### Empty states
- Entity load 404 ‚Üí show not found; disable submit; provide link back to list or previous screen.

---

## 12. Acceptance Criteria

### Scenario 1: Capture digital approval for Work Order (success)
Given a Work Order with id "WO-123" is in an approval-eligible status  
And the Service Advisor is on the Work Order edit/detail screen  
When the user selects "Capture Digital Approval"  
And the customer provides a non-empty signature  
And the user submits the approval  
Then the system sends a POST request to the canonical Work Order approval endpoint for "WO-123" with header `Idempotency-Key`  
And the request body includes `customerSignatureData.signatureImage` and `approvalPayload`  
And the UI displays a success confirmation  
And the Work Order detail is refreshed and shows an approved status

### Scenario 2: Capture digital approval for Estimate (success)
Given an Estimate with id "EST-456" is in an approval-eligible status  
When the user captures a non-empty signature and submits approval  
Then the system POSTs to the canonical Estimate approval endpoint for "EST-456" with header `Idempotency-Key`  
And the UI refreshes the Estimate detail to show an approved status

### Scenario 3: Prevent submit when signature is empty
Given the user is on the digital approval capture screen for an approval-eligible entity  
When the signature area is empty  
Then the "Submit Approval" action is disabled  
And attempting to submit shows "Signature is required."

### Scenario 4: Backend rejects due to invalid state (409)
Given a Work Order "WO-456" is no longer in an approval-eligible status  
When the user submits a digital approval  
Then the UI shows a conflict message indicating the work order is no longer awaiting approval  
And the UI offers a "Refresh status" action  
And after refresh the UI returns to the Work Order detail screen if the work order is not eligible

### Scenario 5: Backend rejects due to incomplete payload (400)
Given an approval-eligible entity is loaded in the capture screen  
When the user submits approval with missing required fields  
Then the UI displays a validation error using backend `fieldErrors` when provided  
And the entity status remains unchanged in the UI after refresh

### Scenario 6: Unauthorized approval attempt (403)
Given the current user lacks permission to record approvals  
When they submit a digital approval  
Then the UI shows a permission error  
And no local state is marked as approved  
And the UI displays the backend `correlationId` (when provided) in a details area for support

### Scenario 7: Idempotent retry on network failure
Given the user submits a digital approval and the network request times out  
When the user retries submission without changing the signature  
Then the UI reuses the same `Idempotency-Key` value  
And the backend response results in at most one approval being recorded  
And the UI ends in a single success state (no duplicate confirmations)

---

## 13. Audit & Observability

### User-visible audit data
After successful approval, show at minimum (from response or refreshed entity):
- Approved status
- approval timestamp (if available)
- approvalId (if available)
- approval method label ‚ÄúDigital Signature‚Äù

### Status history
- If existing Estimate/WorkOrder screens include a history section, it must reflect the status change after refresh.
- No new history UI is required in this story.

### Traceability expectations
- UI must log/retain `correlationId` from error envelope for support workflows (DECISION-INVENTORY-011).
- Do not log raw Base64 signature image; treat as sensitive payload (redact in client logs).

---

## 14. Non-Functional UI Requirements
- **Performance:** signature capture must remain responsive; avoid heavy re-renders while drawing.
- **Accessibility (WCAG 2.1):**
  - Keyboard-accessible controls for Clear/Submit/Cancel.
  - Text instructions for signature capture.
  - Visible focus indicators.
- **Responsiveness:** works on tablet and desktop; signature area scales.
- **i18n/timezone/currency:** display amounts/currency using existing formatting utilities; timestamps displayed in user timezone and labeled if shown (DECISION-INVENTORY-016).

---

## 15. Applied Safe Defaults
- none

---

## 16. Open Questions

1. **Canonical API paths (blocking):** What are the exact canonical endpoints for:
   - Estimate detail GET
   - Work order detail GET
   - Estimate approval POST
   - Work order approval POST  
   The provided docs conflict (`/api/v1/...` vs `/api/...` vs `/api/workorders/...`). Provide the definitive paths used by the Moqui frontend proxy/router.

2. **Eligibility status mapping (blocking):** What exact `statusId` values indicate:
   - ‚Äúawaiting customer approval‚Äù (eligible)
   - ‚Äúapproved‚Äù (ineligible)  
   for both Estimate and Work Order in this Moqui implementation?

3. **Approval payload schema (blocking):** What is the required JSON schema for `approvalPayload` for both endpoints, including any required document digest/version fields to prevent approving stale totals?

4. **Signature strokes requirement (blocking):** Are `signatureStrokes` required or optional? If required, specify:
   - coordinate system (canvas pixels? normalized 0..1?)
   - timestamp semantics (`t` units and origin)
   - expected stroke grouping (single array vs array-of-strokes)

5. **Signer identity (blocking):** Is the signer represented as:
   - customer identity (and how is it represented/selected in POS?), or
   - advisor identity only (customer is implicit), or
   - omitted/derived server-side?  
   If a customer identifier is required, specify the field name and source.

6. **Response shape (non-blocking but needed for UX):** On successful approval, does the POST response include `approvalId`, `approvedAt`, and/or an approval summary? If not, which field on the entity indicates approval metadata after refresh?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Approval: Capture Digital Customer Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/271  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ü§ñ Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #20 - Approval: Capture Digital Customer Approval  
**URL**: https://github.com/louisburroughs/durion/issues/20  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:37:51.888477534*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #269: [FRONTEND] [STORY] Approval: Record Partial Approval
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Approval: Record Partial Approval (Work Order)

### Primary Persona
Service Advisor

### Business Value
Enable a Service Advisor to record customer approval/decline decisions per work order line item so authorized work can proceed while declined work remains clearly tracked, auditable, and excluded from execution/billing.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to record partial approval for a Work Order by approving some line items and declining others (including capturing approval method/proof)  
- **So that** technicians only execute authorized work, totals reflect only approved items, and the system maintains a compliant audit trail.

### In-Scope
- A Work Order ‚ÄúRecord Approval‚Äù UI that:
  - Loads work order + line items requiring approval
  - Allows per-line approval decisions (approve/decline)
  - Captures approval method/proof according to backend-provided configuration/requirements
  - Submits approval decisions in a single atomic confirmation action (idempotent)
  - Displays resulting Work Order status and approved total returned by backend
- Read-only display of relevant audit/approval metadata after submission (method, timestamp, proof reference if any)
- Concurrency-safe submission behavior (409 handling + reload)

### Out-of-Scope
- Creating or editing estimates/prices/line items themselves
- Customer communication (SMS/email collection or sending links)
- Scheduling ‚Äúamendment workflow‚Äù UI (only display backend-provided indicator if any)
- Implementing signature capture mechanics beyond a basic integration hook (depends on backend contract)
- Defining new workflow states beyond authoritative workexec state machine

---

## 3. Actors & Stakeholders
- **Service Advisor (primary)**: Records customer decisions and approval artifact.
- **Customer**: Provides approval/decline decisions.
- **Technician/Mechanic**: Consumes outcomes to know what is authorized.
- **Manager/Auditor**: Reviews approval history and proof.
- **System (POS)**: Validates state, persists immutable approval records, emits audit events.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend.
- Work Order exists and is accessible to the user (location membership + permission).
- Work Order is in a state that permits recording approvals (expected: `AWAITING_APPROVAL` per workexec FSM doc).

### Dependencies (Blocking if missing)
- Backend endpoints/services to:
  - Load Work Order details including line items and current approval statuses
  - Provide applicable approval configuration/requirements for Work Order approval capture (either embedded in Work Order payload or via a separate endpoint)
  - Submit partial approval decisions atomically (single request) with method/proof
  - Enforce approval window rules (if any) and return deterministic error codes
  - Return standard error envelope (`code`, `message`, `correlationId`, optional `fieldErrors[]`)
- Backend-defined enums/status values for:
  - Work Order status allowing approval entry (expected: `AWAITING_APPROVAL`)
  - Line item approval statuses
  - Approval method identifiers and proof requirements
- Idempotency support for submit endpoint (UI sends `Idempotency-Key`) per DECISION-INVENTORY-012.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order edit/detail screen (Moqui): action button **‚ÄúRecord Approval‚Äù**
- Deep link route (Moqui screen transition): `.../WorkOrderEdit?workOrderId=<id>#approval` (exact URL depends on existing screen routing; see Screens below)

### Screens to create/modify
1. **Modify** `durion-workexec/WorkOrderEdit.xml`
   - Add a conditional action/button ‚ÄúRecord Approval‚Äù
   - Button visible/enabled only when:
     - Work order status is `AWAITING_APPROVAL`
     - User has capability/permission to record approvals (capability flag if available; backend still enforces)
   - Button transitions to a new approval capture subscreen (see #2)

2. **Create** `durion-workexec/WorkOrderApprovalRecord.xml` (new screen)
   - Parameters: `workOrderId` (required, opaque string)
   - Loads work order header + approval-eligible line items
   - Provides per-line decision controls: Approved / Declined
   - Shows computed ‚ÄúApproved Total (Preview)‚Äù (client-side preview only)
   - Shows approval method/proof section driven by backend-provided requirements
   - Actions:
     - ‚ÄúConfirm Approval‚Äù (submits)
     - ‚ÄúCancel‚Äù (returns to WorkOrderEdit)

### Navigation context
- Back/breadcrumb returns to Work Order edit/detail (`WorkOrderEdit.xml`) for the same `workOrderId`.
- After successful confirmation:
  - Redirect to `WorkOrderEdit.xml` and show a success message banner
  - WorkOrderEdit should reflect updated line item statuses and work order status from backend

### User workflows (happy + alternate paths)

#### Happy path: approve some, decline some
1. Advisor opens WorkOrderEdit and clicks ‚ÄúRecord Approval‚Äù.
2. Approval screen loads work order + line items + approval requirements.
3. Advisor selects Approved/Declined per line.
4. Advisor provides required proof (if required by method).
5. Advisor clicks Confirm.
6. Backend persists decisions atomically and returns updated work order summary.
7. UI redirects to WorkOrderEdit with success banner.

#### Alternate: all declined
- Same flow; backend returns updated work order status (terminal state per backend) and approved total = 0.

#### Alternate: user cancels
- Cancel returns to WorkOrderEdit without saving; discard local changes (with dirty-form prompt).

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúRecord Approval‚Äù from WorkOrderEdit
- User visits approval record screen directly with `workOrderId`

### UI actions
- **Load**
  - Fetch Work Order details (including line items and current approval statuses)
  - Fetch approval requirements/config (if not embedded)
- **Edit**
  - For each approval-eligible line item, choose `APPROVED` or `DECLINED`
- **Preview**
  - Compute `totalApprovedAmountPreview = sum(line.extendedAmount for lines marked APPROVED)` (display-only)
- **Confirm**
  - Submit all decisions in one request
  - Include `Idempotency-Key` header for the submit attempt; reuse on retry of the same attempt
- **Cancel**
  - Discard changes and navigate back

### State changes (frontend-visible)
- On success, line items‚Äô approval statuses update per backend response.
- Work Order status updates per backend response.
- UI must not assume specific post-approval status values beyond what backend returns.

### Service interactions (high level)
- Load Work Order detail (includes line items + current statuses)
- Load approval requirements/config (if separate)
- Submit partial approval decisions (atomic, idempotent)
- Handle errors via standard envelope:
  - invalid state
  - validation failures (missing decisions/proof)
  - approval window expired (if supported)
  - auth/forbidden
  - conflicts (stale version / concurrent update)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- ‚ÄúRecord Approval‚Äù action is only available when Work Order status is `AWAITING_APPROVAL` (DECISION-INVENTORY-004 status-based gating; FSM doc includes `AWAITING_APPROVAL`).
- Each approval-eligible line item must be set to either Approved or Declined before enabling Confirm.
- Proof requirements are backend-driven:
  - If backend indicates proof required (e.g., signature required), Confirm remains disabled until proof is present.
- Backend is authoritative for any approval window rules; UI may display remaining time if provided but must not compute policy.

### Enable/disable rules
- Disable Confirm until:
  - Data fully loaded
  - No client-side validation errors (missing decisions, missing required proof fields)
  - All editable approval-eligible line items have a decision
- Disable per-line decision controls when backend indicates line is not editable (e.g., already executed, already invoiced, or locked by state).

### Visibility rules
- Approval method/proof section renders based on backend-provided method and requirements:
  - If method is ‚Äúclick confirm‚Äù style: show confirmation checkbox and capture advisor note if required by backend
  - If method is signature: show signature capture placeholder component and ‚ÄúClear‚Äù action
  - If method is verbal confirmation: show required note field(s) if backend supports
- If backend returns an unsupported method identifier, UI must:
  - Block submission
  - Show an error banner: ‚ÄúThis approval method is not supported in this POS UI. Contact support.‚Äù with `correlationId` (if present)

### Error messaging expectations (user-facing)
- Invalid state: ‚ÄúApproval can only be recorded when the Work Order is awaiting approval.‚Äù
- Validation: ‚ÄúPlease select Approved or Declined for all items.‚Äù / ‚ÄúApproval proof is required.‚Äù
- Permission denied: ‚ÄúYou don‚Äôt have permission to record approvals for this Work Order.‚Äù
- Conflict/concurrency: ‚ÄúThis Work Order was updated by someone else. Reload and try again.‚Äù
- Window expired (if backend supports): ‚ÄúApproval window has expired. A new estimate/work order is required.‚Äù

---

## 8. Data Requirements

### Entities involved (frontend consumption)
- **WorkOrder** (workexec SoR)
  - `workOrderId` (opaque string id)
  - `statusId` (string enum; includes `AWAITING_APPROVAL`)
  - `customerId` (opaque string id)
  - `locationId` or `shopId` (opaque string id; for config resolution if needed)
  - `appointmentId` (optional; opaque string id)
  - `totalApprovedAmount` (decimal + currency code if available)
  - `updatedAt` (datetime) and/or `version` (string/number) if optimistic concurrency is supported
- **WorkOrder line items**
  - Must support both services and parts (may be separate entities):
    - `workOrderServiceId` / `workOrderPartId` (opaque string id)
    - `itemType` (`SERVICE` | `PART`)
    - `description`
    - `quantity` (decimal; do not assume integer)
    - `unitAmount` and/or `extendedAmount` (decimal + currency code if available)
    - `approvalStatus` (enum; at minimum includes `PENDING_APPROVAL`, `APPROVED`, `DECLINED`)
    - `isEditableForApproval` (boolean; backend-driven)
    - `approvalRecordedAt` (datetime, optional)
    - `approvalRecordedBy` (user id/name, optional)
    - `approvalMethodUsed` (enum/string, optional)
    - `approvalProofRef` (string, optional; reference only, no raw signature payload)
- **Approval requirements/config (resolved)**
  - `approvalMethod` (enum/string)
  - `requireSignature` (boolean) OR a more explicit `proofRequirements` object
  - Optional: `approvalWindowEnd` (datetime) if backend supports windowing

### Fields (type, required, defaults)
- `workOrderId`: required, opaque string
- For each editable line item: decision required (`APPROVED` or `DECLINED`)
- `approvalMethod`: required (from backend-resolved config)
- `approvalNote`: optional unless backend requires it (must be treated as required if backend indicates)
- `proof`: required only when backend indicates (e.g., signature)

### Read-only vs editable by state/role
- Entire screen is read-only if Work Order status is not `AWAITING_APPROVAL` or user lacks permission.
- Line items are editable only when backend marks them editable for approval capture.

### Derived/calculated fields
- `totalApprovedAmountPreview`: client-side sum for immediate feedback; backend total is authoritative.
- `approvalWindowRemaining`: derived only if backend provides `approvalWindowEnd` (display-only).

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: Exact backend endpoints and payload schemas for Work Order partial approval are not provided in authoritative references. This story defines required contract shape but cannot finalize endpoint paths without confirmation.

### Load/view calls
- **Work Order detail**
  - `GET /rest/api/v1/workexec/workorders/{workOrderId}`
  - Response must include:
    - work order header fields
    - line items (services and parts) with approval statuses and editability flags
- **Approval requirements/config**
  - Either embedded in the Work Order detail response, OR:
  - `GET /rest/api/v1/workexec/workorders/{workOrderId}/approval-requirements`
  - Must return resolved method and proof requirements (customer > location > default precedence handled server-side)

### Submit/transition calls
- **Submit partial approval decisions (atomic)**
  - `POST /rest/api/v1/workexec/workorders/{workOrderId}/approvals:record-partial` (proposed)
  - Headers:
    - `Idempotency-Key: <uuid>` (required for submit) per DECISION-INVENTORY-012
  - Request (required shape; field names may vary but semantics must match):
```json
{
  "approvalMethod": "CLICK_CONFIRM",
  "approvalNote": "Customer approved items 1-2, declined item 3",
  "proof": {
    "type": "SIGNATURE",
    "signatureRef": "file-or-token-ref"
  },
  "lineDecisions": [
    { "lineType": "SERVICE", "lineId": "WOS-1", "decision": "APPROVED" },
    { "lineType": "PART", "lineId": "WOP-9", "decision": "DECLINED" }
  ],
  "version": "optional-if-supported"
}
```
  - Response:
    - `200 OK` with updated Work Order summary + updated line items (preferred)
    - Must include `statusId`, `totalApprovedAmount`, and updated approval fields per line

### Error handling expectations
- All non-2xx errors return standard envelope (DECISION-INVENTORY-011):
```json
{
  "code": "VALIDATION_ERROR",
  "message": "Approval proof is required",
  "correlationId": "c-123",
  "fieldErrors": [{ "field": "proof", "message": "Required" }]
}
```
- `409 Conflict` used for:
  - optimistic concurrency failure (stale `version`)
  - invalid transition due to state change
  - duplicate/idempotency replay conflicts (if applicable)
- UI behavior:
  - Show user-friendly banner
  - Log `correlationId` (and include in support copy UI if present)
  - Offer ‚ÄúReload‚Äù on 409

---

## 10. State Model & Transitions

### Allowed states (authoritative references)
Per `WORKORDER_STATE_MACHINE.md`:
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

### Approval-related expectations for this story
- Recording approval decisions is allowed only when Work Order is in `AWAITING_APPROVAL`.
- Post-submit status is backend-defined; UI must display returned `statusId` and not hardcode transitions.
  - Rationale: FSM doc does not define a dedicated ‚Äúdeclined‚Äù terminal state; only `CANCELLED` exists. Backend must be authoritative for mapping ‚Äúall declined‚Äù outcomes.

### Role-based transitions
- Service Advisor can record approvals (permission/capability required; backend enforces with 403).
- UI should use capability flags if available (DECISION-INVENTORY-013) but must not rely solely on them.

### UI behavior per state
- If status != `AWAITING_APPROVAL`:
  - Hide/disable ‚ÄúRecord Approval‚Äù action on WorkOrderEdit
  - Direct URL to approval screen shows read-only error banner and back link

---

## 11. Alternate / Error Flows

1. **Invalid state (user tries direct URL)**
   - Show error banner
   - Disable all inputs and Confirm
   - Provide ‚ÄúBack to Work Order‚Äù action

2. **User cancels with unsaved changes**
   - Prompt ‚ÄúDiscard changes?‚Äù (dirty-form confirm)
   - If confirmed, navigate back without calling backend

3. **Backend rejects due to missing proof / validation**
   - Keep user selections
   - Highlight fields based on `fieldErrors[]` when provided
   - Show banner with `message`

4. **Concurrency conflict (409)**
   - Show banner ‚ÄúReload to continue‚Äù
   - Provide one-click reload that refetches Work Order and rehydrates UI
   - Do not auto-resubmit without explicit user action

5. **Unauthorized (403)**
   - Show not-authorized message
   - Hide Confirm
   - Provide back link

6. **Empty state: no approval-eligible items**
   - Show message ‚ÄúNo items require approval.‚Äù
   - Disable Confirm
   - Provide back link

7. **Idempotent retry / double-submit**
   - If user double-clicks Confirm or network retries:
     - UI must reuse the same `Idempotency-Key` for the same attempt
     - If backend returns success for the same key, treat as success and proceed

---

## 12. Acceptance Criteria

### Scenario 1: Successful partial approval (some approved, some declined)
**Given** a Service Advisor is authenticated  
**And** a Work Order is in `AWAITING_APPROVAL` state  
**And** the Work Order has 3 approval-eligible line items with `approvalStatus = PENDING_APPROVAL`  
**When** the advisor marks item 1 and 2 as `APPROVED` and item 3 as `DECLINED`  
**And** the advisor provides any required approval proof based on backend-provided requirements  
**And** the advisor clicks ‚ÄúConfirm Approval‚Äù  
**Then** the frontend sends a single atomic request containing all line item decisions and the approval method/proof  
**And** the request includes an `Idempotency-Key` header  
**And** on success the UI displays updated line item approval statuses from the response  
**And** the UI displays the backend-returned `totalApprovedAmount`  
**And** the UI navigates back to Work Order detail/edit showing the backend-returned `statusId`.

### Scenario 2: All items declined results in backend terminal outcome
**Given** a Work Order is in `AWAITING_APPROVAL`  
**And** it has 2 line items pending approval  
**When** the advisor marks both as `DECLINED` and confirms  
**Then** the UI shows `totalApprovedAmount` as 0 (from backend response)  
**And** the UI shows the Work Order `statusId` as returned by backend  
**And** the ‚ÄúRecord Approval‚Äù action is no longer available if the returned status is not `AWAITING_APPROVAL`.

### Scenario 3: Record Approval is blocked for invalid Work Order state
**Given** a Work Order is in `WORK_IN_PROGRESS`  
**When** the advisor attempts to open the Record Approval screen  
**Then** the UI blocks editing and displays ‚ÄúApproval can only be recorded when the Work Order is awaiting approval.‚Äù  
**And** no submit action is available.

### Scenario 4: Proof required blocks submission until provided
**Given** a Work Order is in `AWAITING_APPROVAL`  
**And** backend-provided approval requirements indicate proof is required (e.g., signature)  
**When** the advisor selects decisions for all line items but does not provide proof  
**Then** the Confirm button remains disabled  
**And** the UI indicates proof is required  
**When** the advisor provides proof and clicks Confirm  
**Then** the request includes the proof reference/payload as required by backend.

### Scenario 5: Concurrency conflict prompts reload
**Given** a Work Order is in `AWAITING_APPROVAL`  
**And** the advisor has selected decisions  
**When** the advisor clicks Confirm  
**And** the backend responds `409 Conflict` with a standard error envelope including `correlationId`  
**Then** the UI displays a conflict banner with a ‚ÄúReload‚Äù action  
**And** clicking Reload refetches the Work Order and updates the screen  
**And** the UI does not mark the approval as successful.

### Scenario 6: Idempotent double-submit does not create duplicate approvals
**Given** a Work Order is in `AWAITING_APPROVAL`  
**When** the advisor clicks Confirm twice quickly  
**Then** the frontend reuses the same `Idempotency-Key` for the second attempt  
**And** the UI ends in a single successful state consistent with the backend response  
**And** no duplicate approval records are shown in the UI (as evidenced by stable line item statuses and a single approval timestamp set per line).

---

## 13. Audit & Observability

### User-visible audit data
After successful confirmation, WorkOrderEdit (or approval screen summary) shows read-only:
- approval recorded timestamp (backend-provided)
- recorded by (user display name/id if returned)
- approval method used
- proof reference presence (e.g., ‚ÄúSignature on file‚Äù) without displaying sensitive payload

### Status history / traceability expectations
- If WorkOrderEdit already supports transition history (per `WORKORDER_STATE_MACHINE.md` endpoints conceptually), provide a link ‚ÄúView Status History‚Äù.
- Frontend must:
  - Capture and log `correlationId` from error envelope
  - Include `Idempotency-Key` in client logs for submit attempts (redact if policy requires; do not show to end user unless support workflow requires)

---

## 14. Non-Functional UI Requirements

- **Performance**: initial load under 2s on typical store network for ‚â§ 100 line items; show loading state.
- **Accessibility**: WCAG 2.1 AA; keyboard navigable decision controls; errors announced.
- **Responsiveness**: usable on tablet width; list supports vertical scrolling.
- **i18n**: all user-visible strings via standard localization mechanism.
- **Timezone**: display timestamps in user timezone and label timezone when shown (DECISION-INVENTORY-016).
- **Currency**: display money using store currency formatting; no client-side currency conversion.

---

## 15. Applied Safe Defaults
- SD-UX-01 (Dirty form confirm): Prompt before discarding unsaved changes on Cancel/back; safe as it‚Äôs UI ergonomics only. Impacted: UX Summary, Alternate Flows.
- SD-UX-02 (Loading/empty states): Use standard loading indicator and explicit empty-state message when no line items; safe as it does not alter business logic. Impacted: UX Summary, Error Flows.
- SD-ERR-01 (Generic error mapping): Map HTTP 401/403/404/409 to standard user-friendly banners while preserving backend error codes for logs; safe as it‚Äôs presentation-layer handling. Impacted: Service Contracts, Error Flows.

---

## 16. Open Questions

1. **Backend contract (blocking):** What are the exact REST endpoints (paths) and payload schemas for:
   - loading Work Order detail with approval fields
   - loading approval requirements/config for Work Order
   - submitting partial approval decisions (atomic)  
   (This story proposes shapes but cannot finalize without backend confirmation.)
2. **Line item identifiers (blocking):** Does the Work Order API return separate collections for `WorkOrderService` and `WorkOrderPart` (as in change request workflow docs), and what exact IDs must be echoed back in `lineDecisions`?
3. **Approval method/proof schema (blocking):** What are the supported approval methods for Work Orders *now*, and what proof payload/reference is required for each (e.g., signature token vs file reference vs note-only)?
4. **Terminal outcome mapping (blocking):** When all items are declined, what `statusId` does backend set on the Work Order (e.g., `CANCELLED` per FSM, or another status)? UI must not guess.
5. **Approval window semantics (blocking if required):** Is there an approval/re-approval window for Work Orders? If yes, does backend provide `approvalWindowEnd` (preferred) or should UI fetch it from a requirements endpoint? (UI must not compute policy from config without an explicit contract.)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #268: [FRONTEND] Approval: Handle Approval Expiration
LABELS: domain:workexec,type:story,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:workexec-domain-agent,status:needs-review
BODY:
## Domain Conflict Summary

This story describes an **approval workflow state transition** (`PENDING ‚Üí EXPIRED`, and gating `approve/deny` actions). Per Security domain rule **DECISION-INVENTORY-014**, approvals (workflow state machines and endpoints) are **not security-owned**; Security only provides permission keys and enforcement. Therefore, the primary domain for this story is **workexec** (or the actual workflow domain that owns approvals). This story must be reviewed and relabeled by the owning workflow domain.

Security-related requirements in this story are limited to **permission gating** and **deny-by-default** behavior, but those do not make Security the system of record for approvals.

---

## 1. Story Header

### Title
[FRONTEND] Approval: Handle Approval Expiration

### Primary Persona
Approver (manager/supervisor) who reviews and approves requests in the POS.

### Business Value
Prevents invalid/late approvals by making ‚Äúexpired‚Äù approvals un-actionable, clearly communicating why, and guiding users to the correct next step‚Äîreducing operational errors and support overhead.

---

## 2. Story Intent

### As a / I want / So that
**As an** Approver,  
**I want** approvals to automatically become ‚ÄúExpired‚Äù after their expiration time and be blocked from being approved/denied,  
**so that** I cannot take action on stale approvals and the system remains secure and auditable.

### In-scope
- Frontend detection and handling of an approval that is expired (on load and on submit).
- UI behavior: disabling actions, showing status/alerts, and rendering expiration metadata.
- Error handling for backend responses indicating expiration.
- Moqui screen/form/transitions implementing the above.

### Out-of-scope
- Defining the backend expiration policy (duration, calculation, grace periods).
- Creating/renewing/reissuing approvals (unless explicitly provided by backend).
- Notification mechanisms (email/SMS/push) for impending expiration.

---

## 3. Actors & Stakeholders

- **Approver (Primary Actor):** Attempts to approve/deny a pending approval.
- **Requester (Stakeholder):** Needs timely decisions; impacted if approval expires.
- **Workflow Service (Actor):** Owns approval state machine and enforces expiration; returns errors and current status. *(Per DECISION-INVENTORY-014, approvals are workflow-owned.)*
- **Audit/Compliance (Stakeholder):** Requires traceability of expiration vs actions taken.
- **Security (Stakeholder):** Ensures only authorized users can view/act; deny-by-default authorization. *(Per DECISION-INVENTORY-001.)*

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend.
- User has permission to view the approval item; backend enforcement is deny-by-default. *(Security DECISION-INVENTORY-001.)*

### Dependencies
- A workflow/approval backend API/service exists to:
  - List approvals (inbox) and load approval details including current status and expiration metadata.
  - Attempt approve/deny actions and return deterministic errors for expired approvals.
- Time handling convention must be defined (server time vs client time; timezone).
- Permission keys that gate viewing/acting on approvals must be defined by the owning workflow domain (Security can host keys, but ownership of approval actions remains workflow). *(Security DECISION-INVENTORY-014.)*

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an ‚ÄúApprovals Inbox/List‚Äù screen: selecting an approval navigates to an approval detail screen.
- Deep link: direct navigation to an approval detail screen by `approvalId` in the URL.

### Screens to create/modify
1. **Modify**: `approvals/ApprovalList` (or equivalent)
   - Display status badge and ‚ÄúExpired‚Äù state indicator when applicable.
2. **Modify/Create**: `approvals/ApprovalDetail`
   - Shows approval metadata, status, expiration info.
   - Provides actions: Approve / Deny (or equivalent).
3. **(Optional) Modify**: shared notification/toast wiring consistent with existing frontend patterns.

> Exact screen names/paths are project-convention dependent; implementer must align with existing Moqui screen tree in `durion-moqui-frontend`.

### Navigation context
- Breadcrumb: Approvals ‚Üí Approval Detail
- Back navigation returns to list with preserved filters (safe default).

### User workflows (happy + alternate paths)

#### Happy path (not expired)
1. User opens approval detail.
2. UI shows status = actionable (e.g., `PENDING`) and expiration timestamp (if provided).
3. User clicks Approve or Deny.
4. UI submits action; shows success; status updates to terminal (`APPROVED`/`DENIED`); actions become disabled.

#### Expired on view
1. User opens approval detail.
2. UI shows status = `EXPIRED` (or `isExpired=true`).
3. Approve/Deny actions are disabled/hidden; message explains expiration and shows `expiresAt` if available.
4. User can return to list.

#### Expires between view and submit
1. User opens approval detail while still actionable.
2. User waits; clicks Approve (or Deny).
3. Backend rejects with ‚Äúexpired‚Äù error.
4. UI updates status to `EXPIRED` by reloading detail, displays error, disables actions.

---

## 6. Functional Behavior

### Triggers
- Screen load of Approval Detail (by `approvalId`).
- User clicks ‚ÄúApprove‚Äù or ‚ÄúDeny‚Äù.
- User clicks ‚ÄúRefresh‚Äù (manual refresh action) on detail screen.

### UI actions
- On load:
  - Fetch approval detail from workflow service.
  - Treat backend as source of truth for expiration and status; do not compute expiration from client time unless backend explicitly provides a supported rule/flag.
- Render:
  - Status chip (e.g., Pending/Approved/Denied/Expired)
  - Expiration timestamp (if provided)
  - If expired: show inline alert ‚ÄúThis approval expired at <time> and can no longer be acted on.‚Äù
- Manual refresh:
  - Re-fetch approval detail and re-evaluate action availability.

### State changes (frontend view state)
- `viewStatus`: `loading | loaded | error`
- `approval.status` and/or `approval.isExpired`: reflects backend response
- `actionsEnabled`: derived; enabled only when approval is actionable and user is authorized.

### Service interactions (Moqui)
- `transition` on screen entry calls a service to load approval details.
- `transition` for approve/deny calls submit service; handles response; then reloads approval detail for consistency.
- All calls must propagate/display `correlationId` from error envelope when present (if backend follows canonical envelope). *(Security DECISION-INVENTORY-015 is canonical for Security APIs; workflow domain must confirm its own envelope.)*

---

## 7. Business Rules (Translated to UI Behavior)

### Decision rationale applied from provided Security rules
- **Approvals are workflow-owned**; Security only gates access. *(DECISION-INVENTORY-014.)*  
  Therefore, this story cannot finalize under `domain:security` without a workflow-domain contract.
- **Deny-by-default authorization**: if the user lacks explicit permission, the UI must not expose actions and must handle 401/403 deterministically. *(DECISION-INVENTORY-001.)*

### Validation
- Approve/Deny submit must include required identifiers (e.g., `approvalId`) and any required concurrency token/version if backend requires it.
- Do not allow submission if backend indicates expired (status `EXPIRED` or `isExpired=true`).
- If backend requires a deny reason/comment, validate per backend rules (unknown; blocking).

### Enable/disable rules
- If `approval.status == EXPIRED` OR `approval.isExpired == true`: disable/hide Approve/Deny.
- If `approval.status` is terminal (e.g., `APPROVED`, `DENIED`, `CANCELLED`): disable/hide Approve/Deny.
- If backend returns `403` on load: show ‚ÄúNot authorized‚Äù and do not show actions.
- If backend returns `403` on submit: show ‚ÄúNot authorized to take this action‚Äù and keep actions disabled.

### Visibility rules
- Expiration info is visible when provided by backend (`expiresAt` and/or `expiredAt`).
- If backend provides neither timestamp nor explicit expired flag/status, UI can only reflect current status and submit errors (still functional but less informative).

### Error messaging expectations
- Expired on submit:
  - Show error title ‚ÄúApproval expired‚Äù
  - Body: ‚ÄúThis approval expired and can‚Äôt be approved/denied. Refreshing status‚Ä¶‚Äù
  - Then reload detail and render terminal expired state.
- Concurrency/state changed:
  - Show ‚ÄúThis approval was updated by someone else. Refreshing‚Ä¶‚Äù then reload.
- Include `correlationId` in an expandable ‚ÄúDetails‚Äù section for support when present.

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Approval** (workflow-owned read model / DTO)
  - Source of record: workflow/approval backend service (not Security).

### Fields (must be confirmed by workflow domain/backend)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| `approvalId` | string/UUID | yes | n/a | Route param and submit identifier |
| `status` | enum|string | yes | n/a | Must include an expired representation OR provide `isExpired` |
| `isExpired` | boolean | no | null | Preferred explicit flag to avoid client-time computation |
| `expiresAt` | timestamp (ISO-8601) | no | null | Display-only; do not compute expiration unless explicitly supported |
| `requestedAt` | timestamp | no | null | Informational |
| `requestedBy` | string | no | null | Informational |
| `subjectType` / `subjectId` | string | no | null | What this approval is for |
| `decidedAt` | timestamp | no | null | Informational |
| `version` / `etag` | string/int | no | null | Needed if backend requires optimistic concurrency |
| `denyReasonRequired` | boolean | no | null | If backend supports dynamic requirement; otherwise UI must know rule (blocking) |

### Read-only vs editable
- All fields read-only in UI; only actions are approve/deny (and optional deny reason input).

### Derived/calculated fields
- `isActionable`: derived from backend status set (must be provided/confirmed by workflow domain).
- `actionsEnabled`: `isActionable && userAuthorized`.

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking:** Actual workflow-domain endpoints and error envelope are not provided. Placeholders below define required capabilities but are not implementable without confirmation.

### Load/view calls
- **Endpoint/Service (placeholder):** `GET /api/v1/workexec/approvals/{approvalId}`
- **Input:** path `{approvalId}`
- **Output (minimum):**
  ```json
  {
    "approvalId": "uuid",
    "status": "PENDING|APPROVED|DENIED|EXPIRED|...",
    "isExpired": true,
    "expiresAt": "2026-01-21T12:34:56Z",
    "version": "..."
  }
  ```
- **Errors:**
  - `404` not found ‚Üí show ‚ÄúApproval not found‚Äù
  - `401/403` ‚Üí show ‚ÄúNot authorized‚Äù
  - `5xx` ‚Üí generic retryable error

### List calls (for inbox/list screen)
- **Endpoint/Service (placeholder):** `GET /api/v1/workexec/approvals?pageIndex=&pageSize=&status=...`
- **Output:** paginated list with `items[]`, `pageIndex`, `pageSize`, `totalCount`

### Submit/transition calls
1. **Approve**
   - **Endpoint/Service (placeholder):** `POST /api/v1/workexec/approvals/{approvalId}/approve`
   - **Input:** `{ version? }`
2. **Deny**
   - **Endpoint/Service (placeholder):** `POST /api/v1/workexec/approvals/{approvalId}/deny`
   - **Input:** `{ version?, reason? }`

### Error handling expectations
- Expired:
  - Backend returns deterministic status + machine code (e.g., `409` with `code=APPROVAL_EXPIRED`), and includes `correlationId` if using canonical envelope.
  - UI maps to ‚ÄúApproval expired‚Äù and reloads detail.
- Concurrency/state changed:
  - Backend returns deterministic code (e.g., `APPROVAL_NOT_ACTIONABLE`, `VERSION_CONFLICT`) and UI reloads.
- Envelope:
  - If backend uses the canonical envelope (`code`, `message`, `correlationId`, optional `fieldErrors[]`), UI must map `fieldErrors` to form fields (deny reason) and show `correlationId` in details.
  - If backend does not, this story is blocked until envelope is confirmed.

---

## 10. State Model & Transitions

### Allowed states (must be confirmed by workflow domain)
- Actionable: `PENDING` (or equivalent)
- Terminal: `APPROVED`, `DENIED`, `EXPIRED` (and possibly others)

### Role-based transitions
- Only authorized approvers may transition actionable ‚Üí approved/denied.
- System may transition actionable ‚Üí expired (time-based), owned by workflow domain.

### UI behavior per state
- Actionable: show Approve/Deny enabled.
- Terminal (approved/denied/expired): show status, disable actions.
- Expired: show expired banner and `expiresAt` if available.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing `approvalId` route param ‚Üí show error state and link back to list.
- Deny reason required but missing ‚Üí show inline field error and do not submit (requires backend rule/contract).

### Concurrency conflicts
- Backend indicates already approved/denied/expired while user is viewing:
  - UI shows conflict message and reloads to reflect latest status.

### Unauthorized access
- 401/403 on load: show unauthorized state; do not render actions.
- 401/403 on submit: show forbidden error; keep actions disabled; do not retry automatically.

### Empty states
- Approval detail returns minimal info: still render status and identifiers; hide unknown sections.

---

## 12. Acceptance Criteria

### Scenario 1: View an expired approval
**Given** an approval exists with status `EXPIRED` (or `isExpired=true`)  
**When** the user opens the Approval Detail screen for that approval  
**Then** the screen shows status `EXPIRED` (or an explicit expired indicator)  
**And** the Approve and Deny actions are not actionable (disabled or hidden)  
**And** the user sees a message indicating the approval is expired  
**And** no approve/deny request is sent from the UI.

### Scenario 2: Expiration handled on submit
**Given** an approval is displayed as actionable  
**And** the approval expires before the user submits  
**When** the user clicks Approve (or Deny)  
**And** the backend responds with an ‚Äúexpired approval‚Äù error code  
**Then** the UI shows an ‚ÄúApproval expired‚Äù error message  
**And** the UI reloads the approval detail  
**And** the status is shown as `EXPIRED`  
**And** actions are no longer actionable.

### Scenario 3: Non-expired approval can be approved
**Given** an approval exists with an actionable status  
**When** the user clicks Approve  
**And** the backend returns success  
**Then** the UI shows a success confirmation  
**And** the approval status updates to a terminal approved status (after reload or response binding)  
**And** the Approve/Deny actions are no longer actionable.

### Scenario 4: Unauthorized user cannot act
**Given** a user without permission to act on approvals  
**When** they open an approval detail  
**Then** the UI indicates they are not authorized  
**And** no action controls are available  
**And** if they attempt a direct submit, the UI displays a forbidden error on response.

### Scenario 5: Not found approval
**Given** no approval exists for `approvalId = X`  
**When** the user navigates to Approval Detail for `X`  
**Then** the UI displays ‚ÄúApproval not found‚Äù  
**And** provides navigation back to Approval List.

### Scenario 6: Deny reason validation (if required)
**Given** an approval exists with an actionable status  
**And** the backend requires a deny reason  
**When** the user clicks Deny without providing a reason  
**Then** the UI shows a field-level validation error for the reason field  
**And** no deny request is sent until the reason is provided.

---

## 13. Audit & Observability

### User-visible audit data
- Show status and timestamps if provided (requestedAt, expiresAt, decidedAt).
- Show ‚ÄúLast updated‚Äù timestamp if backend provides.

### Status history
- If backend exposes history, render a read-only timeline; otherwise out of scope.

### Traceability expectations
- Frontend should display/log `correlationId` from error responses when present.
- On submit failures due to expiration, log client event with `approvalId` and backend `code` (no PII).

---

## 14. Non-Functional UI Requirements

- **Performance:** Approval detail load under 2s on typical broadband; show skeleton/loading state immediately.
- **Accessibility:** WCAG 2.1 AA; expired banner announced to screen readers; buttons reflect disabled state correctly.
- **Responsiveness:** Works on tablet and desktop; approval actions remain reachable without horizontal scrolling.
- **i18n/timezone:** Display `expiresAt` in the app-standard timezone formatting (must be confirmed by app/platform standard); if unknown, display ISO-8601 with explicit timezone suffix.

---

## 15. Applied Safe Defaults

- SD-UI-EMPTY-STATE-01: Provide a standard ‚ÄúNot found / Unauthorized / Error‚Äù empty state component behavior; safe because it doesn‚Äôt change domain logic, only presentation. (Impacted: UX Summary, Error Flows)
- SD-UI-LOADING-STATE-01: Use consistent loading indicator/skeleton while fetching approval detail; safe as it only improves ergonomics. (Impacted: UX Summary)
- SD-ERR-MAP-01: Map HTTP 401/403/404/409/422/500 to standard UI notifications with retry where applicable; safe because it doesn‚Äôt assume business policy, only transport-level handling. (Impacted: Service Contracts, Error Flows)

---

## 16. Open Questions

1. **Domain ownership confirmation (blocking):** Confirm the owning domain/service for approvals (expected `workexec` per Security DECISION-INVENTORY-014). Provide the correct `domain:*` label and agent.
2. **Backend contract (blocking):** What are the actual endpoints/services used by the frontend to:
   - list approvals,
   - load approval detail,
   - approve,
   - deny?
   Include request/response schemas and the error envelope (fields + example).
3. **State model (blocking):** What are the authoritative approval statuses and which are actionable? Provide the complete enum and terminal states.
4. **Expiration representation (blocking):** Does backend expose `status=EXPIRED`, `isExpired`, and/or `expiresAt`? Confirm whether the UI must rely solely on backend status/flag (preferred) vs computing from `expiresAt`.
5. **Timezone/display standard (blocking):** Which timezone governs display of `expiresAt` (user profile timezone, tenant/site timezone, or always UTC), and what is the app-standard formatting?
6. **Deny requirements (blocking):** Does denying require a reason/comment? If yes, provide validation rules (required/optional, min/max length, allowed characters) and whether it is enforced client-side, server-side, or both.
7. **Post-expiration user path (non-blocking unless required):** Should UI offer an explicit ‚ÄúRequest new approval‚Äù action/link when expired? If yes, what screen/route/service handles it (and which domain owns it)?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] Approval: Handle Approval Expiration  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/268  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ü§ñ Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #23 - Approval: Handle Approval Expiration  
**URL**: https://github.com/louisburroughs/durion/issues/23  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:37:43.83278977*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #238: [FRONTEND] [STORY] Estimate: Add Parts to Estimate
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Estimate: Add Parts to Estimate (Catalog + Non-Catalog + Price Override)

### Primary Persona
Service Advisor

### Business Value
Enable Service Advisors to build accurate, auditable draft estimates by adding parts (from catalog or non-catalog where allowed), applying pricing defaults, enforcing override permissions/policies, and ensuring totals are recalculated consistently.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want to** search for parts and add them as line items to a Draft estimate (including optional price overrides and controlled non-catalog entry)  
- **So that** I can produce a complete quote for the customer with correct totals and an audit trail of changes.

### In-scope
- Catalog part search (by SKU/part number and description; category filter only if supported by search contract).
- Add a part line item to an **Estimate in `DRAFT`** state with quantity validation.
- Default unit price retrieval and display (backend/pricing authority).
- Optional price override flow with permission gating and optional reason code requirement.
- Non-catalog part entry flow (policy-gated) with required description and manual unit price.
- Immediate refresh of estimate totals after add/edit.
- User-visible audit surfacing (who/when for line changes) if available in backend responses; otherwise show ‚Äúlast updated‚Äù at estimate level.
- Idempotency protection for create/submit actions (send `Idempotency-Key`).

### Out-of-scope
- Configuring price lists, discount/markup rules, tax policies, override reason code lists (configuration ownership outside this story).
- Creating/editing labor line items (parts only).
- Estimate approval / signature capture workflows.
- Work order creation/promotion from estimate.
- Inventory allocation, picking, or consumption.
- SubstituteLink authoring/admin (explicitly not workexec-owned; workexec only consumes substitution eligibility via dedicated picker when applicable).

---

## 3. Actors & Stakeholders

- **Primary Actor:** Service Advisor
- **Secondary Actors:** Service Manager (policy/permission owner), Parts Manager (catalog data quality)
- **System Actors / Dependencies:**
  - Product/Catalog search service (product search & product details)
  - Pricing computation (may be embedded in estimate-item create/update responses)
  - Workexec estimate services (estimate + estimate items + totals + audit metadata)
  - Security/Authorization (capability/permission signaling + backend enforcement)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- An **Estimate** exists and is accessible to the user.
- Estimate status is **`DRAFT`** for add/edit operations.

### Dependencies (blocking if unavailable)
- Backend endpoints/services for:
  - Loading estimate header + items + totals (single call or composable calls).
  - Searching catalog products via a picker/search endpoint (pagination required).
  - Adding a catalog part line item to an estimate and returning updated totals.
  - Adding a non-catalog part line item (if allowed) and returning updated totals.
  - Updating quantity for an existing part line item and returning updated totals.
  - Applying a price override (with optional reason code) and returning updated totals.
  - Capability/policy flags for:
    - `canOverridePrice`
    - `allowNonCatalogParts`
    - `requireOverrideReason`
  - Standard error envelope normalization:
    - `{ code, message, correlationId, fieldErrors?, existingResourceId? }` (DECISION-INVENTORY-011)
- If reason codes are required: a queryable source of valid reason codes (location-scoped if applicable).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From estimate edit screen: ‚ÄúAdd Part‚Äù action within the Parts section.

### Screens to create/modify (Moqui)
1. **Modify** `durion-workexec/EstimateEdit.xml` (canonical per DECISION-INVENTORY-002):
   - Parts line item list/table (if not already present)
   - ‚ÄúAdd Part‚Äù action (enabled only when estimate is `DRAFT`)
   - Per-line actions (when `DRAFT`): edit quantity; override price (capability-gated)
2. **Add** a dialog/modal screen or subscreen under `EstimateEdit.xml` for ‚ÄúAdd Part‚Äù:
   - Catalog Part picker/search
   - Non-Catalog Part entry (visible only if policy allows)
3. **Optional**: a small modal for ‚ÄúOverride Price‚Äù (if inline editing is not already implemented cleanly in `EstimateEdit.xml`)

### Navigation context
- Remain within estimate context (Moqui screen parameter `estimateId`).
- After adding/editing: stay on `EstimateEdit` and refresh the parts list + totals; focus/scroll to the affected line.

### User workflows (happy + alternate paths)
#### Happy path: add catalog part
1. Open Draft estimate in `EstimateEdit`.
2. Click ‚ÄúAdd Part‚Äù.
3. Search catalog (query by SKU/part number or description).
4. Select a product.
5. Enter quantity (>0).
6. Confirm ‚ÄúAdd‚Äù.
7. UI refreshes estimate items and totals; new line is visible.

#### Alternate: override price
1. On an existing part line in Draft estimate, choose ‚ÄúOverride price‚Äù.
2. If `canOverridePrice=true`, enter override unit price.
3. If `requireOverrideReason=true`, select a reason code.
4. Save; UI refreshes item and totals.

#### Alternate: non-catalog part
1. In Add Part dialog, switch to Non-Catalog (only if `allowNonCatalogParts=true`).
2. Enter description, optional part number/SKU text, quantity, and unit price.
3. Save; UI refreshes items and totals.

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúAdd Part‚Äù on a Draft estimate.
- User edits quantity on an existing part line item.
- User applies/removes a price override on an existing part line item.

### UI actions
- Catalog search:
  - Search input with debounce and explicit ‚ÄúSearch‚Äù action.
  - Results list with pagination controls (page size fixed by UI; backend authoritative).
  - Selecting a result populates a ‚Äúselected product‚Äù summary.
- Add catalog part:
  - Quantity input (decimal allowed; do not assume integer-only).
  - ‚ÄúAdd‚Äù submits create call with `Idempotency-Key`.
- Add non-catalog part (policy-gated):
  - Fields: description (required), optional part number text, quantity, unit price (required).
  - ‚ÄúAdd‚Äù submits create call with `Idempotency-Key`.
- Edit quantity:
  - Inline edit or modal; save triggers update call.
- Override price:
  - If capability allows, show override UI.
  - If reason required, show reason picker.
  - Save triggers override call.

### State changes
- Estimate items list updates (new/updated line item appears with stable identifier).
- Totals panel refreshes using backend-calculated totals.
- If estimate is not `DRAFT`: disable add/edit controls and show explanatory banner.

### Service interactions (high-level)
- Load estimate details on screen entry and after successful mutations.
- Product search calls while in Add Part workflow.
- Pricing:
  - Backend is authoritative. UI displays unit price returned by estimate item create/update/override responses (preferred).
  - If backend requires a separate pricing preview call, UI may call it to display a preview before add; final price still comes from create response.

### Decision rationale applied (from provided workexec rules)
- **IDs are opaque**: UI must not validate UUID/numeric formats; use pickers and treat IDs as strings (DECISION-INVENTORY-003).
- **Idempotency**: UI must send `Idempotency-Key` for create/submit operations and reuse on retry (DECISION-INVENTORY-012).
- **Standard error envelope**: UI must parse `{code,message,correlationId,fieldErrors,existingResourceId}` and map to UX (DECISION-INVENTORY-011).
- **Capability gating**: UI uses capability flags to show/hide/disable override actions; backend still enforces with 403 (DECISION-INVENTORY-013).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Estimate status gate:** If estimate status != `DRAFT`, block add/edit actions and show:  
  ‚ÄúThis estimate can‚Äôt be modified because it is <STATUS>.‚Äù
- **Quantity:** numeric and **> 0**. Error: ‚ÄúQuantity must be a number greater than 0.‚Äù
- **Catalog selection:** `productId` required for catalog add.
- **Non-catalog policy gate:** non-catalog form visible/enabled only if `allowNonCatalogParts=true`.
- **Non-catalog required fields:** `description` required (non-empty), `unitPrice` required, `quantity` > 0.
- **Price override permission:** if `canOverridePrice=false`, disable price override UI and show:  
  ‚ÄúYou do not have permission to override prices.‚Äù
- **Override reason code:** if `requireOverrideReason=true`, require selection before saving override; error:  
  ‚ÄúA reason code is required for all price overrides.‚Äù

### Enable/disable rules
- ‚ÄúAdd Part‚Äù enabled only when estimate status is `DRAFT`.
- ‚ÄúNon-Catalog Part‚Äù tab visible only when `allowNonCatalogParts=true`.
- ‚ÄúOverride price‚Äù action enabled only when:
  - estimate status is `DRAFT`
  - `canOverridePrice=true`

### Visibility rules
- Show ‚ÄúOverride reason‚Äù field only when:
  - override is being applied AND `requireOverrideReason=true`

### Error messaging expectations
- Field-level errors for validation failures.
- Top-level summary for submit failures.
- Include `correlationId` in an expandable ‚ÄúDetails‚Äù area for support (not customer-facing).

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `Estimate` (workexec-owned estimate lifecycle per customer approval workflow)
- `EstimateItem` (parts line items)
- `Product` (catalog search results; SoR outside workexec)
- `Capabilities/Policy` payload (source contract required)
- Optional: audit metadata fields on estimate and/or line items (created/updated stamps)

### Fields

#### Estimate (read)
- `estimateId` (id string) **required** (opaque; no format assumptions)
- `status` (enum: `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`) **required**
- Totals (backend-calculated; money):
  - `subtotal` **required**
  - `taxTotal` **required**
  - `grandTotal` **required**
- Optional:
  - `currencyUomId` (string)
  - `lastUpdatedStamp` (datetime)
  - `lastUpdatedByUserId` (id string) (if available)

#### EstimateItem (parts) (read/write)
- Identifiers:
  - `estimateItemId` (id string) **required**
  - `estimateId` **required**
  - `itemSeqId` (string/number) read-only (if present)
- Classification:
  - `itemType` = `PART` (read-only)
  - `isNonCatalog` (boolean) read-only
- Catalog fields:
  - `productId` (id string) required for catalog, null for non-catalog
  - `partNumber`/`sku` (string) optional (from product)
- Common fields:
  - `description` (string) required
  - `quantity` (decimal) required, >0
  - `unitPrice` (money) required (backend authoritative)
  - `overrideUnitPrice` (money) optional
  - `overrideReasonCode` (string) optional/required-by-policy
- Optional tax display fields (only if provided by backend):
  - `taxCodeSnapshot` (string) read-only
  - `lineTaxTotal` (money) read-only
  - `lineTotal` (money) read-only

#### Capabilities/Policy (read)
- `canOverridePrice` (boolean) required for gating
- `allowNonCatalogParts` (boolean) required for gating
- `requireOverrideReason` (boolean) required for gating
- Optional:
  - `overrideReasonCodes[]` (if embedded rather than separate endpoint)

### Read-only vs editable (by state/role)
- When estimate status != `DRAFT`: all estimate items are read-only in UI.
- When `DRAFT`:
  - quantity editable
  - overrideUnitPrice editable only when `canOverridePrice=true`
  - non-catalog fields editable only at create time unless backend supports edits (not assumed)

### Derived/calculated fields
- Display-only extended price and totals:
  - Prefer backend-provided `lineTotal` and totals.
  - If not provided, UI may compute `quantity * effectiveUnitPrice` for display only and must label as ‚ÄúEstimated‚Äù only if it can differ; otherwise avoid client computation.

---

## 9. Service Contracts (Frontend Perspective)

STOP: Clarification required before finalization

> Moqui screen implementation may call services directly rather than REST. This section defines required frontend-facing contracts; exact service names/paths must be confirmed in this repo.

### Load/view calls
- **Required**: Load estimate with items and totals
  - Option 1 (single call): `GET /api/estimates/{estimateId}` returns header + items + totals + capability/policy flags
  - Option 2 (composed):
    - `GET /api/estimates/{estimateId}`
    - `GET /api/estimates/{estimateId}/items?itemType=PART`
    - `GET /api/estimates/{estimateId}/capabilities` (or user-context + policy endpoint)

### Product search calls
- **Required**: searchable picker with pagination (DECISION-INVENTORY-008)
  - Example: `GET /api/products/parts?query=<text>&pageIndex=0&pageSize=20`
  - Response must include:
    - `items[]: { productId, sku/partNumber, description }`
    - `pageIndex, pageSize, totalCount` (or `hasNextPage`)

### Create/update calls
- **Required**: create catalog part estimate item (idempotent)
  - Example: `POST /api/estimates/{estimateId}/items/parts`
  - Headers: `Idempotency-Key: <uuid>`
  - Body:
    ```json
    { "productId": "P-123", "quantity": 2 }
    ```
  - Response (preferred):
    - `createdItem` (full EstimateItem)
    - `estimateTotals` (subtotal/taxTotal/grandTotal)
    - optional `audit` metadata

- **Required**: create non-catalog part estimate item (idempotent; policy-gated)
  - Same endpoint with `isNonCatalog=true` OR a dedicated endpoint; must be confirmed.
  - Body:
    ```json
    {
      "isNonCatalog": true,
      "description": "Brake pad hardware kit",
      "partNumber": "optional",
      "quantity": 1,
      "unitPrice": 19.99
    }
    ```

- **Required**: update quantity (concurrency-safe if version token exists)
  - Example: `PUT /api/estimates/{estimateId}/items/{estimateItemId}`
  - Body:
    ```json
    { "quantity": 3 }
    ```
  - If versioning exists, include `version`/`lastUpdatedStamp` and return 409 on conflict.

### Submit/transition calls
- None in this story (no estimate approval transitions).

### Price override calls
- **Required**: apply override (capability-gated; reason optional/required)
  - Example: `POST /api/estimates/{estimateId}/items/{estimateItemId}/override-price`
  - Headers: `Idempotency-Key` recommended if backend treats as submit-like mutation.
  - Body:
    ```json
    { "overrideUnitPrice": 39.99, "overrideReasonCode": "PRICE_MATCH" }
    ```
  - Response: updated item + updated totals.

### Error handling expectations
- All errors normalized to standard envelope (DECISION-INVENTORY-011):
  - `400` with `fieldErrors[]` for validation
  - `403` for permission/policy violations
  - `404` for missing estimate/item/product
  - `409` for concurrency conflicts; include `correlationId` and optionally `existingResourceId` for duplicates
- UI behavior:
  - Show user-friendly message + ‚ÄúDetails‚Äù with `correlationId`
  - On 409: offer ‚ÄúRefresh estimate‚Äù action

---

## 10. State Model & Transitions

### Estimate states
- `DRAFT`
- `APPROVED`
- `DECLINED`
- `EXPIRED`

### Allowed transitions (not implemented here; used for gating)
- Only `DRAFT` is editable for adding/modifying parts.

### Role-based transitions (UI enforcement for this story)
- Service Advisor can add/edit parts only in `DRAFT`.
- Price override requires capability `canOverridePrice=true` (exact permission string is backend-owned; UI uses capability flags per DECISION-INVENTORY-013).

### UI behavior per state
- `DRAFT`: enable add part, quantity edit, and price override if permitted.
- `APPROVED`/`DECLINED`/`EXPIRED`: read-only; show banner indicating status and that edits are disabled.

---

## 11. Alternate / Error Flows

### Validation failures
- Quantity <= 0: block submit; show inline error.
- Non-catalog without description: block; error ‚ÄúDescription is required.‚Äù
- Non-catalog without unit price: block; error ‚ÄúUnit price is required.‚Äù
- Override without reason when required: block; error ‚ÄúA reason code is required for all price overrides.‚Äù

### Concurrency conflicts
- If backend returns `409` on add/update/override:
  - UI shows blocking dialog: ‚ÄúThis estimate was updated by someone else.‚Äù
  - Actions: ‚ÄúRefresh estimate‚Äù (reload) and ‚ÄúCancel‚Äù
  - After refresh, user may retry; for create calls, reuse the same `Idempotency-Key` only if retrying the same attempt (DECISION-INVENTORY-012).

### Unauthorized access
- If `403` on override:
  - Keep original price displayed.
  - Show message: ‚ÄúYou do not have permission to override prices.‚Äù
  - Ensure UI gating is updated if capability payload indicates false.

### Empty states
- No parts yet: show ‚ÄúNo parts added‚Äù with ‚ÄúAdd Part‚Äù CTA (only in `DRAFT`).
- Search returns no results:
  - Show ‚ÄúNo parts found.‚Äù
  - If `allowNonCatalogParts=true`: show ‚ÄúAdd non-catalog part‚Äù action.

### Duplicate/double-submit
- If user double-clicks ‚ÄúAdd‚Äù:
  - UI disables submit while request in-flight.
  - If a retry occurs and backend returns 409 DUPLICATE with `existingResourceId`, UI navigates/highlights existing line item and refreshes totals.

---

## 12. Acceptance Criteria

### Scenario 1: Add a catalog part line item to a Draft estimate
**Given** I am authenticated as a Service Advisor  
**And** I am viewing an estimate with status `DRAFT`  
**When** I open ‚ÄúAdd Part‚Äù and search by part number/SKU or description  
**And** I select a catalog part  
**And** I enter a quantity of `2`  
**And** I confirm adding the part  
**Then** the UI sends a create request with an `Idempotency-Key` header  
**And** a new part line item is added to the estimate  
**And** the line item shows the selected part‚Äôs description/part number and quantity `2`  
**And** the unit price shown matches the backend response  
**And** the estimate totals are refreshed to the backend-calculated values.

### Scenario 2: Block adding a part when estimate is not Draft
**Given** I am viewing an estimate with status `APPROVED`  
**When** I attempt to add a part  
**Then** the UI prevents the action (button disabled or blocked)  
**And** I see a message indicating the estimate cannot be modified in `APPROVED` status  
**And** no create-item request is executed.

### Scenario 3: Reject invalid quantity
**Given** I am viewing an estimate with status `DRAFT`  
**When** I attempt to add a catalog part with quantity `0`  
**Then** the UI prevents submission  
**And** I see the validation message ‚ÄúQuantity must be a number greater than 0‚Äù  
**And** no create-item request is executed.

### Scenario 4: Add a non-catalog part when policy allows
**Given** I am viewing an estimate with status `DRAFT`  
**And** `allowNonCatalogParts=true` is provided to the UI  
**When** I choose ‚ÄúAdd non-catalog part‚Äù  
**And** I enter description ‚ÄúBrake pad hardware kit‚Äù, quantity `1`, unit price `19.99`  
**Then** the UI sends a create request with an `Idempotency-Key` header  
**And** a new line item is added with `isNonCatalog=true`  
**And** the estimate totals are refreshed to the backend-calculated values.

### Scenario 5: Hide/disable non-catalog entry when policy disallows
**Given** I am viewing an estimate with status `DRAFT`  
**And** `allowNonCatalogParts=false` is provided to the UI  
**When** my catalog search returns no results  
**Then** I do not see an option to add a non-catalog part  
**And** I only see the ‚ÄúNo parts found‚Äù empty search result.

### Scenario 6: Override price with permission and required reason
**Given** I am viewing an estimate with status `DRAFT`  
**And** `canOverridePrice=true` is provided to the UI  
**And** `requireOverrideReason=true` is provided to the UI  
**And** the estimate has a part line item  
**When** I set an override unit price  
**And** I select an override reason code  
**And** I save the override  
**Then** the UI sends an override request  
**And** the line item reflects the overridden price from the backend response  
**And** the estimate totals refresh to backend-calculated values.

### Scenario 7: Block override price without permission
**Given** I am viewing an estimate with status `DRAFT`  
**And** `canOverridePrice=false` is provided to the UI  
**When** I attempt to edit the unit price on a part line item  
**Then** the UI blocks the edit  
**And** I see the message ‚ÄúYou do not have permission to override prices‚Äù  
**And** no override request is executed.

### Scenario 8: Standard error envelope is surfaced with correlation id
**Given** I am viewing an estimate with status `DRAFT`  
**When** an add/edit/override request fails with a backend error envelope containing `correlationId`  
**Then** the UI shows a user-friendly error message  
**And** the UI provides access to the `correlationId` for support troubleshooting.

---

## 13. Audit & Observability

### User-visible audit data
- Display if present in responses:
  - Estimate ‚ÄúLast updated at/by‚Äù
  - Per part line item: ‚ÄúCreated at/by‚Äù and ‚ÄúLast updated at/by‚Äù
- Do not display internal-only audit payloads.

### Status history
- Not required to implement estimate state history view; only enforce edit gating by current status.

### Traceability expectations
- UI logs (frontend) include:
  - action name (addPart, updateQuantity, overridePrice)
  - `estimateId`, `estimateItemId` (when available)
  - `correlationId` from error envelope
- For create/submit actions, UI generates and sends `Idempotency-Key` and reuses it on retry of the same attempt (DECISION-INVENTORY-012).

---

## 14. Non-Functional UI Requirements

- **Performance:** product search debounced (300‚Äì500ms) with loading state; results paginated.
- **Accessibility:** labeled inputs; errors announced via aria-live; keyboard navigation works in modal/dialog; focus management returns to invoking control on close.
- **Responsiveness:** add-part dialog usable on tablet; results list scrollable.
- **i18n/timezone/currency:** money formatted using estimate currency if provided; timestamps displayed in user timezone/locale (DECISION-INVENTORY-016 guidance for display semantics).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide standard empty state messaging and CTA for ‚ÄúNo parts added‚Äù / ‚ÄúNo search results‚Äù; qualifies as safe because it does not change domain behavior. Impacted sections: UX Summary, Alternate / Error Flows.
- SD-UX-DEBOUNCE-SEARCH: Debounce catalog search input to reduce request volume; safe because it only affects ergonomics and not business rules. Impacted sections: Functional Behavior, Non-Functional UI Requirements.
- SD-ERR-HTTP-MAP: Map standard HTTP codes (400/403/404/409/5xx) to user messages using the standard error envelope; safe because it follows the provided backend contract (DECISION-INVENTORY-011) without inventing policies. Impacted sections: Service Contracts, Alternate / Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Moqui/REST contract mapping (blocking):** What are the exact Moqui services and/or REST endpoints used in this repo for:
   - Loading estimate header + items + totals
   - Searching catalog parts/products (query + pagination)
   - Creating catalog part estimate items
   - Creating non-catalog part estimate items
   - Updating quantity
   - Applying/removing price overrides
2. **Capability/policy source (blocking):** Where does the UI obtain:
   - `canOverridePrice`
   - `allowNonCatalogParts`
   - `requireOverrideReason`
   Is this embedded in estimate payload, returned by a user-context endpoint, or a location/shop configuration endpoint (DECISION-INVENTORY-013)?
3. **Override reason codes (blocking if `requireOverrideReason=true`):** What endpoint/schema provides valid reason codes, and are they location-scoped?
4. **Concurrency/version token (blocking for correct 409 behavior):** Do estimate/items expose a version token (`lastUpdatedStamp`, `version`, or ETag) that must be sent on update/override to detect stale edits?
5. **Tax display contract (non-blocking unless UI must show line tax):** Are line-level tax fields returned for estimate items, or should UI display only estimate-level totals?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #237: [FRONTEND] [STORY] Estimate: Add Labor to Estimate
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] Estimate: Add Labor/Service Line to Draft Estimate (Catalog + Optional Custom)

**Primary Persona:** Service Advisor

**Business Value:** Enables accurate, auditable quoting of labor/services on a draft estimate with deterministic backend pricing and immediate total recalculation, reducing quoting time and pricing errors.

---

## 2. Story Intent

**As a** Service Advisor  
**I want** to add labor/service line items to an Estimate in DRAFT status by selecting from the service catalog (and optionally adding a custom labor line when allowed)  
**So that** the estimate reflects accurate labor charges and totals before customer approval.

### In-scope
- Add **catalog labor/service** line item(s) to an **Estimate in DRAFT** status.
- Search and select a **Service Catalog** entry by code or description using a picker/search UX (no raw ID entry).
- Capture **labor units** for time-based services OR accept **flat-rate** services as defined by backend.
- Display backend-derived **pricing** (rate/extended amount) and **recalculated totals** after adding a labor line.
- Add optional **notes/instructions** at line-item level.
- Controlled **custom labor** entry path **only if enabled** by backend capability/policy signal.

### Out-of-scope
- Creating/editing Service Catalog master data.
- Defining pricing rule hierarchy / labor-rate policy (pricing domain; backend-owned).
- Editing/removing existing labor lines (unless already supported elsewhere).
- Estimate approval capture flows and estimate state transitions (approve/decline/reopen).
- Any timekeeping/payroll implications.

---

## 3. Actors & Stakeholders
- **Primary actor:** Service Advisor
- **Secondary actors:** None
- **Stakeholders:**
  - Workexec domain owners (estimate workflow + estimate line items)
  - Pricing domain owners (labor rate determination)
  - Audit/Compliance (traceability of estimate financial changes)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- User has permission/capability to edit estimates (capability signal preferred; backend authoritative).
- An **Estimate** exists and is in **status = DRAFT**.
- Service Catalog is accessible for searching.

### Dependencies (blocking if absent)
- A backend/Moqui contract exists for:
  - Loading estimate details including status, existing items, totals, and a concurrency token (if supported)
  - Searching Service Catalog (query + pagination)
  - Adding a labor/service estimate line (catalog)
  - (Optional) Adding a custom labor line (if allowed)
  - Returning updated estimate totals and the created/updated line(s)
- Standard error envelope support (DECISION-INVENTORY-011): `code`, `message`, `correlationId`, optional `fieldErrors[]`.

### Non-blocking but important
- Backend provides/derives tax behavior for labor items (if totals include tax).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Estimate Edit** screen for an estimate in DRAFT status: action **‚ÄúAdd Labor/Service‚Äù**.

### Screens to create/modify
- **Modify**: `EstimateEdit.xml` (canonical per DECISION-INVENTORY-002) to:
  - Show an ‚ÄúAdd Labor/Service‚Äù action when estimate status is `DRAFT`
  - Display labor/service line items and totals
  - Refresh line list + totals after add
- **Create/Modify**: child screen or dialog flow under estimate context (implementation choice):
  - Suggested: `EstimateEdit.xml` sub-screen (e.g., `EstimateEdit/AddLabor`) or a dialog invoked from `EstimateEdit`
  - Contains catalog search + selection + line inputs + submit

### Navigation context
- Keep user in estimate context:
  - `.../durion-workexec/EstimateEdit?estimateId=<id>` (canonical screen)
  - Optional child transition: `.../durion-workexec/EstimateEdit/AddLabor?estimateId=<id>` (if implemented as sub-screen)

### User workflows (happy + alternate)
**Happy path (catalog labor/service):**
1. Service Advisor opens Draft Estimate in `EstimateEdit`.
2. Clicks ‚ÄúAdd Labor/Service‚Äù.
3. Searches catalog by code/description.
4. Selects a service.
5. If time-based: enters labor units > 0.
6. Submits.
7. Returns to estimate edit view with new line + updated totals.

**Alternate path (custom labor, if enabled):**
1. Search yields no results (or user chooses ‚ÄúCustom Labor‚Äù).
2. Custom entry form appears (only if allowed).
3. Enters required description + labor units > 0 (+ optional notes).
4. Submits.
5. Returns to estimate edit view with new custom labor line + updated totals.

**Deep-link / invalid state path:**
- If user navigates directly to add-labor flow for a non-DRAFT estimate, UI blocks add and routes back to `EstimateEdit` with an info banner.

---

## 6. Functional Behavior

### Triggers
- User clicks **Add Labor/Service** from `EstimateEdit` while estimate is `DRAFT`.
- User submits catalog selection + required inputs.
- User submits custom labor entry (if allowed).

### UI actions
- **Catalog search**
  - Inputs: `query` string, pagination controls (`pageIndex`, `pageSize`)
  - Results list shows at minimum: `serviceCode`, `description`, and `pricingModel` indicator (time-based vs flat-rate)
- **Selection**
  - Selecting a result sets ‚ÄúSelected Service‚Äù
  - If time-based: show editable `laborUnits`
  - If flat-rate: show read-only indicator; any editable fields must be explicitly allowed by backend contract (not assumed)
- **Submit**
  - Submit sends an idempotent mutation request (Idempotency-Key required for create/submit per DECISION-INVENTORY-012)
  - On success, update estimate lines and totals (prefer using response payload; otherwise re-fetch estimate)

### State changes (frontend-visible)
- Estimate line list includes the new labor/service item.
- Totals update (subtotal/tax/grand total or equivalent fields returned by backend).

### Service interactions
- Load estimate (initial + refresh)
- Search service catalog
- Add labor/service line (catalog)
- Add custom labor line (optional, policy-driven)
- Error normalization to standard envelope (DECISION-INVENTORY-011)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Estimate must be DRAFT**
  - If not `DRAFT`, hide/disable ‚ÄúAdd Labor/Service‚Äù
  - If deep-linked, show: ‚ÄúEstimate is not editable in this state.‚Äù and route back to `EstimateEdit`
- **Labor units must be > 0** for time-based services
  - Inline error: ‚ÄúLabor units must be a positive number.‚Äù
  - Submit disabled until valid
- **Custom labor description required** (only when custom entry is enabled and selected)
  - Inline error: ‚ÄúDescription is required.‚Äù
- **IDs are opaque strings** (DECISION-INVENTORY-003)
  - UI must not validate IDs as UUID/numeric; use pickers/search and treat IDs as opaque

### Enable/disable rules
- Submit disabled while:
  - Required fields invalid/missing
  - A request is in-flight
- Custom labor option visible only when backend indicates it is allowed (capability/policy signal; see Open Questions)

### Visibility rules
- Notes field visible for both catalog and custom labor items (optional)
- Any manual price/rate fields are **not shown** unless backend explicitly indicates manual entry is allowed for this user/context (capability-driven; see Open Questions)

### Error messaging expectations
- Parse standard error envelope when present:
  - Show `message` as primary error
  - If `fieldErrors[]` present, map to inline field errors
  - Display `correlationId` in an expandable ‚ÄúDetails‚Äù area for support
- Fallback mapping when envelope not available:
  - 400: ‚ÄúPlease correct the highlighted fields.‚Äù
  - 403: ‚ÄúYou don‚Äôt have permission to modify this estimate.‚Äù
  - 404: ‚ÄúEstimate or service not found.‚Äù
  - 409: ‚ÄúThis estimate was updated by someone else. Refresh and try again.‚Äù
  - 5xx: ‚ÄúSomething went wrong. Try again.‚Äù

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- Workexec-owned:
  - `Estimate` (workexec estimate workflow; status gating per CUSTOMER_APPROVAL_WORKFLOW.md)
  - `EstimateItem` (labor/service line)
- External dependencies (read-only to this story):
  - `ServiceCatalog` (product/catalog domain SoR; searched/selected)
  - Pricing outputs (pricing domain SoR; returned as computed fields)
- Audit metadata (created/updated fields; optional audit endpoints)

### Fields (types, required, defaults)

**Estimate (read-only in this story)**
- `estimateId` (id/opaque string; required)
- `statusId` (enum string; required; must be `DRAFT` to enable add)
- Totals (money; required for display; exact field names per API):
  - `subTotal`
  - `totalTax`
  - `grandTotal`
- Concurrency token (optional but recommended; see Open Questions):
  - `version` or `lastUpdatedStamp`

**ServiceCatalog search result item (read-only)**
- `serviceCode` (string; required)
- `description` (string; required)
- `pricingModel` (enum; required): `TIME_BASED` | `FLAT_RATE` (or equivalent)
- Optional display fields (if available): `defaultUnits`, `category`, etc.

**EstimateItem (labor/service)**
- `estimateItemId` or `itemSeqId` (id/opaque string; backend-assigned; read-only)
- `itemTypeId` (enum string; backend-set; read-only; expected to represent labor/service)
- `serviceCode` (string; required for catalog items)
- `description` (string; required for custom items; read-only for catalog unless backend allows override)
- `laborUnits` (decimal; required for time-based; for flat-rate, behavior is backend-defined)
- Pricing fields (money; backend-derived; read-only unless manual entry explicitly allowed):
  - `unitRate` / `laborRate` (money)
  - `extendedAmount` (money)
- `notes` (string/text; optional)
- `taxCode` (string; backend-derived unless contract requires user selection‚Äîsee Open Questions)

### Read-only vs editable by state/role
- Editable only when `Estimate.statusId = DRAFT`.
- Role/capability gating:
  - Must have estimate edit capability to see/execute add actions
  - Custom labor and manual price/rate entry require explicit capability flags (not assumed)

### Derived/calculated fields
- Totals and extended amounts are authoritative from backend; frontend must not compute totals beyond formatting.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementation may use screen actions/services rather than REST. The contracts below define required behaviors and headers; actual service names/paths must be aligned to the existing `durion-workexec` component.

### Load/view calls
1. **Load estimate detail**
   - Request (example): `GET /rest/api/v1/workexec/estimates/{estimateId}`
   - Response must include:
     - `estimateId`, `statusId`
     - current `items[]` (including labor/service items)
     - totals (`subTotal`, `totalTax`, `grandTotal`)
     - optional concurrency token (`version` or `lastUpdatedStamp`)
     - capability/policy flags relevant to this story (preferred; see Open Questions)

2. **Search service catalog**
   - Request (example): `GET /rest/api/v1/product/services?query=<q>&pageIndex=<n>&pageSize=<n>`
   - Response:
     - `items[]` with `serviceCode`, `description`, `pricingModel`
     - pagination metadata (`pageIndex`, `pageSize`, `totalCount`)

### Create/update calls (mutations must send Idempotency-Key)
3. **Add labor/service line (catalog)**
   - Request (example): `POST /rest/api/v1/workexec/estimates/{estimateId}/items:labor`
   - Headers:
     - `Idempotency-Key: <uuid>` (required; reuse on retry for same attempt)
   - Payload (minimum):
     - `serviceCode` (required)
     - `laborUnits` (required if time-based; omitted or ignored if flat-rate per backend)
     - `notes` (optional)
     - optional concurrency token (`version`/`lastUpdatedStamp`) if supported
   - Response (preferred):
     - created/updated `estimateItem`
     - updated totals
     - updated concurrency token
   - Alternate response:
     - 200/201 with created item only; frontend then re-fetches estimate

4. **Add labor/service line (custom) ‚Äî only if allowed**
   - Request (example): `POST /rest/api/v1/workexec/estimates/{estimateId}/items:labor-custom`
   - Headers:
     - `Idempotency-Key: <uuid>` (required)
   - Payload (minimum):
     - `description` (required)
     - `laborUnits` (required)
     - `notes` (optional)
     - optional `serviceCode` only if backend requires a controlled code; otherwise omitted
     - **No manual rate fields unless backend explicitly supports and signals permission**
   - Response: same expectations as catalog add

### Submit/transition calls
- None (approve/decline/reopen out of scope).

### Error handling expectations
- Standard error envelope (DECISION-INVENTORY-011) for 400/403/404/409/5xx where applicable:
  - `code`, `message`, `correlationId`, optional `fieldErrors[]`
- Concurrency:
  - If concurrency token is used and stale, backend returns `409 Conflict` with message; UI offers refresh and retry
- Authorization:
  - Backend returns `403 Forbidden` even if UI hides actions (DECISION-INVENTORY-013 principle)

---

## 10. State Model & Transitions

### Allowed states (Estimate)
From CUSTOMER_APPROVAL_WORKFLOW.md:
- `DRAFT`
- `APPROVED`
- `DECLINED`
- `EXPIRED`

### Role-based transitions
- None in this story.

### UI behavior per state
- `DRAFT`: show ‚ÄúAdd Labor/Service‚Äù and allow add flows.
- `APPROVED`, `DECLINED`, `EXPIRED`: hide/disable add flows; show info banner ‚ÄúEstimate is not editable in this state.‚Äù

---

## 11. Alternate / Error Flows

1. **No catalog results**
   - Show empty state: ‚ÄúNo services found.‚Äù
   - If custom labor allowed: show ‚ÄúAdd Custom Labor‚Äù
   - If not allowed: show guidance ‚ÄúTry a different search term.‚Äù

2. **Invalid labor units**
   - Inline validation; prevent submit; do not call backend.

3. **Backend rejects due to pricing/rate resolution**
   - Show backend `message` (standard envelope) and keep user on add form.
   - Do not add line; totals remain unchanged.

4. **Estimate not DRAFT**
   - If user deep-links to add-labor route:
     - Load estimate
     - If not DRAFT, block add and route back to `EstimateEdit` with banner

5. **Unauthorized (403)**
   - Show permission error; do not retry automatically.

6. **Conflict (409)**
   - Show ‚ÄúEstimate updated elsewhere‚Äù with actions:
     - ‚ÄúRefresh estimate‚Äù (re-fetch)
     - ‚ÄúDiscard changes‚Äù (close dialog)
   - Preserve user-entered values locally until user chooses.

7. **Network/5xx**
   - Show retry affordance.
   - Do not auto-resubmit; if user retries, reuse the same Idempotency-Key for that attempt.

---

## 12. Acceptance Criteria

### Scenario 1: Add a time-based catalog labor/service item to a Draft estimate
**Given** I am authenticated as a Service Advisor with permission to edit estimates  
**And** an estimate with id "<estimateId>" exists in status "DRAFT"  
**When** I open `EstimateEdit` for "<estimateId>"  
**And** I choose "Add Labor/Service"  
**And** I search the service catalog for "oil"  
**And** I select a service with `pricingModel` = "TIME_BASED" and `serviceCode` = "SVC-OIL-CHG"  
**And** I enter labor units "1.5"  
**And** I submit the add labor form  
**Then** the system creates a new labor/service estimate item  
**And** the item is visible on `EstimateEdit` with service code "SVC-OIL-CHG" and labor units "1.5"  
**And** the item displays backend-derived pricing fields (rate and/or extended amount)  
**And** the estimate totals displayed reflect the newly added item.

### Scenario 2: Prevent adding labor/service when estimate is not Draft
**Given** I am authenticated as a Service Advisor  
**And** an estimate with id "<estimateId>" exists in status "APPROVED"  
**When** I open `EstimateEdit` for "<estimateId>"  
**Then** the "Add Labor/Service" action is not available  
**And** if I navigate directly to the add-labor route, the UI blocks the add flow and returns me to `EstimateEdit` with a message "Estimate is not editable in this state."

### Scenario 3: Reject invalid labor units client-side
**Given** I am authenticated as a Service Advisor  
**And** an estimate exists in status "DRAFT"  
**When** I select a time-based service from the catalog  
**And** I enter labor units "0"  
**Then** I see an inline validation message "Labor units must be a positive number."  
**And** the submit action is disabled  
**And** no request to add a labor/service item is sent.

### Scenario 4: Custom labor entry is shown only when backend indicates it is allowed
**Given** I am authenticated as a Service Advisor  
**And** an estimate exists in status "DRAFT"  
**When** I open the "Add Labor/Service" flow  
**Then** I see an option "Add Custom Labor" only if the estimate payload (or user capability payload) indicates custom labor is allowed  
**And** if custom labor is not allowed, I do not see the option and cannot access the custom labor form.

### Scenario 5: Custom labor requires description
**Given** I am authenticated as a Service Advisor  
**And** custom labor entry is allowed  
**And** an estimate exists in status "DRAFT"  
**When** I choose "Add Custom Labor"  
**And** I leave description empty  
**Then** I see an inline validation message "Description is required."  
**And** the submit action is disabled  
**And** no request to add a custom labor item is sent.

### Scenario 6: Handle backend validation and correlation id on failure
**Given** I am authenticated as a Service Advisor  
**And** an estimate exists in status "DRAFT"  
**When** I submit a catalog labor/service line  
**And** the backend responds with a 400 error using the standard error envelope including `message` and `correlationId`  
**Then** I see the backend `message` displayed to me  
**And** I can view/copy the `correlationId` from the error details  
**And** the labor/service line item is not added  
**And** the estimate totals remain unchanged in the UI.

### Scenario 7: Handle conflict (409) with refresh and idempotency-safe retry
**Given** I am authenticated as a Service Advisor  
**And** an estimate exists in status "DRAFT"  
**When** I submit an add labor/service request  
**And** the backend responds with 409 "Conflict" indicating the estimate was updated  
**Then** I see a message "This estimate was updated by someone else. Refresh and try again."  
**And** I can refresh the estimate and retry the add action  
**And** if I retry the same submission attempt, the UI reuses the same Idempotency-Key for that attempt.

---

## 13. Audit & Observability

### User-visible audit data
- If `EstimateEdit` already displays ‚ÄúLast updated‚Äù / ‚ÄúUpdated by‚Äù, it must update after a successful add.
- No new audit UI is required in this story.

### Status history
- No estimate status changes in this story.

### Traceability expectations
- Each successful add-labor action must be traceable server-side (audit event or updated metadata).
- Frontend must:
  - Send `Idempotency-Key` for add operations (DECISION-INVENTORY-012)
  - Log/propagate `correlationId` from error envelope in UI error details (DECISION-INVENTORY-011)

---

## 14. Non-Functional UI Requirements

- **Performance:** Catalog search supports pagination and should be usable interactively; show loading state and avoid blocking the UI thread.
- **Accessibility:** Labeled inputs; validation errors announced to assistive tech; keyboard navigation for search results and submit.
- **Responsiveness:** Works on tablet-sized POS devices.
- **i18n/timezone/currency:** Currency formatting uses app-wide settings; do not hardcode currency symbols. (Timezone not directly applicable unless timestamps are shown.)

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a standard empty state for ‚Äúno catalog results‚Äù with guidance and optional custom entry action; qualifies as safe UX ergonomics; impacts UX Summary, Alternate/Error Flows.
- SD-UX-LOADING-STATE: Show loading and disable submit during in-flight requests to prevent duplicate submissions; qualifies as safe recoverability; impacts Functional Behavior, Alternate/Error Flows.
- SD-ERR-HTTP-MAP: Map common HTTP errors (400/403/404/409/5xx) to user-friendly messages without leaking internals; qualifies as safe error-handling; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Backend contract specifics (blocking):** What are the exact Moqui screen actions/services or REST endpoints used in this repo for:
   - loading estimate detail (including totals and items)
   - searching service catalog (query + pagination)
   - adding catalog labor/service line
   - adding custom labor line (if supported)
   - whether add responses include updated totals or require re-fetch  
2. **Custom labor policy signal (blocking):** How does the frontend determine whether custom labor is allowed for the current user and estimate context (capability flag in user context, field on estimate payload, or config endpoint)? Provide the exact field name(s).
3. **Flat-rate editability (blocking):** For flat-rate catalog services, is `laborUnits` editable, or must it be locked to backend/catalog defaults? If editable, what validation rules apply?
4. **Manual rate/price entry (blocking):** If backend cannot determine a labor rate, is manual rate entry allowed? If yes:
   - what capability/permission flag enables it (per DECISION-INVENTORY-013 pattern)
   - what fields are required (rate, reason/note)
   - how is it audited and displayed
5. **Tax code handling (blocking):** Is `taxCode` always backend-derived for labor/service items, or can/should the user select it? If selectable, what are allowed values and defaults?
6. **Concurrency token (blocking):** Does the estimate payload include a `version`/`lastUpdatedStamp` (or similar) that must be echoed on mutation for concurrency-safe updates? If yes, specify the field and required behavior.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #235: [FRONTEND] [STORY] Estimate: Revise Estimate Prior to Approval
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Estimate: Revise Estimate Prior to Approval (Versioned + Approval Invalidation)

### Primary Persona
Service Advisor

### Business Value
Ensure Service Advisors can correct or adjust a customer estimate before commitment while preserving immutable history, maintaining auditability, and preventing stale/invalid approvals from being used.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to ‚ÄúRevise‚Äù an estimate by creating a new editable version linked to the prior version  
- **So that** I can adjust scope/pricing/notes before customer approval while the system preserves a full version history and invalidates any prior approvals tied to earlier versions.

### In-scope
- Revise action available on an estimate when in an allowed state (see **State Model**).
- Creating a new estimate version linked to the prior version (immutable prior version).
- Editing the new version (line items + terms/notes) and saving.
- Recalculation of totals on save (and optionally on edit, see safe defaults).
- Invalidation of prior approvals when revision occurs from an approval-pending context.
- Viewing revision/version history and comparing prior versions (read-only).

### Out-of-scope
- Creating or managing approval configurations (method selection) beyond displaying current method if present.
- Notifications (email/SMS) to customers about new revision.
- Converting estimate to work order.
- Change request workflow after conversion to work order.
- Defining pricing/tax calculation logic (assumed backend-owned).

---

## 3. Actors & Stakeholders

- **Primary Actor:** Service Advisor
- **Secondary Actors:**  
  - Shop Manager (read-only oversight of history)  
  - Auditor/Compliance (needs immutable trail)  
- **System Dependencies:** workexec backend services for estimates/versions/approvals; audit/event subsystem (backend).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- User can view the estimate.
- Estimate exists and can be loaded by ID.
- Estimate is in a state that permits revision (see **State Model & Transitions**).

### Dependencies
- Backend must support:
  - Creating a new estimate version/revision linked to a prior version.
  - Fetching current estimate and version history.
  - Persisting edits to the active version.
  - Invalidation of approvals tied to a previous version when revision is initiated from an approval-pending context.
- Moqui screens must be able to call these endpoints/services (exact Moqui service names/routes are not provided in inputs).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Estimate Edit/Detail screen: action button **Revise** (visible/enabled only in eligible states and with permission).
- From Estimate List: contextual action **Revise** (optional; if present, must follow same eligibility rules).

### Screens to create/modify
1. **`durion-workexec/EstimateEdit.xml` (modify)**  
   - Add Revise action, version indicator (e.g., ‚Äúv3‚Äù), and link to ‚ÄúVersion History‚Äù.
2. **`durion-workexec/EstimateVersionHistory.xml` (new)**  
   - List versions with status, createdAt, createdBy, approval status.
   - View read-only prior version details.
   - Compare two versions (minimum: totals + line item diffs).
3. **`durion-workexec/EstimateCompare.xml` (optional new; may be embedded in history screen)**  
   - Side-by-side compare of two selected versions.

> Canonical screen alignment decision: DECISION-INVENTORY-002 (use existing workexec screens; extend rather than invent new routes).

### Navigation context
- Use existing workexec navigation/menu conventions; minimum deep links:
  - `.../durion-workexec/EstimateEdit?estimateId=<id>` (active version)
  - `.../durion-workexec/EstimateVersionHistory?estimateId=<id>`
  - Optional: `.../durion-workexec/EstimateCompare?estimateId=<id>&leftVersionId=<id>&rightVersionId=<id>`

### User workflows (happy + alternate)
- **Happy path**
  1. Advisor opens Estimate Edit/Detail (active version visible).
  2. Clicks **Revise**.
  3. Confirms revision (and enters reason if required by backend contract).
  4. System creates new version, marks it active, and reloads Estimate Edit for the new version.
  5. Advisor edits items/notes and saves.
  6. Totals are recalculated; save succeeds; advisor remains on Estimate Edit showing new version.
- **Alternate paths**
  - User cancels before confirming revision: no new version created.
  - User confirms revision, then navigates away without saving: new version remains active as a draft (backend-owned; UI must not attempt to auto-delete).
  - Attempt revise in non-eligible state: action disabled; if state changed concurrently, backend returns conflict and UI prompts reload.

---

## 6. Functional Behavior

### Triggers
- User clicks **Revise** on Estimate Edit/Detail.

### UI actions
- **On screen load**
  - Load estimate (including active version metadata and status).
  - Load capability flags (if available) to gate actions (see Service Contracts).
- **Revise click**
  - Client refreshes estimate header/status (or uses ETag/version token if provided) to reduce stale actions.
  - Show confirmation modal:
    - Summary: current version number, current status.
    - Warning: ‚ÄúRevising creates a new version and requires re-approval if previously approved/declined.‚Äù
    - Input: revision reason (only if required by backend; otherwise optional free text).
    - Actions: Confirm / Cancel.
- **Confirm**
  - Call backend to create a new version/revision record.
  - Include `Idempotency-Key` header (DECISION-INVENTORY-012).
  - On success: navigate/reload Estimate Edit for the new active version (or returned versionId).
- **Edit**
  - Allow modifying line items and notes/terms on the active editable version only.
  - Save triggers backend update and totals recalculation.
  - Include `Idempotency-Key` for save if backend treats save as a mutation that could double-submit (recommended; see Service Contracts).
- **Version history**
  - List all versions; allow opening prior version read-only.
  - Compare: user selects two versions ‚Üí show differences (minimum: totals + line item add/remove/change).

### State changes (frontend-visible)
- On successful revision initiation:
  - Active version becomes the newly created version (expected to be editable; likely `DRAFT`).
  - Prior version becomes immutable (read-only in UI).
- If revision initiated from `APPROVED`:
  - New version is `DRAFT`.
  - Prior approval is no longer applicable to the new version (approval invalidation).

### Service interactions
- Load estimate + current active version.
- Create revision (new version).
- Update version (save edits).
- Load version history + retrieve specific prior version.
- Compare: compute diff client-side from two loaded versions unless backend provides a diff endpoint.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Revision eligibility by estimate status** (resolved using CUSTOMER_APPROVAL_WORKFLOW.md):
  - Allowed when estimate status is one of: `DRAFT`, `APPROVED`, `DECLINED` (revising a declined estimate is effectively ‚Äúcreate a new draft version‚Äù; see State Model).
  - Not allowed when estimate status is `EXPIRED`.
  - Rationale: approval workflow supports `reopenEstimate()` only for declined; however ‚Äúrevise‚Äù is a versioning action. Without a defined backend contract, UI must follow backend eligibility and treat `EXPIRED` as terminal. (Blocking: confirm backend supports revise for `APPROVED` and `DECLINED`.)
- **Approval invalidation**
  - If current estimate status is `APPROVED`, show warning that a new approval will be required.
  - UI must not attempt to ‚Äúinvalidate‚Äù approvals client-side; backend is authoritative.
- **Immutability**
  - Prior versions are always read-only; UI must not render edit controls for non-active versions.
- **IDs**
  - Treat all IDs as opaque strings (DECISION-INVENTORY-003); no UUID/numeric validation.

### Enable/disable rules
- Disable ‚ÄúConfirm Revise‚Äù while request is in-flight to prevent double-submit.
- Disable ‚ÄúSave‚Äù while save is in-flight.
- Disable ‚ÄúCompare‚Äù until exactly two versions are selected.
- If backend returns fieldErrors, mark fields invalid and keep user input.

### Visibility rules
- Revise button visible only if user has revise capability and estimate is in eligible status.
- Version history link visible if user can view estimate (same permission gate unless separate capability exists).

### Error messaging expectations (standard envelope)
- Use standard error envelope parsing (DECISION-INVENTORY-011):
  - Permission denied (403): ‚ÄúYou do not have permission to revise this estimate.‚Äù
  - Invalid state / conflict (409): ‚ÄúThis estimate changed since you opened it. Reload and try again.‚Äù
  - Validation (400): show inline field errors; banner ‚ÄúFix the highlighted fields.‚Äù
  - Not found (404): ‚ÄúEstimate not found or you no longer have access.‚Äù
  - 5xx: ‚ÄúUnable to revise estimate. Please try again or contact support.‚Äù Include correlationId in details panel if available.

---

## 8. Data Requirements

> Frontend must rely on API responses. The fields below are required for UI binding and display; exact schema must be confirmed against Moqui services/REST.

### Entities involved (conceptual)
- `Estimate` (workexec-owned approval lifecycle per CUSTOMER_APPROVAL_WORKFLOW.md)
- `EstimateVersion` (or `EstimateRevision`) (workexec-owned version history)
- `ApprovalConfiguration` (read-only display of method)
- `Audit metadata` (created/updated fields; optional audit log)

### Fields (frontend contract requirements)

#### Estimate (read)
- `estimateId` (id string, required)
- `status` (enum string, required): `DRAFT|APPROVED|DECLINED|EXPIRED`
- `customerId` (id string, required for display/link)
- `vehicleId` (id string, optional)
- `locationId` or `shopId` (id string, optional)
- `activeVersionId` (id string, required if versioned model)
- `activeVersionNumber` (int, required for display)
- `approvalConfiguration` (object, optional)
  - `approvalMethod` (enum string, optional): `CLICK_CONFIRM|SIGNATURE|ELECTRONIC_SIGNATURE|VERBAL_CONFIRMATION`
  - `requireSignature` (bool, optional)
- `createdAt` (datetime, read-only)
- `updatedAt` (datetime, read-only)

#### Estimate Version / Revision (read/write on active version)
- `estimateVersionId` (id string, required)
- `versionNumber` (int, required)
- `priorVersionId` (id string, nullable)
- `createdBy` (id or displayName, read-only)
- `createdAt` (datetime, read-only)
- `revisionReason` (string, optional unless backend requires)
- `notes` / `terms` (string, editable)
- `lineItems[]` (editable on active version)
  - `lineItemId` (id string, required)
  - `itemType` (enum string, required) **blocking: confirm allowed values**
  - `description` (string, required)
  - `productId` / `serviceId` (id string, optional depending on type)
  - `quantity` (decimal, required, >0)
  - `unitPrice` (decimal/money, editable only if permitted)
  - `declined` (bool, optional; default false)
- `totals` (read-only; calculated by backend)
  - `subtotal`, `tax`, `fees`, `grandTotal` (money/decimal)
  - `currencyUomId` or `currencyCode` (string, optional but preferred)

### Read-only vs editable by state/role
- Prior versions: all fields read-only.
- Active version:
  - Editable when estimate status is `DRAFT` (and possibly when `DECLINED` after revise creates new draft version).
  - If estimate status is `APPROVED`, revision creates a new draft version; editing occurs on that draft.
- Price override editability:
  - Must be gated by capability flag (DECISION-INVENTORY-013) and enforced by backend (403).

### Derived/calculated fields
- Totals are backend-calculated; UI displays returned totals only.

---

## 9. Service Contracts (Frontend Perspective)

> Exact Moqui service names/endpoints for versioning are not provided in inputs. This story defines required contracts; implementation may be via Moqui screen actions calling services or REST endpoints.

### Load/view calls
- `GET /api/estimates/{estimateId}`
  - Returns estimate header including `status`, `activeVersionId`, `activeVersionNumber`, and (ideally) an `isRevisable` boolean to avoid client-side status mapping.
- `GET /api/estimates/{estimateId}/versions`
  - Returns list of versions: `estimateVersionId`, `versionNumber`, `createdAt`, `createdBy`, and a marker for active version.
- `GET /api/estimates/{estimateId}/versions/{versionId}`
  - Returns full version details (read-only for non-active).

### Create/update calls
- **Create revision/version**
  - `POST /api/estimates/{estimateId}/revisions` (preferred REST noun) **or** `POST /api/estimates/{estimateId}/revise` (acceptable)
  - Headers: `Idempotency-Key: <uuid>`
  - Request body:
    - `revisionReason` (string, optional unless required)
    - Optional concurrency token if supported: `ifMatch`/`version` (blocking: confirm)
  - Response (201):
    - Updated estimate header + new active version summary, or at minimum `newVersionId`, `newVersionNumber`, `status`
- **Update active version**
  - `PUT /api/estimates/{estimateId}/versions/{versionId}`
  - Headers: optional `Idempotency-Key` (recommended) and optional concurrency token
  - Request body: editable fields (lineItems, notes/terms)
  - Response (200): updated version + recalculated totals

### Submit/transition calls
- None in this story (approval actions are separate).

### Error handling expectations
- Errors conform to standard envelope (DECISION-INVENTORY-011):
  - `{"code","message","correlationId","fieldErrors":[{"field","message"}], "existingResourceId"}` (as applicable)
- Status codes:
  - 400 validation, 401 unauthenticated, 403 forbidden, 404 not found, 409 conflict, 5xx server error
- UI behavior:
  - On 409: prompt reload; do not assume revision created.
  - On 400: preserve form state and show field errors.

---

## 10. State Model & Transitions

### Allowed states (authoritative source)
From `CUSTOMER_APPROVAL_WORKFLOW.md`:
- `DRAFT`
- `APPROVED`
- `DECLINED`
- `EXPIRED`

### Revision eligibility (UI gating; backend authoritative)
- **Eligible:** `DRAFT`, `APPROVED`, `DECLINED`
- **Not eligible:** `EXPIRED`

> Blocking: confirm backend supports revise for `APPROVED` and `DECLINED` and whether revise is equivalent to `reopenEstimate()` for declined or a distinct action.

### Role-based transitions
- Service Advisor can initiate revision if authorized.
- Backend must enforce with 403 even if UI hides action (DECISION-INVENTORY-013).

### UI behavior per state
- `DRAFT`: Revise enabled; creates new draft version and opens it.
- `APPROVED`: Revise enabled; warns that new approval will be required; creates new draft version.
- `DECLINED`: Revise enabled; creates new draft version (effectively ‚Äúrevise and reopen‚Äù); prior declined version remains immutable.
- `EXPIRED`: Revise disabled; show tooltip/help text ‚ÄúExpired estimates cannot be revised.‚Äù

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required revision reason (if backend requires): show inline error in modal; do not call create.
- Invalid line item quantity/unit price: show inline errors from backend; do not lose user edits.

### Concurrency conflicts
- If estimate status/version changes between load and revise:
  - Backend returns 409.
  - UI shows reload prompt and reloads estimate on user action.
- Double-click revise/confirm:
  - UI disables confirm while in-flight.
  - If request is retried, reuse the same `Idempotency-Key` for that attempt (DECISION-INVENTORY-012).

### Unauthorized access
- If user lacks revise permission:
  - Revise button hidden/disabled.
  - If user deep-links to revise action, show Access Denied and do not create a new version.

### Empty states
- Version history returns empty list:
  - Show empty state with reload; treat as data issue but not fatal.

---

## 12. Acceptance Criteria

### Scenario 1: Revise a Draft estimate creates a new version and opens it for editing
**Given** an estimate exists with status `DRAFT` and active version number `1`  
**And** I am logged in as a Service Advisor with permission/capability to revise estimates  
**When** I open the estimate edit screen and click **Revise** and confirm  
**Then** the system creates a new estimate version linked to version `1`  
**And** the UI reloads/navigates to the estimate edit screen showing active version number `2`  
**And** version `1` is available in Version History as read-only

### Scenario 2: Revising an Approved estimate requires re-approval
**Given** an estimate exists with status `APPROVED` and active version number `3`  
**And** I am logged in as a Service Advisor with revise capability  
**When** I click **Revise** and confirm  
**Then** the system creates a new active version number `4` in an editable state (`DRAFT`)  
**And** the UI displays a banner indicating the estimate requires approval again  
**And** the prior approved version remains read-only in Version History

### Scenario 3: Revising a Declined estimate creates a new draft version
**Given** an estimate exists with status `DECLINED` and active version number `2`  
**And** I am logged in as a Service Advisor with revise capability  
**When** I click **Revise** and confirm  
**Then** the system creates a new active version number `3` in `DRAFT`  
**And** the UI allows editing version `3`  
**And** the declined version `2` remains read-only in Version History

### Scenario 4: Saving edits recalculates totals and persists changes
**Given** I am editing the active draft version of an estimate  
**When** I change a line item quantity and click **Save**  
**Then** the system persists the updated version  
**And** the UI displays recalculated totals returned by the backend  
**And** the active version number remains unchanged after save

### Scenario 5: Attempting to revise an Expired estimate is blocked
**Given** an estimate exists with status `EXPIRED`  
**When** I view the estimate  
**Then** the **Revise** action is not available  
**And** if I attempt the revise endpoint directly  
**Then** the backend returns `409 Conflict` or `400 Bad Request`  
**And** the UI shows ‚ÄúThis estimate cannot be revised in its current state.‚Äù

### Scenario 6: Permission denied when revising
**Given** I am logged in as a user without revise capability  
**When** I attempt to revise an estimate  
**Then** the backend returns `403 Forbidden`  
**And** the UI shows ‚ÄúAccess Denied‚Äù  
**And** no new version is created

### Scenario 7: Concurrency conflict during revision initiation
**Given** I have an estimate open that is revisable  
**And** another user changes the estimate so it is no longer revisable  
**When** I click **Revise** and confirm  
**Then** the backend returns `409 Conflict` with a `correlationId`  
**And** the UI prompts me to reload  
**And** the UI does not show a new active version

### Scenario 8: Version history and compare are read-only and accurate
**Given** an estimate has versions `1`, `2`, and `3` and version `3` is active  
**When** I open Version History and select version `1`  
**Then** the UI displays version `1` in read-only mode with no edit controls  
**When** I select versions `2` and `3` and click **Compare**  
**Then** the UI shows differences at minimum for totals and line items added/removed/changed

---

## 13. Audit & Observability

### User-visible audit data
- Version History list shows:
  - versionNumber, createdAt, createdBy
  - estimate status at time of version (if provided) or current estimate status + version metadata
  - revisionReason if stored/exposed
- On active version after revise-from-approved:
  - Banner ‚ÄúApproval required‚Äù (generic; do not claim specific approval method unless provided).

### Status history
- Display estimate status (`DRAFT/APPROVED/DECLINED/EXPIRED`) on Estimate Edit/Detail.
- If backend exposes transition timestamps (`approvedAt`, `declinedAt`, `expiresAt`), display them read-only.

### Traceability expectations
- For all revise/save calls:
  - Send `Idempotency-Key` for revise (required) and for save (recommended).
  - Log/retain `correlationId` from error envelope in UI error details (support copy).
- Do not log PII in client logs.

---

## 14. Non-Functional UI Requirements

- **Performance**
  - Version history loads within 2 seconds for up to 25 versions; paginate beyond that.
- **Accessibility**
  - Revise confirmation modal is keyboard navigable; focus is trapped; ESC closes; buttons have accessible labels.
- **Responsiveness**
  - Works on tablet form factor.
- **i18n/timezone/currency**
  - Display timestamps in user timezone and label timezone if shown (DECISION-INVENTORY-016).
  - Currency formatting uses `currencyUomId/currencyCode` from backend when provided; otherwise fallback to locale formatting (blocking: confirm shop default currency source).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide empty-state messaging and reload action for Version History; safe UI ergonomics; impacts UX Summary, Alternate/Error Flows.
- SD-UX-PAGINATION-01: Paginate Version History list after 25 items with server-side parameters if supported; safe ergonomics/performance; impacts UX Summary, Service Contracts, Non-Functional UI Requirements.
- SD-ERR-MAP-01: Map HTTP 400/401/403/404/409/5xx to consistent banner/toast messages and preserve form state on 400; safe standard error handling; impacts Business Rules, Alternate/Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Backend contract for estimate versioning (blocking):** What are the exact Moqui services or REST endpoints for:
   - creating a revision/version,
   - listing versions,
   - loading a specific version,
   - saving edits to the active version,
   - and what request/response schemas are used?
2. **Concurrency token (blocking):** Does the estimate/version payload include an ETag or `version` field that must be provided on revise/save to prevent lost updates? If yes, what is the field/header name and conflict behavior?
3. **RBAC/capabilities (blocking):** What capability/permission flags control:
   - revise estimate,
   - edit estimate line items,
   - override unit price (manual price),
   and how are these exposed to the frontend (user context endpoint vs session claims)?
4. **Line item type schema (blocking):** What are the authoritative line item types and required fields per type (PART/LABOR/FEE/etc.) for estimate editing in this UI?
5. **Declined estimate behavior alignment:** For `DECLINED`, should the UI prefer an explicit `reopenEstimate()` flow (existing backend) or always use `revise` to create a new version? If both exist, which is the intended operator workflow?
6. **Currency source:** If `currencyCode` is not returned on totals, what is the authoritative shop/location currency source for formatting?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #234: [FRONTEND] [STORY] Estimate: Present Estimate Summary for Review
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Estimate: Present Customer-Facing Estimate Summary for Review (Snapshot-Based)

## Primary Persona
Service Advisor

## Business Value
Enable Service Advisors to generate a deterministic, customer-facing estimate summary (view/print/share) that matches an immutable snapshot for review prior to seeking customer approval, while enforcing visibility policies and legal/compliance requirements.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor  
- **I want** to generate and view a customer-facing estimate summary for a Draft estimate  
- **So that** I can review scope, pricing, taxes/fees, terms, and expiration with the customer before submitting the estimate for approval.

## In-scope
- UI action to generate a customer-facing summary for an estimate in **DRAFT** status.
- Rendering a read-only summary from an **immutable snapshot** created at generation time.
- Enforcing role/capability-based visibility (hide internal-only fields like cost/margin).
- Displaying configured terms/disclaimers and expiration date when applicable.
- Optional next step CTA to proceed to ‚ÄúSubmit for Approval‚Äù (navigation only; actual approval capture is out of scope unless endpoint exists).

## Out-of-scope
- Editing estimate line items/pricing (only Draft editing elsewhere).
- Creating/changing legal terms configuration or policy configuration UI.
- Implementing approval capture flows (signature, electronic signature, etc.).
- Implementing PDF generation if backend doesn‚Äôt provide it (frontend will consume provided format/URL).

---

# 3. Actors & Stakeholders

- **Primary Actor:** Service Advisor
- **Secondary Actors:** Customer (recipient of summary), System (Moqui screens/services)
- **Stakeholders:** Compliance/Legal (terms/disclaimers), Finance (totals correctness), Audit/Security (visibility enforcement and immutable records)

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in POS frontend.
- Estimate exists and is accessible to the current user (authorization enforced server-side).
- Estimate is in status **DRAFT** (per customer approval workflow).

## Dependencies
- Workexec backend/Moqui capability to:
  - Validate estimate status and permissions.
  - Generate and persist an **Estimate Summary Snapshot** (immutable), and return a snapshot identifier and a renderable payload (structured JSON preferred) and/or a render URL.
  - Provide visibility outcomes (either already-filtered customer payload or explicit field visibility flags).
  - Provide legal terms/disclaimer text and indicate missing-terms handling outcome (e.g., `legalTermsSource=DEFAULT` vs `CONFIGURED`) captured in snapshot.
  - Return errors in the **standard error envelope** (`code`, `message`, `correlationId`, optional `fieldErrors[]`) per DECISION-INVENTORY-011.
- Moqui screen route(s) to reach estimate edit/detail and summary review screen (DECISION-INVENTORY-002).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From **Estimate Edit/Detail** screen for a Draft estimate: action **‚ÄúCustomer Summary‚Äù**.

## Screens to create/modify
1. **Modify**: `durion-workexec/EstimateEdit.xml`  
   - Add action to generate/open customer summary.
2. **Create**: `durion-workexec/EstimateSummaryReview.xml` (new screen in workexec component)  
   - Displays snapshot-based summary (read-only).
   - Provides actions: Print, Download (if supported), Back to Estimate, Proceed to Approval (navigation only).

## Navigation context
- Canonical workexec screen family (DECISION-INVENTORY-002):
  - Estimate edit: `/webroot/durion-workexec/EstimateEdit?estimateId=<id>`
- New screen route (Moqui screen path; exact mount depends on component menu):
  - Summary review: `/webroot/durion-workexec/EstimateSummaryReview?estimateId=<id>&snapshotId=<id>`
- Deep link support:
  - If `snapshotId` is present, screen loads that snapshot.
  - If `snapshotId` is absent, screen generates a new snapshot (only if estimate is DRAFT) then reloads with `snapshotId`.

## User workflows (happy + alternate paths)

### Happy path (generate + review)
1. SA opens Draft estimate in `EstimateEdit`.
2. SA clicks **Customer Summary**.
3. UI calls generate-snapshot service with `Idempotency-Key` (DECISION-INVENTORY-012).
4. UI navigates to `EstimateSummaryReview` with returned `snapshotId`.
5. UI loads snapshot payload and renders read-only customer summary.
6. SA prints/downloads (if available) and discusses with customer.
7. SA optionally clicks **Proceed to Approval** ‚Üí navigates to approval entry (existing flow; out-of-scope here).

### Alternate paths
- Estimate not DRAFT ‚Üí generation blocked; show invalid-state message; remain on estimate screen.
- Missing legal terms:
  - Policy FAIL ‚Üí generation blocked with compliance message.
  - Policy USE_DEFAULTS ‚Üí generation succeeds; show banner ‚ÄúDefault terms used‚Äù.
- Snapshot not found / unauthorized ‚Üí show error and provide navigation back to estimate list or estimate screen.

---

# 6. Functional Behavior

## Triggers
- User clicks/taps **Customer Summary** on a Draft estimate (from `EstimateEdit`).
- User opens `EstimateSummaryReview` directly (deep link).

## UI actions
- Disable the trigger action while request is in-flight; prevent double-submit by:
  - generating a UUID `Idempotency-Key` per user attempt and reusing it on retry for the same attempt (DECISION-INVENTORY-012).
- After successful generation:
  - Navigate to summary review screen with `estimateId` and `snapshotId`.
- On summary review screen:
  - Show loading state while fetching snapshot.
  - Render snapshot data without client-side recalculation.

## State changes
- Estimate status does **not** change (remains DRAFT).
- Backend creates an immutable snapshot record (append-only semantics for snapshots; no updates from UI).

## Service interactions
- Generate snapshot (mutation; idempotent):
  - `POST` generate endpoint/service (see Service Contracts).
- Load snapshot (read-only):
  - `GET` snapshot endpoint/service.
- Optional: if backend returns a `downloadUrl` for PDF, UI uses it for download action (no PDF generation in UI).

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Summary generation is allowed **only** when estimate status is `DRAFT`.
  - UI should hide/disable action when status != `DRAFT`, but server is authoritative.
- Snapshot totals are authoritative:
  - UI must display `subtotal`, `taxTotal`, `feesTotal` (if present), and `grandTotal` exactly as provided by snapshot.
  - UI must not recompute totals from line items.

## Enable/disable rules
- ‚ÄúCustomer Summary‚Äù action:
  - Enabled when estimate status == `DRAFT` AND user has capability to view estimate summary.
  - Disabled otherwise; if accessed via deep link, show error based on server response.

## Visibility rules
- Customer summary must not display internal-only fields (cost/margin, internal notes) unless explicitly allowed by capability flags.
- Preferred enforcement: backend returns a customer-facing DTO with internal fields omitted.
- Defense-in-depth: if payload includes `visibility` flags, UI must still hide restricted fields.

## Error messaging expectations (mapped from standard error envelope)
- Invalid status (409 / code `INVALID_STATE`): ‚ÄúSummary can only be generated for Draft estimates.‚Äù
- Missing legal terms with FAIL (409 / code `MISSING_LEGAL_TERMS`): ‚ÄúCannot generate estimate summary: Legal terms and conditions not configured.‚Äù
- Forbidden (403): ‚ÄúYou don‚Äôt have access to this estimate.‚Äù
- Not found (404): ‚ÄúEstimate not found.‚Äù
- Generic (5xx): ‚ÄúUnable to generate summary. Please try again or contact support.‚Äù Include `correlationId` in a ‚ÄúDetails‚Äù affordance if available.

---

# 8. Data Requirements

## Entities involved
> Note: Entity names for estimate/snapshot are not provided in the workexec domain guide; treat these as UI-facing concepts until confirmed in Moqui entities/services.

- Estimate (workexec-owned estimate lifecycle per approval workflow)
- Estimate line items (services/parts/labor lines)
- Estimate Summary Snapshot (immutable, append-only)
- Legal terms/disclaimer configuration (source may be location/customer config; surfaced via snapshot)
- Capability/visibility signals (DECISION-INVENTORY-013)

## Fields (type, required, defaults)

### Identifiers
- All IDs are **opaque strings**; UI must not validate UUID/numeric formats (DECISION-INVENTORY-003).

### Estimate (read-only in this story)
- `estimateId` (id string; required)
- `statusId` (string enum; required): `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`
- `currencyUomId` (string; required if money values are not already formatted)
- `locationId` (id string; optional but recommended for terms/timezone context)
- `updatedDate` (datetime; optional; for display only)

### EstimateLine (read-only)
- `lineId` (id string; required)
- `lineType` (string enum; required): `SERVICE` | `PART` | `LABOR` (exact values TBD)
- `description` (string; required)
- `quantity` (decimal; required)
- `uomId` (string; optional)
- `unitPrice` (money object or decimal; required)
- `lineTotal` (money object or decimal; required)
- Optional customer-facing fields:
  - `notesForCustomer` (string; optional)
- Internal-only fields (must be absent or hidden):
  - `internalNotes` (string; optional)
  - `itemCost` (money; optional)
  - `marginPercent` (decimal; optional)

### EstimateSummarySnapshot (read-only)
- `snapshotId` (id string; required)
- `estimateId` (id string; required)
- `snapshotAt` (datetime; required; stored in UTC, displayed in user timezone per DECISION-INVENTORY-016)
- `generatedByUserId` (id string; required)
- `policyMode` (string enum; required): `FAIL` | `USE_DEFAULTS`
- `legalTermsSource` (string enum; required): `CONFIGURED` | `DEFAULT`
- `legalTermsVersion` (string; optional)
- `legalTermsText` (string; required for customer summary rendering)
- `expirationAt` (datetime; optional; if present, display with timezone label)
- Totals (authoritative; required unless explicitly unsupported):
  - `subtotal`
  - `taxTotal`
  - `feesTotal` (optional; default display 0 only if provided as 0 by backend)
  - `grandTotal`
- `lines[]` (array of customer-facing line DTOs; required unless backend supports ‚Äúrender-only‚Äù mode)
- Optional rendering fields:
  - `renderFormat` (`DATA` | `HTML` | `PDF`; optional)
  - `downloadUrl` (string URL; optional)
  - `printHtml` (string; optional; if server-rendered HTML is provided)

### Capability signals (read-only)
- `capabilities` object (optional but recommended):
  - `canViewEstimateSummary` (boolean)
  - `canViewInternalCostFields` (boolean; should be false for customer summary)
  - `canProceedToApproval` (boolean)

## Read-only vs editable by state/role
- All fields in this story are **read-only**.
- No edits to estimate items, terms, totals, or snapshot from summary view.

## Derived/calculated fields
- UI may derive display-only formatting:
  - currency formatting and locale formatting
  - timezone display conversion (user timezone)
- UI must not derive financial totals.

---

# 9. Service Contracts (Frontend Perspective)

> This story is blocked until the concrete Moqui service names / REST paths are confirmed. The contracts below define required behaviors and error semantics.

## Load/view calls

1. **Load Estimate (guard + header)**
   - `GET /api/estimates/{estimateId}`
   - Response includes at least: `estimateId`, `statusId`, `currencyUomId`, optional `locationId`
   - Errors: 403/404 in standard envelope

2. **Fetch Summary Snapshot**
   - Option A: `GET /api/estimates/{estimateId}/summary-snapshots/{snapshotId}`
   - Option B: `GET /api/estimate-summary-snapshots/{snapshotId}`
   - Response: `EstimateSummarySnapshot` DTO (customer-facing)
   - Errors: 403/404 in standard envelope

## Create/update calls

1. **Generate Summary Snapshot (idempotent)**
   - `POST /api/estimates/{estimateId}/summary-snapshots:generate`
   - Headers:
     - `Idempotency-Key: <uuid>` (required) (DECISION-INVENTORY-012)
   - Request body: empty `{}` (server derives user from auth; do not send userId unless required by existing backend)
   - Success:
     - `201 Created` (preferred) or `200 OK` if idempotent replay
     - Response includes `snapshotId` and optionally inline snapshot DTO
   - Errors:
     - `409 INVALID_STATE` if estimate not DRAFT
     - `409 MISSING_LEGAL_TERMS` if policy FAIL and terms missing
     - `400` with `fieldErrors[]` for malformed requests (rare)
     - `403/404/5xx` as standard

## Submit/transition calls
- None in this story.
- ‚ÄúProceed to Approval‚Äù is navigation only; any approval submission service is out-of-scope.

## Error handling expectations
- All non-2xx responses return the standard error envelope (DECISION-INVENTORY-011):
  - `code` (string)
  - `message` (string)
  - `correlationId` (string)
  - `fieldErrors[]` (optional: `{field, message}`)
- UI must surface `correlationId` in an expandable ‚ÄúTechnical details‚Äù section for support.

---

# 10. State Model & Transitions

## Allowed states (Estimate)
- `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED` (per Customer Approval Workflow)

## Role-based transitions
- This story performs **no** estimate status transitions.
- Snapshot generation is a **mutation** but does not change estimate status.

## UI behavior per state
- `DRAFT`: show ‚ÄúCustomer Summary‚Äù action enabled (if capability allows).
- `APPROVED` / `DECLINED` / `EXPIRED`: hide or disable action; deep link to generate returns 409 and UI shows invalid-state message.

---

# 11. Alternate / Error Flows

## Validation failures
- Not DRAFT:
  - Generate endpoint returns 409; UI shows ‚ÄúSummary can only be generated for Draft estimates.‚Äù and stays on estimate screen.
- Missing legal terms:
  - FAIL: 409; UI shows compliance-block message; no navigation.
  - USE_DEFAULTS: 201/200; UI shows banner ‚ÄúDefault terms used‚Äù based on `legalTermsSource=DEFAULT`.

## Concurrency conflicts
- If estimate changes between viewing and generating:
  - Snapshot captures at generation time; UI displays `snapshotAt`.
  - If backend enforces optimistic locking and returns 409 `CONFLICT`:
    - UI shows ‚ÄúEstimate changed; please retry.‚Äù and offers retry (reusing same Idempotency-Key only if retrying same attempt; otherwise generate a new key).

## Unauthorized access
- 403:
  - UI shows access denied and provides navigation back to estimate list.

## Empty states
- If snapshot contains `lines=[]`:
  - UI displays ‚ÄúNo line items‚Äù and still shows totals/terms if provided.
- If backend blocks generation for zero items:
  - UI shows backend error message (must be explicit via `code`, e.g., `NO_LINE_ITEMS`).

---

# 12. Acceptance Criteria

## Scenario 1: Generate summary from Draft estimate (success)
Given I am authenticated as a Service Advisor  
And an Estimate exists with status `DRAFT` and at least one line item  
When I click ‚ÄúCustomer Summary‚Äù on the estimate  
Then the system creates an immutable estimate summary snapshot  
And the response includes a `snapshotId`  
And I am shown a read-only customer-facing summary based on that snapshot  
And the displayed `grandTotal` equals the snapshot‚Äôs `grandTotal`  
And the summary shows the snapshot timestamp (`snapshotAt`) in my user timezone with a timezone label.

## Scenario 2: Idempotent generate prevents duplicates on retry/double-click
Given I am authenticated as a Service Advisor  
And an Estimate exists with status `DRAFT`  
When I click ‚ÄúCustomer Summary‚Äù twice quickly  
Then the UI sends the same `Idempotency-Key` for the same in-flight attempt  
And the system returns a single snapshot outcome (same `snapshotId`)  
And the UI navigates to the summary review screen once.

## Scenario 3: Restricted internal fields are not shown
Given I am authenticated as a Service Advisor  
And the snapshot payload contains internal cost/margin fields or visibility flags indicating they are restricted  
When I view the customer-facing summary  
Then the summary does not display internal-only fields (e.g., itemCost, marginPercent, internalNotes)  
And there is no UI control that reveals those fields.

## Scenario 4: Invalid estimate status blocks generation
Given I am authenticated  
And an Estimate exists with status `APPROVED`  
When I attempt to generate a customer summary for that estimate  
Then the system responds with `409` and error code `INVALID_STATE`  
And the UI displays ‚ÄúSummary can only be generated for Draft estimates.‚Äù  
And the UI does not navigate to the summary review screen.

## Scenario 5: Missing legal terms with FAIL policy blocks generation
Given I am authenticated as a Service Advisor  
And an Estimate exists with status `DRAFT`  
And the system policy mode is `FAIL`  
And legal terms are not configured for the applicable context  
When I generate the customer-facing summary  
Then the system responds with `409` and error code `MISSING_LEGAL_TERMS`  
And the UI displays ‚ÄúCannot generate estimate summary: Legal terms and conditions not configured‚Äù  
And the UI does not navigate to a summary view.

## Scenario 6: Missing legal terms with USE_DEFAULTS allows generation (with indication)
Given I am authenticated as a Service Advisor  
And an Estimate exists with status `DRAFT`  
And the system policy mode is `USE_DEFAULTS`  
And legal terms are not configured for the applicable context  
When I generate the customer-facing summary  
Then the system generates the summary using default legal terms  
And the snapshot response includes `legalTermsSource = DEFAULT`  
And the UI displays a non-blocking banner indicating default terms were used.

## Scenario 7: Snapshot not found
Given I am authenticated as a Service Advisor  
When I open the summary review screen with a `snapshotId` that does not exist or is not accessible  
Then the system responds with `404`  
And the UI displays ‚ÄúEstimate summary not found.‚Äù  
And the UI provides a link back to the estimate.

---

# 13. Audit & Observability

## User-visible audit data
- Summary view displays (read-only):
  - `snapshotId`
  - `snapshotAt`
  - `legalTermsSource` and `legalTermsVersion` (if present)
- If an error occurs, UI shows `correlationId` in a details section.

## Status history
- No estimate status changes in this story.
- Snapshot creation is an auditable event; if an audit/history endpoint exists, it should show ‚ÄúEstimateSummaryGenerated‚Äù with who/when.

## Traceability expectations
- UI includes `Idempotency-Key` on generate calls (DECISION-INVENTORY-012).
- UI logs client-side errors with:
  - `estimateId`, `snapshotId` (if known), HTTP status, `code`, `correlationId`.

---

# 14. Non-Functional UI Requirements

- **Performance:** Show loading state; if generation exceeds 2 seconds, show ‚ÄúGenerating summary‚Ä¶‚Äù with spinner; allow retry on failure.
- **Accessibility:** Keyboard accessible actions; summary content readable by screen readers; print/download controls have accessible labels.
- **Responsiveness:** Summary view usable on tablet and desktop; print layout must not clip totals/terms.
- **i18n/timezone/currency:**
  - Display timestamps in **user timezone** and label timezone (DECISION-INVENTORY-016).
  - Money formatting uses `currencyUomId` and locale; do not change numeric values.
  - If backend provides pre-formatted strings, display them as-is.

---

# 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a standard empty-state message on summary screen when `lines=[]`; qualifies as safe because it does not change domain behavior, only presentation. Impacted sections: UX Summary, Alternate/Empty States.
- SD-UX-LOADING-STATE: Standard in-flight disabling and spinner for generate action; qualifies as safe because it‚Äôs UI ergonomics only. Impacted sections: Functional Behavior, Non-Functional.
- SD-ERR-HTTP-MAP: Map 403/404/409/5xx to standard error UI patterns using the standard error envelope; qualifies as safe because it‚Äôs generic error handling aligned to workspace conventions. Impacted sections: Service Contracts, Error Flows.

---

# 16. Open Questions

1. **Moqui screen alignment:** Is `EstimateEdit.xml` the correct existing screen for estimate detail/edit in this repo (per DECISION-INVENTORY-002), and what is the canonical menu path/URL parameters used today?  
2. **Concrete service/endpoint names:** What are the exact Moqui service names and/or REST paths for:
   - generating an estimate summary snapshot (mutation)
   - fetching a snapshot by `snapshotId` (read-only)  
3. **Snapshot DTO shape:** Will backend return a customer-facing structured DTO (`lines[]`, totals, terms) or only a rendered artifact (HTML/PDF URL)? If rendered-only, what is the print/download mechanism and content-type handling?  
4. **Legal terms policy source:** Where does `policyMode` come from (location/customer/default config), and is it only returned in the generate response or also queryable?  
5. **Visibility enforcement contract:** Will backend omit restricted fields entirely, or include them with visibility flags? If flags, what is the exact schema?  
6. **Fees/taxes breakdown:** Are fees represented separately from taxes in the estimate/snapshot contract? If yes, is a line-level breakdown required in the customer summary or totals-only is sufficient?  
7. **Expiration semantics:** Is `expirationAt` stored on the estimate, derived at snapshot generation time, or both? Which timezone should be used for the displayed expiration (user timezone display is fine, but confirm the source timezone/meaning)?  
8. **Zero-line estimates:** Should generation be allowed when there are zero line items, or must backend return a validation error (e.g., `NO_LINE_ITEMS`)?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #233: [FRONTEND] [STORY] Approval: Submit Estimate for Customer Approval
LABELS: domain:workexec,frontend,story-implementation,user,type:story,status:draft,blocked:clarification,risk:incomplete-requirements
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Approval: Submit Estimate for Customer Approval

### Primary Persona
Service Advisor

### Business Value
Enables a Service Advisor to formally submit a completed draft estimate for customer consent, producing an immutable approval snapshot and auditable submission record to support downstream approval workflows and compliance.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to submit a draft estimate for customer approval  
- **So that** the estimate is validated, moved into a pending-approval state, and an immutable approval snapshot + approval request payload are created for customer consent processing.

### In Scope
- Frontend action to submit an estimate for customer approval.
- Frontend-driven validation display (field/section-level errors) based on backend response.
- Moqui screen flow for:
  - Loading an estimate
  - Confirming submission
  - Executing submit service
  - Showing resulting status + approval request reference
- Audit visibility requirements (who/when) as read-only UI fields (if returned by backend).

### Out of Scope
- Customer-facing approval experience (signature capture, external links, customer portal).
- Editing estimate line items/taxes/terms (assumed handled in other stories).
- Notification delivery (email/SMS) and token/link distribution.
- Defining estimate completeness policy (requires clarification; see Open Questions).

---

## 3. Actors & Stakeholders

- **Service Advisor (Primary Actor):** initiates submission.
- **Customer (Stakeholder):** recipient of approval request (not interacting in this story).
- **Audit/Compliance (Stakeholder):** requires immutable snapshot and audit trail.
- **Backend workexec services (System):** enforce completeness checks, state transition, snapshot creation, approval payload generation.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS UI.
- Estimate exists and is retrievable by `estimateId`.
- Estimate is currently in a submit-eligible state (intended: `DRAFT`; see State Model section).

### Dependencies
- Backend endpoint/service to submit estimate for approval (not explicitly provided in inputs; required).
- Backend must return:
  - Updated estimate status (e.g., `PENDING_APPROVAL`)
  - Snapshot reference (e.g., `snapshotId` and/or `snapshotVersion`)
  - Approval request reference (e.g., `approvalRequestId`, approval method, consent text if needed)
- Backend completeness validation rules and error schema (required for actionable UI errors).

---

## 5. UX Summary (Moqui-Oriented)

### Entry Points
- From an Estimate detail screen (viewing a single estimate), a primary action button: **‚ÄúSubmit for Approval‚Äù** visible only when estimate is submit-eligible.

### Screens to Create/Modify
- **Modify:** `EstimateDetail` screen (or equivalent existing estimate view screen)
  - Add ‚ÄúSubmit for Approval‚Äù action
  - Add read-only fields/section for approval metadata after submission (status, submittedBy/submittedDate if available, approvalRequestId, snapshotVersion)
- **Create (if not existing):** `EstimateSubmitConfirm` dialog/screen (can be a modal)
  - Shows irreversible action confirmation + key summary fields (estimate id, total, customer, method if known)
  - ‚ÄúConfirm Submit‚Äù / ‚ÄúCancel‚Äù

### Navigation Context
- Route pattern (proposed; adjust to repo conventions):  
  - `#/estimates/:estimateId` ‚Üí Estimate Detail  
  - Submission stays on detail screen and refreshes state after successful submit.

### User Workflows
#### Happy Path
1. Service Advisor opens Estimate Detail (status `DRAFT`).
2. Clicks **Submit for Approval**.
3. Confirm modal opens; user confirms.
4. UI calls submit service; shows loading.
5. On success: status updates to `PENDING_APPROVAL`, submission metadata appears, submit button disabled/hidden.

#### Alternate Paths
- If estimate already pending approval: button hidden/disabled; if attempted via deep link/action, show non-blocking info message and refresh.
- If backend returns completeness errors: remain in `DRAFT`, show actionable errors (grouped).
- If backend returns conflict (e.g., already submitted by another user): refresh estimate and show latest status.

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúSubmit for Approval‚Äù on an estimate in `DRAFT`.

### UI Actions
- Open confirmation UI requiring explicit user confirmation.
- Execute submit request.
- After response:
  - Refresh estimate data (either from submit response payload or via re-load call).
  - Update UI state (status banner, disable actions, display approval request references).
  - Show toast/inline confirmation message: ‚ÄúSubmitted for customer approval.‚Äù

### State Changes (Frontend)
- Frontend state is derived from backend estimate status.
- Submit action becomes unavailable when status is not `DRAFT`.

### Service Interactions
- `loadEstimate(estimateId)` on screen entry.
- `submitEstimateForApproval(estimateId, submittedByUserId?)` on confirmation.
- Optional: `loadApprovalRequest(approvalRequestId)` if approval details are not embedded in estimate response.

---

## 7. Business Rules (Translated to UI Behavior)

> Note: Business rules for ‚Äúcompleteness‚Äù are explicitly *unclear* in provided inputs beyond examples; frontend must rely on backend to be source of truth and return a structured error list.

### Validation
- Frontend must not attempt to replicate completeness logic beyond basic ‚Äúmust have estimateId loaded‚Äù gating.
- On submit:
  - If backend rejects due to completeness, UI must display:
    - A summary message: ‚ÄúEstimate is not complete. Fix the items below before submitting.‚Äù
    - A list of specific issues as returned (field/section + message).

### Enable/Disable Rules
- ‚ÄúSubmit for Approval‚Äù visible/enabled only when:
  - Estimate is loaded
  - Estimate status is `DRAFT`
  - User has permission to submit (permission name unknown ‚Üí Open Question)

### Visibility Rules
- Approval metadata section visible when estimate status is `PENDING_APPROVAL` (or equivalent).
- Snapshot reference visible once created.

### Error Messaging Expectations
- 400 validation: show actionable list; do not log sensitive info (e.g., customer contact) in UI errors.
- 409 conflict: ‚ÄúThis estimate was updated or submitted by another user. Reloading latest state.‚Äù
- 403 forbidden: ‚ÄúYou do not have permission to submit estimates for approval.‚Äù
- 404 not found: ‚ÄúEstimate not found.‚Äù

---

## 8. Data Requirements

### Entities Involved (Frontend View)
- **Estimate**
- **ApprovalRequest**
- **ApprovalSnapshot** (or `EstimateSnapshot`)
- **AuditEvent** (read-only; if exposed)
  
> Exact entity names in Moqui may differ; map to backend payload fields.

### Fields (Type / Required / Defaults)
#### Estimate (minimum fields needed by UI)
- `estimateId` (string/number, required)
- `status` (enum string, required)
- `customerId` (string/number, required for submission eligibility but enforced by backend)
- `shopId/locationId` (string/number, optional for display)
- `totalAmount` (decimal, optional but recommended for confirmation display)
- `currencyUomId` (string, optional)
- `submittedBy` (string/number, optional; backend-provided)
- `submittedDate` (datetime, optional; backend-provided)
- `approvalMethod` (enum string, optional; backend-provided or derived from configuration)
- `approvalRequestId` (string/number, optional; populated post-submit)
- `snapshotVersion` (integer, optional; populated post-submit)
- `snapshotId` (string/number, optional; populated post-submit)

#### ApprovalRequest (if separately loaded)
- `approvalRequestId` (required)
- `status` (enum, optional)
- `consentText` (string, optional)
- `approvalToken` / `approvalLink` (sensitive; **must not** be displayed unless explicitly required‚ÄîOpen Question)

### Read-only vs Editable
- All approval-related fields are read-only in frontend for this story.
- Estimate becomes non-editable in this flow once `PENDING_APPROVAL` (edit behavior may belong to a different story).

### Derived/Calculated
- None in frontend; totals displayed as returned.

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not fully defined in provided inputs for ‚Äúsubmit for approval‚Äù for estimates (workexec guide lists approval capture endpoints but not ‚Äúsubmit‚Äù). This story therefore requires clarification and/or alignment with backend issue #168.

### Load / View Calls
- `GET /api/estimates/{id}`  
  **Response:** Estimate with status and approval-related references if present.

### Submit / Transition Calls (Required)
- **Proposed:** `POST /api/estimates/{id}/submit-for-approval`  
  **Request:** `{ submittedBy: <userId>, reason?: <string> }` (reason optional; not specified)  
  **Response (200/201):** updated estimate + `approvalRequestId` + `snapshotId`/`snapshotVersion`

> If backend instead uses Moqui service name invocation, the frontend Moqui screen transition should call a Moqui service like `workexec.EstimateSubmitForApproval` and return the same fields.

### Error Handling Expectations
- `400 Bad Request`: completeness validation failures with structured list:
  - `errors: [{ code, field, message }]`
- `409 Conflict`: optimistic concurrency / already submitted
- `403 Forbidden`: permission denial
- `404 Not Found`: unknown estimateId
- `500`: show generic error ‚ÄúCould not submit estimate. Try again.‚Äù

---

## 10. State Model & Transitions

### Allowed States (Estimate)
Provided authoritative states in `CUSTOMER_APPROVAL_WORKFLOW.md` are: `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`.

However, this frontend story requires a `PendingApproval` state, which conflicts with that document unless ‚ÄúPendingApproval‚Äù is an additional internal state not documented there.

### Required Transition (Story)
- `DRAFT` ‚Üí `PENDING_APPROVAL` (or equivalent) on submit.

### Role-based Transitions
- Service Advisor can initiate submit transition (permission details unknown ‚Üí Open Question).

### UI Behavior per State
- `DRAFT`: show Submit button.
- `PENDING_APPROVAL`: hide/disable submit, show submission metadata and approval request reference.
- Other states: submit unavailable; show read-only status.

**Conflict Note:** Since estimate states are inconsistent across provided references, implementation must be blocked until canonical state enum is confirmed.

---

## 11. Alternate / Error Flows

### Validation Failures (Completeness)
- Backend returns 400 with list of missing/invalid elements (taxes, items, terms, totals).
- UI displays list; keeps estimate in `DRAFT`; no snapshot created.

### Duplicate Submission
- If estimate already pending approval:
  - Backend returns 409 or 400; UI shows ‚ÄúAlready submitted‚Äù and refreshes.
  - UI must not create duplicate submission attempts (disable button while request in-flight).

### Concurrency Conflicts
- Another user submits while current user has page open.
- On submit: backend returns 409; UI refreshes estimate and shows updated status.

### Unauthorized Access
- 403: show message and do not alter local state.

### Empty States
- If estimate loads but missing required display fields, UI still renders with placeholders and relies on backend for submission eligibility.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Successful submission from Draft
**Given** I am a Service Advisor viewing an estimate with status `DRAFT`  
**When** I click ‚ÄúSubmit for Approval‚Äù and confirm submission  
**Then** the system sends a submit request for that estimate  
**And** the estimate status is updated to `PENDING_APPROVAL` (or the configured pending-approval equivalent)  
**And** the UI displays a reference to the created approval snapshot (snapshot id and/or version)  
**And** the UI displays a reference to the created approval request (approvalRequestId)  
**And** the ‚ÄúSubmit for Approval‚Äù action is no longer available.

### Scenario 2: Submission blocked due to completeness validation
**Given** I am viewing an estimate with status `DRAFT`  
**And** the estimate is incomplete per backend completeness rules  
**When** I attempt to submit for approval  
**Then** the system rejects the submission with validation errors  
**And** the estimate remains in `DRAFT`  
**And** the UI displays an actionable list of validation errors returned by the backend.

### Scenario 3: Prevent re-submitting an already pending approval estimate
**Given** I am viewing an estimate with status `PENDING_APPROVAL` (or equivalent)  
**When** I attempt to submit for approval  
**Then** the UI prevents the action (button hidden/disabled)  
**And** if a request is still made (e.g., via direct call), the UI shows an ‚ÄúAlready submitted‚Äù message  
**And** the estimate status remains unchanged.

### Scenario 4: Concurrency conflict on submit
**Given** I am viewing an estimate that was `DRAFT` when loaded  
**And** another user submits the estimate for approval before I do  
**When** I submit for approval  
**Then** the backend responds with a conflict (409)  
**And** the UI reloads the estimate  
**And** the UI displays the current estimate status and indicates it was updated elsewhere.

### Scenario 5: Unauthorized user cannot submit
**Given** I am logged in without permission to submit estimates for approval  
**When** I attempt to submit a `DRAFT` estimate for approval  
**Then** the backend responds with 403  
**And** the UI shows an authorization error  
**And** the estimate remains unchanged.

---

## 13. Audit & Observability

### User-visible audit data
- Display (if available from backend):
  - `submittedBy`
  - `submittedDate` (UTC displayed in user‚Äôs locale)
  - `snapshotVersion` / `snapshotId`
  - `approvalRequestId`

### Status history
- If an endpoint exists to fetch estimate history, link to it; otherwise out of scope.

### Traceability expectations
- Frontend must include correlation/request ID support per project convention (if already present) and ensure submit action logs include `estimateId` (no PII).

---

## 14. Non-Functional UI Requirements

- **Performance:** Submit action should show immediate loading state; avoid duplicate submissions (disable confirm button while in-flight).
- **Accessibility:** Confirmation dialog must be keyboard-navigable; errors must be announced via ARIA-friendly mechanism provided by Quasar.
- **Responsiveness:** Works on tablet and desktop layouts used in POS.
- **i18n/timezone/currency:** Display money using `currencyUomId` if provided; timestamps rendered in local timezone; do not assume currency formatting rules beyond existing app utilities.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a generic empty/error placeholder when approval metadata is absent; safe because it affects only presentation and not business logic. (Impacted: UX Summary, Error Flows)
- SD-UX-INFLIGHT-GUARD: Disable submit/confirm controls while request is pending to prevent duplicate submissions; safe because it is UI-only idempotency support. (Impacted: Functional Behavior, Error Flows)
- SD-ERR-HTTP-MAP: Map common HTTP status codes (400/403/404/409/500) to user-friendly messages; safe because it does not change domain policy and relies on backend as SoR. (Impacted: Business Rules, Error Flows, Acceptance Criteria)

---

## 16. Open Questions

1. **Canonical Estimate State Model:** What are the official estimate statuses in this system for ‚Äúpending customer approval‚Äù? The provided `CUSTOMER_APPROVAL_WORKFLOW.md` lists only `DRAFT/APPROVED/DECLINED/EXPIRED`, but this story requires `PENDING_APPROVAL`. What is the correct enum value and transition?
2. **Backend Submit Endpoint / Moqui Service Contract:** What is the exact API endpoint (or Moqui service name) to ‚Äúsubmit estimate for approval‚Äù, and what request/response schema should the frontend use?
3. **Completeness Checklist:** What are the exact completeness requirements enforced at submission time (required fields/items/taxes/totals/terms)? Provide the backend error codes/fields so the frontend can render targeted messages.
4. **Permissions/RBAC:** What permission(s) gate the ‚ÄúSubmit for Approval‚Äù action (role name or permission ID)? Should the UI hide the button or show it disabled with an explanation?
5. **Approval Method & Consent Text Display:** Should the Service Advisor see the selected approval method and consent text at submission time? If yes, should consent text be previewed in the confirm dialog?
6. **Approval Token/Link Sensitivity:** Will the backend return an approval token/link in the submission response? If yes, is the Service Advisor allowed to view/copy it in POS, or must it remain hidden for security?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Approval: Submit Estimate for Customer Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/233  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Approval: Submit Estimate for Customer Approval

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor

## Trigger
A Draft estimate is complete and ready for customer consent.

## Main Flow
1. User selects 'Submit for Approval'.
2. System validates estimate completeness (required fields, items, taxes, totals, terms).
3. System transitions estimate to PendingApproval and freezes an approval snapshot.
4. System generates an approval request payload (method, link/token, consent text).
5. System logs the submission event for audit.

## Alternate / Error Flows
- Validation fails (missing taxes, missing items) ‚Üí block and show actionable errors.
- Estimate already pending approval ‚Üí prevent duplicate submissions and show status.

## Business Rules
- Only submit-ready estimates may enter PendingApproval.
- Submission creates an immutable approval snapshot version.
- Submission must be auditable (who/when).

## Data Requirements
- Entities: Estimate, ApprovalRequest, ApprovalSnapshot, AuditEvent
- Fields: status, approvalRequestId, snapshotVersion, consentText, submittedBy, submittedDate, approvalMethod

## Acceptance Criteria
- [ ] System blocks submission when required completeness checks fail.
- [ ] PendingApproval state is set and visible.
- [ ] An approval snapshot is created and referenced by the request.

## Notes for Agents
Approval snapshot must remain immutable; later revisions require resubmission.

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #229: [FRONTEND] [STORY] Promotion: Generate Workorder Items from Approved Scope
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Promotion: Generate Workorder Items from Approved Scope

### Primary Persona
Service Advisor (initiates promotion from an Approved Estimate)

### Business Value
Ensure that when an approved Estimate is promoted to a Work Order, the resulting Work Order Items are created deterministically from the approved scope with immutable pricing/tax snapshots and traceability, enabling execution, downstream invoicing, and variance explanations.

---

## 2. Story Intent

### As a / I want / So that
- **As a Service Advisor**, I want to promote an **Approved Estimate** into a **Work Order** from the POS frontend, **so that** the system generates **Work Order Items** from the approved scope with immutable snapshot fields and traceability for execution and invoicing.

### In-scope
- Moqui UI flow to initiate ‚ÄúPromote Estimate to Work Order‚Äù from the estimate screen.
- Status-gated availability of the Promote action (only when estimate is `APPROVED`).
- Frontend idempotency behavior for the promotion mutation (send `Idempotency-Key`, reuse on retry).
- Frontend handling of:
  - success ‚Üí navigate to created Work Order screen
  - non-blocking warnings (e.g., items flagged `requiresReview`)
  - blocking failures (invalid state, missing tax config, totals mismatch, unauthorized)
- Read-only display of generated Work Order Items including snapshot/traceability fields returned by backend.
- Standard error envelope parsing and correlationId display (copyable).

### Out-of-scope
- Backend promotion logic, tax calculation, pricing calculation, catalog validation rules (backend responsibility).
- Editing Work Order Items post-promotion (including manual price entry).
- Work order execution transitions (start/in-progress/etc.) beyond viewing the created items.
- Notifications (email/SMS) and customer approval capture.
- Configuration screens for tax/location setup.

---

## 3. Actors & Stakeholders
- **Service Advisor (primary user):** initiates promotion and reviews resulting work order/items.
- **Technician (downstream):** executes authorized items created by promotion.
- **Billing/Accounting (downstream):** invoices using snapshotted amounts and traceability.
- **Audit/Compliance (stakeholder):** expects immutable traceability and correlation IDs for support.

---

## 4. Preconditions & Dependencies

### Preconditions
- Estimate exists and is in status `APPROVED` (per `CUSTOMER_APPROVAL_WORKFLOW.md`).
- User is authenticated.
- User has capability/permission to promote estimates (capability signaling preferred; backend authoritative with 403 per DECISION-INVENTORY-013).

### Dependencies
- **Moqui screens (canonical):**
  - Estimate screen: `durion-workexec/EstimateEdit.xml` (DECISION-INVENTORY-002)
  - Work order screen: `durion-workexec/WorkOrderEdit.xml` (DECISION-INVENTORY-002)
- Backend endpoints to:
  - load estimate
  - promote estimate ‚Üí create work order + items
  - load work order (and items if not embedded)
- Standard error envelope with `correlationId` (DECISION-INVENTORY-011).
- Idempotency-Key support for mutation (DECISION-INVENTORY-012).

### External/System dependencies
- Tax configuration must be valid for the estimate context; if missing/invalid, promotion must fail atomically (no partial work order).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From `durion-workexec/EstimateEdit` when estimate status is `APPROVED`, show primary action **Promote to Work Order**.

### Screens to create/modify
1. **Modify**: `durion-workexec/EstimateEdit.xml`
   - Add Promote action (button) gated by estimate status and capability.
   - Add confirmation dialog (if project uses confirmations for destructive/irreversible actions).
2. **Modify**: `durion-workexec/WorkOrderEdit.xml`
   - Ensure it can display:
     - Work order header with `originEstimateId`
     - Work order items list with `requiresReview` indicator
     - Read-only traceability fields (at least `originEstimateItemId`)
3. **Optional (component reuse)**: shared error dialog/banner component that can render standard error envelope and show `correlationId` copy action.

### Navigation context
- `EstimateEdit` ‚Üí Promote ‚Üí on success navigate to `WorkOrderEdit` for returned `workOrderId`.
- On failure remain on `EstimateEdit` and show blocking error.

### User workflows (happy + alternate)

#### Happy path
1. Service Advisor opens an approved estimate in `EstimateEdit`.
2. Clicks **Promote to Work Order**.
3. Frontend sends promotion request with `Idempotency-Key`.
4. On success, frontend navigates to `WorkOrderEdit` for the created work order.
5. Work order items render with snapshot fields and traceability.

#### Alternate paths
- Promotion succeeds but some items have `requiresReview=true` ‚Üí show non-blocking warning banner and per-item indicator.
- Promotion fails due to missing tax configuration ‚Üí show blocking error; remain on estimate.
- Promotion fails due to totals mismatch ‚Üí show blocking error; remain on estimate.
- Promotion fails due to invalid estimate state (stale UI) ‚Üí show blocking error; refresh estimate data.
- Promotion request is retried (network timeout) ‚Üí reuse same `Idempotency-Key` and handle duplicate outcome deterministically.

---

## 6. Functional Behavior

### Triggers
- User clicks **Promote to Work Order** on `EstimateEdit` while estimate status is `APPROVED`.

### UI actions
- Disable Promote button and show in-progress indicator while request is in-flight.
- Generate an `Idempotency-Key` (UUID) at click time and store it for the duration of the attempt; reuse on retry for the same attempt (DECISION-INVENTORY-012).
- On success:
  - show a brief success toast/banner
  - navigate to `WorkOrderEdit` with returned `workOrderId`
- On failure:
  - show blocking error dialog/banner with reason-specific message
  - show `correlationId` (copyable) when present
  - re-enable Promote button

### State changes (frontend)
- No client-side lifecycle state machine; reflect backend state.
- After success, the work order becomes the primary displayed entity.
- Optionally refresh estimate after failure due to invalid state to reflect latest status.

### Service interactions
- Load estimate details on screen entry (or already loaded by `EstimateEdit`).
- Call promotion endpoint (mutation).
- Load work order details after promotion (if not returned in mutation response).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Client-side gating (non-authoritative):**
  - Promote action is enabled only when estimate status displayed is `APPROVED`.
  - Estimate ID must be present in route/context.
- **Server-side authoritative validation (UI must handle):**
  - If estimate is not promotable (state changed) ‚Üí show error and refresh estimate.
  - If tax configuration missing/invalid ‚Üí show blocking error; do not navigate.
  - If totals mismatch ‚Üí show blocking error; do not navigate.
  - If unauthorized ‚Üí show blocking error; do not navigate.

### Enable/disable rules
- Promote enabled when all are true:
  - estimate.status == `APPROVED`
  - user capability indicates promote allowed (if capability signal exists); otherwise show button and rely on 403 handling
  - no in-flight promotion request
- Promote disabled with explanation when estimate not approved.

### Visibility rules
- On `WorkOrderEdit`:
  - Show `originEstimateId` in header (read-only).
  - For each item:
    - show `requiresReview` indicator when true
    - show `originEstimateItemId` (read-only; can be in an ‚ÄúAdvanced/Traceability‚Äù section)
    - show snapshot amounts (unit/line/tax) as returned; do not recalculate.

### Error messaging expectations (standard envelope)
- Parse standard error envelope fields (DECISION-INVENTORY-011):
  - `code` (string)
  - `message` (string)
  - `correlationId` (string)
  - optional `fieldErrors[]` (field, message)
  - optional `existingResourceId` (for duplicates)
- Map known promotion failure codes to user-facing messages (exact codes are a blocking clarification; see Open Questions):
  - Missing/invalid tax config ‚Üí ‚ÄúPromotion blocked: tax configuration is missing or invalid for this estimate. Correct configuration and retry.‚Äù
  - Totals mismatch ‚Üí ‚ÄúPromotion failed: totals do not match. No work order was created.‚Äù
  - Invalid estimate state ‚Üí ‚ÄúPromotion failed: estimate is not in an approved/promotable state. Refresh and try again.‚Äù
  - Duplicate/already promoted ‚Üí ‚ÄúThis estimate was already promoted. Opening the existing work order.‚Äù (only if backend provides existing workOrderId)
  - Unknown ‚Üí ‚ÄúPromotion failed due to a system error. Try again or contact support.‚Äù + correlationId

---

## 8. Data Requirements

### Entities involved (frontend perspective; via backend responses)
- Workexec:
  - Estimate (workexec-owned UI; estimate lifecycle per provided workflow docs)
  - Work Order (`durion.workexec.DurWorkOrder`)
  - Work Order Items (entity name TBD in Moqui component; must include traceability + snapshot fields)
- Cross-domain (read-only dependencies):
  - Tax configuration (source not specified; treated as backend validation dependency)
  - Catalog/product (only for display; promotion may snapshot even if catalog item invalid)

### Fields (type, required, defaults)
> IDs are opaque strings (DECISION-INVENTORY-003). UI must not validate UUID/numeric formats.

**Estimate (read)**
- `estimateId` (id/string, required)
- `statusId` (string enum, required; includes `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED` per workflow doc)
- Totals (money, required for display):
  - `subtotal`
  - `taxTotal`
  - `grandTotal`

**Promotion response (mutation)**
- `workOrderId` (id/string, required)
- `originEstimateId` (id/string, required; should equal request estimateId)
- Optional:
  - `warnings[]` (array; includes at least ‚ÄúITEM_REQUIRES_REVIEW‚Äù with item identifiers)
  - `correlationId` (string) if not provided via header

**Work Order (read after promotion)**
- `workOrderId` (id/string, required)
- `originEstimateId` (id/string, required)
- `statusId` (string enum, required; workexec status taxonomy is separate; not modified here)
- Totals (money, required):
  - `subtotal`
  - `taxTotal`
  - `grandTotal`

**Work Order Item (read)**
- `workOrderItemId` (id/string, required)
- `workOrderId` (id/string, required)
- `originEstimateItemId` (id/string, required)
- `itemSeqId` (number/int, required)
- `itemTypeEnumId` (string enum, required; e.g., PART/LABOR/FEE ‚Äî exact enum values TBD)
- `description` (string, required)
- `productId` (id/string, nullable)
- `quantity` (decimal, required; UI must not assume integer-only)
- Snapshot pricing/tax (money/object, required):
  - `unitPrice`
  - `lineAmount` (or `totalPrice`) (money, required)
  - `taxSnapshot` (object/json, required; must include at least `taxAmount`; other fields TBD)
- `statusId` (string enum, required; initial expected `Authorized` per original story intent)
- `requiresReview` (boolean, required; default false)

### Read-only vs editable by state/role
- All fields in this story are read-only on the Work Order screen.
- No editing of items, pricing, or tax snapshots.

### Derived/calculated fields
- UI may compute display-only totals (sum of line amounts) for presentation, but must not override backend totals or recalculate tax.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui screen implementations may call services directly (service facade) or via REST. This story defines required behaviors; exact endpoint/service names are a blocking clarification unless already present in repo.

### Load/view calls
- Estimate load (already used by `EstimateEdit.xml`):
  - `GET /rest/api/v1/workexec/estimates/{estimateId}` (preferred namespace) **OR** existing Moqui service invoked by screen.
- Work order load (used by `WorkOrderEdit.xml`):
  - `GET /rest/api/v1/workexec/workorders/{workOrderId}` **OR** existing Moqui service invoked by screen.
- Work order items load (if not embedded in work order response):
  - `GET /rest/api/v1/workexec/workorders/{workOrderId}/items`

### Submit/transition calls (promotion mutation)
- **Required mutation** (choose one canonical contract; blocking until confirmed):
  - `POST /rest/api/v1/workexec/estimates/{estimateId}/promote`
  - Headers:
    - `Idempotency-Key: <uuid>` (required; DECISION-INVENTORY-012)
  - Request body: empty or `{}` (preferred) unless backend requires metadata.
  - Success:
    - `201 Created` (preferred) or `200 OK`
    - body includes `workOrderId`, `originEstimateId`, optional warnings
  - Failure:
    - `400` validation (invalid state, missing required config)
    - `403` unauthorized
    - `404` not found
    - `409` conflict (already promoted, totals mismatch, concurrency)
    - All failures return standard error envelope (DECISION-INVENTORY-011)

### Error handling expectations
- Frontend must normalize errors into the standard envelope shape even if Moqui returns different structures (DECISION-INVENTORY-011).
- If `existingResourceId` is present on duplicate/already-promoted:
  - treat as navigable workOrderId **only if** it is explicitly a workOrderId (blocking clarification; see Open Questions).
- Always surface `correlationId` in error UI when present.

---

## 10. State Model & Transitions

### Allowed states (relevant to this story)
- **Estimate**:
  - Must be `APPROVED` to promote.
- **Work Order Items**:
  - Created in initial status `Authorized` (exact status enum value must match backend; blocking clarification).

### Role-based transitions
- Promotion is initiated by Service Advisor.
- Backend enforces authorization; UI gates via capability signal when available (DECISION-INVENTORY-013) and handles 403.

### UI behavior per state
- Estimate `APPROVED`: show Promote enabled.
- Estimate not `APPROVED`: disable Promote with explanation.
- After promotion success: navigate to work order and show items; show warning banner if any `requiresReview=true`.

---

## 11. Alternate / Error Flows

### Validation failures (stale UI)
- If estimate status changed between load and click:
  - backend returns 400/409 with code indicating invalid state
  - UI shows blocking error and refreshes estimate

### Concurrency conflicts / already promoted
- If backend indicates already promoted:
  - If response includes existing workOrderId (or `existingResourceId` that is a workOrderId):
    - UI navigates to that work order and shows informational banner ‚ÄúOpened existing work order.‚Äù
  - Else:
    - UI shows blocking error ‚ÄúEstimate already promoted‚Äù and remains on estimate.

### Unauthorized access
- 403:
  - UI shows blocking ‚ÄúYou do not have permission to promote estimates.‚Äù
  - No navigation.

### Network/timeouts and retries
- If request times out or returns 5xx:
  - UI offers Retry
  - Retry must reuse the same `Idempotency-Key` for the same attempt (DECISION-INVENTORY-012)
  - UI must not create multiple work orders due to double-submit.

### Empty states
- If work order loads with zero items:
  - show standard empty state ‚ÄúNo authorized items were created from this estimate.‚Äù
  - This is UI-only; backend behavior not assumed.

### Partial warnings
- Promotion succeeds with `requiresReview` items:
  - show non-blocking warning banner and per-item indicator
  - no blocking modal required.

---

## 12. Acceptance Criteria

### Scenario 1: Promote approved estimate successfully and navigate to work order
**Given** I am signed in as a user with permission to promote estimates  
**And** I am viewing an Estimate in `durion-workexec/EstimateEdit` with status `APPROVED`  
**When** I click ‚ÄúPromote to Work Order‚Äù  
**Then** the UI sends a promotion request for that estimate including an `Idempotency-Key` header  
**And** the UI disables the Promote action while the request is in-flight  
**And** on success the UI navigates to `durion-workexec/WorkOrderEdit` for the returned `workOrderId`  
**And** the Work Order screen displays `originEstimateId` matching the promoted estimate.

### Scenario 2: Work order items display snapshot and traceability fields as read-only
**Given** a Work Order was created via promotion from an approved Estimate  
**When** I view the Work Order in `durion-workexec/WorkOrderEdit`  
**Then** each Work Order Item row displays read-only values for `quantity`, `unitPrice`, `taxSnapshot.taxAmount`, and `originEstimateItemId`  
**And** the UI does not allow editing these fields on this screen.

### Scenario 3: Promotion succeeds and flags items requiring review
**Given** an approved Estimate contains at least one line that will be flagged by the backend as requiring review  
**When** I promote the estimate  
**Then** the promotion succeeds and I am navigated to the created Work Order  
**And** the UI shows a non-blocking warning banner indicating some items require review  
**And** each flagged item is indicated in the items list via `requiresReview=true`.

### Scenario 4: Promotion fails due to missing/invalid tax configuration (blocking)
**Given** I am viewing an approved Estimate  
**And** the backend determines tax configuration is missing or invalid for promotion  
**When** I attempt to promote the estimate  
**Then** the backend responds with an error in the standard error envelope including `code` and `correlationId`  
**And** the UI shows a blocking error message indicating tax configuration must be corrected  
**And** the UI remains on the Estimate screen and re-enables the Promote action after dismissal  
**And** the UI displays the `correlationId` in the error details.

### Scenario 5: Promotion fails due to totals mismatch (atomic failure)
**Given** I am viewing an approved Estimate  
**And** the backend detects a totals mismatch during promotion  
**When** I attempt to promote the estimate  
**Then** the backend responds with an error in the standard error envelope  
**And** the UI shows a blocking error message indicating totals mismatch and that no work order was created  
**And** the UI remains on the Estimate screen.

### Scenario 6: Unauthorized promotion attempt
**Given** I am viewing an approved Estimate  
**And** my user lacks permission to promote estimates  
**When** I attempt to promote the estimate  
**Then** the backend responds with HTTP 403 and the standard error envelope  
**And** the UI shows a blocking ‚Äúnot authorized‚Äù message  
**And** the UI does not navigate to a Work Order screen.

### Scenario 7: Retry after transient failure reuses Idempotency-Key
**Given** I click ‚ÄúPromote to Work Order‚Äù and the request fails due to a network timeout  
**When** I click ‚ÄúRetry‚Äù for the same promotion attempt  
**Then** the UI re-sends the promotion request using the same `Idempotency-Key` value as the timed-out attempt  
**And** if the backend returns success on retry, the UI navigates to the created Work Order  
**And** if the backend returns a duplicate/already-processed outcome, the UI navigates to the existing Work Order when the ID is provided.

---

## 13. Audit & Observability

### User-visible audit data
- On success, display (at least in header or details):
  - `workOrderId`
  - `originEstimateId`
- On error, display:
  - `correlationId` (copyable) when present in envelope or response header.

### Status history
- Not implementing transition history UI in this story.
- If `WorkOrderEdit` already has a history/audit section, ensure navigation lands on the work order without losing access to it.

### Traceability expectations
- Work order header shows `originEstimateId`.
- Each item shows `originEstimateItemId`.
- UI must not hide these fields behind permissions unless required by security policy (not specified).

---

## 14. Non-Functional UI Requirements

### Performance
- Show in-progress indicator within 250ms of click.
- After success, navigate immediately; load work order details with standard loading skeletons.

### Accessibility
- Promote button is keyboard accessible.
- Disabled state includes accessible explanation (e.g., helper text).
- Error banner/dialog uses aria-live and supports keyboard dismissal.

### Responsiveness
- Items list usable on tablet widths; rows wrap/stack as needed.

### i18n/timezone/currency
- Currency formatting uses existing POS locale/currency configuration.
- If timestamps are shown (success banner, etc.), display in user timezone and label timezone when shown (DECISION-INVENTORY-016).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide standard empty-state messaging for Work Order Items list when no items returned; safe because it affects only UI ergonomics and not domain logic. Impacted sections: UX Summary, Alternate / Error Flows.
- SD-ERR-MAP-HTTP: Map standard HTTP errors (400/403/404/409/5xx) to consistent UI notifications using the standard error envelope; safe because it standardizes parsing/UX without changing business policy. Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows.
- SD-UX-LOADING-DISABLE: Disable primary action during in-flight request to prevent duplicate submission; safe because it is UI ergonomics and complements idempotency. Impacted sections: Functional Behavior, Acceptance Criteria.

---

## 16. Open Questions

1. What is the **exact backend contract** for promotion in this Moqui frontend (Moqui service name + parameters, or REST method + path)?  
   - Required to implement `EstimateEdit` transition deterministically.
2. What are the **authoritative status enum values** for the created Work Order Item initial status (e.g., `Authorized` vs `AUTHORIZED` vs `WOI_AUTHORIZED`) and for estimate status field name (`status` vs `statusId`)?  
   - UI must display exact values and avoid mismatched comparisons.
3. What are the **authoritative error `code` values** for promotion failures (missing tax config, totals mismatch, invalid state, already promoted) in the standard error envelope?  
   - Needed to implement reason-specific messaging and the ‚Äúalready promoted ‚Üí navigate‚Äù behavior safely.
4. In duplicate/already-promoted cases, does the backend return the existing **workOrderId** explicitly (recommended), or does it use `existingResourceId` and if so is it guaranteed to be a workOrderId for this endpoint?  
   - Needed to safely navigate without guessing identifier type.

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Promotion: Generate Workorder Items from Approved Scope ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/229  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Promotion: Generate Workorder Items from Approved Scope

**Domain**: user

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
A workorder header is created from an approved estimate.

## Main Flow
1. System iterates through approved scope line items.
2. System creates Workorder Items for parts and labor with stable identifiers.
3. System copies pricing/tax snapshot fields needed for downstream invoicing and variance explanations.
4. System marks items as 'Authorized' and sets execution flags (e.g., required vs optional).
5. System validates totals and quantity integrity.

## Alternate / Error Flows
- Approved scope contains an item no longer valid in catalog ‚Üí allow as snapshot item and flag for review.
- Tax configuration missing ‚Üí block promotion and require correction.

## Business Rules
- Only approved items are created on the workorder.
- Snapshot pricing/tax fields are preserved.
- Workorder items maintain traceability to estimate items.

## Data Requirements
- Entities: WorkorderItem, ApprovedScope, EstimateItem, TaxSnapshot
- Fields: itemSeqId, originEstimateItemId, authorizedFlag, quantity, unitPrice, taxCode, taxAmount, snapshotVersion

## Acceptance Criteria
- [ ] Workorder items match approved scope in quantity and pricing.
- [ ] Workorder items carry traceability back to estimate items.
- [ ] Promotion fails if required tax basis is missing (policy).

## Notes for Agents
Design for variance explanations later: preserve the numbers, not just totals.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #226: [FRONTEND] [STORY] Promotion: Record Promotion Audit Trail
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Promotion: View Promotion Audit Trail (Estimate ‚Üí Work Order)

### Primary Persona
Shop Manager / System Auditor (secondary: Service Advisor)

### Business Value
Provide a non-repudiable, easy-to-review UI record for each estimate promotion so disputes can be resolved quickly and compliance/audit needs are met (who promoted, when, what snapshot/approval, what totals were promoted).

---

## 2. Story Intent

### As a / I want / So that
- **As a** Shop Manager or System Auditor  
- **I want** to view the immutable promotion audit record created when an Estimate is promoted to a Work Order  
- **So that** I can verify exactly what was approved and promoted (snapshot + approval), who performed it, and the summary of promoted items.

### In-Scope
- Frontend screens/components to **display** promotion audit records linked to a Work Order and its source Estimate.
- Role-gated visibility of audit data.
- Empty/error states and safe navigation to related records (work order, estimate, snapshot, approval reference).
- Support for multiple promotion audit events (if present) with deterministic ordering and a ‚Äúmost recent‚Äù default.

### Out-of-Scope
- Creating/writing the audit record (triggered by backend during promotion).
- Changing promotion policy (fail vs retry) or implementing the promotion action itself (unless already existing and simply needs a link).
- Editing/deleting audit events (must be immutable).
- Defining/implementing estimate approval workflow (already owned by estimate/approval flows; this story only links to references).

---

## 3. Actors & Stakeholders
- **Primary user:** Shop Manager / System Auditor
- **Secondary user:** Service Advisor (may review after promoting)
- **System actor:** Backend process that records `PromotionAuditEvent` atomically with promotion
- **Stakeholders:** Compliance/audit reviewers, customer dispute resolution, support/ops (correlationId-based troubleshooting)

---

## 4. Preconditions & Dependencies
- Backend persists an immutable promotion audit record per successful promotion (entity name may vary).
- Work Order references its source Estimate (directly or via audit record).
- Authorization model exists to restrict audit visibility (capability/permission-based; backend authoritative).
- Backend endpoint(s) exist to fetch promotion audit records (see Open Questions for exact paths).
- Moqui screens exist for work order and estimate editing:
  - `durion-workexec/WorkOrderEdit.xml`
  - `durion-workexec/EstimateEdit.xml`  
  (DECISION-INVENTORY-002)

Dependencies (frontend):
- Moqui screens framework present in `durion-moqui-frontend` with established routing/layout conventions.
- Standard error envelope parsing support (DECISION-INVENTORY-011) or a normalization layer in the frontend.
- Capability signaling available via user context/session claims (DECISION-INVENTORY-013).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Work Order detail** (`WorkOrderEdit.xml`): ‚ÄúPromotion Audit‚Äù section (read-only).
- From **Estimate detail** (`EstimateEdit.xml`): ‚ÄúPromotion Audit‚Äù section (read-only) shown only when the estimate has at least one promotion audit record or a linked work order.

### Screens to create/modify
1. **Modify** `component://durion-workexec/screen/WorkOrderEdit.xml`
   - Add a read-only ‚ÄúPromotion Audit‚Äù section that loads audit records asynchronously.
2. **Modify** `component://durion-workexec/screen/EstimateEdit.xml`
   - Add a read-only ‚ÄúPromotion Audit‚Äù section (conditional display).
3. **Optional (recommended for deep-linking/support): Create** `component://durion-workexec/screen/PromotionAuditView.xml`
   - Dedicated view for a single audit event with stable URL parameters (e.g., `auditEventId`).

### Navigation context
- Work Order ‚Üí Promotion Audit (inline summary + ‚ÄúView details‚Äù)
- Estimate ‚Üí Promotion Audit (inline summary + link to Work Order)
- Deep link: Promotion Audit Event ‚Üí links to Work Order / Estimate / Snapshot / Approval (where screens exist)

### User workflows (happy + alternate)
**Happy path (Work Order)**
1. User opens Work Order detail.
2. Promotion Audit section loads in parallel.
3. UI shows the most recent promotion audit event summary and key references.
4. User optionally expands ‚ÄúAll promotion events‚Äù to view older events (if any).
5. User navigates to referenced Estimate / Work Order; optionally to Snapshot/Approval if supported.

**Happy path (Estimate)**
1. User opens Estimate detail.
2. If promoted, Promotion Audit section shows the promotion event(s) and links to resulting Work Order.

**Alternate: no audit**
- Work order exists but has no promotion audit (created directly, migrated, or legacy). UI shows ‚ÄúNo promotion audit recorded.‚Äù

**Unauthorized**
- If capability indicates no access, section is hidden.
- If capability is unknown and API returns 403, show access denied without leaking any audit fields.

---

## 6. Functional Behavior

### Triggers
- Work Order detail screen loads (route includes `workOrderId`).
- Estimate detail screen loads (route includes `estimateId`).

### UI actions
- Fetch promotion audit record(s) scoped to the current entity:
  - Prefer work-order-scoped fetch on WorkOrder screen.
  - Prefer estimate-scoped fetch on Estimate screen.
- Render:
  - ‚ÄúMost recent promotion‚Äù summary (always if records exist)
  - Expandable list/table of all events (if multiple)
  - Key-value details view (either inline or via dedicated screen)
- Provide navigation actions (enabled only when reference exists):
  - Open Work Order
  - Open Estimate
  - View Snapshot (if supported)
  - View Approval (if supported)

### State changes
- No domain state transitions (read-only).
- UI state machine per section:
  - `LOADING` ‚Üí `LOADED` | `EMPTY` | `ERROR_FORBIDDEN` | `ERROR_NOT_FOUND` | `ERROR_TRANSIENT`

### Service interactions
- Promotion audit fetch endpoint(s) (Open Question for exact path).
- Optional user identity lookup to render promoter display name (Open Question; do not assume people domain endpoints).
- Capability signal retrieval (existing app mechanism; DECISION-INVENTORY-013).
- Error normalization to standard envelope (DECISION-INVENTORY-011).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Route params must be present and treated as **opaque IDs** (strings). Do **not** validate UUID/numeric formats client-side. (DECISION-INVENTORY-003)
- If required route param missing/empty: show ‚ÄúNot found‚Äù style error and do not call API.

### Enable/disable rules
- ‚ÄúView Snapshot‚Äù enabled only if `estimateSnapshotId` (or equivalent) is present and a destination exists.
- ‚ÄúView Approval‚Äù enabled only if `approvalId` (or equivalent) is present and a destination exists.
- ‚ÄúView details‚Äù enabled only if an audit event exists.

### Visibility rules
- Promotion Audit section visible only to users with the appropriate capability/permission.
  - If capability flags are available: hide section entirely when unauthorized (preferred to reduce confusion).
  - Backend remains authoritative; if API returns 403, show access denied state within the section if it is visible. (DECISION-INVENTORY-013)

### Error messaging expectations
- 403: ‚ÄúYou do not have permission to view promotion audit details.‚Äù
- 404: ‚ÄúPromotion audit not found.‚Äù
- 5xx / network: ‚ÄúUnable to load promotion audit at this time. Try again.‚Äù + Retry action.
- All error states should display/retain `correlationId` when provided by the standard error envelope for support. (DECISION-INVENTORY-011)

---

## 8. Data Requirements

### Entities involved (frontend view model)
- `PromotionAuditEvent` (or equivalent audit record) ‚Äî immutable
- `WorkOrder` (reference)
- `Estimate` (reference)
- `ApprovalRecord` (reference only)
- `EstimateSnapshot` / `EstimateVersion` (reference only)
- `User` display info for `promotingUserId` (optional enrichment)

### Fields (type, required, defaults)

**Identifier types:** all IDs are opaque strings. (DECISION-INVENTORY-003)

Promotion audit fields to display (minimum viable):
- `auditEventId` (string, **required**)
- `eventType` (string, **required**; expected value like `ESTIMATE_PROMOTED_TO_WORK_ORDER`)
- `eventTimestamp` (string ISO-8601, **required**; display in user timezone, store raw)
- `promotingUserId` (string, **required**)
- `workOrderId` (string, **required**)
- `estimateId` (string, **required**)
- `estimateSnapshotId` (string, **optional but expected**; if absent, show ‚ÄúSnapshot reference unavailable‚Äù)
- `approvalId` (string, **optional but expected**; if absent, show ‚ÄúApproval reference unavailable‚Äù)
- `promotionSummary` (object/JSON, **optional**; render known keys and tolerate unknown keys)

`promotionSummary` display behavior:
- Render known fields if present (do not require all):
  - `total` (number) and optional `currencyUomId`/`currencyCode`
  - `laborItemCount` (number)
  - `partItemCount` (number)
  - `taxTotal` / `feesTotal` (if present)
- If keys are unknown, show a generic ‚ÄúSummary details available‚Äù and optionally a collapsible raw JSON view for auditors (read-only), subject to permission.

### Read-only vs editable by state/role
- All audit fields are read-only for all roles and states.

### Derived/calculated fields
- `promotingUserDisplayName` derived from `promotingUserId` if a user display lookup is available; otherwise display the ID.
- `eventTimestampLocal` derived from `eventTimestamp` using user timezone; label timezone used. (DECISION-INVENTORY-016 for display semantics)

---

## 9. Service Contracts (Frontend Perspective)

> Exact endpoint paths are not confirmed in provided inputs. This story requires at least one stable read contract. Until confirmed, the story remains blocked.

### Load/view calls (one must exist)

**Preferred (work order scoped):**
- `GET /rest/api/v1/workexec/workorders/{workOrderId}/promotion-audit`
  - Response: `{ events: PromotionAuditEvent[] }` or `PromotionAuditEvent[]`
  - Ordering: server returns newest-first OR includes `eventTimestamp` for client sort.

**Alternate (estimate scoped):**
- `GET /rest/api/v1/workexec/estimates/{estimateId}/promotion-audit`

**Alternate (generic audit query):**
- `GET /rest/api/v1/audit-events?entityType=WORK_ORDER&entityId={workOrderId}&eventType=ESTIMATE_PROMOTED_TO_WORK_ORDER`

Minimum response fields: those listed in Data Requirements.

### Create/update calls
- None.

### Submit/transition calls
- None.

### Error handling expectations
- Errors conform to standard envelope (DECISION-INVENTORY-011):
  - `{"code":"...","message":"...","correlationId":"...","fieldErrors":[...],"existingResourceId":"..."}`
- UI behavior:
  - `200` with events ‚Üí render
  - `200` with empty list OR `204` ‚Üí empty state
  - `401` ‚Üí follow app auth flow
  - `403` ‚Üí access denied state; do not render partial data
  - `404` ‚Üí not found state
  - `5xx`/timeout ‚Üí transient error with retry

---

## 10. State Model & Transitions

### Allowed states
Domain: N/A (read-only).

UI section states:
- `LOADING`
- `LOADED`
- `EMPTY`
- `ERROR_FORBIDDEN`
- `ERROR_NOT_FOUND`
- `ERROR_TRANSIENT`

### Role-based transitions
- Authorized ‚Üí can view section and data
- Unauthorized ‚Üí section hidden (if capability known) or access denied (if discovered via 403)

### UI behavior per state
- LOADING: show loader/skeleton within the section; do not block main screen.
- LOADED: show most recent event summary; show list if multiple.
- EMPTY: show ‚ÄúNo promotion audit recorded.‚Äù
- ERROR_FORBIDDEN: show access denied message; no data.
- ERROR_NOT_FOUND: show not found message; provide navigation back.
- ERROR_TRANSIENT: show retry action; keep main screen usable.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing `workOrderId`/`estimateId` in route context:
  - Do not call API.
  - Show not-found style message consistent with app routing.

### Concurrency conflicts
- Not applicable (read-only). If the audit record appears after initial load (eventual consistency), user can retry.

### Unauthorized access
- If capability indicates unauthorized: hide section entirely.
- If capability unknown and API returns 403: show access denied state; do not display any audit fields.

### Empty states
- Work order created without promotion audit: show empty state.
- Estimate not promoted: show empty state on Estimate detail.

### Partial data
- If `promotionSummary` missing: show ‚ÄúSummary unavailable‚Äù but still show core references.
- If `estimateSnapshotId` or `approvalId` missing: show the field label with ‚ÄúUnavailable‚Äù value; do not block viewing.

---

## 12. Acceptance Criteria

### Scenario 1: Authorized user views promotion audit from Work Order
**Given** I am logged in as a user with permission/capability to view promotion audit records  
**And** a Work Order exists with at least one associated Promotion Audit Event  
**When** I open the Work Order detail screen  
**Then** I see a ‚ÄúPromotion Audit‚Äù section  
**And** it displays the most recent event‚Äôs promoting user identifier, event timestamp, estimateId, and workOrderId  
**And** it displays snapshot and approval references when present  
**And** it displays promotion summary totals and item counts when provided.

### Scenario 2: Work Order has no promotion audit
**Given** I am logged in as an authorized user  
**And** a Work Order exists with no promotion audit record  
**When** I open the Work Order detail screen  
**Then** I see ‚ÄúNo promotion audit recorded‚Äù in the Promotion Audit section  
**And** the UI does not display placeholder audit identifiers.

### Scenario 3: Unauthorized user cannot view promotion audit
**Given** I am logged in as a user without permission/capability to view promotion audit records  
**When** I open a Work Order detail screen that has a promotion audit record  
**Then** the UI hides the Promotion Audit section when capability is known  
**Or** if the section is visible and the API returns 403, the UI shows ‚ÄúYou do not have permission to view promotion audit details.‚Äù  
**And** the client must not render any audit fields.

### Scenario 4: Backend returns transient error while loading audit
**Given** I am logged in as an authorized user  
**When** the Promotion Audit API request fails with a 5xx error or network timeout  
**Then** I see an error state indicating the audit could not be loaded  
**And** I can retry the load  
**And** the Work Order page remains usable while the audit section is in error.

### Scenario 5: Multiple promotion audit events are handled deterministically
**Given** I am logged in as an authorized user  
**And** a Work Order has multiple Promotion Audit Events  
**When** I open the Work Order detail screen  
**Then** the UI shows the most recent event by `eventTimestamp` as the default summary  
**And** I can view the full list ordered newest-first  
**And** each list row shows `eventTimestamp`, `promotingUserId`, and `auditEventId`.

### Scenario 6: CorrelationId is surfaced for support on errors
**Given** I am logged in as an authorized user  
**When** the Promotion Audit API returns an error response containing `correlationId` in the standard error envelope  
**Then** the UI logs the correlationId to the client log  
**And** the UI displays the correlationId in an expandable ‚ÄúError details‚Äù area (read-only).

---

## 13. Audit & Observability

### User-visible audit data
- Display immutable audit fields:
  - promoter (ID and display name if available)
  - timestamp (localized display; raw ISO available)
  - event type (human label)
  - linked entity references (estimate/work order/snapshot/approval)
  - summary totals (if provided)
  - `auditEventId` (in details view)

### Status history
- Not created by this story. This story only reads and displays promotion audit events.

### Traceability expectations
- When an error occurs, capture and surface `correlationId` from the standard error envelope. (DECISION-INVENTORY-011)
- Do not display sensitive payloads; if raw JSON summary is shown, it must be limited to the `promotionSummary` object and only for authorized users.

---

## 14. Non-Functional UI Requirements
- **Performance:** Promotion Audit section loads asynchronously and must not block Work Order/Estimate initial render.
- **Accessibility:** All fields and actions keyboard navigable; use semantic headings and definition-list style key/value presentation; ensure focus order and screen reader labels.
- **Responsiveness:** Must work on tablet and desktop; section collapsible on smaller screens.
- **i18n/timezone/currency:** Display timestamps in user timezone and label timezone used; currency formatting uses currency code if provided in summary; otherwise display numeric value without assuming currency. (DECISION-INVENTORY-016)

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging when no audit record exists; safe because it does not change domain behavior and only affects presentation. Impacted sections: UX Summary, Alternate/Empty states, Acceptance Criteria.
- SD-UX-ASYNC-SECTION-LOAD: Load Promotion Audit independently from primary Work Order/Estimate details to avoid blocking; safe as it‚Äôs a UI ergonomics choice. Impacted sections: Functional Behavior, Non-Functional Requirements, Error Flows.
- SD-ERR-HTTP-MAP: Standard mapping of 401/403/404/5xx to user-friendly messages; safe because it doesn‚Äôt alter domain logic and follows typical frontend handling. Impacted sections: Business Rules (error messaging), Service Contracts, Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. **Promotion audit read endpoint(s):** What is the exact REST path and response schema to retrieve promotion audit events by `workOrderId` and/or `estimateId` in this Moqui frontend deployment (including whether response is a list vs single object)?  
2. **Permission/capability name:** What is the canonical capability/permission required to view promotion audit (e.g., `WORKEXEC_AUDIT_VIEW`), and is it exposed via user context/session claims?  
3. **Deep-link destinations:** Do screens/endpoints exist to view `estimateSnapshotId` and `approvalId` details? If not, should the UI display them as plain text only (no links) until those screens exist?  
4. **promotionSummary canonical schema:** What are the canonical keys and currency fields for the summary (and whether totals include tax/fees)? Provide a stable DTO contract.  
5. **User display lookup:** Is there an approved endpoint/service to resolve `promotingUserId` to a display name in this app, or should the UI display only the ID to avoid cross-domain coupling?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #222: [FRONTEND] [STORY] Execution: Issue and Consume Parts
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Execution: Issue and Consume Parts (Work Order Part Usage Events)

### Primary Persona
Technician / Parts Counter Staff

### Business Value
Ensure parts issued to (picked) and consumed on (installed) a work order are recorded with full traceability, enforce authorized quantity limits, and reflect parts availability issues in work order execution‚Äîso inventory/accounting downstream processes can rely on accurate, idempotent events.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Technician or Parts Counter Staff
- **I want** to record parts **issued** and **consumed** against a specific work order part line item
- **So that** work progress is accurate, audit trails are immutable, and downstream inventory/accounting systems receive correct, idempotent issuance events.

### In Scope
- View work order part line items and their authorized vs issued/consumed quantities.
- Record part usage as **events** (issue and consume for a work order part item).
- Validate quantity integrity (cannot exceed authorized; cannot exceed available if inventory-integrated).
- Handle insufficient inventory by flagging and moving the work order to a parts-waiting execution status (see Open Questions re exact status mapping).
- Display usage event history (who/when/what) per work order item for auditability.
- Idempotent submission behavior from the frontend (prevent double-submit; handle retry responses safely).

### Out of Scope
- Creating/modifying estimate scope or approvals to increase authorized quantities (approval workflows are separate).
- Defining accounting policy (WIP vs COGS) or ledger postings (downstream/accounting-owned); frontend only surfaces returned policy if available.
- Implementing inventory allocation/picking list scanning workflows (separate ‚Äúpicking‚Äù domain features).
- Notification delivery mechanics (only show messages/alerts in UI).

---

## 3. Actors & Stakeholders

### Actors
- **Technician**: records consumed/installed parts during execution.
- **Parts Counter Staff**: records issued/picked parts to the job.

### Stakeholders
- **Service Advisor**: needs visibility when parts shortages block progress.
- **Inventory** (downstream system): relies on issued events to decrement on-hand / reservations.
- **Accounting** (downstream system): relies on events and policy metadata (WIP/COGS).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- A **Work Order** exists and is in a non-terminal status that permits recording parts usage (not `COMPLETED` / `CANCELLED`).
- Work order contains at least one **WorkOrderPart** (or equivalent) item with:
  - `productId`
  - authorized quantity
  - current issued/consumed totals
- Backend endpoints exist (or will exist) to:
  - Load work order + part items + usage history
  - Record a usage event (issue/consume)
  - Return validation errors deterministically using the standard error envelope (DECISION-INVENTORY-011)

### Dependencies
- Work order execution status model (from `WORKORDER_STATE_MACHINE.md`) for any UI-driven status update behavior.
- Inventory availability lookup and ‚Äúinsufficient inventory‚Äù validation behavior (backend integration contract).
- Idempotency behavior for usage event recording (frontend must send `Idempotency-Key` for mutation calls; DECISION-INVENTORY-012).
- Identifier handling: all IDs are opaque strings; UI must not validate UUID/numeric formats (DECISION-INVENTORY-003).
- Capability/permission signaling: UI gating uses capability flags; backend enforces with 403 (DECISION-INVENTORY-013).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From `durion-workexec` work order edit/detail screen: action ‚ÄúParts‚Äù ‚Üí ‚ÄúIssue / Consume‚Äù.
- From a part line item row: action ‚ÄúRecord Usage‚Äù.

### Screens to create/modify
1. **Modify**: `durion-workexec/WorkOrderEdit.xml`
   - Add a ‚ÄúParts Usage‚Äù section/tab and link to the parts usage screen for the current `workOrderId`.
2. **Create**: `durion-workexec/WorkOrderPartUsage.xml` (new screen)
   - Work order scoped list of part line items with authorized/issued/consumed totals.
   - Per-line actions: ‚ÄúRecord Issue‚Äù, ‚ÄúRecord Consume‚Äù (and optionally ‚ÄúRecord Return‚Äù if supported by backend contract).
   - Per-line link to usage history.
3. **Create/Include**: `durion-workexec/WorkOrderPartUsageRecord.xml` (subscreen/dialog include)
   - Form to submit a single usage event for a selected part line item.
4. **Create**: `durion-workexec/WorkOrderPartUsageHistory.xml` (subscreen)
   - Immutable event list for a selected part line item.

### Navigation context
- Canonical Moqui screen routing (DECISION-INVENTORY-002):
  - `/webroot/durion-workexec/WorkOrderEdit?workOrderId=<id>`
  - `/webroot/durion-workexec/WorkOrderPartUsage?workOrderId=<id>`
  - `/webroot/durion-workexec/WorkOrderPartUsageHistory?workOrderId=<id>&workOrderPartId=<id>`
- Breadcrumb: Work Orders ‚Üí Work Order ‚Üí Parts Usage

### User workflows (happy + alternate paths)

**Happy path: record issue**
1. User opens Work Order ‚Üí Parts Usage.
2. User selects a part line item and clicks ‚ÄúRecord Issue‚Äù.
3. User enters `quantity` to issue and submits.
4. UI refreshes line totals and appends a new immutable event in history.

**Happy path: record consume**
1. User clicks ‚ÄúRecord Consume‚Äù for a part line item.
2. User enters `quantity` to consume and submits.
3. UI refreshes totals and history.

**Alternate paths**
- Insufficient inventory: UI shows server error; if backend transitions WO to `AWAITING_PARTS`, UI shows updated status banner.
- Exceeds authorized: UI shows server error and provides navigation CTA to out-of-scope ‚ÄúRequest approval / change request‚Äù.
- Work order locked (terminal): UI renders read-only with explanation.
- Duplicate submit/retry: UI shows non-blocking ‚ÄúAlready recorded‚Äù message and refreshes totals/history (DECISION-INVENTORY-011, DECISION-INVENTORY-012).

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúRecord Issue‚Äù or ‚ÄúRecord Consume‚Äù on a work order part line item.

### UI actions
- On screen entry, load:
  - Work order header (including `statusId`)
  - Part line items with totals
- For a selected part line item, display:
  - authorized quantity
  - total issued quantity to date
  - total consumed quantity to date
  - remaining authorized quantity (derived; see Business Rules for definition constraints)
- Allow user to submit a **single usage event** with:
  - `eventType` (ISSUE or CONSUME; RETURN optional if backend supports)
  - `quantity` (decimal, > 0)
  - optional `note` only if backend supports (not assumed)

### State changes
- On successful submit:
  - A new immutable **PartUsageEvent** exists (backend-owned).
  - Work order part item totals update (backend-owned).
  - If backend returns updated work order status (e.g., `AWAITING_PARTS`), UI reflects it immediately.

### Service interactions
- Load work order + parts list on screen entry.
- Submit usage event via a single service call per event.
- Refresh affected part line item and its history after successful submission (either via returned payload or follow-up GET).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation

**Client-side (non-authoritative, ergonomic only)**
- A part line item must be selected.
- `quantity` must be a number and `> 0`.
- `eventType` must be selected (ISSUE or CONSUME; RETURN only if enabled by backend capability/contract).
- Disable submit while request is in-flight.

**Server-side (authoritative; UI must display errors using standard envelope DECISION-INVENTORY-011)**
- No usage events allowed when work order is `COMPLETED` or `CANCELLED`.
- Cannot exceed authorized quantity per backend policy (authorization enforcement is domain policy; see Open Questions for exact rule binding to issued vs consumed).
- Inventory constraints (if integrated) are enforced server-side; UI must not assume on-hand values are current.

### Enable/disable rules
- Disable all ‚ÄúRecord ‚Ä¶‚Äù actions when:
  - Work order status is `COMPLETED` or `CANCELLED`
  - User lacks capability to record usage (capability flag; DECISION-INVENTORY-013)
- If work order status is `AWAITING_PARTS`, actions remain enabled unless backend rejects (to allow recording once parts arrive).

### Visibility rules
- If backend indicates inventory integration/availability signals are unavailable:
  - Do not show ‚Äúon hand‚Äù/availability indicators.
  - Still allow recording usage events; backend remains authoritative.

### Error messaging expectations (mapped from error envelope)
- `code=AUTHORIZATION_FAILED` or HTTP 403: ‚ÄúYou do not have permission to record parts usage.‚Äù
- `code=VALIDATION_ERROR` with fieldErrors:
  - quantity: ‚ÄúEnter a quantity greater than 0.‚Äù
  - eventType: ‚ÄúSelect Issue or Consume.‚Äù
- `code=EXCEEDS_AUTHORIZED`: ‚ÄúExceeds authorized quantity. Request approval to increase scope.‚Äù
- `code=INSUFFICIENT_INVENTORY`: ‚ÄúInsufficient inventory to issue the requested quantity.‚Äù
- `code=DUPLICATE` (409 with `existingResourceId`): ‚ÄúThis usage event was already recorded. Totals have been refreshed.‚Äù
- `code=CONFLICT` (409): ‚ÄúThis work order was updated by someone else. Review the latest totals and try again.‚Äù

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `durion.workexec.DurWorkOrder` (read)
- `durion.workexec.WorkOrderPart` (name may differ; read/update via service)
- `durion.workexec.PartUsageEvent` (create/read history; entity name may differ)
- Optional read-only inventory signal DTO (from inventory domain; not owned by workexec)

### Fields (types, required, defaults)

**WorkOrder**
- `workOrderId` (type: id/opaque string, required; DECISION-INVENTORY-003)
- `statusId` (string enum, required)
- Optional convenience flags if provided by backend:
  - `isStarted` (boolean; preferred to avoid client mapping; DECISION-INVENTORY-004)

**WorkOrderPart (part line)**
- `workOrderPartId` (type: id/opaque string, required)
- `workOrderId` (id, required)
- `productId` (id, required)
- `authorizedQuantity` (decimal, required)
- `quantityIssuedTotal` (decimal, required, default 0)
- `quantityConsumedTotal` (decimal, required, default 0)
- `originEstimateItemId` (id, optional)
- Optional:
  - `uomId` (id/string, optional)
  - `description` (string, optional)

**PartUsageEvent (immutable history row)**
- `partUsageEventId` (id, required)
- `workOrderId` (id, required)
- `workOrderPartId` (id, required)
- `productId` (id, required)
- `eventType` (enum: ISSUE | CONSUME | RETURN?; see Open Questions)
- `quantity` (decimal, required)
- `eventAt` (timestamp, required; stored UTC; display in user timezone per DECISION-INVENTORY-016)
- `performedByUserId` (id, required)
- Optional:
  - `note` (string, optional)
  - `idempotencyKey` (string, optional echo)

### Read-only vs editable by state/role
- Read-only always:
  - Existing `PartUsageEvent` rows (append-only)
  - Work order status (except via separate transitions not in scope here)
- Editable:
  - New usage event form inputs (eventType, quantity, optional note)
- Role/capability gating:
  - Viewing parts usage vs recording usage must be capability-driven (DECISION-INVENTORY-013); exact capability names are Open Questions.

### Derived/calculated fields
- `remainingAuthorized` (UI derived for display only):
  - **Do not enforce as authoritative**; backend validates.
  - Definition depends on policy (consumed vs issued vs both); see Open Questions.
- ‚ÄúLast updated‚Äù timestamp for history list (derived from latest eventAt).

---

## 9. Service Contracts (Frontend Perspective)

> Moqui service names / REST paths are not confirmed in provided inputs for this specific feature. The frontend contract below is the **minimum required**; story remains blocked until endpoints are confirmed.

### Load/view calls
1. Load work order header:
   - `GET /rest/api/v1/workexec/workorders/{workOrderId}`
   - Response includes: `workOrderId`, `statusId`, optional `isStarted`, and any capability hints if embedded.

2. Load part line items for work order:
   - `GET /rest/api/v1/workexec/workorders/{workOrderId}/parts?pageIndex=&pageSize=`
   - Response includes list of WorkOrderPart DTOs with totals.

3. Load usage event history for a part line:
   - `GET /rest/api/v1/workexec/workorders/{workOrderId}/parts/{workOrderPartId}/usage-events?pageIndex=&pageSize=`
   - Response includes immutable events ordered by `eventAt desc`.

### Create/update calls
1. Create a usage event (single event per call)
   - `POST /rest/api/v1/workexec/workorders/{workOrderId}/parts/{workOrderPartId}/usage-events`
   - Headers:
     - `Idempotency-Key: <uuid>` (required; DECISION-INVENTORY-012)
   - Request body:
```json
{
  "eventType": "ISSUE",
  "quantity": 2,
  "note": "optional-if-supported"
}
```
   - Response:
     - `201 Created` with:
       - created `PartUsageEvent`
       - updated `WorkOrderPart` totals (preferred)
       - optional updated `WorkOrder` statusId (if changed)
     - OR `200 OK` with same payload on idempotent replay
     - OR `409 Conflict` with standard error envelope including `existingResourceId` when duplicate (DECISION-INVENTORY-011)

### Submit/transition calls
- If insufficient inventory requires explicit transition to `AWAITING_PARTS`, that is a separate work order transition endpoint/service and is **not defined here**. Prefer backend to transition as part of the usage attempt when it is the direct cause; otherwise Open Question.

### Error handling expectations
All non-2xx responses must be normalized to the standard error envelope (DECISION-INVENTORY-011):
```json
{
  "code": "VALIDATION_ERROR",
  "message": "Human readable",
  "correlationId": "c-123",
  "fieldErrors": [{"field":"quantity","message":"..."}],
  "existingResourceId": "optional"
}
```
Frontend behavior:
- Show `message` in a user-visible alert.
- Map `fieldErrors[]` to form fields.
- Log `correlationId` with client-side error telemetry.
- On `DUPLICATE`/`existingResourceId`, refresh totals/history and show non-blocking info.

---

## 10. State Model & Transitions

### Allowed states (Work Order)
From `WORKORDER_STATE_MACHINE.md`:
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

### Role-based transitions
- This story does **not** introduce new transitions.
- It may **reflect** a transition to `AWAITING_PARTS` if the backend performs it due to inventory constraints.
- Any explicit transition action (if required) must be permission-gated and audited by backend; capability name and endpoint are Open Questions.

### UI behavior per state
- `COMPLETED`, `CANCELLED`: read-only; cannot record usage.
- `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`:
  - Allow recording usage unless backend rejects (policy-driven).
  - If `AWAITING_PARTS`, show banner ‚ÄúWaiting for parts‚Äù and keep actions available (to record once parts are issued/received).

---

## 11. Alternate / Error Flows

### Validation failures
- Quantity <= 0:
  - Client blocks submit; server also rejects with 400/VALIDATION_ERROR.
- Exceeds authorized:
  - Server rejects with 400 (or 409 if modeled as conflict) and `code=EXCEEDS_AUTHORIZED`.
  - UI shows error and provides navigation CTA to out-of-scope approval/change request flow.

### Concurrency conflicts
- If totals changed since load:
  - Server returns 409 with `code=CONFLICT` and latest totals if available.
  - UI refreshes list/history and prompts user to retry.

### Unauthorized access
- If user lacks view permission:
  - Screen access denied (Moqui auth) or API returns 403; UI shows ‚ÄúNot authorized‚Äù.
- If user can view but cannot record:
  - Screen loads read-only; ‚ÄúRecord ‚Ä¶‚Äù actions hidden/disabled with explanation.

### Empty states
- No part items:
  - Show ‚ÄúNo parts on this work order.‚Äù
  - Provide navigation to out-of-scope ‚ÄúEdit estimate/work order‚Äù if available.
- No usage history for a line:
  - Show ‚ÄúNo usage recorded yet.‚Äù

---

## 12. Acceptance Criteria

### Scenario 1: Record an ISSUE event successfully
**Given** a work order in `WORK_IN_PROGRESS` with a part line authorizing `2` units of product `PART-123`  
**And** the user has capability to record parts usage  
**When** the user records an `ISSUE` event with `quantity=2` for that part line  
**Then** the system creates an immutable usage event with `performedByUserId` and `eventAt` (UTC source)  
**And** the part line totals reflect `quantityIssuedTotal` increased by `2`  
**And** the new event appears in the history list without requiring a full page reload.

### Scenario 2: Record a CONSUME event successfully
**Given** a work order in `WORK_IN_PROGRESS` with a part line authorizing `2` units of product `PART-123`  
**And** the part line has `quantityIssuedTotal=2` and `quantityConsumedTotal=0`  
**When** the user records a `CONSUME` event with `quantity=2`  
**Then** the system creates an immutable usage event  
**And** the part line totals reflect `quantityConsumedTotal` increased by `2`.

### Scenario 3: Prevent exceeding authorized quantity
**Given** a work order in `WORK_IN_PROGRESS` with a part line authorizing `2` units of `PART-123`  
**When** the user attempts to record a usage event that exceeds the authorized limit per backend policy  
**Then** the submission is rejected with a standard error envelope containing `code=EXCEEDS_AUTHORIZED`  
**And** the UI displays ‚ÄúExceeds authorized quantity. Request approval to increase scope.‚Äù  
**And** no new usage event appears in history.

### Scenario 4: Insufficient inventory handling
**Given** a work order in `WORK_IN_PROGRESS` with a part line authorizing `2` units of `PART-123`  
**And** the backend enforces inventory availability for ISSUE events  
**When** the user submits an `ISSUE` event for `quantity=2` and inventory is insufficient  
**Then** the backend responds with a standard error envelope containing `code=INSUFFICIENT_INVENTORY`  
**And** the UI displays ‚ÄúInsufficient inventory to issue the requested quantity.‚Äù  
**And** no usage event is recorded  
**And** if the backend transitions the work order to `AWAITING_PARTS` as part of this failure, the UI reflects the updated status on refresh.

### Scenario 5: Work order locked (terminal)
**Given** a work order with status `COMPLETED`  
**When** the user navigates to Parts Usage  
**Then** the UI renders parts and usage history read-only  
**And** ‚ÄúRecord ‚Ä¶‚Äù actions are disabled/hidden  
**And** any attempt to submit results in a 403/400 handled error with a user-visible message.

### Scenario 6: Idempotent retry does not double-record
**Given** the user submits an `ISSUE` event with `Idempotency-Key=K1`  
**And** the network times out after submit  
**When** the user retries the same submission reusing `Idempotency-Key=K1`  
**Then** the backend returns the same outcome (200/201 or 409 DUPLICATE with `existingResourceId`)  
**And** the UI shows only one new event in history  
**And** totals reflect a single increment.

---

## 13. Audit & Observability

### User-visible audit data
- Per usage event show:
  - event type
  - quantity
  - performed by (display name if available; otherwise userId)
  - event timestamp (display in user timezone; label timezone; DECISION-INVENTORY-016)
- Show `correlationId` from error envelope in an ‚ÄúAdvanced / Support details‚Äù expander.

### Status history
- If work order status changes (e.g., to `AWAITING_PARTS`), show the current status prominently.
- If transition history endpoint exists, link to it (read-only) but do not require it for this story.

### Traceability expectations
- UI must surface identifiers for support:
  - `workOrderId`
  - `workOrderPartId`
  - `partUsageEventId`
  - `Idempotency-Key` (for the last submission attempt; optional display)

---

## 14. Non-Functional UI Requirements

- **Performance**: Parts list load < 2s for up to 200 part lines; history supports pagination.
- **Accessibility**: All form inputs labeled; errors announced; keyboard navigable; focus returns to triggering control after dialog close.
- **Responsiveness**: Usable on tablet (shop floor).
- **i18n/timezone/currency**: Timestamps displayed in user timezone with explicit timezone label; store/receive UTC timestamps; quantities support decimals (no integer-only assumptions).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit empty state messaging for ‚Äúno parts‚Äù and ‚Äúno history‚Äù; safe because it doesn‚Äôt affect domain policy. (Impacted: UX Summary, Alternate / Error Flows)
- SD-UX-PAGINATION: Paginate usage event history (default page size 25) to avoid long lists; safe UI ergonomics only. (Impacted: UX Summary, Non-Functional UI Requirements)
- SD-ERR-MAP-HTTP: Standard mapping of 400/403/404/409 to user messages and field errors using the standard error envelope; safe because it follows domain decision DECISION-INVENTORY-011. (Impacted: Service Contracts, Business Rules, Alternate / Error Flows)

---

## 16. Open Questions

1. **Backend contract (blocking):** What are the exact Moqui service names and/or REST endpoints for:
   - loading work order parts with totals
   - listing part usage events
   - creating a usage event  
   (This story references `/rest/api/v1/workexec/...` as placeholders only.)

2. **Event model (blocking):** Are usage events modeled as:
   - separate event types with a single `quantity` (`ISSUE`, `CONSUME`, optional `RETURN`), **or**
   - a combined event with both issued+consumed quantities?  
   (Story is written assuming separate event types; adjust if combined is authoritative.)

3. **Authorized quantity enforcement (blocking):** Is the authorized limit enforced against:
   - consumed total only,
   - issued total only,
   - both independently,
   - or a rule like `consumed <= issued <= authorized`?  
   UI must display ‚Äúremaining authorized‚Äù consistent with the authoritative rule.

4. **Insufficient inventory behavior (blocking):** On insufficient inventory for ISSUE:
   - does backend reject without changing work order status,
   - does backend transition to `AWAITING_PARTS`,
   - or must frontend call a separate transition endpoint?  
   (Workexec state machine includes `AWAITING_PARTS`, but transition trigger contract is not specified.)

5. **Idempotency key usage (blocking):** Confirm that frontend should:
   - always generate a UUID `Idempotency-Key` per submit attempt and reuse on retry (per DECISION-INVENTORY-012), and
   - not attempt to construct a semantic key like `workOrderId+partId+sequence`.  
   Also confirm whether backend echoes the idempotency key and/or returns `existingResourceId` on duplicates (DECISION-INVENTORY-011).

6. **Capabilities/permissions (blocking):** What capability flags (names) control:
   - viewing parts usage
   - recording ISSUE
   - recording CONSUME
   - recording RETURN (if supported)
   - transitioning to `AWAITING_PARTS` (if explicit transition exists)  
   (Per DECISION-INVENTORY-013, UI must gate by capability flags, not hardcoded roles.)

7. **Inventory integration signal (blocking):** How does the frontend detect whether to show availability/on-hand indicators:
   - flag in the parts list response,
   - separate inventory availability endpoint,
   - or never shown in workexec UI?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #219: [FRONTEND] [STORY] Execution: Apply Role-Based Visibility in Execution UI
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] Work Execution: Enforce Capability-Based Visibility for Financial Fields in Work Order Execution UI (Moqui)

**Primary Persona:** Mechanic / Technician (restricted view) and Service Advisor / Back Office (full view)

**Business Value:** Prevents unauthorized visibility of sensitive pricing/cost/margin data during execution while preserving full financial truth for invoicing/reporting and ensuring consistent enforcement across execution screens.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Mechanic/Technician  
  **I want** the Work Order execution UI to hide pricing/cost/margin fields I‚Äôm not authorized to see  
  **So that** I can focus on completing work without being exposed to sensitive financial information.

- **As a** Service Advisor / Back Office user  
  **I want** the same screens to show full financial fields when I‚Äôm authorized  
  **So that** I can quote, explain, and prepare billing accurately.

### In Scope
- Frontend (Moqui screens) enforcement of **capability/permission-based visibility** for sensitive financial fields in Work Order execution views.
- Consistent behavior across:
  - Work order header/summary
  - Work order line items (parts/services)
  - Any execution-related subviews that display line item financials (tables, detail panels, totals)
- Secure fallback behavior when capabilities cannot be determined: **hide sensitive fields** and surface a non-sensitive warning banner.
- Standardized error handling and observability for capability resolution and fallback.

### Out of Scope
- Creating or editing visibility policies (owned by Security/Policy backend).
- Backend enforcement logic (server-side filtering/authorization).
- Business calculations (pricing, margins, taxes).
- Defining new workflow states or changing work order state machine.
- Any time-entry CRUD (people domain).

---

## 3. Actors & Stakeholders
- **Mechanic/Technician**: Uses execution UI; must not see restricted financials.
- **Service Advisor / Back Office**: Needs full visibility for pricing/cost/margin.
- **System Administrator / Support**: Needs misconfiguration signal (non-sensitive) and correlation IDs for troubleshooting.
- **Security domain**: Owns permission policy definitions; workexec UI consumes capability signals and enforces UI gating (DECISION-INVENTORY-013).
- **Workexec services/screens**: Provide work order data and enforce authorization server-side.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated and has a user context available to Moqui (session/userAccount).
- Work Order exists and is viewable by the user (base permission/capability required).

### Dependencies (Blocking if absent/unknown)
- **Capability signal source is not specified for this repo** (DECISION-INVENTORY-013 allows either user-context endpoint or session claims). The frontend must have one of:
  1) A user context/capabilities endpoint, or  
  2) Capability flags embedded in the work order payload, or  
  3) A reliable server-side omission of sensitive fields plus an explicit indicator that omission is authorization-driven (not ‚Äúnull data‚Äù).
- Exact Moqui screen(s) used for ‚ÄúWork Order execution UI‚Äù in this repo must be confirmed (DECISION-INVENTORY-002 provides canonical workexec screens, but ‚Äúexecution UI‚Äù vs ‚Äúedit UI‚Äù needs mapping).
- Definitive list of sensitive financial fields present in current DTOs/screens.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order board/list ‚Üí select Work Order ‚Üí Work Order detail/edit (execution-facing) view.
- Direct navigation by ID (deep link).

### Screens to create/modify (Moqui)
- **Modify** existing workexec screens (canonical per DECISION-INVENTORY-002):
  - `durion-workexec/WorkOrderBoard.xml` (only if it displays financials in rows/summary)
  - `durion-workexec/WorkOrderEdit.xml` (primary target for execution UI)
  - Any subscreens included by `WorkOrderEdit.xml` that render parts/services line items and totals
- **No new routes** required; enforce within existing screens/components.

### Navigation context
- Same route renders for all roles; UI behavior changes based on capability flags, not role-name checks.
- If capability resolution fails, UI still renders operational data but hides sensitive financials and shows a limited-visibility banner.

### User workflows (happy + alternate paths)

**Happy path (Mechanic / restricted)**
1. User opens `WorkOrderEdit` for a work order.
2. Screen loads work order + line items.
3. UI shows operational fields (descriptions, quantities, statuses) but hides financial fields and any totals that would reveal them.

**Happy path (Advisor / full)**
1. User opens the same work order.
2. UI shows operational fields plus authorized financial fields and totals.

**Alternate path (capabilities unavailable)**
1. User opens work order.
2. Capability signal cannot be resolved (missing endpoint/claims, request fails, or payload lacks flags).
3. UI defaults to hiding sensitive fields and shows a non-sensitive banner: ‚ÄúLimited visibility: financial fields hidden (policy unavailable).‚Äù
4. UI logs a structured client event with correlationId (if available).

---

## 6. Functional Behavior

### Triggers
- Work order screen loads for a given `workOrderId`.
- User navigates between tabs/subscreens within the work order screen.
- User opens a line item detail panel/modal (if present).

### UI actions
1. Load work order data (and line items) via existing Moqui screen actions/services.
2. Resolve capability flags for financial visibility using the configured source (see Service Contracts).
3. Render UI conditionally:
   - If capability allows: render financial fields.
   - If capability denies or unknown: do not render financial fields or derived totals.

### State changes
- Local UI state (screen context):
  - `capabilitiesResolved: boolean`
  - `canViewPricing: boolean`
  - `canViewCost: boolean`
  - `canViewMargin: boolean`
  - `visibilityFallbackApplied: boolean` (true when capabilities unresolved)
- Rendering toggles:
  - Hide columns/rows/sections for restricted fields
  - Hide totals/subtotals/summary values that would reveal restricted info
  - Hide any ‚Äúshow breakdown‚Äù affordances unless permitted

### Service interactions
- Work order load (existing).
- Optional capability load (if not embedded).
- No create/update/transition calls in scope.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- If user is unauthorized to view the work order (server returns 403 or screen auth denies):
  - UI shows access denied; no work order data rendered.
- If capability resolution fails:
  - UI must default to **hide sensitive fields** (DECISION-INVENTORY-013: backend authoritative; UI should avoid unsafe exposure).

### Enable/disable rules
- Any UI control that reveals sensitive info (e.g., ‚ÄúShow cost breakdown‚Äù, ‚ÄúShow margin‚Äù) must be hidden/disabled unless corresponding capability is true.
- No ‚Äútoggle to reveal‚Äù for restricted users without capability.

### Visibility rules
Sensitive financial fields include (minimum set; expanded by Open Questions):
- Pricing: `unitPrice`, `extendedPrice` (and any line/summary totals derived from them)
- Cost: `unitCost`, `extendedCost` (or `cost` depending on DTO)
- Margin: `marginAmount`, `marginPercent` (or `margin`)

Capability mapping (names TBD; do not hardcode roles):
- `canViewPricing` gates all price fields and price-derived totals.
- `canViewCost` gates all cost fields and cost-derived totals.
- `canViewMargin` gates margin fields; margin must not be computed client-side when not visible.

**Decision rationale:** DECISION-INVENTORY-013 requires capability signaling and backend enforcement; UI must gate based on stable capability flags and still handle 403.

### Error messaging expectations
- Unauthorized (403): ‚ÄúInsufficient permissions to view this work order.‚Äù
- Capability unavailable (fallback): ‚ÄúLimited visibility: financial fields hidden (policy unavailable).‚Äù
- Must not reveal internal policy/role names.

---

## 8. Data Requirements

### Entities involved (frontend-consumed)
- `durion.workexec.DurWorkOrder` (work order execution record; SoR for execution lifecycle per AGENT_GUIDE)
- Work order line items (implementation-dependent: `WorkOrderService`, `WorkOrderPart`, or a unified DTO)
- Capability signal (from user context endpoint/session claims or embedded payload; DECISION-INVENTORY-013)

### Fields (type, required, defaults)

**Identifiers**
- All IDs are opaque strings (DECISION-INVENTORY-003). UI must not validate UUID/numeric formats.

**Work Order (read-only for this story)**
- `workOrderId` (id/string, required)
- `statusId` (string enum, required)
- Operational fields currently rendered by `WorkOrderEdit.xml` (unchanged)

**Line items (read-only for this story)**
- `lineId` (id/string, required)
- `itemType` (enum: `PART`/`SERVICE`, required if unified)
- `description` (string, required)
- `quantity` (number/decimal, required for parts if present)
- `statusId` (string enum, required if present)

**Sensitive financial fields (optional; visibility-gated)**
- Pricing:
  - `unitPrice` (decimal)
  - `extendedPrice` (decimal)
  - `discountAmount` (decimal) (if present)
  - `taxAmount` (decimal) (if present)
- Cost:
  - `unitCost` or `cost` (decimal)
  - `extendedCost` (decimal)
- Margin:
  - `marginAmount` or `margin` (decimal)
  - `marginPercent` (decimal)

**Capabilities**
- Preferred shape (stable booleans):
  - `capabilities: { canViewPricing: boolean, canViewCost: boolean, canViewMargin: boolean }`
- Default if missing/unresolved:
  - all `false`, `capabilitiesResolved=false`, `visibilityFallbackApplied=true`

### Read-only vs editable by state/role
- This story is visibility-only; no edits required.
- If existing screens allow editing financial fields, those controls must be hidden when capability is false (even if backend would reject).

### Derived/calculated fields
- UI must not compute or display derived totals (e.g., subtotal, total cost, margin) when the underlying values are hidden.
- If a mixed-permission user can view pricing but not cost, UI may show price totals but must not show cost/margin totals.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui screen actions may call services directly rather than REST. This story requires a consistent capability signal and predictable error handling.

### Load/view calls
- **Work order load**: existing `WorkOrderEdit.xml` data load mechanism (service or REST) must provide:
  - Work order + line items
  - Either embedded `capabilities` OR a way to fetch capabilities separately

- **Capability load (preferred if not embedded)**:
  - A user context endpoint or screen action that returns stable capability flags for the current user (DECISION-INVENTORY-013).
  - Example shape:
    - `GET /rest/api/v1/me/capabilities?domain=workexec` ‚Üí `{ capabilities: { canViewPricing, canViewCost, canViewMargin } }`

### Create/update calls
- None in scope.

### Submit/transition calls
- None in scope.

### Error handling expectations (standardized)
- `401` ‚Üí route to login/session expired
- `403` ‚Üí access denied state (no data rendered)
- `404` ‚Üí ‚ÄúWork order not found‚Äù
- Capability call failure (5xx/timeout) ‚Üí apply fallback (hide sensitive) + show limited-visibility banner
- If backend uses standard error envelope (DECISION-INVENTORY-011), UI should capture `correlationId` for logs and optionally display it in a ‚ÄúDetails‚Äù expander for admins/support (non-sensitive).

---

## 10. State Model & Transitions

- Work order lifecycle is owned by workexec; started means `WO_IN_PROGRESS` or later (DECISION-INVENTORY-004).  
- This story does not add or change transitions.

### Allowed states
- Visibility rules apply in all work order statuses.

### Role-based transitions
- None in scope.

### UI behavior per state
- Independent of state: financial visibility is capability-based, not status-based.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing/invalid `workOrderId` in route ‚Üí show invalid route state and link back to board/list.

### Concurrency conflicts
- If load returns a conflict/stale indicator (implementation-dependent), show ‚ÄúRefresh‚Äù CTA; visibility rules still apply after refresh.

### Unauthorized access
- If user lacks base view permission:
  - Do not render cached data
  - Show access denied

### Empty states
- No line items ‚Üí show standard empty state; do not show placeholder totals that imply hidden financials.

### Capability misconfiguration / unavailable
- If capabilities cannot be determined:
  - Hide sensitive fields
  - Show limited-visibility banner
  - Emit client log event with correlationId (if available)

---

## 12. Acceptance Criteria

### Scenario 1: Restricted user cannot see pricing/cost/margin fields
**Given** a logged-in user with base permission to view a work order  
**And** the user‚Äôs resolved capabilities are `canViewPricing=false`, `canViewCost=false`, `canViewMargin=false`  
**When** the user opens `durion-workexec/WorkOrderEdit.xml` for an existing work order with line items  
**Then** the UI renders operational work order and line item fields  
**And** the UI does not render any pricing fields (`unitPrice`, `extendedPrice`, discounts, taxes)  
**And** the UI does not render any cost fields (`unitCost/cost`, `extendedCost`)  
**And** the UI does not render any margin fields (`marginAmount/margin`, `marginPercent`)  
**And** the UI does not render totals/subtotals that would reveal hidden values.

### Scenario 2: Authorized user sees pricing fields only
**Given** a logged-in user with base permission to view a work order  
**And** the user‚Äôs resolved capabilities are `canViewPricing=true`, `canViewCost=false`, `canViewMargin=false`  
**When** the user opens the work order screen  
**Then** the UI renders pricing fields and price-derived totals  
**And** the UI does not render cost or margin fields or cost/margin-derived totals.

### Scenario 3: Authorized user sees full financial fields
**Given** a logged-in user with base permission to view a work order  
**And** the user‚Äôs resolved capabilities are `canViewPricing=true`, `canViewCost=true`, `canViewMargin=true`  
**When** the user opens the work order screen for a work order that includes those values  
**Then** the UI renders pricing, cost, and margin fields where present  
**And** displayed values match the backend response (no client-side recomputation required for margin).

### Scenario 4: Capabilities unavailable defaults to safe (hide)
**Given** a logged-in user with base permission to view a work order  
**And** the capability signal cannot be resolved (missing from payload and capability endpoint fails/unavailable)  
**When** the user opens the work order screen  
**Then** the UI hides all sensitive financial fields and derived totals  
**And** the UI displays a non-sensitive banner indicating limited visibility due to policy unavailability  
**And** the UI emits a structured client log event `VISIBILITY_POLICY_FALLBACK_APPLIED` including any available `correlationId`.

### Scenario 5: User lacks base permission
**Given** a logged-in user without permission to view the work order  
**When** the user navigates to the work order screen  
**Then** the UI shows an access denied state  
**And** does not display any work order details or cached sensitive fields.

### Scenario 6: Accessibility‚Äîhidden means not in DOM
**Given** a restricted user (no financial capabilities)  
**When** the work order screen is rendered  
**Then** sensitive financial fields are not present in the DOM (not merely visually hidden)  
**And** screen readers cannot access hidden financial values.

---

## 13. Audit & Observability

### User-visible audit data
- Not required in UI for this story.

### Status history
- Not in scope.

### Traceability expectations
- Client-side structured logs (non-PII):
  - `VISIBILITY_POLICY_FALLBACK_APPLIED` when capabilities cannot be resolved
  - `SENSITIVE_FIELDS_RENDERED` when any financial capability is true (include which categories: pricing/cost/margin; do not include values)
- If backend provides `correlationId` (DECISION-INVENTORY-011), include it in logs and optionally show it in a support-only details area.

---

## 14. Non-Functional UI Requirements
- **Performance:** Capability resolution must not add more than one extra network call on initial load; cache capabilities for the session if fetched separately.
- **Accessibility:** Hidden fields must be removed from DOM; ensure focus order does not land on hidden controls.
- **Responsiveness:** Column/section hiding must work across desktop/tablet/mobile.
- **i18n/timezone/currency:** Currency formatting applies only when pricing is visible; do not show currency placeholders for hidden values.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty state messaging for ‚Äúno line items‚Äù; safe because it does not affect domain policy; impacts UX Summary, Alternate / Error Flows.
- SD-ERR-HTTP-MAP: Standard handling for 401/403/404 with user-friendly messages; safe because it is generic transport behavior; impacts Service Contracts, Alternate / Error Flows.
- SD-A11Y-DOM-REMOVE: Remove restricted fields from DOM rather than CSS hiding; safe because it strengthens confidentiality without changing policy; impacts Business Rules, Acceptance Criteria, Non-Functional.

---

## 16. Open Questions
1. **Capability signal source (blocking):** In this Moqui frontend, where do we get workexec capability flags?
   - Session claims, a `/me/capabilities` endpoint, or embedded in the work order payload?
2. **Canonical screens in scope (blocking):** Confirm which screens constitute ‚Äúexecution UI‚Äù in this repo:
   - Is `durion-workexec/WorkOrderEdit.xml` the execution screen, and does `WorkOrderBoard.xml` also need enforcement?
3. **Sensitive field inventory (blocking):** What exact financial fields exist today in the work order/line item UI and payloads (e.g., discounts, taxes, labor rate, fees, internal codes)?
4. **Capability names (blocking):** Confirm the exact capability keys/permission strings to use for:
   - pricing visibility
   - cost visibility
   - margin visibility
5. **Correlation ID availability (non-blocking):** Do current Moqui responses expose a `correlationId` (DECISION-INVENTORY-011), and if so, where should the frontend read it (header vs body)?
6. **Server-side omission semantics (non-blocking):** If backend omits sensitive fields, is omission guaranteed to mean ‚Äúnot authorized‚Äù vs ‚Äúnot applicable/null‚Äù? If ambiguous, we must rely on explicit capability flags.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #216: [FRONTEND] [STORY] Completion: Finalize Billable Scope Snapshot
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Completion: Finalize Billable Scope Snapshot (Finalize Work Order for Billing)

### Primary Persona
Service Advisor (primary), Manager/FinanceManager (variance approval / correction initiation if supported)

### Business Value
Create an immutable, versioned, invoice-ready snapshot of authorized completed work so invoicing uses a stable source of truth and is auditable, while blocking invalid billing (completed-but-unauthorized items) and gating price/tax variances.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** to finalize a Work Order for billing by creating a versioned Billable Scope Snapshot and marking items invoice-ready,  
**So that** Billing can generate an invoice from an immutable snapshot rather than mutable work order items, with a clear audit trail and variance controls.

### In-scope
- Frontend UI to initiate ‚ÄúFinalize for Billing‚Äù for a work order.
- Display of validation failures (completed-but-unauthorized items, no billable items, variance detected).
- Variance approval UI gate (capture reason code; require elevated permission where applicable).
- Display snapshot result (version, totals, createdBy/createdAt, variance flags) and expose for back office review.
- Read-only behavior expectations after finalization (work order/item editing blocked in this UI surface).
- Ability to view snapshot versions/history for a work order (list + open details).

### Out-of-scope
- Implementing invoice generation itself (billing domain).
- Defining pricing/tax calculation logic (backend responsibility); frontend only displays results/variance payload.
- Full ‚Äúcorrection workflow‚Äù implementation beyond initiating action if API exists.
- Notification delivery.

---

## 3. Actors & Stakeholders
- **Service Advisor**: initiates finalization; reviews variance and approves if permitted.
- **Manager / FinanceManager**: approves variance when elevated approval required; may initiate correction if supported.
- **Billing / Back Office**: views snapshot totals and versions for review.
- **Auditor**: relies on immutable snapshot and audit metadata.
- **System**: performs snapshot creation, versioning, and state transitions.

---

## 4. Preconditions & Dependencies
- User is authenticated in POS frontend.
- A Work Order exists and is in a state that permits finalization (backend-enforced).
- Work Order has work order items with execution/authorization status data available to UI (for pre-check display and/or backend error rendering).
- Backend endpoints exist for:
  - Finalize/create snapshot (and variance approval flow if separate).
  - Retrieve snapshot list/details by work order.
- Moqui screens framework routing and authz integration is configured for Work Order views.

**Dependencies / Contracts not provided in inputs (blocking)**
- Exact Moqui screen(s) to modify for Work Order detail in this repo (workexec canonical screens provided include `WorkOrderEdit.xml`, but this story references `WorkOrderDetail`).
- Exact Moqui service names and/or REST endpoints and payload schemas for snapshot finalization and retrieval.
- Authoritative Work Order status values for ‚Äúfinalized for billing‚Äù and ‚Äúeligible to finalize‚Äù (workexec FSM provided does not include billing-finalization states).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order edit/detail screen (workexec): primary action button **‚ÄúFinalize for Billing‚Äù** shown when eligible.
- From Work Order screen: link/tab **‚ÄúBillable Snapshot(s)‚Äù** visible when snapshots exist (and optionally always visible with empty state).

### Screens to create/modify
1. **Modify**: Work order screen in `durion-workexec` (canonical: `WorkOrderEdit.xml`)
   - Add ‚ÄúFinalize for Billing‚Äù action.
   - Add a ‚ÄúBillable Snapshot(s)‚Äù section/link and summary of active snapshot if present.
2. **Create**: `WorkOrderBillableSnapshots.xml` (new screen under `durion-workexec`)
   - List snapshots for a work order (version, status, totals, createdBy/createdAt, hasVariance).
3. **Create**: `BillableScopeSnapshotDetail.xml` (new screen under `durion-workexec`)
   - Read-only snapshot header + totals + variance metadata + line items.
4. **Optional (only if API exists now)**: `WorkOrderBillingCorrectionInitiate.xml` (dialog/screen)
   - Capture required reasonCode and submit correction initiation.

### Navigation context
- Nested under Work Order:
  - `/durion-workexec/workorders/WorkOrderEdit?workOrderId=<id>` (existing)
  - `/durion-workexec/workorders/WorkOrderBillableSnapshots?workOrderId=<id>`
  - `/durion-workexec/workorders/BillableScopeSnapshotDetail?snapshotId=<id>&workOrderId=<id>`
- ‚ÄúFinalize for Billing‚Äù remains on Work Order screen.

### User workflows (happy + alternate)
**Happy path**
1. Service Advisor opens Work Order.
2. Clicks ‚ÄúFinalize for Billing‚Äù.
3. Confirms in dialog.
4. UI calls finalize service with `Idempotency-Key`.
5. On success: UI shows confirmation, refreshes Work Order, and navigates to Snapshot Detail.

**Alternate paths**
- Completed-but-unauthorized items ‚Üí show blocking message listing items; no finalize.
- No billable items ‚Üí show blocking message; no finalize.
- Variance detected ‚Üí show variance details and gated approval action; after approval, finalize proceeds and snapshot created.
- Already finalized ‚Üí hide/disable finalize and offer ‚ÄúView Snapshot(s)‚Äù and active snapshot link.

---

## 6. Functional Behavior

### Triggers
- User clicks **Finalize for Billing** on an eligible Work Order.
- User clicks **Approve Variance & Finalize** when variance gate occurs (if supported by backend contract).

### UI actions
- Eligibility rendering:
  - Prefer backend-driven flags on Work Order load (e.g., `canFinalizeForBilling`, `hasActiveBillableSnapshot`, `activeBillableSnapshotId`).
  - If flags are not available, allow click and rely on backend error envelope to drive UX (still disable while in-flight).
- Finalize click:
  - Show confirm dialog: ‚ÄúFinalizing creates an immutable snapshot for invoicing. Continue?‚Äù
  - Submit finalize request with `Idempotency-Key` header (DECISION-INVENTORY-012).
- Variance gate:
  - Display variance details from backend response (header-level and/or line-level).
  - Collect `varianceReasonCode` (required) and optional free-text note if backend requires.
  - Submit approval/finalize request with `Idempotency-Key` (reuse same key on retry for the same attempt).

### State changes (frontend-visible)
- Work Order becomes ‚Äúfinalized for billing‚Äù (exact status TBD; backend authoritative).
- Work Order items included become invoice-ready (exact field/status TBD; backend authoritative).
- Snapshot list gains a new version marked `Active`; prior version becomes `Superseded` if correction re-finalize occurs.

### Service interactions
- Call finalize snapshot creation service.
- Call snapshot list/detail load services.
- If variance approval is separate: call variance approval service then re-attempt finalize (or a single finalize endpoint that accepts variance approval payload).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (UI responsibilities vs backend)
- **BR1: Completed but Unauthorized hard block**
  - UI must surface as a blocking error; do not present ‚Äúforce finalize‚Äù.
  - Error message must identify affected items (at minimum by description + ID).
  - Rationale: prevents invalid billing; backend authoritative; UI must not invent override policy (SAFE_DEFAULTS denylist).
- **BR2: No billable items**
  - UI shows blocking error: ‚ÄúNo billable items are available to be finalized.‚Äù
- **BR3: Price/Tax variance hard stop with approval gate**
  - UI must stop finalize flow and show variance details.
  - UI must require explicit user action to approve variance.
  - UI must collect `varianceReasonCode` (required) and pass via request.
  - If backend indicates elevated permission required, UI must show authorization error and instruct user to have a Manager/FinanceManager approve.
  - Rationale: permission gating must be capability-driven and backend-enforced (DECISION-INVENTORY-013).

### Enable/disable rules
- Disable ‚ÄúFinalize for Billing‚Äù when:
  - Work Order already has an active snapshot OR backend indicates finalized.
  - A finalize/approve call is in-flight (prevent double-submit; idempotency still required).
- Disable ‚ÄúApprove Variance & Finalize‚Äù until required fields are populated (at least `varianceReasonCode`).

### Visibility rules
- Snapshot panels/links visible when:
  - At least one snapshot exists; optionally always visible with empty state.
- Variance approval UI only visible when variance error/response indicates variance gating.

### Error messaging expectations
- Use user-safe language; do not leak internal stack traces.
- Normalize errors to standard envelope semantics (DECISION-INVENTORY-011):
  - `403`: ‚ÄúYou don‚Äôt have permission to approve this variance. Ask a Manager or Finance Manager.‚Äù
  - `409`: ‚ÄúThis work order changed since you loaded it. Refresh and try again.‚Äù
  - `400/422`: show field-level messages (reasonCode required, etc.).
  - If `existingResourceId` is returned on duplicate/‚Äúalready finalized‚Äù, offer navigation to that snapshot.

---

## 8. Data Requirements

### Entities involved (frontend read models)
- `durion.workexec.DurWorkOrder` (authoritative workexec entity)
- Work order line items (services/parts/labor) as implemented in workexec component (exact entity names TBD)
- `BillableScopeSnapshot` (entity name TBD; workexec-owned snapshot record)
- `BillableScopeSnapshotItem` (entity name TBD)
- Tax/fee detail structures as returned by backend (DTO/JSON)

### Fields (type, required, defaults)

**WorkOrder (minimum required for UI)**
- `workOrderId` (id/opaque string, required; DECISION-INVENTORY-003)
- `statusId` (string/enum, required)
- `canFinalizeForBilling` (boolean, optional but strongly recommended)
- `hasActiveBillableSnapshot` (boolean, optional)
- `activeBillableSnapshotId` (id, optional)
- `activeBillableSnapshotVersion` (number/int, optional)

**WorkOrderItem (for error display and invoice-ready confirmation)**
- `workOrderItemId` (id, required)
- `description` (string, required)
- `authorized` (boolean, required) OR `authorizationStatus` (enum, required)
- `executionStatus` (enum/string, required) including ‚Äúcompleted‚Äù
- `invoiceReady` (boolean, optional) OR `billingStatus` (enum, optional)

**BillableScopeSnapshot (header)**
- `snapshotId` (id, required)
- `workOrderId` (id, required)
- `snapshotVersion` (int, required)
- `snapshotStatus` (enum: `ACTIVE|SUPERSEDED|PENDING_REVIEW` or backend-defined, required)
- `subtotalAmount` (money/decimal+currency, required)
- `taxTotalAmount` (money, required)
- `feeTotalAmount` (money, required)
- `grandTotalAmount` (money, required)
- `hasVariance` (boolean, required)
- `varianceApprovedByUserId` (id, nullable)
- `varianceApprovedAt` (datetime, nullable)
- `varianceReasonCode` (string, nullable unless variance approved)
- `correctsSnapshotId` (id, nullable)
- `createdByUserId` (id, required)
- `createdAt` (datetime, required)

**BillableScopeSnapshotItem**
- `snapshotItemId` (id, required)
- `sourceWorkOrderItemId` (id, required)
- `description` (string, required)
- `quantity` (number/decimal, required; do not assume integer)
- `unitPrice` (money, required)
- `lineTotal` (money, required)
- `taxDetails` (json/structured, optional)
- `feeDetails` (json/structured, optional)

### Read-only vs editable by state/role
- Snapshot entities: always read-only in UI.
- Work Order and items: once finalized-for-billing (or active snapshot exists), this UI surface must treat items as read-only and hide/disable edit actions that would change billable scope. (Correction workflow, if any, is separate.)

### Derived/calculated fields
- UI may compute display-only sums from snapshot items for verification, but backend snapshot totals are authoritative.

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: exact Moqui service names / REST endpoints are not provided. Below defines required contract shapes and error semantics.

### Load/view calls
1. Load Work Order detail (existing workexec contract)
   - Must include `statusId` and snapshot summary flags/ids if available.
2. List snapshots for a Work Order
   - Request: `workOrderId`
   - Response: list of snapshot headers (version/status/totals/created metadata/hasVariance)
3. Load snapshot detail
   - Request: `snapshotId` (and optionally `workOrderId` for authorization scoping)
   - Response: snapshot header + items

### Create/update calls
1. Finalize for billing (create snapshot)
   - Request: `workOrderId`
   - Headers: `Idempotency-Key` required (DECISION-INVENTORY-012)
   - Body: optional `varianceApproval` object when approving inline:
     - `varianceReasonCode` (required when approving)
     - `varianceNote` (optional; only if backend requires)
   - Success: `200 OK` or `201 Created` returning:
     - `snapshotId`, `snapshotVersion`, `snapshotStatus`
     - totals
     - updated Work Order summary fields (or UI re-fetches Work Order)
2. Variance approval (if separate)
   - Request: `workOrderId` or `snapshotDraftId` (TBD)
   - Headers: `Idempotency-Key` required
   - Body: `varianceReasonCode` (+ optional note)
   - Success: returns updated eligibility to finalize or directly creates snapshot

### Submit/transition calls (Moqui transitions)
- On `WorkOrderEdit.xml`, add transitions:
  - `finalizeForBilling` (calls finalize service)
  - `viewBillableSnapshots` (navigates to list)
- On variance modal, transition:
  - `approveVarianceAndFinalize` (calls service; may be same as finalize with payload)

### Error handling expectations
- Errors must be normalized to standard envelope (DECISION-INVENTORY-011):
  - `code` (string), `message` (string), `correlationId` (string)
  - optional `fieldErrors[]` with `{field, message}`
  - optional `existingResourceId` (use to link to existing snapshot)
  - optional `details` for domain-specific payloads:
    - `unauthorizedItems[]` (id, description)
    - `variance` (header + line deltas; schema TBD)
- HTTP mapping:
  - `400/422`: validation failures (missing reason code, not eligible, etc.)
  - `403`: permission denied (finalize or variance approval)
  - `404`: work order/snapshot not found
  - `409`: conflict (already finalized, stale version, concurrent changes)

---

## 10. State Model & Transitions

### Allowed states
Workexec FSM (provided) includes:
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

**Billing finalization state gap (blocking)**
- This story requires a ‚Äúfinalized for billing‚Äù indicator. The provided FSM does not include `FINALIZED_FOR_BILLING` (or equivalent), and SAFE_DEFAULTS deny guessing lifecycle/state machines.
- Required resolution: confirm whether finalization is represented as:
  1) a new Work Order `statusId` value, or
  2) a separate snapshot presence flag only (active snapshot implies finalized), or
  3) both.

### Role-based transitions
- Service Advisor: can initiate finalize-for-billing if capability present.
- Manager/FinanceManager: can approve variance when elevated approval required; can initiate correction if supported.

### UI behavior per state
- If `hasActiveBillableSnapshot=true` (or equivalent):
  - Hide/disable finalize action.
  - Show link to active snapshot and snapshot list.
- If Work Order is not eligible (backend flag false or backend returns not-eligible error):
  - Hide finalize action or show disabled with tooltip ‚ÄúWork must be completed before finalizing for billing.‚Äù

---

## 11. Alternate / Error Flows

### Validation failures
1. **Completed but Unauthorized items exist**
   - Show blocking error with list of items requiring authorization/removal.
   - Provide navigation to items section (anchor) but do not implement authorization changes in this story.
2. **No billable items**
   - Show error and keep user on Work Order screen.
3. **Variance detected**
   - Show variance modal with details and required approval.
   - If user lacks permission, show 403-style messaging and stop.

### Concurrency conflicts
- If finalize returns `409` because snapshot already exists / version advanced:
  - Reload Work Order and snapshots.
  - Navigate to active snapshot if `existingResourceId` provided or active snapshot id is available on refresh.
  - Show message: ‚ÄúWork order was already finalized.‚Äù

### Unauthorized access
- If user lacks permission to finalize:
  - Hide action if capability flags exist; otherwise show error on attempt and keep action disabled thereafter until refresh.

### Empty states
- Snapshot list empty: show ‚ÄúNo billable snapshots yet.‚Äù
- Snapshot detail not found: show not found and link back to Work Order.

---

## 12. Acceptance Criteria

### Scenario 1: Finalize creates snapshot and marks invoice-ready (happy path)
**Given** a Work Order is eligible for billing finalization per backend eligibility  
**And** the Work Order has items that are completed and authorized per backend rules  
**When** the Service Advisor clicks ‚ÄúFinalize for Billing‚Äù and confirms  
**Then** the system creates a new Billable Scope Snapshot with the next sequential version and status `ACTIVE` (or backend-defined active status)  
**And** the UI navigates to the Snapshot Detail view showing snapshot totals and createdBy/createdAt  
**And** the Work Order view reflects that it is finalized for billing (via active snapshot indicator and/or status)  
**And** the included Work Order items reflect invoice-ready/billing-ready state after refresh

### Scenario 2: Hard block when any completed item is not authorized
**Given** a Work Order has at least one item that is completed but not authorized  
**When** the Service Advisor attempts to ‚ÄúFinalize for Billing‚Äù  
**Then** the finalization request fails and no snapshot is created  
**And** the UI shows a blocking error identifying the unauthorized completed item(s) (id + description)  
**And** the UI does not offer a ‚Äúforce finalize‚Äù option

### Scenario 3: Block when no billable items exist
**Given** a Work Order has no items that are both completed and authorized per backend rules  
**When** the Service Advisor attempts to ‚ÄúFinalize for Billing‚Äù  
**Then** the request fails  
**And** the UI shows ‚ÄúNo billable items are available to be finalized.‚Äù  
**And** no new snapshot appears in the snapshot list after refresh

### Scenario 4: Variance detected requires explicit approval before snapshot creation
**Given** a Work Order has completed and authorized items  
**And** the backend detects a price or tax variance versus the authorized basis  
**When** the Service Advisor attempts to ‚ÄúFinalize for Billing‚Äù  
**Then** the UI shows a variance blocking modal including variance details returned by the backend  
**And** the UI requires a variance reason code before enabling ‚ÄúApprove Variance & Finalize‚Äù  
**When** the user submits variance approval with a reason code  
**Then** the snapshot is created with `hasVariance=true`  
**And** variance approval metadata (approvedBy/approvedAt/reasonCode) is visible on the snapshot detail

### Scenario 5: Variance approval requires elevated permission
**Given** the backend indicates elevated permission is required to approve the variance  
**When** a user without that capability attempts to approve the variance  
**Then** the request is rejected with `403`  
**And** the UI instructs the user to have a Manager/FinanceManager approve  
**And** no snapshot is created

### Scenario 6: Snapshot versions are viewable for back office review
**Given** a Work Order has one or more billable snapshots  
**When** the user opens ‚ÄúBillable Snapshot(s)‚Äù from the Work Order  
**Then** the UI lists snapshots with version, status, totals, and created metadata  
**And** selecting a snapshot opens a read-only detail view with line items and totals  
**And** the UI displays `sourceWorkOrderItemId` for each snapshot line (directly or via expandable details)

### Scenario 7: Idempotency prevents duplicate snapshots on double-submit
**Given** a Work Order is eligible for finalization  
**When** the Service Advisor double-clicks ‚ÄúFinalize for Billing‚Äù (or retries after a network timeout)  
**Then** the UI reuses the same `Idempotency-Key` for the same attempt  
**And** the backend returns a single created snapshot outcome (no duplicate versions created)  
**And** the UI navigates to the created snapshot

### Scenario 8: Concurrency‚Äîalready finalized by another user
**Given** the Work Order is finalized by another user while the Service Advisor is viewing it  
**When** the Service Advisor attempts to finalize  
**Then** the UI receives a `409` conflict (or equivalent duplicate/finalized error)  
**And** the UI refreshes and navigates to the active snapshot when available  
**And** the UI shows a message indicating it was already finalized

---

## 13. Audit & Observability

### User-visible audit data
- Snapshot detail displays:
  - `snapshotVersion`, `snapshotStatus`
  - `createdByUserId` (render as username if available) and `createdAt`
  - `hasVariance` and, if true: `varianceApprovedByUserId`, `varianceApprovedAt`, `varianceReasonCode`
  - `correctsSnapshotId` if present (link to prior snapshot)

### Status history
- Snapshot list provides version history; if correction exists, show relationship (e.g., ‚ÄúCorrects v1‚Äù).

### Traceability expectations
- Snapshot items display `sourceWorkOrderItemId`.
- UI logs/telemetry:
  - Include `correlationId` from error envelope in user-visible error details (copyable) and in frontend logs.
  - Send `Idempotency-Key` on finalize/approve calls and log it client-side for support correlation (do not expose to end users by default).

---

## 14. Non-Functional UI Requirements
- **Performance**: Snapshot list and detail render within 2s for up to 200 snapshot items; if more, use pagination or virtualized rendering.
- **Accessibility**: Modal dialogs are focus-trapped; buttons have accessible names; errors announced via ARIA live region.
- **Responsiveness**: Works on tablet resolutions used at service desk.
- **i18n/timezone/currency**:
  - Currency formatting uses store/user locale settings when available.
  - Timestamps display in user timezone (DECISION-INVENTORY-016) and label the timezone used.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for snapshot list/detail; safe UI ergonomics; impacts UX Summary, Alternate/Empty states.
- SD-UX-INFLIGHT-GUARD: Disable submit buttons during in-flight finalize/approve calls to prevent double submit; safe because it doesn‚Äôt alter domain rules; impacts Functional Behavior, Error Flows.
- SD-ERR-HTTP-MAP: Standard mapping of 400/403/404/409 to user messaging using the standard error envelope; safe because it follows implied backend contract; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Moqui screen routing (blocking):** Which exact existing workexec screen is the Work Order ‚Äúdetail‚Äù surface in this repo (confirm `WorkOrderEdit.xml` vs another screen), and what is the canonical route/menu path to it?
2. **Finalize contract (blocking):** What are the exact Moqui service names and/or REST endpoints for:
   - finalizing for billing (snapshot creation),
   - listing snapshots by work order,
   - loading snapshot detail,
   - variance approval (inline vs separate)?
   Include request/response schemas and HTTP statuses.
3. **Finalization indicator (blocking):** Is ‚Äúfinalized for billing‚Äù represented as:
   - a new `DurWorkOrder.statusId` value,
   - an `activeBillableSnapshotId` presence flag only,
   - or both?
   Provide authoritative enum/field names so UI can render deterministically.
4. **Eligibility rule source (blocking):** What backend field(s) indicate eligibility to finalize (e.g., `canFinalizeForBilling`, `isCompleted`, `isStarted`), and which work order statuses are eligible?
5. **Variance payload schema (blocking):** When variance is detected, what structured fields are returned for display (header-level vs line-level deltas, tax/fee breakdown, and whether elevated approval is required)?
6. **Variance reason codes (blocking):** Is `varianceReasonCode` sourced from a controlled list? If yes, what endpoint/entity provides the list and what are the codes? Is free-text also required?
7. **Item ‚Äúinvoice-ready‚Äù representation (blocking):** What exact field/status indicates an item is invoice-ready after finalization (boolean vs status enum), and is it on each item or derived from snapshot membership?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #162: [FRONTEND] [STORY] Billing: Enforce PO Requirement During Estimate Approval
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Workexec: Enforce Purchase Order (PO) Requirement During Estimate Approval

## Primary Persona
Service Advisor

## Business Value
Reduce billing exceptions and rework by preventing estimate approval when customer billing rules mandate a PO, and ensure the captured PO reference is available downstream (e.g., invoice display).

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor
- **I want** the Estimate approval flow to require a PO number (and optionally a PO attachment reference) when the customer‚Äôs billing rules mandate it
- **So that** non-compliant estimates cannot be approved and downstream billing/invoicing has the PO reference.

## In-scope
- Frontend changes to the **Estimate approval step** in the existing Moqui workexec estimate screen to:
  - Determine whether PO is required (prefer explicit backend-provided requirement signal; fallback to ‚Äúlearn from backend validation error‚Äù).
  - Capture `poNumber` and optional `attachmentId` (reference only; no upload).
  - Block approval client-side where possible and **always** handle backend validation failures deterministically using the standard error envelope (DECISION-INVENTORY-011).
  - Display stored PO reference on approved estimate views (and on work order view if the work order payload includes it).
- Idempotent submit behavior for approval (send `Idempotency-Key` per DECISION-INVENTORY-012).
- Concurrency-safe behavior (handle 409 conflicts deterministically).

## Out-of-scope
- Implementing or changing CRM billing rule configuration UI.
- Implementing attachment upload/storage system (only capturing an `attachmentId` reference if provided).
- Any backend changes (this story assumes backend already enforces PO requirement and returns stable error codes).
- Creating new invoice rendering routes; only display PO reference **if** the existing invoice/work order/estimate payload already includes it.

---

# 3. Actors & Stakeholders
- **Primary actor:** Service Advisor (approves estimates, enters PO)
- **Secondary stakeholders:**
  - Billing/Accounting (consumes PO reference downstream)
  - Admin/Support (troubleshoot configuration/rule failures)
- **Systems involved:**
  - Workexec (estimate approval UI + approval submit; authoritative for estimate lifecycle per `CUSTOMER_APPROVAL_WORKFLOW.md`)
  - Billing rules provider (upstream dependency; may be CRM or another service‚Äîworkexec consumes it)

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated.
- User has capability/permission to approve estimates (UI gating via capability signal when available; backend authoritative with 403 per DECISION-INVENTORY-013).
- An Estimate exists and is in an approval-eligible state (`DRAFT` per `CUSTOMER_APPROVAL_WORKFLOW.md`).
- Estimate is associated to a customer/account such that workexec can evaluate billing rules.

## Dependencies
- **Canonical Moqui screen**: Estimate approval occurs in `durion-workexec/EstimateEdit.xml` (DECISION-INVENTORY-002).
- Backend endpoints (paths must be confirmed; see Open Questions):
  - Estimate load: `GET /api/estimates/{id}` (as referenced in original story; may be `/rest/api/v1/workexec/estimates/{id}` in Moqui REST conventions‚Äîneeds confirmation).
  - Estimate approve: `POST /api/v1/estimates/{id}/approve?approvedBy={userId}` (as referenced in original story; needs confirmation).
- Backend error contract:
  - Standard error envelope with `code`, `message`, `correlationId`, optional `fieldErrors[]`, optional `existingResourceId` (DECISION-INVENTORY-011).
- Capability signal source:
  - A user context/capabilities endpoint or session claims that can provide a stable flag for ‚Äúcan approve estimate‚Äù (DECISION-INVENTORY-013). If not available, UI still attempts and handles 403.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From the existing Estimate edit/detail screen:
  - `durion-workexec/EstimateEdit.xml` opened with `estimateId` parameter.
  - Primary action: ‚ÄúApprove Estimate‚Äù (existing action).

## Screens to create/modify
- **Modify** `durion-workexec/EstimateEdit.xml`
  - Add a ‚ÄúPurchase Order‚Äù section within the approval area.
  - Add validation messaging and submit wiring to include PO reference when approving.
- **Modify (optional, only if already present and in-scope)** any existing workexec read-only summary panel(s) on:
  - `durion-workexec/EstimateEdit.xml` (approved state)
  - `durion-workexec/WorkOrderEdit.xml` (if it already displays estimate-derived fields and the payload includes PO reference)

## Navigation context
- User is already in a specific estimate context (`estimateId`).
- After successful approval:
  - Remain on `EstimateEdit` with refreshed data showing `APPROVED` state (do not introduce new navigation).
  - If existing behavior redirects elsewhere, preserve existing behavior and ensure PO reference is visible wherever the user lands (requires confirmation of current flow).

## User workflows (happy + alternate paths)

### Happy path (PO required)
1. Service Advisor opens `EstimateEdit` for a `DRAFT` estimate.
2. UI shows PO section; requirement indicator is shown if backend provides `isPoRequired=true` (preferred) or after a first failed approval attempt indicating missing PO (fallback).
3. Service Advisor enters PO number; optionally enters attachment reference.
4. Service Advisor clicks Approve.
5. UI submits approval with `Idempotency-Key`.
6. Approval succeeds; UI refreshes estimate; status shows `APPROVED`; PO reference is displayed read-only.

### Happy path (PO not required)
1. Service Advisor approves without entering PO.
2. Approval succeeds; PO reference remains empty/null.

### Alternate path (rule unavailable / not configured)
1. Service Advisor attempts approval.
2. Backend returns a rule/config error.
3. UI blocks completion, shows actionable message and retry guidance (for retryable errors) or admin guidance (for non-configured).

### Alternate path (user lacks permission)
1. Service Advisor attempts approval.
2. Backend returns 403.
3. UI shows blocking message and keeps estimate unchanged.

---

# 6. Functional Behavior

## Triggers
- User clicks ‚ÄúApprove Estimate‚Äù on `EstimateEdit`.

## UI actions
- Provide inputs in PO section:
  - `poNumber` (string)
  - `attachmentId` (string; treated as opaque ID unless backend explicitly requires UUID format‚Äîsee Open Questions)
- Provide ‚ÄúApprove‚Äù action that:
  - Validates inputs client-side (advisory).
  - Submits approval request with PO payload (shape must match backend).
  - Uses `Idempotency-Key` header for the submit attempt (DECISION-INVENTORY-012).
  - Disables the Approve button while request is in-flight.

## State changes (frontend-visible)
- On success:
  - Refresh estimate record (or use response payload if it returns updated estimate).
  - Update displayed status to `APPROVED`.
  - Display saved `purchaseOrderReference` read-only.
- On failure:
  - No optimistic status change.
  - Inline field errors for PO/attachment validation failures.
  - Blocking banner for rule/config errors and authorization errors.
  - On 409 conflict: refresh estimate and show ‚Äúupdated by another user‚Äù message.

## Service interactions
- Load estimate on screen entry (existing behavior).
- Submit approval via approve endpoint.
- Refresh estimate after approval success (unless approve response includes full updated estimate).

---

# 7. Business Rules (Translated to UI Behavior)

## Validation (client-side, non-authoritative)
Backend is authoritative; client validation is to reduce round-trips.

### PO requirement determination
- Preferred: use explicit backend-provided boolean flag on estimate payload (e.g., `purchaseOrderRequirement.isRequired`).
- Fallback: if backend returns `PurchaseOrderNumberMissing`, set UI-only `isPoRequired=true` for this estimate for the remainder of the session/view.

### PO number validation (only when `isPoRequired=true`)
- Required: non-empty after trim.
- Max length: 64 characters (as per original story; must match backend‚Äîsee Open Questions).
- Format: do **not** enforce a regex unless backend contract confirms it. UI may show a generic ‚Äúinvalid format‚Äù message when backend returns `PurchaseOrderNumberInvalidFormat`.

### Attachment reference validation
- Treat `attachmentId` as an opaque string ID by default (DECISION-INVENTORY-003) **unless** backend explicitly requires UUID format.
- If backend requires UUID, validate UUID format client-side and block submit when invalid.

## Enable/disable rules
- Disable Approve while request is in-flight.
- If `isPoRequired=true` and `poNumber` is empty/too long, disable Approve until corrected.
- If attachmentId format is invalid per confirmed backend contract, disable Approve until corrected.

## Visibility rules
- PO section is visible on `EstimateEdit` in all states:
  - In `DRAFT`: editable inputs.
  - In `APPROVED`/`DECLINED`/`EXPIRED`: read-only display of stored values (or ‚ÄúNone‚Äù).
- ‚ÄúRequired‚Äù indicator:
  - Shown when backend provides requirement flag or after a missing-PO backend error.

## Error messaging expectations (mapping to backend errors)
All errors are parsed from the standard envelope (DECISION-INVENTORY-011) and mapped:

- `PurchaseOrderNumberMissing` ‚Üí inline on PO number: ‚ÄúPO number is required to approve this estimate.‚Äù
- `PurchaseOrderNumberInvalidFormat` ‚Üí inline: ‚ÄúPO number format is invalid.‚Äù
- `PurchaseOrderNumberTooLong` ‚Üí inline: ‚ÄúPO number must be 1‚Äì64 characters.‚Äù
- `BillingRuleUnavailable` ‚Üí blocking banner: ‚ÄúCannot verify PO requirement right now. Please try again.‚Äù
- `BillingRuleNotConfigured` ‚Üí blocking banner: ‚ÄúBilling rules are not configured for this customer; approval is blocked. Contact an administrator.‚Äù
- Attachment errors:
  - `PurchaseOrderAttachmentInvalidId` ‚Üí inline: ‚ÄúAttachment reference is invalid.‚Äù
  - `PurchaseOrderAttachmentNotFound` ‚Üí inline: ‚ÄúAttachment not found.‚Äù
  - `PurchaseOrderAttachmentUnauthorized` ‚Üí inline: ‚ÄúYou do not have access to that attachment.‚Äù
- Generic:
  - 403 ‚Üí ‚ÄúYou are not authorized to approve estimates.‚Äù
  - 404 ‚Üí ‚ÄúEstimate not found.‚Äù
  - 409 ‚Üí ‚ÄúThis estimate was updated by another user; please review the current status.‚Äù

---

# 8. Data Requirements

## Entities involved
- Workexec Estimate (system of record for estimate approval state per `CUSTOMER_APPROVAL_WORKFLOW.md`)

## Fields (types, required, defaults)

### Estimate (read)
- `estimateId` (id/opaque string) ‚Äî required
- `status` (enum: `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`) ‚Äî required
- `purchaseOrderReference` (object, nullable) ‚Äî optional
  - `poNumber` (string) ‚Äî optional
  - `attachmentId` (id/opaque string) ‚Äî optional
- `canApprove` (boolean) ‚Äî optional (capability signal; if present, use for UI gating)
- `purchaseOrderRequirement` (object) ‚Äî optional (preferred; see Open Questions)
  - `isRequired` (boolean)

### Inputs (editable in `DRAFT` only)
- `poNumber` (string)
  - required: conditionally when PO required
  - default: empty
- `attachmentId` (string)
  - required: no
  - default: empty

## Read-only vs editable by state/role
- `DRAFT`:
  - Service Advisor: can edit PO fields and submit approval if permitted.
- `APPROVED`/`DECLINED`/`EXPIRED`:
  - PO fields are read-only.
- If backend allows reopen to `DRAFT` (per workflow), PO fields become editable again when status returns to `DRAFT` (no additional policy assumed).

## Derived/calculated fields
- `isPoRequired` (UI-only)
  - Derived from `purchaseOrderRequirement.isRequired` if present, else from last backend error indicating missing PO.

---

# 9. Service Contracts (Frontend Perspective)

> Moqui implementation should use screen actions/transitions and service calls consistent with existing `durion-workexec` patterns. Exact service names are not assumed; HTTP contracts are specified for integration.

## Load/view calls
### Load estimate
- `GET <estimate-load-endpoint>/{estimateId}`
- Response must include:
  - `estimateId`, `status`
  - `purchaseOrderReference` (nullable)
  - Optional: `purchaseOrderRequirement.isRequired`
  - Optional: `canApprove` or equivalent capability signal

## Submit/transition calls
### Approve estimate
- `POST <estimate-approve-endpoint>/{estimateId}/approve?approvedBy={userId}`
- Headers:
  - `Idempotency-Key: <uuid>` (DECISION-INVENTORY-012)
- Request body (one of the following; must match backend‚Äîsee Open Questions):
  - Option A (nested):
    ```json
    {
      "purchaseOrderReference": {
        "poNumber": "string",
        "attachmentId": "string (optional)"
      }
    }
    ```
  - Option B (flat):
    ```json
    {
      "poNumber": "string",
      "attachmentId": "string (optional)"
    }
    ```

- Success:
  - 200 OK with updated estimate payload (preferred), OR
  - 204 No Content (then UI must reload estimate), OR
  - 201 Created (unlikely for approve; if used, treat as success and reload)

## Error handling expectations
- Errors conform to standard envelope (DECISION-INVENTORY-011):
  ```json
  {
    "code": "PurchaseOrderNumberMissing",
    "message": "‚Ä¶",
    "correlationId": "‚Ä¶",
    "fieldErrors": [{"field":"purchaseOrderReference.poNumber","message":"‚Ä¶"}]
  }
  ```
- HTTP mapping:
  - 400: validation errors
  - 403: unauthorized
  - 404: not found
  - 409: conflict (stale state / already approved)
  - 503: billing rule unavailable (retryable)

---

# 10. State Model & Transitions

## Allowed states (Estimate)
Per `CUSTOMER_APPROVAL_WORKFLOW.md`:
- `DRAFT`
- `APPROVED`
- `DECLINED`
- `EXPIRED`

## Allowed transitions relevant to this story
- `DRAFT` ‚Üí `APPROVED` via approve
  - This story enforces PO requirement at this boundary (UI + backend validation handling).

## Role-based transitions
- Service Advisor initiates approval when permitted.
- UI gating:
  - If capability signal exists (DECISION-INVENTORY-013), hide/disable Approve when `canApprove=false`.
  - Backend remains authoritative; handle 403.

## UI behavior per state
- `DRAFT`: show editable PO inputs + Approve action.
- `APPROVED`: show PO reference read-only; approval action hidden/disabled.
- `DECLINED`/`EXPIRED`: approval action hidden/disabled; PO reference read-only if present.

---

# 11. Alternate / Error Flows

## Validation failures
- Missing/invalid PO when required:
  - If `isPoRequired=true`: block submit client-side for empty/too-long.
  - If not known required: submit may fail; on `PurchaseOrderNumberMissing`, show inline error and set `isPoRequired=true`.

## Concurrency conflicts (409)
- If approve returns 409:
  - UI reloads estimate.
  - UI shows message: ‚ÄúThis estimate was updated by another user; please review the current status.‚Äù
  - If status is now `APPROVED`/`DECLINED`/`EXPIRED`, disable approval and show read-only state.

## Unauthorized access (403)
- Show blocking message and keep user on page.
- Do not change UI state optimistically.

## Rule unavailable / not configured
- `BillingRuleUnavailable` (503):
  - Show retryable banner with ‚ÄúTry again‚Äù action.
- `BillingRuleNotConfigured`:
  - Show non-retryable banner instructing to contact admin/support.

## Empty states
- If `purchaseOrderReference` is null:
  - Display ‚ÄúNone‚Äù in read-only contexts.

---

# 12. Acceptance Criteria

## Scenario 1: PO required and provided ‚Üí approval succeeds
**Given** an estimate is in `DRAFT`  
**And** the backend indicates PO is required (via explicit flag or by enforcing on approve)  
**And** the Service Advisor enters a non-empty PO number within the backend‚Äôs allowed length  
**When** the Service Advisor submits approval  
**Then** the UI sends an approve request including the PO reference fields in the backend-required shape  
**And** the request includes an `Idempotency-Key` header  
**And** the estimate status is shown as `APPROVED` after refresh  
**And** the stored PO number is displayed read-only on the approved estimate view.

## Scenario 2: PO required and missing ‚Üí approval blocked with inline error
**Given** an estimate is in `DRAFT`  
**And** PO is required by backend billing rules  
**When** the Service Advisor attempts approval without a PO number  
**Then** the approval does not complete  
**And** the UI displays an inline error mapped from backend `PurchaseOrderNumberMissing`  
**And** the estimate remains not approved in the UI.

## Scenario 3: PO not required ‚Üí approval succeeds without PO
**Given** an estimate is in `DRAFT`  
**And** PO is not required by backend billing rules  
**When** the Service Advisor approves without providing a PO number  
**Then** the approval succeeds  
**And** the refreshed estimate shows `purchaseOrderReference` as empty/null (or absent)  
**And** the UI displays ‚ÄúNone‚Äù for PO reference in read-only display.

## Scenario 4: Billing rule unavailable ‚Üí fail-safe blocks approval and suggests retry
**Given** an estimate is in `DRAFT`  
**When** the Service Advisor attempts approval and the backend returns `BillingRuleUnavailable` with HTTP 503  
**Then** the UI shows a blocking retryable message  
**And** the estimate remains unapproved  
**And** the user can retry approval without leaving the screen.

## Scenario 5: Conflict on approval ‚Üí UI refreshes and shows current status
**Given** an estimate is in `DRAFT`  
**And** another user approves or declines the estimate before this user submits approval  
**When** the Service Advisor submits approval and the backend returns HTTP 409  
**Then** the UI reloads the estimate  
**And** the UI shows a conflict message instructing the user to review the current status  
**And** the Approve action is disabled if the estimate is no longer `DRAFT`.

## Scenario 6: Unauthorized approval attempt ‚Üí blocked with 403 message
**Given** a user without approval permission views an estimate  
**When** the user attempts to approve and the backend returns HTTP 403  
**Then** the UI shows a blocking ‚Äúnot authorized‚Äù message  
**And** the estimate remains unchanged in the UI.

---

# 13. Audit & Observability

## User-visible audit data
- On approval failure, show a stable reason derived from backend `code`.
- Do not show stack traces or raw payloads.

## Status history
- No new history UI required.
- If the screen already shows approval metadata (approvedBy/approvedAt), ensure PO display does not obscure it.

## Traceability expectations
- If backend returns `correlationId` in error envelope, display it in an expandable ‚ÄúDetails‚Äù area for support copy/paste.
- Frontend logging:
  - Log `estimateId`, outcome (success/failure), `code`, `correlationId`.
  - Do **not** log PO number or attachmentId.

---

# 14. Non-Functional UI Requirements

- **Performance:** Approve action shows immediate loading state; prevent double-submit.
- **Accessibility:** Field labels and error associations; keyboard navigable; focus moves to first invalid field on submit.
- **Responsiveness:** PO inputs usable on tablet layouts.
- **i18n:** Error strings should use existing message/i18n mechanism if present; otherwise keep strings centralized for later extraction.

---

# 15. Applied Safe Defaults

- Default ID: UI-ERG-EMPTYSTATE-01  
  - What was assumed: When no PO reference exists, display ‚ÄúNone‚Äù rather than blank.  
  - Why it qualifies as safe: Presentational only; no domain behavior change.  
  - Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.

- Default ID: UI-ERG-LOADING-01  
  - What was assumed: Disable Approve while request is in-flight and show a loading indicator.  
  - Why it qualifies as safe: Prevents duplicate submissions without changing business rules.  
  - Impacted sections: Functional Behavior, Non-Functional UI Requirements, Acceptance Criteria.

- Default ID: ERR-MAP-STD-01  
  - What was assumed: Parse errors using the standard envelope (`code`, `message`, `correlationId`, optional `fieldErrors`).  
  - Why it qualifies as safe: Derived from domain decision DECISION-INVENTORY-011; improves determinism.  
  - Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows, Audit & Observability.

- Default ID: IDEMPOTENCY-UI-01  
  - What was assumed: UI generates and sends `Idempotency-Key` for approve submit and reuses it on retry of the same attempt.  
  - Why it qualifies as safe: Required by DECISION-INVENTORY-012; prevents duplicate transitions.  
  - Impacted sections: Functional Behavior, Service Contracts, Acceptance Criteria.

---

# 16. Open Questions

1. **Endpoint canonicalization (blocking):** What are the exact Moqui/REST paths for:
   - Load estimate by id
   - Approve estimate (including whether it is `/api/...` or `/rest/api/v1/...`)
2. **Approve request payload shape (blocking):** Does approve accept a JSON body, and if so is PO reference nested (`purchaseOrderReference`) or flat fields? If body is not supported, what is the supported mechanism?
3. **PO requirement signal (blocking):** Does the estimate load response include an explicit ‚ÄúPO required‚Äù flag/config (preferred), or must UI infer requirement only after a failed approval attempt?
4. **Attachment reference ID type (blocking):** Is `attachmentId` an opaque string ID (preferred per DECISION-INVENTORY-003) or strictly a UUID? If UUID, confirm validation rules and max length.
5. **Downstream visibility scope (non-blocking but needs decision):** Which existing screen(s) constitute ‚Äúinvoice display‚Äù in this repo, and does their payload already include PO reference? If not, should invoice display be a separate story under `domain:billing`?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #157: [FRONTEND] [STORY] Integration: Emit CRM Reference IDs in Workorder Artifacts
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Capture & Persist CRM Reference IDs on Estimate/Work Order Artifacts

### Primary Persona
System User (Service Advisor / POS User) operating the POS frontend

### Business Value
Ensures every Estimate and Work Order created/edited in the POS has durable CRM reference IDs (party, vehicle, contacts) for traceability and reporting, and preserves the original IDs even if CRM later merges entities.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor (POS user)  
- **I want** the Estimate and Work Order creation/edit flows to capture and send CRM reference IDs (`crmPartyId`, `crmVehicleId`, `crmContactIds`) to the backend and show them read-only on artifacts  
- **So that** work artifacts can always be correlated back to CRM records for reporting and audit, even if CRM later merges/aliases records.

### In-scope
- Frontend data-model + UI changes to:
  - include `crmPartyId`, `crmVehicleId`, `crmContactIds` in relevant create/update requests for **Estimates** and **Work Orders**
  - display these fields on Estimate/Work Order detail views as read-only ‚Äúintegration references‚Äù
- Frontend validation and error handling for missing required CRM IDs where backend requires them.
- Ensure update flows do not accidentally drop CRM reference fields (preserve on submit).

### Out-of-scope
- Implementing CRM merge/alias resolution logic in the workexec backend or frontend.
- Defining or changing CRM system-of-record policies, identifier formats, or merge rules.
- Adding new workflow states to work orders/estimates.
- Any time-entry/people scheduling features.

---

## 3. Actors & Stakeholders
- **Actors**
  - Service Advisor / POS User: creates/edits estimates and work orders via Moqui screens.
  - POS Frontend (Moqui): collects CRM references from existing customer/vehicle/contact context and sends to backend.
- **Stakeholders**
  - Reporting/Analytics: relies on stable stored IDs.
  - Audit/Compliance: needs traceability between work artifact and CRM entities.
  - CRM System: authoritative for party/vehicle/contact entities and merge/alias resolution.

---

## 4. Preconditions & Dependencies
- A customer and vehicle are selected in the POS flow prior to creating an Estimate and/or Work Order (source of `crmPartyId` and `crmVehicleId`).
- The frontend has access to:
  - current selected customer‚Äôs CRM party ID
  - current selected vehicle‚Äôs CRM vehicle ID
  - associated contact IDs (0..n)
- Workexec screens exist and are the canonical UI surfaces:
  - `durion-workexec/EstimateEdit.xml`
  - `durion-workexec/WorkOrderEdit.xml`
  - (Navigation may originate from `durion-workexec/WorkOrderBoard.xml` but this story modifies edit/detail screens.)
- Backend endpoints/services exist (or will exist) to accept these fields on create/update:
  - Estimate create/update
  - Work Order create/update (including conversion from Estimate ‚Üí Work Order)
- Standard error envelope is expected for REST calls (Decision: DECISION-INVENTORY-011), but Moqui screen actions may still return framework errors; frontend must normalize where applicable.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Estimate creation flow (from customer/vehicle context)
- Estimate detail/edit screen (`EstimateEdit.xml`)
- Work Order creation flow (direct or via conversion from approved Estimate)
- Work Order detail/edit screen (`WorkOrderEdit.xml`)

### Screens to create/modify
- **Modify** `durion-workexec/EstimateEdit.xml`
  - Ensure CRM reference IDs are included in create/update submissions.
  - Add a read-only ‚ÄúCRM References‚Äù section on the estimate detail/edit screen.
- **Modify** `durion-workexec/WorkOrderEdit.xml`
  - Ensure CRM reference IDs are included in create/update submissions.
  - Add a read-only ‚ÄúCRM References‚Äù section on the work order detail/edit screen.
- **No new top-level navigation**; fields appear in existing artifact screens.

### Navigation context
- CRM references are displayed as artifact metadata (read-only) and must not interrupt primary estimate/work order workflows.

### User workflows (happy + alternate)
- **Happy path (Estimate create)**
  1. User selects customer + vehicle (and optionally contacts).
  2. User creates an Estimate in `EstimateEdit`.
  3. Frontend submits estimate with `crmPartyId`, `crmVehicleId`, `crmContactIds`.
  4. Estimate screen shows stored CRM references read-only.
- **Happy path (Work Order create/convert)**
  1. User creates Work Order directly in `WorkOrderEdit` or converts from an approved Estimate.
  2. Frontend ensures the Work Order submission includes CRM references.
  3. Work Order screen shows stored CRM references read-only.
- **Alternate path (contacts empty)**
  - User has no contacts selected; frontend sends `crmContactIds: []` (non-null).
- **Legacy record view**
  - Older Estimate/WO without CRM refs: show ‚ÄúNot set‚Äù and do not block viewing/editing unrelated fields.

---

## 6. Functional Behavior

### Triggers
- Submitting Estimate create
- Submitting Estimate update (where allowed by state/permissions)
- Submitting Work Order create
- Submitting Work Order update (where allowed by state/permissions)
- Converting Estimate ‚Üí Work Order (if exposed as a UI action)

### UI actions
- On load of Estimate/WO: display CRM reference fields read-only.
- On submit:
  - include CRM IDs in request payload consistently.
  - if missing required IDs, prevent submission (client-side) and show validation.
  - include `Idempotency-Key` header for create/submit operations (Decision: DECISION-INVENTORY-012) **when using REST calls**.

### State changes
- No new workexec workflow states introduced.
- CRM reference fields are treated as artifact metadata; UI treats them as immutable (read-only) after persistence.

### Service interactions
- Create/update calls must include CRM reference fields or must use a backend contract that guarantees preservation.
- If the UI uses Moqui screen transitions (non-REST), the same data must be passed in transition parameters and persisted by the invoked service.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- IDs are opaque strings; UI must not enforce UUID/numeric formats (Decision: DECISION-INVENTORY-003).
- On create:
  - `crmPartyId` required (non-empty string)
  - `crmVehicleId` required (non-empty string)
  - `crmContactIds` required as a non-null array (may be empty)
- On update:
  - UI must not null/omit previously stored CRM reference fields.
  - If backend rejects changes to CRM references, UI must treat them as immutable and not attempt to change them.

### Enable/disable rules
- Create/submit actions disabled while:
  - required CRM IDs are absent from current context, or
  - submission is in-flight.
- CRM reference fields are always read-only in UI.

### Visibility rules
- Always show ‚ÄúCRM References‚Äù section on Estimate/Work Order screens.
- For missing values (legacy records), show ‚ÄúNot set‚Äù.

### Error messaging expectations
- 400 missing/invalid CRM fields: show actionable message:
  - ‚ÄúCustomer/Vehicle reference is missing. Re-select customer and vehicle and try again.‚Äù
- 409 conflict on update: show:
  - ‚ÄúThis record was updated elsewhere. Refresh to continue.‚Äù
- 403: show:
  - ‚ÄúNot authorized to perform this action.‚Äù

---

## 8. Data Requirements

### Entities involved
- `durion.workexec` Estimate entity (exact entity name not provided in inputs; treat as ‚ÄúEstimate‚Äù read model used by `EstimateEdit.xml`)
- `durion.workexec.DurWorkOrder`

### Fields (Estimate + Work Order)
| Field | Type | Required | Default | Editable |
|------|------|----------|---------|----------|
| crmPartyId | string (opaque id) | Yes on create | none | Read-only |
| crmVehicleId | string (opaque id) | Yes on create | none | Read-only |
| crmContactIds | string[] (opaque ids) | Yes (non-null) | `[]` | Read-only |

### Read-only vs editable by state/role
- Read-only across all states/roles in the frontend.
- If backend supports updating these values in `DRAFT`, that is a separate story; this story does not introduce editing.

### Derived/calculated fields
- None. (Alias/canonical resolution display is explicitly out-of-scope until a contract exists.)

---

## 9. Service Contracts (Frontend Perspective)

> Moqui screen actions may call internal services; REST endpoints below are referenced from provided docs but are not canonical for this repo. This story requires confirmation of the actual endpoints used by the frontend for estimate/work order CRUD.

### Load/view calls
- Estimate load (one of):
  - Moqui screen load via entity-auto or service in `EstimateEdit.xml`, OR
  - `GET /api/estimates/{id}` (as referenced in provided docs)
- Work order load (one of):
  - Moqui screen load via entity-auto or service in `WorkOrderEdit.xml`, OR
  - `GET /api/workorders/{id}` or `GET /api/work-orders/{id}` (path must be confirmed)

### Create/update calls
- Estimate create:
  - `POST /api/estimates` with body including `crmPartyId`, `crmVehicleId`, `crmContactIds`
  - Include `Idempotency-Key` header on REST create (Decision: DECISION-INVENTORY-012)
- Estimate update:
  - `PUT/PATCH /api/estimates/{id}` (contract must be confirmed)
  - Must preserve CRM fields (send them back or use patch semantics that cannot clear them)
- Work order create:
  - `POST /api/workorders` or `POST /api/work-orders` (contract must be confirmed)
  - Include `Idempotency-Key` header on REST create (Decision: DECISION-INVENTORY-012)
- Work order update:
  - `PUT/PATCH /api/workorders/{id}` (contract must be confirmed)
  - Must preserve CRM fields

### Submit/transition calls
- Estimate ‚Üí Work Order conversion:
  - If conversion is a backend action, frontend must ensure CRM references are present in the conversion request **or** verify backend copies them from the estimate.
  - No assumption allowed without contract confirmation.

### Error handling expectations
- Normalize errors to standard envelope where REST is used (Decision: DECISION-INVENTORY-011):
  - `code`, `message`, `correlationId`, optional `fieldErrors[]`
- For Moqui framework errors (screen transitions), map to:
  - field errors where possible
  - otherwise a banner with a generated local correlation token plus any server-provided reference

---

## 10. State Model & Transitions

### Allowed states
- No changes to existing Estimate state machine (`DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`) or Work Order state machine (per `WORKORDER_STATE_MACHINE.md` and workexec domain guidance).

### Role-based transitions
- Not modified by this story.

### UI behavior per state
- Estimate:
  - In all states: CRM references visible read-only.
  - In `DRAFT`: when saving edits, CRM references must be preserved.
- Work Order:
  - In all states: CRM references visible read-only.
  - During execution states: no special behavior besides display and preservation on any allowed updates.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing selected customer (`crmPartyId` unavailable):
  - Block submit; show ‚ÄúSelect a customer to continue.‚Äù
- Missing selected vehicle (`crmVehicleId` unavailable):
  - Block submit; show ‚ÄúSelect a vehicle to continue.‚Äù

### Backend validation failures
- Backend returns 400 for missing `crmVehicleId`:
  - Show actionable error; keep user on screen; preserve in-progress form state.

### Concurrency conflicts
- Update returns 409:
  - Prompt user to refresh; do not auto-resubmit.

### Unauthorized access
- 403 on load:
  - Show authorization error; do not display record data.
- 403 on submit:
  - Show authorization error; keep user on screen.

### Empty states / legacy records
- Loaded record lacks CRM refs:
  - Display ‚ÄúNot set‚Äù and a note: ‚ÄúThis record was created before CRM references were required.‚Äù

---

## 12. Acceptance Criteria

### Scenario 1: Create Estimate includes CRM references
**Given** a POS user has selected a customer with `crmPartyId` and a vehicle with `crmVehicleId`  
**And** the user has selected zero or more contacts (yielding `crmContactIds`)  
**When** the user submits ‚ÄúCreate Estimate‚Äù  
**Then** the frontend sends a create request containing `crmPartyId`, `crmVehicleId`, and `crmContactIds` (non-null; empty array allowed)  
**And** on successful creation, the Estimate screen displays the stored CRM reference fields read-only.

### Scenario 2: Prevent Estimate create when required CRM IDs are missing
**Given** a POS user has not selected a vehicle (no `crmVehicleId` available)  
**When** the user attempts to submit ‚ÄúCreate Estimate‚Äù  
**Then** the frontend blocks submission  
**And** shows an error indicating vehicle selection is required.

### Scenario 3: Work Order detail displays CRM references
**Given** a work order exists with stored `crmPartyId`, `crmVehicleId`, and `crmContactIds`  
**When** the user opens the Work Order screen  
**Then** the CRM reference fields are displayed read-only  
**And** the UI does not allow direct editing of these fields.

### Scenario 4: Updates do not drop CRM references
**Given** an estimate exists with CRM references set  
**And** the estimate is edited in a manner that triggers an update call (e.g., adding a line item)  
**When** the frontend submits the update request  
**Then** the update request does not omit or null `crmPartyId`, `crmVehicleId`, or `crmContactIds`  
**And** after reload, the CRM reference fields remain unchanged.

### Scenario 5: Backend 400 is shown as actionable error
**Given** the backend responds `400 Bad Request` indicating `crmPartyId` is missing  
**When** the frontend receives the response  
**Then** the UI displays an actionable error message instructing the user to re-select customer/vehicle and retry  
**And** the user‚Äôs in-progress form data is preserved  
**And** if the response includes `correlationId`, it is displayed in the error details area.

---

## 13. Audit & Observability

### User-visible audit data
- On Estimate/WO screens, show:
  - CRM Party ID
  - CRM Vehicle ID
  - CRM Contact IDs (count; list if available without clutter)
- Do not expose any additional CRM attributes beyond IDs.

### Status history
- No new status history requirements.

### Traceability expectations
- For REST failures using the standard error envelope, display `correlationId` in the error banner/details.
- For successful create/update via REST, log client-side (console/logger) the action name and returned artifact ID (no PII), and include any server correlation headers if available.

---

## 14. Non-Functional UI Requirements
- **Performance**: Displaying CRM reference fields must not add additional blocking network calls.
- **Accessibility**: CRM reference section must be keyboard navigable and screen-reader labeled (IDs announced with clear field names).
- **Responsiveness**: CRM references render well on tablet layouts (wrap long IDs).
- **i18n/timezone/currency**: Not applicable (IDs only).

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE-01: Show ‚ÄúNot set‚Äù for missing legacy CRM reference fields; safe because it‚Äôs a non-decision UX fallback that doesn‚Äôt alter domain policy. (Impacted: UX Summary, Alternate/Error Flows)
- SD-ERR-MAP-01: Standard HTTP error-to-banner mapping (400/401/403/404/409/500) with non-destructive retry guidance; safe because it does not invent business rules, only displays backend outcomes. (Impacted: Service Contracts, Alternate/Error Flows)

---

## 16. Open Questions

1. **Canonical backend contracts used by Moqui frontend**: What are the exact endpoints (or Moqui services) used for Estimate and Work Order load/create/update in this repo (including whether paths are `/api/workorders` vs `/api/work-orders`, and whether updates are PUT vs PATCH)?  
2. **Estimate entity/service field names**: What are the exact field names on the Estimate and Work Order records as exposed to the frontend (confirm they are exactly `crmPartyId`, `crmVehicleId`, `crmContactIds`)?  
3. **Conversion behavior**: When converting an Estimate ‚Üí Work Order, does the backend automatically copy CRM references from the Estimate, or must the frontend supply them in the conversion/create request?  
4. **Idempotency support in current stack**: For the actual endpoints used by this frontend, are `Idempotency-Key` headers accepted and honored for create/submit operations (Decision: DECISION-INVENTORY-012), or is additional gateway/bridge work required?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Integration: Emit CRM Reference IDs in Workorder Artifacts  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/157  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Integration: Emit CRM Reference IDs in Workorder Artifacts

**Domain**: user

### Story Description

/kiro  
# User Story

## Narrative  
As a **System**, I want **workorders/estimates to store CRM partyId, vehicleId, and contactIds** so that **traceability and reporting are possible**.

## Details  
- Workorder domain stores foreign references to CRM.  
- CRM merges must not break references (aliases/redirects).

## Acceptance Criteria  
- Estimate/WO persist CRM references.  
- References resolvable back to CRM after merges.

## Integration Points (Workorder Execution)  
- Workorder Execution persists CRM IDs; CRM provides alias resolution endpoint if needed.

## Data / Entities  
- WO/Estimate reference fields  
- PartyAlias (optional)

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: CRM

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #149: [FRONTEND] [STORY] Timekeeping: Mechanic Clock In/Out
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Timekeeping: Mechanic Clock In/Out (Moqui Screen + Service Wiring)

### Primary Persona
Mechanic (authenticated POS user)

### Business Value
Accurate, auditable attendance time tracking by enabling a mechanic to clock in/out with server-authoritative timestamps and clear prevention of duplicate/open entries.

---

## 2. Story Intent

### As a / I want / So that
**As a** Mechanic,  
**I want to** clock in and clock out with a single action,  
**so that** my attendance time is recorded accurately and can be audited.

### In-scope
- A dedicated Moqui screen flow for a mechanic to:
  - View current clock status (clocked in vs clocked out)
  - Perform **Clock In** or **Clock Out** (one tap)
- Frontend enforcement + backend error handling for:
  - Preventing double clock-in without clock-out
  - Preventing clock-out when not clocked in
- Display of last/open TimeEntry context after load and after actions (timestamps + timezone)
- Audit-oriented UI exposure (read-only): show created/updated timestamps and who performed action when returned by backend
- Optional ‚Äúshift context display‚Äù (if endpoint exists) as non-blocking enhancement (no new business logic)

### Out-of-scope
- Payroll calculations, wage rules, overtime policies
- Manager corrections/edits to TimeEntry records
- Defining/implementing authorization policy and role model (frontend will respect backend 401/403)
- Creating or changing domain state machines beyond the timekeeping open/closed entry behavior
- Notification workflows
- Time entry CRUD beyond ‚Äúclock in/out‚Äù (create open entry, close open entry)

---

## 3. Actors & Stakeholders
- **Mechanic (Primary Actor):** clocks in/out.
- **Shop Manager (Stakeholder):** relies on accurate attendance records; may review exceptions later.
- **Payroll/HR (Downstream):** consumes time entries (not implemented here).
- **System (Moqui UI):** orchestrates calls, displays status and errors.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User identity is available to backend via auth context (‚Äúme‚Äù semantics preferred; do not send actor IDs from UI unless contract requires).
- Backend provides timekeeping endpoints (see Service Contracts) with server-generated UTC timestamps.
- IDs are treated as opaque strings (DECISION-INVENTORY-003).

### Dependencies
- **Domain ownership dependency:** Timekeeping is people/HR domain in the original issue classification; however this story is explicitly requested to be updated under `domain:workexec`. Workexec may host the execution UI, but time entry SoR is expected to be People domain per workexec guide (DECISION-INVENTORY-009). This creates a contract dependency on People/timekeeping APIs.
- **Location context dependency:** A ‚Äúcurrent location/shop context‚Äù must be available in frontend session/context OR user must select a location. Policy is not defined in provided workexec rules; must be clarified (blocking).
- **API contract dependency:** Exact REST paths and payload schemas for timekeeping are not provided in authoritative references here; must be clarified (blocking).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Primary: POS navigation item **Timekeeping ‚Üí Clock In/Out**
- Secondary (optional): from Mechanic home/dashboard card ‚ÄúClock status‚Äù

### Screens to create/modify
- **New Screen (workexec component UI surface):** `durion-workexec/screen/timekeeping/ClockInOut.xml` (path/name must follow repo conventions; final location to be confirmed during implementation)
  - Single view that:
    - Loads current status on entry
    - Shows current status and last/open entry summary
    - Provides one primary action button that toggles between Clock In / Clock Out based on status
    - Shows location context (read-only or selectable depending on policy)
- **Optional embedded screenlet** for dashboard usage, if project uses screenlets.

### Navigation context
- Screen requires access to:
  - Authenticated user identity (session)
  - Current shop/location context (or selection control if not implicit)
  - User timezone for display (DECISION-INVENTORY-016)

### User workflows (happy + alternate)

**Happy path ‚Äì Clock In**
1. Mechanic opens Timekeeping screen.
2. Screen loads current status and shows ‚ÄúClock In‚Äù.
3. Mechanic taps ‚ÄúClock In‚Äù.
4. UI disables button, shows in-progress indicator.
5. On success, UI shows ‚ÄúClocked In‚Äù and displays clock-in timestamp (displayed in user timezone) and labels timezone used.

**Happy path ‚Äì Clock Out**
1. Mechanic opens Timekeeping screen while clocked in.
2. Screen shows ‚ÄúClock Out‚Äù.
3. Mechanic taps ‚ÄúClock Out‚Äù.
4. On success, UI shows ‚ÄúClocked Out‚Äù and displays clock-out timestamp (displayed in user timezone) and labels timezone used.

**Alternate path ‚Äì Location selection (only if required)**
- Mechanic selects a location before clocking in/out; selection persists for the session (frontend-only persistence unless backend requires otherwise).
- If backend rejects location, UI shows error and keeps prior status.

**Alternate path ‚Äì Partial context (shift display)**
- If a shift endpoint exists, UI loads it in parallel and renders it as supplemental context; failure to load shift must not block clock in/out.

---

## 6. Functional Behavior

### Triggers
- Screen load ‚Üí fetch current timekeeping status for the authenticated mechanic.
- Button press:
  - If status is ‚Äúclocked out‚Äù ‚Üí call Clock In
  - If status is ‚Äúclocked in‚Äù ‚Üí call Clock Out

### UI actions
- Show a single primary action button whose label and action is determined by loaded status.
- Disable action button during network request; prevent double-submission.
- Send `Idempotency-Key` header for clock-in/out mutations (DECISION-INVENTORY-012).
- On success:
  - Refresh status using response payload OR reloading status endpoint (preferred for consistency if backend response is minimal).
- On failure:
  - Show inline error banner/toast with actionable message.
  - Maintain prior known status (do not optimistically flip state).
  - If failure is 409/400 indicating stale state, reload status.

### State changes (frontend-local)
- `viewState.status`: `UNKNOWN | CLOCKED_OUT | CLOCKED_IN`
- `viewState.pendingAction`: `NONE | CLOCK_IN | CLOCK_OUT`
- `viewState.openTimeEntry`: TimeEntry | null
- `viewState.lastClosedTimeEntry`: TimeEntry | null
- `viewState.locationId`: string | null (selected/derived)
- `viewState.shiftContext`: object | null (optional)

### Service interactions
- `GET current status` on screen load (and after successful actions)
- `POST clock-in` and `POST clock-out` on action
- Optional `GET shift context` in parallel (non-blocking)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- UI MUST NOT allow Clock In when backend-reported status indicates an open entry (clocked in).
- UI MUST NOT allow Clock Out when backend-reported status indicates no open entry (clocked out).
- UI MUST treat all IDs as opaque strings; no UUID/numeric validation (DECISION-INVENTORY-003).
- UI MUST NOT send timestamps; server is authoritative for timestamps (aligns with workexec invariants: server-authoritative state transitions and auditability).
- If backend rejects due to race/concurrency, UI must display backend message and reload status.

### Enable/disable rules
- Primary action button enabled only when:
  - Status is known (`CLOCKED_IN` or `CLOCKED_OUT`)
  - No request is pending
  - Required location input (if any) is satisfied

### Visibility rules
- If status unknown due to load failure:
  - Show retry action and disable clock action button.
- Show location context always:
  - Read-only if derived from terminal/session.
  - Editable only if selection is required by backend policy.

### Error messaging expectations
Use backend standard error envelope when available (DECISION-INVENTORY-011). If backend does not provide a user-safe message, map these cases:

- Double clock-in attempt (409): ‚ÄúYou are already clocked in. You must clock out before clocking in again.‚Äù
- Clock-out without clock-in (409): ‚ÄúYou are not currently clocked in.‚Äù
- Missing required location (400): ‚ÄúSelect a location to continue.‚Äù
- Not authorized for location (403): ‚ÄúClock-in failed: You are not authorized for this location.‚Äù
- Generic system error: ‚ÄúUnable to record time right now. Please try again or contact a manager.‚Äù

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **TimeEntry** (attendance record; SoR expected to be People domain per DECISION-INVENTORY-009, but consumed by this workexec-hosted UI)

### Fields (type, required, defaults)

**Identifier types**
- All IDs are opaque strings (`type="id"` semantics) (DECISION-INVENTORY-003).

**TimeEntry (response DTO)**
Minimum required for this UI:
- `timeEntryId` (string, required)
- `employeeId` or `mechanicId` (string, required) ‚Äî name depends on People/timekeeping contract (blocking)
- `locationId` (string, required if timekeeping is location-scoped; blocking)
- `clockInTimestampUtc` (ISO-8601 string, required when open or closed)
- `clockOutTimestampUtc` (ISO-8601 string, nullable)
- `createdAtUtc` (ISO-8601 string, optional but preferred)
- `updatedAtUtc` (ISO-8601 string, optional but preferred)
- `createdByUserId` (string, optional)
- `updatedByUserId` (string, optional)

**TimekeepingStatus (response DTO)**
- `status` enum: `CLOCKED_IN | CLOCKED_OUT` (required)
- `openTimeEntry` (TimeEntry | null)
- `lastClosedTimeEntry` (TimeEntry | null) (optional)

**Clock action request (frontend ‚Üí backend)**
- `locationId` (string, required **only if** backend requires explicit location; blocking)
- No timestamps provided by frontend.

### Read-only vs editable
- Timestamps and audit fields are **read-only**.
- Location:
  - Read-only if derived from session/terminal.
  - Editable only if required due to missing config/context.

### Derived/calculated fields (frontend only)
- Display timestamps in **user timezone** (DECISION-INVENTORY-016).
- UI must label the timezone used for display (e.g., ‚ÄúTimes shown in America/Denver‚Äù).
- If backend provides a shop/location timezone for bucketing, it may be displayed as context; do not change business logic.

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: exact endpoints and schemas are not provided in authoritative references for this repo. The below are placeholders that MUST be replaced with actual Moqui REST routes/services during implementation.

### Load/view calls
1. **Get current timekeeping status**
   - Request: `GET /rest/api/v1/timekeeping/me/status` (placeholder)
   - Response (200): `TimekeepingStatus`
   - Errors:
     - 401 ‚Üí route to login/session expired handling
     - 403 ‚Üí show unauthorized message; disable actions
     - 5xx/timeout ‚Üí show retry state; keep actions disabled

### Create/update calls
2. **Clock in**
   - Request: `POST /rest/api/v1/timekeeping/me/clock-in`
     - Headers:
       - `Idempotency-Key: <uuid>` (required; DECISION-INVENTORY-012)
     - Body: `{ "locationId": "<id>" }` only if required
   - Response (200 or 201): `TimekeepingStatus` preferred; or `TimeEntry` if status endpoint must be reloaded
   - Errors:
     - 409 with standard envelope code (e.g., `ALREADY_CLOCKED_IN`) ‚Üí show mapped message; reload status
     - 403 ‚Üí show not authorized; keep status
     - 400 with `fieldErrors[]` ‚Üí show first field error; do not change status

3. **Clock out**
   - Request: `POST /rest/api/v1/timekeeping/me/clock-out`
     - Headers:
       - `Idempotency-Key: <uuid>` (required; DECISION-INVENTORY-012)
     - Body: `{ "locationId": "<id>" }` only if required
   - Response (200): `TimekeepingStatus` preferred; or `TimeEntry`
   - Errors:
     - 409 (e.g., `NOT_CLOCKED_IN`) ‚Üí show mapped message; reload status
     - 403/400 as above

### Submit/transition calls
- Not applicable beyond clock-in/out actions.

### Error handling expectations
- Backend errors should conform to standard envelope (DECISION-INVENTORY-011):
  - `code` (string)
  - `message` (string)
  - `correlationId` (string)
  - `fieldErrors[]` optional
- UI behavior:
  - 400/409: show message (backend `message` if safe), then reload status
  - 403: show unauthorized message; disable actions
  - 5xx/network: show generic error; allow retry; do not change UI status

---

## 10. State Model & Transitions

### Allowed states (timekeeping UI state)
- `CLOCKED_OUT` ‚Üí user can perform **Clock In**
- `CLOCKED_IN` ‚Üí user can perform **Clock Out**
- `UNKNOWN` ‚Üí no actions allowed until status loads

### Role-based transitions
- Mechanic role (or equivalent capability) must be allowed to clock in/out.
- UI must not assume role names; it must rely on backend authorization (403) and optional capability flags if provided (DECISION-INVENTORY-013 pattern, though timekeeping capability schema is not defined here).

### UI behavior per state
- **CLOCKED_OUT**
  - Primary button: ‚ÄúClock In‚Äù
  - Show last closed entry if available (clock-out time)
- **CLOCKED_IN**
  - Primary button: ‚ÄúClock Out‚Äù
  - Show open entry details (clock-in time, location)
- **UNKNOWN/ERROR**
  - Primary button disabled
  - Show retry

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required location input (if required by backend):
  - Show ‚ÄúSelect a location to continue‚Äù and block action.
- Backend returns 400 with field errors:
  - Show first error message in banner; highlight relevant input (location) when applicable.

### Concurrency conflicts
- Mechanic clocks in on another device while this screen is open:
  - Clock-in request returns 409; UI shows ‚ÄúYou are already clocked in‚Ä¶‚Äù and reloads status.
- Mechanic clocks out on another device:
  - Clock-out request returns 409; UI shows ‚ÄúYou are not currently clocked in.‚Äù and reloads.

### Unauthorized access
- 401: route to login flow.
- 403: show ‚ÄúYou do not have permission to use timekeeping‚Äù and hide/disable actions.

### Empty states
- No previous entries:
  - Show status and action button; omit ‚Äúlast entry‚Äù panel.

### Idempotency retry behavior
- If a clock-in/out request times out client-side:
  - UI offers ‚ÄúRetry‚Äù and MUST reuse the same `Idempotency-Key` for that attempt (DECISION-INVENTORY-012).
  - On retry success, UI reloads status.

---

## 12. Acceptance Criteria

### Scenario 1: View clock status on load (clocked out)
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_OUT`  
**When** the mechanic opens the Timekeeping Clock screen  
**Then** the UI shows status `Clocked Out`  
**And** the primary action is `Clock In`  
**And** no clock-out action is available.

### Scenario 2: Successful clock in (idempotent)
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_OUT`  
**When** the mechanic taps `Clock In`  
**Then** the frontend sends a clock-in request to the backend with an `Idempotency-Key` header  
**And** the UI disables the action while the request is pending  
**And** on success the UI shows status `Clocked In`  
**And** displays the server-recorded clock-in timestamp in the user timezone  
**And** the UI labels the timezone used for display.

### Scenario 3: Prevent double clock-in (UI + backend)
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_IN`  
**When** the mechanic views the Timekeeping Clock screen  
**Then** the `Clock In` action is not available  
**And** the primary action is `Clock Out`.

**And Given** the mechanic is `CLOCKED_IN`  
**When** the mechanic attempts to invoke clock-in (e.g., by rapid double-tap or stale UI)  
**Then** the backend responds with 409 in the standard error envelope including `correlationId`  
**And** the UI displays ‚ÄúYou are already clocked in. You must clock out before clocking in again.‚Äù  
**And** the UI reloads and displays the current status.

### Scenario 4: Successful clock out (idempotent)
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_IN` with an open TimeEntry  
**When** the mechanic taps `Clock Out`  
**Then** the frontend sends a clock-out request to the backend with an `Idempotency-Key` header  
**And** on success the UI shows status `Clocked Out`  
**And** displays the server-recorded clock-out timestamp in the user timezone  
**And** the UI labels the timezone used for display.

### Scenario 5: Prevent clock-out when not clocked in
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_OUT`  
**When** the mechanic attempts to clock out (via stale state or direct action)  
**Then** the backend responds with 409 in the standard error envelope  
**And** the UI displays ‚ÄúYou are not currently clocked in.‚Äù  
**And** the UI reloads status.

### Scenario 6: Location required but missing (if enforced by backend)
**Given** the backend requires `locationId` for clock-in/out  
**And** the mechanic has not selected a location and no location is available from session context  
**When** the mechanic taps `Clock In`  
**Then** the UI blocks the request client-side  
**And** displays ‚ÄúSelect a location to continue.‚Äù

### Scenario 7: Location authorization failure (if enforced)
**Given** location validation is enabled by policy  
**And** the mechanic is not authorized for the current/selected location  
**When** the mechanic taps `Clock In`  
**Then** the backend responds with 403  
**And** the UI displays ‚ÄúClock-in failed: You are not authorized for this location.‚Äù  
**And** no TimeEntry is created  
**And** the UI continues to show the prior status.

### Scenario 8: System/network failure with retry
**Given** the mechanic is authenticated  
**And** the backend is unavailable or returns 5xx  
**When** the mechanic taps `Clock In` or `Clock Out`  
**Then** the UI shows ‚ÄúUnable to record time right now. Please try again or contact a manager.‚Äù  
**And** the UI does not change the displayed clock status  
**And** the mechanic can retry  
**And** if retrying the same attempt after a timeout, the UI reuses the same `Idempotency-Key`.

---

## 13. Audit & Observability

### User-visible audit data
- Display (read-only) from backend when available:
  - clock-in/out timestamps
  - associated location (if applicable)
  - created/updated timestamps and actor IDs if provided
- Do not display sensitive internal IDs unless already standard in POS UI.

### Status history
- Out-of-scope to build a full history view.
- If backend provides `lastClosedTimeEntry`, show a summary (clock-in/out times and location).

### Traceability expectations
- UI should pass through/record `correlationId` from error envelope in client logs for support (DECISION-INVENTORY-011).
- For mutations, UI generates and logs `Idempotency-Key` per attempt (DECISION-INVENTORY-012).
- Client logs must avoid PII; log only route, action, correlationId, and idempotency key.

---

## 14. Non-Functional UI Requirements

- **Performance:** status load should render actionable UI within 1s on typical store network; show loading state while fetching.
- **Accessibility:** action button reachable by keyboard; status changes announced (aria-live) if framework supports; sufficient color contrast.
- **Responsiveness:** usable on tablet and desktop.
- **i18n/timezone:** timestamps displayed in user timezone (DECISION-INVENTORY-016) and timezone labeled. Currency not applicable.

---

## 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE:** Show a clear empty state when no prior TimeEntry exists; qualifies as safe because it does not change business logic, only presentation. (Impacted: UX Summary, Alternate/Empty states)
- **SD-UX-REQUEST-IN-FLIGHT-GUARD:** Disable primary action and prevent double-submit while request is pending; qualifies as safe because it prevents accidental duplicate requests without altering domain policy. (Impacted: Functional Behavior, Error Flows)
- **SD-ERR-HTTP-MAPPING:** Standard handling for 401/403/409/5xx with retry and message mapping; qualifies as safe because it follows common REST semantics and does not invent business rules. (Impacted: Service Contracts, Error Flows)

---

## 16. Open Questions

1. **Domain ownership/labeling (blocking):** Timekeeping is explicitly classified as People Management in the original issue, and workexec domain rules state time entry remains in People domain (DECISION-INVENTORY-009). Should this story be relabeled to `domain:people` and moved, with workexec consuming it only as a link/entry point? If it must remain `domain:workexec`, confirm workexec is allowed to own the UI surface while People owns the data/services.
2. **Location validation policy (blocking):** Is ‚Äúmechanic assigned to selected location‚Äù enforcement **Not enforced**, **Strict (block)**, or **Soft (warn/flag but allow)**? This affects whether location selection is required and how 403/400 are handled.
3. **Location source (blocking):** How does the frontend determine `locationId` for timekeeping?
   - Derived implicitly from terminal/session context, or
   - Mechanic must select a location, or
   - Backend infers location and frontend sends none.
4. **Backend endpoints + schemas (blocking):** What are the exact REST paths and response schemas for:
   - current status
   - clock-in
   - clock-out  
   Include whether responses return `TimekeepingStatus` vs `TimeEntry`, and confirm standard error envelope usage (DECISION-INVENTORY-011).
5. **Identity mapping (blocking):** Does backend identify mechanic via auth token (‚Äúme‚Äù) or does frontend need to send an identifier? If sending is required, which identifier is canonical (`userId`, `partyId`, employeeId)?
6. **Shift context integration (non-blocking):** If ‚Äúshopmgr shift can be displayed‚Äù is desired, what endpoint and minimal fields should be displayed, and is it People or ShopMgr SoR?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Timekeeping: Mechanic Clock In/Out  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/149  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Timekeeping: Mechanic Clock In/Out

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Mechanic**, I want **to clock in and out** so that **my attendance time is recorded accurately**.

## Details
- Capture UTC timestamp and local timezone.
- Optional validation that mechanic is assigned to the selected location.

## Acceptance Criteria
- One-tap clock in/out.
- Prevent double clock-in without clock-out.
- Entries are auditable.

## Integration Points (workexec/shopmgr)
- shopmgr shift can be displayed for context (optional).

## Data / Entities
- TimeEntry (attendance)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: People Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #146: [FRONTEND] [STORY] Integration: Start/Stop Timer Against Assigned Workorder Task
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Workexec: Start/Stop Job Timer for Assigned Work Order Task

## Primary Persona
Mechanic (Technician)

## Business Value
Accurate, audit-friendly labor time capture tied to a work order (and optionally a specific task/labor code), reducing manual calculations and improving downstream job costing/billing accuracy.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Mechanic  
- **I want** to start and stop a job timer for my assigned work order/task  
- **So that** the system records accurate time entries automatically and prevents overlapping timers unless allowed by policy.

## In-scope
- UI to **view active timer state** and recover after refresh/login.
- UI actions to **start** a timer (with `workOrderId` required; optional `workOrderItemId` and/or `laborCode` if available in the UI context).
- UI actions to **stop** timer(s) for the authenticated mechanic.
- Frontend handling of backend constraint errors (single active timer by default).
- Display of resulting time entry summary after start/stop.
- Basic audit visibility (who/when) where returned by API.

## Out-of-scope
- Timer **pause/break handling**.
- Manual editing/adjustment of completed/auto-stopped time entries.
- Creating/assigning work orders or tasks.
- Clock-in/clock-out UI and the actual auto-stop jobs (handled by backend/system).
- Defining policy values/roles (concurrent timers configuration and permissions).

---

# 3. Actors & Stakeholders
- **Mechanic (Primary)**: starts/stops timers while working.
- **Service Advisor (Stakeholder)**: reviews time captured for billing accuracy (read-only impact).
- **System/Backend**: enforces assignment and timer constraints; creates immutable time entries.
- **Audit/Reporting (Downstream)**: consumes timer events/time entry records.

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in POS frontend.
- User is authorized to use timers (capability/permission signaled to UI when available; backend remains authoritative with 403).
- Work order exists and is in a ‚Äúworkable‚Äù state per backend validation.
- Mechanic is assigned to the work order (and to the item if item-level timing is used).
- IDs are treated as opaque strings (no UUID/numeric assumptions).

## Dependencies
- Backend endpoints available (referenced by backend story #82; paths must be confirmed):
  - `GET /api/workexec/time-entries/timer/active`
  - `POST /api/workexec/time-entries/timer/start`
  - `POST /api/workexec/time-entries/timer/stop`
- Work order/task context available in the UI (e.g., from work order detail screen) to provide:
  - `workOrderId` (required)
  - `workOrderItemId` (optional)
  - `laborCode` (optional)
- Moqui security session provides authenticated principal; frontend must not supply `mechanicId`.
- Standard error envelope is available and stable (Decision: DECISION-INVENTORY-011):
  - `code`, `message`, `correlationId`, optional `fieldErrors[]`, optional `existingResourceId` (not expected for timers but envelope must parse).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From **Work Order Edit/Execution** screen for an assigned work order (primary).
- From a **Mechanic ‚ÄúMy Work‚Äù** view listing assigned work orders (secondary).
- Optional: a dedicated **My Active Timer** view for recovery/visibility outside a work order.

## Screens to create/modify (Moqui)
1. **Modify**: `durion-workexec/WorkOrderEdit.xml`
   - Add a ‚ÄúTimer‚Äù section/screenlet with Start/Stop actions and current timer status.
2. **Create**: `durion-workexec/component/screenlet/TimerPanel.xml` (screenlet)
   - Reusable component to display active timer and controls; accepts `workOrderId` (and optionally `workOrderItemId`, `laborCode`) as parameters.
3. **Create (optional but recommended)**: `durion-workexec/MyActiveTimer.xml`
   - Dedicated screen to show active timer(s) and allow stop without requiring a work order context.

## Navigation context
- Work order context provides `workOrderId`.
- If user navigates away and returns, UI must re-load active timer via `GET ‚Ä¶/active`.
- If `MyActiveTimer` is implemented, provide a navigation link from `WorkOrderEdit` timer section when an active timer exists.

## User workflows (happy + alternate)

### Happy path: start then stop (single-timer mode)
1. Mechanic opens assigned work order (`WorkOrderEdit`).
2. UI loads active timer(s).
3. Mechanic clicks **Start Timer**.
4. UI shows timer running (start time; elapsed time increments client-side).
5. Mechanic clicks **Stop Timer**.
6. UI confirms timer stopped and shows recorded duration.

### Alternate: start blocked due to existing active timer
1. Mechanic clicks Start Timer while another timer is active.
2. UI shows error and offers to:
   - Refresh and show active timer details (via GET active)
   - Stop active timer(s)

### Recovery: refresh/relogin while timer active
1. Mechanic reloads app or logs back in.
2. UI calls GET active on entry and shows running timer state.

---

# 6. Functional Behavior

## Triggers
- Screen load / route enter for timer-capable screens triggers active timer load.
- User clicks Start Timer.
- User clicks Stop Timer.

## UI actions
- **On load**:
  - Call `GET /api/workexec/time-entries/timer/active`
  - Render:
    - No active timer: show Start controls enabled (subject to having `workOrderId` context)
    - Active timer(s): show Stop controls enabled; Start controls disabled by default (single-timer UX), but must still handle backend allowing concurrent timers.
- **Start Timer click**:
  - Validate required inputs present in UI context:
    - `workOrderId` required
    - If `workOrderItemId` supplied, include it
    - If `laborCode` supplied, include it
  - Generate and send `Idempotency-Key` header for the start attempt (Decision: DECISION-INVENTORY-012). Reuse the same key on retry for the same user attempt.
  - Call `POST ‚Ä¶/start` with body `{ workOrderId, workOrderItemId, laborCode }`
  - On success, update UI to running state using response summary.
- **Stop Timer click**:
  - Generate and send `Idempotency-Key` header for the stop attempt (same idempotency rule as above; stop is a mutation and may be double-clicked).
  - Call `POST ‚Ä¶/stop` with empty body
  - On success, update UI to not-running state and show stopped entries summary.

## State changes (frontend)
- Maintain a local timer view state:
  - `timerState = NONE | ACTIVE | STARTING | STOPPING | ERROR`
- When ACTIVE, show:
  - `startTime` from server
  - elapsed time computed from `(nowClient - startTimeServer)` for display only (server remains authoritative)

## Service interactions
- All calls include auth token/session.
- Propagate/record `correlationId` from error envelope when present (Decision: DECISION-INVENTORY-011).
- Do not send `mechanicId` in any request; backend derives from auth context.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Start Timer is blocked client-side if:
  - `workOrderId` is missing from context.
- IDs are opaque strings; UI must not validate format beyond non-empty.
- Do **not** attempt to provide `mechanicId` in requests (backend derives it).
- Do not allow ‚ÄúStop‚Äù if UI already knows there is no active timer, but still handle server-side conflict responses.

## Enable/disable rules
- If GET active returns at least one ACTIVE timer:
  - Disable Start (default single-timer UX)
  - Enable Stop
- If GET active returns none:
  - Enable Start (if `workOrderId` present)
  - Disable Stop
- While a start/stop request is in-flight:
  - Disable both Start and Stop to prevent double-submit.

## Visibility rules
- When timer ACTIVE:
  - Show workOrder reference and (if present) item/laborCode from the active timer response.
- When timer stopped:
  - Show last stopped duration and timestamps from response.

## Error messaging expectations
Use standard error envelope parsing (Decision: DECISION-INVENTORY-011). Map known codes to user-facing messages (no sensitive details):
- `TIMER_ALREADY_ACTIVE` (409): ‚ÄúYou already have an active timer. Stop it before starting a new one.‚Äù
- `NO_ACTIVE_TIMER` (409): ‚ÄúNo active timer to stop.‚Äù
- `FORBIDDEN`/`UNAUTHORIZED` (403): ‚ÄúYou don‚Äôt have permission to use timers.‚Äù
- `NOT_FOUND` (404): ‚ÄúWork order/task not available.‚Äù
- `CONFLICT` (409 other): ‚ÄúTimer action can‚Äôt be completed due to current work order status or assignment.‚Äù
- Unknown/5xx: ‚ÄúSomething went wrong. Try again. If it keeps happening, contact support with reference: <correlationId>.‚Äù

---

# 8. Data Requirements

## Entities involved (frontend view models)
- **TimeEntry** (job timer entry)

> Note: Original context mentioned `JobLink` and `TimeException`. This story does not create or edit those; only display if returned by timer endpoints.

## Fields (type, required, defaults)

### TimeEntry (as consumed by frontend)
- `timeEntryId` (string) ‚Äî required
- `workOrderId` (string) ‚Äî required
- `workOrderItemId` (string|null) ‚Äî optional
- `laborCode` (string|null) ‚Äî optional
- `startTime` (ISO-8601 timestamp string) ‚Äî required
- `endTime` (ISO-8601 timestamp string|null) ‚Äî present when stopped
- `durationInSeconds` (number|null) ‚Äî present when stopped
- `status` (enum: `ACTIVE|COMPLETED|AUTO_STOPPED`) ‚Äî required

### Active timer response (canonicalized expectation)
- `active` (array of TimeEntry summaries) ‚Äî may be empty
- `asOf` (ISO-8601 timestamp string, optional) ‚Äî if provided, display ‚ÄúLast updated‚Äù time

If backend returns a single object instead of `{active: []}`, frontend must normalize to an array for rendering (see Service Contracts).

## Read-only vs editable
- All displayed fields are read-only in this story.
- Only actions are start/stop.

## Derived/calculated fields
- `elapsedDisplaySeconds = nowClient - startTimeServer` (display only)
- `durationDisplay = format(durationInSeconds)` when stopped

---

# 9. Service Contracts (Frontend Perspective)

## Load/view calls

### Get active timer(s)
- **Method/Path:** `GET /api/workexec/time-entries/timer/active`
- **Request:** none
- **Success (200):** active timer info for authenticated mechanic
- **Empty:** returns either:
  - `{ "active": [] }`, or
  - `[]`, or
  - `null`/empty body (discouraged but must not crash UI)
- **Frontend normalization rule:** Convert any of the above into `activeTimers: TimeEntry[]` for UI rendering.

## Create/update calls

### Start timer
- **Method/Path:** `POST /api/workexec/time-entries/timer/start`
- **Headers:** `Idempotency-Key: <uuid>` (Decision: DECISION-INVENTORY-012)
- **Request body:**
  ```json
  {
    "workOrderId": "WO-123",
    "workOrderItemId": "LINE-1",
    "laborCode": "LABOR-ALIGNMENT"
  }
  ```
  `workOrderItemId` and `laborCode` omitted or null when not applicable.
- **Success (201):** created time entry summary including at minimum:
  - `timeEntryId`, `status=ACTIVE`, `startTime`, `workOrderId`, optional `workOrderItemId`, optional `laborCode`

### Stop timer(s)
- **Method/Path:** `POST /api/workexec/time-entries/timer/stop`
- **Headers:** `Idempotency-Key: <uuid>`
- **Request body:** none
- **Success (200):**
  ```json
  {
    "stopped": [
      {
        "timeEntryId": "TE-1",
        "status": "COMPLETED",
        "startTime": "2026-01-21T10:00:00Z",
        "endTime": "2026-01-21T10:15:00Z",
        "durationInSeconds": 900,
        "workOrderId": "WO-123"
      }
    ]
  }
  ```

## Submit/transition calls
- None beyond start/stop.

## Error handling expectations
- Errors conform to standard envelope (Decision: DECISION-INVENTORY-011):
  ```json
  {
    "code": "TIMER_ALREADY_ACTIVE",
    "message": "‚Ä¶",
    "correlationId": "c-123",
    "fieldErrors": [{"field":"workOrderId","message":"‚Ä¶"}]
  }
  ```
- `409 TIMER_ALREADY_ACTIVE`:
  - UI should refresh by calling `GET ‚Ä¶/active` and render the active timer.
- `409 NO_ACTIVE_TIMER`:
  - UI should refresh by calling `GET ‚Ä¶/active` and render none.
- Generic network/5xx:
  - Show non-technical error and allow retry; do not auto-retry mutations.

---

# 10. State Model & Transitions

## Timer states (TimeEntry.status)
- `ACTIVE` ‚Üí `COMPLETED` via Stop action
- `ACTIVE` ‚Üí `AUTO_STOPPED` via system (clock-out/job); UI may discover via refresh
- `COMPLETED` / `AUTO_STOPPED` are immutable via this UI

## Role-based transitions
- Mechanic (authorized): may start/stop for self (identity derived from auth)
- Others: UI should hide controls when capability signal indicates not allowed (Decision: DECISION-INVENTORY-013), but backend remains authoritative with 403.

## UI behavior per state
- ACTIVE: show running timer and Stop button
- COMPLETED/AUTO_STOPPED (as last action result): show summary; Start enabled if no active timers remain

---

# 11. Alternate / Error Flows

## Validation failures (client)
- Missing `workOrderId` in context:
  - Disable Start, show message ‚ÄúSelect a work order to start a timer.‚Äù

## Backend conflict: timer already active
- Start returns 409 `TIMER_ALREADY_ACTIVE`:
  - UI displays message + fetches active timers to show what is running.

## Backend conflict: stop when none active
- Stop returns 409 `NO_ACTIVE_TIMER`:
  - UI displays message + refreshes active timers (should show none).

## Concurrency conflicts
- Rapid double-click start/stop:
  - UI disables the action button(s) while request is in-flight.
- Two devices:
  - If a timer is started/stopped elsewhere, GET active refresh reflects server truth.

## Unauthorized access
- 403:
  - Hide Start/Stop controls for the session after first 403 and show a permission message.
  - Provide a ‚ÄúRequest access‚Äù/help link if the app has a standard support route (otherwise omit).

## Empty states
- No active timer:
  - Show ‚ÄúNo active timer‚Äù and Start available (with context).

---

# 12. Acceptance Criteria

### Scenario 1: Load screen shows no active timer
**Given** I am authenticated as a mechanic  
**And** I open an assigned work order screen with a valid `workOrderId`  
**When** the screen loads  
**Then** the app calls `GET /api/workexec/time-entries/timer/active`  
**And** if no active timer exists, the UI shows ‚ÄúNo active timer‚Äù  
**And** the ‚ÄúStart Timer‚Äù action is enabled  
**And** the ‚ÄúStop Timer‚Äù action is disabled.

### Scenario 2: Start timer creates an active time entry (idempotent)
**Given** I have no active timer  
**And** I am viewing a work order with `workOrderId=W1`  
**When** I click ‚ÄúStart Timer‚Äù  
**Then** the app calls `POST /api/workexec/time-entries/timer/start` with `workOrderId=W1`  
**And** the request includes an `Idempotency-Key` header  
**And** the API responds `201` with a `TimeEntry` having `status=ACTIVE` and `startTime`  
**And** the UI displays the timer as running  
**And** if I retry the same start due to a network timeout using the same `Idempotency-Key`, the server returns the same outcome without creating a duplicate active entry.

### Scenario 3: Stop timer completes the time entry (idempotent)
**Given** I have an active timer running  
**When** I click ‚ÄúStop Timer‚Äù  
**Then** the app calls `POST /api/workexec/time-entries/timer/stop`  
**And** the request includes an `Idempotency-Key` header  
**And** the API responds `200` with `stopped[]` containing at least one entry  
**And** each returned entry has `endTime`, `durationInSeconds`, and `status=COMPLETED` or `AUTO_STOPPED`  
**And** the UI displays the stopped summary and shows no active timer.

### Scenario 4: Prevent starting a second timer in single-timer mode
**Given** I already have an active timer  
**When** I attempt to start another timer  
**Then** the API responds `409` with error code `TIMER_ALREADY_ACTIVE` in the standard error envelope  
**And** the UI shows an error stating an active timer already exists  
**And** the UI refreshes by calling `GET /api/workexec/time-entries/timer/active` and displays the active timer.

### Scenario 5: Stop fails when no timer active
**Given** I have no active timer  
**When** I click ‚ÄúStop Timer‚Äù  
**Then** the API responds `409` with error code `NO_ACTIVE_TIMER` in the standard error envelope  
**And** the UI shows an error stating there is no active timer to stop  
**And** the UI refreshes active timer state via `GET /api/workexec/time-entries/timer/active`.

### Scenario 6: Recover after refresh
**Given** I started a timer and it is still active  
**When** I refresh the page or reopen the app  
**Then** the app calls `GET /api/workexec/time-entries/timer/active`  
**And** the UI shows the active timer as running using the returned `startTime`.

### Scenario 7: Permission gating and backend authority
**Given** I am authenticated but do not have timer permission  
**When** I open the work order screen  
**Then** if the UI has a capability signal indicating timers are not allowed, Start/Stop controls are hidden or disabled  
**And** if I still attempt to call start/stop (e.g., via direct action), the backend responds `403`  
**And** the UI shows ‚ÄúYou don‚Äôt have permission to use timers.‚Äù

---

# 13. Audit & Observability

## User-visible audit data
- Display (if present in responses):
  - `startTime`, `endTime`, `status`
  - Work order/task identifiers
- Do not display `mechanicId` unless explicitly required by UX; treat as internal.

## Status history
- Not required to display full history; only current active timer and last stop result.
- If backend provides multiple stopped entries (concurrent stop), show all in a list.

## Traceability expectations
- Frontend logs timer actions with:
  - route/screen
  - `workOrderId` / `workOrderItemId` (non-PII)
  - outcome (success/failure + error `code`)
  - `correlationId` when present (Decision: DECISION-INVENTORY-011)

---

# 14. Non-Functional UI Requirements

- **Performance:** Active timer load should complete quickly on screen entry; avoid polling by default (manual refresh acceptable).
- **Accessibility:** Timer controls must be keyboard accessible; provide text labels for screen readers.
- **Responsiveness:** Controls usable on tablet-sized devices typical for shop floor.
- **i18n/timezone:** Display timestamps in user timezone (Decision: DECISION-INVENTORY-016); store/transport timestamps as ISO-8601; duration is timezone-independent.

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Show explicit ‚ÄúNo active timer‚Äù empty state and disable Stop when none active; qualifies as safe because it‚Äôs purely presentational and does not change domain policy. (Impacted sections: UX Summary, Alternate/Empty states, Acceptance Criteria)
- SD-UX-INFLIGHT-GUARD: Disable Start/Stop buttons while request is in-flight to prevent double submission; qualifies as safe because it prevents duplicate calls without altering business rules. (Impacted sections: Alternate / Error Flows, Functional Behavior)

---

# 16. Open Questions

1. **Canonical API contract (blocking):** Confirm the exact response schema for `GET /api/workexec/time-entries/timer/active` and for `POST ‚Ä¶/start` and `POST ‚Ä¶/stop` (field names, wrapper objects, and whether active is a list vs single object). The story assumes normalization is possible, but tests require a canonical schema.
2. **Work order ‚Äútask/item‚Äù identifier (blocking):** What is the canonical identifier and field name for timing against a specific work order line/task in Moqui workexec UI? (`workOrderItemId` vs `workOrderPartId`/`workOrderServiceId`/`lineId`). This determines what the frontend can send and how it is sourced from `WorkOrderEdit`.
3. **Permission/capability signal (blocking):** What is the authoritative capability/permission flag exposed to the frontend for timer usage (e.g., `WORKEXEC_TIME_ENTRY_TIMER_USE`) and where is it obtained (session claims vs user context endpoint)? UI gating depends on this, while backend still enforces with 403.
4. **Idempotency support confirmation (blocking):** Do these timer endpoints honor `Idempotency-Key` today (Decision: DECISION-INVENTORY-012 requires it for UI mutations)? If not, what is the approved bridge-layer plan and timeline?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Integration: Start/Stop Timer Against Assigned Workorder Task ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/146

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #145: [FRONTEND] [STORY] Integration: Submit Job Time to workexec as Labor Performed (Idempotent)
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Submit Job Time (TimeEntry) as Labor Performed (Idempotent)

### Primary Persona
Mechanic / Technician (primary), with system-integration behavior initiated from the POS UI context.

### Business Value
Ensure technician labor is recorded in `workexec` accurately and without duplication, with clear, actionable failures when the Work Order state prevents labor posting‚Äîsupporting correct execution tracking and downstream billing readiness.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Mechanic/Technician  
- **I want** my finalized job time (TimeEntry) submitted to Work Execution (`workexec`) as `LaborPerformed` in an idempotent way  
- **So that** labor performed lines are created/updated accurately without duplication, and I receive stable error feedback when submission is disallowed.

### In Scope
- Frontend UI flow to **initiate** (or re-initiate) submission of a TimeEntry to workexec.
- Frontend display of **submission result** and **stable error codes**/messages returned by the integration (standard error envelope).
- Idempotency behavior at the UI level: repeated ‚ÄúSubmit‚Äù actions do not create duplicates; UI handles ‚Äúreplayed‚Äù success.
- Audit/traceability display elements (workOrder reference; correlation/idempotency key surfaced where appropriate).
- Moqui screens/forms/transitions wiring to a Moqui service that performs the POST to workexec.

### Out of Scope
- Authoring or editing TimeEntry time capture itself (People/Job-Time domain).
- Implementing the backend `workexec` endpoint (this story consumes it).
- Defining or changing Work Order state machine states (must follow workexec backend).
- Payroll/billing calculation rules based on labor time.

---

## 3. Actors & Stakeholders
- **Mechanic/Technician (UI user):** initiates submit/retry and needs clear status.
- **Service Advisor (stakeholder):** needs confidence labor is recorded; may help resolve conflicts.
- **Workexec system (`durion-workexec`):** system of record for Work Orders and Labor Performed.
- **People/Job-Time system (upstream):** source of TimeEntry, provides `timeEntryId`, `workOrderId`, `technicianId`, time quantities.

---

## 4. Preconditions & Dependencies
- A `TimeEntry` exists and is eligible for submission (expected ‚Äúfinalized‚Äù state in People/Job-Time domain).
- Frontend can access (field names TBD by actual TimeEntry contract):
  - `timeEntryId` (opaque string ID; do not validate format)
  - associated `workOrderId` (opaque string ID)
  - `technicianId` (opaque string ID)
  - `performedAt` timestamp (ISO-8601)
  - labor quantity in hours (decimal)
  - time entry status indicating eligibility (e.g., `FINALIZED`)
- Workexec endpoint is reachable:
  - `POST /rest/api/v1/workexec/labor-performed` **OR** `POST /api/workexec/labor-performed` (path must be confirmed; see Open Questions)
- Workexec supports idempotency (DECISION-INVENTORY-012):
  - UI sends `Idempotency-Key` for submit operations and reuses it on retry for the same attempt.
- Standard error envelope is used (DECISION-INVENTORY-011):
  - JSON envelope with `code`, `message`, `correlationId`, optional `fieldErrors[]`, optional `existingResourceId` (if applicable).

**Dependency note:** This frontend story depends on an existing/available UI context where a technician can view a TimeEntry and submit it. The canonical TimeEntry screen route(s) are not provided in inputs (blocking clarification).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
At least one entry point must exist (to be confirmed by repo screens):
1. From a **Time Entry detail** screen: ‚ÄúSubmit to Work Order‚Äù action.
2. From a **My Time Entries** list: per-row ‚ÄúSubmit‚Äù / ‚ÄúRetry‚Äù.

(An integration/outbox admin screen is explicitly **out of scope** unless it already exists; this story will not introduce a new queue UI without a separate story.)

### Screens to create/modify
- **Modify**: existing TimeEntry detail screen (exact screen name/path TBD) to add:
  - submission result panel (last attempt outcome)
  - submit/retry action
- **Optional**: existing TimeEntry list screen (exact screen name/path TBD) to add:
  - per-row submit action and status indicator

> Canonical Moqui workexec screens are known (DECISION-INVENTORY-002), but TimeEntry screens are not part of workexec; they likely live under People. Exact screen names/paths must be confirmed (blocking clarification).

### Navigation context
- Standard Moqui screen with a transition:
  - `transition submitLaborPerformed`
  - on success, refresh the same screen with updated status/result
  - on error, show message and keep user on the same screen

### User workflows (happy + alternate)
**Happy path**
1. Mechanic opens a finalized TimeEntry.
2. Clicks ‚ÄúSubmit to Workexec‚Äù.
3. UI shows in-progress state.
4. On success, UI shows ‚ÄúSubmitted‚Äù and records the correlation id for support.

**Alternate paths**
- Mechanic clicks submit twice ‚Üí second call is idempotent; UI shows success (may indicate ‚ÄúAlready submitted‚Äù if replay is detectable).
- Workexec blocks submission due to work order state ‚Üí UI shows non-retriable failure with stable error code.
- Network/5xx transient errors ‚Üí UI indicates ‚ÄúTemporary failure, try again‚Äù and allows manual retry.

---

## 6. Functional Behavior

### Triggers
- User action: click ‚ÄúSubmit to Workexec‚Äù / ‚ÄúRetry submission‚Äù.

### UI actions
- Disable submit button while request is in-flight.
- On completion:
  - Success: show success banner + update status/result panel.
  - Replay success: show success banner noting already submitted **if** replay can be detected (see Open Questions).
  - Failure: show error banner with stable error code + guidance.

### State changes
**Minimum (non-persistent) requirement:** maintain in-screen state for the current session:
- `NOT_SUBMITTED` | `SUBMITTING` | `SUBMITTED` | `FAILED`

**Optional (persistent) enhancement:** if a persistence mechanism exists (Moqui entity or upstream People service field), store:
- lastAttemptAt
- lastHttpStatus
- lastErrorCode
- lastCorrelationId
- lastOutcome (`SUBMITTED`/`FAILED`)

Persistence is **not assumed**; requires clarification/confirmation.

### Service interactions
- Moqui screen transition calls a Moqui service that performs HTTP POST to workexec.
- Headers:
  - `Idempotency-Key`: generated per submission attempt policy (see Business Rules)
  - `X-Correlation-Id`: generated if not already present in request context
  - `Content-Type: application/json`

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
Before allowing submit, UI must validate presence of required fields:
- `timeEntryId` present (opaque string)
- `workOrderId` present (opaque string)
- `technicianId` present (opaque string)
- `performedAt` present and ISO-8601 serializable
- `labor.quantity` > 0
- `labor.unit` = `HOURS`

If missing, block submission and show inline error:  
`Cannot submit: missing/invalid fields: <field list>.`

### Enable/disable rules
- Submit button enabled only when:
  - TimeEntry is in eligible state (expected `FINALIZED`) **based on an explicit field from the TimeEntry contract**.
- Submit button disabled when:
  - request in-flight
  - TimeEntry is not eligible (not finalized)

### Visibility rules
- Show ‚ÄúSubmission Result‚Äù panel if:
  - user attempted submission in this session, **or**
  - persisted submission metadata exists and is loaded.

### Idempotency rules (UI-side)
- UI must send `Idempotency-Key` for submit operations (DECISION-INVENTORY-012).
- **Do not** use raw `timeEntryId` as the idempotency key unless explicitly required by backend contract. Prefer a UUID per attempt and reuse it on retry of the same attempt.
  - Rationale: DECISION-INVENTORY-012 requires reuse for the same attempt; using `timeEntryId` makes all attempts globally identical and prevents distinguishing ‚Äúnew attempt after correction‚Äù vs ‚Äúretry‚Äù.
  - This is blocked pending backend contract confirmation (see Open Questions).

### Error messaging expectations
- Errors must be parsed from the standard envelope (DECISION-INVENTORY-011):
  - Show `code` and `message` to the user (message may be user-safe; if not, show generic + correlationId).
  - Always show `correlationId` in the UI for support.
- For `409` conflict: show stable error code and guidance: ‚ÄúWork order is not accepting labor in its current state.‚Äù
- For `401/403`: show ‚ÄúNot authorized to submit labor performed.‚Äù
- For `404`: show ‚ÄúWork order not found in workexec.‚Äù
- For `400`: show validation failure details (field-level if provided).
- For `5xx/timeout`: show ‚ÄúTemporary failure; please retry.‚Äù

---

## 8. Data Requirements

### Entities involved
- **TimeEntry** (source; owned by People/Job-Time domain; read-only here)
- **LaborPerformed** (workexec target; not stored locally unless a reference is returned)
- **Optional**: SubmissionAttempt (if persistence exists; ownership TBD)

### Fields (types, required, defaults)
**TimeEntry (read)**
- `timeEntryId`: string (opaque id), required
- `workOrderId`: string (opaque id), required
- `technicianId`: string (opaque id), required
- `performedAt`: datetime, required
- `quantityHours`: decimal, required, must be `> 0`
- `status`: enum/string, required (must indicate eligibility)

**Submission payload (derived)**
- `labor.unit`: `"HOURS"` (constant)
- `source.system`: `"people"` (constant)
- `source.sourceReferenceId`: `timeEntryId` (derived)

**Optional persisted submission metadata (if available)**
- `lastAttemptAt`: datetime
- `lastOutcome`: enum (`SUBMITTED`/`FAILED`)
- `lastCorrelationId`: string
- `lastErrorCode`: string
- `lastHttpStatus`: integer
- `idempotencyKey`: string (the key used for the last attempt)

### Read-only vs editable by state/role
- All fields used for submission are read-only in this story.
- No changes to TimeEntry editing behavior.

### Derived/calculated fields
- None beyond payload mapping.

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls
- Load TimeEntry details (existing People/Job-Time service/screen load). **Contract not provided** (blocking clarification).
- Optional: load persisted submission metadata (if exists). **Contract not provided**.

### Submit call (workexec)
**Endpoint (needs confirmation):**
- `POST /rest/api/v1/workexec/labor-performed` (preferred per repo conventions in domain docs)  
  **or**
- `POST /api/workexec/labor-performed` (as referenced in original story)

**Headers:**
- `Idempotency-Key: <string>` (required; see idempotency rules)
- `Content-Type: application/json`
- `X-Correlation-Id: <uuid>` (recommended; generate if missing)

**Request body:**
```json
{
  "workOrderId": "WO-123",
  "technicianId": "TECH-9",
  "performedAt": "2026-01-15T17:30:00Z",
  "labor": { "quantity": 1.50, "unit": "HOURS" },
  "source": { "system": "people", "sourceReferenceId": "TE-456" }
}
```

**Success responses:**
- `201 Created` OR `200 OK` (backend-defined)
- Response body: may include created/updated `laborPerformedId` and/or updated work order summary (not defined; optional to display if present)

**Error responses (standard envelope; DECISION-INVENTORY-011):**
```json
{
  "code": "WORKORDER_STATE_BLOCKED",
  "message": "Work order is not accepting labor in its current state.",
  "correlationId": "c-123",
  "fieldErrors": [
    { "field": "performedAt", "message": "must be present" }
  ]
}
```

### Error handling expectations
- UI must parse `code`, `message`, `correlationId`.
- If `fieldErrors` present, map to inline field errors where applicable; otherwise show banner.
- For 409 with `existingResourceId` (if used by this endpoint), UI may show ‚ÄúAlready submitted‚Äù and optionally store/display the existing id.

---

## 10. State Model & Transitions

### Allowed states
This story does not define work order states; it reacts to workexec responses.
- Workexec is authoritative for whether labor can be posted.
- UI must not hardcode a work order status taxonomy; it must rely on server error codes and/or an `isStarted`/status field if returned (DECISION-INVENTORY-004 guidance).

### Role-based transitions
- UI must gate the submit action based on capability/permission signaling when available (DECISION-INVENTORY-013), but backend remains authoritative (403).
- Exact capability flag name(s) are not provided (blocking clarification).

### UI behavior per state
- If workexec returns a state-blocking conflict:
  - Mark attempt as failed (terminal for that attempt).
  - Keep ‚ÄúRetry‚Äù available (manual), but show guidance that it will continue to fail until work order state changes.
- If success:
  - Mark as submitted; disable submit by default (see Open Questions for final UX).

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing required ids or quantity <= 0:
  - Block submit, show inline validation.

### Workexec rejects due to work order state (409)
- Show `code`, `message`, and `correlationId`.
- Provide navigation link to Work Order detail **if** a work order screen is available in Moqui (canonical: `durion-workexec/WorkOrderEdit.xml`, DECISION-INVENTORY-002) and the user has access.

### Concurrency / duplicate clicks
- Disable button during in-flight to prevent parallel submits.
- If user retries after a timeout, reuse the same `Idempotency-Key` for that attempt (DECISION-INVENTORY-012).

### Unauthorized access
- If `401/403`, display error and do not retry automatically.

### Empty states
- If TimeEntry cannot be loaded, show standard ‚ÄúNot found‚Äù state.

---

## 12. Acceptance Criteria

### Scenario 1: Submit labor performed successfully (first time)
**Given** I am viewing a TimeEntry with eligible status (e.g., `FINALIZED`) and it has `timeEntryId`, `workOrderId`, `technicianId`, `performedAt`, and a positive hours quantity  
**When** I click ‚ÄúSubmit to Workexec‚Äù  
**Then** the system sends a POST request to the configured workexec endpoint with header `Idempotency-Key`  
**And** the request body maps the time entry to the labor-performed schema (unit `HOURS`, source.system `people`, sourceReferenceId = timeEntryId)  
**And** when workexec returns a 2xx success response, the UI shows status `SUBMITTED`  
**And** the UI displays the returned `correlationId` (if present) or the request correlation id used.

### Scenario 2: Retry after timeout reuses Idempotency-Key and does not create duplicates
**Given** I clicked ‚ÄúSubmit to Workexec‚Äù and the request timed out  
**When** I click ‚ÄúRetry‚Äù for the same submission attempt  
**Then** the system re-sends the POST with the same `Idempotency-Key` as the timed-out attempt  
**And** when workexec returns success, the UI shows `SUBMITTED`  
**And** the UI does not show evidence of duplicate creation (no second distinct success record for the same attempt).

### Scenario 3: Work order state blocks submission (conflict)
**Given** I attempt to submit labor for a TimeEntry whose Work Order is not accepting labor in workexec  
**When** workexec responds `409 Conflict` with a standard error envelope containing `code` and `correlationId`  
**Then** the UI shows an actionable error message including the error `code` and `correlationId`  
**And** the UI marks the submission as failed for that attempt  
**And** the UI does not automatically retry.

### Scenario 4: Client-side validation prevents invalid submission
**Given** I am viewing a TimeEntry missing `workOrderId` (or hours quantity is `0`)  
**When** I click ‚ÄúSubmit to Workexec‚Äù  
**Then** the UI prevents the request from being sent  
**And** displays a validation error indicating which required field(s) are missing/invalid.

### Scenario 5: Unauthorized submission is handled safely
**Given** I do not have permission to submit labor performed  
**When** I click ‚ÄúSubmit to Workexec‚Äù  
**Then** the backend responds `403 Forbidden`  
**And** the UI shows a not-authorized message  
**And** the UI does not mark the TimeEntry as submitted.

---

## 13. Audit & Observability
- UI must display (or make available in a copyable support section):
  - `timeEntryId`
  - `workOrderId`
  - last `Idempotency-Key` used (if stored in-session)
  - `correlationId` from response envelope (or request correlation id if response missing)
- Moqui logs for the submit service must include:
  - correlation id
  - idempotency key
  - HTTP status code
  - error `code` from envelope when present
- User-visible: show ‚ÄúLast attempted at‚Äù timestamp **only if** persistence exists; otherwise show ‚ÄúAttempted just now‚Äù in-session.

---

## 14. Non-Functional UI Requirements
- **Performance:** Show loading state immediately; request timeout handling must be explicit (no silent failure).
- **Accessibility:** Status messages and errors must be announced (ARIA live); buttons must have accessible names.
- **Responsiveness:** Usable on tablet-sized UI.
- **i18n:** User-facing strings must be localizable; do not hardcode backend error messages without wrapping/translation strategy (show code + generic message if needed).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty/not-found state messaging for missing TimeEntry data; qualifies as safe because it does not affect business policy, only presentation. Impacted sections: UX Summary, Alternate / Error Flows.
- SD-UX-INFLIGHT-DISABLE: Disable submit button while request is in-flight to prevent accidental double posts; qualifies as safe because idempotency already exists and this only improves ergonomics. Impacted sections: Functional Behavior, Alternate / Error Flows.
- SD-ERR-TRANSIENT-RETRY-MANUAL: Treat 408/429/5xx/timeouts as transient and allow *manual* retry from UI; qualifies as safe because it does not introduce automated domain side effects and mirrors common HTTP semantics. Impacted sections: Service Contracts, Alternate / Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. **Canonical TimeEntry screens/routes:** What are the Moqui screen paths for TimeEntry list/detail where this action must be implemented (component + screen name), and what menu/entry point should be used?
2. **TimeEntry load contract:** What service/endpoints provide TimeEntry details to the UI, and what are the exact field names for `id`, `status`, `workOrderId`, `technicianId`, `performedAt`, and hours quantity?
3. **Workexec endpoint path + replay signaling:** Is the correct endpoint `/rest/api/v1/workexec/labor-performed` or `/api/workexec/labor-performed`? Does workexec return an `Idempotency-Replayed` header (or equivalent) on replay, or should UI treat any 2xx as success without distinguishing replay?
4. **Idempotency-Key policy:** Does workexec require `Idempotency-Key = timeEntryId` specifically, or does it accept any client-generated key? If it accepts any key, confirm that UI should generate a UUID per attempt and reuse it on retry (preferred per DECISION-INVENTORY-012).
5. **Permission/capability signal:** What capability/permission controls visibility/enabled state of the submit action (DECISION-INVENTORY-013), and where does the UI read it (session claims vs user context endpoint)?
6. **Persistence of submission metadata:** Should submission attempt status be persisted (and where)? If yes, define the owning system and required fields (lastOutcome, lastAttemptAt, lastErrorCode, lastCorrelationId, lastIdempotencyKey).

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #138: [FRONTEND] [STORY] Scheduling: View Schedule by Location and Resource
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Work Execution: Dispatch Board (Daily Schedule by Location/Resource) with Conflict Flags (Read-only)

### Primary Persona
Dispatcher

### Business Value
Enables dispatchers to view a single-day schedule organized by location and resource (bay/mobile/person where available) to manage capacity, identify overlaps, and prevent double-booking‚Äîwhile degrading gracefully if secondary data sources (People availability) are unavailable.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Dispatcher  
- **I want** to view a daily dispatch board for a selected location, grouped by resource, with conflicts highlighted  
- **So that** I can manage workload, avoid resource collisions, and adjust assignments proactively.

### In-scope and out-of-scope

**In Scope**
- A read-only daily dispatch board screen that:
  - Filters by **location** and **day** (required), and optionally **resource type** and **resource**
  - Loads board data from **workexec-owned** read model/screen (`WorkOrderBoard.xml`) or a read-only endpoint if present
  - Highlights work orders/events flagged with conflicts/exceptions and shows details (stable exception codes)
  - Optionally overlays People availability as a **soft dependency** (non-blocking)

**Out of Scope**
- Editing schedule events (create/update appointments, blocks, etc.)
- Drag/drop rescheduling, assignment changes, or conflict resolution workflows
- Authoring location hours, resource definitions, or People availability rules (owned by shopmgr/location/people)
- Implementing People availability provider (frontend consumes if present; must not block board)
- Introducing a new scheduling system-of-record (appointments remain shopmgr SoR)

---

## 3. Actors & Stakeholders
- **Dispatcher (primary):** views dispatch board to manage capacity/conflicts
- **Service Advisor (secondary):** references board when coordinating customer work
- **Shop Manager (secondary):** reviews schedule health/utilization
- **Workexec backend (system actor):** provides work order board view (authoritative for work order execution data)
- **Shopmgr backend (dependency):** appointment details via `appointmentId` link when needed
- **People backend (optional dependency):** availability overlay (read-only signal)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User has explicit permission to view dispatch board: `WORKEXEC_DISPATCH_VIEW` (DECISION-INVENTORY-013).
- User is a member of / authorized for the selected location (enforced server-side; UI handles 403).

### Dependencies
- Canonical Moqui screen exists in workexec component: `durion-workexec/WorkOrderBoard.xml` (DECISION-INVENTORY-002).
- Appointments are shopmgr SoR and linked via `DurWorkOrder.appointmentId` (DECISION-INVENTORY-010).
- If People availability overlay is shown, it is fetched separately and must not block board rendering (DECISION-INVENTORY-009).
- Timezone semantics:
  - Display timestamps in **user timezone**
  - Day-bucket filters interpreted in **shop/location timezone when available**, otherwise user timezone with explicit labeling (DECISION-INVENTORY-016).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Work Execution ‚Üí Dispatch / Work Order Board**
- Deep link (recommended):  
  `/durion-workexec/WorkOrderBoard?locationId=...&viewDate=YYYY-MM-DD&resourceType=...&resourceId=...&includeAvailability=0|1`

### Screens to create/modify
- **Modify/Extend (preferred):** `durion-workexec/WorkOrderBoard.xml`
  - Add/standardize filter inputs (location/day/resourceType/resourceId)
  - Add conflict/exception indicators and details panel
  - Add optional People availability overlay section (non-blocking)
- **No new screen required** unless repo conventions require a wrapper screen; if so, create a thin wrapper that transitions to `WorkOrderBoard.xml` while preserving query params.

### Navigation context
- User remains in Work Execution context.
- Filter changes update the board without leaving the screen (same screen, re-render region).

### User workflows (happy + alternate paths)

**Happy path**
1. Dispatcher opens Work Order Board.
2. Selects **Location** and **Day** (defaults allowed; see Applied Safe Defaults).
3. Optionally selects **Resource Type** and/or **Resource**.
4. Board loads and renders resources/lanes with work items for the day.
5. Dispatcher selects a work item to view details; conflict/exception flags are visible and explainable.

**Alternate paths**
- Toggle ‚ÄúInclude People availability‚Äù:
  - Board renders immediately from workexec data
  - Availability loads in parallel; if it fails, show warning and keep board usable
- If a work item references an appointment (`appointmentId`), user can navigate to shopmgr appointment screen (read-only/edit per shopmgr permissions):
  - `durion-shopmgr/AppointmentEdit.xml` (DECISION-INVENTORY-002, DECISION-INVENTORY-010)

---

## 6. Functional Behavior

### Triggers
- Screen load when required parameters are present:
  - `locationId` and `viewDate` (day)
- User changes any filter:
  - `locationId`, `viewDate`, `resourceType`, `resourceId`, `includeAvailability`

### UI actions
- **Load Board**
  - Show loading indicator in board region
  - Prevent duplicate in-flight loads (latest-wins)
- **Select Work Item**
  - Open a read-only details panel/section showing:
    - Work order identifiers (opaque IDs)
    - Time window (if present)
    - Linked appointment (if present) with navigation action
    - Conflict/exception indicators with stable codes and human-readable messages
- **View Conflicts/Exceptions**
  - For flagged items, show:
    - Severity (blocking vs warning)
    - List of conflicting item IDs (if provided)
    - Exception code(s) (stable enum/code strings)

### State changes
- Screen state machine:
  - `idle` ‚Üí `loading` ‚Üí `loaded` or `error`
- Filter state persisted in URL query params for shareable deep links.

### Service interactions
- Primary: load board data from workexec (Moqui screen actions or REST if already present).
- Optional: load People availability overlay in parallel (separate call).
- Optional: load appointment details only on-demand when user opens appointment link (shopmgr).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `locationId` is required before loading board.
- `viewDate` is required in `YYYY-MM-DD`.
- IDs are opaque strings; UI must not validate UUID/numeric formats (DECISION-INVENTORY-003).
- If `resourceType` is offered, it must be limited to backend-supported values; UI must not invent types.

### Enable/disable rules
- While board is loading:
  - Allow changing filters, but apply latest-wins (cancel/ignore prior response).
- Resource selector:
  - Disabled until `resourceType` selected (if resourceType is part of UX).
  - Options derived from returned resources/lanes when available.

### Visibility rules
- If People availability overlay fails:
  - Show non-blocking warning banner; board remains visible (DECISION-INVENTORY-009).
- If conflicts/exceptions exist:
  - Show per-item indicator and details in the details panel.
- If user lacks permission (`WORKEXEC_DISPATCH_VIEW`) or location membership:
  - Show access denied empty state; keep filters visible to switch location (DECISION-INVENTORY-013).

### Error messaging expectations
- Normalize errors to standard envelope where applicable (DECISION-INVENTORY-011):
  - `code`, `message`, `correlationId`, optional `fieldErrors[]`
- User-facing messages:
  - 400: ‚ÄúInvalid filters. Please verify location and date.‚Äù
  - 403: ‚ÄúYou don‚Äôt have access to this dispatch board or location.‚Äù
  - 404: ‚ÄúLocation or resource not found.‚Äù
  - 5xx/timeouts: ‚ÄúDispatch board is unavailable. Try again.‚Äù
- If People overlay fails but board succeeds:
  - ‚ÄúPeople availability is currently unavailable; dispatch board data may be incomplete.‚Äù

---

## 8. Data Requirements

### Entities involved
- Workexec:
  - `durion.workexec.DurWorkOrder` (board rows/cards/lanes)
- Shopmgr (linked, optional on-demand):
  - `durion.shopmgr.DurShopAppointment` via `DurWorkOrder.appointmentId`
- People (optional overlay):
  - Availability read model (endpoint TBD; see Open Questions)

### Fields (type, required, defaults)

**Request parameters (UI model)**
- `locationId` (string, required; opaque ID)
- `viewDate` (string `YYYY-MM-DD`, required; interpreted in shop timezone when available per DECISION-INVENTORY-016)
- `resourceType` (string enum, optional; backend-supported)
- `resourceId` (string, optional; opaque ID)
- `includeAvailability` (boolean, optional; default false)

**Response / View model (minimum required for v1)**
Because `WorkOrderBoard.xml` is the canonical implementation (DECISION-INVENTORY-002) and a REST contract is not confirmed, the frontend must support rendering from a Moqui screen-provided context map. Minimum fields required in the screen context (names may be mapped in screen actions):
- `asOf` (instant string, optional; ‚ÄúLast updated‚Äù)
- `timezoneLabel` (string, required; e.g., `America/Chicago` or `User Local Time`)
- `resources[]` (array, required; may be empty)

**Resource lane**
- `resourceId` (string, required)
- `resourceType` (string, required)
- `resourceName` (string, required)
- `items[]` (array, required; may be empty)

**Board item (work order / appointment-backed work)**
- `workOrderId` (string, required)
- `statusId` (string, required)
- `appointmentId` (string, optional)
- `startTime` / `endTime` (instant string, optional; if not available, UI must still render item without time grid)
- `title` (string, required; e.g., RO/customer/vehicle summary if provided)
- `exceptions[]` (array of objects, optional)
  - `code` (string, required)
  - `severity` (`BLOCKING|WARNING`, required)
  - `message` (string, required)
  - `conflictingIds[]` (string[], optional)

### Read-only vs editable by state/role
- Entire screen is read-only in v1 (DECISION-INVENTORY-009).

### Derived/calculated fields
- `durationMinutes` derived when both `startTime` and `endTime` exist (display-only).
- `isStale` derived if `asOf` older than a UI threshold (display-only; threshold TBD by UI ergonomics).

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls

**Primary (Moqui screen render)**
- `GET /webroot/durion-workexec/WorkOrderBoard?locationId=...&viewDate=YYYY-MM-DD&resourceType=...&resourceId=...`
- Authorization enforced by Moqui artifact auth; must require `WORKEXEC_DISPATCH_VIEW` (DECISION-INVENTORY-013).

**Optional (if REST read model exists now or later)**
- `GET /rest/api/v1/workexec/dispatch-board?locationId=...&viewDate=YYYY-MM-DD&resourceType=...&resourceId=...`
- Must be read-only, filter-required, and return stable exception codes and `asOf` (DECISION-INVENTORY-009).

### Create/update calls
- none

### Submit/transition calls
- none

### Error handling expectations
- For REST calls (if used), parse standard error envelope (DECISION-INVENTORY-011) and surface `correlationId` in an expandable ‚ÄúDetails‚Äù section for support.
- For Moqui screen render errors:
  - Show generic error banner and log correlation/request id if present in headers.

---

## 10. State Model & Transitions

### Allowed states
- `idle`: required filters missing
- `loading`: board request in-flight
- `loaded`: board rendered
- `error`: board failed to load (may show last known good data)

### Role-based transitions
- If user lacks `WORKEXEC_DISPATCH_VIEW` or location membership:
  - transition to `error` with 403 messaging; do not render board data.

### UI behavior per state
- `idle`: prompt to select location and day.
- `loading`: show skeleton/loader; latest-wins.
- `loaded`: show lanes/items; allow selection for details.
- `error`: show error + retry; keep filters visible; if last good data exists, show it with ‚Äústale‚Äù label.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing `locationId` or `viewDate`:
  - Do not load; show inline prompt.
- Invalid `viewDate` format:
  - Block load; show inline validation.

### Concurrency conflicts
- Read-only; handle rapid filter changes:
  - cancel prior request or ignore out-of-order responses (latest-wins).

### Unauthorized access
- 403:
  - Show access denied empty state
  - Keep filters visible to switch location/day

### Empty states
- No resources:
  - ‚ÄúNo schedulable resources found for this location/day.‚Äù
- Resources with no items:
  - ‚ÄúNo work scheduled in the selected day.‚Äù
- No conflicts/exceptions:
  - No special banner; indicators absent.

### Partial dependency failure (People overlay)
- People availability request fails:
  - Show warning banner and render board without overlay (DECISION-INVENTORY-009).

---

## 12. Acceptance Criteria

### Scenario 1: View dispatch board for a location/day (Moqui screen)
**Given** I am an authenticated user with capability `WORKEXEC_DISPATCH_VIEW`  
**And** I am authorized for location `<locationId>`  
**When** I open `/durion-workexec/WorkOrderBoard?locationId=<locationId>&viewDate=<date>`  
**Then** the board renders a list of resources/lanes for that location/day  
**And** each lane renders its items (or an empty message)  
**And** the UI displays the timezone label used for the day.

### Scenario 2: Filter by resource type
**Given** I am viewing the dispatch board for `<locationId>` and `<date>`  
**When** I select resourceType `<resourceType>`  
**Then** the board reloads with `resourceType=<resourceType>` in the query parameters  
**And** only lanes returned for that resourceType are rendered.

### Scenario 3: Filter to a single resource
**Given** I am viewing the dispatch board for `<locationId>` and `<date>`  
**And** the UI has a resource selector populated from the returned lanes  
**When** I select resource `<resourceId>`  
**Then** the board reloads with `resourceId=<resourceId>`  
**And** only that lane is rendered.

### Scenario 4: Conflicts/exceptions are flagged with details
**Given** the board data includes an item with an exception `{ code: "<code>", severity: "BLOCKING" }`  
**When** I view the lane and select the item  
**Then** the item is visibly flagged as blocking  
**And** the details panel shows the exception code, message, and any `conflictingIds`.

### Scenario 5: People availability overlay is non-blocking
**Given** I enable ‚ÄúInclude People availability‚Äù  
**And** the People availability request fails  
**When** the board request succeeds  
**Then** the dispatch board lanes/items still render  
**And** I see a non-blocking warning indicating People availability is unavailable.

### Scenario 6: Unauthorized access to board or location
**Given** I attempt to load the board without `WORKEXEC_DISPATCH_VIEW` or without location authorization  
**When** the server responds with `403 Forbidden`  
**Then** the UI shows an access denied message  
**And** does not render board data  
**And** I can change location/day filters and retry.

### Scenario 7: Latest-wins on rapid filter changes
**Given** I change the day filter twice quickly from `<date1>` to `<date2>`  
**When** the `<date1>` response arrives after the `<date2>` response  
**Then** the UI renders the `<date2>` board  
**And** ignores the stale `<date1>` response.

---

## 13. Audit & Observability

### User-visible audit data
- Show ‚ÄúLast updated‚Äù using `asOf` when available (DECISION-INVENTORY-009).

### Status history
- Not applicable (read-only board). No mutations.

### Traceability expectations
- For REST calls (if used), log `correlationId` from standard error envelope on failures (DECISION-INVENTORY-011).
- Client logs/telemetry (if enabled by project conventions) include:
  - `locationId`, `viewDate`, `resourceType`, `resourceId`, `includeAvailability`
  - load duration
  - whether People overlay succeeded/failed

---

## 14. Non-Functional UI Requirements

- **Performance:** One primary board load per filter change; People overlay fetched in parallel and must not block rendering (DECISION-INVENTORY-009).
- **Accessibility:** Conflict/exception indicators must not rely on color alone; include text labels for severity and exception code.
- **Responsiveness:** Must be usable on typical shop tablet widths; lanes may collapse to list view as needed.
- **i18n/timezone:** Display timestamps in user timezone; day filter interpreted in shop timezone when available; always label timezone used (DECISION-INVENTORY-016).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATES: Provide explicit empty states for ‚Äúno resources‚Äù and ‚Äúno items‚Äù; qualifies as safe because it changes only presentation, not domain logic. Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- SD-UX-DEBOUNCE-LATEST-WINS: Debounce filter-triggered loads and ignore out-of-order responses; qualifies as safe because it prevents duplicate reads without altering business rules. Impacted sections: Functional Behavior, Alternate / Error Flows, Non-Functional UI Requirements.
- SD-ERR-HTTP-STATUS-MAP: Standard mapping of 400/403/404/5xx to user messages; qualifies as safe because it follows backend contract and affects only UI messaging. Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows.

---

## 16. Open Questions
1. **Domain/SoR clarification (blocking):** Is this ‚ÄúDaily Schedule‚Äù intended to be the **workexec dispatch board** (work orders) or a **shopmgr scheduling calendar** (appointments/blocks)? Current workexec guidance supports `WorkOrderBoard.xml` (workexec) and treats appointments as linked via `appointmentId` (shopmgr). Confirm the intended SoR and primary dataset for this screen.
2. **Contract clarification (blocking):** Should the frontend implement this purely by extending `durion-workexec/WorkOrderBoard.xml` (Moqui screen render), or is there an existing REST endpoint (path + schema) that must be used? The story currently references `GET /api/v1/schedules/view`, which is not aligned to the workexec canonical screen guidance.
3. **Resource model clarification (blocking):** What resource types are supported for grouping in v1 (e.g., `BAY`, `MOBILE`, `PERSON`)? If `PERSON` is supported, is it sourced from People domain and how is it represented in the board response?
4. **Timezone source (blocking):** Where does the frontend obtain **shop/location timezone** for interpreting `viewDate` bucketing (DECISION-INVENTORY-016)? Is it available on the location entity/context today, or must the UI label and use user timezone until provided?
5. **Exception/conflict codes (blocking):** What are the stable exception/conflict code enums and their meanings for the board (DECISION-INVENTORY-009)? Provide the list or the source of truth so UI can render consistent labels and tests can assert behavior.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #137: [FRONTEND] [STORY] Scheduling: Reschedule or Cancel Appointment with Audit
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] Scheduling: Reschedule or Cancel Appointment with Audit (Moqui Screens)

**Primary Persona:** Dispatcher

**Business Value:** Keep the shop plan accurate by allowing Dispatchers to reschedule/cancel scheduled appointments with a complete audit trail and downstream notification when the appointment is linked to an Estimate or Work Order.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Dispatcher  
- **I want** to reschedule or cancel a previously scheduled appointment  
- **So that** the schedule remains accurate, changes are auditable, and work execution workflows stay in sync when an appointment is linked to an Estimate/Work Order.

### In-scope
- View an Appointment and its current scheduling details (shopmgr SoR; displayed in workexec UI).
- Reschedule an appointment by changing:
  - scheduled time window (start/end)
  - optionally assigned resource (technician/resource) **if supported by shopmgr**
- Cancel an appointment by providing:
  - cancellation reason code (required)
  - cancellation notes (optional)
- Display audit history for reschedule/cancel actions (minimum: created/updated metadata; full audit list if endpoint exists).
- When an appointment is linked to an Estimate or Work Order, ensure the backend is notified by calling the authoritative shopmgr/workexec API (frontend does not emit events).  
  - **Decision rationale:** Per DECISION-INVENTORY-010, appointments are shopmgr entities; workexec consumes via link (`appointmentId`) and must not become SoR for scheduling.
- Frontend validation and error handling consistent with backend rules:
  - only `Scheduled` appointments can be rescheduled/cancelled
  - handle conflicts (resource unavailable) and invalid state
  - handle idempotent retries for mutation calls (Idempotency-Key)

### Out-of-scope
- Creating appointments.
- Defining/configuring cancellation reason codes (source-of-truth list management).
- Notifications to customer (SMS/email).
- Editing/creating Work Orders/Estimates as a result of changes (only linkage awareness).
- Any dispatch-board aggregation (read-only board is separate scope).

---

## 3. Actors & Stakeholders
- **Dispatcher (Primary):** performs reschedule/cancel actions.
- **Service Advisor (Secondary stakeholder):** relies on accurate appointment status and audit.
- **Technician/Resource (Secondary):** assignment changes affect workload.
- **Shop Management (shopmgr) services (System of Record):** appointment update/cancel APIs and audit persistence; emits domain events as needed.
- **Workexec (Consumer):** displays appointment linkage on work order/estimate screens; may be impacted by appointment changes via integration.

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend.
- User has permission to view appointments and (if allowed) modify appointments (exact permission/capability names TBD; see Open Questions).
- Appointment exists and can be loaded by opaque `appointmentId` (treat as string; no UUID/numeric assumptions).  
  - **Decision rationale:** DECISION-INVENTORY-003 (IDs are opaque strings).
- Backend endpoints exist and are reachable (authoritative owner expected to be shopmgr):
  - Load appointment details
  - Reschedule appointment
  - Cancel appointment
  - Load audit history (or at minimum created/updated metadata)
  - Load cancellation reason codes (if controlled list)
  - (Optional) resource picker / availability query
- Backend enforces:
  - state rules (only Scheduled modifiable)
  - resource availability checks
  - authorization (403)
  - standard error envelope with `correlationId` (DECISION-INVENTORY-011)
  - idempotency for create/submit/mutations using `Idempotency-Key` (DECISION-INVENTORY-012)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From workexec Work Order edit screen when `DurWorkOrder.appointmentId` is present:
  - `durion-workexec/WorkOrderEdit.xml` ‚Üí link ‚ÄúView Appointment‚Äù opens shopmgr appointment screen.
- From shopmgr scheduling UI (if present) via menu/navigation to appointment detail.
- From a deep link route with `appointmentId`.

### Screens to create/modify
1. **Modify existing shopmgr screen (preferred): `durion-shopmgr/AppointmentEdit.xml`**
   - **Decision rationale:** DECISION-INVENTORY-002 (use existing screens/routes; appointments are shopmgr).
   - Add/ensure:
     - Read-only appointment summary (status, window, assigned resource)
     - Actions:
       - `Reschedule` (enabled only when status == `Scheduled`)
       - `Cancel` (enabled only when status == `Scheduled`)
     - Audit section:
       - If audit endpoint exists: list entries
       - Else: show created/updated metadata and a placeholder ‚ÄúAudit history not available‚Äù message

2. **(Optional) Workexec link-out integration in `durion-workexec/WorkOrderEdit.xml`**
   - Display appointment summary snippet (read-only) and link to `durion-shopmgr/AppointmentEdit.xml?appointmentId=...`.

### Navigation context
- After successful reschedule/cancel:
  - remain on AppointmentEdit (shopmgr) and refresh appointment + audit section
  - use PRG (Post/Redirect/Get) to avoid double-submit
- If opened from WorkOrderEdit:
  - provide ‚ÄúBack to Work Order‚Äù link (no implicit cross-screen mutation)

### User workflows (happy + alternate)
- **Happy path (Reschedule):**
  1. Open AppointmentEdit
  2. Click Reschedule
  3. Edit start/end (and optionally resource)
  4. Submit
  5. See updated window/resource and audit entry/metadata
- **Happy path (Cancel):**
  1. Open AppointmentEdit
  2. Click Cancel
  3. Select reason + optional notes
  4. Submit
  5. Status becomes Cancelled; reason/notes visible; audit entry/metadata visible
- **Alternate (resource conflict):**
  - Backend returns 409 conflict; UI shows conflict message; keeps form values
- **Alternate (state changed):**
  - Backend returns 409 invalid state; UI refreshes and disables actions

---

## 6. Functional Behavior

### Triggers
- Dispatcher clicks **Reschedule** or **Cancel** on AppointmentEdit.

### UI actions
- **Reschedule**
  - Open modal/dialog (or sub-screen) with fields prefilled from current appointment:
    - `scheduledStart`
    - `scheduledEnd`
    - `assignedResourceId` (if present)
  - Validate client-side:
    - start present
    - end present
    - start < end
  - On submit:
    - generate `Idempotency-Key` (UUID) for this submit attempt; reuse on retry of same attempt
    - call reschedule service
    - on success: redirect to GET AppointmentEdit and reload audit section

- **Cancel**
  - Open modal/dialog with fields:
    - `cancellationReasonCode` (required; dropdown)
    - `cancellationNotes` (optional)
  - Validate client-side:
    - reason code present
  - On submit:
    - generate `Idempotency-Key` for this submit attempt; reuse on retry
    - call cancel service
    - on success: redirect to GET AppointmentEdit and reload audit section

### State changes (frontend-observed)
- Reschedule success:
  - appointment window changes; assigned resource may change
  - audit/metadata reflects change
- Cancel success:
  - status becomes `Cancelled`
  - cancellation reason/notes displayed (if returned; otherwise reload and display from GET)
  - audit/metadata reflects change
- No optimistic updates; always treat backend as authoritative.

### Service interactions
- On AppointmentEdit load:
  - load appointment details
  - load audit history (if available)
  - load cancellation reason codes (if needed for cancel dialog; can be lazy-loaded on dialog open)
  - (Optional) load resource picker options / availability query for reschedule dialog

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Modifiable only in `Scheduled`**
  - If status != `Scheduled`:
    - disable Reschedule and Cancel actions
    - show helper text: ‚ÄúThis appointment is <status> and cannot be modified.‚Äù
  - If stale UI submits anyway:
    - handle 409 with standard envelope; refresh appointment and show message

- **Cancellation reason must be from authoritative list**
  - UI must render a controlled selection sourced from backend/config
  - If backend returns 400 invalid reason:
    - show inline error on reason field using `fieldErrors[]` when available (DECISION-INVENTORY-011)

- **Reschedule must respect availability**
  - Backend is authoritative; UI must not assume availability
  - On 409 conflict:
    - show message and keep dialog open with values preserved

### Enable/disable rules
- Reschedule enabled iff `appointment.status == Scheduled` AND user has modify capability (if provided) else rely on 403 handling.
- Cancel enabled iff `appointment.status == Scheduled` AND user has modify capability (if provided) else rely on 403 handling.

### Visibility rules
- Link indicators:
  - If appointment payload includes `workOrderId` and/or `estimateId` (or equivalent refs), show ‚ÄúLinked to Work Order/Estimate‚Äù with link-out where routes exist.
- Audit section:
  - Always visible; if no entries, show empty state.

### Error messaging expectations (standardized)
All API errors should be normalized to the standard envelope (DECISION-INVENTORY-011):
- 404: ‚ÄúAppointment not found.‚Äù
- 403: ‚ÄúYou do not have permission to modify appointments.‚Äù
- 409 invalid state: ‚ÄúAppointment cannot be modified because it is <status>.‚Äù
- 409 resource conflict: ‚ÄúSelected resource is unavailable for that time window.‚Äù
- 400 validation: field-level messages (time window, reason code)
- Include `correlationId` in error toast/details for support.

---

## 8. Data Requirements

### Entities involved
- `durion.shopmgr.DurShopAppointment` (Appointment; shopmgr SoR)
- `AppointmentAudit` (name TBD; shopmgr-owned if exists)
- Link references (either on appointment or via workexec entities):
  - `durion.workexec.DurWorkOrder.appointmentId` (workexec link to appointment; DECISION-INVENTORY-010)

### Fields (type, required, defaults)

**Appointment (DurShopAppointment)**
- `appointmentId` (id/opaque string, required, read-only)
- `statusId` (enum/string, required, read-only)
  - expected values for this story: `SCHEDULED`, `IN_PROGRESS`, `COMPLETED`, `CANCELLED` (exact IDs TBD)
- `scheduledStart` (datetime, required when scheduled, editable via reschedule action)
- `scheduledEnd` (datetime, required when scheduled, editable via reschedule action)
- `assignedResourceId` (id/opaque string, optional, editable via reschedule action if supported)
- `workOrderId` (id/opaque string, optional, read-only) **or** `appointmentId` is referenced by work order; exact direction TBD
- `estimateId` (id/opaque string, optional, read-only) (if appointment links to estimate)
- `cancellationReasonCode` (string, nullable; required when cancelled)
- `cancellationNotes` (string/text, nullable)
- `createdDate` (datetime, read-only)
- `createdByUserId` (id/opaque string, read-only)
- `lastUpdatedDate` (datetime, read-only)
- `lastUpdatedByUserId` (id/opaque string, read-only)

**AppointmentAudit (if available)**
- `auditId` (id/opaque string, required, read-only)
- `appointmentId` (id/opaque string, required, read-only)
- `eventTime` (datetime UTC, required, read-only)
- `actorUserId` (id/opaque string, required, read-only)
- `action` (enum/string, required, read-only): `CREATED`, `RESCHEDULED`, `CANCELLED`
- `changes` (json/text, optional, read-only)

**CancellationReasonCode**
- `code` (string, required)
- `label` (string, required)
- `isActive` (boolean, required; only active shown)

### Read-only vs editable (by state/role)
- Editable only via action endpoints and only when status is scheduled:
  - `scheduledStart`, `scheduledEnd`, `assignedResourceId`
  - `cancellationReasonCode`, `cancellationNotes`
- All other fields read-only.

### Derived/calculated fields
- `scheduledTimeWindowDisplay` derived from start/end in **user timezone** (DECISION-INVENTORY-016).
- If a ‚Äúdispatch day‚Äù filter exists elsewhere, it must bucket by shop timezone when available (not required in this story).

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementation may use screen transitions calling services rather than REST; however, the frontend must behave as if calling these contracts. Exact paths remain blocking until confirmed.

### Load/view calls
- `GET <APPOINTMENT_GET_ENDPOINT>/{appointmentId}`
  - Returns Appointment fields listed above.
- `GET <APPOINTMENT_AUDIT_ENDPOINT>/{appointmentId}/audit` (optional)
  - Returns list of audit entries sorted by `eventTime` desc.
- `GET <CANCELLATION_REASONS_ENDPOINT>`
  - Returns active cancellation reasons.

### Create/update calls (mutations)
All mutation requests MUST include:
- `Idempotency-Key: <uuid>` header (DECISION-INVENTORY-012)

**Reschedule**
- `POST <APPOINTMENT_RESCHEDULE_ENDPOINT>/{appointmentId}/reschedule`
- Request:
  - `scheduledStart` (ISO-8601 with offset or Z; see Open Questions)
  - `scheduledEnd` (ISO-8601 with offset or Z)
  - `assignedResourceId` (optional)
- Response:
  - `200 OK` with updated Appointment OR `204 No Content` (then UI reloads)

**Cancel**
- `POST <APPOINTMENT_CANCEL_ENDPOINT>/{appointmentId}/cancel`
- Request:
  - `cancellationReasonCode` (string)
  - `cancellationNotes` (optional string)
- Response:
  - `200 OK` with updated Appointment OR `204 No Content` (then UI reloads)

### Submit/transition calls
- Not applicable beyond reschedule/cancel.

### Error handling expectations
- Errors conform to standard envelope (DECISION-INVENTORY-011):
  - `{ code, message, correlationId, fieldErrors?, existingResourceId? }`
- 400: validation errors (fieldErrors)
- 403: unauthorized
- 404: not found
- 409: conflict (invalid state or resource unavailable)
- UI behavior:
  - show toast/banner with `message`
  - show inline field errors when `fieldErrors` present
  - include `correlationId` in an expandable ‚ÄúDetails‚Äù section

---

## 10. State Model & Transitions

### Appointment allowed states (frontend-relevant)
- `SCHEDULED`
- `IN_PROGRESS`
- `COMPLETED`
- `CANCELLED`

### Allowed transitions (in scope)
- `SCHEDULED` ‚Üí `SCHEDULED` (reschedule)
- `SCHEDULED` ‚Üí `CANCELLED` (cancel)

### Role-based transitions
- Dispatcher can trigger reschedule/cancel if authorized.
- Backend remains authoritative; UI may optionally gate using capability flags if provided (DECISION-INVENTORY-013 pattern), but must still handle 403.

### UI behavior per state
- `SCHEDULED`: actions enabled (subject to permission)
- `IN_PROGRESS` / `COMPLETED` / `CANCELLED`: actions disabled; show explanation
- `CANCELLED`: show cancellation reason/notes

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Reschedule end <= start:
  - block submit; inline error ‚ÄúEnd time must be after start time.‚Äù
- Cancel missing reason:
  - block submit; inline error ‚ÄúReason is required.‚Äù

### Backend validation failures (400)
- Invalid reason code:
  - show inline error on reason field (from `fieldErrors`)
- Invalid time window:
  - show inline errors on start/end fields

### Conflicts (409)
- Invalid state:
  - show message; close dialog; refresh appointment; actions disabled
- Resource unavailable:
  - show message; keep reschedule dialog open; preserve inputs

### Concurrency / stale data
- If backend indicates stale version (if version token exists):
  - treat as 409; refresh and inform user ‚ÄúAppointment was updated by another user; please retry.‚Äù
- If no version token:
  - still handle 409 and refresh.

### Unauthorized (403)
- Show ‚ÄúYou do not have permission to modify appointments.‚Äù
- Disable actions for the remainder of the session on that screen instance (until reload).

### Empty states
- Audit history empty:
  - show ‚ÄúNo changes recorded yet.‚Äù
- Cancellation reasons unavailable (endpoint failure):
  - disable Cancel submit and show ‚ÄúUnable to load cancellation reasons. Try again.‚Äù

---

## 12. Acceptance Criteria

### Scenario 1: Reschedule a Scheduled appointment successfully
**Given** I am logged in as a Dispatcher with permission to modify appointments  
**And** an appointment exists with status `SCHEDULED`  
**When** I submit a reschedule with a new start/end window (end after start) and an available resource (or no resource)  
**Then** the appointment detail must display the updated scheduled window (and resource if changed)  
**And** the UI must not double-submit on refresh/back (PRG behavior)  
**And** the UI must display either (a) a new audit entry with action `RESCHEDULED` **or** (b) updated metadata (`lastUpdatedDate/By`) if audit endpoint is not available.

### Scenario 2: Cancel a Scheduled appointment successfully
**Given** I am logged in as a Dispatcher with permission to modify appointments  
**And** an appointment exists with status `SCHEDULED`  
**When** I cancel the appointment providing a valid cancellation reason code  
**Then** the appointment status must display as `CANCELLED`  
**And** the cancellation reason code (and notes if entered) must be displayed  
**And** the UI must display either (a) a new audit entry with action `CANCELLED` **or** (b) updated metadata (`lastUpdatedDate/By`) if audit endpoint is not available.

### Scenario 3: Attempt to reschedule a Completed appointment is rejected
**Given** I am logged in as a Dispatcher  
**And** an appointment exists with status `COMPLETED`  
**When** I view the appointment detail  
**Then** the Reschedule action must be disabled  
**And** if I attempt to submit via a stale UI and the API returns 409  
**Then** the UI must show an error message indicating the appointment cannot be modified in its current status  
**And** the displayed appointment data must refresh and remain unchanged.

### Scenario 4: Resource conflict during reschedule
**Given** I am logged in as a Dispatcher with permission to modify appointments  
**And** an appointment exists with status `SCHEDULED`  
**When** I reschedule to a time window where the selected resource is unavailable  
**Then** the UI must display a conflict error message  
**And** the reschedule form must remain open with my entered values preserved  
**And** the appointment must not be updated.

### Scenario 5: Cancel fails without a valid reason code
**Given** I am logged in as a Dispatcher with permission to modify appointments  
**And** an appointment exists with status `SCHEDULED`  
**When** I submit cancellation without a reason code  
**Then** the UI must show an inline validation error without calling the backend  
**And** the appointment must not be updated.  

**When** I submit cancellation with an invalid reason code and the backend returns 400 with field errors  
**Then** the UI must show the server-provided inline error  
**And** the appointment must not be updated.

### Scenario 6: Idempotent retry on mutation
**Given** I am logged in as a Dispatcher with permission to modify appointments  
**And** an appointment exists with status `SCHEDULED`  
**When** I submit a reschedule (or cancel) and the network request is retried with the same `Idempotency-Key`  
**Then** the backend response must not create duplicate audit entries beyond the single logical action  
**And** the UI must end in a consistent state showing the final appointment values.

---

## 13. Audit & Observability

### User-visible audit data
- Appointment detail must show:
  - timestamps displayed in **user timezone** (DECISION-INVENTORY-016) and labeled if needed
  - actor (ID and/or display name if available)
  - action type (RESCHEDULED/CANCELLED)
  - changed fields summary (from `changes` if provided)

### Status history
- If audit endpoint exists: audit list is the history.
- If not: show created/updated metadata as minimum audit visibility (DECISION-INVENTORY-014).

### Traceability expectations
- For any error response with `correlationId`, UI must display it in an expandable details section and include it in console log (frontend) for support.
- For mutation calls, UI should include `Idempotency-Key` in client logs for troubleshooting (do not display to end-user by default).

---

## 14. Non-Functional UI Requirements

- **Performance:** Appointment detail (appointment + audit/metadata) should render within 2s on typical network; audit list paginated if large.
- **Accessibility:** All actions keyboard accessible; dialogs have focus management; validation errors announced via aria-live.
- **Responsiveness:** Works on tablet and desktop; dialogs usable on narrow screens.
- **i18n/timezone:** Display datetimes in user timezone; date/time inputs must clearly indicate timezone/offset being used. Bucketing by shop timezone is out-of-scope here.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Show explicit empty-state message for no audit entries; safe because it does not change domain behavior; impacts UX Summary, Alternate/Empty states.
- SD-UX-POST-REDIRECT-GET: Use PRG-style redirect after POST transitions to avoid double-submit; safe as it‚Äôs a UI ergonomics pattern; impacts UX Summary, Error Flows.
- SD-UX-PAGINATION: Paginate audit list when > 50 entries; safe as it‚Äôs presentation-only; impacts UX Summary, Data Requirements.

---

## 16. Open Questions

1. **Domain ownership / label conflict (blocking):** Appointments are shopmgr SoR (DECISION-INVENTORY-010), but this story is labeled `domain:workexec`. Should this story be relabeled to `domain:shopmgmt` and implemented primarily in `durion-shopmgr/AppointmentEdit.xml`? If it must remain `domain:workexec`, confirm the intended ownership boundary and where the screen lives.  
2. **Exact endpoints/contracts (blocking):** What are the authoritative Moqui screen paths and/or REST endpoints for:
   - load appointment
   - reschedule
   - cancel
   - audit history (if any)
   - cancellation reason codes  
   Provide request/response schemas and whether Moqui screens call services directly vs REST.
3. **RBAC/capabilities (blocking):** What permission/capability gates reschedule/cancel for Dispatchers? Is there a user-context capability endpoint/claims to drive UI gating (DECISION-INVENTORY-013), or should UI rely solely on 403?
4. **Resource model & availability (blocking):** What is `assignedResourceId` (person userId, mechanicId, bayId, or a scheduling resource)? Is there an endpoint to search/select resources and/or check availability for a time window?
5. **Time payload semantics (blocking):** For reschedule requests, should timestamps be sent as UTC `Z` or local with offset? What is the backend‚Äôs parsing expectation? (Display is user timezone per DECISION-INVENTORY-016, but request format must be confirmed.)

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Scheduling: Reschedule or Cancel Appointment with Audit  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/137  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Scheduling: Reschedule or Cancel Appointment with Audit

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Dispatcher**, I want to reschedule or cancel an appointment so that the plan stays accurate.

## Details
- Reschedule: change window/resource; Cancel: reason.
- Notify workexec if linked to estimate/WO.

## Acceptance Criteria
- Reschedule updates schedule.
- Cancel sets status+reason.
- Changes audited.

## Integrations
- Emit AppointmentUpdated/Cancelled to workexec when linked.

## Data / Entities
- Appointment, AppointmentAudit, WorkexecLinkRef

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #134: [FRONTEND] [STORY] Dispatch: Assign Mechanic and Resource (Bay/Mobile) to Appointment
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Dispatch: Assign Mechanic(s) and Primary Resource (Bay/Mobile) to Appointment

## Primary Persona
Dispatcher

## Business Value
Enables dispatch to allocate labor and a primary work resource to a scheduled appointment with conflict/skills validation (and controlled override), ensuring the schedule is accurate, auditable, and ready for downstream work execution.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Dispatcher
- **I want** to create or replace an assignment for an appointment by selecting one or more mechanics (lead/helper) and a primary resource (bay/mobile)
- **So that** the appointment is staffed and resourced without conflicts (or with an authorized override), and the assignment is tracked and auditable.

## In-scope
- View current assignment (active) and assignment history for an appointment.
- Create a new assignment for an appointment using:
  - one primary resource (`resourceId`)
  - one or more mechanics with roles (`LEAD`, `ASSIST`) per rules
  - optional override block (with required reason/notes/checks) when validation fails but override is permitted.
- UX for surfacing validation failures and offering override flow when authorized.
- Frontend handling for backend error codes/statuses: 400/403/404/409/422.
- Basic audit visibility via assignment history listing (who/when/version/status if returned by API).

## Out-of-scope
- Building roster management (mechanics/resources creation, skills administration).
- Editing assignment status transitions (e.g., marking IN_PROGRESS/COMPLETED) unless exposed by existing backend endpoint.
- Full calendar/dispatch board UI; only the assignment workflow from an appointment context.
- Emitting domain events directly (frontend does not emit events; backend does).

---

# 3. Actors & Stakeholders
- **Dispatcher**: primary user creating/reassigning assignments.
- **Mechanic(s)**: assigned personnel; may be impacted by scheduling conflicts.
- **Workshop/Operations Manager**: reviews overrides and utilization (audit).
- **System (Moqui UI)**: orchestrates calls, shows conflicts, captures override justification.
- **Shop Management (shopmgr) system**: system-of-record for appointment operational context (appointment schedule, bay/resource availability rules).

---

# 4. Preconditions & Dependencies
- Appointment exists and is in **`SCHEDULED`** state (hard requirement; not overrideable).
- Appointment has `scheduledStartAt` and `scheduledEndAt` (time window source of truth).
- **System-of-record boundary (DECISION-INVENTORY-005 rationale):**
  - Appointment operational context (schedule/resource context) is **shopmgr SoR**.
  - Workexec UI may display and request an override, but must not ‚Äúinvent‚Äù scheduling truth client-side.
- Backend endpoints available (see ¬ß9):
  - `GET /appointments/{appointmentId}/assignments`
  - `POST /appointments/{appointmentId}/assignments`
- AuthN in place; user has permission:
  - Base create: `workexec.assignment.create`
  - Override create (when used): `dispatch:assignment:override_create`
- Data required to populate selection lists (mechanics/resources) must be available to frontend (endpoint(s) **TBD**; see Open Questions).
- **Identifier handling (DECISION-INVENTORY-003):** all IDs are opaque strings; UI must not validate UUID format.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From an Appointment detail screen: action/button **‚ÄúAssign‚Äù** (or ‚ÄúReassign‚Äù if active assignment exists).

## Screens to create/modify
1. **Modify**: `durion-shopmgr/screen/AppointmentEdit.xml` (canonical appointment screen per DECISION-INVENTORY-002)
   - Add an ‚ÄúAssignment‚Äù panel showing current active assignment summary + ‚ÄúAssign/Reassign‚Äù action.
2. **Create**: `durion-workexec/screen/dispatch/AppointmentAssign.xml` (new workexec-owned subscreen)
   - Screen for selecting resource + mechanics and submitting.
3. **Create/Modify**: `durion-workexec/screen/dispatch/AppointmentAssignmentHistory.xml` (optional; may be embedded in AppointmentAssign)
   - Shows list of assignments returned by GET, highlighting active assignment.

> Moqui routing note (DECISION-INVENTORY-002): extend existing screens/components rather than introducing a parallel appointment detail route. Workexec screen should accept `appointmentId` as a required parameter and provide a ‚ÄúBack to Appointment‚Äù transition to `durion-shopmgr/AppointmentEdit.xml`.

## Navigation context
- From `AppointmentEdit.xml` ‚Üí transition to `durion-workexec/dispatch/AppointmentAssign.xml?appointmentId=...`
- Breadcrumb: Appointments ‚Üí Appointment {appointmentId} ‚Üí Assign

## User workflows (happy + alternate)

### Happy path: create assignment (no conflicts)
1. Dispatcher opens appointment detail (`AppointmentEdit.xml`).
2. Clicks ‚ÄúAssign‚Äù.
3. On assign screen, selects:
   - Primary resource (one)
   - Mechanics (1+)
   - Roles (single mechanic defaults to LEAD; multi requires explicit roles)
4. Clicks ‚ÄúCreate Assignment‚Äù.
5. UI shows success, returns to appointment detail, assignment panel updates.

### Alternate path: validation fails; dispatcher uses override
1. Dispatcher completes selections and submits.
2. Backend responds with 409/422 including error code(s) and (if supported) overrideability metadata.
3. UI displays blocking messages and offers ‚ÄúOverride and Create‚Äù only if:
   - current user has override permission, and
   - failure category is overrideable, and
   - appointment is still SCHEDULED
4. Dispatcher enters:
   - override reason code
   - override notes
   - selects which checks to override (from backend-provided list if available; otherwise from mapped error codes)
5. Submits override request; on success show banner indicating override was used.

### Alternate path: reassignment
- If an active assignment exists, the flow is the same, but UI text indicates it will replace the current assignment; after success, history shows previous assignment marked CANCELLED/SUPERSEDED (as returned by backend).

---

# 6. Functional Behavior

## Triggers
- User clicks ‚ÄúAssign/Reassign‚Äù from appointment detail.

## UI actions
- Load appointment context (at minimum: status, scheduledStartAt, scheduledEndAt) from the appointment screen context (shopmgr).
- Load assignment history for appointment.
- Load mechanics and resources picklists (dependency; see Open Questions).
- Collect assignment inputs (resource + mechanics + roles).
- Submit create request (with or without override).
- Display result and navigate back/update context.

## State changes (frontend-visible)
- Appointment screen shows ‚ÄúAssigned‚Äù state in UI (display-only).
- Active assignment shown as:
  - resource
  - mechanics list with roles
  - status (expected `CONFIRMED` on create)
  - version (monotonic; create=1 if backend uses versioning)
- If reassignment: prior active assignment shown as `CANCELLED`/`SUPERSEDED` depending on backend.

## Service interactions
- `GET /appointments/{appointmentId}/assignments` to show active/history.
- `POST /appointments/{appointmentId}/assignments` to create assignment.
- No frontend-side availability/skills computation; backend is source of truth (DECISION-INVENTORY-005).

---

# 7. Business Rules (Translated to UI Behavior)

## Validation (client-side: basic; server-side: authoritative)
Client-side must validate before submit:
- Required:
  - `resourceId` selected
  - at least one `mechanic` selected
- Roles:
  - if exactly 1 mechanic: role field optional; UI defaults to LEAD for display and may omit role in payload if backend supports (see Open Questions); otherwise send explicit `LEAD`.
  - if >1 mechanics:
    - each mechanic must have a role selected
    - exactly one LEAD
- Override block:
  - if override is being used:
    - `reasonCode` required
    - `notes` required (non-empty)
    - `overriddenChecks[]` must be non-empty

Server-side errors must be surfaced clearly (see ¬ß11) and are authoritative for:
- availability conflicts
- skill mismatch
- appointment state eligibility
- override permission

## Enable/disable rules
- Disable ‚ÄúCreate Assignment‚Äù until required fields valid.
- Show/enable ‚ÄúOverride‚Äù section only after a failed submission with an overrideable error response (conservative default; avoids pre-authorizing overrides without server signal).
- Disable override option if backend indicates hard-block (appointment not SCHEDULED) or if user lacks override permission.

## Visibility rules
- Show assignment history section only if GET returns items; otherwise show empty state ‚ÄúNo assignments yet‚Äù.
- If active assignment exists, show ‚ÄúReassign‚Äù label and warning text: ‚ÄúCreating a new assignment will replace the active assignment.‚Äù

## Error messaging expectations
- Map backend error codes to user-facing messages:
  - `MECHANIC_UNAVAILABLE` ‚Üí ‚ÄúOne or more selected mechanics are unavailable in the appointment time window.‚Äù
  - `RESOURCE_UNAVAILABLE` ‚Üí ‚ÄúSelected resource is unavailable in the appointment time window.‚Äù
  - `SKILL_MISMATCH` ‚Üí ‚ÄúSelected team does not meet required skills for this appointment.‚Äù
  - `INVALID_ROLE_SET` ‚Üí ‚ÄúFor multiple mechanics, select exactly one Lead and assign roles for all mechanics.‚Äù
  - `OVERRIDE_NOT_PERMITTED` (403) ‚Üí ‚ÄúYou don‚Äôt have permission to override scheduling checks.‚Äù
- Always display the appointment time window in conflict messages (start/end) using the UI timezone convention (see ¬ß14; DECISION-INVENTORY-016).

---

# 8. Data Requirements

## Entities involved (frontend concern; backend SoR)
- Appointment (read; shopmgr SoR): `appointmentId`, `status`, `scheduledStartAt`, `scheduledEndAt`, (optional) `locationId`, (optional) `timezone`
- Assignment (read/write via API): `assignmentId`, `appointmentId`, `resourceId`, `status`, `version`, override fields
- AssignmentMechanic (read/write via API): `mechanicId`, `role`
- Mechanic roster + skills (read for selection UI) ‚Äî **endpoint/entity TBD** (likely people domain SoR)
- Resource roster (bays/mobile units) (read for selection UI) ‚Äî **endpoint/entity TBD** (likely shopmgr/location SoR)

## Fields (type, required, defaults)

### Create Assignment request (frontend payload)
- `resourceId` (id string; opaque) ‚Äî required
- `mechanics` (array) ‚Äî required, min 1
  - `mechanicId` (id string; opaque) ‚Äî required
  - `role` (enum `LEAD|ASSIST`) ‚Äî required when mechanics length > 1; for length == 1 see Open Questions
- `override` (object) ‚Äî optional
  - `used` (boolean) ‚Äî required if override object present (must be `true`)
  - `overriddenChecks` (array enum) ‚Äî required if `used=true`, min 1
  - `reasonCode` (string/enum) ‚Äî required if `used=true`
  - `notes` (string) ‚Äî required if `used=true`

### Display fields (from GET assignments)
Minimum required for UI:
- `assignmentId`
- `status` (`CONFIRMED|IN_PROGRESS|COMPLETED|CANCELLED|SUPERSEDED` if used)
- `version` (if provided)
- `resourceId` (+ optionally resource display name)
- `mechanics[]` with role (+ optionally mechanic display name)
- audit-ish fields if provided: `createdAt`, `createdBy`, `isOverridden`, `overrideReasonCode`, `overrideNotes` (notes may be sensitive; display policy is TBD)

## Read-only vs editable
- Existing assignments are read-only in this story (no status edits).
- Only create/reassign via POST.

## Derived/calculated fields (frontend)
- ‚ÄúActive assignment‚Äù derived as first assignment with status in (`CONFIRMED`,`IN_PROGRESS`) returned by GET (or explicit `active` flag if backend provides).

---

# 9. Service Contracts (Frontend Perspective)

## Load/view calls

### Get assignment history (and active)
- **Method/Path**: `GET /appointments/{appointmentId}/assignments`
- **Success**: `200 OK` returns list (may be empty)
- **Frontend expectations**:
  - includes enough fields to render active summary + history (see ¬ß8)
  - order: newest-first preferred; if not specified, frontend sorts by `createdAt` when available, else by `version` when available

## Create/update calls

### Create assignment (also used for reassignment)
- **Method/Path**: `POST /appointments/{appointmentId}/assignments`
- **Headers**:
  - `Idempotency-Key: <uuid>` (DECISION-INVENTORY-012; required for create/submit UI mutations)
- **Request body**: as defined in ¬ß8
- **Success**: `201 Created`
  - returns created assignment (preferred) OR an id reference; frontend then refreshes via GET.
- **Errors** (normalized to standard envelope where applicable; DECISION-INVENTORY-011):
  - `400 Bad Request`: malformed/missing required fields; may include `fieldErrors[]`
  - `403 Forbidden`: permission denied; include code `OVERRIDE_NOT_PERMITTED` when applicable
  - `404 Not Found`: appointment not found
  - `409 Conflict`: availability conflict; include code `MECHANIC_UNAVAILABLE` or `RESOURCE_UNAVAILABLE`; may also represent ‚Äúactive assignment already exists‚Äù race
  - `422 Unprocessable Entity`: skills/role validation; include code `SKILL_MISMATCH` or `INVALID_ROLE_SET`

## Submit/transition calls
- None beyond POST create.

## Error handling expectations (UI)
- For 409/422: show inline, actionable errors; keep user selections.
- For 403: show blocking banner and disable override UI.
- For 404: navigate back to appointments list with message ‚ÄúAppointment no longer exists.‚Äù
- For network/5xx: show retry option; do not clear entered data.
- For duplicate/idempotent replays: if backend returns a successful prior result for same `Idempotency-Key`, treat as success and refresh.

---

# 10. State Model & Transitions

## Appointment state constraints (hard block)
- Assignment creation allowed only when appointment is `SCHEDULED`. If not scheduled:
  - hide/disable ‚ÄúAssign/Reassign‚Äù
  - if user reaches screen via deep link, screen must show blocking message and disable submit.

## Assignment statuses (display semantics)
- `CONFIRMED`, `IN_PROGRESS` ‚Üí considered ‚Äúactive‚Äù and block availability
- `COMPLETED`, `CANCELLED`, `SUPERSEDED` ‚Üí historical; do not block availability

## Role-based transitions (frontend gating)
- Dispatcher with `workexec.assignment.create` can attempt creation.
- Override submission requires `dispatch:assignment:override_create` and completion of override fields.

> Note: Work order/workexec events and state transitions are backend-managed.

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- Missing resource ‚Üí show ‚ÄúSelect a resource.‚Äù
- No mechanics ‚Üí show ‚ÄúSelect at least one mechanic.‚Äù
- Multi-mechanic without roles / multiple leads ‚Üí show role rule message; block submit.

## Backend conflicts (409)
- Mechanic unavailable:
  - Show list of selected mechanics (by display name if available) and message referencing window.
  - Offer override path if permitted and error is overrideable.
- Resource unavailable:
  - Highlight selected resource; offer override if permitted and error is overrideable.

## Backend semantic issues (422)
- Skill mismatch:
  - Show message; do not auto-change selection.
  - Offer override if permitted and backend categorizes as overrideable.
- Invalid role set:
  - Force user to correct roles; do not show override (treat as non-overrideable).

## Concurrency conflicts
- If POST fails with conflict due to ‚Äúactive assignment already exists‚Äù (race):
  - UI refreshes assignment history and informs user ‚ÄúAssignment was updated by someone else; review current assignment before retrying.‚Äù

## Unauthorized access
- If user lacks create permission:
  - hide assign action from appointment detail (preferred)
  - if deep-linked, show 403 state with no submit.

## Empty states
- No assignments returned: show empty history state.
- No mechanics/resources available for selection: show empty picker state and guidance (contact admin).

---

# 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create assignment with single mechanic (defaults to LEAD)
**Given** an appointment is in `SCHEDULED` state with a defined start and end time  
**And** I have permission `workexec.assignment.create`  
**When** I select a primary resource and exactly one mechanic  
**And** I submit create assignment without specifying a role  
**Then** the system creates the assignment successfully  
**And** the appointment shows an active assignment with status `CONFIRMED`  
**And** the mechanic is shown as `LEAD` in the assignment display (either returned by API or inferred from response)

### Scenario 2: Create assignment with multiple mechanics requires exactly one Lead
**Given** an appointment is `SCHEDULED`  
**When** I select two mechanics  
**And** I do not assign roles for both mechanics  
**Then** the UI prevents submission and shows an error indicating roles are required  
**When** I set exactly one mechanic to `LEAD` and the other to `ASSIST`  
**Then** submission is enabled

### Scenario 3: Backend rejects due to mechanic availability conflict
**Given** an appointment is `SCHEDULED`  
**And** I have permission `workexec.assignment.create`  
**When** I submit an assignment that conflicts with an existing mechanic booking  
**Then** I see an error message indicating mechanic unavailability for the appointment time window  
**And** my selected inputs remain intact for editing

### Scenario 4: Override flow allowed and succeeds
**Given** an appointment is `SCHEDULED`  
**And** I have permissions `workexec.assignment.create` and `dispatch:assignment:override_create`  
**When** I submit an assignment that fails with error code `MECHANIC_UNAVAILABLE`  
**Then** the UI offers an override option  
**When** I enable override and provide a reason code, notes, and select `MECHANIC_AVAILABILITY` in overridden checks  
**And** I resubmit with a new `Idempotency-Key`  
**Then** the assignment is created successfully  
**And** the UI indicates the assignment was created with an override (e.g., ‚ÄúOverride used‚Äù banner)

### Scenario 5: Override not permitted
**Given** an appointment is `SCHEDULED`  
**And** I have permission `workexec.assignment.create` but not `dispatch:assignment:override_create`  
**When** I submit an assignment and backend responds `403 Forbidden` with code `OVERRIDE_NOT_PERMITTED`  
**Then** the UI shows a permission error  
**And** the override UI is not available  
**And** no assignment is created

### Scenario 6: Hard block when appointment is not SCHEDULED
**Given** an appointment is not in `SCHEDULED` state  
**When** I navigate to the assign screen  
**Then** the UI displays a blocking message stating assignments can only be created for scheduled appointments  
**And** the submit action is disabled

### Scenario 7: Reassignment replaces active assignment
**Given** an appointment is `SCHEDULED` and currently has an active assignment  
**When** I create a new assignment for the same appointment  
**Then** the appointment shows only one active assignment  
**And** the previous assignment appears in history with a non-active status (e.g., `CANCELLED`/`SUPERSEDED`) as returned by the backend

### Scenario 8: Idempotent retry does not create duplicates
**Given** an appointment is `SCHEDULED`  
**And** I have permission `workexec.assignment.create`  
**When** I submit create assignment with an `Idempotency-Key`  
**And** the network times out and I retry the same submission with the same `Idempotency-Key`  
**Then** at most one assignment is created  
**And** the UI refreshes history and shows a single resulting assignment

---

# 13. Audit & Observability

## User-visible audit data
- Assignment history list must show (when provided by API):
  - created timestamp
  - created by (user display name/id)
  - status + version
  - override indicator + reason code (if overridden)

## Status history
- Use `GET /appointments/{appointmentId}/assignments` as the primary source for history.
- If the API includes versioning, display version to support traceability.

## Traceability expectations
- UI must log (client-side) structured events for:
  - `appointment.assign.opened` (appointmentId)
  - `appointment.assign.submitted` (appointmentId, hasOverride, idempotencyKey)
  - `appointment.assign.succeeded` (appointmentId, assignmentId)
  - `appointment.assign.failed` (appointmentId, httpStatus, errorCode, correlationId if present)
- Do not log PII; do not log override notes content.

---

# 14. Non-Functional UI Requirements

- **Performance**: assignment history load should complete within 2s on typical LAN; show loading state.
- **Accessibility**: all form controls labeled; errors associated with fields; keyboard navigable role selection.
- **Responsiveness**: usable on tablet width; mechanics list supports scrolling.
- **i18n/timezone**:
  - Display timestamps in **user timezone**.
  - Display the appointment window using the same convention and label timezone explicitly when shown in conflict messages (DECISION-INVENTORY-016).
  - If shop/location timezone is available, use it for day-bucket filters only (not applicable in this story).

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for ‚Äúno assignments‚Äù, ‚Äúno mechanics‚Äù, ‚Äúno resources‚Äù to avoid blank panels; qualifies as safe UI ergonomics. (Impacted: UX Summary, Alternate / Error Flows)
- SD-ERR-STD-MAPPING: Map HTTP 400/403/404/409/422/5xx into consistent banner + inline field errors while preserving form state; qualifies as safe error-handling boilerplate. (Impacted: Service Contracts, Alternate / Error Flows, Acceptance Criteria)

---

# 16. Open Questions
1. **Mechanic picker contract (blocking):** What endpoint/service should the frontend use to list/search mechanics for selection (id + displayName at minimum), and does it support filtering by `locationId` and/or appointment window? (People domain is likely SoR; workexec must consume read-only per DECISION-INVENTORY-009.)
2. **Resource picker contract (blocking):** What endpoint/service should the frontend use to list/select primary resources (bays/mobile units) for the appointment‚Äôs location, including id + displayName and (optionally) type?
3. **Assignment API canonical paths (blocking):** Are the paths in this story (`/appointments/{appointmentId}/assignments`) the actual Moqui REST paths, or should this be implemented as Moqui screen transitions/services instead of REST? Provide the canonical route(s) used in this repo for appointment-scoped assignment CRUD.
4. **Single-mechanic role default (blocking):** Does the backend accept omitting `role` when exactly one mechanic is provided (and default to `LEAD`), or must UI always send `LEAD` explicitly?
5. **Overrideability metadata (non-blocking but important):** Will the backend response include a machine-readable list of overrideable checks (e.g., `overrideableChecks[]`) and/or a boolean `isOverrideable` per error? If not, confirm the authoritative mapping from error codes to overrideable checks for UI gating.
6. **Audit field visibility (non-blocking):** Does `GET /appointments/{appointmentId}/assignments` return `createdAt`, `createdBy`, `isOverridden`, `overrideReasonCode`? If not, confirm the minimal history fields required for v1 UI.

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Dispatch: Assign Mechanic and Resource (Bay/Mobile) to Appointment  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/134  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Dispatch: Assign Mechanic and Resource (Bay/Mobile) to Appointment

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Dispatcher**, I want to assign mechanics and a resource to an appointment so that work can be executed efficiently.

## Details
- Validate mechanic/resource availability + required skills.
- Support team assignment (lead/helper).

## Acceptance Criteria
- Assignment created only if checks pass (or override).
- Changes audited.
- Schedule updated.

## Integrations
- Emit AssignmentCreated/Updated to workexec when linked.

## Data / Entities
- Assignment, AssignmentRole, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #133: [FRONTEND] [STORY] Dispatch: Override Conflict with Manager Permission
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Dispatch: Override Scheduling Conflict with Manager Permission (Reason + Audit Flag)

### Primary Persona
Shop Manager / Dispatcher with explicit override capability (manager-only override)

### Business Value
Enable urgent/exception scheduling despite conflicts while preserving auditability (who/when/why + what was overridden) and ensuring work execution can see an ‚Äúoverride/expedite‚Äù context flag.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Shop Manager/Dispatcher with override capability  
- **I want** to override a scheduling conflict by providing a mandatory reason  
- **So that** urgent jobs can proceed while keeping a permanent audit trail and signaling downstream systems that the schedule was forced.

### In-scope
- Frontend conflict-resolution flow when a schedule/save attempt returns a conflict.
- Permission-gated ‚ÄúOverride conflict‚Äù action (capability-driven UI gating; backend authoritative).
- Mandatory capture of override reason (non-empty, non-whitespace).
- Submit override mutation with idempotency protection and concurrency-safe handling.
- After success, display an ‚ÄúOverridden‚Äù indicator and (if provided) override metadata on the appointment/work order view.
- Standard error handling using the standard error envelope (code/message/correlationId/fieldErrors/existingResourceId where applicable).

### Out-of-scope
- Implementing conflict detection logic (backend/shopmgr responsibility).
- Authoring scheduling resource models (tech/bay calendars) beyond rendering backend-provided conflict details.
- Defining permission policy/roles (security domain); frontend consumes capability signals and handles 403.
- Notifications to other parties.
- Any new lifecycle states for work orders/appointments; this story is a flag/audit event only.

---

## 3. Actors & Stakeholders
- **Shop Manager / Dispatcher (primary)**: may override conflicts with reason.
- **Service Advisor / Dispatcher without override capability (secondary)**: can view conflicts but cannot override.
- **Auditor/Compliance**: needs immutable override record visibility (at least ‚Äúwho/when/why‚Äù).
- **Work Execution (workexec)**: consumes override/expedite context as read-only signal; does not author scheduling.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS UI.
- User is editing an appointment schedule (or scheduling context that links to a work order via `appointmentId`).
- A schedule attempt can return a conflict response with structured conflict details.

### Dependencies
- **Shop management scheduling SoR**: operational context/scheduling is shopmgr SoR (DECISION-INVENTORY-005, DECISION-INVENTORY-010). Workexec UI may display it but does not own scheduling truth.
- **Capability/permission signaling**: UI must be able to determine whether the current user can override conflicts via a capability signal (DECISION-INVENTORY-013). Backend must still enforce with 403.
- **Standard error envelope**: backend errors must be normalized to `{code,message,correlationId,fieldErrors?}` (DECISION-INVENTORY-011).
- **Idempotency**: UI must send `Idempotency-Key` for override mutation and reuse on retry (DECISION-INVENTORY-012).
- **Moqui screen alignment**: dispatch board exists as `WorkOrderBoard.xml` in workexec (read-only v1) (DECISION-INVENTORY-002, DECISION-INVENTORY-009). Appointment editing is in shopmgr (`AppointmentEdit.xml`) (DECISION-INVENTORY-002).

**Blocking note:** This story‚Äôs core action is a shopmgr scheduling mutation, but the issue is labeled `domain:workexec`. Per domain boundaries, scheduling/operational context is shopmgr SoR; workexec can only display and consume flags. Ownership/label must be confirmed (see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- **Primary**: `durion-shopmgr/AppointmentEdit.xml` when user attempts to save/reschedule and backend reports a conflict.
- **Secondary (read-only context)**: `durion-workexec/WorkOrderBoard.xml` may display an ‚ÄúOverridden‚Äù badge on linked work orders/appointments (no override action from board in v1).

### Screens to create/modify (Moqui)
1. **Modify** `durion-shopmgr/AppointmentEdit.xml`
   - Add conflict resolution handling on schedule/save transition.
   - Add ‚ÄúOverride conflict‚Äù action gated by capability.
   - Add modal/dialog form to capture reason and show conflict details.
2. **Modify (optional display-only)** `durion-workexec/WorkOrderEdit.xml` and/or `durion-workexec/WorkOrderBoard.xml`
   - Display read-only indicator if linked appointment/work order has `isConflictOverride=true` (no mutation).

### Navigation context
- User remains in the appointment scheduling flow; override is a continuation of the original save/reschedule attempt.
- After successful override, user remains on appointment detail with updated schedule and override indicator visible.

### User workflows (happy + alternate paths)

#### Happy path (override)
1. User edits appointment time/resources and clicks Save/Schedule.
2. Backend responds with a conflict payload (typed conflict response).
3. UI renders conflict summary and details.
4. If user has override capability, UI offers ‚ÄúOverride conflict‚Äù.
5. User enters a reason and submits.
6. Backend schedules with override, returns updated appointment including `isConflictOverride=true` and override metadata.
7. UI shows success and displays ‚ÄúConflict overridden‚Äù indicator.

#### Alternate paths
- **No override capability**: conflict details shown; override action hidden; user must adjust schedule.
- **User cancels modal**: no override submitted; appointment remains unscheduled/unchanged; conflict panel remains.
- **Backend rejects override**:
  - 400 validation: show inline reason error.
  - 403: show permission error; keep user in conflict flow.
  - 409 concurrency: prompt refresh and reattempt.

---

## 6. Functional Behavior

### Triggers
- A schedule/save attempt results in a conflict response from the scheduling backend/service.

### UI actions
- Render conflict details returned by backend (do not infer conflicts client-side).
- Gate override action using capability signal (DECISION-INVENTORY-013).
- Collect override reason (required).
- Submit override mutation with `Idempotency-Key` (DECISION-INVENTORY-012).
- On success, refresh appointment view model and display override indicator.

### State changes
- UI state:
  - `conflictDetected: boolean`
  - `conflictDetails: ConflictDetail[]`
  - `overrideModalOpen: boolean`
  - `overrideReason: string`
  - `submittingOverride: boolean`
- After success:
  - `conflictDetected=false`
  - appointment model includes `isConflictOverride=true` and override metadata if returned.

### Service interactions (Moqui-oriented)
- AppointmentEdit save transition calls a scheduling service.
- On conflict response, UI either:
  - calls a dedicated override service, or
  - retries schedule with an override payload.
- All mutations include `Idempotency-Key` header and handle standard error envelope.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Override reason is required**:
  - Must be non-empty and not whitespace-only.
  - UI blocks submit until valid.
  - Backend validation errors map to inline field error on reason (DECISION-INVENTORY-011).

### Enable/disable rules
- ‚ÄúOverride conflict‚Äù action is available only when:
  - conflict is present, and
  - user capability indicates override allowed (capability flag; name TBD), and
  - user is a member of the relevant location context (if enforced by backend; UI should not assume).
- Override submit button enabled only when reason valid and not currently submitting.

### Visibility rules
- Users without override capability: **hide** override action (safe default for security UX; backend still enforces 403).

### Error messaging expectations (standardized)
- 403: ‚ÄúYou don‚Äôt have permission to override scheduling conflicts.‚Äù
- 409: ‚ÄúThe schedule changed. Refresh and try again.‚Äù
- 400: ‚ÄúReason is required to override a conflict.‚Äù (or field-level message)
- 5xx: ‚ÄúCould not override conflict due to a system error. Try again.‚Äù
- All errors should display `correlationId` in a ‚ÄúDetails‚Äù affordance for support.

---

## 8. Data Requirements

### Entities involved
- **Shop appointment** (`durion.shopmgr.DurShopAppointment`) (SoR: shopmgr)
  - `appointmentId` (opaque string id; DECISION-INVENTORY-003)
  - scheduling fields (date/time/resource references) as already present
  - `isConflictOverride` (boolean; read-only from backend)
  - `conflictOverrideId` (opaque string; optional, read-only)
  - `conflictOverrideReason` (string; optional, read-only if policy allows)
  - `conflictOverrideByUserId` / displayName (optional, read-only)
  - `conflictOverrideAt` (timestamp; optional, read-only)
- **Work order** (`durion.workexec.DurWorkOrder`) (SoR: workexec for execution; references appointment)
  - `workOrderId` (opaque string)
  - `appointmentId` (opaque string; link to shopmgr appointment; DECISION-INVENTORY-010)
  - `isConflictOverride` (optional denormalized read model field OR derived by joining appointment; read-only)

### Conflict details payload (read-only)
Minimum fields required for UI rendering:
- `conflictType` (string/enum)
- `resourceType` (string/enum; e.g., BAY/MECHANIC)
- `resourceId` (opaque string)
- `conflictingEntityId` (opaque string; optional)
- `message` (string; optional human-readable)
- `asOf` (timestamp; optional; supports concurrency messaging)

### Fields (type, required, defaults)
- `overrideReason: string` (required input; no default)
- `isConflictOverride: boolean` (default false; set true only by backend on successful override)

### Read-only vs editable
- Editable: `overrideReason` only during override submission.
- Read-only: all audit fields, conflict details, and override flags.

### Derived/calculated fields
- `overrideBadgeLabel` derived from `isConflictOverride` (e.g., ‚ÄúConflict overridden‚Äù).
- `displayConflictSummary` derived from `conflictDetails[]`.

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking:** Exact Moqui service names and REST paths for shopmgr scheduling are not provided in inputs. The frontend needs one of the following contracts; implementer must map to actual Moqui services/transitions in `durion-shopmgr`.

### Load/view calls
1. Load appointment detail (existing shopmgr screen/service)
   - Must return appointment including `isConflictOverride` and (if allowed) override metadata.
2. Load user capabilities (existing platform/user context)
   - Returns stable capability flags (DECISION-INVENTORY-013).

### Create/update calls (schedule attempt)
- **Schedule/Reschedule appointment**
  - Request includes appointmentId and new schedule fields.
  - On conflict, backend responds with either:
    - **409 Conflict** + standard error envelope extended with `conflictDetails[]`, OR
    - **200 OK** with `conflictDetected=true` and `conflictDetails[]` (less preferred).
  - UI must support the chosen pattern; prefer 409 for deterministic flow.

### Submit/transition calls (override)
One of:
- **Dedicated override endpoint/service**
  - `POST /rest/api/v1/shopmgr/appointments/{appointmentId}/schedule:override-conflict`
  - Headers: `Idempotency-Key: <uuid>`
  - Body: `{ reason: string, conflictToken?: string, asOf?: string }`
  - Returns: updated appointment with `isConflictOverride=true` and override metadata.
- **Retry schedule with override payload**
  - Same schedule endpoint with `{ override: { reason } }`
  - Headers: `Idempotency-Key`

### Error handling expectations
- All errors normalized to standard envelope (DECISION-INVENTORY-011):
  - `code` (e.g., `VALIDATION_ERROR`, `FORBIDDEN`, `CONFLICT`, `STALE_VERSION`)
  - `message`
  - `correlationId`
  - `fieldErrors[]` with `{field, message}` for reason validation
- 409 used for concurrency/conflict changes; UI prompts refresh.
- Idempotent retries must return same outcome for same `Idempotency-Key` (DECISION-INVENTORY-012).

---

## 10. State Model & Transitions

### Allowed states
- No new work order FSM states are introduced (DECISION-INVENTORY-004).
- Override is an **auditable event/flag** on the appointment schedule context.

### Role-based transitions
- Override action requires explicit override capability/permission (capability-driven gating; backend authoritative) (DECISION-INVENTORY-013).

### UI behavior per state
- **Conflict detected**: show conflict panel; block save completion unless override or schedule adjustment.
- **Override successful**: show overridden badge and (if available) audit metadata.
- **Read-only contexts (WorkOrderBoard)**: display badge only; no override action.

---

## 11. Alternate / Error Flows

1. **Reason missing**
   - UI blocks submit; if backend returns 400 with fieldErrors, show inline error and keep modal open.

2. **Unauthorized**
   - If backend returns 403, show permission error; do not mark overridden; keep conflict panel visible.

3. **Concurrency / stale conflict**
   - Backend returns 409 with `code=STALE_VERSION` or `code=CONFLICT_CHANGED`.
   - UI offers ‚ÄúRefresh conflict details‚Äù (reload appointment) and reattempt.

4. **Duplicate submit / retry**
   - User double-clicks submit or network retry occurs.
   - UI reuses same `Idempotency-Key` for the same attempt; backend returns same result; UI handles gracefully (DECISION-INVENTORY-012).

5. **Partial data**
   - Conflict response missing details: show generic conflict message and log correlationId; still allow override if backend allows and user has capability.

---

## 12. Acceptance Criteria

### Scenario 1: Authorized user overrides conflict successfully
**Given** a user is logged in and has the capability to override scheduling conflicts  
**And** the user attempts to save/reschedule an appointment and the backend responds with a scheduling conflict including conflict details  
**When** the user selects ‚ÄúOverride conflict‚Äù  
**And** enters a non-empty reason ‚ÄúEmergency customer vehicle‚Äù  
**And** submits the override with an `Idempotency-Key`  
**Then** the appointment is scheduled successfully  
**And** the appointment detail response includes `isConflictOverride=true`  
**And** the UI displays a ‚ÄúConflict overridden‚Äù indicator  
**And** the response includes override audit metadata (at minimum an override identifier and timestamp) or created/updated metadata sufficient for audit.

### Scenario 2: User without override capability cannot override
**Given** a user is logged in without the capability to override scheduling conflicts  
**And** a scheduling conflict is detected on save/reschedule  
**When** the conflict is displayed  
**Then** the UI does not show an override action  
**And** the user cannot complete scheduling in the conflicting slot via override.

### Scenario 3: Reason is required
**Given** a user has override capability  
**And** a scheduling conflict is detected  
**When** the user opens the override flow  
**And** leaves the reason empty or whitespace  
**Then** the UI prevents submission and shows a field-level error for reason  
**And** no successful override occurs.

### Scenario 4: Backend denies override (defense-in-depth)
**Given** a user attempts to override a conflict  
**When** the backend responds with `403 Forbidden` in the standard error envelope  
**Then** the UI shows ‚ÄúYou don‚Äôt have permission to override scheduling conflicts.‚Äù  
**And** the appointment is not marked overridden  
**And** the user remains in the conflict resolution flow.

### Scenario 5: Concurrency conflict on override
**Given** a user has override capability  
**And** a conflict is displayed for an appointment schedule attempt  
**When** the user submits an override  
**And** the backend responds with `409 Conflict` indicating the conflict/schedule changed  
**Then** the UI prompts the user to refresh conflict details  
**And** does not mark the appointment overridden.

### Scenario 6: Idempotent retry does not create duplicates
**Given** a user submits an override and the network times out  
**When** the UI retries the same override using the same `Idempotency-Key`  
**Then** the backend returns the same outcome (success or failure) without creating duplicate override records  
**And** the UI reflects the final outcome correctly.

---

## 13. Audit & Observability

### User-visible audit data
- On appointment detail (and optionally on linked work order detail), display when available:
  - override timestamp
  - overridden by (display name or id)
  - reason (if policy allows)
  - conflict summary (type/resource)
- Minimum acceptable audit visibility: created/updated metadata plus `isConflictOverride=true` (DECISION-INVENTORY-014).

### Status history
- Override is an auditable event; it does not change work order FSM state.

### Traceability expectations
- UI logs `correlationId` from error envelope for support.
- If override identifier is returned, display it in a ‚ÄúDetails‚Äù section for audit/support lookup.

---

## 14. Non-Functional UI Requirements
- **Performance:** conflict UI renders without additional calls; override call only on user action.
- **Accessibility:** modal is keyboard navigable; focus trapped; reason field has label and error text; ESC closes modal without submitting.
- **Responsiveness:** usable on tablet resolutions.
- **i18n:** all user-facing strings use existing translation mechanism if present.
- **Security:** do not expose sensitive internal identifiers beyond what backend returns; always handle 403/401 safely.

---

## 15. Applied Safe Defaults
- SD-UX-001 (Empty/partial state messaging): If conflict details are missing, show a generic conflict message and correlationId. Qualifies as safe because it affects only UI ergonomics, not business policy. Impacted sections: UX Summary, Alternate/Error Flows.
- SD-UX-002 (Hide unauthorized actions): Hide override action when capability is absent. Qualifies as safe because backend remains authoritative and this is a standard UX security pattern. Impacted sections: Business Rules, Acceptance Criteria.

---

## 16. Open Questions

1. **Domain ownership/label conflict (blocking):** This story is labeled `domain:workexec`, but scheduling/operational context is shopmgr SoR (DECISION-INVENTORY-005, DECISION-INVENTORY-010). Should this story be relabeled to `domain:shopmgmt` and implemented primarily in `durion-shopmgr/AppointmentEdit.xml`, with a small follow-up workexec story for read-only badge display?
2. **Authoritative contract (blocking):** What is the actual Moqui service/transition or REST endpoint used by `AppointmentEdit.xml` to schedule/reschedule, and what is the conflict response pattern?
   - 409 with conflict payload vs 200 with `conflictDetected`
   - Is there a `conflictToken`/`asOf`/version required for override?
3. **Capability flag name (blocking):** What is the exact capability/permission signal exposed to the frontend for conflict override (per DECISION-INVENTORY-013)? (Do not hardcode `shopmgr.appointment.override` unless confirmed as the capability key.)
4. **Audit visibility policy (blocking):** Should the override reason be displayed to all users who can view the appointment, or only to managers/auditors? What fields are permitted in UI?
5. **Data propagation (non-blocking if read-only):** Should workexec screens display `isConflictOverride` by joining appointment data at runtime, or will workexec receive a denormalized flag on `DurWorkOrder`?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Dispatch: Override Conflict with Manager Permission  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/133  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Dispatch: Override Conflict with Manager Permission

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Shop Manager**, I want to override a scheduling conflict with a reason so that urgent jobs can proceed with auditability.

## Details
- Requires shopmgr.appointment.override.
- Records rationale and impacts.

## Acceptance Criteria
- Permission required.
- Reason required.
- Conflict flagged.

## Integrations
- Workexec receives override/expedite flag via context.

## Data / Entities
- OverrideRecord, PermissionCheck

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #132: [FRONTEND] [STORY] Timekeeping: Start/Stop Work Session for Assigned Work
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Timekeeping: Start/Stop Work Session (with Breaks + Overlap Guard) for Assigned Work Order Task

### Primary Persona
Mechanic

### Business Value
Capture accurate, auditable labor time against a specific work order task (net of breaks) to support operational execution and downstream payroll/job-costing consumption, while preventing invalid/overlapping time entries.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Mechanic  
- **I want** to start and stop a work session (and optionally record breaks) tied to my assigned work order task  
- **So that** my labor time is captured accurately for costing and downstream processing, without accidental overlaps or edits after locking/approval.

### In-scope
- UI to **start** a work session for a selected assigned work order task.
- UI to **stop** the currently active session (or active session for that task if backend supports).
- UI to **start/stop breaks** within an active work session (manual break segments).
- UI enforcement of **overlap prevention** and explicit **override path** when backend indicates it is allowed (config + permission + audit reason).
- UI enforcement that **locked/approved** sessions cannot be modified.
- Viewing basic session details and computed totals as returned by backend.

### Out-of-scope
- Manager approval/locking workflow UI (approve/reject) beyond enforcing immutability when locked.
- Configuration UI for overlap policies / approval methods.
- Payroll export screens and downstream integrations UI.
- Creating/assigning work order tasks; this story assumes tasks exist and are assigned.

---

## 3. Actors & Stakeholders
- **Mechanic (Primary)**: starts/stops sessions and records breaks.
- **Service Manager / Admin (Approver)**: approves/locks sessions (enforced as read-only here).
- **Workexec backend service (SoR for Work Order execution UI)**: hosts the execution UI where timekeeping actions are initiated.
- **People/HR backend service (SoR for timekeeping)**: owns `WorkSession` lifecycle, overlap policy, locking/approval, and computed duration.
- **Payroll / HR / Job Costing (Downstream)**: consume timekeeping outputs; no direct UI scope here.

---

## 4. Preconditions & Dependencies
- User is authenticated in POS frontend.
- Mechanic has at least one assigned work order task that is eligible to start work (backend-enforced).
- Timekeeping endpoints for work sessions exist and are reachable (see Service Contracts).
- Frontend has a way to identify:
  - current user identity (from session/auth context)
  - selected `workOrderId` + `workOrderTaskId` (from navigation context)
  - current `locationId` (from POS context; if not available, backend must infer)
- Dependency: backend story referenced as implemented/available API contract (Durion backend issue #68). If endpoints differ from the high-level contract, this story remains at risk until confirmed.
- **Domain boundary dependency (binding):** Per workexec domain rules, **time entry is People domain SoR**; workexec UI may only *initiate* timekeeping actions and display read-only results.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a Work Order execution context (workexec screens):
  - Work order detail/edit screen action area for a selected task/line: ‚ÄúStart Work‚Äù, ‚ÄúStop Work‚Äù, ‚ÄúStart Break‚Äù, ‚ÄúEnd Break‚Äù
- Optional global entry (non-blocking enhancement): ‚ÄúMy Active Session‚Äù quick access if project conventions allow.

### Screens to create/modify
- **Modify** existing workexec screen(s) to include timekeeping actions and a session status panel:
  - `durion-workexec/WorkOrderEdit.xml` (primary)
  - If tasks are rendered in a sub-screen, add actions there (exact sub-screen path depends on current repo structure).
- **Create** a lightweight embedded panel (screen include) for session status + breaks list:
  - `durion-workexec/WorkSessionPanel.xml` (new include screen)
- **Do not create** new People-domain admin screens here; this story is execution-facing only.

### Navigation context
- Work order context params: `workOrderId`, `workOrderTaskId` (IDs treated as opaque strings; no UUID validation).
- User context: derived from Moqui user session; do not require manual entry.
- After start/stop/break actions, remain on the same work order/task context and refresh the session panel.

### User workflows (happy + alternate paths)

**Happy path: start ‚Üí break ‚Üí resume ‚Üí stop**
1. Mechanic opens a work order and selects an assigned task.
2. Clicks **Start Work**.
3. UI shows session `IN_PROGRESS`, start timestamp, and enables break/stop actions.
4. Clicks **Start Break**, then **End Break**.
5. Clicks **Stop Work**; UI displays completed duration (net of breaks) returned by backend.

**Alternate: overlap prevented**
- Mechanic clicks Start Work but already has an active session; backend returns 409 conflict ‚Üí UI explains and offers navigation to ‚ÄúMy Active Session‚Äù (if available) or shows the active session summary if returned.

**Alternate: overlap override allowed**
- Backend indicates override is permitted only with explicit override and reason ‚Üí UI prompts for reason and retries via override-capable request (if supported by API).

**Alternate: locked**
- If session is `APPROVED` or `locked=true`, all mutation actions are disabled; attempting mutation results in error banner.

---

## 6. Functional Behavior

### Triggers
- Button clicks: Start Work, Stop Work, Start Break, End Break
- Screen load: fetch current task context + current active session state (if available) to set button enabled/disabled states.

### UI actions
- **Start Work**
  - Collect required identifiers: `workOrderId`, `workOrderTaskId`
  - Do **not** require manual `mechanicId` entry; prefer backend deriving from auth (if supported).
  - Send `Idempotency-Key` header for the start action and reuse it on retry for the same attempt (DECISION-INVENTORY-012).
  - Call start service; on success, refresh session data.
- **Stop Work**
  - Send `Idempotency-Key` header for stop action and reuse on retry for the same attempt.
  - Call stop service (by `workSessionId` if known; otherwise task-scoped stop if backend supports).
  - On success, refresh and show final totals.
- **Start Break / End Break**
  - Only available when session is `IN_PROGRESS`.
  - Send `Idempotency-Key` header for break start/stop.
  - Call break start/stop endpoints with `workSessionId`.
  - Refresh break list/state after each operation.

### State changes (frontend)
- No client-side authoritative state transitions; frontend reflects backend state.
- UI state derived from loaded `WorkSession.status`, `locked`, and ‚Äúactive break‚Äù indicator from backend (or inferred from last break segment missing endAt if returned).

### Service interactions
- Load work order/task context via existing workexec screen/entity queries.
- Timekeeping actions via timekeeping endpoints (People/HR SoR) proxied/accessible from the frontend.
- Handle 409 conflicts for overlaps and concurrent actions using standard error envelope parsing (DECISION-INVENTORY-011).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Before calling Start Work:
  - Ensure `workOrderId` and `workOrderTaskId` present in route/context; if missing, block action and show error ‚ÄúTask context missing.‚Äù
- Before calling Stop Work / Break actions:
  - Ensure an active `workSessionId` is loaded; if not, disable actions and show ‚ÄúNo active session.‚Äù

### Enable/disable rules
- **Start Work** enabled only when:
  - No active session for this mechanic **OR** backend indicates overlap override is allowed (must be server-provided; UI must not guess)
  - Current session for this task is not already `IN_PROGRESS`
  - Session is not locked
- **Stop Work** enabled only when:
  - There is an active session in `IN_PROGRESS` (for the mechanic or for this task, depending on backend model)
  - Session is not locked
- **Start Break** enabled only when:
  - Session is `IN_PROGRESS`
  - No break currently active (if backend provides; otherwise infer)
  - Session is not locked
- **End Break** enabled only when:
  - Session is `IN_PROGRESS`
  - A break is currently active
  - Session is not locked

### Visibility rules
- Show ‚ÄúLocked/Approved‚Äù badge when `locked=true` or `status=APPROVED`.
- Show overlap warning banner when backend returns conflict on start due to existing active session.

### Error messaging expectations
- Errors must be normalized to the standard envelope where possible (DECISION-INVENTORY-011):
  - `code`, `message`, `correlationId`, optional `fieldErrors[]`, optional `existingResourceId`
- 400 validation: show field-level or banner message from backend.
- 403 unauthorized: ‚ÄúYou don‚Äôt have permission to perform this action.‚Äù
- 404 not found: ‚ÄúWork order/task/session not found or no longer available.‚Äù
- 409 conflict:
  - Overlap: ‚ÄúYou already have an active session. Stop it before starting another.‚Äù
  - Concurrent stop/start: ‚ÄúThis session changed since you loaded the page. Refresh and try again.‚Äù

---

## 8. Data Requirements

### Entities involved
- `WorkSession` (People/HR SoR; read-only display here except via actions)
- `BreakSegment` (People/HR SoR; read-only display here except via actions)
- (Indirect, workexec context) `DurWorkOrder` and work order task/line entity used by the screen

### Fields (type, required, defaults)
**WorkSession (read model as returned)**
- `workSessionId` (string, opaque id) ‚Äî required
- `mechanicId` (string, opaque id) ‚Äî required
- `workOrderId` (string, opaque id) ‚Äî required
- `workOrderTaskId` (string, opaque id) ‚Äî required
- `locationId` (string, opaque id) ‚Äî required (or backend-derived)
- `resourceId` (string|null) ‚Äî optional
- `startAt` (ISO-8601 timestamp) ‚Äî required
- `endAt` (ISO-8601 timestamp|null) ‚Äî optional
- `status` (enum) ‚Äî required: `IN_PROGRESS`, `COMPLETED`, `APPROVED`, `REJECTED` (plus any additional statuses returned by backend)
- `locked` (boolean) ‚Äî required
- `totalDurationSeconds` (int) ‚Äî required on completed/approved (may be omitted/0 while in progress depending on backend)
- Override audit (read-only, if supported by backend):
  - `overlapOverrideUsed` (boolean)
  - `overrideReason` (string|null)
  - `overriddenByUserId` (string|null)
  - `overrideAt` (ISO-8601|null)

**BreakSegment (read model as returned)**
- `breakSegmentId` (string, opaque id) ‚Äî required
- `workSessionId` (string, opaque id) ‚Äî required
- `breakStartAt` (ISO-8601 timestamp) ‚Äî required
- `breakEndAt` (ISO-8601 timestamp|null) ‚Äî optional while active
- `breakType` (enum|null) ‚Äî optional (`MEAL`, `REST`, `OTHER`)
- `notes` (string|null) ‚Äî optional

### Read-only vs editable by state/role
- Mechanic can mutate only when session not locked and status is appropriate:
  - Start session
  - Stop session
  - Manage breaks
- When `locked=true` or `status=APPROVED`: all fields read-only; mutation calls must be blocked in UI and rejected by backend.

### Derived/calculated fields
- Display ‚ÄúNet duration‚Äù using `totalDurationSeconds` from backend as source of truth.
- Display formatting (HH:MM:SS) derived in UI.
- Timezone display: show timestamps in user timezone and label timezone (DECISION-INVENTORY-016).

---

## 9. Service Contracts (Frontend Perspective)

> Contract must be confirmed against the actual Moqui integration layer used in this repo. Until confirmed, treat as ‚Äúcontract-at-risk‚Äù.

### Load/view calls
- **Get active session for current user/mechanic**
  - `GET /api/work-sessions/active` (preferred; derived from auth)
  - Alternate: `GET /api/work-sessions/active?mechanicId={id}` (only if required)
  - Returns 200 with WorkSession or 204/404 when none.
- **Get work session by id**
  - `GET /api/work-sessions/{workSessionId}`
- **List breaks for session**
  - `GET /api/work-sessions/{workSessionId}/breaks`

### Create/update calls
- **Start work session**
  - `POST /api/work-sessions/start`
  - Headers: `Idempotency-Key: <uuid>`
  - Request (minimum):
    - `workOrderId`
    - `workOrderTaskId`
    - optional: `locationId` (if required)
    - optional: `resourceId`
    - optional: `overrideReason` (only when override path used)
  - Response: 201 with created WorkSession
- **Stop work session**
  - `POST /api/work-sessions/stop`
  - Headers: `Idempotency-Key: <uuid>`
  - Request: `{ workSessionId }` (preferred) OR `{ workOrderTaskId }` (if supported)
  - Response: 200 with updated WorkSession

### Submit/transition calls (breaks)
- `POST /api/work-sessions/{id}/breaks/start`
  - Headers: `Idempotency-Key: <uuid>`
  - optional body: `breakType`, `notes`
- `POST /api/work-sessions/{id}/breaks/stop`
  - Headers: `Idempotency-Key: <uuid>`
  - Response: updated BreakSegment (or WorkSession + breaks)

### Error handling expectations
- Errors should conform to standard envelope (DECISION-INVENTORY-011) including `correlationId`.
- 400: invalid task state, missing required fields, break rules violated
- 403: lacking permission (including overlap override permission)
- 409: overlap conflict; concurrent mutation; idempotency replay conflicts (if applicable)
- UI must surface backend-provided message; do not reproduce policy client-side beyond basic disabling.

---

## 10. State Model & Transitions

### Allowed states (WorkSession)
- `IN_PROGRESS`
- `COMPLETED`
- `APPROVED`
- `REJECTED` (read-only display if returned)

### Role-based transitions
- Mechanic:
  - create `IN_PROGRESS` via Start Work
  - `IN_PROGRESS` ‚Üí `COMPLETED` via Stop Work
  - manage breaks while `IN_PROGRESS`
- Manager/Admin (out-of-scope):
  - `COMPLETED` ‚Üí `APPROVED` (locks session)
  - `REJECTED` handling out-of-scope

### UI behavior per state
- `IN_PROGRESS`: show live state; enable Stop/Break actions (unless locked).
- `COMPLETED`: disable Stop/Break; allow Start Work on eligible task subject to overlap policy.
- `APPROVED`: show locked badge; disable all mutations.
- `REJECTED`: show status; disable all mutations; show reason if backend provides.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing context IDs: show blocking banner; do not call backend.
- Break start when already on break: backend 409/400; UI shows ‚ÄúBreak already active.‚Äù

### Concurrency conflicts
- Two devices attempt stop/start: backend 409; UI instructs refresh and reload active session state.

### Unauthorized access
- Mechanic attempts override without permission: backend 403; UI: ‚ÄúOverride not permitted.‚Äù

### Empty states
- No active session:
  - Task screen shows ‚ÄúNo active session‚Äù and enables Start Work (if task eligible).
- No breaks:
  - Break list shows empty state ‚ÄúNo breaks recorded.‚Äù

---

## 12. Acceptance Criteria

### Scenario 1: Start work session successfully
**Given** I am logged in as a Mechanic  
**And** I am viewing an assigned Work Order Task eligible to start  
**And** I have no other active `IN_PROGRESS` work session (or overlap is permitted and I use the correct path)  
**When** I click ‚ÄúStart Work‚Äù  
**Then** the system creates a WorkSession with `status = IN_PROGRESS` and `startAt`  
**And** the UI displays the active session details and enables ‚ÄúStop Work‚Äù and ‚ÄúStart Break‚Äù.

### Scenario 2: Stop work session successfully
**Given** I have an active WorkSession in `IN_PROGRESS` for the current task  
**When** I click ‚ÄúStop Work‚Äù  
**Then** the system updates the session to `status = COMPLETED` with `endAt`  
**And** the UI shows `totalDurationSeconds` (net of breaks) returned by the backend  
**And** the UI disables break controls for that session.

### Scenario 3: Start break and end break within a session
**Given** I have an active WorkSession in `IN_PROGRESS`  
**When** I click ‚ÄúStart Break‚Äù  
**Then** a BreakSegment is created with `breakStartAt`  
**And** the UI disables ‚ÄúStart Break‚Äù and enables ‚ÄúEnd Break‚Äù  
**When** I click ‚ÄúEnd Break‚Äù  
**Then** the BreakSegment is updated with `breakEndAt`  
**And** the UI re-enables ‚ÄúStart Break‚Äù.

### Scenario 4: Overlap prevented by default
**Given** I am logged in as a Mechanic  
**And** I already have an `IN_PROGRESS` WorkSession  
**When** I attempt to start another WorkSession  
**Then** the backend responds with HTTP 409 using the standard error envelope including `correlationId`  
**And** the UI displays an overlap error message  
**And** no new session is shown as started.

### Scenario 5: Overlap override requires permission + reason
**Given** I already have an `IN_PROGRESS` WorkSession  
**And** the backend policy allows overlap only with permission and an explicit override reason  
**When** I attempt to start a new WorkSession and provide an override reason  
**Then** the new WorkSession is created  
**And** the UI indicates an override was used (if backend returns override audit fields).

### Scenario 6: Locked/approved sessions are immutable
**Given** a WorkSession is `APPROVED` or has `locked=true`  
**When** I view the session  
**Then** the UI disables Start/Stop/Break actions for that session  
**And** if I attempt a mutation, the backend rejects it and the UI displays an error message with `correlationId`.

### Scenario 7: Idempotency on double-submit
**Given** I am logged in as a Mechanic  
**And** I am starting a work session  
**When** I click ‚ÄúStart Work‚Äù twice quickly (same attempt)  
**Then** the frontend reuses the same `Idempotency-Key` on retry  
**And** the backend returns the same outcome (no duplicate sessions)  
**And** the UI shows a single active session.

---

## 13. Audit & Observability

### User-visible audit data
- Display (read-only) on the session panel when available:
  - `status`, `startAt`, `endAt`, `totalDurationSeconds`
  - `locked` indicator
  - If override used: `overrideReason`, `overrideAt`, `overriddenByUserId` (or mapped display name if available)

### Status history
- Out-of-scope to render full transition history; if backend returns history, UI may render it read-only in a collapsible section.

### Traceability expectations
- Each start/stop/break call must include:
  - `Idempotency-Key` for mutations (DECISION-INVENTORY-012)
- UI must surface `correlationId` from error envelope in error banners to support troubleshooting (DECISION-INVENTORY-011).

---

## 14. Non-Functional UI Requirements
- **Performance:** initial session panel load should complete within 2s on typical shop network; avoid excessive polling.
- **Accessibility:** all controls keyboard reachable; button labels descriptive; status changes announced via aria-live region where feasible in Quasar.
- **Responsiveness:** usable on tablet-sized devices used in bays; actions should be touch-friendly.
- **i18n/timezone:** display timestamps in user timezone; label timezone explicitly; do not change backend storage semantics (DECISION-INVENTORY-016).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for ‚Äúno active session‚Äù and ‚Äúno breaks‚Äù. Why safe: purely UI ergonomics, no policy impact. Impacted sections: UX Summary, Alternate/Empty states.
- SD-ERR-HTTP-MAP: Map HTTP 400/403/404/409/500 to consistent Quasar notifications/banners. Why safe: standard error-handling, no domain policy inference. Impacted sections: Business Rules, Error Flows, Service Contracts.

---

## 16. Open Questions
1. **Domain ownership confirmation (blocking):** This story is labeled `domain:workexec`, but timekeeping is People/HR SoR per workexec domain rules. Confirm that this issue should remain `domain:workexec` as ‚Äúexecution UI integration‚Äù (workexec-owned screens calling People APIs), rather than being relabeled to `domain:people`.
2. What are the **exact backend endpoint paths** and request/response schemas for:
   - start session, stop session
   - start/stop break
   - fetching active session and breaks  
   (The story lists high-level endpoints but Moqui frontend needs exact contracts and whether they are under `/rest/api/v1/...` or another base path.)
3. How should the frontend determine whether **overlap override is available** before attempting start?
   - Is it returned as structured metadata in the 409 error envelope (e.g., `code=OVERLAP` + `overrideAllowed=true`) or via a capabilities/policy endpoint?
4. Is `mechanicId` derived from the authenticated user in the backend, or must the frontend pass `mechanicId/userId` explicitly?
5. How is `locationId` sourced in the frontend (POS context) and is it required by the backend for starting sessions?
6. Does the backend support stopping by `{workSessionId}` only, or can it stop by `{workOrderTaskId}` / ‚Äúcurrent active session‚Äù?
7. Are there any **additional WorkSession statuses** beyond those listed that must be displayed (e.g., `PAUSED`), and what are the UI rules for them?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Timekeeping: Start/Stop Work Session for Assigned Work ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/132

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #131: [FRONTEND] [STORY] Timekeeping: Capture Mobile Travel Time Separately
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] Timekeeping: Capture Mobile Travel Time Separately (Travel Segments)

**Primary Persona:** Mobile Lead (and Mobile Technician as day-to-day actor)

**Business Value:** Ensure mobile technician availability is blocked during travel and travel time is captured accurately for downstream timekeeping/payroll workflows, reducing scheduling conflicts and payroll corrections.

---

## 2. Story Intent

**As a** Mobile Lead (or authorized Mobile Technician),  
**I want** to create and complete travel time segments for a mobile work assignment,  
**So that** scheduling accurately blocks availability during travel and timekeeping has the raw travel records needed for later approval/export to HR/payroll.

### In-scope
- View travel segments for a given mobile assignment / work order context
- Start a new travel segment (choose segment type)
- End the active in-progress travel segment
- Basic validation and user feedback for invalid actions (duplicate in-progress segment, non-mobile assignment, etc.)
- Show ‚Äúavailability blocked / in transit‚Äù indicator based on in-progress segment status (UI-derived from segment state)

### Out-of-scope
- Travel-time buffer/rounding policy application (explicitly owned by People/Timekeeping per backend reference)
- Time approval workflow and ‚Äúsend to HR‚Äù (frontend may display status but not implement approval/export unless endpoints exist)
- GPS tracking, geofencing, map routing
- Managing approval configurations or HR integration settings
- Post-approval corrections via adjustment records (backend concept exists; frontend editing of approved is out-of-scope unless API confirmed)

---

## 3. Actors & Stakeholders

- **Mobile Technician:** Starts/ends travel segments on their own assignment.
- **Mobile Lead / Service Advisor:** May create/end on behalf (only if permitted by capability signal + backend authorization).
- **Scheduler / Dispatch:** Consumes availability status; frontend must reflect blocked time in relevant views.
- **Payroll/HR System (downstream):** Ultimately receives approved travel time (explicitly out-of-scope here).
- **Store/Location Manager:** Needs auditability for on-behalf edits and corrections.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- A **mobile** assignment exists and is accessible to the user (assignment identifier available in route params or context).

### Dependencies (blocking if absent)
- **Backend API contract for travel segments** (paths, request/response, enums, idempotency, error envelope) is not provided in the inputs. The provided workexec domain guide does not define travel segment endpoints.
- **System-of-record/domain ownership** for travel segments/timekeeping is not defined in the provided workexec domain rules. The workexec guide explicitly states time entry remains in **people domain** (DECISION-INVENTORY-009), which conflicts with labeling this story as `domain:workexec` unless clarified as ‚Äúworkexec UI consumption only‚Äù vs ‚Äúpeople-owned feature‚Äù.
- **UI entry point** (which existing Moqui screen(s) link to Travel Time) is not specified in repo references provided.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a **Mobile Assignment / Mobile Appointment** detail screen: ‚ÄúTravel Time‚Äù action/tab
- From a **Work Order (mobile)** detail screen: ‚ÄúTravel Time‚Äù action/tab (if work order is the primary context)

### Screens to create/modify
1. **New screen (proposed):** `apps/pos/screen/mobile/TravelSegmentList.xml`
   - Lists segments for the current assignment
   - Shows active segment (if any) with ‚ÄúEnd Segment‚Äù primary action
   - Shows ‚ÄúStart Segment‚Äù action when no segment is in progress
2. **Modify existing screen(s)** (if present in repo):
   - Mobile assignment detail screen: add navigation to Travel Segment screen
   - Work order detail (mobile): add navigation to Travel Segment screen

### Navigation context
- Route contains `mobileWorkAssignmentId` (preferred) or `workOrderId` with a way to resolve mobile assignment reference.
- Breadcrumb: Mobile Assignments ‚Üí Assignment Detail ‚Üí Travel Time

### User workflows (happy + alternate)
**Happy path**
1. User opens Travel Time screen for an assignment.
2. Sees current segments and whether one is in progress.
3. Clicks ‚ÄúStart Segment‚Äù ‚Üí selects segment type ‚Üí confirms.
4. UI shows segment as `IN_PROGRESS` with start timestamp.
5. On arrival, user clicks ‚ÄúEnd Segment‚Äù ‚Üí confirms.
6. UI shows completed segment with duration.

**Alternate paths**
- Start blocked because there is already an in-progress segment ‚Üí UI shows error and highlights active segment.
- Assignment is not mobile ‚Üí UI shows ‚ÄúTravel time can only be logged for mobile assignments.‚Äù
- User is not authorized ‚Üí UI shows access denied and disables actions.
- Backend indicates ‚Äútimekeeping domain owns this‚Äù / endpoint missing ‚Üí UI shows ‚ÄúTravel time capture is not available‚Äù with correlationId (if provided).

---

## 6. Functional Behavior

### Triggers
- Screen load (route entry): fetch assignment + segments
- Start Segment action
- End Segment action

### UI actions
- **Start Segment**
  - Opens a modal/dialog to select `segmentType` (enum-driven from backend if available; otherwise static list is blocked)
  - Confirm submits to backend with `Idempotency-Key` header (DECISION-INVENTORY-012 pattern; applies to UI mutations)
- **End Segment**
  - Available only when exactly one segment is `IN_PROGRESS` (or backend indicates activeSegment)
  - Confirm submits to backend with `Idempotency-Key` header

### State changes (frontend-local)
- Maintain `segments[]` list and `activeSegment` computed from `status === IN_PROGRESS`
- On successful start/end: refresh list (preferred) or update from response if it includes the updated segment

### Service interactions (Moqui screen actions)
- Load segments for assignment
- Start/create segment
- End/complete segment
- Normalize errors to standard envelope shape when possible (DECISION-INVENTORY-011), but this is blocked until the backend contract is confirmed for this feature

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Cannot start a segment if an `IN_PROGRESS` segment exists for the same assignment.
- Cannot end a segment if none is `IN_PROGRESS`.
- Segment type must be selected (required).
- Travel time can only be logged for **mobile assignments**; otherwise block start/end actions and show error.

### Enable/disable rules
- ‚ÄúStart Segment‚Äù disabled if active segment exists.
- ‚ÄúEnd Segment‚Äù enabled only if active segment exists.
- Segment type selector lists only supported types (v1 per original story text; **blocked until backend enum confirmed**):
  - `DEPART_SHOP`
  - `ARRIVE_CUSTOMER_SITE`
  - `DEPART_CUSTOMER_SITE`
  - `ARRIVE_SHOP`
  - `TRAVEL_BETWEEN_SITES`
  - `DEADHEAD`

### Visibility rules
- If segment was created/edited ‚Äúon behalf‚Äù, show an indicator and audit snippet (**blocked until API fields confirmed**).
- Show an ‚ÄúIn Transit‚Äù banner/indicator when active segment exists.

### Error messaging expectations
- Duplicate in-progress: ‚ÄúYou already have an active travel segment. End it before starting a new one.‚Äù
- Non-mobile: ‚ÄúTravel time can only be logged for mobile assignments.‚Äù
- Unauthorized: ‚ÄúYou do not have permission to record travel time for this technician.‚Äù

---

## 8. Data Requirements

### Entities involved (frontend view model)
- `TravelSegment`
- `MobileWorkAssignmentRef` (or `MobileWorkAssignment`)

### Fields
**TravelSegment**
- `travelSegmentId` (id/opaque string) ‚Äì required (DECISION-INVENTORY-003 pattern: IDs are opaque strings)
- `mobileWorkAssignmentId` (id/opaque string) ‚Äì required
- `technicianId` (id/opaque string) ‚Äì required (may be implied by assignment)
- `segmentType` (enum string) ‚Äì required
- `startAt` (ISO datetime) ‚Äì required
- `endAt` (ISO datetime, nullable) ‚Äì required for completed
- `status` (enum string: `IN_PROGRESS`, `COMPLETED`, `CANCELLED`) ‚Äì required
- `durationMinutes` (number, derived) ‚Äì read-only; display when completed

**Optional audit/on-behalf fields** (ONLY if backend supplies; otherwise blocked)
- `createdBy`, `createdAt`
- `lastUpdatedBy`, `lastUpdatedAt`
- `actedByUserId`, `actedForPersonId`, `onBehalfReasonCode`

### Read-only vs editable
- Segments are not ‚Äúeditable‚Äù in this story; only start/end actions.
- Completed segments are read-only.

### Derived/calculated fields
- `durationMinutes` displayed if provided; otherwise compute in UI from `startAt/endAt` for display only (not persisted).

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking:** Exact API paths/schemas for travel segment capture are not defined in the provided inputs. The workexec domain guide does not define this feature‚Äôs endpoints, and timekeeping ownership appears to be in the People domain (DECISION-INVENTORY-009).

### Load/view calls (proposed placeholders; must be replaced with actual contracts)
- `GET /api/mobile-assignments/{mobileWorkAssignmentId}` (or equivalent) to confirm mobile context (if needed)
- `GET /api/mobile-assignments/{mobileWorkAssignmentId}/travel-segments`
  - Response: list of TravelSegment ordered by `startAt` asc

### Create/update calls (proposed placeholders; must be replaced with actual contracts)
- `POST /api/mobile-assignments/{mobileWorkAssignmentId}/travel-segments`
  - Headers: `Idempotency-Key: <uuid>`
  - Request: `{ "segmentType": "DEPART_SHOP" }` (+ possibly `technicianId` if on-behalf)
  - Response: `201` with TravelSegment

### Submit/transition calls (proposed placeholders; must be replaced with actual contracts)
- `POST /api/travel-segments/{travelSegmentId}/end`
  - Headers: `Idempotency-Key: <uuid>`
  - Request: optional `{ "endAt": "<now>" }` (or none; server uses now)
  - Response: `200` with updated TravelSegment

### Error handling expectations
- Normalize to standard envelope where possible (DECISION-INVENTORY-011):
  - `400` validation errors ‚Üí show message; highlight field if `fieldErrors[]` provided
  - `401/403` ‚Üí show access denied; disable actions
  - `404` assignment/segment not found ‚Üí show not found state
  - `409` conflict (active segment exists / stale state) ‚Üí refresh list and show conflict message
- Include correlationId in user-facing error details when present (supportability)

---

## 10. State Model & Transitions

### TravelSegment states (as described in story; must match backend)
- `IN_PROGRESS`
- `COMPLETED`
- `CANCELLED` (not created by UI in this story unless API exists)

### Allowed transitions (UI-supported)
- Start segment: (no active) ‚Üí creates `IN_PROGRESS`
- End segment: `IN_PROGRESS` ‚Üí `COMPLETED`

### Role-based transitions
- Technician: start/end for self (**blocked until permission/capability contract confirmed**)
- Mobile Lead/Service Advisor: on-behalf start/end (**blocked until permission/capability contract confirmed**)

### UI behavior per state
- `IN_PROGRESS`: show active banner + ‚ÄúEnd Segment‚Äù
- `COMPLETED`: show duration + timestamps; no actions
- `CANCELLED`: show as cancelled; no actions

---

## 11. Alternate / Error Flows

### Validation failures
- Missing segment type ‚Üí prevent submit; show inline error ‚ÄúSegment type is required.‚Äù
- Non-mobile assignment ‚Üí disable actions; show blocking message.

### Concurrency conflicts
- Another user started a segment ‚Üí start returns `409`; UI refreshes and shows the now-active segment.
- Segment ended elsewhere ‚Üí end returns `409/404`; UI refreshes and removes end action.

### Unauthorized access
- User lacks permission to access assignment or record travel ‚Üí show `403` screen state; hide action buttons.

### Empty states
- No segments yet ‚Üí show empty state with ‚ÄúStart Segment‚Äù CTA (if permitted).

---

## 12. Acceptance Criteria

### Scenario 1: Start a travel segment successfully
**Given** I am a Mobile Technician assigned to a mobile work assignment  
**And** there is no existing travel segment in `IN_PROGRESS` for that assignment  
**When** I open the Travel Time screen  
**And** I click ‚ÄúStart Segment‚Äù and select `DEPART_SHOP`  
**Then** a new travel segment is created with status `IN_PROGRESS` and a recorded `startAt` timestamp  
**And** the UI displays an ‚ÄúIn Transit‚Äù indicator and an enabled ‚ÄúEnd Segment‚Äù action.

### Scenario 2: End an in-progress travel segment successfully
**Given** a travel segment for my mobile assignment is in status `IN_PROGRESS`  
**When** I click ‚ÄúEnd Segment‚Äù  
**Then** the segment transitions to `COMPLETED` with `endAt` populated  
**And** the UI shows the segment duration (from `durationMinutes` or computed from timestamps)  
**And** the ‚ÄúIn Transit‚Äù indicator is no longer shown.

### Scenario 3: Prevent starting a new segment when one is already active
**Given** a travel segment for the assignment is in status `IN_PROGRESS`  
**When** I attempt to start another travel segment  
**Then** the system rejects the action with a clear error message  
**And** the UI keeps the existing active segment visible and does not create a second active segment.

### Scenario 4: Block travel time logging for non-mobile assignments
**Given** I navigate to Travel Time from a non-mobile work order/assignment  
**When** the Travel Time screen loads  
**Then** the UI shows ‚ÄúTravel time can only be logged for mobile assignments.‚Äù  
**And** Start/End actions are disabled or hidden.

### Scenario 5: Unauthorized user cannot record travel time
**Given** I am logged in without permission to create or end travel segments for this technician/assignment  
**When** I open the Travel Time screen  
**Then** I can view segments only if permitted  
**And** any record actions are hidden/disabled  
**And** attempting the action results in a `403` error message.

### Scenario 6: Idempotent start/end prevents duplicate segments on retry
**Given** I click ‚ÄúStart Segment‚Äù and the network request times out after submission  
**When** the UI retries the same request using the same `Idempotency-Key`  
**Then** the backend returns the same outcome without creating a second `IN_PROGRESS` segment  
**And** the UI shows only one active segment.

---

## 13. Audit & Observability

- UI must display basic audit metadata if provided by backend (created/modified timestamps and ‚Äúon behalf‚Äù indicator).
- UI must include `Idempotency-Key` for start/end mutations (DECISION-INVENTORY-012).
- UI should surface `correlationId` from error envelope (DECISION-INVENTORY-011) in an expandable error detail area for support.
- Client-side logging must avoid PII; log only: endpoint name, HTTP status, correlationId, assignmentId, segmentId.

---

## 14. Non-Functional UI Requirements

- **Performance:** Travel Time screen loads segments within 2s on typical mobile network for ‚â§100 segments; if more, backend must paginate and UI must support pagination/infinite scroll.
- **Accessibility:** All actions keyboard accessible; dialog has focus trap; labels announced.
- **Responsiveness:** Mobile-first layout; primary actions reachable on small screens.
- **i18n/timezone:** Display timestamps in user timezone (DECISION-INVENTORY-016 pattern); if backend returns timezone-aware timestamps, render accordingly and label timezone in UI.

---

## 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE**
  - Assumed: Provide an explicit empty state with a primary CTA when there are no segments.
  - Why safe: UI-only ergonomics; no domain policy implied.
  - Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- **SD-ERR-HTTP-MAP**
  - Assumed: Standard mapping of HTTP 400/401/403/404/409 to inline/toast errors plus optional refresh on 409.
  - Why safe: Pure error handling; consistent with common frontend practice without altering domain behavior.
  - Impacted sections: Service Contracts, Alternate / Error Flows.

---

## 16. Open Questions

1. **Domain ownership (blocking):** Is travel segment capture/timekeeping owned by `domain:people` (timekeeping) with workexec only consuming/embedding UI, or is there a workexec-owned ‚Äúmobile execution travel‚Äù concept? The workexec guide states time entry remains in people domain (DECISION-INVENTORY-009), which suggests this story‚Äôs `domain:workexec` label may be incorrect.
2. **API contracts (blocking):** What are the exact backend endpoints and payloads for:
   - listing travel segments,
   - starting/creating a segment,
   - ending/completing a segment,
   and what are the exact enum values for `status` and `segmentType`?
3. **Primary context identifier (blocking):** Should the frontend route be keyed by `mobileWorkAssignmentId`, `workOrderId`, or both? If both, which is canonical for segment association?
4. **Permissions/capabilities (blocking):** Confirm the capability flags and enforcement rules for:
   - technician self-capture,
   - Mobile Lead/Advisor on-behalf capture,
   - whether viewing segments requires separate permission.
5. **On-behalf workflow (blocking if supported):** If on-behalf edits are allowed, what fields are required (`actedForPersonId`, `reasonCode`), and what is the allowed reason code enum list?
6. **Cancellation (non-blocking unless required):** Is cancelling a segment in-scope for frontend v1? If yes, what are the rules and endpoint?
7. **Availability indicator source (blocking):** Should availability ‚ÄúIn Transit‚Äù be derived solely from active segment state, or does backend expose a separate availability/status API that must be used?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Timekeeping: Capture Mobile Travel Time Separately  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/131  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Timekeeping: Capture Mobile Travel Time Separately

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Mobile Lead**, I want to record travel time for a mobile appointment so that availability and payroll are accurate.

## Details
- Travel segments depart/arrive/return.
- Policies may auto-apply buffers.

## Acceptance Criteria
- Segments recorded.
- Sent to HR.
- Availability blocked during travel.

## Integrations
- Shopmgr‚ÜíHR TravelTime events/API.

## Data / Entities
- TravelSegment, MobileAssignmentRef

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #129: [FRONTEND] [STORY] Workexec: Create Draft Estimate from Appointment
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Create Draft Estimate from Appointment

### Primary Persona
Service Advisor

### Business Value
Reduce manual re-entry and ensure quote-to-cash starts from the authoritative appointment context (customer/vehicle/location/requested services) by creating a draft estimate directly from an appointment with idempotent behavior.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to create a **Draft** estimate in **workexec** from an appointment  
- **So that** the estimate is initialized with operational context and can immediately be reviewed/edited/approved through the normal estimate workflow.

### In-scope
- Add a **frontend action** from an Appointment context: ‚ÄúCreate Draft Estimate‚Äù.
- Call the backend operation to create the estimate from the appointment (**idempotent**).
- Handle ‚Äúalready created‚Äù idempotent responses by navigating to the existing estimate.
- Persist/linkage visibility in UI:
  - show resulting `estimateId`
  - show that it‚Äôs linked to this appointment (at minimum via appointmentId reference on the estimate header or a link lookup)

### Out-of-scope
- Appointment creation/editing (shop management domain).
- Estimate line-item editing workflows beyond confirming the created draft exists (those belong to estimate authoring stories).
- Any changes to approval configuration logic or estimate state machine beyond ensuring initial status is `DRAFT`.
- Any new event ingestion/inbox processing UI (integration/ops stories).

---

## 3. Actors & Stakeholders
- **Primary actor:** Service Advisor (POS user)
- **System actors:**
  - **Moqui/Quasar UI**: initiates create-from-appointment and routes to estimate view.
  - **Workexec services**: system of record for Estimate lifecycle and create-from-appointment behavior.
  - **Shopmgr services**: system of record for Appointment; provides appointment detail to UI.
- **Stakeholders:** Shop Manager, Customer (indirect)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS.
- User can view the target appointment.
- Appointment is not cancelled (must be enforced server-side; UI may pre-disable if status is available).

### Dependencies (blocking to implement precisely)
1. **Concrete callable contract** for ‚ÄúCreate Draft Estimate from Appointment‚Äù available to the Moqui frontend (service name/screen transition or REST path) is not specified in this issue.
2. **Appointment retrieval contract** used by the Moqui appointment detail screen (service name/entity/view) is not specified in this issue.
3. **Permission/capability signal** for showing/enabling the action is not specified (DECISION-INVENTORY-013 requires capability-driven gating, backend authoritative).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Appointment detail** screen (shopmgr): primary action **‚ÄúCreate Draft Estimate‚Äù**.
- If an estimate is already linked/known: show **‚ÄúView Estimate‚Äù** link instead of create.

### Screens to create/modify
1. **Modify (shopmgr):** `AppointmentEdit.xml` (canonical per DECISION-INVENTORY-002)
   - Add action button ‚ÄúCreate Draft Estimate‚Äù
   - Add display of linked estimate (if known): `estimateId` + link to estimate screen
2. **Use existing (workexec):** `EstimateEdit.xml` (canonical per DECISION-INVENTORY-002)
   - Must accept `estimateId` parameter and load estimate header/status
   - No new estimate editing UI required in this story

### Navigation context
- Entry: `durion-shopmgr/AppointmentEdit` with `appointmentId`
- Exit: `durion-workexec/EstimateEdit` with `estimateId`

> Note: exact URL patterns depend on component mount; Moqui screen names above are canonical artifacts and must be used for implementation.

### User workflows (happy + alternate paths)

**Happy path**
1. SA opens appointment in `AppointmentEdit`.
2. Clicks ‚ÄúCreate Draft Estimate‚Äù.
3. UI calls create-from-appointment operation with idempotency key.
4. UI navigates to `EstimateEdit` for returned `estimateId` (status must be `DRAFT`).

**Alternate paths**
- **Already created:** create call returns existing `estimateId` (idempotent). UI navigates to it and shows informational message.
- **Appointment cancelled:** UI disables action if status is visible; backend rejects if attempted.
- **Timeout/retry:** UI offers retry; must reuse the same idempotency key for the same attempt.
- **403:** UI shows permission error and does not navigate.

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúCreate Draft Estimate‚Äù on appointment detail.

### UI actions
- Generate an `Idempotency-Key` (UUID) at click time and store it for the duration of the attempt.
- Disable the button while request is in-flight.
- Show progress indicator.
- On success:
  - show non-blocking message: ‚ÄúEstimate created: <estimateId>‚Äù (or ‚ÄúEstimate already exists: <estimateId>‚Äù)
  - navigate to `durion-workexec/EstimateEdit?estimateId=<id>`
- On failure:
  - show error message mapped from standard error envelope (DECISION-INVENTORY-011)
  - re-enable button
  - keep user on appointment screen

### State changes (frontend)
- Local state:
  - `createEstimate.status = idle|pending|success|error`
  - `createEstimate.idempotencyKey` (persisted until success/failure)
  - `createEstimate.resultEstimateId` (on success)
- After success, appointment screen should reflect linkage:
  - either by updating local model with returned `estimateId`
  - or by refetching appointment detail (preferred if appointment stores linkage)

### Service interactions
- Call create-from-appointment mutation (workexec-owned).
- Load estimate header on `EstimateEdit` (existing behavior).
- Optionally refetch appointment detail to show linkage (shopmgr-owned).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **IDs are opaque strings** (DECISION-INVENTORY-003). UI must not validate UUID format.
- Client-side pre-checks are limited to presence checks only (safe UX):
  - require `appointmentId` present in screen parameters/model
- Do **not** require `requestedServices` to be present (it is optional).

### Enable/disable rules
- ‚ÄúCreate Draft Estimate‚Äù is disabled when:
  - request is pending
  - appointment status is `CANCELLED` (only if status is available in the appointment payload)
- Permission gating:
  - If capability signal is available, hide/disable action when capability is missing (DECISION-INVENTORY-013).
  - Backend remains authoritative; UI must handle 403.

### Visibility rules
- If a linked `estimateId` is known (from appointment payload or link lookup):
  - show ‚ÄúEstimate: <estimateId>‚Äù with ‚ÄúView Estimate‚Äù
  - hide or disable ‚ÄúCreate Draft Estimate‚Äù to prevent confusion (idempotency still protects server-side)

### Error messaging expectations (standard envelope)
- Parse error envelope fields:
  - `code`, `message`, `correlationId`, optional `fieldErrors[]`
- Display:
  - user-friendly message (from `message` when safe)
  - include `correlationId` in a ‚ÄúDetails‚Äù expandable area for support

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Appointment** (`durion.shopmgr.DurShopAppointment`) ‚Äî shopmgr SoR (DECISION-INVENTORY-010)
- **Estimate** (workexec SoR)
- **Linkage** between appointment and estimate:
  - Either appointment contains `estimateId`, or workexec estimate contains `appointmentId`, or a dedicated link entity exists.
  - UI must support at least one of these; exact SoR for the link is a dependency.

### Fields (types, required, defaults)

**Appointment (read-only in this story)**
- `appointmentId` (type: id/opaque string, required)
- `statusId` (type: text, optional but needed for UI disable; backend must enforce regardless)
- `customerId` (type: id, optional for UI; backend may require)
- `vehicleId` (type: id, optional for UI; backend may require)
- `locationId` (type: id, optional for UI; backend may require)
- `requestedServices[]` (optional)
  - `code` (text)
  - `description` (text)

**Estimate (view after creation)**
- `estimateId` (type: id, required)
- `statusId` (type: text enum, required; must be `DRAFT` after create)
- `appointmentId` (type: id, optional but preferred for traceability)
- `customerId` (type: id, optional)
- `vehicleId` (type: id, optional)
- `locationId` or `shopId` (type: id, optional; naming depends on existing model)

### Read-only vs editable by state/role
- Appointment: read-only.
- Estimate: no editing required by this story; `EstimateEdit` may allow edits but that is outside this story‚Äôs scope.

### Derived/calculated fields
- `hasLinkedEstimate` boolean:
  - true if appointment payload includes `estimateId`
  - or if create call returns an `estimateId` (success)
  - or if a link lookup by `appointmentId` returns an `estimateId`

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: exact Moqui service names/REST paths are not provided. The contracts below define required semantics and headers.

### Load/view calls
1. **Load appointment detail (shopmgr)**
   - Input: `appointmentId`
   - Output: appointment fields above, including `statusId` and (if available) linked `estimateId`

2. **Load estimate header (workexec)**
   - Input: `estimateId`
   - Output: `estimateId`, `statusId`, and header identifiers (customer/vehicle/location/appointmentId if present)

3. **(Optional) Lookup estimate by appointment**
   - Input: `appointmentId`
   - Output: `estimateId` if exists
   - Purpose: allow appointment screen to show linkage even if shopmgr does not store `estimateId`

### Create/update calls
1. **Create estimate from appointment (idempotent mutation)**
   - Headers:
     - `Idempotency-Key: <uuid>` (required; DECISION-INVENTORY-012)
   - Input:
     - `appointmentId` (required)
     - No other client-supplied appointment fields unless explicitly required by backend (to avoid SoR drift)
   - Output (minimum):
     - `estimateId` (required)
     - `statusId` (required; should be `DRAFT`)
     - Optional: `wasCreated` boolean (recommended to distinguish ‚Äúcreated vs existing‚Äù without relying on HTTP status)
   - Semantics:
     - Safe to retry with same idempotency key; must return same outcome.
     - If estimate already exists for appointment, return existing `estimateId` as success (do not require client to treat as error).

### Submit/transition calls
- None.

### Error handling expectations
- Errors conform to standard envelope (DECISION-INVENTORY-011):
  - `code` (string)
  - `message` (string)
  - `correlationId` (string)
  - optional `fieldErrors[]` (each: `field`, `message`)
  - optional `existingResourceId` (for duplicates; not required here but supported)
- HTTP mapping expectations:
  - 400: validation (missing/invalid appointment, missing required appointment fields server-side)
  - 403: unauthorized to create estimate
  - 404: appointment not found / inaccessible
  - 409: conflict (rare; if returned, UI should prompt refresh and optionally attempt link lookup)
  - 5xx/timeout: retryable; UI offers retry and reuses idempotency key for the same attempt

---

## 10. State Model & Transitions

### Estimate states (relevant subset)
- `DRAFT` (must be the created state)

### Allowed transitions (in this story)
- None initiated.

### Role-based transitions
- Not applicable.

### UI behavior per state
- After navigation to `EstimateEdit`, if loaded estimate `statusId != DRAFT`:
  - show warning banner: ‚ÄúEstimate created in unexpected status: <statusId>. Contact support with Correlation ID if present.‚Äù

---

## 11. Alternate / Error Flows

1. **Double-click / retry**
   - UI disables button, but if double-submit occurs (e.g., network retries), idempotency ensures single estimate.
   - UI must reuse the same idempotency key when user clicks ‚ÄúRetry‚Äù for the same failed attempt.

2. **Appointment cancelled**
   - If appointment status is visible and equals `CANCELLED`, disable action and show message.
   - If status not visible, backend must still reject; UI shows backend error.

3. **Backend returns 409 conflict**
   - UI shows: ‚ÄúAnother user may have created an estimate. Refreshing‚Ä¶‚Äù
   - UI refetches appointment detail and/or calls lookup-by-appointment (if available).
   - If an `estimateId` is found, navigate to it; otherwise remain and show error with correlationId.

4. **Unauthorized (403)**
   - UI shows permission error and does not navigate.

5. **Appointment not found (404)**
   - UI shows: ‚ÄúAppointment not found or no longer available.‚Äù Provide link back to appointment list if present.

6. **Empty requested services**
   - Allowed; UI does not block. Estimate may be created with no lines.

---

## 12. Acceptance Criteria

### Scenario 1: Create draft estimate from appointment (happy path)
**Given** I am a Service Advisor viewing `durion-shopmgr/AppointmentEdit` for appointment `A1`  
**And** I have capability to create estimates from appointments  
**When** I click ‚ÄúCreate Draft Estimate‚Äù  
**Then** the UI sends a create-from-appointment request with `Idempotency-Key` and `appointmentId=A1`  
**And** the response contains an `estimateId`  
**And** the UI navigates to `durion-workexec/EstimateEdit` for that `estimateId`  
**And** the estimate loads with `statusId = DRAFT`.

### Scenario 2: Idempotent retry returns existing estimate
**Given** an estimate already exists linked to appointment `A1`  
**When** I click ‚ÄúCreate Draft Estimate‚Äù on appointment `A1`  
**Then** the create-from-appointment operation returns the existing `estimateId` as a success response  
**And** the UI navigates to `durion-workexec/EstimateEdit` for that `estimateId`  
**And** no duplicate estimate is created.

### Scenario 3: Retry after timeout reuses idempotency key
**Given** I clicked ‚ÄúCreate Draft Estimate‚Äù for appointment `A1`  
**And** the request timed out after sending  
**When** I click ‚ÄúRetry‚Äù  
**Then** the UI resends the request using the same `Idempotency-Key` value as the timed-out attempt  
**And** the UI eventually navigates to the single resulting estimate.

### Scenario 4: Appointment cancelled disables action (when status available)
**Given** I am viewing an appointment with `statusId = CANCELLED`  
**Then** the ‚ÄúCreate Draft Estimate‚Äù action is disabled (or hidden)  
**And** the UI does not send a create request if clicked/triggered.

### Scenario 5: Backend validation failure is shown to user
**Given** I am viewing appointment `A1`  
**When** I click ‚ÄúCreate Draft Estimate‚Äù  
**And** the backend responds with `400` and a standard error envelope including `correlationId`  
**Then** the UI displays the error `message`  
**And** the UI displays the `correlationId` in a details area  
**And** I remain on the appointment screen  
**And** the action becomes available again.

### Scenario 6: Unauthorized user
**Given** I am logged in without permission/capability to create estimates from appointments  
**When** I click ‚ÄúCreate Draft Estimate‚Äù  
**Then** the backend responds with `403`  
**And** the UI shows a permission error  
**And** no navigation occurs.

---

## 13. Audit & Observability

### User-visible audit data
- On `EstimateEdit`, display (if available from existing estimate load):
  - `createdDate` / `createdByUserId` (or equivalent Moqui fields)
  - `lastUpdatedDate` / `lastUpdatedByUserId`
- On `AppointmentEdit`, display linked `estimateId` when known.

### Status history
- Not required for this story.

### Traceability expectations
- UI logs a client event: `workexec.create_estimate_from_appointment` with:
  - `appointmentId` (opaque id)
  - `estimateId` (opaque id, once known)
  - `correlationId` (if returned on error)
- Do not log customer PII.

---

## 14. Non-Functional UI Requirements

- **Performance:** show immediate feedback (loading state) within 200ms of click; do not block UI thread.
- **Accessibility:** action is keyboard operable; async messages announced via aria-live; focus management on error (focus error summary/alert).
- **Responsiveness:** usable on tablet service-desk viewport.
- **i18n:** all user-facing strings use localization keys.
- **Timezone:** not applicable beyond displaying any timestamps already present; if displayed, show in user timezone (DECISION-INVENTORY-016).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Allow appointments with no requested services; show ‚ÄúNo requested services‚Äù text because requestedServices is optional and this is a UI-only ergonomics choice. (Impacted: UX Summary, Alternate / Error Flows)
- SD-UX-LOADING-DISABLE: Disable primary action during in-flight request to prevent double submits; safe because backend is idempotent and this reduces accidental retries. (Impacted: Functional Behavior)
- SD-ERR-HTTP-MAP: Standard mapping of HTTP 400/403/404/409/5xx to user messages; safe because it does not change domain policy, only presentation. (Impacted: Business Rules, Alternate / Error Flows)

---

## 16. Open Questions

1. **Create-from-appointment callable contract (blocking):** What is the exact Moqui service name and/or REST path invoked by the frontend to create an estimate from an appointment, and what is the exact request/response payload?
   - Must confirm whether response includes `wasCreated` (recommended) and whether it returns 200 vs 201.

2. **Appointment detail data source (blocking):** In this repo, what is the exact mechanism used by `AppointmentEdit.xml` to load appointment data (entity/service name), and does it include `statusId` and a linked `estimateId`?

3. **Linkage source of truth for UI (blocking):** Where should the appointment screen read the appointment‚Üíestimate linkage from?
   - Option A: appointment payload includes `estimateId` (shopmgr stores linkage)
   - Option B: estimate payload includes `appointmentId` (workexec stores linkage)
   - Option C: dedicated link lookup service by `appointmentId`
   Confirm which is implemented so UI can reliably show ‚ÄúView Estimate‚Äù without guessing.

4. **Capability/permission gating (blocking):** What capability flag or permission controls ‚ÄúCreate Draft Estimate‚Äù and how is it exposed to the frontend (user context endpoint vs session claims), per DECISION-INVENTORY-013?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Workexec: Create Draft Estimate from Appointment ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/129

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #127: [FRONTEND] [STORY] Workexec: Update Appointment Status from Workexec Events
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Consume Workexec Events to Update Appointment Status + Timeline (Moqui)

### Primary Persona
System (Moqui runtime acting as event consumer) benefiting Dispatchers and Service Advisors.

### Business Value
Dispatch and advisors see near-real-time appointment status aligned with work execution progress, improving scheduling accuracy, customer communication, and operational visibility, with an auditable timeline and reopen signaling.

---

## 2. Story Intent

### As a / I want / So that
- **As a** system integrated with Workexec,
- **I want** to ingest Workexec work order events and reflect them onto the linked Appointment‚Äôs status, timeline, and reopen indicator,
- **So that** the appointment board reflects execution reality, even with duplicate or out-of-order event delivery.

### In-scope
- Moqui UI screen changes to **view** (read-only) appointment status, reopen indicator, and status timeline entries.
- Moqui services/entities to support **inbox-style** event ingestion and processing (persist-first, async processing, idempotent).
- Mapping Workexec status ‚Üí Appointment status, including precedence rules for out-of-order delivery.
- Idempotency: no duplicate timeline entries for the same event.
- Orphan handling (no appointment mapping) and invalid mapping handling with ops visibility.

### Out-of-scope
- Emitting Workexec events (owned by workexec/backend).
- Creating/maintaining WorkOrder ‚Üî Appointment mapping (assumed pre-existing; this story consumes it).
- Notifications to external systems (only record/log for ops visibility).
- Appointment authoring/scheduling behavior (shopmgr SoR; this story only updates appointment status/timeline based on events).

---

## 3. Actors & Stakeholders
- **System Actors**
  - Workexec event producer (external to this frontend repo)
  - Moqui runtime (event ingestion endpoint + async processor) acting as consumer
- **Human Stakeholders**
  - Dispatcher (needs real-time status for scheduling/dispatch board)
  - Service Advisor (needs accurate customer-facing updates)
  - Ops/Support (needs orphan/invalid mapping visibility and reprocess controls)

---

## 4. Preconditions & Dependencies
- Appointment exists in Shop Management domain (`durion.shopmgr.DurShopAppointment` per workexec domain guide; shopmgr is SoR).
- Work order references appointment via `durion.workexec.DurWorkOrder.appointmentId` (Decision DECISION-INVENTORY-010).
- Workexec events are delivered at-least-once and may be duplicated/out-of-order (Decision DECISION-INVENTORY-015).
- Standard error envelope is used for API responses where applicable (Decision DECISION-INVENTORY-011).
- IDs are opaque strings; UI/services must not validate UUID/numeric formats (Decision DECISION-INVENTORY-003).

**Blocking dependency:** This story requires confirmation of the actual Moqui component/service wiring used in this repo for inbound events (web endpoint vs internal service invocation), and confirmation of the appointment status field(s) on `DurShopAppointment` to update.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Appointment detail screen (existing shopmgr screen): `durion-shopmgr/AppointmentEdit.xml` (Decision DECISION-INVENTORY-002).
- Ops/admin entry point (new): Workexec ‚Üí Event Inbox / Failures.

### Screens to create/modify
1. **Modify** `durion-shopmgr/AppointmentEdit.xml`
   - Add read-only display of:
     - current appointment execution status (field TBD; see Open Questions)
     - reopen indicator (derived or stored; see Data Requirements)
   - Add a read-only timeline list of status changes (paged).
2. **Create** `durion-workexec/WorkexecEventInbox.xml` (new ops screen)
   - Lists inbox events and processing outcomes (SUCCESS/FAILED/PENDING).
   - Filters: received date range, eventType, workOrderId, appointmentId (if resolved), processingStatus, failureReason.
   - Drilldown to event detail (sanitized payload + identifiers).
3. **Create** `durion-workexec/WorkexecEventFailures.xml` (optional if combined with inbox screen)
   - Focused view of failures with reprocess action (admin-only).

### Navigation context
- Dispatcher/advisor: Appointment list/board ‚Üí Appointment detail ‚Üí Status timeline section.
- Ops: Workexec menu ‚Üí Event Inbox/Failures ‚Üí Event detail ‚Üí (external remediation if mapping missing).

### User workflows (happy + alternate)
- **Happy path (viewer):**
  1. User opens Appointment detail.
  2. Sees current status updated based on latest processed Workexec event.
  3. Reviews timeline entries with timestamps and source event ids.
- **Alternate path (duplicate/out-of-order):**
  1. Duplicate event arrives; processing is idempotent and does not duplicate timeline.
  2. Out-of-order INVOICED arrives after COMPLETED; appointment status becomes INVOICED per precedence.
- **Ops path (orphan/failure):**
  1. Ops opens Event Inbox/Failures.
  2. Sees orphaned event (no appointment mapping) with workOrderId and correlationId.
  3. After mapping is fixed externally, ops reprocesses the event.

---

## 6. Functional Behavior

### Triggers
- Receipt of a Workexec event into Moqui via an ingestion endpoint/service:
  - `WorkorderStatusChanged`
  - `InvoiceIssued` (or equivalent status transition; see Decision DECISION-INVENTORY-015)

### UI actions
- Appointment status/timeline are read-only in UI.
- Ops screen supports:
  - view inbox events and failures
  - reprocess a failed event (admin-only)
  - view sanitized payload and identifiers

### State changes
On successful processing of an event:
- Resolve `appointmentId` from the event‚Äôs `workOrderId`:
  - Prefer direct lookup of `DurWorkOrder` by `workOrderId` and read `appointmentId` (Decision DECISION-INVENTORY-010).
- Compute `appointmentStatus` from Workexec status mapping table (see State Model).
- Apply precedence rules (see State Model) to decide whether to update appointment status.
- Persist:
  - appointment status update (if applied)
  - append-only timeline entry (if not already present for the event id)
  - inbox processing outcome (SUCCESS, with `idempotentNoop` if applicable)

On failure:
- Persist inbox record as FAILED with `failureReason` and minimal identifiers.
- Do not modify appointment.

### Service interactions (Moqui)
- Ingestion service persists event into an inbox entity (persist-first).
- Async processor service reads PENDING inbox events and processes them.
- Processing is idempotent using `eventId` as the primary idempotency key (Decision DECISION-INVENTORY-015), with a fallback composite key only if `eventId` is not guaranteed unique (Open Question).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (server-side; UI only displays outcomes)
- Required fields by event type:
  - All events: `eventId`, `eventType`, `workOrderId`, `eventTimestamp`
  - `WorkorderStatusChanged`: `newStatus` required
- Unrecognized `eventType`:
  - mark FAILED with `failureReason=UNSUPPORTED_EVENT_TYPE`
- Work order not found for `workOrderId`:
  - mark FAILED with `failureReason=WORK_ORDER_NOT_FOUND`
- Work order found but `appointmentId` is null/blank:
  - mark FAILED with `failureReason=APPOINTMENT_NOT_LINKED`
- Appointment not found for resolved `appointmentId`:
  - mark FAILED with `failureReason=APPOINTMENT_NOT_FOUND`
- Status mapping missing for `newStatus`:
  - mark FAILED with `failureReason=INVALID_STATUS_MAPPING`

### Enable/disable rules
- Appointment status and timeline are not editable.
- Ops ‚ÄúReprocess‚Äù action enabled only when:
  - user has admin/ops capability (capability signaling; Decision DECISION-INVENTORY-013)
  - inbox record is FAILED (or optionally PENDING stuck; see Open Questions)

### Visibility rules
- Appointment detail always shows current status field (even if null, show ‚ÄúUnknown/Not yet updated‚Äù).
- Reopen indicator:
  - show when true; otherwise show false (safe UI default: always show boolean).
- Timeline list:
  - newest first (safe UI default)
  - paged

### Error messaging expectations
- Appointment detail:
  - if timeline load fails: ‚ÄúUnable to load status history. Try again.‚Äù (non-destructive)
- Ops screens:
  - show `failureReason`, `message`, `correlationId`, `eventId`, `workOrderId`, `appointmentId` (if resolved)
  - do not show secrets/PII; payload view must be sanitized/minimal

---

## 8. Data Requirements

### Entities involved (Moqui; exact names may vary‚Äîconfirm in Open Questions)

#### ShopMgr Appointment (SoR: shopmgr)
- Entity: `durion.shopmgr.DurShopAppointment`
  - `appointmentId` (PK, type=id)
  - **Status field to update**: TBD (e.g., `executionStatusId` or `statusId`; must not conflict with shop scheduling status) **(blocking)**
  - `reopenFlag` (boolean) **(blocking: confirm if exists or must be added)**
  - Standard audit fields: `createdDate`, `createdByUserId`, `lastUpdatedDate`, `lastUpdatedByUserId` (if present)

#### Workexec Work Order (SoR: workexec; read-only here)
- Entity: `durion.workexec.DurWorkOrder`
  - `workOrderId` (PK, type=id)
  - `appointmentId` (FK to `DurShopAppointment.appointmentId`, type=id)

#### Workexec Event Inbox (new; SoR: workexec integration)
- Entity: `durion.workexec.DurWorkexecEventInbox` (proposed)
  - `inboxId` (PK, type=id)
  - `eventId` (type=id/string; **unique**)
  - `eventType` (string; required)
  - `workOrderId` (type=id; required)
  - `appointmentId` (type=id; nullable until resolved)
  - `newStatus` (string; nullable depending on eventType)
  - `eventTimestamp` (datetime; required; store UTC)
  - `correlationId` (string; optional)
  - `receivedAt` (datetime UTC; required)
  - `processedAt` (datetime UTC; nullable)
  - `processingStatus` (enum: PENDING|SUCCESS|FAILED; required)
  - `failureReason` (enum/string; nullable)
  - `failureMessage` (string; nullable; sanitized)
  - `payloadHash` (string; optional) and/or `payloadJsonRedacted` (text; optional; see Open Questions)
  - `attemptCount` (number; default 0)
  - `lastAttemptAt` (datetime UTC; nullable)

#### Appointment Status Timeline (new; append-only)
- Entity: `durion.shopmgr.DurAppointmentStatusTimeline` (proposed; owned by shopmgr but written by this integration)
  - `timelineId` (PK, type=id)
  - `appointmentId` (FK; required)
  - `appointmentStatusId` (string; required)
  - `appliedAt` (datetime UTC; required) ‚Äî when Moqui applied the change
  - `eventTimestamp` (datetime UTC; required) ‚Äî when event occurred
  - `sourceEventId` (string; required; unique per appointment or globally unique)
  - `sourceEventType` (string; required)
  - `workOrderId` (type=id; required)
  - `correlationId` (string; optional)

### Fields: required/defaults
- All IDs are opaque strings (type=id); no client-side format validation (Decision DECISION-INVENTORY-003).
- `reopenFlag` default false; once true, never set back to false.

### Read-only vs editable by state/role
- Appointment detail: all integration fields read-only for all users.
- Ops screens: read-only for most; reprocess action restricted (capability-gated).

### Derived/calculated fields
- ‚ÄúReopened indicator‚Äù can be derived from:
  - `reopenFlag == true` OR current status == `REOPENED`
- ‚ÄúCurrent status‚Äù is stored on appointment (not derived from timeline at render time) to keep appointment board fast.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementation: services invoked by REST endpoints and by scheduled jobs; screens call services via transitions/actions.

### Load/view calls
1. **Appointment detail load** (existing shopmgr service/screen action)
   - Input: `appointmentId`
   - Output: appointment fields including current execution status + reopenFlag
2. **Timeline list service** `shopmgr.AppointmentStatusTimelineList` (proposed)
   - Input: `appointmentId`, `pageIndex`, `pageSize`
   - Output: `items[]`, `totalCount`
3. **Inbox list service** `workexec.WorkexecEventInboxList` (proposed)
   - Input: filters + pagination
   - Output: `items[]`, `totalCount`
4. **Inbox detail service** `workexec.WorkexecEventInboxDetail` (proposed)
   - Input: `inboxId` or `eventId`
   - Output: identifiers + sanitized payload fields + processing outcome

### Create/update calls (event-driven)
1. **Ingest event** `workexec.IngestWorkexecEvent` (proposed)
   - Transport: REST endpoint (path TBD) OR internal service invoked by integration layer **(blocking)**
   - Input:
     - `eventId` (required)
     - `eventType` (required)
     - `workOrderId` (required)
     - `newStatus` (required for WorkorderStatusChanged)
     - `eventTimestamp` (required)
     - `correlationId` (optional)
     - `payload` (optional; if provided, must be redacted before storage)
   - Behavior:
     - persist inbox record with `processingStatus=PENDING`
     - return 202 Accepted (preferred for async) with `eventId` and `correlationId` echoed
   - Idempotency:
     - if `eventId` already exists, return 202 with existing inbox status (idempotent accept)
2. **Process inbox event** `workexec.ProcessWorkexecEventInbox` (proposed; async job)
   - Input: `inboxId` (or batch criteria)
   - Output: updated inbox record status; appointmentId resolved; applied status (if any)
3. **Reprocess** `workexec.ReprocessWorkexecEventInbox` (proposed; admin-only)
   - Input: `inboxId`
   - Output: updated processing status

### Error handling expectations
- For REST ingestion:
  - 202 for accepted (even if later fails processing)
  - 400 for invalid payload (missing required fields)
  - 401/403 for unauthorized ingestion (security model TBD)
- For UI list/detail services:
  - errors normalized to standard envelope (Decision DECISION-INVENTORY-011) where applicable:
    - `{ code, message, correlationId, fieldErrors? }`

---

## 10. State Model & Transitions

### Workexec statuses (authoritative)
Workexec status taxonomy in workexec is authoritative (Decision DECISION-INVENTORY-004). This story consumes Workexec event statuses and maps them to appointment execution statuses.

### Appointment execution statuses (target)
The story assumes an appointment execution-status enum exists or will be added. The provided mapping table is treated as the required mapping for this integration, but the actual field name and enum storage must be confirmed in Moqui entities (Open Questions).

### Mapping table (Workexec ‚Üí Appointment)
| Workexec Status | Appointment Status |
|---|---|
| CREATED | SCHEDULED |
| PENDING | SCHEDULED |
| ASSIGNED | SCHEDULED |
| CUSTOMER_ARRIVED | CHECKED_IN |
| CHECKED_IN | CHECKED_IN |
| IN_PROGRESS | WORK_IN_PROGRESS |
| STARTED | WORK_IN_PROGRESS |
| PARTS_PENDING | WAITING_FOR_PARTS |
| ON_HOLD | WAITING_FOR_PARTS |
| PARTS_ORDERED | WAITING_FOR_PARTS |
| INSPECTING | QUALITY_CHECK |
| QC_IN_PROGRESS | QUALITY_CHECK |
| WORK_COMPLETE | READY_FOR_PICKUP |
| AWAITING_CUSTOMER | READY_FOR_PICKUP |
| CLOSED | COMPLETED |
| DELIVERED | COMPLETED |
| CUSTOMER_PICKUP | COMPLETED |
| CANCELLED | CANCELLED |
| ABANDONED | CANCELLED |
| INVOICE_GENERATED | INVOICED |
| INVOICED | INVOICED |
| REOPENED | REOPENED |
| REWORK_REQUIRED | REOPENED |

### Precedence rules (event processing)
1. **CANCELLED terminal**: once appointment is CANCELLED, ignore subsequent updates **except** reopen statuses (REOPENED/REWORK_REQUIRED) which may move it to REOPENED.
2. **INVOICED supersedes COMPLETED**: if out-of-order, INVOICED wins over COMPLETED.
3. **REOPENED supersedes terminal**: REOPENED can supersede COMPLETED/CANCELLED; after REOPENED, subsequent non-reopen statuses may apply if not blocked by rule #1.
4. **Idempotent same-status**: if an event maps to the same appointment status as current, do not create a duplicate timeline entry if `sourceEventId` already exists; if `sourceEventId` is new, still append timeline entry (audit) **(blocking: confirm desired behavior)**.

### Role-based transitions
- No human-initiated transitions in UI for this story.

### UI behavior per state
- Always display current status.
- If status is REOPENED or reopenFlag is true, show ‚ÄúReopened‚Äù indicator.
- Timeline shows applied status changes with event timestamps and source identifiers.

---

## 11. Alternate / Error Flows

### Validation failures (bad payload)
- Missing required fields:
  - Ingest endpoint returns 400 (if synchronous validation at ingress)
  - No inbox record created OR create FAILED inbox record (blocking: choose one; see Open Questions)
- Unsupported eventType:
  - record FAILED inbox with `UNSUPPORTED_EVENT_TYPE`

### Duplicate delivery
- If `eventId` already exists:
  - ingestion is idempotent: do not create a second inbox record
  - processing is idempotent: do not create duplicate timeline entry for same `sourceEventId`

### Out-of-order delivery
- Apply precedence rules; record timeline entry only when an update is applied (or per audit policy; see Open Questions).

### Concurrency conflicts
- If appointment update fails due to optimistic lock:
  - mark inbox as FAILED with `failureReason=CONCURRENCY_CONFLICT` and allow reprocess
  - retry-once behavior is allowed but must not cause duplicate timeline entries (idempotency enforced)

### Unauthorized access
- Ingestion endpoint requires service authentication (Decision DECISION-INVENTORY-015; exact mechanism TBD).
- Ops screens restricted by explicit capability/permission (Decision DECISION-INVENTORY-013).

### Empty states
- No timeline entries: show ‚ÄúNo status changes recorded yet.‚Äù
- No inbox events in filter: show ‚ÄúNo events found for selected filters.‚Äù

### Orphaned event (no mapping)
- If work order exists but has no appointmentId:
  - FAILED with `APPOINTMENT_NOT_LINKED`
- If appointmentId exists but appointment missing:
  - FAILED with `APPOINTMENT_NOT_FOUND`
- Do not create appointment.

### Invalid status mapping
- FAILED with `INVALID_STATUS_MAPPING`
- Persist offending `newStatus` value in inbox record.

---

## 12. Acceptance Criteria

### Scenario 1: Successful status update from WorkorderStatusChanged
Given a WorkOrder "WO-123" exists and is linked to Appointment "APPT-1"  
And Appointment "APPT-1" current execution status is "SCHEDULED"  
When the system ingests a WorkorderStatusChanged event with eventId "event-abc", workOrderId "WO-123", newStatus "IN_PROGRESS", and an eventTimestamp in UTC  
And the async processor processes the inbox record successfully  
Then Appointment "APPT-1" execution status is set to "WORK_IN_PROGRESS"  
And a status timeline entry is appended with status "WORK_IN_PROGRESS" and sourceEventId "event-abc"  
And the entry includes workOrderId "WO-123" and the eventTimestamp  
And the inbox record is marked SUCCESS with processedAt set

### Scenario 2: Idempotent duplicate delivery does not duplicate timeline
Given the system has already ingested eventId "event-abc" for workOrderId "WO-123"  
And the inbox record for "event-abc" is SUCCESS  
When the system ingests the same event again with eventId "event-abc"  
Then no new inbox record is created  
And the existing inbox record remains SUCCESS  
And no additional timeline entry is created for sourceEventId "event-abc"

### Scenario 3: Reopen sets permanent reopenFlag and status REOPENED
Given WorkOrder "WO-456" exists and is linked to Appointment "APPT-2"  
And Appointment "APPT-2" execution status is "COMPLETED"  
And reopenFlag is false  
When the system processes a WorkorderStatusChanged event with newStatus "REOPENED"  
Then Appointment "APPT-2" execution status is set to "REOPENED"  
And reopenFlag is set to true  
And a timeline entry is appended for the REOPENED status

### Scenario 4: ReopenFlag is never cleared
Given Appointment "APPT-2" has reopenFlag true  
When the system processes subsequent events that map to non-reopened statuses  
Then reopenFlag remains true

### Scenario 5: CANCELLED terminal rule blocks non-reopen updates
Given WorkOrder "WO-777" exists and is linked to Appointment "APPT-7"  
And Appointment "APPT-7" execution status is "CANCELLED"  
When the system processes a WorkorderStatusChanged event that maps to "WORK_IN_PROGRESS"  
Then Appointment "APPT-7" execution status remains "CANCELLED"  
And the inbox record is marked SUCCESS with `idempotentNoop=true` (ignored due to precedence)  
And no timeline entry is appended for that event

### Scenario 6: CANCELLED can be superseded by reopen
Given Appointment "APPT-7" execution status is "CANCELLED"  
When the system processes a WorkorderStatusChanged event with newStatus "REWORK_REQUIRED"  
Then Appointment "APPT-7" execution status becomes "REOPENED"  
And reopenFlag is true  
And a timeline entry is appended for REOPENED

### Scenario 7: INVOICED supersedes COMPLETED with out-of-order delivery
Given WorkOrder "WO-888" exists and is linked to Appointment "APPT-8"  
And Appointment "APPT-8" execution status is "COMPLETED"  
When the system processes an event that maps to INVOICED for workOrderId "WO-888"  
Then Appointment "APPT-8" execution status becomes "INVOICED"  
And a timeline entry is appended for INVOICED

### Scenario 8: Work order not found is recorded as failure
Given no WorkOrder exists with workOrderId "WO-999"  
When the system ingests a WorkorderStatusChanged event for workOrderId "WO-999"  
And the async processor attempts to process it  
Then the inbox record is marked FAILED with reason "WORK_ORDER_NOT_FOUND"  
And no appointment is modified

### Scenario 9: Appointment not linked is recorded as failure
Given WorkOrder "WO-1000" exists  
And WorkOrder "WO-1000" has no appointmentId  
When the system processes an event for workOrderId "WO-1000"  
Then the inbox record is marked FAILED with reason "APPOINTMENT_NOT_LINKED"  
And no appointment is modified

### Scenario 10: Invalid status mapping is recorded as failure
Given WorkOrder "WO-123" exists and is linked to Appointment "APPT-1"  
When the system processes a WorkorderStatusChanged event with newStatus "SOME_NEW_STATUS" that is not in the mapping table  
Then the inbox record is marked FAILED with reason "INVALID_STATUS_MAPPING"  
And Appointment "APPT-1" execution status is not changed  
And no timeline entry is appended

### Scenario 11: Ops can view failures and reprocess after remediation
Given an inbox record exists with processingStatus FAILED and failureReason "APPOINTMENT_NOT_LINKED"  
And an ops user has the required capability to reprocess  
When the ops user opens the Workexec Event Inbox screen and filters by FAILED  
Then the failed record is visible with eventId, workOrderId, failureReason, and correlationId  
When the underlying WorkOrder is later updated externally to include an appointmentId  
And the ops user clicks Reprocess on the failed inbox record  
Then the inbox record transitions to SUCCESS  
And the appointment status/timeline are updated according to the event

---

## 13. Audit & Observability

### User-visible audit data
- Appointment timeline shows:
  - appointment status applied
  - appliedAt (when processed)
  - eventTimestamp (when occurred)
  - sourceEventId
  - correlationId (if present)

### Status history
- Timeline is append-only; no edits/deletes in UI.

### Traceability expectations
- Every inbox record stores:
  - `eventId`, `workOrderId`, `appointmentId` (if resolved), `correlationId`
  - processingStatus, failureReason, processedAt
- Logs include `correlationId` when present (Decision DECISION-INVENTORY-011).
- Payload storage must be sanitized/minimal; prefer hash + selected fields over raw payload (Decision DECISION-INVENTORY-015; security posture).

---

## 14. Non-Functional UI Requirements

- **Performance:** Appointment detail loads last 50 timeline entries within 1s excluding network latency; timeline supports pagination.
- **Accessibility:** Timeline table supports keyboard navigation and screen-reader labels for status and timestamps.
- **Responsiveness:** Appointment detail and timeline usable on tablet width.
- **i18n/timezone:** Store timestamps in UTC; display in user timezone; label timezone in UI where timestamps are shown (Decision DECISION-INVENTORY-016).
- **Security:** Ops payload views must be redacted; restrict ops screens by explicit permission/capability (Decision DECISION-INVENTORY-013).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for no timeline / no inbox results; qualifies as safe UI ergonomics; impacts UX Summary, Alternate/Error Flows.
- SD-UX-PAGINATION-DEFAULT: Paginate timeline and inbox lists (default page size 50); safe to avoid large renders; impacts UX Summary, Data Requirements.
- SD-OBS-CORRELATION-ID: Surface correlationId when provided; safe observability boilerplate; impacts Audit & Observability, Service Contracts.

---

## 16. Open Questions
1. **Blocking ‚Äî Ingestion wiring:** In this Moqui repo, what is the chosen inbound event transport for Workexec events?
   - REST webhook endpoint in Moqui (preferred for this story), or
   - broker consumer, or
   - polling job only?
   *Decision reference:* Workexec requires inbox + async processing; transport is safe_to_defer but must be selected for implementation (DECISION-INVENTORY-015).
2. **Blocking ‚Äî Appointment field ownership:** On `durion.shopmgr.DurShopAppointment`, what exact field should be updated for ‚Äúexecution status‚Äù without conflicting with scheduling status (e.g., `statusId` vs `executionStatusId`)?
3. **Blocking ‚Äî Reopen indicator storage:** Does `DurShopAppointment` already have `reopenFlag`? If not, should it be added, or should reopen be derived solely from current execution status + timeline?
4. **Blocking ‚Äî Timeline entity location:** Should the appointment status timeline be stored under shopmgr entities (recommended, since appointment is shopmgr SoR), or under workexec with a FK to appointmentId?
5. **Blocking ‚Äî Timeline append policy:** When an event maps to the same appointment status as current, should we still append a timeline entry (for audit) if `sourceEventId` is new, or treat it as a no-op with no timeline row?
6. **Blocking ‚Äî Payload storage policy:** Are we allowed to store any payload JSON in Moqui DB (even redacted), or must we store only `payloadHash` + selected fields?
7. **Blocking ‚Äî Security model:** What authentication mechanism protects the ingestion endpoint (mTLS, signed JWT, shared secret), and what explicit permission/capability gates ops inbox/failure screens?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #85: [FRONTEND] [STORY] Order: Create Sales Order Cart and Add Items
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,blocked:domain-conflict,agent:story-authoring,agent:workexec-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Work Execution: Create Sales Order Cart and Add Items (Domain Ownership + Moqui Integration)

### Primary Persona
POS Clerk

### Business Value
Enable a clerk to start a sales transaction by creating a persistent cart (sales order) and adding products/services with deterministic totals, optional source linking (estimate/workorder), and auditable changes‚Äîso checkout/quoting can proceed efficiently and traceably.

---

## 2. Story Intent

### As a / I want / So that
- **As a** POS Clerk  
- **I want** to create a new sales order cart and add/update/remove items (by SKU or service code), optionally merge items from an estimate/workorder  
- **So that** I can quote and sell at the counter with reliable totals and a clear audit trail.

### In-scope
- Create a new Sales Order (‚Äúcart‚Äù) in `DRAFT` state.
- Display and maintain cart header (orderId, customer/vehicle context if present, terminal/clerk context).
- Add line items by identifier (SKU/service code) with quantity.
- Resolve unit price via Pricing Service; handle pricing-service failure via cache TTL and manual-entry permission gate.
- Optional inventory availability check and insufficient-stock policy (WARN_AND_BACKORDER vs BLOCK) as described.
- Update quantity and remove line items.
- Optional linking to an existing estimate or workorder, using merge + idempotency rules described.
- Display deterministic subtotal (sum of qty * unitPrice).
- Frontend-visible audit cues (show that change is recorded; optionally show transition/audit feed if API exists).

### Out-of-scope
- Promotions, tax finalization, invoicing, order submission/checkout flows.
- Configuration management (inventory policy, price override policies, default locations, approval configs).
- Implementing backend services/entities/events (assumed available).
- Notification delivery (alerts).

---

## 3. Actors & Stakeholders
- **POS Clerk (Primary user)**
- **Service Advisor (Secondary user)**: may link estimates/workorders depending on permissions.
- **Pricing Service (External dependency)**: authoritative unit price.
- **Inventory Service (Optional external dependency)**: availability/backorder status.
- **CRM/Customer context provider (Dependency)**: customerId/vehicleId lookup and selection.
- **Audit/Reporting consumers (Stakeholders)**: require consistent event/audit generation.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS UI.
- User session has access to a **clerk identity** and **terminal identity** (required to create an order per backend rules).
- User has permission to create orders and modify lines (exact permission names TBD; see Open Questions).

### Dependencies (must exist or be stubbed)
- Backend endpoints/services for:
  - Create SalesOrder (cart)
  - Add/update/remove SalesOrderLine
  - Link source (estimate/workorder) and merge idempotently
  - Price quote lookup and/or line add that performs pricing server-side
  - Optional inventory availability check
  - Permission check for manual price entry (`ENTER_MANUAL_PRICE`) and possibly reason codes
- Entities exposed (or mapped) to UI:
  - `SalesOrder`, `SalesOrderLine` (names may differ in Moqui entities; mapping required)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- POS main navigation: **Order / New Order** action.
- Optional: from Customer/Vehicle context screen: **Start Order**.
- Optional: from Estimate/Workorder view: **Create Order from Source** (links source during creation or immediately after).

### Screens to create/modify (Moqui)
1. **`apps/pos/order/OrderCreate.xml`** (new)
   - Action to create a new cart (SalesOrder) and redirect to Order Detail.
2. **`apps/pos/order/OrderDetail.xml`** (new)
   - Shows cart header + line items table + subtotal.
   - Contains add-item form and line edit/remove actions.
   - Contains ‚ÄúLink Source‚Äù action (estimate/workorder) and results summary.
3. **`apps/pos/order/OrderLinkSourceDialog.xml`** (new or embedded screen/dialog)
   - Collect `sourceType` (ESTIMATE/WORKORDER) and `sourceId`.
4. (Optional) **`apps/pos/order/OrderAudit.xml`** (new) if audit feed is available.

> Note: exact file paths must follow repo conventions (README/agents). If different, adjust during implementation.

### Navigation context
- After creation: redirect to `OrderDetail?orderId=...`
- From OrderDetail, allow returning to POS home while preserving orderId in session/history (implementation detail).

### User workflows (happy + alternate paths)

**Happy path**
1. Clerk clicks ‚ÄúNew Order‚Äù.
2. System creates SalesOrder (`DRAFT`) and loads Order Detail.
3. Clerk adds an item by SKU/service code + quantity.
4. UI shows added line, unit price source, and updated subtotal.
5. Clerk adjusts quantities/removes lines as needed.

**Alternate paths**
- Link an estimate/workorder: user provides ID; UI merges lines and shows merge summary.
- Pricing service down: UI uses cached price (within TTL) or prompts for manual price (if permitted) + reason code.
- Inventory insufficient: UI shows warning and line flagged BACKORDER; still included in subtotal.

---

## 6. Functional Behavior

### Triggers
- User clicks **Create New Order**
- User submits **Add Item**
- User edits **Quantity**
- User clicks **Remove Line**
- User initiates **Link Source** (estimate/workorder)

### UI actions
- **Create New Order**
  - Calls create service
  - On success: navigate to OrderDetail with `orderId`
  - On failure: show blocking error banner with reason
- **Add Item**
  - Validate inputs client-side (non-empty identifier, quantity > 0 integer)
  - Call backend add-line operation (preferred: backend performs pricing/inventory checks and returns created line)
  - Render line with flags: `fulfillmentStatus`, `priceSource`, `STALE` indicator if `CACHE`
- **Update Quantity**
  - Inline edit quantity (integer > 0). If set to 0, treat as remove (confirm) OR block (see Open Questions).
  - Call update-line service, refresh order totals
- **Remove Line**
  - Confirm remove
  - Call remove-line service, refresh order totals
- **Link Source**
  - Collect `sourceType` and `sourceId`
  - Call link/merge service
  - Show merge results: items merged vs added as separate lines
  - Ensure idempotency: re-linking same source shows ‚ÄúAlready linked; no changes‚Äù (based on backend response)

### State changes (frontend-visible)
- SalesOrder created in `DRAFT`
- SalesOrder subtotal changes on line add/update/remove/link merge
- Line-level fields set/returned by backend:
  - `fulfillmentStatus` changes based on inventory policy
  - `priceSource` and staleness indicator

### Service interactions
- Create order
- Get order detail (header + lines)
- Add line (with pricing resolution)
- Update line quantity
- Remove line
- Link source (estimate/workorder) -> merge

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Create order** requires terminalId + clerkId context; if missing in UI session:
  - Block action and show: ‚ÄúTerminal or clerk context missing. Please re-login or select a terminal.‚Äù
- **Add item**:
  - Identifier required (SKU/service code)
  - Quantity required, integer, > 0
- **Manual price fallback** (only when pricing unavailable AND no valid cached price):
  - Only show manual price input if user has `ENTER_MANUAL_PRICE`
  - Require:
    - `unitPrice` decimal > 0
    - `reasonCode` non-empty
  - Mark line as `priceSource=MANUAL`
- **Inventory insufficient**:
  - If policy = `WARN_AND_BACKORDER`: allow add, set `fulfillmentStatus=BACKORDER`, show warning
  - If policy = `BLOCK`: prevent add and show error (exact message below)

### Enable/disable rules
- Disable ‚ÄúAdd Item‚Äù submit while request in-flight.
- Disable quantity edit/remove while update in-flight for that line.
- Hide/disable manual price controls unless pricing failure pathway is active and permission is present.
- While `SalesOrder.status != DRAFT`: disable all line modifications and linking.

### Visibility rules
- Show ‚ÄúAnonymous cart‚Äù indicator when `customerId` is null.
- Show ‚ÄúPrice from cache (STALE)‚Äù banner/label when `priceSource=CACHE`.
- Show ‚ÄúBackordered‚Äù badge when `fulfillmentStatus=BACKORDER`.

### Error messaging expectations (user-facing)
- Invalid SKU/service code: **‚ÄúProduct not found‚Äù**
- Pricing service unavailable, cache used: **‚ÄúPricing service unavailable ‚Äî using cached price (may be stale).‚Äù**
- Pricing unavailable, no cache, no permission: **‚ÄúPricing unavailable and manual price entry is not permitted. Try again later or contact a manager.‚Äù**
- Inventory insufficient + BLOCK policy: **‚ÄúInsufficient stock ‚Äî item cannot be added.‚Äù**
- Unauthorized (403): **‚ÄúYou don‚Äôt have permission to perform this action.‚Äù**
- Conflict (409) e.g., concurrent edits: **‚ÄúThis order was updated elsewhere. Reload to continue.‚Äù**

---

## 8. Data Requirements

### Entities involved (frontend view)
- `SalesOrder` (SoR: **TBD ‚Äî domain conflict**, see Open Questions)
- `SalesOrderLine` (SoR: **TBD ‚Äî domain conflict**, see Open Questions)
- Optional reference entities:
  - Estimate, Workorder (as source references only)
- Optional: AuditLog/Event feed (read-only)

### Fields

**SalesOrder**
- `orderId` (string, required, read-only)
- `status` enum: `DRAFT`, `QUOTED`, `COMPLETED`, `VOIDED` (read-only in this story; always `DRAFT` after create)
- `customerId` (string, nullable; editable only if UI supports setting context‚ÄîNOT implemented here unless already exists)
- `vehicleId` (string, nullable; same as above)
- `clerkId` (string, required, derived from session, read-only)
- `terminalId` (string, required, derived from session, read-only)
- `subtotal` (decimal, read-only; returned by backend)
- `createdAt`, `updatedAt` (timestamps, read-only)

**SalesOrderLine**
- `orderLineId` (string, required, read-only)
- `orderId` (string, required, read-only)
- `itemSku` (string, required)
- `itemDescription` (string, returned, read-only)
- `quantity` (int, required, editable)
- `unitPrice` (decimal, required; editable ONLY in manual-price flow at add-time; otherwise read-only)
- `fulfillmentStatus` enum `AVAILABLE|BACKORDER` (read-only)
- `priceSource` enum `PRICING_SERVICE|CACHE|MANUAL` (read-only)
- `reasonCode` (string; required when `priceSource=MANUAL`; read-only after add unless backend supports edits‚Äîassume read-only)
- `sourceType` enum `ESTIMATE|WORKORDER|null` (read-only)
- `sourceId` (string|null, read-only)
- `sourceLineId` (string|null, read-only)

### Read-only vs editable by state/role
- While `SalesOrder.status != DRAFT`: all line modifications disabled (UI should enforce even if not expected in this story).
- Manual price entry: only if permission `ENTER_MANUAL_PRICE` and only during add flow when pricing unavailable.

### Derived/calculated fields
- `lineExtended = quantity * unitPrice` (display only; backend remains authoritative for subtotal)
- `isStalePrice = (priceSource == CACHE)` (display only)

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementation may call REST endpoints directly or via Moqui services; contracts below describe required behaviors, not transport specifics.

### Load/view calls
1. **Get order detail**
   - `GET /api/orders/{orderId}` (TBD exact path)
   - Returns SalesOrder + lines + subtotal

### Create/update calls
2. **Create new order**
   - `POST /api/orders`
   - Request includes (or derives): `customerId?`, `vehicleId?`, `clerkId`, `terminalId`
   - Response: created SalesOrder with `orderId`, `status=DRAFT`, `subtotal=0.00`

3. **Add line**
   - Preferred: `POST /api/orders/{orderId}/lines`
   - Request: `itemSkuOrServiceCode`, `quantity`
   - Optional request fields only in manual flow: `unitPrice`, `reasonCode`
   - Response: created line + updated order subtotal (or require refetch)

4. **Update line quantity**
   - `PUT /api/orders/{orderId}/lines/{orderLineId}`
   - Request: `quantity`
   - Response: updated line + updated subtotal (or require refetch)

5. **Remove line**
   - `DELETE /api/orders/{orderId}/lines/{orderLineId}`
   - Response: success + updated subtotal (or require refetch)

### Submit/transition calls
6. **Link source (merge)**
   - `POST /api/orders/{orderId}/link-source`
   - Request: `sourceType`, `sourceId`
   - Response:
     - Updated lines and subtotal
     - Merge summary: counts of merged vs added; idempotency indicator

### Error handling expectations
- `400` validation errors: show field-level error where possible, otherwise banner.
- `401` redirect to login.
- `403` show permission error.
- `404` show not found (order/line/source not found).
- `409` concurrency: prompt reload and provide reload action.
- `503/504` service unavailable: trigger pricing fallback logic when adding items (cache/manual pathways).

---

## 10. State Model & Transitions

### SalesOrder states (relevant to this story)
- `DRAFT` (modifiable)
- `QUOTED`, `COMPLETED`, `VOIDED` (non-modifiable here; UI must render read-only if encountered)

### Allowed transitions (UI impact)
- This story does **not** implement transitions between SalesOrder states.
- UI must:
  - Allow add/update/remove/link only when `status=DRAFT`
  - Disable modification controls when `status!=DRAFT`

### Role-based transitions
- N/A (no state transitions implemented), but role-based permission affects:
  - Manual price entry (`ENTER_MANUAL_PRICE`)

---

## 11. Alternate / Error Flows

1. **Invalid SKU/service code**
   - Backend returns 404/400 with code indicating unknown item
   - UI shows ‚ÄúProduct not found‚Äù, keeps form inputs for correction

2. **Pricing service unavailable**
   - If backend returns line with `priceSource=CACHE`: show stale warning
   - If backend indicates no price and requires manual:
     - If user has permission: show manual price + reasonCode inputs and allow retry submit
     - Else: show blocking error and do not add line

3. **Inventory insufficient**
   - If WARN_AND_BACKORDER: line added with BACKORDER + warning badge/banner
   - If BLOCK: do not add line; show error

4. **Link source idempotency**
   - Re-link same source:
     - Backend returns no changes or explicit idempotent response
     - UI shows ‚ÄúSource already linked; no changes applied.‚Äù

5. **Concurrency conflict**
   - When updating/removing line:
     - Backend returns 409
     - UI shows conflict message and offers reload; do not attempt auto-merge client-side

6. **Unauthorized**
   - Any action returns 403:
     - UI shows permission error
     - If action is manual price entry, ensure manual controls are hidden/disabled afterwards

7. **Empty states**
   - New order has no lines: show ‚ÄúNo items yet‚Äù and focus add-item input.

---

## 12. Acceptance Criteria

### Scenario 1: Create a new, empty sales cart
Given I am a logged-in POS Clerk with terminal context available  
When I initiate ‚ÄúCreate New Order‚Äù  
Then a SalesOrder is created with a unique orderId  
And the SalesOrder status is DRAFT  
And the subtotal is 0.00  
And the Order Detail screen is shown for that orderId

### Scenario 2: Add a valid and available item to the cart
Given I have a DRAFT sales order  
When I add SKU ‚ÄúABC-123‚Äù with quantity 2  
Then the system adds a SalesOrderLine for ‚ÄúABC-123‚Äù with quantity 2 and a resolved unit price  
And the order subtotal equals the deterministic sum of (quantity * unitPrice) across all lines  
And the new line is displayed in the cart

### Scenario 3: Attempt to add an item with an invalid SKU
Given I have a DRAFT sales order  
When I attempt to add SKU ‚ÄúINVALID-SKU‚Äù with quantity 1  
Then the item is not added to the cart  
And I see the error message ‚ÄúProduct not found‚Äù  
And the order subtotal remains unchanged

### Scenario 4: Update the quantity of an existing item
Given my cart contains a line for SKU ‚ÄúABC-123‚Äù with quantity 2 and unit price 10.50  
When I update that line quantity to 3  
Then the line quantity becomes 3  
And the order subtotal is recalculated and displayed as 31.50

### Scenario 5: Remove an item from the cart
Given my cart contains a line for SKU ‚ÄúABC-123‚Äù  
When I remove that line  
Then the line no longer appears in the cart  
And the order subtotal is recalculated and displayed

### Scenario 6: Add item with insufficient inventory (backorder policy WARN_AND_BACKORDER)
Given I have a DRAFT sales order  
And the inventory insufficient policy is WARN_AND_BACKORDER  
When I add an item that the Inventory Service reports as insufficient stock  
Then the line is added to the cart  
And the line is marked with fulfillmentStatus BACKORDER  
And I see a warning ‚ÄúInsufficient stock ‚Äî item will be backordered‚Äù  
And the line is included in the subtotal calculation

### Scenario 7: Pricing unavailable - use cached price within TTL
Given I have a DRAFT sales order  
And the Pricing Service is unavailable  
And a valid cached price exists within the TTL  
When I add SKU ‚ÄúABC-123‚Äù  
Then the line is added with priceSource CACHE  
And I see ‚ÄúPricing service unavailable ‚Äî using cached price (may be stale).‚Äù

### Scenario 8: Pricing unavailable - manual entry allowed with permission
Given I have a DRAFT sales order  
And the Pricing Service is unavailable  
And no valid cached price exists  
And I have permission ENTER_MANUAL_PRICE  
When I enter a manual unit price and a reason code and submit add-item  
Then the line is added with priceSource MANUAL  
And the reason code is stored for audit  
And the order subtotal updates accordingly

### Scenario 9: Pricing unavailable - manual entry not permitted
Given I have a DRAFT sales order  
And the Pricing Service is unavailable  
And no valid cached price exists  
And I do not have permission ENTER_MANUAL_PRICE  
When I attempt to add the item  
Then the item is not added  
And I see ‚ÄúPricing unavailable and manual price entry is not permitted. Try again later or contact a manager.‚Äù

### Scenario 10: Link estimate merges lines deterministically and is idempotent
Given I have a DRAFT sales order with SKU ‚ÄúTIRE-001‚Äù quantity 2 at price 100  
And an estimate exists with SKU ‚ÄúTIRE-001‚Äù quantity 3 at price 100 and SKU ‚ÄúOIL-001‚Äù quantity 1 at price 25  
When I link the estimate to the cart  
Then the cart line for ‚ÄúTIRE-001‚Äù quantity becomes 5  
And ‚ÄúOIL-001‚Äù is added as a new line  
And the lines include sourceType ESTIMATE and sourceId and sourceLineId values  
When I link the same estimate again  
Then no duplicate lines are created  
And the UI indicates no changes were applied

---

## 13. Audit & Observability

### User-visible audit data
- After each successful action (create/add/update/remove/link), show a non-intrusive confirmation and maintain a ‚Äúlast updated‚Äù timestamp (from `updatedAt` or response).
- If an audit feed endpoint exists, show a read-only panel listing:
  - action type, user, timestamp, key identifiers (orderId, orderLineId)

### Status history
- Not applicable for SalesOrder state transitions in this story, but changes to lines must be traceable.

### Traceability expectations
- UI must pass correlation/request ID headers if project conventions exist (TBD).
- For manual price entry, ensure reasonCode is collected and submitted; do not log sensitive details client-side.

---

## 14. Non-Functional UI Requirements

- **Performance:** Order detail load and line mutations should feel immediate; show loading states. Target < 500ms UI feedback after response; if slower, show spinner.
- **Accessibility:** Keyboard operable add-item flow; proper labels for inputs; warnings/errors announced (ARIA live region).
- **Responsiveness:** Usable on tablet and desktop POS layouts.
- **i18n/timezone/currency:** Display currency formatting consistently with locale; timestamps displayed in local timezone but stored/handled in UTC (display-only here).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide an explicit empty-state message when a cart has no lines; safe because it‚Äôs purely presentational and does not alter business logic. (Sections: UX Summary, Alternate / Error Flows)
- SD-UX-INFLIGHT-DISABLE: Disable action buttons during in-flight requests to prevent duplicate submissions; safe because it reduces accidental double posts without changing domain rules. (Sections: Functional Behavior, Error Flows)
- SD-ERR-HTTP-MAP: Map common HTTP codes (400/401/403/404/409/5xx) to standard user messages; safe because it does not change backend policy, only presentation. (Sections: Service Contracts, Business Rules, Error Flows)

---

## 16. Open Questions

1. **Domain ownership (BLOCKING):** This story is labeled `domain:workexec`, but it describes POS Sales Order/cart creation, pricing resolution, and inventory policy. Which domain is the system-of-record for `SalesOrder`/`SalesOrderLine` and the cart lifecycle in this Moqui repo (e.g., `domain:billing`, `domain:pricing`, `domain:inventory`, or a POS/order domain)?  
2. **Moqui routing & screen conventions (BLOCKING):** What are the exact POS app screen paths and naming conventions in `durion-moqui-frontend` for new order/cart screens (confirm folder and menu integration)?  
3. **Backend endpoint paths for frontend (BLOCKING):** What are the exact REST or Moqui service endpoints for create order, add/update/remove line, get order, and link source in the Moqui frontend integration layer?  
4. **Permissions source & names (BLOCKING):** Besides `ENTER_MANUAL_PRICE`, what permissions control create order, modify lines, and link estimate/workorder? How does the frontend check them (capabilities endpoint vs session claims)?  
5. **Quantity-to-zero behavior:** Should setting quantity to `0` be treated as ‚Äúremove line‚Äù (with confirmation) or rejected as invalid?  
6. **Service vs SKU identifier:** How does the UI distinguish ‚Äúproduct SKU‚Äù vs ‚Äúservice code‚Äù? Is there a unified identifier field, or should there be a selector?  
7. **Inventory check toggle:** Is inventory availability check always on, or configurable per site/terminal? If configurable, where does the frontend read that configuration?  
8. **Pricing cache behavior location:** Is the cache TTL implemented server-side (preferred) or must the frontend implement caching? If frontend, what is the cache key data available in UI (customerAccountId, priceListId, currency)?  
9. **Link source UX:** How does the clerk locate/select an estimate/workorder to link (search dialog vs entering an ID)? If search is required, which endpoints support lookup and what filters are allowed?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #79: [FRONTEND] [STORY] Workexec: Retrieve and Display Estimates for Customer/Vehicle
LABELS: domain:workexec,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:workexec-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Workexec: Retrieve and Display Estimates for Customer/Vehicle

## Primary Persona
Service Advisor

## Business Value
Enable Service Advisors to quickly find and review estimates tied to a specific customer and/or vehicle, understand current status and totals, and navigate into an estimate detail view to support downstream actions (appointment creation, checkout) with correct context and permissions.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor  
- **I want** to retrieve and view estimate lists for a given customer or vehicle, and drill into an estimate to see its details  
- **So that** I can confidently proceed from quote review to scheduling or checkout with accurate status, totals, and notes

## In-scope
- Customer- or vehicle-scoped estimate list entry points (from customer or vehicle context)
- Paginated list view of estimates with status, totals, and ‚Äúlast updated‚Äù
- Estimate detail view with line items and notes
- Permission-aware visibility (only show estimates user is allowed to view)
- Handling of ‚Äúexpired‚Äù estimates:
  - Display expired status/indicator when backend provides `status=EXPIRED` and/or `expiresAt` (see Customer Approval Workflow)
  - Do **not** implement any new business logic for expiry beyond displaying backend-provided fields
- ‚ÄúRetry‚Äù behavior and user-friendly error messages for service failures
- Use Moqui workexec screens as canonical navigation targets where applicable (DECISION-INVENTORY-002)

## Out-of-scope
- Editing estimate line items or changing estimate status (approval/decline/reopen)
- Estimate cloning/repricing
- Appointment creation UI itself (only link/transition with preserved parameters if a target exists)
- SSE/event subscription implementation

---

# 3. Actors & Stakeholders
- **Primary user:** Service Advisor
- **Secondary:** Shop Manager (may view across locations if permitted; exact permission scopes are backend/security-owned)
- **System actors:** Workexec services providing estimate list/detail
- **Stakeholders:** Operations (speed), Compliance/Audit (traceability), Customer experience (accuracy)

---

# 4. Preconditions & Dependencies
- User is authenticated in the POS frontend.
- Workexec component exposes estimate list and detail read endpoints (exact REST paths must be confirmed; Moqui screen-based rendering is acceptable if REST is not present).
- Customer and Vehicle context pages exist (or equivalent global search) to provide `customerId` and/or `vehicleId`.
- Authorization is enforced server-side; UI must handle 401/403 and avoid leaking cross-location data.
- IDs are treated as opaque strings (DECISION-INVENTORY-003).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From **Customer** context: ‚ÄúEstimates‚Äù action/tab opens estimates list filtered by `customerId`.
- From **Vehicle** context: ‚ÄúEstimates‚Äù action/tab opens estimates list filtered by `vehicleId`.
- Optional: allow direct navigation via URL with query params to support deep links from other screens.

## Screens to create/modify (Moqui)
Modify or add screens under `durion-workexec` consistent with existing patterns (DECISION-INVENTORY-002):
1. **Estimate List Screen** (new or extend existing `EstimateEdit.xml` navigation)
   - Accepts `customerId` and/or `vehicleId` (at least one required)
   - Displays a list of `EstimateSummary`
2. **Estimate Detail Screen**
   - Prefer reusing/augmenting existing `EstimateEdit.xml` for detail display (read-only in this story)
   - Accepts `estimateId` (required)
   - Displays `EstimateDetail` including lines + notes
3. Update Customer/Vehicle screens to add navigation transition(s) into Estimate List Screen while preserving context.

## Navigation context
- Preserve query params on drilldown and ‚ÄúBack to list‚Äù:
  - `customerId`, `vehicleId`
  - `status` filter (if used)
  - `pageIndex`, `pageSize`, `sort`
- Preserve context using standard Moqui parameter passing (screen parameters) and/or URL query params.

## User workflows (happy + alternate paths)
### Happy path
1. Service Advisor opens customer (or vehicle) record
2. Clicks ‚ÄúEstimates‚Äù
3. Sees a list of estimates with status, totals, last updated
4. Clicks an estimate row
5. Sees estimate detail with lines and notes
6. Navigates back to the list, preserving filter/sort/page

### Alternate paths
- No estimates found ‚Üí empty state explaining no results for that customer/vehicle
- Unauthorized estimate access ‚Üí permission denial state; do not reveal estimate content
- Backend unavailable ‚Üí error state with Retry

---

# 6. Functional Behavior

## Triggers
- Entering the estimate list screen with `customerId` and/or `vehicleId`
- Changing filters/sort/pagination on list
- Selecting an estimate row
- Entering the estimate detail screen with `estimateId`

## UI actions
### Estimate List
- Load list automatically on screen load when required params are present
- Provide controls for:
  - Status filter (values are backend-driven; UI must not assume a fixed enum beyond displaying what is returned)
  - Sort by last updated (default descending)
  - Pagination controls

### Estimate Detail
- Load detail automatically on screen load
- Show:
  - Header context (estimate identifier, status, last updated)
  - Line items
  - Notes (as provided)
  - Expiry indicator if `status=EXPIRED` and/or `expiresAt` is present
- Provide:
  - ‚ÄúBack‚Äù navigation to list with preserved context

## State changes (frontend view-state)
- List screen view-state: `loading | loaded | error | empty`
- Detail screen view-state: `loading | loaded | error | notFound | forbidden`

## Service interactions
- List: call estimate list endpoint with either `customerId` or `vehicleId`
- Detail: call estimate detail endpoint by `estimateId`
- Error mapping based on HTTP status (DECISION-INVENTORY-011 for envelope expectations where applicable):
  - 401 ‚Üí show ‚ÄúSession expired‚Äù pattern and route to login if that exists
  - 403 ‚Üí show ‚ÄúYou do not have access to this estimate‚Äù
  - 404 ‚Üí show ‚ÄúEstimate not found‚Äù
  - 5xx / network ‚Üí show ‚ÄúUnable to load estimates; service temporarily unavailable‚Äù with Retry

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- List screen requires at least one of:
  - `customerId` OR `vehicleId`
- If neither provided:
  - Show blocking inline error ‚ÄúSelect a customer or vehicle to view estimates.‚Äù and do not call backend.

## Enable/disable rules
- Drilldown row action enabled only when row has a non-empty `estimateId`.
- If backend supplies `status=EXPIRED` and/or `expiresAt`:
  - Show an ‚ÄúExpired‚Äù indicator on list rows and a warning banner on detail.
  - Do **not** infer expiry from dates client-side unless backend provides explicit `expiresAt` and a timezone reference; prefer backend `status` as authoritative (Customer Approval Workflow).

## Visibility rules
- Only show estimates returned by backend; do not attempt to merge across locations client-side.
- Do not render internal-only fields if present; only render fields explicitly mapped in this story‚Äôs data requirements.

## Error messaging expectations
- Use consistent POS error banner/toast conventions.
- Do not expose backend stack traces.
- If backend returns standard error envelope (DECISION-INVENTORY-011), display `message` and log `correlationId`.

---

# 8. Data Requirements

## Entities involved (frontend read models)
- `EstimateSummary` (list)
- `EstimateDetail` (detail)

## Fields (types, required, defaults)

### Identifier rules
- All identifiers are opaque strings; no UUID/numeric validation (DECISION-INVENTORY-003).

### EstimateSummary (list)
Required:
- `estimateId` (string; required)
- `status` (string/enum; required; display as label)
- `grandTotal` (decimal string preferred; see Open Questions) (required to display totals)
- `currencyUomId` (string; required if totals displayed with currency symbol/formatting)
- `lastUpdatedAt` (ISO-8601 datetime string; required)

Optional (display if present):
- `customerId` (string)
- `vehicleId` (string)
- `expiresAt` (ISO-8601 datetime string)
- `summaryText` (string)

### EstimateDetail (detail)
Required:
- `estimateId` (string)
- `status` (string/enum)
- `lastUpdatedAt` (ISO-8601 datetime string)
- `lineItems[]` (array; required for ‚Äúshows lines‚Äù)
  - each line item (minimum):
    - `lineId` (string; required for stable rendering keys)
    - `lineType` (string enum: `SERVICE|PART|FEE|OTHER` if provided; otherwise string)
    - `description` (string)
    - `quantity` (decimal string or number; do not assume integer)
    - `unitPrice` (decimal string or number; nullable if not priced)
    - `lineTotal` (decimal string or number; nullable if not priced)
    - `declined` (boolean; optional; if present, show as declined)
Optional:
- `notes` (string or array of note objects; see Open Questions)
- `expiresAt` (ISO-8601 datetime string)
- Totals breakdown fields (subtotal/tax/fees) if provided

## Read-only vs editable by state/role
- All fields in this story are read-only.

## Derived/calculated fields
- Display formatting only:
  - ‚ÄúLast updated‚Äù formatted in user timezone (DECISION-INVENTORY-016 display rule)
  - Currency formatting using `currencyUomId` if provided
- Do not recalculate totals; backend totals are source of truth.

---

# 9. Service Contracts (Frontend Perspective)

> Contract must be confirmed for REST pathing; however, error envelope and ID handling are standardized by domain decisions.

## Load/view calls
### Option A (preferred if REST exists): Workexec estimate read API
- List estimates:
  - `GET /rest/api/v1/workexec/estimates?customerId={customerId}&vehicleId={vehicleId}&status={status?}&pageIndex={n?}&pageSize={n?}&sort={field?}&sortDir={asc|desc?}`
  - Rules:
    - At least one of `customerId` or `vehicleId` required
    - If both provided, backend should AND-filter (return estimates matching both) unless backend defines otherwise (see Open Questions)
- Get estimate detail:
  - `GET /rest/api/v1/workexec/estimates/{estimateId}`

### Option B (Moqui screen-backed): Use existing `EstimateEdit.xml`
- Navigate to `/webroot/durion-workexec/EstimateEdit?estimateId={estimateId}`
- For list, implement a Moqui screen that queries and renders list server-side, or calls a service and renders results.

## Create/update calls
- None (read-only story)

## Submit/transition calls
- None (read-only story)

## Error handling expectations
- For REST:
  - Errors should conform to standard envelope (DECISION-INVENTORY-011):
    - `{ code, message, correlationId, fieldErrors?, existingResourceId? }`
  - UI behavior:
    - 400: show validation message (and field errors if present)
    - 401/403/404: show appropriate state
    - 5xx/network: show retryable error
- For Moqui screen rendering:
  - Map Moqui errors to the same user-facing messages; log correlationId if available.

---

# 10. State Model & Transitions

This story is display-only; it does not initiate estimate state transitions.

## Allowed states
- Display whatever `status` values backend returns.
- Known from Customer Approval Workflow (informational, not enforced client-side):
  - `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`
- UI must not assume these are exhaustive.

## Role-based transitions
- None initiated by this UI in this story.

## UI behavior per state
- Always show list rows regardless of status, subject to backend filtering and permissions.
- If `status=EXPIRED`:
  - Show ‚ÄúExpired‚Äù indicator and, if `expiresAt` present, display expiry timestamp.

---

# 11. Alternate / Error Flows

## Validation failures
- Missing both `customerId` and `vehicleId`:
  - Show blocking message; do not call backend.

## Concurrency conflicts
- Reads should not normally return 409. If a 409 is returned:
  - Treat as retryable and show ‚ÄúEstimate changed; reload to view latest.‚Äù with Retry.

## Unauthorized access
- 403 on list:
  - Show ‚ÄúYou do not have access to view estimates for this customer/vehicle.‚Äù
- 403 on detail:
  - Show ‚ÄúYou do not have access to this estimate.‚Äù and do not show any estimate data.

## Empty states
- 200 with empty list:
  - Show ‚ÄúNo estimates found for this customer/vehicle.‚Äù
  - Provide navigation back to customer/vehicle record.

---

# 12. Acceptance Criteria

### Scenario 1: View estimates for a customer
**Given** I am authenticated as a Service Advisor  
**And** I navigate to the Estimates list from a Customer record with `customerId`  
**When** the Estimates list screen loads  
**Then** the system requests estimates filtered by that `customerId`  
**And** I see a paginated list of estimates including each estimate‚Äôs ID, status, grand total, currency (if provided), and last updated timestamp

### Scenario 2: View estimates for a vehicle
**Given** I am authenticated as a Service Advisor  
**And** I navigate to the Estimates list from a Vehicle record with `vehicleId`  
**When** the Estimates list screen loads  
**Then** the system requests estimates filtered by that `vehicleId`  
**And** I see a paginated list of estimates including each estimate‚Äôs ID, status, grand total, currency (if provided), and last updated timestamp

### Scenario 3: Drill into estimate details
**Given** I am viewing an Estimates list with at least one estimate row  
**When** I select an estimate row  
**Then** I am navigated to the Estimate detail screen for that `estimateId`  
**And** the system loads the estimate detail  
**And** I can see line items and notes returned by the backend

### Scenario 4: Preserve navigation context
**Given** I opened the Estimates list with a `customerId` (and optional filters/sort/page)  
**When** I navigate into an Estimate detail and then go back to the list  
**Then** the list screen restores the same `customerId`/`vehicleId` context  
**And** my previously selected filters/sort/page are preserved

### Scenario 5: No estimates found
**Given** I am viewing the Estimates list for a valid `customerId` or `vehicleId`  
**When** the backend returns an empty result set  
**Then** I see an empty state indicating no estimates were found  
**And** the UI does not display an error

### Scenario 6: Unauthorized access to estimate detail
**Given** I attempt to open an estimate detail  
**When** the backend responds with HTTP 403  
**Then** I see a permission denied message  
**And** no estimate line items or notes are displayed

### Scenario 7: Backend service unavailable
**Given** I am on the Estimates list screen  
**When** the backend request fails with a network error or HTTP 5xx  
**Then** I see an error message ‚ÄúUnable to load estimates; service temporarily unavailable‚Äù  
**And** I can select ‚ÄúRetry‚Äù to re-attempt loading

### Scenario 8: Expired estimate is indicated (when provided by backend)
**Given** I am viewing an estimate that the backend marks as expired via `status=EXPIRED` and/or provides `expiresAt`  
**When** the estimate appears in the list or detail view  
**Then** the UI displays an ‚ÄúExpired‚Äù indicator  
**And** the UI does not attempt to change the estimate status

---

# 13. Audit & Observability

## User-visible audit data
- Display `lastUpdatedAt` on list and detail.

## Status history
- Not required by this story.

## Traceability expectations
- Frontend logs include:
  - screen name (`estimateList`, `estimateDetail`)
  - request correlationId when provided by backend error envelope (DECISION-INVENTORY-011)
  - identifiers used (`customerId`/`vehicleId`/`estimateId`) as operational identifiers
- Do not log notes content or line descriptions if they may contain sensitive customer text; log only counts (e.g., `lineItemCount`) where useful.

---

# 14. Non-Functional UI Requirements

## Performance
- Paginate list results; do not render unbounded lists.
- Show loading indicators; avoid blocking UI thread.

## Accessibility
- Keyboard navigable list and detail actions.
- Status and error messages announced via accessible alerts (Quasar standard).

## Responsiveness
- Works on tablet and desktop POS layouts.

## i18n/timezone/currency
- Format datetimes in the user‚Äôs timezone for display (DECISION-INVENTORY-016).
- Currency formatting uses `currencyUomId` when provided; otherwise display numeric totals without currency symbol and treat as a contract gap.

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty-state copy and ‚ÄúBack‚Äù navigation; qualifies as safe UX ergonomics; impacts UX Summary, Error Flows, Acceptance Criteria.
- SD-UX-PAGINATION: Use standard pagination controls with default page size (repo standard); qualifies as safe UX ergonomics; impacts UX Summary, Functional Behavior, Service Contracts.
- SD-ERR-HTTP-MAP: Map 401/403/404/5xx to standard user messages; qualifies as safe because it is generic error handling and does not change domain policy; impacts Functional Behavior, Error Flows.

---

# 16. Open Questions

1. **API contract (blocking):** What are the exact backend endpoints and response shapes for:
   - list estimates by customer/vehicle (including pagination envelope)
   - get estimate detail  
   (Docs show `/api/estimates/...` and Moqui screen routes; this story needs the canonical contract for the frontend implementation path.)

2. **Filter semantics (blocking):** If both `customerId` and `vehicleId` are provided, should the backend:
   - AND-filter (estimates for that customer *and* vehicle), or
   - OR-filter (either), or
   - treat one as primary and ignore the other?

3. **Status filter values (blocking):** What status values should be offered in the list filter UI?
   - Should the UI use a backend-provided list of statuses, or a fixed subset?
   - Confirm whether the estimate status taxonomy is exactly `DRAFT/APPROVED/DECLINED/EXPIRED` (Customer Approval Workflow) or includes additional statuses.

4. **Totals and numeric types (blocking):** Confirm:
   - Is `grandTotal` a decimal string (preferred) or number?
   - Is `currencyUomId` always present?
   - Any rounding/display rules required (UI will not recalculate, but must format consistently).

5. **Notes schema (blocking):** What is the structure of `notes` in `EstimateDetail`?
   - plain string, array of note objects, or rich text?
   - Are any notes internal-only and must be hidden from Service Advisors?

6. **Moqui screen vs REST (blocking):** For this repo, should implementation be:
   - Moqui screen-backed (server-rendered queries/services), or
   - Vue/Quasar SPA calling REST endpoints?  
   (Story currently references Vue/Quasar, but Moqui screen conventions are also authoritative; pick one canonical approach for this story.)

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Workexec: Retrieve and Display Estimates for Customer/Vehicle  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/79  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Workexec: Retrieve and Display Estimates for Customer/Vehicle

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Service Advisor**, I want to view estimates for a customer/vehicle so that I can move from quote to appointment or checkout.

## Details
- List open/draft/approved estimates.
- Show totals, status, and last updated.

## Acceptance Criteria
- Estimates list shown with statuses.
- Drilldown shows lines and notes.
- Links preserved.

## Integrations
- Workexec provides estimate read APIs/events.

## Data / Entities
- EstimateSummary, EstimateDetail, WorkexecRef

## Classification (confirm labels)
- Type: Story
- Layer: Experience
- domain :  Point of Sale

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

