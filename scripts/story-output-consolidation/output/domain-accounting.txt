════════════════════════════════════════
ISSUE #207: [FRONTEND] [STORY] Events: Receive Events via Queue and/or Service Endpoint
LABELS: domain:accounting,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:accounting-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Accounting Events Ingestion (Ops Tool): Submit Canonical Event to Sync Ingestion Endpoint + View Acknowledgement

### Primary Persona
Accounting integration operator / platform engineer (diagnostic + producer validation support)

### Business Value
Provide an internal, permission-gated Moqui UI that can submit a canonical accounting event envelope to the ingestion sync endpoint and display deterministic acknowledgements/errors, enabling end-to-end validation of ingestion behavior (auth, validation, idempotency, conflict/quarantine) without external tooling and without leaking sensitive payloads.

---

## 2. Story Intent

### As a / I want / So that
- **As a** platform engineer or accounting integration operator,
- **I want** a Moqui UI to submit a canonical accounting event envelope to the ingestion sync API and view the acknowledgement/result,
- **So that** I can validate integration behavior end-to-end (validation, auth failures, idempotent replay, conflict detection) and capture support-ready identifiers for troubleshooting.

### In-scope
- Moqui screen(s) to:
  - enter a canonical event envelope (including JSON payload)
  - submit to a **sync ingestion endpoint**
  - display acknowledgement fields and normalized outcome (accepted vs replay vs conflict vs rejected)
- Client-side validation aligned to Accounting domain rules:
  - UUIDv7 validation for identifiers when provided (**Decision AD-006**)
  - JSON validity validation for payload
- Permission gating:
  - screen access and submit action are denied-by-default (**Decision AD-013**)
  - raw payload visibility is restricted (**Decision AD-009**)
- Error handling mapped to canonical `{errorCode, message, details}` shape (**Decision AD-013**)
- Observability: propagate W3C Trace Context headers (**Decision AD-008**) and show copyable identifiers

### Out-of-scope
- Implementing broker/Kafka/SQS ingestion configuration and operations (backend/infrastructure)
- Downstream mapping/posting screens (journal entries, ledger posting, etc.)
- EventType-specific payload schema validation beyond JSON syntax (backend remains authoritative)
- Retry/reprocess ingestion records (covered by separate ingestion monitoring workflow `/accounting/ingestion/*`; not part of this submit tool)

---

## 3. Actors & Stakeholders
- **Integration Operator / Platform Engineer (human user):** submits test events and inspects responses.
- **Accounting Ops:** uses acknowledgements/IDs to troubleshoot ingestion outcomes.
- **Security/Admin:** ensures only authorized users can access the tool and that payload visibility is controlled.
- **Backend Accounting Ingestion Service:** authoritative validator and persistence/processing owner for ingestion outcomes (**Decision AD-007**).

---

## 4. Preconditions & Dependencies
- Moqui is configured with an environment-specific base URL for the Accounting backend.
- A **sync ingestion endpoint** exists and is reachable from Moqui.
- Authentication/authorization from Moqui to backend is configured (token forwarding or service credential).
- Backend returns errors using canonical shape `{ errorCode, message, details? }` (**Decision AD-013**).
- W3C Trace Context headers are propagated on outbound calls (`traceparent` required; `tracestate` optional) (**Decision AD-008**).

**Blocking dependency (clarification required):**
- The Accounting domain guide defines ingestion monitoring endpoints (`/accounting/ingestion/*`) but does **not** define a sync submit endpoint path for arbitrary event submission. This story requires the exact endpoint path + response schema for the sync submit tool.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main menu: **Accounting → Integrations → Event Ingestion → Submit (Sync)**
- Direct route (proposed): `/accounting/integration/event-ingestion/submit`

### Screens to create/modify
- **New screen:** `apps/<app>/screens/accounting/integration/EventIngestionSubmit.xml`
  - Form for envelope input + submit action
  - Result panel for acknowledgement/error (including raw response viewer with payload gating)
- **Optional (recommended) shared include:** `apps/<app>/screens/accounting/integration/includes/EventIngestionResult.xml` for reuse later

### Navigation context
- Under Accounting → Integrations.
- Breadcrumb: Accounting → Integrations → Event Ingestion → Submit (Sync).

### User workflows (happy + alternate paths)

**Happy path (new event accepted):**
1. User opens Submit (Sync).
2. User enters required envelope fields and valid JSON payload.
3. User clicks **Submit**.
4. UI shows acknowledgement with copyable identifiers and normalized outcome.

**Alternate path (idempotent replay):**
1. User submits the same `eventId` with identical payload again.
2. UI shows successful acknowledgement and indicates replay/idempotent outcome.

**Alternate path (duplicate conflict):**
1. User submits an event with `eventId`.
2. User changes payload but keeps the same `eventId`, submits again.
3. UI shows conflict outcome and guidance.

**Failure paths:**
- Client-side validation blocks submit (missing fields, invalid UUIDv7, invalid JSON).
- Backend validation errors show field/row details if provided.
- Forbidden/auth errors show safe messaging without leaking record existence.
- Dependency failure shows retry guidance.

---

## 6. Functional Behavior

### Triggers
- User clicks **Submit** on the ingestion form.

### UI actions
- Validate locally before submit:
  - Required: `specVersion`, `eventType`, `sourceModule`, `eventTimestamp`, `schemaVersion`, `payload`
  - Optional: `eventId`, `correlationId`
  - If `eventId` provided: must be UUIDv7 format (**Decision AD-006**)
  - If `correlationId` provided: must be non-empty string (trimmed)
  - `payload` must parse as JSON object (or JSON value if backend allows; see Open Questions)
- On submit:
  - Generate and attach W3C `traceparent` header if absent; propagate unchanged if present (**Decision AD-008**)
  - Disable submit button while request is in flight (prevent double-submit)
  - POST envelope to backend sync ingestion endpoint
  - Render normalized outcome:
    - **Success panel** for 2xx with acknowledgement fields
    - **Error panel** for non-2xx with `errorCode`, `message`, and `details` (if any)
  - Provide “Copy” actions for `eventId`, `correlationId` (if present), and `traceparent` value used

### State changes
- Client-side state only (no persistence required):
  - `lastRequest` (sanitized; never log/store raw payload beyond in-memory UI state)
  - `lastResponse`
  - `lastHttpStatus`
  - `lastErrorCode`
  - `submittedAtClient` timestamp

### Service interactions
- Moqui screen action calls a Moqui service that performs outbound HTTP to backend:
  - Proposed service: `accounting.integration.EventIngestionSubmit` (final name per repo conventions)
- Service returns a normalized map for the screen:
  - `httpStatus`
  - `ack` (map) when success
  - `error` (map) when failure
  - `traceparent` (string) used/propagated for the call

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Required fields must be present and non-empty (trimmed) before submit.
- UUIDv7 validation:
  - `eventId` (if provided) must be UUIDv7 (**Decision AD-006**)
  - If backend returns an `eventId`, UI treats it as authoritative and displays it even if user omitted it
- Payload JSON:
  - Must be syntactically valid JSON
  - UI does not validate eventType-specific schema (backend authoritative)
- Timestamp:
  - `eventTimestamp` must be ISO-8601 parseable; UI sends as entered (normalized to ISO string if UI uses a date-time picker)

### Enable/disable rules
- Submit button disabled when:
  - request in flight
  - required fields invalid/missing
  - payload JSON invalid
- “Generate eventId” helper:
  - **Not allowed** unless the frontend can generate UUIDv7 deterministically (identifiers are not a safe default) (**Decision AD-006**, SAFE_DEFAULTS denylist)
  - If UUIDv7 generation is available in the codebase, allow a “Generate UUIDv7” action and label it explicitly “UUIDv7”

### Visibility rules
- Acknowledgement panel visible after any server response.
- Error details visible only on non-2xx responses.
- Raw response JSON viewer:
  - Always available for ack/error metadata
  - Must redact/hide any raw payload echo unless user has payload permission (see below)

### Error messaging expectations
- Display backend `errorCode` prominently when present.
- Map common HTTP classes to user-safe guidance:
  - 409: duplicate conflict guidance (change `eventId` or revert payload)
  - 403/401: access denied (do not reveal whether eventId exists)
  - 422: schema unsupported guidance (change schemaVersion/eventType)
  - 503/5xx: temporary failure guidance (retry later)

### Payload visibility policy
- Default view shows only:
  - user-entered payload editor (since user typed it)
  - backend-provided `payloadSummary` (if returned)
- If backend returns any raw payload echo fields, UI must:
  - hide them unless user has `accounting:events:view-payload` (**Decision AD-009**, **Decision AD-013**)
  - never log them
  - avoid caching beyond in-memory render

---

## 8. Data Requirements

### Entities involved
- No new Moqui entities required for MVP.
- This is a diagnostic UI; persistence/history is out of scope.

### Fields (type, required, defaults)

**Request (form input model):**
- `specVersion` (string, required)
- `eventId` (string UUIDv7, optional)
- `eventType` (string, required)
- `sourceModule` (string, required)
- `eventTimestamp` (string datetime, required; ISO-8601)
- `schemaVersion` (string, required)
- `correlationId` (string, optional)
- `payload` (JSON, required; entered as text and parsed before send)

**Response (ack/error model):**
- `eventId` (string UUIDv7; required on success; may be present on some errors)
- `processingStatus` and/or `status` (string; backend-authoritative)
- `receivedAt` (string datetime; backend-authoritative)
- Optional:
  - `idempotencyOutcome` (string; backend-authoritative enum if provided) (**Decision AD-007**)
  - `message` (string)
  - `payloadSummary` (object/string; safe summary)
  - `errorCode`, `message`, `details` for errors (**Decision AD-013**)

### Read-only vs editable by state/role
- All request fields editable at all times (to support replay/conflict testing).
- Response panel is read-only.
- Payload visibility in response is permission-gated (see Business Rules).

### Derived/calculated fields
- `payloadParsed` derived from payload text; submission uses parsed JSON.
- `payloadValid` boolean for UI validation state.
- `traceparentUsed` stored for display/copy.

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls
- None required for initial load.
- Optional config load:
  - default `specVersion` from Moqui configuration (not hardcoded)

### Create/update calls
- **POST** to backend sync ingestion endpoint (exact path TBD; see Open Questions):
  - Request body: canonical envelope fields listed above
  - Headers:
    - `traceparent` (required) and `tracestate` (optional) (**Decision AD-008**)
    - auth headers per platform standard

### Submit/transition calls
- Single submit action:
  - Moqui service: `accounting.integration.EventIngestionSubmit`
  - Output normalization:
    - `httpStatus` (int)
    - `ack` (map) for 2xx
    - `error` (map) for non-2xx
    - `traceparent` (string)

### Error handling expectations
- Backend error schema (canonical) (**Decision AD-013**):
  - `{ errorCode, message, details? }`
- UI mapping:
  - 400/422: show inline/global validation summary; if `details` includes field keys, map to fields
  - 401/403: show access denied; do not reveal existence of eventId
  - 404: show not found (only if backend uses it; otherwise treat as generic error)
  - 409: show conflict guidance
  - 5xx/timeout: show retry guidance; preserve user inputs

---

## 10. State Model & Transitions

### Allowed states (frontend view)
- `Idle`
- `Submitting`
- `Success` (2xx)
- `ClientValidationFailed`
- `ServerValidationFailed` (400/422)
- `Forbidden` (401/403)
- `Conflict` (409)
- `ServerFailure` (5xx/503)
- `NetworkError` (no HTTP response)

### Role-based transitions
- Screen view requires permission (see Open Questions; must be explicit per **Decision AD-013**).
- Submit requires ingest permission (see Open Questions).
- Viewing raw payload fields requires `accounting:events:view-payload` (**Decision AD-009**, **Decision AD-013**).

### UI behavior per state
- `Submitting`: disable submit; show progress indicator.
- `Success`: show acknowledgement summary + raw response metadata.
- `Conflict/Forbidden/ServerValidationFailed/ServerFailure/NetworkError`: show error panel with code/message and guidance; keep form editable.

---

## 11. Alternate / Error Flows

### Validation failures
- Client-side:
  - Missing required fields → block submit; show inline errors
  - Invalid UUIDv7 in `eventId` → block submit; show inline error
  - Invalid JSON payload → block submit; show inline error
- Server-side:
  - 400/422 with `details` → show global error + map details to fields when keys match

### Concurrency conflicts
- Not applicable (single submission tool). If backend returns 409, treat as duplicate conflict.

### Unauthorized access
- If user lacks screen permission: Moqui denies access (do not render form).
- If backend returns 401/403: show access denied; do not reveal whether the eventId exists.

### Empty states
- First load: blank form; optionally prefill `specVersion`.
- No response yet: hide result panels.

---

## 12. Acceptance Criteria

### Scenario 1: Authorized user submits valid event and sees acknowledgement
Given I have permission to view the Accounting Event Ingestion Submit screen  
And I have permission to submit events to the ingestion sync endpoint  
And I enter valid values for specVersion, eventType, sourceModule, eventTimestamp, schemaVersion  
And I enter a syntactically valid JSON payload  
When I click Submit  
Then the UI sends a POST request to the configured sync ingestion endpoint with the canonical envelope  
And the request includes a `traceparent` header  
And I see an acknowledgement panel that includes the returned eventId and receivedAt  
And I can copy the eventId and traceparent used

### Scenario 2: Replay submission returns success and is indicated as replay/idempotent
Given I previously submitted an event with eventId "E1" and payload "P1" and received a successful acknowledgement  
When I submit the same eventId "E1" with the same payload "P1" again  
Then the UI shows a successful acknowledgement  
And the UI indicates the outcome is an idempotent replay based on backend response fields and/or HTTP status

### Scenario 3: Duplicate conflict returns 409 and shows safe guidance
Given an event with eventId "E1" and payload "P1" was previously accepted  
When I submit eventId "E1" with a different payload "P2"  
Then the UI shows an error result  
And the HTTP status displayed is 409  
And the UI displays the backend errorCode  
And the UI guidance instructs me to use a new eventId or revert the payload

### Scenario 4: Client-side validation blocks invalid UUIDv7 eventId
Given I am on the Event Ingestion Submit screen  
When I enter an invalid UUID value in eventId  
And I click Submit  
Then the UI prevents submission  
And I see an inline validation error indicating eventId must be a UUIDv7

### Scenario 5: Client-side validation blocks invalid JSON payload
Given I am on the Event Ingestion Submit screen  
When I enter a payload that is not valid JSON  
And I click Submit  
Then the UI prevents submission  
And I see an inline validation error indicating payload must be valid JSON

### Scenario 6: Forbidden response does not leak existence and shows access denied
Given I am on the Event Ingestion Submit screen  
When the backend responds with 401 or 403  
Then the UI shows an access denied message  
And the UI does not display messaging that confirms whether the submitted eventId already exists

### Scenario 7: Dependency failure shows retry guidance and preserves inputs
Given I entered a valid envelope and payload  
When the backend responds with a 5xx/503 error or the request times out  
Then the UI shows a failure result with retry guidance  
And my entered form values remain present for retry

---

## 13. Audit & Observability

### User-visible audit data
- Display (copyable):
  - `eventId` (returned or submitted)
  - `eventType`, `sourceModule`, `schemaVersion`
  - `correlationId` (if provided)
  - `receivedAt` (if returned)
  - `traceparent` used

### Status history
- In-session only:
  - show `submittedAtClient` and last outcome
- No persistence/history in this story.

### Traceability expectations
- Moqui logs for the submit service must include structured fields:
  - `eventId` (if provided/returned), `eventType`, `sourceModule`, `schemaVersion`, `httpStatus`, `errorCode`
- Must not log:
  - raw payload JSON
  - auth tokens
  - raw backend payload echoes (**Decision AD-009**)

---

## 14. Non-Functional UI Requirements
- **Performance:** show in-progress state within 250ms of submit; do not freeze UI when rendering large JSON (use collapsible/lazy rendering).
- **Accessibility:** labeled fields; inline errors associated to fields; keyboard navigable; error summary announced (aria-live).
- **Responsiveness:** usable at tablet widths; payload editor scrolls independently.
- **i18n/timezone/currency:** display timestamps in user locale while preserving raw ISO strings in a raw response section.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE-01: Hide result panels until first response; qualifies as safe UI ergonomics; impacts UX Summary, Alternate / Error Flows.
- SD-UX-ERROR-MAP-01: Map canonical `{errorCode,message,details}` to field/global errors when keys match; qualifies as safe because error schema is explicitly defined by Accounting domain guide; impacts Service Contracts, Alternate / Error Flows, Acceptance Criteria.
- SD-OBS-TRACE-PROP-01: Propagate W3C Trace Context headers and generate `traceparent` only if absent; qualifies as safe because tracing standard is explicitly defined (**Decision AD-008**); impacts Functional Behavior, Audit & Observability.

---

## 16. Open Questions

1. What is the exact backend endpoint path for **sync event submission** (e.g., `POST /accounting/ingestion/submitSync` vs another path), and what is the exact success response schema (fields and meanings)?  
2. What permissions gate this submit tool?
   - Screen view permission token (new or reuse `accounting:events:view`?) (**Decision AD-013 requires explicit mapping**)  
   - Submit/ingest permission token (story currently references `SCOPE_accounting:events:ingest`, but this scope is not defined in the Accounting domain guide)  
3. Does the backend accept `payload` as any valid JSON value, or must it be a JSON object? If object-only, confirm errorCode returned when not an object.

════════════════════════════════════════
ISSUE #204: [FRONTEND] [STORY] CoA: Create and Maintain Chart of Accounts
LABELS: domain:accounting,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:accounting-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] CoA: Create and Maintain Chart of Accounts (GL Accounts)

**Primary Persona:** Finance Manager / Accountant (authorized CoA maintainer)

**Business Value:** Maintain an accurate, auditable Chart of Accounts so downstream posting, reporting, and controls (effective dating, deactivation) behave predictably and compliantly.

---

## 2. Story Intent

**As a** Finance Manager / Accountant,  
**I want** a POS admin UI to create, view, edit (limited fields), and deactivate GL accounts with effective dating and audit visibility,  
**so that** the Chart of Accounts stays clean, controlled, and usable for financial classification and posting.

### In-scope
- List/search GL accounts with filters (type, status, effective dating windows)
- View GL account details including audit metadata
- Create GL account (code, name, type, description, activeFrom, optional activeThru)
- Update allowed fields only (name/description)
- Deactivate GL account by setting `activeThru` effective date/time (subject to backend policy)
- Show and handle backend validation errors (duplicate codes, invalid dates, policy violations, auth)

### Out-of-scope
- Defining/deleting chart structures (parent/child hierarchies) unless provided by API
- Editing `accountCode` or `accountType` after creation
- Any GL posting, balances display, reconciliation, or reporting screens
- Posting Categories / mappings / rule sets (explicitly out unless separately specified)

---

## 3. Actors & Stakeholders

- **Primary Actor:** Finance Manager / Accountant
- **Secondary Actors:** Auditor (read-only needs), System Administrator (may grant permissions)
- **System Dependencies:** Accounting backend service (GL account endpoints), AuthN/AuthZ provider, Audit log provider (if separate)

---

## 4. Preconditions & Dependencies

- User is authenticated.
- **Permissions are not defined in the Accounting domain guide for CoA maintenance.** Per Accounting **AD-013 (Permission Gating Model)**, screens must not ship without explicit permission mapping.
- Backend provides APIs for:
  - listing GL accounts (paged)
  - retrieving GL account by id
  - creating GL account
  - patching/updating allowed fields
  - deactivating with effective date (or updating `activeThru`)
- Backend enforces:
  - unique account codes
  - canonical account types: ASSET/LIABILITY/EQUITY/REVENUE/EXPENSE
  - effective dating constraints
  - deactivation policy constraints (e.g., non-zero balance/usage), with stable error codes/messages

**Decision rationale applied (from Accounting domain rules):**
- **AD-013** requires explicit permission tokens; since none are provided for CoA, this story remains blocked for clarification rather than inventing `CoA:Manage`/`CoA:View`.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Accounting → Chart of Accounts**
- Direct routes (proposed; must align with repo conventions):
  - List: `/accounting/coa`
  - Create: `/accounting/coa/create`
  - Detail: `/accounting/coa/account/{glAccountId}`

### Screens to create/modify (Moqui)
- **New Screen:** `apps/pos/screen/accounting/Coa.xml` (container + sub-screens)
  - `CoaList.xml` (list/search)
  - `CoaCreate.xml` (create form)
  - `CoaDetail.xml` (view + edit + deactivate action)
- Add menu entry in the app’s navigation (per repo conventions)

### Navigation context
- Breadcrumbs:
  - Accounting → Chart of Accounts → (List | Create | Account Detail)

### User workflows (happy + alternate)
**Happy path: Create**
1. User opens CoA list.
2. Clicks “Create GL Account”.
3. Fills required fields and submits.
4. On success, navigates to detail view for the new account with confirmation banner.

**Happy path: Update name/description**
1. From detail screen, user enters edit mode for allowed fields.
2. Saves changes; sees updated metadata (updatedAt/updatedBy).

**Happy path: Deactivate**
1. From detail screen, user selects “Deactivate”.
2. Provides effective deactivation date/time.
3. Confirms; on success, detail shows `activeThru` and a derived status badge.

**Alternate: View-only**
- User can list and view details without edit actions if lacking manage permission (exact permission token(s) TBD).

---

## 6. Functional Behavior

### Triggers
- Screen load triggers data fetch (list or detail)
- Form submit triggers create/update/deactivate service calls

### UI actions
- List:
  - filter by `accountType`
  - filter by derived status (Active / Inactive / NotYetActive) **only if backend supports filtering**; otherwise UI provides client-side status chips derived from returned dates but does **not** claim server-side filtering
  - search by `accountCode` or `accountName` **only if supported by API** (no client-side full dataset search)
  - pagination controls (server-side)
- Detail:
  - display fields read-only by default
  - “Edit” toggles editable fields (name, description only)
  - “Deactivate” opens confirmation + effective date input

### State changes (frontend)
- Local UI state only (loading, saving, error)
- UI may compute a badge based on `activeFrom/activeThru` for display only; backend remains authoritative for enforcement.

### Service interactions
- Load list via Moqui service call (see Service Contracts)
- Create via service call; handle duplicate code conflict
- Update via patch service call
- Deactivate via dedicated action call (preferred) or update `activeThru` if that is the backend contract

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (client-side, non-authoritative)
- Required fields on create:
  - `accountCode` (non-empty; trim whitespace)
  - `accountName` (non-empty; trim whitespace)
  - `accountType` (must be one of allowed enum values)
  - `activeFrom` (non-empty)
- Effective date validation:
  - if `activeThru` provided, must be strictly after `activeFrom`
- Deactivate validation:
  - `effectiveDate` required
  - Do **not** enforce “>= now” or “open period” client-side (policy is backend-owned; see AD-012 for period enforcement generally, but CoA deactivation policy is not specified)

### Enable/disable rules
- Create/Edit/Deactivate actions are shown only when the user has the (TBD) manage permission.
- Deactivate action disabled if:
  - `activeThru` exists and `activeThru <= now` (already inactive)
- If `activeThru` exists and `activeThru > now` (scheduled deactivation):
  - UI shows “Deactivation scheduled” and **does not** offer “change deactivation date” unless backend explicitly supports it (no guessing).

### Visibility rules
- Always show audit fields (createdAt/createdBy/updatedAt/updatedBy) if returned by API.
- Status badge derived for display only:
  - **NotYetActive:** now < activeFrom
  - **Active:** now >= activeFrom AND (activeThru is null OR now < activeThru)
  - **Inactive:** activeThru is not null AND now >= activeThru

### Error messaging expectations
- Duplicate code: show inline error on `accountCode` with backend message; also top-level banner.
- Policy violation on deactivate: show modal error with backend reason; do not change UI state.
- Auth failure: show “You do not have permission” and disable actions; for 401 redirect to login.
- Do not invent error codes; display backend `errorCode` (if present) in a copyable “Details” area for support.

---

## 8. Data Requirements

### Entities involved
- `GLAccount` (Accounting domain)

### Fields
| Field | Type | Required | Editable | Default | Notes |
|---|---|---:|---:|---|---|
| glAccountId | UUIDv7 | yes (response) | no | n/a | route param for detail; naming TBD by backend |
| accountCode | string | yes | create-only | none | unique; backend authoritative on case sensitivity |
| accountName | string | yes | yes | none | editable post-create |
| accountType | enum | yes | create-only | none | ASSET/LIABILITY/EQUITY/REVENUE/EXPENSE |
| description | string | no | yes | empty | optional |
| activeFrom | datetime (tz) | yes | create-only | none | effective start |
| activeThru | datetime (tz) | no | via deactivate action | null | do not expose as free-edit unless specified |
| createdAt | datetime (tz) | if provided | no | n/a | display |
| updatedAt | datetime (tz) | if provided | no | n/a | display |
| createdBy | string/UUID | if provided | no | n/a | display |
| updatedBy | string/UUID | if provided | no | n/a | display |

### Read-only vs editable by state/role
- If user lacks manage permission: all fields read-only; actions hidden/disabled.
- If account is inactive (`activeThru <= now`): **editing policy is unknown**; UI should allow edit attempt only if backend contract allows it, otherwise disable edit when inactive (requires clarification).

### Derived/calculated fields
- `uiStatusBadge` derived for display only (NotYetActive/Active/Inactive).

---

## 9. Service Contracts (Frontend Perspective)

**STOP NOTE:** Accounting domain guide provides canonical endpoint families for exports/payments/refunds/ingestion/apply-payment, but **does not define CoA/GLAccount endpoints**. Per SAFE_DEFAULTS_MODE (denylist: event contracts/identifiers/security boundaries), we cannot invent these. This story remains blocked until backend contract is confirmed.

### Load/view calls (TBD)
- **List GL accounts**
  - Endpoint/service: **TBD**
  - Request params (expected):
    - `pageIndex`, `pageSize`, `orderBy`
    - optional filters: `accountType`, `accountCode`, `accountName`, `activeOn` (date), `status` (if supported)
  - Response (expected):
    - `{ data: GLAccount[], pageInfo: { pageIndex, pageSize, totalCount } }`

- **Get GL account detail**
  - Endpoint/service: **TBD**
  - Request: `glAccountId`
  - Response: `GLAccount`

### Create/update calls (TBD)
- **Create GL account**
  - Endpoint/service: **TBD**
  - Body (expected): `{ accountCode, accountName, accountType, description?, activeFrom, activeThru? }`
  - Success: returns created `GLAccount` including `glAccountId`
  - Errors (expected mapping):
    - 400/422 validation errors (dates, required fields, enum)
    - 409 duplicate code (or 400 with errorCode)
    - 403 forbidden

- **Update mutable fields**
  - Endpoint/service: **TBD**
  - Body: `{ accountName?, description? }`
  - Concurrency control: **TBD** (ETag/version field)

### Submit/transition calls (TBD)
- **Deactivate GL account**
  - Preferred: dedicated command endpoint/service: **TBD**
  - Body: `{ effectiveDate }`
  - Errors:
    - policy violation (e.g., non-zero balance/usage) with stable `errorCode`
    - validation errors for effectiveDate
    - 403 forbidden

### Error handling expectations (frontend)
- Use canonical error shape when provided:
  - `{ errorCode, message, details? }`
- Map HTTP errors to UI:
  - 400/422: inline field errors when `details` contains field keys; else banner
  - 401: redirect to login
  - 403: show not-authorized callout; do not reveal record existence (treat 403/404 similarly in messaging if required by security policy)
  - 404: “Not found” safe message + back-to-list
  - 409: conflict banner; if duplicate code, inline on `accountCode`
  - 5xx/timeout: retry affordance; preserve inputs

---

## 10. State Model & Transitions

### Allowed states (UI-level, derived)
- **NotYetActive**: now < activeFrom
- **Active**: now >= activeFrom AND (activeThru is null OR now < activeThru)
- **Inactive**: activeThru is not null AND now >= activeThru

### Role-based transitions
- Manage permission (TBD token):
  - can create
  - can update name/description (subject to backend)
  - can deactivate (set activeThru) subject to backend rules
- Without manage permission:
  - view only

### UI behavior per state
- Inactive: show badge “Inactive”; disable “Deactivate”.
- NotYetActive: show badge “Not yet active”; allow deactivate only if backend supports setting `activeThru` before `activeFrom` (unknown; default to allow attempt and rely on backend validation only if clarified).

---

## 11. Alternate / Error Flows

- **Duplicate account code on create**
  - Backend returns conflict/validation error
  - UI shows inline error on `accountCode` and preserves form values

- **Invalid effective dates**
  - Client-side blocks submit when `activeThru <= activeFrom`
  - Backend errors displayed if returned

- **Deactivation policy violation**
  - Backend returns policy error (e.g., 422) with `errorCode/message`
  - UI shows blocking dialog/banner; no local changes

- **Concurrency conflict**
  - If backend returns 409/412 due to version mismatch:
    - UI prompts reload
    - UI discards edit mode and shows “Record changed; please review latest values”

- **Unauthorized**
  - 403: show access denied; hide actions
  - 401: login flow

- **Empty states**
  - List returns 0 results: show “No accounts found” with “Clear filters”
  - If authorized, show “Create GL Account” CTA

---

## 12. Acceptance Criteria

### Scenario 1: View CoA list (authorized view)
**Given** I am an authenticated user with the CoA view permission (TBD)  
**When** I navigate to Accounting → Chart of Accounts  
**Then** I see a server-paginated list of GL accounts showing account code, name, type, and effective dates  
**And** I can paginate through results without loading the full dataset client-side

### Scenario 2: Create a new GL account successfully
**Given** I am an authenticated user with the CoA manage permission (TBD)  
**When** I create a GL account with a unique account code, a name, an account type of `ASSET`, and an activeFrom date  
**Then** the system creates the account successfully  
**And** I am navigated to the account detail screen for the new account  
**And** the account detail shows the persisted values and any audit metadata returned by the backend

### Scenario 3: Prevent duplicate account code
**Given** I am an authenticated user with the CoA manage permission (TBD)  
**And** a GL account exists with account code "1010-CASH"  
**When** I attempt to create a new GL account with account code "1010-CASH"  
**Then** I see an inline validation error indicating the account code is already in use  
**And** the form remains editable with my previously entered values preserved

### Scenario 4: Update name/description only
**Given** I am an authenticated user with the CoA manage permission (TBD)  
**And** I am viewing an existing GL account  
**When** I edit the account name and description and save  
**Then** the changes are persisted  
**And** the account code and account type are not editable in the UI  
**And** the UI displays updated audit metadata if returned by the backend

### Scenario 5: Deactivate a GL account with an effective date
**Given** I am an authenticated user with the CoA manage permission (TBD)  
**And** I am viewing an active GL account  
**When** I deactivate the account effective tomorrow  
**Then** the account detail displays an activeThru date equal to tomorrow  
**And** the UI displays the derived status as “Inactive” once the effective date passes

### Scenario 6: Deactivation blocked by policy
**Given** I am an authenticated user with the CoA manage permission (TBD)  
**And** I am viewing an active GL account that violates deactivation policy  
**When** I attempt to deactivate the account  
**Then** I see an error explaining the policy violation using the backend-provided message and errorCode (if present)  
**And** the account remains unchanged in the UI

### Scenario 7: Unauthorized user cannot manage CoA
**Given** I am authenticated  
**And** I do not have the CoA manage permission (TBD)  
**When** I navigate to a GL account detail screen  
**Then** I can view the account details if I have view permission  
**And** I do not see controls to create, edit, or deactivate accounts  
**And** if I attempt a restricted action via direct URL or UI manipulation, the backend response is handled as access denied without leaking record existence

---

## 13. Audit & Observability

- **User-visible audit data (read-only):**
  - createdAt, createdBy, updatedAt, updatedBy (when provided)
- **Status history:** out-of-scope unless backend provides an audit/history endpoint for GLAccount changes.
- **Traceability expectations (per AD-008 principles):**
  - Frontend propagates `traceparent`/`tracestate` headers on all CoA API calls.
  - UI error surfaces include a copyable “Support details” section containing:
    - `glAccountId` (when applicable)
    - `errorCode` (if present)
    - request timestamp

**Security note (aligned with AD-013 principles):**
- Do not log sensitive payloads; for CoA this is low sensitivity, but still avoid logging full request bodies in client telemetry.

---

## 14. Non-Functional UI Requirements

- **Performance:** first page list load under ~2s under normal conditions; show loading state.
- **Accessibility:** labeled inputs; keyboard navigable dialogs; validation messages associated to fields and announced.
- **Responsiveness:** usable on tablet widths; tables support horizontal scroll when needed.
- **i18n/timezone:** display datetimes in user locale; input uses timezone-aware picker; do not assume UTC-only.
- **Security:** permission-based rendering; backend remains source of truth; do not reveal record existence on 403/404.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a standard empty-state panel on list screens with optional “Create” CTA when authorized; safe because it doesn’t change domain behavior (Impacted: UX Summary, Alternate/Empty states).
- SD-UX-PAGINATION: Default to server-side paginated list view with page size control; safe because it’s purely UI ergonomics (Impacted: UX Summary, Functional Behavior).
- SD-ERR-HTTP-MAPPING: Standard HTTP→UI error mapping (400/401/403/404/409/422/5xx) using backend messages; safe because it follows implied REST semantics without inventing policies (Impacted: Service Contracts, Error Flows).

---

## 16. Open Questions

1. **Backend contract (blocking):** What are the exact Moqui services and/or REST endpoints for GLAccount list/detail/create/update/deactivate, including request/response field names (e.g., `glAccountId` vs `accountId`) and pagination/sort parameters?
2. **Permissions (blocking, AD-013):** What are the explicit permission tokens for:
   - viewing CoA list/detail
   - creating/updating/deactivating GL accounts
   (Replace the placeholder “TBD” and ensure Moqui artifact authz is configured accordingly.)
3. **Deactivation policy (blocking):** What specific conditions block deactivation (e.g., non-zero balance, referenced by mappings, used in posted journal entries), and what stable `errorCode` values should the UI expect and display?
4. **Editing inactive accounts (blocking):** Are name/description edits allowed after an account becomes inactive, or must inactive accounts be immutable?
5. **Status filtering (blocking):** Does the list endpoint support server-side filtering by derived status (Active/Inactive/NotYetActive), or should the UI only display derived badges without a status filter?
6. **Optimistic locking (blocking):** Does GLAccount use ETag/version for concurrency? If yes, what request header/field is required and what response code is returned on conflict (409 vs 412), and does the response include the latest entity?

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] CoA: Create and Maintain Chart of Accounts  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/204  
Labels: frontend, story-implementation, general

## Frontend Implementation for Story

**Original Story**: [STORY] CoA: Create and Maintain Chart of Accounts

**Domain**: general

### Story Description

/kiro
# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## Capability
[CAP] Maintain Chart of Accounts and Posting Categories

## Story
CoA: Create and Maintain Chart of Accounts

## Acceptance Criteria
- [ ] Accounts support types: Asset/Liability/Equity/Revenue/Expense
- [ ] Accounts are effective-dated (activeFrom/activeThru) and audit-logged
- [ ] Duplicate account codes are blocked
- [ ] Deactivation rules are enforced per policy (e.g., balances/usage)


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

════════════════════════════════════════
ISSUE #203: [FRONTEND] [STORY] Categories: Define Posting Categories and Mapping Keys
LABELS: domain:accounting,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:accounting-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Accounting: Manage Posting Categories, Mapping Keys, and Effective-Dated GL Mappings

### Primary Persona
Financial Controller / Accountant

### Business Value
Enable consistent, deterministic classification of producer financial events into Posting Categories and effective-dated GL mappings (account + dimensions), with auditability and validation, so journal entry generation can be automated reliably.

---

## 2. Story Intent

### As a / I want / So that
**As a** Financial Controller,  
**I want** to create and maintain Posting Categories, producer-facing Mapping Keys, and effective-dated mappings from categories to GL accounts (and required dimensions),  
**so that** producer systems can deterministically resolve posting instructions for a transaction date and finance can audit configuration history.

### In-scope
- Moqui frontend screens to:
  - List/view/create/update/deactivate Posting Categories
  - List/view/create/update/deactivate Mapping Keys and link them deterministically to a Posting Category
  - Create new effective-dated GL mappings for a Posting Category (no overlapping ranges)
  - View mapping history for a category (effective ranges + audit metadata)
  - Validate and surface API errors (overlap conflicts, missing GL account, deactivated category, etc.)
- Read-only resolution test utility (optional UI) to validate a mapping key resolves for a given transaction date **if** backend provides an endpoint.

### Out-of-scope
- Defining or editing Chart of Accounts itself (assumed managed elsewhere; this story only selects from existing GL accounts)
- Defining Posting Rule Sets, journal entry generation, or posting to ledger
- Tax rules, revenue recognition, or any debit/credit mapping logic
- Automatic “close previous mapping end date” behavior unless explicitly confirmed (see Open Questions)

---

## 3. Actors & Stakeholders
- **Financial Controller / Accountant**: configures categories/keys/mappings, reviews history, resolves validation errors.
- **Auditor (read-only)**: reviews configuration history and audit fields.
- **Producer System Integrator (read-only)**: verifies mapping keys and resolution behavior (if UI utility exists).
- **System (Moqui backend services)**: enforces invariants (uniqueness, effective dating, non-overlap, immutability/versioning policy).

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui application.
- Authorization exists for managing posting configuration (**permission tokens are not defined in Accounting domain guide; see Open Questions**).
- Backend provides services/endpoints for:
  - Posting Category CRUD + deactivate
  - Mapping Key CRUD + link to Posting Category
  - GL Mapping create (new version) + list/history by category
  - Chart of Accounts lookup (list GL accounts for selection and validate existence)
  - (Optional) mapping resolution by key + date for producers/test utility
- Backend enforces audit logging and immutability/versioning rules; frontend must not assume it can “hard update” records if backend requires create-new-version semantics.
- Effective-dated GL mappings must be **non-overlapping** (Accounting domain rule: “GL mappings are effective-dated and non-overlapping.”).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Accounting → Configuration → Posting Setup**
  - Sub-screens:
    - **Posting Categories**
    - **Mapping Keys**
    - **GL Mappings**

### Screens to create/modify
Create a screen tree under Accounting configuration, following repo conventions (screen location and menu wiring must match existing Accounting patterns):

- `Accounting/Configuration/PostingSetup` (container)
  - `PostingCategoryList`
  - `PostingCategoryDetail`
  - `MappingKeyList`
  - `MappingKeyDetail`
  - `GlMappingList` (scoped to category)
  - `GlMappingCreate` (scoped to category)
  - (Optional) `ResolutionTest` (read-only; only if backend endpoint exists)

Moqui implementation expectations:
- Use Moqui `screen` with `transition` actions calling backend services.
- Use `form-single` for create/edit, `form-list` for lists/history.
- Use `parameter` + `transition` for `postingCategoryId`, `mappingKeyId`, `glMappingId` routing.
- Enforce permission gating at screen + action level (deny-by-default).

### Navigation context
- From **Posting Categories list** → **Category detail**:
  - view category fields + status
  - see linked mapping keys
  - see GL mapping history (effective ranges)
  - actions: edit (if allowed), deactivate, create new GL mapping

- From **Mapping Keys list** → **Key detail**:
  - view/edit key fields
  - link/unlink to a Posting Category (deterministic 1:1)
  - status and audit metadata

- From **GL Mappings**:
  - select a category (or navigate from category detail)
  - view history list
  - create new mapping version

### User workflows (happy + alternate)

#### Happy path: create category + mapping key + GL mapping
1. Create Posting Category (code + description) → saved ACTIVE.
2. Create Mapping Key (unique key string) → associate to category (many keys may point to one category; each key points to exactly one category).
3. Add GL Mapping for category: select GL account + dimensions (if any), set effective start (and optional end).
4. Verify mapping appears in history.

#### Alternate path: new mapping version for same category
1. On category detail, choose “New GL Mapping”.
2. Enter new effective start date (and optional end).
3. Save; backend rejects if overlap. UI surfaces conflict details.

#### Alternate path: deactivate category
1. Deactivate Posting Category.
2. UI prevents creating new GL mappings for INACTIVE category; if attempted, backend error surfaced.

#### Read-only path: auditor review
1. Auditor opens category detail.
2. Auditor can view mapping history and audit fields but cannot create/update/deactivate.

---

## 6. Functional Behavior

### Triggers
- User navigates to Posting Setup screens.
- User submits create/update/deactivate forms.
- User selects a category to view mappings and history.

### UI actions
- **List screens**:
  - server-side pagination and filtering
  - open detail
  - create new (if authorized)
- **Detail screens**:
  - edit allowed fields (depending on backend immutability policy)
  - deactivate (if authorized)
  - view linked keys and mapping history
- **GL mapping create**:
  - select GL account from CoA lookup
  - set effective dates
  - set dimensions (if backend supports; otherwise omit)

### State changes (frontend perspective)
- Posting Category: `ACTIVE` → `INACTIVE` via explicit deactivate action (no delete in UI)
- Mapping Key: active/inactive if modeled; otherwise association changes only (backend-owned)
- GL Mapping: creation of a new mapping record/version; prior mappings remain for history

### Service interactions
- On list load: call list services with `pageIndex`, `pageSize`, `orderBy`, filters.
- On detail load: call detail services by ID; then load related lists (keys, mappings).
- On submit:
  - create/update/deactivate services
  - handle validation errors (400/422), conflicts (409), unauthorized (401/403), not found (404)
- Overlap conflicts:
  - handle `409 Conflict` and display backend-provided conflicting mapping identifiers and date ranges (do not infer).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
**Posting Category**
- `categoryCode` required and unique.
- `description` required **unless backend contract marks optional** (treat as required in UI only if backend requires; otherwise allow empty and rely on backend validation).

**Mapping Key**
- `mappingKey` required and unique system-wide.
- Each mapping key must link to exactly one posting category (deterministic resolution).
- A posting category may have multiple mapping keys.

**GL Mapping**
- `postingCategoryId` required.
- `glAccountId` required and must exist in CoA.
- `effectiveStartDate` required.
- `effectiveEndDate` optional; if provided must be `>= effectiveStartDate`.
- Effective-dated ranges must not overlap for the same posting category (backend authoritative).
- Cannot create new mappings for an INACTIVE category.

### Enable/disable rules
- Deactivate Category button:
  - visible only with manage permission (TBD)
  - disabled if already INACTIVE
- Add/New GL Mapping:
  - visible only with manage permission (TBD)
  - disabled if category INACTIVE
- If backend enforces immutability-by-version:
  - editing existing GL mapping is not offered; only “Create new mapping” is offered.

### Visibility rules
- Category detail shows:
  - linked mapping keys list
  - GL mapping history list (effective start/end, GL account, dimensions, createdBy/createdAt)
- If backend returns overlap conflict details:
  - show inline under effective date fields and as a non-PII toast/banner.

### Error messaging expectations
- Uniqueness violation → “Already exists.”
- Overlap conflict (409) → “Effective dates overlap with an existing mapping.” Include backend-provided identifiers/dates.
- GL account not found → “Selected GL account is invalid; refresh and try again.”
- Unauthorized (401/403) → show access denied; hide write actions; do not reveal record existence.
- Not found (404) → “Not found.”

---

## 8. Data Requirements

> Field names below reflect story intent; actual entity/field names must match backend and Moqui entities/services.

### Entities involved (conceptual)
- `PostingCategory`
- `MappingKey`
- `GlMapping` (effective-dated)
- `GlAccount` (Chart of Accounts reference entity)
- Audit fields on each entity (created/updated metadata)

### Fields (frontend expectations)

#### PostingCategory
- `postingCategoryId` (UUIDv7) — read-only
- `categoryCode` (string) — required, unique
- `description` (string) — required/optional per backend contract
- `status` (`ACTIVE`/`INACTIVE`) — read-only except via deactivate action
- `createdAt`, `createdBy`, `updatedAt`, `updatedBy` — read-only

#### MappingKey
- `mappingKeyId` (UUIDv7) — read-only
- `mappingKey` (string) — required, unique
- `postingCategoryId` (UUIDv7) — required (deterministic 1:1 key→category)
- `status` (if present) — read-only except via deactivate action
- audit fields — read-only

#### GlMapping
- `glMappingId` (UUIDv7) — read-only
- `postingCategoryId` (UUIDv7) — required (scoped)
- `glAccountId` (UUIDv7 or code-based ID per CoA contract) — required
- `dimensions` — **unknown schema** (see Open Questions)
- `effectiveStartDate` (date) — required
- `effectiveEndDate` (date nullable) — optional
- audit fields — read-only

### Read-only vs editable by state/role
- Users without manage permission: all screens read-only; no create/edit/deactivate actions.
- Category and mapping key:
  - editable only if backend supports update; otherwise show read-only and require new record creation (TBD).
- GL mappings:
  - treated as append-only effective-dated records unless backend explicitly supports updates.

### Derived/calculated fields
- “Active on date” indicator for each GL mapping row (computed client-side for display only; not authoritative).

---

## 9. Service Contracts (Frontend Perspective)

> Backend service names/routes for this capability are not defined in the provided Accounting domain guide. Frontend must not invent endpoints. This story requires backend contract confirmation (see Open Questions).

### Load/view calls (required)
- List Posting Categories (paged, filterable)
- Get Posting Category detail by `postingCategoryId`
- List Mapping Keys (paged, filterable)
- Get Mapping Key detail by `mappingKeyId`
- List GL Mappings by `postingCategoryId` (history; paged)
- List/lookup GL Accounts for selection (paged/search)

### Create/update calls (required)
- Create Posting Category
- Update Posting Category (if supported) **or** create new version (if versioned)
- Deactivate Posting Category
- Create Mapping Key
- Update Mapping Key (if supported) and/or deactivate
- Create GL Mapping (new effective-dated record)

### Submit/transition calls
- Deactivate actions are explicit commands (no hard delete).

### Error handling expectations
- 400/422 validation errors:
  - map `details` to inline field errors when keys match field names
- 409 conflict:
  - show conflict banner and keep user inputs
  - if `details` includes conflicting mapping IDs/date ranges, display them
- 401/403:
  - show access denied; do not leak existence
- 404:
  - show not found; provide navigation back to list

---

## 10. State Model & Transitions

### Allowed states
- Posting Category: `ACTIVE`, `INACTIVE`
- Mapping Key: `ACTIVE`, `INACTIVE` (only if backend models; otherwise omit state UI)
- GL Mapping: no explicit state; effective dating defines applicability

### Role-based transitions
- Financial Controller (with manage permission):
  - create/update/deactivate categories
  - create/update/deactivate mapping keys
  - create GL mappings
- Auditor / read-only:
  - view only

### UI behavior per state
- INACTIVE category:
  - cannot add new GL mappings
  - cannot associate new mapping keys to it (UI prevents; backend enforces)
  - history remains visible

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required fields → inline errors; prevent submit.
- End date earlier than start date → inline error; prevent submit.

### Concurrency conflicts
- If backend uses optimistic locking:
  - on conflict, show “Changed by another user. Reload to continue.”
  - provide “Reload” action that refetches detail and related lists.

### Unauthorized access
- If user navigates directly to create/edit URLs without permission:
  - screen denies access (preferred) or renders read-only with no transitions
  - backend 403 handled without leaking record existence.

### Empty states
- No categories: show empty state + “Create Posting Category” if authorized.
- Category with no GL mappings: show “No mappings yet” + “Add Mapping” if authorized.
- No GL accounts returned: show error “No GL accounts available; check CoA setup.”

---

## 12. Acceptance Criteria

### Scenario 1: Create posting category
**Given** I am logged in as a Financial Controller with permission to manage posting configuration  
**When** I create a Posting Category with code `REVENUE_PARTS` and description `Revenue from Parts Sales`  
**Then** the category is saved with status `ACTIVE`  
**And** the category appears in the Posting Categories list

### Scenario 2: Prevent duplicate posting category codes
**Given** a Posting Category with code `REVENUE_PARTS` already exists  
**When** I attempt to create another Posting Category with code `REVENUE_PARTS`  
**Then** I see an error indicating the code must be unique  
**And** the duplicate category is not created

### Scenario 3: Create mapping key linked to a category
**Given** a Posting Category `REVENUE_PARTS` exists  
**When** I create a Mapping Key `pos.sale.item.parts.standard` linked to `REVENUE_PARTS`  
**Then** the mapping key is saved  
**And** the key is visible on the category detail screen

### Scenario 4: Prevent duplicate mapping keys
**Given** a Mapping Key `pos.sale.item.parts.standard` already exists  
**When** I attempt to create another Mapping Key with the same value  
**Then** I see an error indicating the mapping key must be unique  
**And** the duplicate key is not created

### Scenario 5: Create an effective-dated GL mapping
**Given** a Posting Category `REVENUE_PARTS` exists and is `ACTIVE`  
**And** a GL Account `40010` exists in the Chart of Accounts  
**When** I create a GL Mapping for `REVENUE_PARTS` to GL Account `40010` with effective start date `2026-02-01` and no end date  
**Then** the mapping is saved  
**And** it appears in the mapping history for `REVENUE_PARTS`

### Scenario 6: Reject overlapping effective dates
**Given** a GL Mapping exists for category `REVENUE_PARTS` effective `2026-02-01` through (no end date)  
**When** I attempt to create another GL Mapping for `REVENUE_PARTS` effective `2026-01-15` through `2026-03-01`  
**Then** the system rejects the save with a conflict error  
**And** I see a message identifying the conflicting mapping and overlapping date range

### Scenario 7: Block new mappings for inactive category
**Given** a Posting Category `REVENUE_PARTS` is `INACTIVE`  
**When** I view the category detail screen  
**Then** the “Add/New GL Mapping” action is disabled or hidden  
**And** if I attempt to submit a new mapping anyway  
**Then** I see an error indicating mappings cannot be created for inactive categories

### Scenario 8: Handle missing GL account
**Given** I am creating a GL Mapping and select a GL account that is no longer valid  
**When** I submit the mapping  
**Then** I see an error indicating the GL account is invalid or not found  
**And** the mapping is not created

### Scenario 9: Read-only access for auditors
**Given** I am logged in as a user without posting-configuration manage permission  
**When** I open a Posting Category detail screen  
**Then** I can view mapping history and audit fields  
**And** I do not see actions to create, edit, or deactivate categories, keys, or mappings

---

## 13. Audit & Observability

### User-visible audit data
- On detail screens show:
  - `createdBy`, `createdAt`
  - `updatedBy`, `updatedAt` (if present)
- For GL mapping history show `createdAt/createdBy` per mapping record.

### Status history
- If backend exposes audit events for config changes:
  - show a read-only “History” section (who/when/what changed)
- Otherwise:
  - show current status + audit fields only.

### Traceability expectations
- Each mapping record/version must be traceable by ID and effective date range.
- UI should display copyable identifiers (UUIDs) for support.

---

## 14. Non-Functional UI Requirements
- **Performance**: list screens use server-side pagination; first page loads within ~2s under normal conditions.
- **Accessibility**: labeled controls; keyboard navigation; inline errors announced via aria-live.
- **Responsiveness**: usable on tablet widths; forms stack vertically.
- **i18n/timezone/currency**:
  - Effective dates are date-only; display in user locale.
  - No currency handling required for this story.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty state components with primary CTA when lists are empty; qualifies as safe because it changes no domain behavior; impacts UX Summary, Alternate/Empty states.
- SD-UX-PAGINATION: Paginate list screens with default page size (e.g., 25) and server-side filtering where supported; safe because it only affects presentation/perf; impacts UX Summary, Service Contracts.
- SD-ERR-STANDARD-MAPPING: Map HTTP 400/401/403/404/409 to standard inline/toast handling consistent with app conventions; safe because it follows backend signals; impacts Service Contracts, Error Flows.

---

## 16. Open Questions
1. **Backend service contracts (blocking)**: What are the exact Moqui service names and/or REST endpoints (paths) for Posting Category, Mapping Key, and GL Mapping list/detail/create/update/deactivate, plus GL Account lookup? Provide request/response field names and error shapes (including 409 overlap details).  
2. **Permissions (blocking)**: What are the exact permission tokens for:
   - viewing posting configuration screens (read-only)
   - managing posting configuration (create/update/deactivate)
   - auditor read-only access (if distinct)  
   (Accounting domain guide defines permissions for exports/payments/refunds/ingestion/apply-payment, but not for posting configuration.)  
3. **Dimensions schema (blocking)**: What is the authoritative list and data types for GL mapping “dimensions” (e.g., businessUnitId, locationId, departmentId, costCenterId), and are they required/optional per posting category? Are they references to entities (with lookups) or freeform strings/enums?  
4. **Immutability/versioning policy (blocking)**: Are Posting Categories and Mapping Keys editable in place, or append-only/versioned? Are GL mappings strictly append-only (create new effective-dated rows only), and are existing rows ever editable?  
5. **Overlap handling policy (non-blocking if backend rejects overlaps)**: Confirm that overlap is always rejected (409) and that the system will not auto-end-date prior mappings. If auto-end-dating exists, specify the exact behavior and UI requirements.  
6. **Resolution test endpoint (non-blocking)**: Is there a supported backend endpoint to resolve `mappingKey + transactionDate → postingCategory + glAccount + dimensions` for validation/testing? If yes, provide contract and permissions so the optional “Resolution Test” screen can be implemented.

════════════════════════════════════════
ISSUE #202: [FRONTEND] [STORY] Mapping: Configure EventType → Posting Rule Set
LABELS: domain:accounting,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:accounting-domain-agent
BODY:
## 1. Story Header

**Title**: [FRONTEND] [STORY] Mapping: Configure EventType → Posting Rule Set

**Primary Persona**: Financial Controller / System Administrator

**Business Value**: Enables controlled, auditable configuration of versioned posting rules that deterministically generate balanced journal entries and provide traceability (journal entry → ruleset + version), reducing accounting errors and audit risk.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Financial Controller or System Administrator  
- **I want** to create, version, validate, publish, and archive Posting Rule Sets that map a business `EventType` to accounting postings (with conditional logic)  
- **So that** journal entry generation is balanced, deterministic, and traceable to the exact rule version used.

### In-scope
- Frontend screens to:
  - List Posting Rule Sets and versions
  - View a Posting Rule Set (including version, status, eventType, rules definition)
  - Create a new Posting Rule Set (version 1)
  - Create a new version from an existing rule set/version
  - Publish a DRAFT version (only if it balances / passes server validation)
  - Archive a version (per backend policy)
- Validation UX:
  - Show server-side validation results (including “unbalanced” details)
  - Prevent publish action when backend reports imbalance/invalid references
- Traceability UX (read-only):
  - Display `postingRuleSetId` + `version` metadata clearly on detail views

### Out-of-scope
- Designing the internal semantics of debit/credit mappings (owned by backend rules engine)
- Creating or managing Chart of Accounts, Posting Categories, GL mappings (separate stories)
- Event ingestion processing UI, journal entry creation UI
- Defining or inventing `EventType` values (must come from upstream/canonical list)

---

## 3. Actors & Stakeholders

- **Primary actor:** Financial Controller / System Administrator
- **Stakeholders:**
  - Accounting operations team (needs safe configuration + auditability)
  - Auditors/Compliance (needs immutable version history + traceability)
  - Developers/Integrators (need predictable `EventType` mapping behavior)
- **Systems:**
  - Moqui frontend (this story)
  - Accounting backend service(s) exposing Posting Rule Set APIs (authoritative)

---

## 4. Preconditions & Dependencies

- User is authenticated in the POS admin UI.
- User has required permissions to manage accounting configuration (**blocking**: permission tokens for this capability are not defined in Accounting domain guide; see Open Questions).
- Backend endpoints exist for:
  - Listing rule sets and versions
  - Viewing a rule set/version
  - Creating rule set and new versions
  - Publishing and archiving
  - Validation errors returned with actionable codes/messages
- Backend provides a source of valid/recognized `EventType` values (**blocking**: endpoint not defined in Accounting domain guide; see Open Questions).
- Backend validates referenced GL accounts and rule balancing and returns structured validation failures.
- Identifiers are UUIDv7 (client-side validation required) (**Decision AD-006**).
- Error response schema follows `{ errorCode, message, details? }` with optional per-field/per-row errors (**Decision AD-013**, error schema guidance in provided rules).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Admin navigation: **Accounting → Posting Rules → Posting Rule Sets**

### Screens to create/modify
1. **Screen:** `apps/accounting/postingRuleSet/List.xml`
   - List/search table of Posting Rule Sets (latest version summary at minimum)
2. **Screen:** `apps/accounting/postingRuleSet/Detail.xml`
   - Detail view of a specific `postingRuleSetId`
   - Versions subview (list of versions with status)
3. **Screen:** `apps/accounting/postingRuleSet/VersionDetail.xml`
   - Read-only view of a specific version (including `rulesDefinition`, validation results from last publish attempt if provided)
4. **Screen:** `apps/accounting/postingRuleSet/VersionEdit.xml`
   - Create version 1 (new rule set) or create new version from an existing one (always creates/edits a DRAFT version)
5. **Dialog/Screen section:** Publish confirmation + results display (transition returning validation result)
6. **Dialog/Screen section:** Archive confirmation

> Note: Screen paths are proposed to match typical Moqui app structure; adjust to repo conventions if different, but keep under `apps/accounting/...`.

### Navigation context
- From list → select rule set → detail
- From detail → select version → version detail
- From version detail → “Create New Version” (clone) → version edit → save as DRAFT
- From DRAFT version detail/edit → “Publish” (runs backend validation; if fails, remain DRAFT and show errors)
- From PUBLISHED version detail → “Archive” (if allowed)

### User workflows (happy + alternate)
- **Happy path: create & publish**
  1. User opens Posting Rule Set list
  2. Clicks “New Posting Rule Set”
  3. Selects `EventType`, defines rules definition, saves as DRAFT (version 1)
  4. Clicks Publish → backend validates balance and references → success → status becomes PUBLISHED
- **Alternate path: create new version**
  1. User opens existing ruleset detail
  2. Chooses a PUBLISHED version → “Create New Version”
  3. Edits rules; saves as DRAFT version N+1
  4. Publishes after backend validation
- **Error path: unbalanced / invalid references**
  - Publish returns validation error describing imbalance and/or failing references; UI shows errors and blocks publish.

---

## 6. Functional Behavior

### Triggers
- User navigates to Posting Rule Set configuration screens
- User submits create/update version form
- User triggers publish or archive actions

### UI actions

#### List screen
- Filter/search (server-side) by:
  - `eventType` (exact match or contains; backend-defined)
  - `latestStatus` (DRAFT/PUBLISHED/ARCHIVED if backend provides)
  - `updatedAt` date range (optional)
- Pagination and sorting (server-side): `pageIndex`, `pageSize`, `orderBy`
- Navigate to rule set detail

#### Detail screen
- View rule set metadata:
  - `postingRuleSetId` (copyable)
  - `eventType` (display)
- View versions table:
  - `version`, `status`, `createdAt`, `createdBy`
  - Row action: “View”
- Actions:
  - “Create New Version” (requires selecting a base version; defaults to latest PUBLISHED if present, else latest version)

#### Version edit screen (DRAFT only)
- Supports two entry modes:
  - **Create new rule set (version 1)**: requires selecting `eventType` + entering `rulesDefinition`
  - **Create new version from base**: pre-fills `rulesDefinition` from base version; `eventType` is read-only (inherits from rule set)
- Save:
  - Creates a new DRAFT version record (never edits an existing PUBLISHED/ARCHIVED version)
  - On success, route to VersionDetail for the created version

#### Version detail screen
- Displays:
  - `postingRuleSetId`, `eventType`, `version`, `status`
  - `rulesDefinition` (read-only unless status is DRAFT and user has edit permission; see Open Questions)
  - Audit metadata (`createdAt/By`, `updatedAt/By`)
- Actions (visibility depends on status + permissions):
  - If `status=DRAFT`: “Edit” (if supported), “Publish”
  - If `status=PUBLISHED`: “Create New Version”, “Archive”
  - If `status=ARCHIVED`: “Create New Version” (policy TBD; see Open Questions)

#### Publish action
- Confirmation prompt includes:
  - `postingRuleSetId`, `version`, `eventType`
- Calls publish endpoint/service
- On success:
  - Status becomes `PUBLISHED`
  - UI disables editing for that version
- On failure:
  - Remains `DRAFT`
  - UI renders backend validation errors (including imbalance details) without reinterpretation

#### Archive action
- Confirmation prompt includes:
  - `postingRuleSetId`, `version`, `eventType`
- Calls archive endpoint/service
- On success:
  - Status becomes `ARCHIVED`
  - UI disables publish/edit actions for that version

### State changes (frontend reflects backend state)
- DRAFT → PUBLISHED (publish)
- PUBLISHED → ARCHIVED (archive)
- Any “edit” operation results in **new version** (immutability enforced by backend); frontend must not attempt in-place update of a published/used version.

### Service interactions
- Load list/detail/version data from backend via Moqui service calls (REST or service facade)
- Submit create/version/publish/archive actions to backend
- Display backend validation results and error codes

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `eventType` is required when creating a new rule set (version 1).
- `rulesDefinition` is required.
- If `rulesDefinition` is entered as JSON text, UI must validate it is syntactically valid JSON before submit.
- Publishing is blocked if backend validation fails, including (non-exhaustive):
  - Unbalanced debits/credits for any supported condition
  - Invalid GL account references
  - Unknown/invalid `EventType`
- UI must display backend error code(s) and messages in a user-actionable manner and must not invent additional meanings.

### Enable/disable rules
- If version `status=PUBLISHED` or `ARCHIVED`, editing fields are disabled (read-only).
- “Publish” is visible/enabled only for `status=DRAFT` and only when user has publish permission (permission token TBD).
- “Archive” is visible/enabled only for `status=PUBLISHED` and only when user has archive permission (permission token TBD).
- “Create New Version” is enabled when user has create/upversion permission (permission token TBD). Base version selection is required; default selection is latest PUBLISHED if present.

### Visibility rules
- Always show `postingRuleSetId` and `version` prominently on version detail.
- Show status badge for each version (DRAFT/PUBLISHED/ARCHIVED).
- If backend returns validation detail payload on publish failure, show it in a dedicated “Validation Results” section; do not show raw payloads beyond what backend returns.

### Error messaging expectations
- For publish failures, show:
  - Summary: “Publish blocked: rule set failed validation”
  - Detail list including backend-provided reasons (e.g., imbalance per condition)
- For unknown `EventType`, show: “Select a recognized EventType.”

---

## 8. Data Requirements

### Entities involved (frontend view models; backend-owned)
- `PostingRuleSet` (rule set identity + eventType)
- `PostingRuleSetVersion` (versioned configuration)
- (Reference) `EventType` catalog/list (source-of-truth upstream/back-end exposed)

### Fields (type, required, defaults)

**PostingRuleSet (logical)**
- `postingRuleSetId` (UUIDv7, read-only)
- `eventType` (string, required)
  - UI behavior: editable only when creating a new rule set; read-only for subsequent versions (assumption aligns with “rule set maps EventType → ruleset”; **blocking** if backend allows changing eventType per version)

**PostingRuleSetVersion**
- `postingRuleSetId` (UUIDv7, required, read-only)
- `version` (int, required, read-only)
- `status` (`DRAFT|PUBLISHED|ARCHIVED`, required, read-only except via actions)
- `rulesDefinition` (JSON, required; editable only for DRAFT)
- `createdAt` (datetime, read-only)
- `createdBy` (string/userId, read-only)
- `updatedAt` (datetime, read-only)
- `updatedBy` (string/userId, read-only)

**Validation result (publish attempt)**
- `errorCode` (string, read-only)
- `message` (string, read-only)
- `details` (object, read-only; may include per-condition/per-rule info)

### Read-only vs editable by state/role
- **DRAFT**: editable `rulesDefinition`; `eventType` editable only for version 1 creation
- **PUBLISHED/ARCHIVED**: all fields read-only; only “Create New Version” allowed
- Role-based enforcement must also be performed by backend; frontend should hide/disable actions when unauthorized and handle 403 safely.

### Derived/calculated fields
- “Latest version” displayed in list view:
  - Prefer backend-provided `latestVersion` and `latestStatus` for performance (**blocking** if not available; see Open Questions)
- Validation result details displayed after publish attempt (from backend response)

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract for Posting Rule Set APIs is not defined in the provided Accounting domain guide. Until confirmed, this story is blocked. The frontend must not invent schemas or endpoints.

### Load/view calls (required)
- **List rule sets**
  - Proposed: `GET /accounting/postingRuleSets/list`
  - Request: `pageIndex`, `pageSize`, `orderBy`, optional filters (`eventType`, `status`, `updatedFrom`, `updatedThru`)
  - Response: list of rule sets with latest version summary (preferred) or versions count
- **Get rule set detail**
  - Proposed: `GET /accounting/postingRuleSets/detail?postingRuleSetId=...`
  - Response: rule set + versions list
- **Get version detail**
  - Proposed: `GET /accounting/postingRuleSets/versionDetail?postingRuleSetId=...&version=...`
  - Response: version record including `rulesDefinition`

- **List recognized EventTypes**
  - Proposed: `GET /accounting/eventTypes/list`
  - Response: array of `{ eventType, description?, schemaVersion? }`

### Create/update calls (required)
- **Create new rule set (version 1, DRAFT)**
  - Proposed: `POST /accounting/postingRuleSets/create`
  - Body: `{ eventType, rulesDefinition }`
  - Response: `{ postingRuleSetId, version: 1, status: "DRAFT" }`
- **Create new version (clone + edit)**
  - Proposed: `POST /accounting/postingRuleSets/createVersion`
  - Body: `{ postingRuleSetId, baseVersion, rulesDefinition }`
  - Response: `{ postingRuleSetId, version, status: "DRAFT" }`

### Submit/transition calls (required)
- **Publish version**
  - Proposed: `POST /accounting/postingRuleSets/publish`
  - Body: `{ postingRuleSetId, version }`
  - Success response: updated version with `status=PUBLISHED`
  - Failure response: `400/422` with `{ errorCode, message, details }` including imbalance details
- **Archive version**
  - Proposed: `POST /accounting/postingRuleSets/archive`
  - Body: `{ postingRuleSetId, version }`
  - Response: updated version with `status=ARCHIVED`

### Error handling expectations
- Map HTTP errors to UI:
  - `400/422` validation: show field/summary errors (do not retry automatically)
  - `401/403`: show “Not authorized” and disable actions; do not reveal record existence beyond safe messaging (**Decision AD-013**)
  - `404`: show “Not found” and return to list
  - `409`: show conflict (e.g., publishing non-DRAFT, concurrent version creation); prompt reload
  - `5xx/timeout`: show generic error; allow retry; preserve user inputs/filters
- Correlation/tracing:
  - Propagate `traceparent`/`tracestate` headers on all calls (**Decision AD-008**)

---

## 10. State Model & Transitions

### Allowed states (version status)
- `DRAFT`
- `PUBLISHED`
- `ARCHIVED`

### Role-based transitions
- Users with posting-rule management permissions can:
  - Create DRAFT versions
  - Publish DRAFT → PUBLISHED
  - Archive PUBLISHED → ARCHIVED
- Users without permission:
  - Read-only access if they have view permission; otherwise no access (permission tokens **blocking**)

### UI behavior per state
- **DRAFT**: editable rules; show “Publish” primary action
- **PUBLISHED**: read-only; show “Create New Version” action; show “Archive” secondary action
- **ARCHIVED**: read-only; hide publish/archive; “Create New Version” allowed only if backend policy allows (**blocking**)

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid JSON in rulesDefinition:
  - Block save client-side with inline error “Invalid JSON”
- Backend validation on publish:
  - Show list of failing conditions and debit/credit totals (as provided)
  - Keep version as DRAFT
  - Do not silently modify rulesDefinition

### Concurrency conflicts
- If another user creates a newer version while current user is editing:
  - Save attempt may return `409`
  - UI prompts to reload versions list and rebase by creating a new version from latest (requires backend semantics; **blocking**)

### Unauthorized access
- If user lacks permission:
  - Hide “New”, “Publish”, “Archive”, “Create New Version” actions
  - If direct URL access attempted, show safe “Not authorized” and route to list/unauthorized screen

### Empty states
- No rule sets exist:
  - Show empty state with “Create Posting Rule Set”
- No EventTypes returned:
  - Show message: “No EventTypes available. Check integration configuration.”

---

## 12. Acceptance Criteria

### Scenario 1: List posting rule sets
**Given** I am an authenticated user with permission to view posting rule sets  
**When** I navigate to Accounting → Posting Rules → Posting Rule Sets  
**Then** I see a paginated list of existing posting rule sets  
**And** each row shows at least `eventType`, `postingRuleSetId`, and latest version `status`

### Scenario 2: Create a new rule set as DRAFT
**Given** I have permission to manage posting rule sets  
**And** the system provides a list of recognized `EventType` values  
**When** I create a new posting rule set with a selected `eventType` and a valid `rulesDefinition`  
**Then** the system creates version `1` with `status=DRAFT`  
**And** I can view the new rule set version detail showing `postingRuleSetId` and `version=1`

### Scenario 3: Publish a balanced DRAFT version
**Given** a posting rule set version exists with `status=DRAFT`  
**When** I click “Publish” and confirm  
**Then** the frontend calls the publish service for that `postingRuleSetId` and `version`  
**And** on success the version status updates to `PUBLISHED`  
**And** the UI disables editing for that published version

### Scenario 4: Reject publish for unbalanced rules
**Given** a posting rule set version exists with `status=DRAFT`  
**And** its rules are unbalanced for at least one supported condition  
**When** I click “Publish”  
**Then** the system responds with a validation failure (HTTP 400/422)  
**And** the UI shows an error summary and the backend-provided imbalance details  
**And** the version remains `DRAFT` and editable

### Scenario 5: Create a new version from an existing rule set
**Given** a posting rule set exists with a `PUBLISHED` version `N`  
**When** I choose “Create New Version” from version `N` and save changes  
**Then** the system creates a new version `N+1` with `status=DRAFT`  
**And** version `N` remains unchanged and read-only

### Scenario 6: Unauthorized user cannot publish
**Given** I am authenticated but do not have permission to publish posting rule sets  
**When** I view a DRAFT posting rule set version  
**Then** I do not see an enabled “Publish” action  
**And** if I attempt to publish via direct URL/action, I receive a not-authorized error and no state changes occur

### Scenario 7: UUIDv7 validation blocks invalid IDs in routes/filters
**Given** I am on the Posting Rule Set detail screen  
**When** I enter an invalid UUID into a `postingRuleSetId` filter or attempt to navigate to a URL with an invalid UUID  
**Then** the UI blocks the action with an inline “Invalid ID format” message  
**And** no backend request is sent for that invalid ID

---

## 13. Audit & Observability

### User-visible audit data
- On version detail, display:
  - `createdAt`, `createdBy`, `updatedAt`, `updatedBy`
  - Status and status change timestamps if provided by backend

### Status history
- Show a version list with status and created timestamp.
- If backend provides audit events, provide a collapsible “Audit” section per version (actor, action: created/published/archived, timestamp, correlation id).

### Traceability expectations
- UI must always present `postingRuleSetId` + `version` for any view of rulesDefinition.
- Any publish/archive action should include trace context headers (**Decision AD-008**) and should surface a support-friendly identifier if backend returns one (e.g., requestId/correlationId).

---

## 14. Non-Functional UI Requirements

- **Performance:** List view should load within 2s for up to 50 rows/page (assuming normal network); support server-side pagination.
- **Accessibility:** All actions keyboard-navigable; validation messages associated to inputs; status conveyed not by color alone.
- **Responsiveness:** Works on tablet width; tables horizontally scroll or collapse columns.
- **i18n/timezone:** Display timestamps in user locale/timezone (from session settings).
- **Security:** Do not log `rulesDefinition` content or backend validation detail payloads if they may contain sensitive configuration; log only identifiers and error codes. Deny-by-default for unknown permissions (**Decision AD-013**).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a standard empty state with a primary CTA (“Create Posting Rule Set”) because it is UI ergonomics and does not change domain logic. (Impacted: UX Summary, Alternate/Error Flows)
- SD-UX-PAGINATION: Use server-side pagination with default page size 25 and user-selectable 25/50/100 because it is standard UI ergonomics. (Impacted: UX Summary, Service Contracts)
- SD-ERR-HTTP-MAP: Map HTTP 400/401/403/404/409/5xx to standard notifications + inline form errors where applicable because it’s standard error-handling behavior implied by backend contracts. (Impacted: Service Contracts, Alternate/Error Flows)
- SD-OBS-CORRELATION: Propagate W3C trace headers and display a correlation/request id when provided because it is observability boilerplate and does not alter business behavior. (Impacted: Audit & Observability, Service Contracts)

---

## 16. Open Questions

1. **Backend endpoint family for Posting Rule Sets (blocking):** What are the exact REST endpoints and request/response schemas for list/detail/versionDetail/create/createVersion/publish/archive? The Accounting domain guide defines endpoint families for exports/payments/refunds/ingestion, but not posting rule sets.  
2. **Permissions (blocking):** What are the exact permission tokens for:
   - viewing posting rule sets
   - creating/upversioning
   - publishing
   - archiving  
   (Accounting domain guide provides permissions for other capabilities only; do not invent new tokens.)  
3. **EventType source (blocking):** What is the authoritative endpoint/service to retrieve recognized `EventType` values (and optional descriptions/schema versions)? Is it shared with ingestion event types or a separate catalog?  
4. **Rules editor format & schema (blocking):** Is `rulesDefinition` edited as raw JSON only, or is there a structured editor? Provide the JSON schema (or a link) so the UI can validate and render meaningful errors without guessing.  
5. **Version creation semantics (blocking):** When creating a new version, does the API require `baseVersion` explicitly, or does it auto-increment from latest? What is the expected 409 conflict behavior for concurrent version creation (errorCode/details shape)?  
6. **Archiving policy (blocking):** Are archived versions eligible as a base for “Create New Version”? Is un-archive allowed? Is archiving restricted to PUBLISHED only?  
7. **List view optimization (non-blocking but high impact):** Does backend provide a flattened “latest version summary” per rule set, or must frontend fetch versions per rule set? If not provided, confirm acceptable performance approach.  
8. **Validation detail payload shape (blocking):** For unbalanced rule sets, what exact structure is returned in `details` (e.g., per condition: debitTotal, creditTotal, failing rule IDs)? Provide a sample error response for UI rendering.

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] Mapping: Configure EventType → Posting Rule Set  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/202  
Labels: frontend, story-implementation, inventory

## Frontend Implementation for Story

**Original Story**: [STORY] Mapping: Configure EventType → Posting Rule Set

**Domain**: inventory

### Story Description

/kiro  
# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## Capability
[CAP] Maintain Chart of Accounts and Posting Categories

## Story
Mapping: Configure EventType → Posting Rule Set

## Acceptance Criteria
- [ ] Posting rules are versioned and referenced on every journal entry
- [ ] Rules produce balanced debit/credit outputs for representative test fixtures
- [ ] Rules support conditional logic (taxable/non-taxable, inventory/non-inventory)
- [ ] Publishing rules that don’t balance is blocked

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

════════════════════════════════════════
ISSUE #201: [FRONTEND] [STORY] GL: Build Balanced Journal Entry from Event
LABELS: domain:accounting,frontend,story-implementation,general,type:story,status:draft,blocked:clarification,risk:incomplete-requirements
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] GL: Build Balanced Journal Entry from Event (Draft JE creation & review UI)

### Primary Persona
Accountant / GL Specialist (back-office user) who monitors and reviews draft Journal Entries generated from source events.

### Business Value
Provide an auditable, UI-accessible representation of automatically generated draft Journal Entries (JEs) created from domain events, enabling review/troubleshooting and ensuring only balanced, traceable entries proceed toward posting workflows.

---

## 2. Story Intent

### As a / I want / So that
- **As a** GL Specialist  
- **I want** to view the draft Journal Entry created from a source event, including header traceability (eventId/source refs/rule version) and balanced lines per currency  
- **So that** I can verify correctness, investigate mapping failures, and support downstream posting controls without needing database access.

### In-scope
- Moqui screen(s) to:
  - Search/list draft Journal Entries and open a JE detail view
  - View JE header traceability fields (event references, mapping rule version)
  - View JE lines including account/category/dimensions and debit/credit amounts
  - Display balance status **per currency** (balanced vs not balanced) as a computed UI check
- Error/empty states for missing data, unauthorized access, and load failures
- Basic navigation entry points from an Accounting/GL menu

### Out-of-scope
- Creating JEs from events in the frontend (event consumption/transformation is backend-owned)
- Editing JE lines or headers (draft generation is automated; story does not define manual correction)
- Posting JEs to the ledger (separate capability/story)
- Defining/maintaining mapping rules, suspense policies, or chart of accounts data management (separate stories)

---

## 3. Actors & Stakeholders
- **Primary user:** Accountant / GL Specialist
- **Secondary stakeholders:**
  - Auditor (needs traceability and immutable history visibility)
  - System Admin (triages mapping/rule issues)
  - Upstream domain owners (Billing, POS, Work Execution) as event producers

---

## 4. Preconditions & Dependencies
- Backend provides persisted draft Journal Entries generated from events, including:
  - Header refs: `eventId`, `sourceModule/sourceSystem`, `sourceEntityRef`, `mappingRuleVersionId` (or equivalent)
  - Lines with: account references, category references, dimension references, debit/credit amounts, currency
- Backend provides an API/service to:
  - List/search JEs
  - Load JE detail with lines
- Authorization permissions exist for viewing accounting/GL journal entries.

**Dependency note (blocking):** The frontend cannot be fully buildable until service names/endpoints, entity names, and permission strings are confirmed (see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main menu: **Accounting → General Ledger → Journal Entries**
- Optional deep link: `/accounting/gl/journal-entry/<journalEntryId>` (exact path TBD per repo conventions)

### Screens to create/modify
1. **Screen: `Accounting/GL/JournalEntryList`**
   - Search/list journal entries (default filter Draft)
2. **Screen: `Accounting/GL/JournalEntryDetail`**
   - Read-only header + lines
   - Balance-by-currency summary panel
3. (Optional) **Screen: `Accounting/GL/EventProcessingFailures`** (only if backend exposes failure records; otherwise out-of-scope)

### Navigation context
- From list → click JE row → detail
- From detail → back to list (preserving prior filters in parameters where possible)

### User workflows
#### Happy path
1. User opens Journal Entry list
2. User filters by status = Draft, date range, source module, eventId
3. User opens a JE
4. User reviews header traceability + mapping rule version
5. User reviews lines and confirms balanced per currency (UI computed check matches backend indicator if present)

#### Alternate paths
- User searches by `eventId`; no results → empty state explaining no JE found for that event
- User opens JE detail but lacks permission → access denied screen/message
- JE loads but lines missing/invalid → show data integrity warning banner and allow copy of identifiers for support

---

## 6. Functional Behavior

### Triggers
- User navigates to JE list or JE detail screens.

### UI actions
- List screen:
  - Apply filters (status, date range, eventId, source system/module, currency)
  - Open JE detail
- Detail screen:
  - View header fields
  - View lines table
  - View balance summary per currency
  - Copy key identifiers (journalEntryId, eventId, mappingRuleVersionId) to clipboard (UI-only convenience)

### State changes
- None (read-only in this story). No transitions or edits.

### Service interactions
- `searchJournalEntries` (list)
- `getJournalEntryDetail` (header + lines)
- (Optional) `getJournalEntryAuditTrail` if backend exposes JE audit events

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Filters:
  - `eventId` input must be a valid UUID format if provided; otherwise show inline validation error and do not submit search.
  - Date range must have `from <= to` else inline error.
- JE detail display:
  - If JE has multiple currencies, compute balancing per currency group and display per currency totals.
  - If any currency group is not balanced, show **prominent warning**: “Not balanced for currency <CUR>: debits X != credits Y”. (This should be possible only if backend allowed it; still display defensively.)

### Enable/disable rules
- “View detail” action disabled until a row is selected (if using selection model) or always enabled via row click.
- Any “Post”, “Edit”, “Rebuild” buttons **must not** be present unless explicitly required by a future story.

### Visibility rules
- Show mapping rule version only if present; if absent, show “Not available” and a warning badge “Missing mapping reference”.

### Error messaging expectations
- Map backend errors to user-facing messages:
  - 401/403: “You don’t have access to General Ledger journal entries.”
  - 404 on detail: “Journal Entry not found (may have been deleted or you may not have access).”
  - 409/422: show backend-provided error code + message (sanitized) and include IDs for support.

---

## 8. Data Requirements

### Entities involved (conceptual; exact Moqui entity names TBD)
- `JournalEntry` (header)
- `JournalEntryLine` (lines)
- (Optional) `PostingRuleSetVersion` or `MappingRuleVersion`
- (Optional) `GLAccount`, `PostingCategory`, `Dimension` references for display names

### Fields (type, required, defaults)
**JournalEntry (Header)**
- `journalEntryId` (string/UUID, required, read-only)
- `status` (enum: at least `Draft`; required, read-only)
- `transactionDate` (date/datetime, required, read-only)
- `sourceEventId` / `eventId` (UUID, required, read-only)
- `sourceModule` or `sourceSystem` (string, required, read-only)
- `sourceEntityRef` (string, required, read-only)
- `schemaVersion` (string, optional, read-only) — if stored
- `mappingRuleVersionId` (string/UUID, required for traceability; if missing, UI flags)
- `businessUnitId` (string/UUID, optional; display if available)
- `currencyUomId` (string; optional if multi-currency at line level)

**JournalEntryLine**
- `journalEntryLineId` (string/UUID, required)
- `lineNumber` (int, optional but preferred for stable ordering)
- `postingCategoryId` / `glCategoryId` (string/UUID, required)
- `glAccountId` (string/UUID, required)
- `dimensions` (object or separate fields; optional but may be required by rule)
  - examples: `locationId`, `departmentId`, `customerId`, etc. (do not invent which ones are required)
- `currencyUomId` (string, required)
- `debitAmount` (decimal, nullable)
- `creditAmount` (decimal, nullable)
  - Exactly one of debit/credit should be non-zero per line (if backend supports); UI displays both columns.
- `memo/description` (string, optional)

### Read-only vs editable by state/role
- All fields are read-only for all roles in this story.

### Derived/calculated fields (frontend)
- For each `currencyUomId`:
  - `totalDebits = sum(debitAmount)`
  - `totalCredits = sum(creditAmount)`
  - `isBalanced = (totalDebits == totalCredits)` using currency-scale comparison (see Open Question about rounding/scale in UI)

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking:** Actual Moqui service names, parameters, and response structures must be confirmed.

### Load/view calls
1. **List/search**
   - Service: `AccountingServices.searchJournalEntries` (placeholder)
   - Inputs (query params):
     - `status` (default `Draft`)
     - `fromDate`, `toDate`
     - `eventId`
     - `sourceModule`
     - `currencyUomId`
     - pagination: `pageIndex`, `pageSize`
     - sorting: `orderBy` (default newest first by transactionDate/createdAt)
   - Output:
     - array of JE headers + `totalCount`

2. **Detail**
   - Service: `AccountingServices.getJournalEntry` (placeholder)
   - Input: `journalEntryId`
   - Output:
     - header
     - lines[]
     - (optional) computed backend balance status per currency (if provided)

### Create/update calls
- None.

### Submit/transition calls
- None.

### Error handling expectations
- Standard Moqui service error structure surfaced to UI with:
  - `errorCode` (preferred)
  - `message`
  - field errors (for filter validation if backend validates)
- For list/detail failures, UI must show a retry action.

---

## 10. State Model & Transitions

### Allowed states
- `Draft` (required for this story)
- `Posted`, `Cancelled` may exist but are view-only if returned.

### Role-based transitions
- None in this story.

### UI behavior per state
- Draft: normal view
- Posted/Cancelled (if shown in list/detail): show status badge; still read-only.

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid `eventId` format on list filter → inline error; do not call backend.
- Invalid date range → inline error; do not call backend.

### Concurrency conflicts
- If JE disappears between list and detail:
  - Detail load returns 404 → show not found message and link back to list.

### Unauthorized access
- 403 on list or detail:
  - Show access denied page; do not reveal existence of specific JE IDs beyond user-provided input.

### Empty states
- No JEs match filters:
  - Show “No journal entries found” with suggestions (clear filters, search by eventId).

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View draft journal entries list with default Draft filter
**Given** the user has permission to view GL journal entries  
**When** the user navigates to Accounting → General Ledger → Journal Entries  
**Then** the system displays a list of journal entries filtered to status “Draft” by default  
**And** each row shows at minimum journalEntryId, transactionDate, status, sourceEventId/eventId, and sourceModule/sourceSystem  
**And** the user can open a journal entry detail from the list.

### Scenario 2: Search journal entries by eventId
**Given** the user is on the Journal Entries list screen  
**When** the user enters a valid UUID into the Event ID filter and submits  
**Then** the system requests results filtered by that eventId  
**And** if a matching journal entry exists it is shown in the results  
**And** if no matching journal entry exists the UI shows an empty state indicating no results.

### Scenario 3: Prevent search with invalid eventId
**Given** the user is on the Journal Entries list screen  
**When** the user enters an invalid Event ID value (not a UUID) and submits  
**Then** the UI shows an inline validation error for Event ID  
**And** no backend search request is sent.

### Scenario 4: View journal entry detail with traceability header fields
**Given** a draft Journal Entry exists  
**And** the user has permission to view it  
**When** the user opens the Journal Entry detail screen  
**Then** the UI displays the JE header including sourceEventId/eventId, sourceEntityRef, sourceModule/sourceSystem, transactionDate, status, and mappingRuleVersionId  
**And** the UI displays all journal entry lines with debit and credit columns, currency, glAccount reference, posting category reference, and dimension references (if present).

### Scenario 5: Balance check is shown per currency
**Given** a journal entry detail is displayed with lines in one or more currencies  
**When** the UI computes totals grouped by currency  
**Then** the UI shows total debits and total credits for each currency  
**And** for each currency where totals are equal the UI indicates “Balanced”  
**And** for each currency where totals are not equal the UI indicates “Not balanced” and shows the mismatch values.

### Scenario 6: Unauthorized user cannot access journal entries
**Given** the user does not have permission to view GL journal entries  
**When** the user navigates to the Journal Entries list or opens a JE detail URL directly  
**Then** the system shows an access denied message  
**And** does not display journal entry header or line data.

### Scenario 7: Journal entry not found
**Given** the user has permission to view GL journal entries  
**When** the user opens a journalEntryId that does not exist (or is not accessible)  
**Then** the system shows “Journal Entry not found”  
**And** provides a link back to the Journal Entries list.

---

## 13. Audit & Observability

### User-visible audit data
- Display immutable identifiers for traceability:
  - `journalEntryId`, `sourceEventId/eventId`, `mappingRuleVersionId`, `sourceModule/sourceSystem`, `sourceEntityRef`
- If backend supports, show:
  - created timestamp and createdBy (read-only)
  - processing status / last processed timestamp (if JE is tied to event ingestion pipeline)

### Status history
- Not required unless backend already provides status history; if available, render a read-only timeline component.

### Traceability expectations
- Provide “Copy identifiers” action to copy a block containing:
  - journalEntryId
  - eventId
  - mappingRuleVersionId
  - sourceModule
  - transactionDate

---

## 14. Non-Functional UI Requirements
- **Performance:** List screen should load first page within 2s under normal conditions; show loading states.
- **Accessibility:** All tables and badges must be keyboard navigable; status conveyed with text (not color only).
- **Responsiveness:** List and detail usable on tablet widths; lines table supports horizontal scroll.
- **i18n/timezone/currency:**
  - Dates displayed in user locale/timezone.
  - Currency amounts formatted with currency code; do not assume symbol-only.
  - No multi-currency conversion performed in UI.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty state messaging and “Clear filters” action; safe because it does not change domain behavior. (Impacted: UX Summary, Alternate/Empty states)
- SD-UX-PAGINATION: Paginate list results with page size default (e.g., 25) and server-side pagination parameters; safe because it is a UI ergonomics concern. (Impacted: Service Contracts, UX Summary)
- SD-ERR-STD: Standard mapping of HTTP 401/403/404 to user-friendly messages with retry/back link; safe because it does not alter business rules. (Impacted: Business Rules, Error Flows)

---

## 16. Open Questions

1. **Backend API/service contract (blocking):** What are the exact Moqui services (names, input params, output fields) to:
   - search/list Journal Entries
   - load Journal Entry detail (including lines)
   - (optional) load JE audit/status history?
2. **Permissions (blocking):** What are the exact permission strings/roles for viewing GL journal entries in the frontend (e.g., `gl.je.view`, `accounting.je.view`)?
3. **Entity/field naming (blocking):** Are the canonical fields named `sourceEventId` vs `eventId`, and `mappingRuleVersionId` vs something else? What are the exact dimension fields available on JE lines?
4. **Rounding/scale for UI balance check (blocking):** Should the UI compare debits/credits using:
   - exact decimal equality as provided by backend, or
   - currency-scale rounding before comparison (and what scale per currency)?
5. **Failure policy visibility (clarification):** The requirement mentions “Mapping failures route to suspense or rejection per policy.” Should the frontend expose a view of:
   - failed events / quarantined items / DLQ references,
   - or is that handled in another admin tool/story?

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] GL: Build Balanced Journal Entry from Event  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/201  
Labels: frontend, story-implementation, general

## Frontend Implementation for Story

**Original Story**: [STORY] GL: Build Balanced Journal Entry from Event

**Domain**: general

### Story Description

/kiro
# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## Capability
[CAP] Post Journal Entries to the General Ledger

## Story
GL: Build Balanced Journal Entry from Event

## Acceptance Criteria
- [ ] Mapped events create a draft journal entry with header refs (eventId/source refs/rule version)
- [ ] JE is balanced per currency (debits=credits)
- [ ] Each JE line includes category, account, and dimension references
- [ ] Mapping failures route to suspense or rejection per policy (no partial postings)

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

════════════════════════════════════════
ISSUE #194: [FRONTEND] [STORY] AP: Create Vendor Bill from Purchasing/Receiving Event
LABELS: domain:accounting,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:accounting-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] AP: Create & Review Vendor Bill Created from Purchasing/Receiving Event

### Primary Persona
AP Clerk (Accounts Payable)

### Business Value
Ensure vendor liabilities created from upstream receiving/invoice events are reviewable, traceable, and ready for downstream approval/payment, with clear ingestion/idempotency visibility and audit links (event ↔ bill ↔ posting reference).

---

## 2. Story Intent

### As a / I want / So that
**As an** AP Clerk,  
**I want** a UI to find and open a Vendor Bill that was automatically created from a Purchasing/Receiving-originated event,  
**So that** I can verify the bill details, confirm traceability to the source event and posting references, and route issues (duplicates/invalid references/quarantine) to investigation.

### In-scope
- Read-only review UI for system-created Vendor Bills originating from upstream events (Purchasing/Receiving domain emits; Accounting ingests/creates AP bill read model).
- Ability to search/list Vendor Bills by vendor, PO, source event id, vendor invoice reference, status, date range.
- Bill detail view including:
  - header fields, line items, totals
  - traceability links (source event, PO/receipt refs)
  - posting references (journal entry id primary; ledger transaction id secondary) when provided (**Decision AD-011**)
  - ingestion/idempotency indicators (processingStatus/idempotencyOutcome/error fields) when provided (**Decision AD-007**)
- Standard error handling and empty states.
- Permission-gated access to raw source payload JSON (if backend provides) (**Decision AD-009**, **Decision AD-013**).

### Out-of-scope
- Creating/editing Vendor Bills manually.
- Approving, paying, voiding bills.
- Defining GL accounts, posting categories, or posting rule sets.
- Implementing event ingestion (backend responsibility).
- Three-way match resolution workflow beyond displaying backend-provided discrepancy indicators (no policy inference).

---

## 3. Actors & Stakeholders
- **AP Clerk (Primary):** reviews bills created by events.
- **Accounting Ops (Secondary):** investigates quarantined/duplicate/conflict ingestion outcomes.
- **Auditor:** needs traceability and immutable audit trail visibility; read-only.
- **Purchasing/Receiving stakeholders:** need linkage to PO/receipts for investigation.
- **Accounting backend services:** authoritative source for bill read model, ingestion record, and posting references.

---

## 4. Preconditions & Dependencies
- Backend provides an authoritative Vendor Bill record created from an ingested upstream event.
- Backend exposes read endpoints to:
  - list Vendor Bills with filters
  - view a single Vendor Bill with lines, refs, traceability
  - provide posting references (journalEntryId primary; ledgerTransactionId optional) (**Decision AD-011**)
  - provide ingestion visibility fields (processingStatus/idempotencyOutcome/errorCode/errorMessage) either on the bill or via linked ingestion record (**Decision AD-007**)
  - optionally provide source event payload summary and (permission-gated) raw payload (**Decision AD-009**)
- Authentication is configured.
- Authorization/permissions for AP bill viewing and payload viewing are defined and enforced (see Open Questions; **Decision AD-013** requires explicit mapping).

**Dependency note:** The provided Accounting domain rules define ingestion monitoring and posting reference conventions but do not define AP/Vendor Bill endpoint families. This story is blocked until backend contracts and permissions are confirmed.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Accounting → Accounts Payable → Vendor Bills**
- Deep link: `/accounting/ap/vendor-bill/detail?billId=<UUIDv7>`

### Screens to create/modify
1. **AccountingApVendorBillList** (new)
   - Filter/search Vendor Bills
   - Paged results table
   - Navigate to detail screen
2. **AccountingApVendorBillDetail** (new)
   - View bill header + status
   - View line items
   - View traceability panel (source event, PO/receipt refs)
   - View ingestion/idempotency panel (if provided)
   - View posting references (journalEntryId primary; ledgerTransactionId secondary)
   - Optional: view source event payload summary; raw payload gated
3. **AccountingEventIngestionDetail** (existing or new link target; optional)
   - If ingestionId is available, link to Accounting → Integrations/Event Ingestion detail screen (if implemented in separate story). If not available, show ingestion fields inline only.

### Navigation context
- Breadcrumbs:
  - Accounting → Accounts Payable → Vendor Bills → Vendor Bill Detail
- From detail, links out to:
  - Purchase Order detail (if a screen exists; otherwise display id only)
  - Receipt/Goods Received reference (if a screen exists; otherwise display id only)
  - Journal Entry detail (if a screen exists and user permitted) using `journalEntryId` (**Decision AD-011**)
  - Ingestion record detail (if `ingestionId` exists) (**Decision AD-007**)

### User workflows (happy + alternate)
**Happy path**
1. User opens Vendor Bills list.
2. Filters by vendor and bill date range; optionally status.
3. Opens a bill detail.
4. Confirms:
   - source event identifiers (eventId/type) and upstream references (PO/receipt)
   - amounts/lines
   - posting reference(s) present (journalEntryId preferred)
   - ingestion status indicates PROCESSED (if provided)
5. Copies identifiers for downstream workflows (approval/payment out of scope).

**Alternate paths**
- Search by `sourceEventId`:
  - one bill: open and verify traceability
  - none: empty state with guidance
  - multiple: show warning banner “Multiple bills found for the same source event; investigate idempotency outcome” and list all (UI does not dedupe; backend is authoritative).
- Bill shows `processingStatus=QUARANTINED` or `idempotencyOutcome=DUPLICATE_CONFLICT`: show investigation banner and error code/message; provide copyable identifiers (**Decision AD-007**).
- User lacks payload permission: show payload section as “Restricted” and do not fetch raw payload (**Decision AD-009**, **Decision AD-013**).

---

## 6. Functional Behavior

### Triggers
- User navigates to Vendor Bill list screen.
- User submits filters/search.
- User opens a bill detail from the list or deep link.
- User clicks “View raw payload” (only if permitted and backend supports).

### UI actions
- Filter form submit triggers a Moqui transition calling list service; results rendered with server-side pagination.
- Row click navigates to detail transition with `billId`.
- “Copy” actions for identifiers (billId, sourceEventId/eventId, vendorInvoiceReference, journalEntryId, ingestionId) are client-only.
- “View raw payload” triggers a separate call (or expands a field) only when permission is present; otherwise hidden/disabled.

### State changes
- No domain state changes in this story (read-only).
- No “mark as reviewed” or similar tracking is implemented (audit policy denylist).

### Service interactions
- List screen calls backend list service to retrieve paged results.
- Detail screen calls backend detail service to retrieve bill + lines + traceability + ingestion fields + posting refs.
- Optional: call to retrieve ingestion record detail by ingestionId (if separate screen exists).
- Optional: call to retrieve source event payload summary/raw payload (permission-gated).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **UUIDv7 validation**: For inputs that are UUIDv7 identifiers (billId, sourceEventId/eventId, ingestionId), UI blocks invalid UUID format with inline error (**Decision AD-006**).
- Filter validation:
  - date range: `fromDate <= toDate` else inline error “From date must be on or before To date.”
  - `sourceEventId` is exact match only (no partial).
- Deep link validation:
  - if `billId` invalid UUID → inline error state and do not call backend.
  - if `billId` valid but not found → not-found state.

### Enable/disable rules
- All fields are read-only.
- “View Journal Entry” link enabled only when `journalEntryId` is present and user has permission to view journal entries (permission token TBD; see Open Questions; **Decision AD-013**).
- “View raw payload” enabled only with `accounting:events:view-payload` and only if backend provides raw payload endpoint/field (**Decision AD-009**, **Decision AD-013**).

### Visibility rules
- Traceability panel shown when any of: `sourceEventId/eventId`, `purchaseOrderId`, receipt reference exists.
- Ingestion panel shown when any of: `processingStatus`, `idempotencyOutcome`, `errorCode`, `ingestionId` exists.
- Posting references panel shown when `journalEntryId` or `ledgerTransactionId` exists; `journalEntryId` is primary and should be emphasized (**Decision AD-011**).
- Raw payload section hidden by default; show payload summary if provided; raw JSON only when permitted (**Decision AD-009**).

### Error messaging expectations
- Standard wrapper:
  - List load failure: “Unable to load Vendor Bills. Please retry.” + show `errorCode` if provided.
  - Detail load failure: “Unable to load Vendor Bill. Please retry.” + show `errorCode` if provided.
- Authorization failures:
  - 401: prompt re-authentication per app standard.
  - 403: “Access denied.” Do not reveal whether a specific billId exists (**Decision AD-013**).
- Quarantine/conflict:
  - If `processingStatus=QUARANTINED` or `idempotencyOutcome=DUPLICATE_CONFLICT`, show banner with backend-provided `errorCode`/`errorMessage` and copyable identifiers (**Decision AD-007**).

---

## 8. Data Requirements

### Entities involved (frontend-facing)
(Exact Moqui entity names TBD; treat as backend resources.)
- `VendorBill` (AP bill read model in Accounting)
- `VendorBillLineItem`
- `Vendor` (display name only)
- `PurchaseOrder` (reference only)
- `GoodsReceipt` / `Receipt` (reference only)
- `AccountingEventIngestionRecord` (optional linkage by ingestionId; **Decision AD-007**)
- `JournalEntry` reference (by journalEntryId; **Decision AD-011**)
- Source event envelope/payload summary (optional; raw payload gated; **Decision AD-009**)

### Fields (minimum required for UI)

**VendorBill (header)**
- `billId` (UUIDv7, required, read-only)
- `vendorId` (UUIDv7, required, read-only)
- `vendorName` (string, optional display)
- `purchaseOrderId` (UUIDv7, optional, read-only)
- `receiptId` or `goodsReceivedId` (UUIDv7, optional, read-only) — exact field name TBD
- `sourceEventId` or `eventId` (UUIDv7, optional but expected for system-created bills, read-only)
- `sourceEventType` (string, optional; backend-authoritative)
- `vendorInvoiceReference` (string, optional)
- `status` (string enum; backend-authoritative, read-only)
- `billDate` (date, optional/required per backend)
- `dueDate` (date, optional)
- `currencyUomId` (string, required)
- `totalAmount` (decimal, required)
- `createdAt`, `createdBy` (datetime/string, optional but preferred for audit display)

**VendorBillLineItem**
- `lineId` (UUIDv7, required)
- `productId` (UUIDv7, optional)
- `description` (string, optional/required per backend)
- `quantity` (decimal, required)
- `unitPrice` (decimal, required)
- `lineTotal` (decimal, required)
- Optional accounting display fields (display-only; do not infer):
  - `postingCategory` or `glAccountRef` (string, optional)
  - `taxAmount`, `feeAmount` (decimal, optional)

**Ingestion visibility (if provided on bill or via linked ingestion record)**
- `ingestionId` (UUIDv7, optional)
- `processingStatus` (enum: `PROCESSED`, `REJECTED`, `QUARANTINED`; backend-owned; **Decision AD-007**)
- `idempotencyOutcome` (enum: `NEW`, `DUPLICATE_IGNORED`, `DUPLICATE_CONFLICT`; backend-owned; **Decision AD-007**)
- `receivedAt` (datetime, optional)
- `errorCode` (string, optional)
- `errorMessage` (string, optional)

**Posting references**
- `journalEntryId` (UUIDv7, optional; primary navigation; **Decision AD-011**)
- `ledgerTransactionId` (UUIDv7, optional; secondary display; **Decision AD-011**)

**Source event payload**
- `payloadSummary` (object/string, optional; safe for default display; **Decision AD-009**)
- `rawPayloadJson` (string/object, optional; only fetch/render with permission; **Decision AD-009**)

### Read-only vs editable by state/role
- All fields read-only for all roles in this story.

### Derived/calculated fields
- Money formatting uses `currencyUomId` from backend (no assumed default).
- Human label mapping for known ingestion enums is allowed only for the enums explicitly defined in Accounting guide (AD-007). Any additional enum values must be displayed as-is with a generic label “Unknown status: <value>” (no inference).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not provided for AP Vendor Bills. The following contracts are REQUIRED for implementation and must be confirmed. Until confirmed, this story remains blocked.

### Load/view calls

#### `GET /accounting/ap/vendor-bills/list` (proposed; TBD)
- Query params:
  - `vendorId` (UUIDv7, optional)
  - `purchaseOrderId` (UUIDv7, optional)
  - `sourceEventId` (UUIDv7, optional)
  - `vendorInvoiceReference` (string, optional)
  - `status` (string or list, optional)
  - `billDateFrom` (date, optional)
  - `billDateTo` (date, optional)
  - pagination: `pageIndex`, `pageSize`
  - sorting: `orderBy` (stable)
- Response:
  - `items[]` summary fields (see Data Requirements)
  - `pageIndex`, `pageSize`, `totalCount`

#### `GET /accounting/ap/vendor-bills/detail?billId=...` (proposed; TBD)
- Response:
  - `vendorBill` header
  - `lineItems[]`
  - `traceability` object (PO/receipt/source event ids)
  - `ingestion` object (optional) OR `ingestionId` for linking
  - `postingRefs` object (journalEntryId, ledgerTransactionId)

### Optional calls (if backend supports)

#### `GET /accounting/ingestion/detail?ingestionId=...`
- Use canonical ingestion endpoint family (**Decision AD-007**).
- Response fields per Accounting ingestion guide (processingStatus/idempotencyOutcome/receivedAt/errorCode/errorMessage/posting refs).

#### `GET /accounting/events/detail?eventId=...` (or equivalent; TBD)
- Must support:
  - `payloadSummary` always (or when available)
  - raw payload only when permitted (**Decision AD-009**)

### Create/update/submit calls
- None (read-only story).

### Error handling expectations
- 400/422: validation errors (e.g., invalid date range) should be handled client-side; if returned, show message and keep filters.
- 401/403: show access denied without leaking existence (**Decision AD-013**).
- 404: show not found for detail.
- 409: show conflict/reload guidance (rare for read-only; still handle).
- 5xx/timeout: show retry; preserve filters and scroll position where feasible.

---

## 10. State Model & Transitions

### Allowed states
- Vendor Bill `status` is backend-defined; UI must render any string value.
- UI must not implement transitions.

### Role-based transitions
- None in this story.

### UI behavior per state
- Always show a status badge with the raw status value.
- If status indicates a non-actionable state (e.g., PAID/VOID), show informational text only if backend provides a `statusLabel` or `statusDescription`; otherwise do not infer meaning.

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid UUID in `sourceEventId` filter → inline error; do not call backend.
- Invalid date range → inline error; do not call backend.

### Concurrency conflicts
- If backend returns 409 on detail fetch: show “This Vendor Bill may have changed. Reload to view latest.” with Reload action.

### Unauthorized access
- List: show access denied state; no data rendered.
- Detail deep link: show access denied state; do not reveal whether bill exists (**Decision AD-013**).

### Empty states
- No results: “No Vendor Bills match your filters.” with “Clear filters”.
- Missing ingestion info: show “Ingestion details not available” (informational).
- Missing posting references: show “Posting references not available” (informational).

---

## 12. Acceptance Criteria

### Scenario 1: List Vendor Bills by status and date
**Given** I am an authenticated AP Clerk with permission to view Vendor Bills  
**When** I open the Vendor Bills list screen  
**And** I filter by a bill date range and a status value  
**Then** I see a paged list of Vendor Bills matching the filters  
**And** each row shows `billId`, vendor, status, bill date, due date (if present), and total amount with currency.

### Scenario 2: Search by sourceEventId with UUID validation
**Given** I am on the Vendor Bills list screen  
**When** I enter an invalid UUID into the `sourceEventId` filter  
**Then** I see an inline validation error  
**And** the search is not submitted.

### Scenario 3: View bill detail with line items and posting references
**Given** a Vendor Bill exists with line items and a `journalEntryId` posting reference  
**When** I open the Vendor Bill detail screen for that bill  
**Then** I see all line items with quantity, unit price, and line total  
**And** I see `journalEntryId` displayed as the primary posting reference  
**And** if `ledgerTransactionId` is present, it is displayed as a secondary reference.

### Scenario 4: Quarantined/conflict ingestion visibility
**Given** a Vendor Bill exists with ingestion fields indicating `processingStatus = QUARANTINED` or `idempotencyOutcome = DUPLICATE_CONFLICT`  
**When** I open the Vendor Bill detail screen  
**Then** I see a prominent banner indicating the record requires investigation  
**And** I see backend-provided `errorCode` and `errorMessage` (if present)  
**And** I can copy `billId`, `sourceEventId/eventId`, and `ingestionId` (if present).

### Scenario 5: Vendor Bill detail not found
**Given** I navigate directly to a Vendor Bill detail URL with a valid UUIDv7 `billId` that does not exist  
**When** the screen loads  
**Then** I see a “Vendor Bill not found” message  
**And** I can navigate back to the Vendor Bills list.

### Scenario 6: Unauthorized access does not leak existence
**Given** I am authenticated but do not have permission to view Vendor Bills  
**When** I open the Vendor Bills list screen  
**Then** I see an access denied state  
**And** no bill data is displayed.  
**When** I navigate directly to a Vendor Bill detail URL  
**Then** I see an access denied state  
**And** the UI does not indicate whether the bill exists.

### Scenario 7: Raw payload visibility is permission-gated
**Given** a Vendor Bill detail includes a source event payload summary  
**And** I do not have `accounting:events:view-payload` permission  
**When** I open the Vendor Bill detail screen  
**Then** I can view the payload summary (if provided)  
**And** I cannot view raw payload JSON and the UI shows “Restricted” for raw payload.

---

## 13. Audit & Observability

### User-visible audit data
- Display when provided:
  - `createdAt`, `createdBy`
  - `sourceEventId/eventId`, `sourceEventType`
  - `ingestionId`, `receivedAt` (if provided)
  - posting references (`journalEntryId`, `ledgerTransactionId`) (**Decision AD-011**)

### Status history
- If backend provides `statusHistory[]`, render chronologically (status, changedAt, changedBy).
- Otherwise, show only current status (no fabrication).

### Traceability expectations
- Bill detail must display copyable identifiers for audit tracing:
  - `billId`
  - `vendorId`
  - `purchaseOrderId` (if present)
  - receipt reference id (if present)
  - `sourceEventId/eventId` (if present)
  - `ingestionId` (if present)
  - `journalEntryId` (if present)

---

## 14. Non-Functional UI Requirements

- **Performance:** first page list load within ~2s under normal conditions; server-side pagination required.
- **Accessibility:** keyboard navigation for filters and results; proper labels; error messages announced (aria-live).
- **Responsiveness:** usable on tablet widths; table may collapse columns.
- **Security:** do not log or cache raw payload JSON; render JSON safely (no HTML injection) (**Decision AD-009**).
- **i18n/timezone/currency:** format money using `currencyUomId`; display dates in user locale; do not alter backend semantics.

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Added standard empty-state messaging and “Clear filters” action; UI ergonomics only; impacts UX Summary, Alternate / Error Flows, Acceptance Criteria.
- SD-UI-PAGINATION: Use paged list with `pageIndex/pageSize` and server-side `totalCount`; UI ergonomics/performance; impacts UX Summary, Service Contracts, Non-Functional UI Requirements.
- SD-ERR-STD-MAPPING: Standard mapping of 401/403/404/409/5xx to UI states with retry and safe messaging; standard error-handling; impacts Service Contracts, Alternate / Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Backend API contracts (blocking):** What are the exact Moqui service names / REST endpoints and request/response schemas for:
   - listing Vendor Bills
   - Vendor Bill detail (including line items)
   - traceability fields (PO/receipt/source event identifiers)
   - ingestion visibility fields (processingStatus/idempotencyOutcome/errorCode/errorMessage) and whether they are embedded on the bill or linked via `ingestionId` (**Decision AD-007**)
   - posting references (journalEntryId/ledgerTransactionId) (**Decision AD-011**)

2. **Permissions (blocking, AD-013):** What are the explicit permission tokens for:
   - viewing Vendor Bills list/detail (e.g., `accounting:ap-bill:view` or similar)
   - viewing linked Journal Entry detail (if a JE screen exists)
   - viewing source event payload summary vs raw payload (raw must use `accounting:events:view-payload`; confirm summary access policy) (**Decision AD-009**, **Decision AD-013**)

3. **Origin event taxonomy (blocking):** What are the canonical upstream event types that can create a Vendor Bill in Accounting (e.g., `GoodsReceivedEvent`, `VendorInvoiceReceivedEvent`, other)? Provide the exact `sourceEventType` strings the UI should display (no inference).

4. **Vendor Bill status enum (blocking):** What are the canonical Vendor Bill `status` values and their meanings for AP review? (UI will render any string, but filters and default tabs require known values.)

5. **Journal Entry navigation (non-blocking but recommended):** Is there an existing Moqui screen route to view a Journal Entry by `journalEntryId`? If yes, provide the route and required permission. If no, this story will display the ID only (no link).

════════════════════════════════════════
ISSUE #193: [FRONTEND] [STORY] AP: Approve and Schedule Payments with Controls
LABELS: domain:accounting,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:accounting-domain-agent
BODY:
## Title
[FRONTEND] [STORY] AP: Approve and Schedule Payments with Controls

## Primary Persona
- AP Clerk
- AP Manager

## Business Value
Enable controlled, auditable progression of Bills from Draft to Approved to Scheduled, enforcing approval thresholds and permissions so the organization pays vendors accurately and reduces fraud/unauthorized disbursements.

---

# 2. Story Intent

## As a / I want / So that
**As an** AP Clerk or AP Manager,  
**I want** to approve Draft bills and schedule Approved bills for payment from the POS frontend,  
**so that** AP obligations can be managed with appropriate controls, audit trail, and readiness for payment execution.

## In-scope
- View bill details including current status and relevant audit fields.
- Perform **Approve** action on `DRAFT` bills (if authorized and within threshold).
- Perform **Schedule Payment** action on `APPROVED` bills (if authorized), capturing `scheduledFor` and `paymentMethod`.
- Display server validation/authorization/threshold errors clearly.
- Display bill status history/audit entries related to approval and scheduling (read-only).

## Out-of-scope
- Executing payments (owned by `domain:payment`).
- Editing bill header/lines, vendor data, or bill creation flow (unless already exists; not defined here).
- Configuration UI for approval policy/thresholds (owned by accounting configuration; not requested).
- Downstream payment outcome handling (`Payment.Executed.v1`, `Payment.Failed.v1`) UI (not requested here).

---

# 3. Actors & Stakeholders

## Actors
- **AP Clerk**: prepares bills; may request approval; may schedule if permitted.
- **AP Manager**: approves bills (higher thresholds); may schedule payments.
- **System (Moqui app)**: enforces status prerequisites, permission checks, threshold checks; records audit entries.

## Stakeholders
- **Finance/AP leadership**: needs controlled approval and cashflow scheduling.
- **Auditors/Compliance**: require immutable, queryable audit trail.
- **Payments/Treasury team**: relies on scheduled payments being valid and approved.

---

# 4. Preconditions & Dependencies

## Preconditions
- A Bill exists and is retrievable by `billId`.
- Bill has a status in `{DRAFT, APPROVED, SCHEDULED, ...}`.
- User is authenticated in the frontend and has server-evaluated permissions.

## Dependencies
- Backend capability for:
  - Loading bill details (including status, amount, vendor, and audit-related fields).
  - Approving a bill: transition `DRAFT → APPROVED` with threshold validation and audit entry.
  - Scheduling a bill: transition `APPROVED → SCHEDULED` capturing schedule inputs, audit entry, and emitting `Accounting.PaymentScheduled.v1`.

## Blocking dependency (needs clarification)
- Concrete Moqui screen route conventions for AP (menu placement + URL patterns) in `durion-moqui-frontend`.
- Concrete backend service/REST contracts for AP Bills (load/approve/schedule), including:
  - request/response field names
  - error codes (or stable `errorCode` values)
  - permission tokens for AP approve/schedule
- Domain ownership confirmation for AP Bills workflow (AP/Bills may be Billing/Accounting/Payments depending on backend); this story assumes Accounting UI ownership but cannot define SoR without contract.

**Decision rationale (why blocked):** SAFE_DEFAULTS_MODE forbids guessing system-of-record, permission scope, and event contracts/identifiers. The accounting domain guide provided is authoritative for AR, ingestion, refunds, exports—but does not define AP Bills endpoints, entities, or permissions.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From an AP Bills list screen (if exists): select a bill → navigate to Bill Detail.
- Direct route deep link: **TBD** (must align with repo conventions; see Open Questions).

## Screens to create/modify
1. **AP Bill List Screen (if exists; otherwise create)**  
   - Server-paginated list of bills with filters (status, vendor, date range, amount range).
   - Row navigation to Bill Detail.
2. **AP Bill Detail Screen (required)**  
   - Read-only bill summary: billNumber, vendor, amount, currency, status, dueDate (if available).
   - Contextual actions:
     - `Approve` available only when bill is `DRAFT` and user has approve permission.
     - `Schedule Payment` available only when bill is `APPROVED` and user has schedule permission.
   - Schedule form (modal or inline):
     - `scheduledFor` (date)
     - `paymentMethod` (type + optional instrumentId)
   - Audit/history panel (read-only):
     - approval and scheduling events (and any other bill status transitions returned by backend).

## Navigation context
- Breadcrumb: Accounting → Accounts Payable → Bills → Bill {billNumber} (menu placement TBD by repo conventions).
- After successful transitions, remain on Bill Detail and refresh from backend.

## User workflows (happy + alternate)

### Happy path A: Approve bill
1. User opens Bill Detail (status `DRAFT`).
2. Clicks **Approve**.
3. UI submits approve command.
4. On success: status updates to `APPROVED`; approval audit entry visible.

### Happy path B: Schedule payment
1. User opens Bill Detail (status `APPROVED`).
2. Clicks **Schedule Payment**.
3. User enters `scheduledFor` and selects `paymentMethod`.
4. UI submits schedule command.
5. On success: status updates to `SCHEDULED`; scheduling audit visible; show returned scheduling reference(s) if provided.

### Alternate path: Not authorized / policy failure / invalid state
- Server rejects; UI shows error banner and keeps bill state unchanged; UI refreshes bill detail on 409 conflicts.

---

# 6. Functional Behavior

## Triggers
- Screen load: Bill Detail is opened.
- User actions: Approve button click; Schedule Payment submit.

## UI actions
- **Load bill** on screen init and after any successful transition.
- **Approve**
  - Optional confirm dialog (project UX convention TBD): includes billNumber and amount.
  - Submit approve request.
- **Schedule**
  - Open schedule form.
  - Client-side validate required fields (presence + date format).
  - Submit schedule request.

## State changes (frontend perspective)
- No optimistic updates for financial state.
- After server success:
  - Refresh bill state from backend
  - Update action availability based on returned status

## Service interactions
> Service names/paths are **TBD** pending backend contract. Frontend must call backend-owned services and treat backend as authoritative for state and policy.

Required interactions:
- Load bill detail (and audit/history if available)
- Approve bill (command)
- Schedule payment (command)

**Decision rationale:** Accounting domain guide provides canonical endpoints for AR apply, refunds, ingestion, exports—not AP Bills. Therefore endpoints cannot be safely inferred.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Approve action:
  - UI offers Approve only when status is `DRAFT`.
  - Server is authoritative for:
    - permission to approve
    - approval threshold policy
    - any additional prerequisites (e.g., vendor compliance holds)
- Schedule action:
  - UI offers Schedule only when status is `APPROVED`.
  - Client-side required-field validation:
    - `scheduledFor` required; must be a valid date (YYYY-MM-DD).
    - `paymentMethod.type` required.
    - `paymentMethod.instrumentId` required only when backend indicates it is required for the selected type (requires contract or a “payment method options” endpoint).

## Enable/disable rules
- Disable all action buttons while a transition request is in-flight.
- Disable Approve if status ≠ `DRAFT`.
- Disable Schedule if status ≠ `APPROVED`.
- Disable Schedule submit if required schedule fields invalid/missing.

## Visibility rules
- Entry points and actions must be permission-gated:
  - If user lacks permission, hide the action (preferred) and rely on backend 403 if attempted via crafted request.
  - If project convention requires showing disabled actions, show disabled with “Not authorized” helper text.
  - **TBD**: project-wide convention (see Open Questions).

## Error messaging expectations
- Authorization failures (403): “You are not authorized to perform this action.”
- Threshold/policy failures (422): “Approval not permitted for this bill.” If backend provides safe details (e.g., “threshold exceeded”), display them; do not infer limits.
- Invalid state transition (409): “Bill status changed; reloading latest data.”
- Validation errors (400/422): show inline field errors for schedule form when `details` provides field-level keys.
- Generic/network/5xx: “Unable to complete action. Try again.”

---

# 8. Data Requirements

## Entities involved (frontend view models)
> Backend entity names are not provided; below is the required data contract for UI.

### Bill
- `billId` (UUIDv7, required, read-only)
- `billNumber` (string, required, read-only)
- `vendorId` (UUIDv7, required, read-only)
- `vendorName` (string, required for UI display, read-only) *(may be derived server-side)*
- `status` (string/enum, required, read-only): must support at least `DRAFT`, `APPROVED`, `SCHEDULED` (others allowed; treated read-only)
- `amount.value` (decimal, required, read-only)
- `amount.currencyUomId` (string, required, read-only)
- `dueDate` (date, optional, read-only)
- `createdAt` (timestamp, optional, read-only)
- `createdByUserId` (UUIDv7, optional, read-only)

### Approval fields (when status ≥ APPROVED)
- `approvedByUserId` (UUIDv7, nullable, read-only)
- `approvedAt` (timestamp, nullable, read-only)

### Scheduling fields (when status ≥ SCHEDULED)
- `scheduledFor` (date, nullable until scheduled; read-only after scheduled)
- `paymentMethod.type` (string/enum, nullable until scheduled; read-only after scheduled)
- `paymentMethod.instrumentId` (string/UUIDv7, nullable; read-only after scheduled)
- `scheduledByUserId` (UUIDv7, nullable; read-only)
- `scheduledAt` (timestamp, nullable; read-only)
- `scheduledPaymentRef` (string/UUIDv7, optional, read-only) *(e.g., paymentId or scheduleId if backend returns one)*

### Audit entries (read-only list)
- `auditId` (UUIDv7/string, required)
- `billId` (UUIDv7, required)
- `eventType` (string, required) e.g., `BILL_APPROVED`, `PAYMENT_SCHEDULED`
- `oldStatus` (string, required)
- `newStatus` (string, required)
- `principalUserId` (UUIDv7, required)
- `occurredAt` (timestamp, required)
- `notes` (string, optional)

## Read-only vs editable by state/role
- All bill fields are read-only in this story.
- Editable inputs (only in schedule form, only before submit):
  - `scheduledFor`
  - `paymentMethod.type`
  - `paymentMethod.instrumentId` (conditional)

## Derived/calculated fields (frontend-only)
- `canApprove` = (status == `DRAFT`) AND (user has approve permission OR backend returns `allowedActions` containing `APPROVE`)
- `canSchedule` = (status == `APPROVED`) AND (user has schedule permission OR backend returns `allowedActions` containing `SCHEDULE`)

**Decision rationale:** Permission gating model must be explicit (Accounting AD-013), but AP-specific permission tokens are not provided; therefore UI must support either explicit permission checks (preferred) or backend-provided `allowedActions` until tokens are confirmed.

---

# 9. Service Contracts (Frontend Perspective)

> Moqui implementations typically use screen transitions and services. Exact service names are not provided; define required interfaces below and map them to Moqui `service-call` / REST as implemented in this repo.

## Load/view calls

### Get Bill Detail
- **Request**: `{ billId }`
- **Response**:
  - `bill` (Bill object as above)
  - `auditEvents[]` (optional)
  - `allowedActions[]` (optional; strings like `APPROVE`, `SCHEDULE`)
  - `version` / `lastUpdatedAt` (optional; for concurrency messaging)

### List Bills (if list screen is in scope for implementation)
- **Request**: `{ pageIndex, pageSize, orderBy?, filters... }`
- **Response**: `{ items[], pageIndex, pageSize, totalCount }`

## Create/update calls (commands)

### Approve Bill
- **Request**: `{ billId }`
- **Response**:
  - updated `bill` and any new `auditEvents` (optional), OR
  - `{ success: true }` plus identifiers to refetch
- **Expected errors**:
  - `403` unauthorized
  - `409` invalid state / concurrency
  - `422` policy/threshold failure

### Schedule Payment
- **Request**: `{ billId, scheduledFor, paymentMethod: { type, instrumentId? } }`
- **Response**:
  - updated `bill` including scheduling fields and any schedule reference (e.g., `paymentId`), OR
  - `{ success: true }` plus identifiers to refetch
- **Expected errors**:
  - `403` unauthorized
  - `409` invalid state / concurrency
  - `400/422` validation errors (field-level)

## Submit/transition calls
- Treat approve and schedule as **commands**.
- UI must prevent double-submit by disabling buttons while in-flight.

## Error handling expectations
Use canonical error shape when provided:
```json
{
  "errorCode": "SOME_CODE",
  "message": "User-safe message",
  "details": { "fieldName": "REQUIRED" }
}
```

Mapping:
- `403` → show authorization banner; do not reveal record existence beyond what screen already loaded.
- `409` → show conflict banner and auto-refresh detail.
- `400/422` with `details` → map to inline field errors; otherwise show banner.
- `5xx/timeout` → show retryable banner; preserve entered schedule form values.

**Decision rationale:** Error schema guidance exists in Accounting domain docs (A3), but AP-specific error codes are not defined; UI must be resilient and rely on `errorCode/message/details` without hardcoding AP policy.

---

# 10. State Model & Transitions

## Allowed states (in scope)
- `DRAFT`
- `APPROVED`
- `SCHEDULED`

Other states may exist; they are read-only for this story.

## Role-based transitions
- `DRAFT → APPROVED`: requires approve permission and passing threshold/policy (server-side).
- `APPROVED → SCHEDULED`: requires schedule permission (server-side).

## UI behavior per state
- `DRAFT`:
  - Approve action available if permitted
  - Schedule action hidden/disabled
- `APPROVED`:
  - Schedule action available if permitted
  - Approve action hidden/disabled
- `SCHEDULED`:
  - No approve/schedule actions
  - Show schedule details read-only

---

# 11. Alternate / Error Flows

## Validation failures (schedule form)
- Missing `scheduledFor` → inline error; block submit
- Missing `paymentMethod.type` → inline error; block submit
- Invalid date format → inline error; block submit
- Missing `instrumentId` when required by selected method → inline error; block submit (requires backend-provided requirement signal)

## Threshold/policy failure on approval
- Server rejects (422); UI shows banner using backend `message` and optional `errorCode`.
- Bill remains `DRAFT`.

## Concurrency conflicts
- If bill status changed since load:
  - Approve/Schedule returns `409`
  - UI shows “Bill was updated; reloading latest data.”
  - UI refetches bill detail and resets action availability.

## Unauthorized access
- If user can load bill but cannot act:
  - Actions hidden/disabled
  - If action attempted (e.g., stale UI), server returns 403 and UI shows authorization banner.

## Empty states
- Audit panel empty: show “No audit events recorded yet.”
- If bill loads without audit support: show “Audit history unavailable” and provide link to refresh; do not fabricate history.

---

# 12. Acceptance Criteria

## Scenario 1: View bill details with contextual actions
**Given** I am an authenticated AP user  
**And** a bill exists with status `DRAFT`  
**When** I open the Bill Detail screen for that bill  
**Then** I can see billNumber, vendor, amount, currency, and status  
**And** I see an Approve action available only if I am authorized  
**And** I do not see Schedule Payment available

## Scenario 2: Approve a draft bill successfully
**Given** I am authorized to approve bills and within my approval threshold  
**And** a bill exists in status `DRAFT`  
**When** I click Approve (and confirm if prompted)  
**Then** the frontend submits an approve command for that bill  
**And** on success the bill status updates to `APPROVED` after reloading from the backend  
**And** the approval audit entry is visible with approver and timestamp (if audit is returned)

## Scenario 3: Approval blocked due to threshold/policy
**Given** I am authenticated  
**And** a bill exists in status `DRAFT`  
**And** the backend policy prevents me from approving this bill (e.g., threshold exceeded)  
**When** I attempt to approve the bill  
**Then** the backend rejects the request with a validation/policy error  
**And** the frontend shows the backend-provided user-safe message  
**And** the bill remains in status `DRAFT`

## Scenario 4: Schedule payment successfully for approved bill
**Given** I am authorized to schedule payments  
**And** a bill exists in status `APPROVED`  
**When** I open Schedule Payment, enter a scheduled date and payment method, and submit  
**Then** the frontend submits the scheduling command  
**And** on success the bill status updates to `SCHEDULED` after reloading from the backend  
**And** scheduling audit entry is visible (if audit is returned)  
**And** a scheduling reference (e.g., paymentId/scheduleId) is displayed if returned by the backend

## Scenario 5: Scheduling blocked when bill not approved
**Given** I am authenticated  
**And** a bill exists in status `DRAFT`  
**When** I attempt to schedule payment for the bill (via direct URL or stale UI)  
**Then** the backend rejects the request due to invalid state  
**And** the frontend shows a conflict/state error and reloads the bill  
**And** the bill remains in status `DRAFT`

## Scenario 6: Unauthorized approve/schedule
**Given** I am authenticated but not authorized to approve (or schedule)  
**And** a bill exists in the corresponding prerequisite status  
**When** I attempt the action  
**Then** the backend returns an authorization error  
**And** the frontend shows a “not authorized” message  
**And** no state change is shown in the UI

## Scenario 7: Concurrency conflict reload
**Given** I am viewing a bill in status `DRAFT` or `APPROVED`  
**And** another user changes the bill status before I submit my action  
**When** I submit Approve or Schedule  
**Then** the backend returns a conflict (409)  
**And** the frontend informs me the bill changed and reloads the latest bill state  
**And** the available actions update to match the new status

---

# 13. Audit & Observability

## User-visible audit data
- Bill detail shows (when present):
  - `approvedByUserId` + `approvedAt`
  - `scheduledByUserId` + `scheduledAt` + `scheduledFor` + `paymentMethod`
  - scheduling reference (paymentId/scheduleId) if returned

## Status history
- Display chronological audit events if backend returns them.
- If backend does not provide audit events, display only the latest approval/scheduling fields and show “Audit history unavailable.”

## Traceability expectations
- Frontend must propagate W3C Trace Context headers (`traceparent`, `tracestate`) unchanged on all calls when present; generate `traceparent` only if absent. (Accounting AD-008)
- For each command attempt, capture (client-side) non-PII telemetry fields:
  - `billId`, action (`approve`/`schedule`), outcome (`success`/`error`), `errorCode` if provided.

---

# 14. Non-Functional UI Requirements

## Performance
- Bill Detail initial load: target < 2s for first render of summary fields under normal conditions.
- Action calls show immediate in-flight state and prevent duplicate submissions.

## Accessibility
- All actions and schedule form controls keyboard accessible.
- Inline errors and banners announced to screen readers (aria-live).

## Responsiveness
- Bill Detail usable on tablet width and above; responsive stacking acceptable.

## i18n/timezone/currency
- Display amounts formatted using `currencyUomId` from backend.
- Display timestamps in user locale/timezone per project convention (TBD).
- `scheduledFor` is a date (no timezone conversion); submit as ISO date string.

---

# 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Show explicit empty-state copy for missing audit/history; safe because it doesn’t alter domain behavior; impacts UX Summary, Alternate/Empty states.
- SD-UX-INFLIGHT-DISABLE: Disable actions while request in-flight to prevent double submit; safe UI ergonomics; impacts Functional Behavior, Error Flows.
- SD-ERR-MAP-GENERIC: Map unknown server/network errors to a generic retryable banner; safe because it avoids guessing business meaning; impacts Service Contracts, Error Flows.

---

# 16. Open Questions

1. **Domain ownership / SoR (blocking):** Which backend domain/service is the system of record for AP Bills and their workflow (`DRAFT → APPROVED → SCHEDULED`)? Is this Accounting, Billing, or a dedicated AP module? Provide the authoritative entity/service owner.  
2. **Moqui routing/screen conventions (blocking):** What are the correct Moqui screen paths and menu placement for Accounts Payable Bills list/detail in `durion-moqui-frontend`? Provide the canonical route(s) (e.g., `/accounting/ap/bills`, `/accounting/ap/bills/:billId`).  
3. **Backend service/API contract (blocking):** What are the exact endpoints/services and request/response schemas for:
   - list bills (pagination + filters),
   - bill detail (including audit/history if available),
   - approve bill,
   - schedule payment (including payment method model and returned scheduling reference)?  
4. **Permissions (blocking / denylist):** What are the exact permission tokens for:
   - viewing AP bills list/detail,
   - approving bills,
   - scheduling payments?
   (Accounting AD-013 requires explicit permission mapping; cannot ship without it.)  
5. **Payment method model (blocking):** What are allowed `paymentMethod.type` values and when is `instrumentId` required? Is there an endpoint to list available instruments (by vendor, business unit, bank account, etc.)?  
6. **Audit/history source (blocking):** Is there a dedicated audit endpoint/entity for bill status transitions, and what fields are guaranteed? If not, which fields on Bill are authoritative for approval/scheduling audit?  
7. **Event contract (blocking / denylist):** Does scheduling emit `Accounting.PaymentScheduled.v1` (as stated), and what is the canonical event name/schemaVersion? UI will not implement event emission but needs stable identifiers for observability and linking (if shown).  

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] AP: Approve and Schedule Payments with Controls  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/193  
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] AP: Approve and Schedule Payments with Controls

**Domain**: payment

### Story Description

/kiro
# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## Capability
[CAP] Accounts Payable (Bill → Payment)

## Story
AP: Approve and Schedule Payments with Controls

## Acceptance Criteria
- [ ] Bill workflow supports Draft → Approved → Scheduled
- [ ] Approval thresholds and role permissions enforced
- [ ] Payment scheduling records date/method and audit trail
- [ ] Payment execution blocked unless approved


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

════════════════════════════════════════
ISSUE #190: [FRONTEND] [STORY] Adjustments: Create Manual Journal Entry with Controls
LABELS: domain:accounting,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:accounting-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Adjustments: Create Manual Journal Entry (JE) with Controls

### Primary Persona
Accountant / Controller (authorized financial user)

### Business Value
Enable controlled, auditable manual GL adjustments directly from the POS frontend while preventing unbalanced entries, enforcing accounting period controls, and ensuring immutability once posted.

---

## 2. Story Intent

### As a / I want / So that
**As an** authorized financial user (Accountant/Controller),  
**I want** a frontend workflow to create and post a manual Journal Entry with a required reason code and balanced debit/credit lines,  
**So that** necessary accounting adjustments can be recorded accurately, within open periods, with a complete audit trail.

### In-scope
- A “Create Manual Journal Entry” UI to enter header + multiple lines.
- Client-side and server-side validation handling:
  - reasonCode required
  - at least 2 lines
  - each line must have either debit or credit (not both)
  - totals must balance before posting
- Posting submission and resulting immutable “POSTED” record behavior in UI.
- Error display for:
  - unbalanced entry
  - closed period
  - invalid/inactive GL account
  - missing required fields
  - insufficient permissions
- Read-only view of a posted JE (no edit/delete actions).

### Out-of-scope
- Editing or deleting posted JEs (explicitly disallowed).
- Creating reversing/reversal JEs (mentioned as correction mechanism, but not implemented here unless separately specified).
- Managing GL accounts, accounting periods, or reason code master data (assumed existing).
- Reporting screens (trial balance, JE listings) unless required for navigation entry points.

---

## 3. Actors & Stakeholders
- **Accountant/Controller (Primary)**: creates and posts manual JEs.
- **Auditor (Stakeholder)**: needs immutable records and visible audit metadata.
- **System**: enforces period status, balancing, immutability, and permissions.

---

## 4. Preconditions & Dependencies
1. User is authenticated in the frontend.
2. Authorization model is implemented in Moqui screens/actions (deny-by-default).
3. Backend exposes Accounting-owned services/endpoints for:
   - GL account lookup/search (active-only)
   - manual JE reason code lookup (active-only; scoped appropriately)
   - create+post manual JE (single atomic command preferred)
   - retrieve JE by id for post-submit view
4. Accounting period status is enforced server-side based on `postingDate` (period enforcement is backend-authoritative; UI must handle `PERIOD_CLOSED`-style errors).
5. Identifier strategy: all IDs are UUIDv7; UI validates UUID format for ID inputs (if any are user-entered).

**Dependency note:** The Accounting domain guide provided defines permissions for exports/payments/refunds/ingestion/apply-payment, but does **not** define permissions for manual journal entry adjustments. This story is blocked until the permission token(s) are specified.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Accounting → Adjustments → Manual Journal Entry → Create**
- Optional secondary entry: Accounting dashboard “Create Manual JE” action (only if dashboard exists and permission allows).

### Screens to create/modify
- **New screen**: `accounting/adjustments/manualJe/Create`
  - Form for JE header + repeating line entry grid.
- **New screen**: `accounting/adjustments/manualJe/View`
  - Read-only detail view (primarily for POSTED JEs; may also display just-created result).
- **Modify**: Accounting menu definition to add the entry point (hidden if user lacks view/create permission).

### Navigation context
- Breadcrumb: Accounting > Adjustments > Manual Journal Entry > Create
- After successful post: redirect to View screen for created JE.

### User workflows (happy + alternate paths)

**Happy path**
1. User opens Create Manual JE screen.
2. Enters `postingDate`, `description`, selects `reasonCode`.
3. Adds 2+ lines; for each line selects a GL account and enters either debit or credit amount.
4. UI shows running totals (debits, credits, difference) and blocks submit until balanced.
5. User submits “Post Journal Entry”.
6. On success, user is redirected to View screen showing JE status `POSTED`, header/lines, and audit metadata.

**Alternate paths**
- Missing header fields → inline validation; submit disabled.
- Both debit and credit entered on one line → inline validation; submit disabled.
- Unbalanced totals → submit disabled; difference shown.
- Posting date in closed period → backend rejects; UI shows error banner and keeps entered values.
- Invalid/inactive GL account (e.g., deactivated between search and submit) → backend rejects; UI shows error and highlights the affected line if backend provides per-line details.

---

## 6. Functional Behavior

### Triggers
- **Create screen load**
  - Load reason codes for manual JE adjustments (active-only).
  - Initialize form with 2 empty lines.
- **GL account search interaction**
  - Query backend for accounts matching user input (active-only).
- **Line edits**
  - Recalculate totals/difference on any debit/credit change.
- **Submit**
  - Call backend to create and post JE (atomic).

### UI actions
- Add line / remove line:
  - Remove disabled when only 2 lines remain.
- GL account selection per line:
  - Search/typeahead; do not load full chart of accounts.
- Debit/Credit inputs:
  - Decimal currency input (no floating point).
  - Mutually exclusive:
    - If user enters debit > 0, clear credit to 0.
    - If user enters credit > 0, clear debit to 0.
  - Disallow negative values.
- Submit button:
  - Disabled until all client validations pass.
  - Disabled while request in-flight to prevent double-submit.

### State changes (frontend)
- Local “draft” state for form entry only (no backend draft persistence in this story).
- On successful post:
  - Navigate to View screen with `journalEntryId` returned by backend.

### Service interactions
- Load reason codes list.
- Search/select GL accounts.
- Submit JE create+post request.
- Load JE detail for view.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
**Header**
- `postingDate` required.
- `description` required (non-empty; trim whitespace).
- `reasonCode` required.

**Lines**
- Minimum 2 lines required.
- For each line:
  - `glAccountId` required.
  - Exactly one of `debitAmount` or `creditAmount` must be **> 0**.
  - The other side must be **0** (or omitted if backend supports; UI will send 0 by default unless contract specifies otherwise).
  - Optional `memo`.

**Balanced**
- Sum(debitAmount) must equal Sum(creditAmount) exactly at currency scale.
- UI calculates:
  - `totalDebits`, `totalCredits`, `difference = totalDebits - totalCredits`
- Submit blocked unless `difference == 0`.

**Period control**
- UI does not attempt to determine open/closed periods locally unless a dedicated endpoint exists.
- Backend rejection for closed period must be surfaced with a clear message and no data loss.

**Immutability**
- View screen for `POSTED` JE is read-only.
- No edit/delete actions are rendered for `POSTED` status.
- If a user navigates to an edit route (if one exists), UI must block and show immutable message (and/or rely on backend 403/409).

### Enable/disable rules
- “Post Journal Entry” enabled only when:
  - header valid
  - at least 2 valid lines
  - totals balanced
  - user has create/post permission (token TBD)
- “Remove line” disabled when only 2 lines remain.

### Visibility rules
- Totals panel visible whenever at least one line exists (always true after initialization).
- Server error banner shown on submission failures; include backend `errorCode` (if provided) and a user-safe message.

### Error messaging expectations
Frontend must map backend error responses of canonical shape:
```json
{ "errorCode": "...", "message": "...", "details": { ... } }
```

Minimum mappings (exact `errorCode` values TBD; see Open Questions):
- Unbalanced → “Entry is not balanced. Debits must equal credits.”
- Period closed → “Posting date is in a closed accounting period. Choose a date in an open period.”
- Invalid/inactive account → “One or more selected accounts are invalid or inactive.”
- Missing required fields → “Complete all required fields before posting.”
- Permission denied (403) → “You do not have permission to post manual journal entries.”
- Immutable/posted conflict (409) → “This journal entry is posted and cannot be changed.”

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `JournalEntry` (header)
- `JournalEntryLine` (lines)
- `GLAccount` (reference/lookup)
- `ReasonCode` (reference/lookup)
- `AccountingPeriod` (enforced server-side; optionally displayed if backend returns period info)

### Fields (types, required, defaults)

#### JournalEntry (Create payload)
- `postingDate` (ISO date `YYYY-MM-DD`, required)
- `description` (string, required)
- `reasonCode` (string/enum, required)
- `lines[]` (array, required, min 2)

#### JournalEntryLine (Create payload)
- `glAccountId` (UUIDv7, required)
- `debitAmount` (decimal string, required; default `"0.00"` unless credit used)
- `creditAmount` (decimal string, required; default `"0.00"` unless debit used)
- `memo` (string, optional)

#### JournalEntry (View)
- `journalEntryId` (UUIDv7, required)
- `status` (string enum; must at least support `POSTED`)
- `postingDate` (ISO date)
- `description`
- `reasonCode` (+ optional reason label/description)
- `lines[]` with:
  - `lineId` (UUIDv7, if provided)
  - `glAccountId`, `glAccountCode`/`accountCode` (if provided), `glAccountName` (if provided)
  - `debitAmount`, `creditAmount`, `memo`
- Audit fields (if provided):
  - `createdAt`, `createdByUserId` (and optional display name)
  - `postedAt`, `postedByUserId` (if distinct)

### Read-only vs editable by state/role
- Create screen: editable only for users with create/post permission (token TBD).
- View screen:
  - `POSTED`: read-only for all users with view permission (token TBD).
  - Any other status: treat as read-only unless explicitly supported by backend contract (no edit in this story).

### Derived/calculated fields (UI-only)
- `totalDebits` = sum of debitAmount across lines (decimal arithmetic)
- `totalCredits` = sum of creditAmount across lines
- `difference` = totalDebits - totalCredits

---

## 9. Service Contracts (Frontend Perspective)

> Contract note: Unlike other Accounting workflows in the provided domain guide (exports/payments/refunds/ingestion/apply-payment), manual JE endpoints are not specified. This story is blocked until backend service names/routes and permission tokens are confirmed. The placeholders below define required capabilities and expected shapes.

### Load/view calls
1. **List reason codes for manual JE**
   - `GET /accounting/adjustments/reasonCodes?type=MANUAL_JE` (placeholder)
   - Response: `[{ reasonCode, label, active }]`
   - UI uses only active codes; if none, show blocking empty state.

2. **Search GL accounts (active-only)**
   - `GET /accounting/gl/accounts/search?query=...&active=true&pageIndex=0&pageSize=20` (placeholder)
   - Response: `[{ glAccountId, accountCode, name, active }]`
   - Must support server-side pagination; UI uses typeahead.

3. **Get journal entry detail**
   - `GET /accounting/journalEntry/detail?journalEntryId=...` (placeholder)
   - Response: `JournalEntry` with lines and audit fields.

### Create/update calls
- None (no draft save).

### Submit/transition calls
1. **Create and post manual journal entry (atomic)**
   - `POST /accounting/journalEntry/manual/post` (placeholder)
   - Request:
     ```json
     {
       "postingDate": "YYYY-MM-DD",
       "description": "string",
       "reasonCode": "string",
       "lines": [
         { "glAccountId": "uuidv7", "debitAmount": "0.00", "creditAmount": "10.00", "memo": "optional" }
       ]
     }
     ```
   - Response (minimum):
     ```json
     { "journalEntryId": "uuidv7", "status": "POSTED" }
     ```
   - Response (recommended): include full JE detail to avoid an immediate refetch.

### Error handling expectations
- Validation errors: 400/422 with `{errorCode, message, details?}`.
  - If `details` includes per-line errors, UI maps them to the corresponding line row (by index or lineId; contract must specify).
- 403: show access denied without leaking record existence.
- 404: show not found (for view screen) with safe messaging.
- 409: show conflict/immutable messaging and prompt reload.
- Network/timeouts: show retryable error; preserve form state.

---

## 10. State Model & Transitions

### Allowed states
Backend-authoritative; UI must not invent additional states. Minimum expected:
- `POSTED`

If backend returns additional states (e.g., `DRAFT`, `VOID`, `REVERSED`), UI behavior:
- Display status badge.
- Treat as read-only unless explicitly supported by this story (not supported).

### Role-based transitions
- Authorized Accountant/Controller:
  - `Create (local)` → `POSTED` via submit.
- No transitions for edit/delete in this story.

### UI behavior per state
- Create: editable, validations active.
- View:
  - `POSTED`: read-only; show immutable notice.
  - Unknown: read-only; show “This entry is not editable in this screen.”

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing header fields → inline errors; submit disabled.
- < 2 lines → show “At least two lines are required.”; submit disabled.
- Per-line:
  - missing account → line error; submit disabled.
  - both debit and credit > 0 → line error; submit disabled.
  - neither debit nor credit > 0 → line error; submit disabled.
- Unbalanced totals → totals panel shows non-zero difference; submit disabled.

### Server-side validation failures
- Show error banner with backend `message` and `errorCode`.
- If `details` contains line-specific errors:
  - Highlight the affected line(s) and show inline message(s).
- Keep user inputs intact.

### Concurrency conflicts
- If backend returns 409 due to period closure between load and submit or other state change:
  - Show conflict message and keep form values; user must resubmit after correction.

### Unauthorized access
- Entry points hidden when permission absent (if frontend can evaluate permissions).
- Direct URL access:
  - Backend 403 → show “Not authorized”.
  - Do not reveal whether a JE exists on 403/404.

### Empty states
- No reason codes configured → disable submit; show “No manual adjustment reason codes configured; contact administrator.”
- No GL accounts found for search → show “No accounts match your search.”

---

## 12. Acceptance Criteria

### Scenario 1: Successful creation and posting of a balanced manual JE
**Given** an authenticated user with permission to create and post manual journal entries  
**And** the accounting period for the selected posting date is open  
**When** the user enters a posting date, description, and selects a reason code  
**And** the user adds at least two lines with valid GL accounts  
**And** each line has exactly one of debit or credit greater than zero  
**And** the total debits equal the total credits  
**And** the user clicks “Post Journal Entry”  
**Then** the frontend submits the JE to the backend create+post endpoint  
**And** the backend returns a `journalEntryId` and `status` of `POSTED`  
**And** the user is redirected to the Journal Entry view screen for that `journalEntryId`  
**And** the view screen shows the JE as read-only with no edit/delete actions.

### Scenario 2: Client blocks posting when entry is unbalanced
**Given** an authenticated user is on the Create Manual JE screen  
**When** the user enters lines where total debits do not equal total credits  
**Then** the UI shows a non-zero difference  
**And** the “Post Journal Entry” action is disabled  
**And** the user cannot submit until the difference is zero.

### Scenario 3: Client blocks posting when a line has both debit and credit
**Given** an authenticated user is on the Create Manual JE screen  
**When** the user enters a debit amount greater than zero and a credit amount greater than zero on the same line  
**Then** the UI shows a line-level validation error  
**And** the “Post Journal Entry” action is disabled.

### Scenario 4: Server rejects posting date in a closed period
**Given** an authenticated user with permission to create and post manual journal entries  
**And** the user enters a posting date that is in a closed accounting period  
**And** the entry is otherwise valid and balanced client-side  
**When** the user clicks “Post Journal Entry”  
**Then** the backend returns a validation error indicating the period is closed  
**And** the frontend displays a user-safe error message about closed periods  
**And** the user’s entered form values remain available for correction.

### Scenario 5: Server rejects invalid or inactive GL account
**Given** an authenticated user is creating a manual JE  
**When** the user submits an entry containing a GL account that is invalid or inactive  
**Then** the backend returns an invalid-account validation error  
**And** the frontend displays an error message indicating an account is invalid/inactive  
**And** the entry is not posted.

### Scenario 6: Posted JEs are immutable in the UI
**Given** a user with permission to view journal entries navigates to a Journal Entry that is `POSTED`  
**When** the Journal Entry view loads  
**Then** all fields are displayed read-only  
**And** no UI actions to edit or delete the JE are present.

---

## 13. Audit & Observability

### User-visible audit data
On the JE View screen display (if provided by backend):
- `journalEntryId` (copyable)
- `status`
- `postingDate`
- `createdAt`, `createdByUserId` (and display name if provided)
- `postedAt`, `postedByUserId` (if provided)
- `reasonCode` (and label if provided)

### Status history
- Not required unless backend provides a status history collection.
- If provided, show immutable history table: `status`, `changedAt`, `changedBy`.

### Traceability expectations
- UI must surface `journalEntryId` on success.
- Do not log line memos or other potentially sensitive free-text in client logs.
- If the platform supports W3C Trace Context, propagate `traceparent`/`tracestate` headers on all calls (consistent with workspace standards).

---

## 14. Non-Functional UI Requirements
- **Performance**: GL account lookup must be server-side searchable; do not load full CoA.
- **Accessibility**: All form controls labeled; errors associated to fields; keyboard operable line grid; error summary/banner announced via aria-live.
- **Responsiveness**: Works on typical POS tablet widths; line-entry table may scroll horizontally.
- **i18n/timezone/currency**:
  - `postingDate` uses locale-friendly input but submits ISO date.
  - Currency display/formatting must match backend-provided currency context (currency source for manual JE is not defined in provided accounting rules; do not assume).

---

## 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE-01**: Provide explicit empty-state messaging for missing reason codes / no GL accounts found; qualifies as safe UI ergonomics; impacts UX Summary, Alternate / Error Flows.
- **SD-UX-SEARCH-LOOKUP-01**: Use typeahead/search for GL account selection to avoid large payloads; qualifies as safe performance/ergonomics; impacts UX Summary, Service Contracts.
- **SD-ERR-MAP-01**: Standard mapping of backend validation/permission errors to inline/banner UI messages using `{errorCode,message,details}`; qualifies as safe error-handling boilerplate; impacts Business Rules, Alternate / Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. **Backend/Moqui contract (blocking):** What are the exact Moqui service names and REST endpoints for:
   - reason code list for manual JE (`type=MANUAL_JE` or equivalent),
   - GL account search (including pagination params and returned fields),
   - create+post manual JE (atomic command),
   - JE retrieval by id (detail view)?
2. **Permissions (blocking):** What are the authoritative permission tokens for:
   - viewing manual JE screens (create/view),
   - posting manual JEs (mutation)?
   (The provided Accounting domain guide does not define adjustment/JE permissions; must be added or referenced.)
3. **Reason code source/scope (blocking):** Is `reasonCode` sourced from an Accounting-owned entity, and is it scoped by business unit/legal entity? Must the UI filter by business unit?
4. **Currency context (blocking):** What currency applies to manual JEs (legal entity/base currency), and what scale/rounding rules should the UI enforce for amount inputs? (UI must not assume.)
5. **Line amount payload shape (blocking):** Does backend require both `debitAmount` and `creditAmount` fields always present (with `"0.00"`), or does it accept omission/null for the unused side?
6. **Error code taxonomy (blocking):** What exact `errorCode` values will backend return for:
   - unbalanced,
   - period closed,
   - invalid/inactive account,
   - missing required fields,
   - permission denied,
   - immutable/posted conflict,
   and does `details` support per-line errors (and how are lines identified: index vs lineId)?
7. **Draft vs post (non-blocking but impacts UX):** Is there a backend-supported `DRAFT` JE state and “Save Draft” endpoint planned? If yes, should this story include it or remain create+post only?
8. **Idempotency (blocking):** Does the create+post endpoint support an idempotency key to prevent double-posting on retry/timeouts? If yes, what is the field/header name and expected behavior on duplicate submissions?

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] Adjustments: Create Manual Journal Entry with Controls  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/190  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Adjustments: Create Manual Journal Entry with Controls

**Domain**: user

### Story Description

/kiro
# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## Capability
[CAP] Period Close, Adjustments, and Reporting

## Story
Adjustments: Create Manual Journal Entry with Controls

## Acceptance Criteria
- [ ] Authorized users can create manual JEs with reason code
- [ ] System blocks unbalanced manual JEs
- [ ] Posted manual JEs are immutable (corrections via reversal)
- [ ] Posting respects period controls and audit requirements


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

════════════════════════════════════════
ISSUE #187: [FRONTEND] [STORY] Reconciliation: Support Bank/Cash Reconciliation Matching
LABELS: domain:accounting,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:accounting-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Reconciliation: Bank/Cash Reconciliation Matching (Import/Enter Statement Lines, Match, Adjust, Finalize & Report)

### Primary Persona
Accountant (or Finance Manager acting as accountant)

### Business Value
Ensure cash/bank balances are accurate and auditable by matching bank statement activity to recorded POS payments/receipts, recording controlled adjustments (fees/interest) with correct accounting traceability, and producing a finalized reconciliation report.

---

## 2. Story Intent

### As a / I want / So that
**As an** Accountant,  
**I want** a reconciliation workspace to import or manually enter bank/cash statement lines and match them to system-recorded payments/receipts (or create controlled adjustments),  
**so that** I can reconcile a bank/cash account for a period with a complete audit trail and produce a finalized reconciliation report.

### In-scope
- Create a reconciliation for a selected bank/cash account and date range.
- Import statement lines (file upload) and/or manually enter statement lines.
- View unreconciled system transactions and match/unmatch to statement lines (manual; suggestions optional but not required unless backend provides).
- Create controlled adjustments (fees/interest) that generate proper accounting entries (frontend flow + validations + submission).
- Track matched/unmatched counts and reconciliation difference and prevent finalization if non-zero.
- Finalize reconciliation (immutability/read-only behavior).
- Generate/download a reconciliation report (or navigate to report screen) after finalization.
- Full audit visibility (who/when) for reconciliation actions.

### Out-of-scope
- Defining GL account mappings, posting rules, or journal entry debit/credit structure (owned by accounting backend configuration).
- Automated matching tolerance rules or auto-match heuristics unless explicitly provided by backend.
- Re-opening finalized reconciliations (explicitly disallowed by provided reference).
- Multi-currency reconciliation behavior (unless backend contract explicitly supports it).
- Bank connectivity / live bank feeds.

---

## 3. Actors & Stakeholders
- **Accountant (Primary):** Performs reconciliation, matching, adjustments, finalization, report.
- **Auditor (Secondary):** Reviews finalized reconciliation and audit trail.
- **Finance Admin (Secondary):** Ensures bank accounts and GL accounts exist (configuration outside this story’s UI unless already present in app).
- **Payment/Receipt Domain (Data Provider):** Supplies reconcilable transactions for matching (read-only from frontend perspective).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- User has permission to access reconciliation features and to create adjustments and finalize reconciliations (**permissions are not defined in Accounting domain guide; see Open Questions**).
- At least one bank/cash account exists and is selectable.
- Backend supports persistence and retrieval of reconciliations, statement lines, matches, adjustments, and report generation.

### Dependencies (blocking where unknown)
- **Backend API contracts** for:
  - Creating/loading reconciliations, listing statement lines, listing reconcilable system transactions.
  - Performing match/unmatch operations.
  - Creating adjustments (fees/interest) and resulting journal entry creation/posting behavior.
  - Finalization rules and report generation/download.
- **Supported import formats** and parsing rules (CSV/OFX/etc.).
- **GL account selection source** for adjustments (list/search endpoint).
- **Audit event visibility** (what endpoint returns history).
- **Authorization model**: exact permission tokens for reconciliation (view/create/edit/finalize/report).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Accounting → Reconciliation → Bank/Cash Reconciliation**
- Deep link (if supported): `/accounting/reconciliation` (list) and `/accounting/reconciliation/{reconciliationId}` (detail workspace)

### Screens to create/modify (Moqui)
1. **`Accounting/Reconciliation/ReconciliationList.xml`** (new)
   - List prior reconciliations with filters (account, date range, status).
   - Action: “Start Reconciliation”.

2. **`Accounting/Reconciliation/ReconciliationCreate.xml`** (new)
   - Form: select `bankAccountId`, `periodStartDate`, `periodEndDate` (and optionally `statementClosingBalance` if required by backend).
   - Create action transitions to detail workspace.

3. **`Accounting/Reconciliation/ReconciliationDetail.xml`** (new)
   - Workspace with:
     - Reconciliation header (account, period, opening/closing balance fields as read-only unless backend allows edits).
     - Sections:
       - Statement Lines (import/enter, matched/unmatched, select line)
       - System Transactions (unreconciled payments/receipts, select txn)
       - Matches (view/remove)
       - Adjustments (create/view)
       - Audit Trail (view events)
     - Primary actions: Import Statement, Add Statement Line, Match, Unmatch, Create Adjustment, Finalize, Download Report (enabled by state + permissions).

4. **`Accounting/Reconciliation/ReconciliationReport.xml`** (optional new)
   - If report is rendered as a screen; otherwise “Download” triggers file response.

### Navigation context
- Breadcrumb: Accounting > Reconciliation > {Bank Account Name} > {Period}
- Back to list from detail.

### User workflows (happy + alternate paths)
- **Happy path**
  1. Create reconciliation (Draft).
  2. Import statement lines (or manually enter).
  3. Load unreconciled system transactions.
  4. Select statement line + transaction(s) → Match.
  5. For lines without system transactions → Create Adjustment → line becomes matched.
  6. Difference becomes zero → Finalize.
  7. Download/view report.

- **Alternate paths**
  - Manual entry only (no import).
  - Unmatch and re-match when a mistake is found (Draft only).
  - Many-to-one match (multiple system txns match one statement line) **only if backend supports** (Open Question).
  - One-to-many match (one system txn matched to multiple statement lines) **unknown** (Open Question).
  - Partial matching / split amounts **unknown** (Open Question).
  - Unable to finalize due to non-zero difference; user continues matching/adjusting.

---

## 6. Functional Behavior

### Triggers
- User starts reconciliation from list.
- User imports statement file or adds statement line manually.
- User matches/unmatches.
- User creates adjustment.
- User finalizes reconciliation.
- User requests report.

### UI actions & expected system behavior

#### 6.1 Create reconciliation
- UI submits create form.
- On success, navigate to reconciliation detail workspace in **DRAFT**.

Client-side validation:
- `periodEndDate >= periodStartDate` (inclusive).
- `bankAccountId` required.
- If `statementClosingBalance` is required by backend contract, enforce required + numeric.

#### 6.2 Import statement lines
- User selects file and submits.
- UI shows import progress and results summary (imported count, failed count, failure reasons).
- Imported lines appear in Statement Lines list with status **UNMATCHED** by default.

Constraints:
- Import is disabled when reconciliation is not editable (non-DRAFT).
- UI must not log file contents.

#### 6.3 Manually enter statement line
- User opens “Add Statement Line” modal/form.
- Required fields validated client-side:
  - `transactionDate` required
  - `description` required
  - amount model per backend (Open Question: signed vs direction+amount)
- On save, line appears in Statement Lines list as **UNMATCHED**.

#### 6.4 Load unreconciled system transactions
- UI loads a list filtered by:
  - `bankAccountId` (or backend mapping key)
  - `periodStartDate..periodEndDate`
  - unreconciled only
- Transactions display key match fields: date, amount, reference, counterparty/payer/payee if available, `systemTransactionId`.

Constraints:
- UI must treat these as read-only projections; no mutation of payment/receipt records in this story.

#### 6.5 Match / unmatch
- **Match** action enabled when:
  - reconciliation is DRAFT
  - user has match permission (Open Question)
  - selection meets backend-supported cardinality rules (Open Question)
- UI submits match command; on success:
  - statement line(s) status becomes MATCHED
  - system transaction(s) marked matched/cleared within this reconciliation (and excluded from “unreconciled” list)
  - reconciliation header fields refresh from backend (difference/balances/counts)

- **Unmatch** action enabled when:
  - reconciliation is DRAFT
  - user has match permission (Open Question)
  - a selected match record exists
- UI submits unmatch command; on success:
  - items return to UNMATCHED/unreconciled pools
  - reconciliation header refreshes from backend

#### 6.6 Create adjustment (fee/interest)
- From a statement line (typically UNMATCHED), user chooses “Create Adjustment”.
- UI presents adjustment form:
  - `adjustmentType` (if backend provides enum/list; otherwise omit and rely on description) (**Open Question**)
  - `glAccountId` (required)
  - `amount` (required; default to statement line amount)
  - `description` (required if backend requires; otherwise optional but recommended)
  - `statementLineId` (pre-filled, read-only)
- On submit:
  - backend creates adjustment and returns posting reference(s) (at least `journalEntryId` if available)
  - statement line becomes MATCHED (backend-authoritative)
  - adjustment appears in Adjustments list with `journalEntryId` link (if provided)

Accounting period enforcement:
- If backend rejects due to closed period (Decision AD-012), UI must surface backend error code/message and keep reconciliation in DRAFT.

#### 6.7 Finalize
- Finalize action enabled only when:
  - reconciliation is DRAFT
  - user has finalize permission (Open Question)
  - backend-provided `difference == 0.00` (do not compute locally)
- On finalize success:
  - status becomes FINALIZED
  - all mutation actions disabled (import, add line, match/unmatch, create adjustment)
  - report actions enabled (download/view)
  - audit shows finalization event with user and timestamp.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Finalization gating:** cannot finalize unless backend-provided `difference == 0.00`.
- **Adjustment required fields:** `glAccountId` required; `amount` required; `statementLineId` required for “create adjustment from line” flow.
- **Date range validation:** inclusive; `endDate >= startDate` for list filters and create form.
- **Identifier validation:** if backend uses UUIDs for reconciliation IDs and line IDs, UI should validate UUID format for any direct-ID search fields. (UUIDv7 is normative for Accounting domain entities per AD-006, but reconciliation entities are not defined in provided Accounting guide; treat as unknown until backend confirms.)

### Enable/disable rules
- If status == `FINALIZED`:
  - All editing and command actions disabled.
  - Screen is read-only.
- Match/unmatch/adjustment actions disabled when required selections missing.
- Import disabled when no `reconciliationId` exists (must create first).

### Visibility rules
- Show matched vs unmatched filters for statement lines and system transactions.
- Show audit trail section always; if backend doesn’t provide, show “Audit unavailable” with safe error message.

### Error messaging expectations
- Import parsing errors must show:
  - file-level error (unsupported format) OR
  - row-level errors (line number + reason)
- Finalize attempt with non-zero difference must show:
  - “Reconciliation cannot be finalized with a non-zero difference.” (use backend message if provided; otherwise this exact string)
- Unauthorized operations show “You do not have permission to perform this action.” without leaking record existence (Decision AD-013 principle).

---

## 8. Data Requirements

### Entities involved (frontend view models)
> Exact entity names may differ; use Moqui services/entities as implemented by backend. Frontend must not assume entity schema beyond contracts returned.

- `Reconciliation`
- `BankStatementLine`
- `ReconciliationMatch`
- `ReconciliationAdjustment`
- `SystemTransaction` (from payment/receipt domain; read-only projection)
- `GLAccount` (for adjustment selection)
- `ReconciliationAuditEvent` (or generic audit log)

### Fields (type, required, defaults)

#### Reconciliation
- `reconciliationId` (string, required, read-only)
- `bankAccountId` (string, required, read-only after create)
- `periodStartDate` (date, required, read-only after create)
- `periodEndDate` (date, required, read-only after create)
- `openingBalance` (decimal, read-only; backend)
- `statementClosingBalance` (decimal, **unknown if required**; backend)
- `bookClosingBalance` (decimal, read-only; backend)
- `difference` (decimal, read-only; backend)
- `status` (`DRAFT`|`FINALIZED`, read-only)
- `finalizedAt` (datetime, read-only)
- `finalizedByUserId` (string, read-only)

#### BankStatementLine
- `statementLineId` (string, read-only)
- `transactionDate` (date, required)
- `description` (string, required)
- `amount` (decimal, required)
- `direction` (`DEBIT`|`CREDIT` OR signed amount; **TBD**)
- `status` (`UNMATCHED`|`MATCHED`, read-only except via match/unmatch/adjustment commands)
- `reference` (string, optional)

#### SystemTransaction (reconcilable payment/receipt)
- `systemTransactionId` (string, read-only)
- `transactionDate` (date/datetime, read-only)
- `amount` (decimal, read-only)
- `type` (string/enum, optional)
- `reference` (string, optional)
- `counterpartyName` (string, optional)
- `reconciliationStatus` (string/enum, read-only)

#### ReconciliationMatch
- `matchId` (string, read-only)
- `statementLineId` (string, required)
- `systemTransactionId` (string, required)
- `createdAt`, `createdByUserId` (read-only)

#### ReconciliationAdjustment
- `adjustmentId` (string, read-only)
- `statementLineId` (string, required in this UX path)
- `glAccountId` (string, required)
- `amount` (decimal, required)
- `description` (string, optional/required TBD)
- `adjustmentType` (string/enum, optional; TBD)
- `journalEntryId` (string, read-only; primary posting reference if provided per AD-011 pattern)
- `createdAt`, `createdByUserId` (read-only)

### Read-only vs editable by state/role
- Draft: statement lines editable only via create/import; match/unmatch and adjustments allowed.
- Finalized: all above are read-only.
- Role-based editing depends on permissions (Open Question).

### Derived/calculated fields
- `difference` and balances are backend-calculated authoritative values; UI must not compute financial difference beyond display formatting.

---

## 9. Service Contracts (Frontend Perspective)

> Accounting domain guide provides canonical endpoint families for exports/payments/refunds/ingestion/apply-payment, but **does not define reconciliation endpoints**. This story requires new backend contracts or confirmation of existing ones. Frontend must not invent schemas.

### Load/view calls (required capabilities)
- `GET /accounting/reconciliation/list`
  - Params: `bankAccountId?`, `status?`, `periodStartFrom?`, `periodEndTo?`, `pageIndex`, `pageSize`, `orderBy`
  - Returns: list of reconciliation summaries

- `GET /accounting/reconciliation/detail?reconciliationId=...`
  - Returns: reconciliation header + computed fields + counts (if provided)

- `GET /accounting/reconciliation/statementLines?reconciliationId=...`
  - Params: `status?`, pagination
  - Returns: statement line list

- `GET /accounting/reconciliation/systemTransactions?reconciliationId=...`
  - Params: pagination, filters (date range optional if reconciliation already defines it)
  - Returns: reconcilable system transactions list (unreconciled by default)

- `GET /accounting/reconciliation/matches?reconciliationId=...`
- `GET /accounting/reconciliation/adjustments?reconciliationId=...`
- `GET /accounting/reconciliation/audit?reconciliationId=...`

- `GET /accounting/glAccounts/search`
  - Params: `q`, `activeOnly=true`, `pageIndex`, `pageSize`

### Create/update calls (required capabilities)
- `POST /accounting/reconciliation/create`
  - Body: `{ bankAccountId, periodStartDate, periodEndDate, statementClosingBalance? }`
  - Returns: `{ reconciliationId }`

- `POST /accounting/reconciliation/statementLines/create`
  - Body: `{ reconciliationId, transactionDate, description, amount, direction? | signedAmount?, reference? }`
  - Returns: created line

- `POST /accounting/reconciliation/statementLines/import`
  - Multipart: `{ reconciliationId, file, format? }`
  - Returns: `{ importedCount, failedCount, failures:[{rowNumber, errorCode?, message}] }`

### Submit/transition calls (required capabilities)
- `POST /accounting/reconciliation/match`
  - Body: `{ reconciliationId, statementLineIds:[...], systemTransactionIds:[...], requestId? }`
  - Returns: updated statuses + updated reconciliation computed fields

- `POST /accounting/reconciliation/unmatch`
  - Body: `{ reconciliationId, matchIds:[...] }` (or `{statementLineId, systemTransactionId}` pairs)
  - Returns: updated statuses + updated reconciliation computed fields

- `POST /accounting/reconciliation/adjustments/create`
  - Body: `{ reconciliationId, statementLineId, glAccountId, amount, description?, adjustmentType? }`
  - Returns: `{ adjustmentId, journalEntryId?, reconciliation:{...updated fields...}, statementLine:{...updated...} }`

- `POST /accounting/reconciliation/finalize`
  - Body: `{ reconciliationId }`
  - Returns: updated reconciliation

- `GET /accounting/reconciliation/report/download?reconciliationId=...`
  - Returns: binary file stream (PDF/CSV) OR a `{downloadUrl}` (Open Question)

### Error handling expectations
- Use canonical error shape from Accounting guide when backend supports it:
  - `{ errorCode, message, details? }`
- Map:
  - 400/422 → inline errors (field-level) and/or row-level import failures
  - 401/403 → access denied (no existence leak)
  - 404 → not found (safe message)
  - 409 → conflict/stale update; prompt refresh and reload detail
  - 5xx/timeouts → retry affordance; preserve user selections/filters

---

## 10. State Model & Transitions

### Allowed states
- `DRAFT`
- `FINALIZED`

### Role-based transitions
- `DRAFT -> FINALIZED` requires explicit permission (Open Question).
- No transitions out of `FINALIZED` (immutable).

### UI behavior per state
- **DRAFT**
  - Editable workspace; actions enabled as per selection rules and permissions.
  - Show backend-provided `difference` and counts.
- **FINALIZED**
  - Read-only; show finalized metadata; allow report download/view and audit review.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required fields on create reconciliation: show inline errors.
- Import file missing/unsupported: show file-level error and keep prior data unchanged.
- Create adjustment without `glAccountId`: prevent submit; if backend rejects, show returned validation.
- Match attempt with invalid selection/cardinality: show backend validation error and keep selections.

### Concurrency conflicts
- If match/unmatch/adjustment/finalize fails due to concurrent update (optimistic lock / stale status):
  - UI reloads reconciliation detail and lists, and shows: “This reconciliation was updated by another user. Please review the latest status.”

### Unauthorized access
- If user lacks permission for create/match/adjust/finalize/report:
  - Hide/disable action buttons when permission flags are known.
  - If backend rejects, show access denied and keep UI state unchanged.

### Empty states
- No statement lines: show “No statement lines yet. Import a file or add one manually.”
- No reconcilable system transactions: show “No unreconciled transactions found for this period/account.”
- No matches/adjustments: show empty placeholders with guidance.

---

## 12. Acceptance Criteria

### Scenario 1: Create a draft reconciliation
**Given** I am an authenticated Accountant with permission to create reconciliations  
**When** I start a new reconciliation and select a bank/cash account and a period start and end date (end date on or after start date)  
**Then** a new reconciliation is created in `DRAFT` status  
**And** I am navigated to the reconciliation detail workspace showing the selected account and period.

### Scenario 2: Import bank statement lines successfully
**Given** I have a `DRAFT` reconciliation  
**When** I upload a supported bank statement file for that reconciliation  
**Then** the system imports statement lines and displays them as `UNMATCHED` statement lines  
**And** any line-level import failures are listed with row numbers and reasons without importing invalid lines.

### Scenario 3: Manually add a statement line
**Given** I have a `DRAFT` reconciliation  
**When** I add a statement line with a transaction date, description, and amount using the backend-defined amount model  
**Then** the new statement line appears in the statement lines list as `UNMATCHED`.

### Scenario 4: Match a statement line to a system transaction (1-to-1)
**Given** I have a `DRAFT` reconciliation with an imported statement line of amount 55.50 on 2026-07-10  
**And** the system shows an unreconciled system transaction of amount 55.50 on 2026-07-10  
**When** I select the statement line and the system transaction and perform “Match”  
**Then** the statement line is marked `MATCHED`  
**And** the system transaction is no longer shown as unreconciled for this reconciliation  
**And** the reconciliation `difference` shown in the header is refreshed from backend-calculated values.

### Scenario 5: Create an adjustment and auto-match the line
**Given** I have a `DRAFT` reconciliation with an unmatched statement line described as “Monthly Service Fee”  
**When** I choose “Create Adjustment” for that statement line  
**And** I select a GL account and submit the adjustment with the amount equal to the statement line amount  
**Then** an adjustment is created and listed under Adjustments  
**And** the adjustment includes a `journalEntryId` reference when provided by the backend  
**And** the statement line is marked `MATCHED`.

### Scenario 6: Prevent finalize when difference is non-zero
**Given** I have a `DRAFT` reconciliation where the displayed backend-provided `difference` is not 0.00  
**When** I attempt to finalize the reconciliation  
**Then** the finalize action is rejected  
**And** I see an error message indicating finalization is not allowed with a non-zero difference  
**And** the reconciliation remains in `DRAFT` status.

### Scenario 7: Finalize when difference is zero and enforce immutability
**Given** I have a `DRAFT` reconciliation where the displayed backend-provided `difference` is 0.00  
**When** I finalize the reconciliation  
**Then** the reconciliation status becomes `FINALIZED`  
**And** importing, adding statement lines, matching, unmatching, and creating adjustments are no longer available  
**And** I can download or view the reconciliation report.

### Scenario 8: Unauthorized user cannot mutate reconciliation
**Given** I am an authenticated user without permission to finalize reconciliations  
**And** I am viewing a `DRAFT` reconciliation  
**When** I attempt to finalize the reconciliation  
**Then** the action is denied (403)  
**And** the UI shows an access denied message without revealing additional record details  
**And** the reconciliation remains unchanged.

### Scenario 9: Conflict handling on stale data
**Given** I have a `DRAFT` reconciliation open in my browser  
**And** another user matches a statement line in the same reconciliation  
**When** I attempt to match a different statement line using stale data  
**And** the backend returns a conflict (409)  
**Then** the UI prompts me to reload  
**And** after reload I see the updated matches and updated `difference`.

---

## 13. Audit & Observability

### User-visible audit data
In the reconciliation detail screen, provide an Audit Trail view that lists, at minimum:
- event type (Created, Statement Imported, Statement Line Added, Matched, Unmatched, Adjustment Created, Finalized)
- timestamp
- actor (userId/displayName if available)
- related entity references (statementLineId, systemTransactionId, adjustmentId, matchId, journalEntryId if present)

### Status history
- Reconciliation status transitions visible with `finalizedAt` and `finalizedBy`.

### Traceability expectations
- UI displays identifiers (copyable):
  - `reconciliationId`, `statementLineId`, `matchId`, `adjustmentId`, `journalEntryId` (if present)
- Propagate W3C Trace Context headers (`traceparent`, `tracestate`) on all calls (Decision AD-008).
- UI must not log raw imported statement content or any raw payloads.

---

## 14. Non-Functional UI Requirements

- **Performance:** Lists (statement lines, system transactions) must use server-side pagination; avoid loading all rows at once.
- **Accessibility:** All actions accessible via keyboard; forms have labels; errors announced and associated to inputs.
- **Responsiveness:** Usable on tablet widths; matching UI may stack vertically on small screens.
- **i18n/timezone/currency:** Display dates in user locale; display amounts using backend-provided `currencyUomId` if present. If not provided, show amounts as plain decimals without assuming a currency symbol (Open Question: currency contract).

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATES: Added explicit empty-state messages for no data in lists; qualifies as safe because it affects only UX guidance and not business policy. Impacted sections: UX Summary, Alternate / Error Flows.
- SD-UI-PAGINATION: Require server-side pagination/virtualization for potentially large lists; safe because it’s UI ergonomics and does not change domain rules. Impacted sections: Non-Functional UI Requirements, UX Summary, Service Contracts.
- SD-ERROR-GENERIC-MAPPING: Display backend `message` and retain `errorCode` for support; safe because it doesn’t invent business logic and preserves authoritative backend messaging. Impacted sections: Service Contracts, Error Flows, Acceptance Criteria.
- SD-OBS-TRACE-PROPAGATION: Propagate `traceparent`/`tracestate` headers unchanged; safe because it is observability boilerplate and does not alter business behavior. Impacted sections: Audit & Observability, Service Contracts.

---

## 16. Open Questions

1. **Permissions/authorization (blocking):** What are the exact permission tokens for reconciliation:
   - view list/detail
   - create reconciliation
   - import statement lines
   - create statement line
   - match/unmatch
   - create adjustment
   - finalize
   - view/download report
   (Accounting domain guide defines permissions for exports/payments/refunds/ingestion/apply-payment, but not reconciliation.)

2. **Backend endpoints & schemas (blocking):** Confirm the reconciliation endpoint family and request/response schemas (list/detail/statementLines/systemTransactions/match/unmatch/adjustments/finalize/report/audit). The story currently proposes `/accounting/reconciliation/*` as placeholders.

3. **Import formats & parsing rules (blocking):** Which statement formats are supported (CSV/OFX/BAI2)? If CSV:
   - required columns
   - date format(s)
   - amount model (signed vs debit/credit columns)
   - header row handling
   - encoding rules

4. **Statement line amount model (blocking):** Does backend represent statement line amounts as:
   - signed `amount` (negative for debit), or
   - `amount` + `direction` (`DEBIT`/`CREDIT`)?
   This affects manual entry validation and display.

5. **Matching cardinality & partials (blocking):** Are matches:
   - strictly 1-to-1, or
   - many system transactions → one statement line allowed, and if so must amounts sum exactly?
   - one system transaction → many statement lines allowed?
   - partial matching/splits allowed?
   UI must enforce selection rules consistent with backend.

6. **Closing/ending balance inputs (blocking):** Is `statementClosingBalance` required at create time or before finalize? Is it editable in DRAFT? Is `openingBalance` derived or user-entered?

7. **Adjustment types & defaults (non-blocking unless required by backend):** Does backend provide `adjustmentType` enums and default GL accounts per type, or is GL account always manually selected?

8. **Report contract (blocking):** Is the reconciliation report:
   - downloadable file (PDF/CSV), with filename/content-type rules, or
   - rendered screen?
   What minimum contents are required (header balances, matched items, adjustments, audit summary)?

9. **Reconcilable system transactions contract (blocking):** What is the authoritative source and filtering logic for “reconcilable system transactions” for a bank/cash account? What fields are guaranteed (date, amount, reference, counterparty)?

10. **Currency handling (blocking):** Is reconciliation single-currency per bank account? Will backend return `currencyUomId` on reconciliation and statement lines for formatting and validation?

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] Reconciliation: Support Bank/Cash Reconciliation Matching  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/187  
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Reconciliation: Support Bank/Cash Reconciliation Matching

**Domain**: payment

### Story Description

/kiro
# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## Capability
[CAP] Reconciliation, Audit, and Controls

## Story
Reconciliation: Support Bank/Cash Reconciliation Matching

## Acceptance Criteria
- [ ] Import/enter bank statement lines and match to payments/receipts
- [ ] Track matched/unmatched items with audit trail
- [ ] Allow controlled adjustments (fees/interest) via proper entries
- [ ] Produce reconciliation report


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

════════════════════════════════════════
ISSUE #183: [FRONTEND] [STORY] Accounting: Ingest WorkCompleted Event
LABELS: domain:accounting,frontend,story-implementation,user,type:story,status:draft,blocked:clarification,risk:incomplete-requirements
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Accounting: Ingest WorkCompleted Event (Ops UI for Monitoring, Replay, and Workorder Invoice-Eligibility)

### Primary Persona
Accounting Operations User (Back-office accountant / accounting ops) who monitors accounting event ingestion and resolves failures.

### Business Value
Ensure `WorkCompleted` events are ingested reliably and are traceable/auditable so WIP finalization (if enabled) and workorder invoice-eligibility are correctly applied, reducing billing delays and preventing duplicate/invalid financial processing.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Accounting Operations User  
- **I want** a UI to view the status of ingested `WorkCompleted` events (including validation errors, duplicates, and processing outcomes) and to safely retry/replay failed events  
- **So that** completed workorders become invoice-eligible on time and ingestion problems can be triaged without engineering intervention.

### In-scope
- Moqui screens to:
  - List and filter `WorkCompleted` ingestion records.
  - View a single ingestion record details (payload envelope, validation results, processing outcome).
  - Trigger an operator-initiated **retry/reprocess** action for eligible failed records (subject to permissions).
- UI handling of backend error codes and status mapping (validation/duplicate/not-found/WIP failure).
- Audit/observability display fields (processed timestamps, correlation/event IDs, outcome reason).

### Out-of-scope
- Implementing the actual ingestion processor/business logic (backend-owned).
- Defining GL account mappings, journal entry lines, or posting semantics in the UI.
- Building/altering the canonical event schema (contract owned elsewhere).
- Creating AR, invoices, or revenue recognition flows.

---

## 3. Actors & Stakeholders

- **Accounting Operations User (Primary human actor):** monitors ingestion, investigates failures, initiates retries.
- **System (Accounting Ingestion Service):** produces ingestion status records and exposes APIs consumed by UI.
- **Work Execution domain/system:** upstream producer of `WorkCompleted` events (context only).
- **Billing domain/system:** downstream consumer of “invoice-eligible” status (context only).
- **Audit/Compliance stakeholder:** needs traceability (who retried what, when, why).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend and has access to Accounting module navigation.
- Backend exposes endpoints/services to:
  - Search ingestion records by filters.
  - Retrieve ingestion record details by ID.
  - Trigger retry/reprocess (operator action) for a specific ingestion record.

### Dependencies (Blocking if absent)
- The **backend contract** for ingestion records and retry is not defined in the provided inputs (only a backend story reference exists and is itself blocked). Frontend cannot be finalized without:
  - Entity/DTO field names
  - Status enums
  - Error code taxonomy
  - Retry eligibility rules
  - Authorization permission(s)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main app nav: **Accounting → Event Ingestion → WorkCompleted** (or **Accounting → Events → Ingestion** if that’s the established pattern).

### Screens to create/modify
1. **Screen:** `apps/pos/accounting/events/WorkCompletedIngestionList.xml`
   - Search/list view for ingestion records.
2. **Screen:** `apps/pos/accounting/events/WorkCompletedIngestionDetail.xml`
   - Detail view for a single ingestion record with actions (retry) and payload inspection.

> Note: Exact screen path must match repo conventions; adjust to the project’s existing screen root and menu structure once confirmed.

### Navigation context
- From list → click row → detail screen
- From detail → back to list preserving prior filters (via URL parameters or session-saved search)

### User workflows
#### Happy path (monitoring)
1. User opens list screen.
2. Filters by date range and status = `FAILED` (or equivalent).
3. Opens a record; reviews reason and payload.
4. If eligible, clicks **Retry**.
5. UI shows confirmation, submits retry, shows updated status (e.g., `RETRY_QUEUED` / `PROCESSING` / `SUCCEEDED`).

#### Alternate paths
- View `DUPLICATE` records (idempotency) and understand they are not retried.
- View `WORKORDER_NOT_FOUND` failures and optionally retry after upstream data issue is resolved.
- View `VALIDATION_ERROR` and see it is not retryable (unless policy allows manual override—currently unknown).

---

## 6. Functional Behavior

### Triggers
- User navigates to list screen.
- User selects a record to view details.
- User initiates retry action.

### UI actions
- **List Screen**
  - Filter controls:
    - `status` (single-select or multi-select)
    - `occurredAt` date/time range
    - `workorderId` (text)
    - `eventId` (text)
    - `sourceModule` (text)
  - Table columns (minimum):
    - occurredAt
    - eventId
    - workorderId
    - status
    - reasonCode / errorCode (if any)
    - processedAt (if any)
  - Row click navigates to detail.

- **Detail Screen**
  - Summary panel:
    - eventId, eventType, schemaVersion, occurredAt
    - workorderId, businessUnitId, currencyUomId
    - processingStatus, processedAt, attemptCount
    - lastErrorCode, lastErrorMessage (sanitized)
  - Payload viewer:
    - read-only formatted JSON (collapsed by default)
  - Actions:
    - **Retry/Reprocess** button visible only when record is retry-eligible and user has permission.
    - Confirmation dialog requiring “Reason for retry” (if required by audit policy—currently unclear).

### State changes (frontend-observed)
- After retry submission, record status should transition to a queued/processing status or immediately re-evaluated. UI must refresh the record.

### Service interactions
- `searchIngestionRecords` (list)
- `getIngestionRecord` (detail)
- `retryIngestionRecord` (action)
- Optional: `getConfig` for WIP flag display (read-only), if exposed.

---

## 7. Business Rules (Translated to UI Behavior)

> Business rules provided are primarily backend semantics; UI must reflect them safely without inventing accounting policies.

### Validation
- Filters:
  - Date range: `from <= to`; show inline validation error.
  - `eventId` format: if UUID required, validate format client-side (optional) and server-side (authoritative).
- Retry action:
  - Must require confirmation.
  - Must block action while request in-flight to prevent double-submit.
  - Must show backend error codes and messages if retry rejected.

### Enable/disable rules
- Retry button enabled only if:
  - Record status is in a retryable terminal state (e.g., `FAILED_RETRYABLE`) **(needs clarification)**.
  - User has required permission (e.g., `accounting:events:retry`) **(needs clarification)**.

### Visibility rules
- Show WIP-related processing outcome fields only if present in record (do not assume WIP enabled/disabled unless explicitly provided).
- Do not expose sensitive/internal stack traces; display sanitized error message.

### Error messaging expectations
Map backend errors to user-facing messages (do not guess missing codes; see Open Questions). At minimum:
- Validation failure: “Event payload failed validation; cannot be processed.”
- Not found: “Workorder referenced by event was not found.”
- Duplicate conflict: “Duplicate event ID detected; already processed or conflicting payload.”
- WIP reconciliation failure: “WIP reconciliation failed; retry may be available.”

---

## 8. Data Requirements

### Entities involved (frontend-facing)
Because authoritative entity names are not provided, define placeholders to be replaced with actual Moqui entities/services:

- `AccountingEventIngestion` (or similar): ingestion record for canonical accounting events.
- `AccountingEventIngestionAttempt` (optional): per-attempt history.
- Related reference data:
  - Workorder reference (read-only link by `workorderId`), if a screen exists.

### Fields (type, required, defaults)
**Ingestion Record (minimum set)**
- `ingestionId` (string/UUID, required, read-only)
- `eventId` (UUID, required, read-only)
- `eventType` (string, required, read-only) — expected `WorkCompleted`
- `schemaVersion` (string, required, read-only)
- `sourceModule` (string, required, read-only)
- `sourceEntityRef` (string/object, required?, read-only) *(unclear)*
- `occurredAt` (datetime, required, read-only)
- `receivedAt` (datetime, required, read-only)
- `businessUnitId` (string/UUID, required, read-only)
- `currencyUomId` (string, required, read-only)
- `workorderId` (UUID, required, read-only)
- `processingStatus` (enum/string, required, read-only)
- `processedAt` (datetime, optional, read-only)
- `attemptCount` (number, required, read-only; default 0)
- `lastErrorCode` (string, optional, read-only)
- `lastErrorMessage` (string, optional, read-only; sanitized)
- `payloadJson` (text/json, required, read-only)

**Attempt History (if available)**
- `attemptNo` (int)
- `attemptedAt` (datetime)
- `outcomeStatus` (enum)
- `errorCode`/`errorMessage`

### Read-only vs editable by state/role
- All ingestion record fields are read-only.
- Only operator action is `retry` (command), not editing payload.

### Derived/calculated fields
- `retryEligible` (boolean) derived by backend or computed from status; prefer backend-provided to avoid duplicating policy.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementations may use `service-call` to invoke REST or local services; exact service names must be confirmed.

### Load/view calls
1. **Search**
   - Service: `accounting.events.IngestionSearch` *(placeholder)*
   - Inputs:
     - `eventType=WorkCompleted`
     - `status[]` (optional)
     - `occurredAtFrom`, `occurredAtTo` (optional)
     - `workorderId` (optional)
     - `eventId` (optional)
     - pagination: `pageIndex`, `pageSize`
     - sorting: `orderByField`, `orderByDirection`
   - Outputs:
     - `records[]` with fields listed above (subset ok for list)
     - `totalCount`

2. **Detail**
   - Service: `accounting.events.IngestionGet` *(placeholder)*
   - Inputs: `ingestionId` (or `eventId`)
   - Outputs: full ingestion record + attempt history + `retryEligible`

### Create/update calls
- None (UI does not create events).

### Submit/transition calls
1. **Retry**
   - Service: `accounting.events.IngestionRetry` *(placeholder)*
   - Inputs:
     - `ingestionId`
     - `operatorReason` (optional/required? **unclear**)
   - Outputs:
     - updated record status or an acknowledgment `{queued:true}`

### Error handling expectations
- 400 validation errors: show inline banner and field hints where applicable.
- 401/403: show “Not authorized” and hide retry action when permission missing.
- 404: record not found → show not-found state.
- 409: conflict (already processed / not retryable) → show conflict message and refresh record.
- Known domain error codes expected (from backend story/checklist examples):
  - `SCHEMA_VALIDATION_FAILED`
  - `INGESTION_DUPLICATE_CONFLICT`
  - `INVOICE_TOTAL_NEGATIVE_REQUIRES_CREDIT_MEMO` *(likely not applicable here; do not surface unless returned)*
  - `workorder_not_found`
  - `wip_reconciliation_failed`

---

## 10. State Model & Transitions

### Allowed states (display + filtering)
Backend-defined; UI must support at least:
- `RECEIVED` (optional)
- `VALIDATED` (optional)
- `PROCESSED_SUCCESS` (or `SUCCEEDED`)
- `FAILED`
- `DUPLICATE_IGNORED` / `DUPLICATE_CONFLICT`
- `RETRY_QUEUED` / `REPROCESSING`

### Role-based transitions
- Only authorized users can initiate `FAILED -> RETRY_QUEUED/REPROCESSING`.
- No UI transition for success states.

### UI behavior per state
- Success: show “Processed” and processed timestamp.
- Failed: show error code/message and show Retry if eligible.
- Duplicate: show duplicate explanation; hide Retry unless policy says retryable (default: not retryable).
- Processing: disable Retry and show spinner/processing indicator.

---

## 11. Alternate / Error Flows

### Validation failures
- User enters invalid UUID filter → UI prevents submission or shows server-side error.
- Backend returns `SCHEMA_VALIDATION_FAILED` for record details: show “Payload failed schema validation” and render payload viewer for analysis.

### Concurrency conflicts
- Retry clicked twice / two users retry simultaneously:
  - Backend returns 409 conflict “already queued/processing”; UI refreshes detail and shows latest status.

### Unauthorized access
- User without permission opens list: either deny access to screen or show empty + authorization error (per app convention).
- User can view but cannot retry: hide/disable Retry and show “Insufficient permissions” on attempt.

### Empty states
- No ingestion records match filters: show “No events found” with suggestion to adjust date range/status.

---

## 12. Acceptance Criteria

### Scenario 1: View WorkCompleted ingestion records list
**Given** I am an authenticated user with access to Accounting event ingestion screens  
**When** I open the WorkCompleted ingestion list screen  
**Then** I see a paginated list of ingestion records filtered to `eventType = WorkCompleted`  
**And** each row shows `occurredAt`, `eventId`, `workorderId`, `processingStatus`, and `processedAt` (if present)

### Scenario 2: Filter by status and date range
**Given** I am on the WorkCompleted ingestion list screen  
**When** I set `status = FAILED` and set an `occurredAt` date range  
**And** I run the search  
**Then** only records matching those filters are displayed  
**And** the URL (or preserved navigation state) retains the applied filters

### Scenario 3: View ingestion record detail with payload
**Given** an ingestion record exists for a WorkCompleted event  
**When** I open its detail screen  
**Then** I can view its identifiers (`eventId`, `workorderId`, `schemaVersion`, `sourceModule`)  
**And** I can view the sanitized last error code/message if the record failed  
**And** I can view the raw payload JSON in a read-only viewer

### Scenario 4: Retry a retry-eligible failed ingestion record
**Given** I have permission to retry ingestion records  
**And** an ingestion record is in a backend-defined retry-eligible failed state  
**When** I click “Retry” and confirm the action  
**Then** the UI calls the retry service with the record identifier  
**And** the UI shows a success acknowledgment and refreshes the record status  
**And** the Retry action is disabled while the request is in-flight

### Scenario 5: Retry rejected due to conflict (already processed/queued)
**Given** I am viewing a failed ingestion record  
**When** I click “Retry”  
**And** the backend responds with HTTP 409 indicating the record is no longer retryable  
**Then** the UI shows a conflict message  
**And** refreshes the record detail to display the current status

### Scenario 6: Unauthorized user cannot retry
**Given** I can view ingestion records but do not have retry permission  
**When** I open a failed ingestion record detail  
**Then** I do not see an enabled Retry action (hidden or disabled per convention)  
**And** if I attempt the retry endpoint via UI controls, I receive an authorization error message

---

## 13. Audit & Observability

### User-visible audit data
- Display:
  - `attemptCount`
  - `processedAt`
  - last retry/attempt timestamp (if attempt history exists)
  - actor for operator-initiated retry (if returned)

### Status history
- If backend provides attempt history, render a chronological list of attempts (attempt no, timestamp, outcome, errorCode).

### Traceability expectations
- UI must surface identifiers for cross-system tracing:
  - `eventId`, `workorderId`, `businessUnitId`, correlationId/traceId if provided.

---

## 14. Non-Functional UI Requirements

- **Performance:** list search should return and render first page within 2 seconds for typical filter usage (dependent on backend).
- **Accessibility:** all actions reachable via keyboard; payload viewer supports screen readers (at minimum provides copy-to-clipboard and proper labels).
- **Responsiveness:** list and detail screens usable on tablet widths; table columns may collapse but must remain functional.
- **i18n/timezone:** all timestamps displayed in user’s locale/timezone with an option to view raw ISO timestamp in detail (read-only). Currency display is informational only (no calculations).

---

## 15. Applied Safe Defaults

- SD-UI-EMPTY-STATE: Provide explicit “No results” empty state and guidance to adjust filters; qualifies as safe UI ergonomics; impacts UX Summary, Alternate / Error Flows.
- SD-UI-PAGINATION: Use standard pagination (pageSize default 25) and server-side paging; qualifies as safe UI ergonomics; impacts UX Summary, Service Contracts.
- SD-UI-INFLIGHT-GUARD: Disable action buttons while requests are in-flight to prevent double-submit; qualifies as safe error-prevention; impacts Functional Behavior, Alternate / Error Flows.

---

## 16. Open Questions

1. **Backend contract for ingestion records:** What are the exact API endpoints/service names, request parameters, and response field names for listing and fetching `WorkCompleted` ingestion records?
2. **Status model:** What are the authoritative `processingStatus` values for ingestion records (including “duplicate” and “retry queued/processing”)?
3. **Retry policy:** Which statuses/errors are retry-eligible (e.g., `wip_reconciliation_failed`, `workorder_not_found`) and which are not (e.g., `SCHEMA_VALIDATION_FAILED`, `INGESTION_DUPLICATE_CONFLICT`)?
4. **Authorization:** What permission(s)/scope(s) gate access to (a) viewing ingestion screens and (b) initiating a retry? (e.g., `SCOPE_accounting:events:ingest` is mentioned for service-to-service; what is the human/operator permission?)
5. **Operator reason/audit requirement:** Must the UI collect a mandatory “retry reason” comment for audit? If yes, what are constraints (min/max length) and where is it stored?
6. **Payload access controls:** Is the full event payload always safe to display to ops users, or must some fields be masked/redacted?
7. **Moqui navigation conventions:** What is the expected screen root/module path and menu placement in `durion-moqui-frontend` for accounting event ingestion UIs?

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] Accounting: Ingest WorkCompleted Event  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/183  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Accounting: Ingest WorkCompleted Event

**Domain**: user

### Story Description

/kiro
Determine WIP finalization or readiness for invoicing.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## Actor
Accounting System

## Trigger
Receipt of `WorkCompleted` event from Workorder Execution

## Main Flow
1. Validate completion event and source workorder
2. If WIP accounting enabled:
   - Transfer WIP to Finished Work
3. Mark workorder as invoice-eligible
4. Persist completion accounting state

## Business Rules
- Completion does not create AR or revenue
- WIP handling is configuration-driven

## Acceptance Criteria
- [ ] WIP is reconciled (if enabled)
- [ ] Workorder marked invoice-ready

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## References
- Durion Accounting Event Contract v1

[Durion_Accounting_Event_Contract_v1.pdf](https://github.com/user-attachments/files/24299815/Durion_Accounting_Event_Contract_v1.pdf)

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

