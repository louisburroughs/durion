════════════════════════════════════════
ISSUE #130: [FRONTEND] [STORY] Timekeeping: Approve Submitted Time for a Day/Workorder
LABELS: type:story,status:draft,blocked:clarification,risk:incomplete-requirements,domain:people,blocked:domain-conflict,agent:story-authoring,agent:people-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Timekeeping: Approve/Reject Submitted Time (Day or Work Order) with Adjustments + Exception Resolution

### Primary Persona
Shop Manager

### Business Value
Locks approved labor time for payroll accuracy, prevents retroactive changes without audit, and ensures exceptions are explicitly handled before approval.

---

## 2. Story Intent

### As a / I want / So that
**As a** Shop Manager,  
**I want** to review submitted time entries by day and/or work order, resolve/waive any exceptions, optionally create audited adjustments, and approve or reject submissions,  
**so that** time becomes locked and finalized for payroll and downstream HR integration.

### In-scope and out-of-scope

#### In Scope
- A manager-facing Moqui screen flow to:
  - View time entries filtered by **work date** and/or **work order**
  - See entry status and exception badges
  - Approve one or more `PENDING_APPROVAL` time entries (lock after approval)
  - Reject one or more `PENDING_APPROVAL` time entries with a required reason
  - Create a **separate adjustment record** for an entry (delta/proposed times), without editing the original entry
  - View and act on exceptions (acknowledge/resolve/waive) based on severity
- Read-only display of approval/decision audit metadata (who/when/reason)

#### Out of Scope
- Creating/submitting time entries by employees (separate workflow)
- Payroll/HR system UI or monitoring (integration is backend/event-driven)
- Defining pay rates, wage calculations, tax/benefits
- Configuring exception thresholds and approval methods (policy/config domain)
- Any work order execution lifecycle changes (workexec domain)

---

## 3. Actors & Stakeholders
- **Shop Manager (primary):** approves/rejects, creates adjustments, resolves/waives exceptions.
- **Technician / Employee (indirect):** submits time; may correct and resubmit after rejection.
- **HR/Payroll system (downstream):** consumes approval outputs/events (no synchronous dependency for UI).
- **Audit/Compliance (stakeholder):** requires immutable history of approvals, rejections, adjustments, and exception handling.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User has permission to approve/reject time entries and to resolve/waive exceptions (exact capability/permission codes are owned by security/people domains; see Open Questions).
- There exist time entries in `PENDING_APPROVAL` for the selected day and/or work order.

### Dependencies (Backend/API)
This frontend story depends on a People/Timekeeping backend (system of record) providing:
- Time entries list/view with status and decision metadata
- Approve/reject operations with validation and proper error codes
- Time exceptions list and mutation operations (acknowledge/resolve/waive)
- Time entry adjustment create/list and (if applicable) adjustment approval workflow

**Domain decision rationale (binding):**
- Per `workexec` domain guide (DECISION-INVENTORY-009), time entry remains in the **people domain**; workexec may only consume people availability read-only. Therefore, this story’s primary ownership is **not** `domain:workexec` and must be routed to `domain:people`. This creates a domain conflict with the provided issue’s current `domain:workexec` label and requires clarification/triage.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- POS main navigation: **Timekeeping → Approvals**
- Deep links:
  - `/timekeeping/approvals` (queue by date default)
  - `/timekeeping/approvals?workDate=YYYY-MM-DD`
  - `/timekeeping/approvals?workOrderId=<id>`

### Screens to create/modify (Moqui)
Create new screen tree (final paths must match repo conventions for component + menu wiring):
- **Screen:** `apps/pos/screen/Timekeeping/Approvals.xml`
  - Subscreens:
    - `Queue.xml` (list + filters + batch actions)
    - `EntryDetail.xml` (single entry view + exceptions + adjustments)

Notes:
- Use Moqui screen transitions for actions (approve/reject/exception actions/adjustment create).
- Use Moqui forms with server-side validation surfaced via standard error mapping.

### Navigation context
- Breadcrumb: `Timekeeping > Approvals`
- Filter chips show active scope: `Work Date` and/or `Work Order`

### User workflows (happy + alternate)

#### Happy path A — Approve entries for a day
1. Manager opens **Timekeeping > Approvals**
2. Selects a work date (default: today)
3. Reviews list; entries with exceptions show badges
4. Resolves/waives any **BLOCKING** exceptions
5. Selects entries and clicks **Approve**
6. UI shows success and updates status to `APPROVED` + read-only lock indicator

#### Happy path B — Reject entries with reason
1. Manager selects one or more `PENDING_APPROVAL` entries
2. Clicks **Reject**
3. Modal requires a reason
4. Submits; entries become `REJECTED`, unlock for submitter (informational note)

#### Happy path C — Create adjustment (delta/proposed times)
1. From entry detail (or row action) manager chooses **Create Adjustment**
2. Enters reason code + either proposed start/end OR minutes delta (one-of)
3. Submits; adjustment appears in adjustments list as `PROPOSED` (or equivalent)
4. Manager proceeds to resolve exceptions then approve/reject time entry as allowed by backend rules

#### Alternate path — Approve by work order
- Filter by `workOrderId`, review all pending entries, approve/reject as above.

---

## 6. Functional Behavior

### Triggers
- Screen load: fetch approval queue for default date (today) or selected filters.
- Filter change: re-fetch queue.
- Row click: open entry detail.
- Approve/Reject button: perform batch action.
- Create Adjustment: submit adjustment request.
- Exception actions: acknowledge/waive/resolve (depending on capability).

### UI actions
- Select rows (multi-select) limited to eligible statuses (must be `PENDING_APPROVAL`).
- Approve: confirmation dialog (shows count and warns about locking).
- Reject: modal with required `rejectionReason`.
- Entry detail:
  - Read-only times, work order, employee, status, submittedAt
  - Exceptions section with severity and required actions
  - Adjustments section listing existing adjustments + create new

### State changes
- `PENDING_APPROVAL` → `APPROVED` on success (entry becomes read-only; disable actions)
- `PENDING_APPROVAL` → `REJECTED` on success (display rejection reason; allow no further manager action except view)
- Exception status changes: `OPEN` → `ACKNOWLEDGED` / `RESOLVED` / `WAIVED`
- Adjustment status change is **not performed by this story** unless backend supports approving adjustments in same UI (see Open Questions)

### Service interactions (Moqui)
- Use Moqui `transition` actions invoking service calls for:
  - Loading queue data
  - Performing approve/reject
  - Creating adjustments
  - Updating exception statuses
- For mutation actions, UI must support idempotency if backend requires it (header-based). Exact requirement is not defined for people/timekeeping in provided rules; see Open Questions.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Reject requires non-empty reason (client-side required + server-side enforced).
- Approve only allowed when:
  - Entry status is `PENDING_APPROVAL`
  - All `BLOCKING` exceptions are not `OPEN` (must be `RESOLVED` or `WAIVED`)
- Adjustments:
  - Must not edit original time entry directly.
  - Must require `reasonCode` (reason code set is backend-owned; UI must render as a dropdown from backend-provided options if available; otherwise accept a backend-validated string code).
  - Must require exactly one of:
    - proposed start/end timestamps (both required together), **or**
    - minutes delta
  - UI must prevent submitting both modes; backend must enforce one-of.

### Enable/disable rules
- Approve enabled only when selection contains ≥1 entry and all selected are `PENDING_APPROVAL`.
- Reject enabled only when selection contains ≥1 entry and all selected are `PENDING_APPROVAL`.
- If any selected entry has `BLOCKING` exceptions still `OPEN`, Approve is disabled and UI explains why.
- For `APPROVED` entries: all edit/decision controls hidden/disabled; show “Locked” indicator.

### Visibility rules
- Exceptions badge visible when entry has ≥1 exception (open or otherwise); badge style indicates presence of open blocking exceptions.
- Exception action buttons depend on backend-permitted transitions and user capability:
  - `WARNING`: allow `ACKNOWLEDGED` (if permitted)
  - `BLOCKING`: require `RESOLVED` or `WAIVED` prior to approval

### Error messaging expectations
- 403: “You do not have permission to approve/reject time entries.”
- 409: “This entry was updated by someone else. Refresh and try again.”
- 400: show field-level error (e.g., missing rejection reason).
- 422 (if used): show validation summary for exceptions not resolved.

---

## 8. Data Requirements

### Entities involved (frontend view models)
- `TimeEntry`
- `TimeEntryAdjustment`
- `TimeException`

### Fields (type, required, defaults)

#### TimeEntry (read)
- `timeEntryId` (id/opaque string) required
- `employeeId` (id/opaque string) required
- `workOrderId` (id/opaque string) optional
- `workDate` (date) required
- `startAtUtc` (timestamp) required
- `endAtUtc` (timestamp) optional
- `status` (enum string) required
- `submittedAtUtc` (timestamp) required when `status=PENDING_APPROVAL|APPROVED|REJECTED`
- `decisionByUserId` (id/opaque string) present when `status=APPROVED|REJECTED`
- `decisionAtUtc` (timestamp) present when `status=APPROVED|REJECTED`
- `rejectionReason` (string) present when `status=REJECTED`
- Derived (display-only):
  - `durationMinutesDisplay` computed client-side if start/end present (non-authoritative)
  - `hasOpenBlockingExceptions` boolean derived from exceptions list

#### TimeEntryAdjustment (create + read)
- `adjustmentId` (id/opaque string) read-only
- `timeEntryId` (id/opaque string) required
- `reasonCode` (string/enum) required
- `notes` (string) optional
- One-of input required:
  - `proposedStartAtUtc` (timestamp) and `proposedEndAtUtc` (timestamp) (both required together), OR
  - `minutesDelta` (integer) (positive or negative)
- `status` (enum string) read-only (e.g., `PROPOSED|APPROVED|REJECTED`)
- audit fields read-only: `createdByUserId`, `createdAtUtc`, `decidedByUserId`, `decidedAtUtc`

#### TimeException (read + update status)
- `exceptionId` (id/opaque string) required
- `timeEntryId` (id/opaque string) optional (nullable for day-level exceptions)
- `employeeId` (id/opaque string) required
- `workDate` (date) required
- `exceptionCode` (string/enum) required
- `severity` (enum string) required: `WARNING|BLOCKING`
- `status` (enum string) required: `OPEN|ACKNOWLEDGED|RESOLVED|WAIVED`
- `resolutionNotes` (string) required when waiving (if backend enforces; see Open Questions)
- audit fields read-only: `detectedAtUtc`, `resolvedByUserId`, `resolvedAtUtc`

### Read-only vs editable by state/role
- Managers can only change:
  - time entry decision (approve/reject) while pending
  - exception status (ack/resolve/waive) as permitted
  - create adjustment records (not mutate time entry)
- Non-managers: read-only access (if allowed) is out of scope.

### Derived/calculated fields
- `durationMinutesDisplay` is derived for display only; do not use for payroll totals.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementation will call services or REST endpoints; exact names depend on backend exposure in this frontend repo. Below are required contracts; if not present, this story remains blocked.

### Load/view calls
- `GET /api/time-entries?status=PENDING_APPROVAL&workDate=YYYY-MM-DD&pageIndex=&pageSize=`
- `GET /api/time-entries?status=PENDING_APPROVAL&workOrderId=<id>&pageIndex=&pageSize=`
- `GET /api/time-entries/{timeEntryId}`
- `GET /api/time-entries/{timeEntryId}/exceptions`
- `GET /api/time-entries/{timeEntryId}/adjustments`

### Create/update calls
- `POST /api/time-entries/{timeEntryId}/adjustments`
  - body (one-of):
    - `{ reasonCode, notes?, proposedStartAtUtc, proposedEndAtUtc }`
    - `{ reasonCode, notes?, minutesDelta }`

### Submit/transition calls
- Approve (batch):
  - `POST /api/time-entries/approve`
    - body: `{ timeEntryIds: [<id>...], note? }`
- Reject (batch):
  - `POST /api/time-entries/reject`
    - body: `{ timeEntryIds: [<id>...], reason: "..." }`

- Exception actions:
  - `POST /api/time-exceptions/{exceptionId}/acknowledge`
  - `POST /api/time-exceptions/{exceptionId}/resolve`
  - `POST /api/time-exceptions/{exceptionId}/waive`
    - body: `{ resolutionNotes: "..." }`

### Error handling expectations
- 401 unauthenticated → redirect to login
- 403 unauthorized → show permission error; keep screen read-only
- 404 not found → show “Entry no longer exists”
- 409 conflict → prompt refresh; do not assume idempotent success
- 400/422 validation errors → map to form-level and field-level messages using a standard envelope if provided (code/message/fieldErrors/correlationId)

---

## 10. State Model & Transitions

### Allowed states (UI-relevant)
- `PENDING_APPROVAL` (or `SUBMITTED`) — eligible for manager approve/reject
- `APPROVED` — locked, immutable
- `REJECTED` — not locked; submitter can correct/resubmit (outside scope)
- Other states may exist (e.g., `DRAFT`), displayed read-only if encountered.

### Role-based transitions
- Only Shop Manager (or users with equivalent permissions) can:
  - approve/reject
  - waive blocking exceptions (if permitted)
  - create adjustments

### UI behavior per state
- `PENDING_APPROVAL`: selectable in queue; actions enabled subject to exception rules
- `APPROVED`: show locked + decision metadata; disable selection/actions
- `REJECTED`: show rejection metadata; disable selection/actions

---

## 11. Alternate / Error Flows

### Validation failures
- Reject without reason:
  - UI blocks submit; server 400 displayed if bypassed.
- Approve with unresolved blocking exceptions:
  - UI disables Approve and lists blocking exceptions; if bypassed, handle 422/400 with message.
- Adjustment invalid one-of:
  - UI prevents selecting both modes; if server rejects, show returned field errors.

### Concurrency conflicts
- Another manager approves while current manager viewing queue:
  - Approve attempt returns 409; UI refreshes queue and shows which entries failed (per-item errors if provided; otherwise show generic and refresh).

### Unauthorized access
- User without permission loads screen:
  - If backend returns 403 on load, show access denied.
  - If backend allows read-only load, hide/disable all actions and show “Read-only: insufficient permissions.”

### Empty states
- No pending entries for selected filters:
  - Show empty state with guidance: “No time awaiting approval for this scope.”

---

## 12. Acceptance Criteria

### Scenario 1: View pending approvals for a day
Given I am authenticated as a Shop Manager  
When I navigate to Timekeeping Approvals for workDate "2026-01-15"  
Then I see a list of time entries with status "PENDING_APPROVAL" for that date  
And each row shows employee, work order (if any), start/end times, and an exception indicator when exceptions exist

### Scenario 2: Approve a pending time entry with no open blocking exceptions
Given a time entry "T1" is in status "PENDING_APPROVAL"  
And "T1" has no exceptions with severity "BLOCKING" in status "OPEN"  
When I approve "T1"  
Then the system updates "T1" to status "APPROVED"  
And the UI shows decision metadata (approved by, approved at)  
And "T1" becomes read-only/locked in the UI

### Scenario 3: Reject a pending time entry requires reason
Given a time entry "T2" is in status "PENDING_APPROVAL"  
When I attempt to reject "T2" without entering a reason  
Then the UI prevents submission and displays "Rejection reason is required"  
When I reject "T2" with reason "Incorrect work order"  
Then the system updates "T2" to status "REJECTED"  
And the UI displays the rejection reason and decision metadata

### Scenario 4: Approval blocked by unresolved blocking exception until waived/resolved
Given a time entry "T3" is in status "PENDING_APPROVAL"  
And "T3" has an exception "E1" with severity "BLOCKING" and status "OPEN"  
When I view "T3" in the approval queue  
Then the Approve action is disabled for "T3" and the UI explains that blocking exceptions must be resolved or waived  
When I waive exception "E1" with resolution notes "Reviewed; acceptable for payroll"  
And I approve "T3"  
Then "T3" transitions to "APPROVED"

### Scenario 5: Create an adjustment record for an entry without changing the original entry
Given a time entry "T4" exists  
When I create an adjustment for "T4" with reasonCode "INCORRECT_WORKORDER" and minutesDelta "+15"  
Then an adjustment record is created and visible under "T4" adjustments  
And the original time entry timestamps are unchanged in the UI

### Scenario 6: Concurrency conflict on approve
Given a time entry "T5" is in status "PENDING_APPROVAL"  
And another manager approves "T5" before I do  
When I attempt to approve "T5"  
Then the system responds with a 409 conflict error  
And the UI prompts me to refresh and shows "T5" is already approved after refresh

---

## 13. Audit & Observability

### User-visible audit data
- For each entry: submittedAt, decisionBy, decisionAt, rejectionReason (if rejected)
- For adjustments: createdBy, createdAt, status, decision metadata (if any)
- For exceptions: detectedAt, severity, status, resolvedBy/resolvedAt, resolution notes (if waived)

### Status history
- If backend supports history endpoints, provide a “History” panel for:
  - approvals/rejections
  - exception state changes
  - adjustments lifecycle
- If not supported, show only current metadata fields.

### Traceability expectations
- UI includes identifiers in error details/logs: `timeEntryId`, `exceptionId`, and `correlationId` if provided by backend error envelope/headers.

---

## 14. Non-Functional UI Requirements
- **Performance:** Queue load for a single day should render within 2s for up to 200 entries (paginate if more).
- **Accessibility:** All dialogs keyboard-navigable; form errors announced; table selection accessible.
- **Responsiveness:** Works on tablet (manager station) and desktop.
- **i18n/timezone:** Display timestamps in the user’s timezone; if a shop/location timezone is provided by backend, label it and use it for day-bucket filtering only when explicitly supported by API. (Timezone contract is a dependency; see Open Questions.)

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty state messaging and “change filters” guidance; safe as UI-only ergonomics. (Sections: UX Summary, Alternate / Error Flows)
- SD-UX-PAGINATION: Paginate queue results when large; safe as it doesn’t change domain logic. (Sections: UX Summary, Service Contracts)
- SD-ERR-HTTP-MAP: Standard mapping for 401/403/404/409 to user-facing messages; safe as it does not invent business rules. (Sections: Business Rules, Alternate / Error Flows, Service Contracts)

---

## 16. Open Questions

1. **Domain ownership / label (blocking):** Per workexec domain rules, timekeeping is owned by `domain:people`, not `domain:workexec`. Confirm this issue should be moved to `domain:people` and coordinated with the People domain agent (and security for permissions).  
2. **Backend contract (blocking):** What are the actual endpoints/services exposed to the Moqui frontend for:
   - listing time entries by workDate/workOrder/status (including pagination)
   - approving/rejecting (single vs batch; request/response schema; whether actor comes from auth)
   - adjustments create/list and whether adjustments require separate approval in this same UI  
3. **Canonical status enums (blocking):** What are the canonical enum values returned by the API for time entry status (e.g., `SUBMITTED` vs `PENDING_APPROVAL`)? Provide the full set and which are actionable.  
4. **Exception lifecycle (blocking):** Are exception actions (ACKNOWLEDGED/RESOLVED/WAIVED) implemented as endpoints? If not, is exception handling read-only for v1 and enforced only by approval validation?  
5. **Permission/capability model (blocking):** What capability flags or permission codes should the frontend use to gate:
   - view approvals queue
   - approve
   - reject
   - create adjustment
   - waive blocking exceptions  
6. **Adjustment input rule (blocking):** Must the UI support both “proposed start/end” and “minutes delta”, or only one? If both, confirm the one-of rule and whether proposed start/end requires both fields.  
7. **Timezone semantics (blocking):** Should timestamps display in user timezone (preferred) and what timezone should day filters use? Is shop/location timezone available from backend, and if so where?

