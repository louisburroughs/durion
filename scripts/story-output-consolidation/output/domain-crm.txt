════════════════════════════════════════
ISSUE #176: [FRONTEND] [STORY] Party: Create Commercial Account
LABELS: domain:crm,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:crm
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] Party: Create Commercial Account

**Primary Persona:** Fleet Account Manager

**Business Value:** Enables consistent association of workorders/estimates/invoices to a single, stable commercial customer entity (CRM Party/Account), reducing duplicate customer creation and downstream billing errors.

---

## 2. Story Intent

### As a / I want / So that
**As a** Fleet Account Manager,  
**I want** to create a commercial customer account with legal name, billing profile (default billing terms), and optional identifiers,  
**So that** workorders and invoices can be consistently tied to the correct business entity via a stable CRM ID (`partyId`).

### In-scope
- A “Create Commercial Account” UI flow in the Moqui frontend to create a new Commercial Account/Party (CRM SoR).
- Capture fields:
  - legal name (required)
  - DBA (optional)
  - tax ID (optional)
  - default billing terms (required; reference data sourced from Billing domain)
  - external identifiers (optional; structure depends on backend contract)
- Duplicate detection UX:
  - Explicit duplicate-check step before create (or create returns duplicates requiring confirmation), with an override path requiring explicit confirmation and justification.
- Post-create confirmation:
  - show/copy the newly created stable CRM ID (`partyId`)
  - navigate to an existing Party/Account view route if available; otherwise show a deterministic “created” confirmation state with a deep link placeholder.

### Out-of-scope
- Editing/updating existing accounts (separate story).
- Full CRM account search UI (beyond any existing search).
- Defining billing terms master data management (Billing-owned; UI consumes list).
- Implementing backend services/entities (frontend story consumes Moqui services/endpoints).
- Complex dedupe algorithms beyond backend-provided candidate matching and reasons.

---

## 3. Actors & Stakeholders
- **Fleet Account Manager (primary)**: creates accounts and resolves duplicate warnings.
- **Workexec users/systems (downstream)**: search/select account by `partyId`; store `partyId` on estimate/workorder.
- **Billing stakeholders (downstream)**: rely on default billing terms selection being captured and persisted.
- **System Admin / Support (secondary)**: may troubleshoot duplicates via audit trail (read-only concerns in this story).
- **Security/Authorization stakeholders (cross-cutting)**: define permission keys → roles mapping; backend must enforce.

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend.
- User has permission to create commercial accounts (permission key name requires confirmation; see Open Questions).
- Moqui backend provides (or will provide) dedicated services/endpoints:
  - Billing terms list service (read-only reference list).
  - Duplicate-check service for commercial accounts **or** create service that returns duplicate candidates requiring confirmation (DECISION-INVENTORY-015 requires duplicate-check then create; exact contract still needed).
  - Create commercial account service that returns `partyId` on success and returns structured errors on validation/duplicates.
- Network connectivity to backend is available.
- Project conventions for correlation headers are available to the frontend (at minimum, UI must display server-provided correlation id if present in error response headers/body; DECISION-INVENTORY-004).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Primary entry from CRM/Accounts area: “Create Commercial Account”.
- Secondary entry from a downstream flow (e.g., estimate/workorder customer selection) via a return URL pattern (caller provides `returnUrl`; see DECISION-INVENTORY-013 handoff pattern; applied here for party selection return).

### Screens to create/modify
1. **New Screen:** `apps/durion/screen/crm/party/CommercialAccountCreate.xml`  
   - Screen renders a form and orchestrates duplicate-check + create.
2. **Existing or New Screen (dependency):** Party/Account view screen (route TBD)
   - After successful create, navigate to Party view if it exists; otherwise show a confirmation panel with `partyId` and a “Go back” link to `returnUrl` if provided.

> Note: Exact file paths must follow repository conventions; the above is a placeholder path that must be aligned during implementation.

### Navigation context
- Breadcrumb/title: “Create Commercial Account”.
- Cancel:
  - If `returnUrl` is provided, navigate to it without mutation.
  - Else navigate to a CRM Accounts landing/list route (if exists) or previous browser history.

### User workflows (happy + alternate)
**Happy path (no duplicates)**
1. User opens Create Commercial Account.
2. Form loads billing terms options.
3. User enters legal name, selects default billing terms, optionally enters DBA/taxId/external identifiers.
4. User clicks Create.
5. UI performs duplicate-check (or create returns no duplicates).
6. UI creates account.
7. UI shows success with `partyId` and navigates to Party view (if available) or stays on confirmation state.

**Alternate path (duplicates found)**
1. User clicks Create.
2. UI shows duplicate candidates list with match reasons (if provided).
3. User chooses:
   - “Open candidate” (navigates to candidate Party view in same tab; user can return via back)
   - “Cancel” (returns to form with inputs preserved)
   - “Create anyway” (requires explicit confirmation + justification; then create with override)

**Alternate path (billing terms unavailable)**
- Billing terms list returns empty or error → UI blocks create and shows actionable message.

---

## 6. Functional Behavior

### Triggers
- Screen load: initialize form defaults and load billing terms list.
- User action: click “Create” submits the form.

### UI actions
- Form inputs:
  - legal name (required)
  - DBA (optional)
  - tax ID (optional)
  - default billing terms (required select)
  - external identifiers (optional; rendered only if contract supports)
  - duplicate override justification (required only when overriding duplicates)
- Submit flow:
  1) client-side required checks (presence only; no policy guessing)  
  2) call duplicate-check service (preferred per DECISION-INVENTORY-015)  
  3) if duplicates returned → show duplicates panel and require explicit override confirmation + justification  
  4) call create service with `override` fields if user proceeds

### State changes (frontend)
- Local UI states:
  - `loadingRefData` (billing terms)
  - `editing`
  - `checkingDuplicates`
  - `duplicatesFound`
  - `creating`
  - `success`
  - `error`
- Duplicate override is a separate explicit state requiring:
  - checkbox “I understand this may create a duplicate account”
  - justification text input (required; min length TBD by backend; UI enforces non-empty)

### Service interactions
- On load: billing terms list service.
- On submit:
  - duplicate-check service (or create service that can return duplicates)
  - create commercial account service

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Canonical identifier rule:** UI must treat created account ID as `partyId` (DECISION-INVENTORY-001). Do not introduce `customerId` as a primary identifier in routes or UI state.
- **Legal Name**: required, non-empty string.
  - UI blocks submit if empty.
  - Error: “Legal name is required.”
- **Default Billing Terms**: required selection.
  - UI blocks submit if not selected.
  - Error: “Default billing terms is required.”
- **Tax ID**: optional.
  - UI does not enforce format unless backend provides field errors; display backend field error inline.
- **Duplicate override justification**:
  - Required only when user chooses “Create anyway”.
  - UI blocks override submit if empty.
  - Error: “Justification is required to create an account when duplicates are detected.”
- **External identifiers**:
  - UI must not assume free-form keys/values; render based on backend contract.
  - If backend returns fieldErrors for identifiers, map inline.

### Enable/disable rules
- Disable Create button while `checkingDuplicates` or `creating`.
- Disable “Create anyway” until:
  - confirmation checkbox checked
  - justification provided (non-empty)
- Disable entire form if billing terms cannot be loaded (or if backend indicates create is impossible without terms).

### Visibility rules
- Duplicate candidates panel only visible when backend returns candidates.
- Justification input only visible when user selects override path.
- If user lacks permission (403), hide/disable entry points where possible, but always handle direct URL access with a deterministic access denied state (DECISION-INVENTORY-007).

### Error messaging expectations
- Inline field errors when backend returns structured `fieldErrors`.
- Non-field errors shown as banner:
  - “Unable to create account.”
  - Include correlation id if provided by backend response header/body (do not include sensitive payloads).
- Do not render backend strings as HTML (DECISION-INVENTORY-006 pattern: treat details as sensitive; render as plain text).

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Party (Commercial Account subtype)**: CRM-owned; created by this flow; returns `partyId` (UUID/string).
- **Billing Terms reference list**: Billing-owned reference data; consumed read-only.
- **Duplicate candidates**: CRM-owned read model returned by duplicate-check service (candidate summaries).
- **External identifiers**: CRM-owned fields/child records; exact schema TBD by backend contract.
- **Audit fields**: createdBy/createdAt (display-only if returned or available on view screen).

### Fields (types, required, defaults)
**Commercial Account Create Input DTO (frontend payload)**
- `legalName` (string, required)
- `dbaName` (string, optional)
- `taxId` (string, optional)
- `defaultBillingTermsId` (string/UUID, required; depends on Billing terms key type)
- `externalIdentifiers` (optional; structure TBD)
- `duplicateOverride` (boolean, default `false`)
- `duplicateOverrideJustification` (string, required when `duplicateOverride=true`)
- `duplicateCandidatePartyIds` (array of `partyId`, required when `duplicateOverride=true` if backend supports auditing)

**Duplicate-check Input DTO**
- `legalName` (string, required)
- `taxId` (string, optional)
- `externalIdentifiers` (optional; if used for matching)
- **Contact inputs**: phone/email are NOT included unless backend contract requires them (see Open Questions). UI must not invent these fields.

**Read-only outputs**
- `partyId` (UUID/string, required on success)
- Optional: `createdAt`, `createdByUserId` (if provided)

### Read-only vs editable by state/role
- Create screen: all input fields editable.
- Success state: `partyId` read-only; copy action available.
- Account status:
  - Not included as an editable field by default (blocked pending clarification; see Open Questions). Backend defaults apply.

### Derived/calculated fields
- None on frontend. Duplicate matching and normalization are backend-owned (DECISION-INVENTORY-015).

---

## 9. Service Contracts (Frontend Perspective)

> Moqui screen actions must call dedicated services/endpoints; do not direct entity-find for sensitive or permissioned data (pattern from DECISION-INVENTORY-005/006/007). Exact service names are not provided and must be confirmed before implementation.

### Load/view calls
1. **List billing terms (reference data)**
   - Endpoint/service (placeholder): `GET /rest/api/v1/billing/terms?activeOnly=true`
   - Response DTO:
     - `items: [{ billingTermsId, code?, description, active? }]`
     - pagination optional (if list is small); if paginated, include `pageIndex/pageSize/total`
   - UI behavior:
     - populate select with `description` (and optionally `code`)

2. **Load Party view (post-create navigation)**
   - Existing route/service unknown; UI must navigate using `partyId` only (DECISION-INVENTORY-001).

### Create/update calls
1. **Duplicate check (preferred per DECISION-INVENTORY-015)**
   - Endpoint/service (placeholder): `POST /rest/api/v1/crm/parties/commercial-accounts/duplicate-check`
   - Request: `{ legalName, taxId?, externalIdentifiers? }` (+ any required fields per contract)
   - Response:
     - `{ candidates: [{ partyId, legalName, dbaName?, taxIdMasked?, matchReason, matchScore? }], correlationId? }`
   - Notes:
     - UI treats `matchScore` display-only if present.

2. **Create commercial account**
   - Endpoint/service (placeholder): `POST /rest/api/v1/crm/parties/commercial-accounts`
   - Request:
     - `legalName`, `dbaName?`, `taxId?`, `defaultBillingTermsId`
     - `externalIdentifiers?`
     - `duplicateOverride` (boolean)
     - `duplicateOverrideJustification` (string when override)
     - `duplicateCandidatePartyIds` (array when override; if supported)
   - Success response: `{ partyId, createdAt?, createdBy? }`
   - Duplicate response (if backend enforces confirm-at-create instead of separate check):
     - `409 DUPLICATE_CANDIDATES` with `{ candidates: [...] }` (per DECISION-INVENTORY-015)
   - Validation errors:
     - `400` with `{ errorCode, message, fieldErrors: { fieldName: "message" } }` (pattern used in CRM checklist)

### Submit/transition calls
- None beyond create.

### Error handling expectations
- `401/403`: show access denied; do not retry automatically.
- `409 DUPLICATE_CANDIDATES`: show duplicates panel; do not lose form state.
- `409` other conflicts: show banner; map fieldErrors if present.
- `400` validation: inline field errors.
- Network errors/timeouts: show retryable banner; preserve form values.
- Correlation:
  - If response includes `X-Correlation-Id` header or `correlationId` field, display it in error banner for support (DECISION-INVENTORY-004), but do not log sensitive inputs client-side.

---

## 10. State Model & Transitions

### Allowed states
- UI flow states (frontend):
  - `editing` → `checkingDuplicates` → `duplicatesFound` → (`creating`) → (`success` | `error`)
- Account lifecycle states are CRM-owned but not managed here.

### Role-based transitions
- Creation requires a create permission (exact key TBD).
- Duplicate override is allowed only if the user has create permission; no separate override permission is assumed without confirmation (blocked; see Open Questions).

### UI behavior per state
- `editing`: form enabled.
- `checkingDuplicates`: form disabled; show progress indicator.
- `duplicatesFound`: show candidates; allow open/cancel/override.
- `creating`: disable all actions; show progress.
- `success`: show `partyId` and navigation options.
- `error`: show banner; allow retry.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing legal name or billing terms:
  - UI blocks submit; no service calls.
- Missing override justification when overriding:
  - UI blocks create; no create call.

### Duplicate conflicts
- If duplicates returned by duplicate-check:
  - UI shows candidates and requires explicit override confirmation + justification.
- If duplicates returned by create (409):
  - UI transitions to `duplicatesFound` using candidates from response; user can retry create with override.

### Concurrency conflicts
- Not typical for create; if backend returns `409` due to uniqueness constraints (e.g., external identifier unique):
  - UI shows banner and maps fieldErrors if provided.

### Unauthorized access
- If user lacks permission:
  - Entry point may be hidden (if permission is known client-side).
  - If accessed directly, backend returns 403; UI shows access denied and disables form.

### Empty states
- Billing terms list empty:
  - UI shows “No billing terms available. Contact an administrator.”
  - Create is disabled.

---

## 12. Acceptance Criteria

### Scenario 1: Create commercial account successfully with required fields
**Given** I am authenticated as a Fleet Account Manager with permission to create commercial accounts  
**And** billing terms are available to select  
**When** I enter a legal name and select default billing terms  
**And** I click Create  
**Then** the UI performs a duplicate check (or the create call proceeds if duplicate-check is not separate)  
**And** the system creates a commercial account  
**And** I am shown a success confirmation containing the new stable CRM ID (`partyId`)  
**And** I can copy the `partyId` from the confirmation state  
**And** I am navigated to the account view screen if it exists, otherwise I remain on the confirmation state with a deterministic link target placeholder

### Scenario 2: Required field validation blocks submission (legal name)
**Given** I am on the Create Commercial Account screen  
**When** I click Create with legal name empty  
**Then** the UI prevents submission  
**And** I see “Legal name is required.”  
**And** no duplicate-check or create service call is made

### Scenario 3: Required field validation blocks submission (billing terms)
**Given** I am on the Create Commercial Account screen  
**When** I click Create without selecting default billing terms  
**Then** the UI prevents submission  
**And** I see “Default billing terms is required.”  
**And** no duplicate-check or create service call is made

### Scenario 4: Duplicate warning is shown when close matches exist
**Given** the backend duplicate-check (or create) returns one or more duplicate candidates  
**When** I attempt to create the commercial account  
**Then** I am shown a duplicate warning state  
**And** I can see a list of potential matching accounts including at least `partyId` and legal name  
**And** I can open a candidate’s Party view (if route exists)  
**And** I can cancel and return to the form with my inputs preserved

### Scenario 5: Duplicate override requires explicit confirmation and justification
**Given** a duplicate warning is shown with candidate matches  
**When** I choose “Create anyway”  
**Then** the UI requires me to confirm I understand duplicates may exist  
**And** the UI requires a non-empty justification before submitting the override create request  
**And** the create request includes `duplicateOverride=true` and the justification

### Scenario 6: Duplicate override creates account and returns `partyId`
**Given** a duplicate warning is shown  
**And** I have provided confirmation and justification  
**When** I submit the override create request  
**Then** the system creates a new commercial account  
**And** I am shown the new `partyId`  
**And** the UI does not lose the correlation id if provided in the response headers/body

### Scenario 7: Backend validation error is rendered inline
**Given** I submit the create form with a tax ID value  
**When** the backend returns `400` with a field validation error for `taxId`  
**Then** the UI shows the backend error message associated with the tax ID field  
**And** my other entered values remain intact

### Scenario 8: Unauthorized user cannot create
**Given** I am authenticated but do not have permission to create commercial accounts  
**When** I access the Create Commercial Account screen or attempt to submit the form  
**Then** the backend returns 403  
**And** the UI shows an access denied state  
**And** no account is created

### Scenario 9: Billing terms unavailable blocks create
**Given** I am on the Create Commercial Account screen  
**When** billing terms fail to load or return an empty list  
**Then** the UI shows an error/empty state message indicating billing terms are required  
**And** the Create action is disabled

---

## 13. Audit & Observability

### User-visible audit data
- On success confirmation (and/or view screen), display:
  - `partyId` (canonical ID; DECISION-INVENTORY-001)
  - created timestamp and created by (only if provided by backend response or view load)

### Status history
- Not in scope for this create flow.

### Traceability expectations
- UI must not log PII (taxId, identifiers) to client telemetry.
- If backend provides `X-Correlation-Id` (DECISION-INVENTORY-004), UI should display it in error banners for support and include it in copyable error details.
- UI must render backend error strings as plain text (no HTML) to avoid injection and to align with sensitive-details handling (DECISION-INVENTORY-006).

---

## 14. Non-Functional UI Requirements
- **Performance:** show loading state within 200ms of initiating billing terms load, duplicate-check, or create; prevent double-submit.
- **Accessibility:** all inputs have labels; required fields announced; duplicate warning state is keyboard navigable and focus-managed.
- **Responsiveness:** usable on tablet-sized viewport.
- **i18n/timezone/currency:** no currency. Any displayed timestamps must include timezone or be clearly labeled as local vs UTC if shown.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty state messaging for missing billing terms; qualifies as safe because it does not change domain policy, only improves clarity. (Impacted: UX Summary, Error Flows, Acceptance Criteria)
- SD-UX-LOADING-DISABLE: Disable submit buttons during in-flight requests to prevent double-submit; safe because it prevents duplicate requests without changing business rules. (Impacted: Functional Behavior, Error Flows)
- SD-ERR-PRESERVE-FORM: Preserve user-entered values on backend error; safe because it’s purely UX ergonomics. (Impacted: Error Flows, Acceptance Criteria)

---

## 16. Open Questions
1. **Permissions (blocking):** What is the exact permission key (or keys) required to access and submit “Create Commercial Account”? (DECISION-INVENTORY-007 requires explicit permissions and fail-closed; role mapping is owned by Security.)
2. **Billing terms contract (blocking):** What is the exact Moqui service/REST endpoint to list billing terms, and what are the fields/ID type (`billingTermsId` type, display label fields)? (DECISION-INVENTORY-015 notes Billing-owned reference data; wiring is safe-to-defer but contract is required to implement.)
3. **Duplicate-check contract (blocking):** Confirm the backend contract for duplicate detection:
   - Is there a dedicated duplicate-check endpoint (preferred), or does create return `409 DUPLICATE_CANDIDATES` with candidates?
   - What fields are required for matching (legalName only vs also phone/email/taxId/external identifiers)?
   - What is the candidate DTO shape (fields available for display and matchReason)?
4. **External identifiers schema (blocking):** What is the allowed structure for `externalIdentifiers` (fixed set vs key/value list), and what validations apply?
5. **Post-create navigation route (blocking):** What is the canonical Party/Account view route in this frontend (pattern and screen name)? If none exists, should this story include creating a minimal `PartyView` screen, or is confirmation-only acceptable for MVP?

════════════════════════════════════════
ISSUE #173: [FRONTEND] [STORY] Party: Search and Merge Duplicate Parties (Basic)
LABELS: domain:crm,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:crm-domain-agent
BODY:
## 1. Story Header

**Title:** [FRONTEND] [STORY] Party: Search and Merge Duplicate Parties (Basic)

**Primary Persona:** Admin (back-office / data steward)

**Business Value:** Reduce duplicate customer records so POS workorder customer selection and downstream history are clean, consistent, and resolvable after merges.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Admin  
- **I want** to search for potential duplicate Parties and merge exactly two Parties by selecting a survivor  
- **So that** customer selection and history remain accurate and references to prior Party IDs remain resolvable for downstream systems (e.g., Workorder Execution)

### In-scope
- A Moqui-based UI flow to:
  - search Parties by name/email/phone (criteria required; no browse)
  - select exactly two Party records
  - choose survivor vs source
  - provide a required merge justification (reason)
  - confirm merge
  - show merge result including backend-provided redirect/alias behavior and merged-to ID if returned
- UX protections: preventing self-merge, enforcing “exactly two” selection, confirm dialog, error display.
- Deterministic handling of merged-party reads returning `409 PARTY_MERGED` with `mergedToPartyId` (DECISION-INVENTORY-014).

### Out-of-scope
- Field-by-field conflict resolution UI (choose which email/name/etc. to keep).
- Bulk merging (more than two at once).
- Unmerge/rollback UI.
- Editing Party details beyond what’s necessary to initiate the merge.
- Any operator actions beyond initiating the merge command (no “retry”, “force”, etc.).

---

## 3. Actors & Stakeholders

- **Admin (Primary Actor):** Executes searches, selects Parties, initiates merge, confirms, provides justification.
- **CSR / Service Advisor (Indirect Stakeholder):** Benefits from cleaner workorder selection and customer history.
- **Workorder Execution (Downstream Stakeholder):** Requires merged IDs to remain resolvable (alias/redirect) for historical references.
- **CRM Backend Services (System Actor):** Performs merge transaction, audit creation, aliasing/redirection, and enforces subtype rules.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend.
- User has authorization to perform Party merges (permission key TBD; backend must enforce).
- At least two Party records exist matching provided criteria.

### Dependencies (blocking where undefined)
- Backend endpoints/services for:
  - Party search (by name/email/phone; pagination; excludes merged by default; no unfiltered browse) (DECISION-INVENTORY-014)
  - Party merge command (sourcePartyId + survivorPartyId + justification; same subtype only; survivor wins) (DECISION-INVENTORY-014)
  - Party read behavior after merge: reads by merged party return `409 PARTY_MERGED` with `mergedToPartyId` (DECISION-INVENTORY-014)
- Permission taxonomy and exact permission keys/role mapping (DECISION-INVENTORY-007)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From CRM/Party area: **Party Search** screen includes an action “Merge Duplicates”.
- Direct navigation URL (proposed; adjust to repo conventions):
  - `/crm/party/merge` (Search + selection)
  - `/crm/party/merge/confirm` (Confirmation)
  - `/crm/party/merge/result` (Result)

### Screens to create/modify (Moqui Screens)
1. **Screen: PartyMergeSearch**
   - Search form fields:
     - `name` (string, optional)
     - `email` (string, optional)
     - `phone` (string, optional)
   - Validation: at least one criterion required; no “browse all” (DECISION-INVENTORY-014).
   - Results list with multi-select (exactly two).
   - Action button: “Continue to Merge” enabled only when exactly two selected.

2. **Screen: PartyMergeConfirm**
   - Shows the two selected parties (summary fields).
   - Requires user to pick survivor vs source (radio selection).
   - Requires a **merge justification** text input (required; min 5 chars; max 500 chars).
   - Requires acknowledgement checkbox: “I understand this merge is irreversible.”
   - Action: “Merge Parties” (calls merge service).

3. **Screen: PartyMergeResult**
   - Success message.
   - Displays:
     - `survivorPartyId`
     - `sourcePartyId`
     - `mergeAuditId` (if returned)
     - `sourcePartyFinalStatus` (expected `MERGED` if returned)
     - `redirectToPartyId` / `mergedToPartyId` (if returned)
   - Link to open survivor Party detail screen.
   - Optional “Try opening source party” link that navigates to source party detail; expected to show deterministic merged handling (409 PARTY_MERGED) and offer redirect to survivor (DECISION-INVENTORY-014).

### Navigation context
- Breadcrumb: CRM > Parties > Merge Duplicates
- After successful merge: route to result screen; provide link back to search.

### User workflows (happy + alternate)
- **Happy path:** Search (criteria required) → select 2 → choose survivor → enter justification + acknowledge → merge success → view survivor
- **Alternate path:** Search returns 0/1 results → show empty state guidance
- **Alternate path:** User selects >2 results → CTA disabled and helper message
- **Error path:** Backend validation error (e.g., cross-subtype merge, unauthorized, party already merged) → show error banner and keep user on confirm screen
- **Merged read path:** User navigates to a merged party (via link or pasted URL) → UI shows “This party was merged” and offers redirect to survivor using `mergedToPartyId` from 409 payload (DECISION-INVENTORY-014)

---

## 6. Functional Behavior

### Triggers
- User submits search form.
- User selects rows in results table.
- User clicks “Continue to Merge”.
- User selects survivor on confirm screen.
- User enters justification and checks acknowledgement.
- User clicks “Merge Parties”.

### UI actions
- **Search**
  - On submit, call backend search service with filters (name/email/phone) and pagination.
  - Render results; backend must exclude merged parties by default (DECISION-INVENTORY-014).
- **Selection**
  - Enforce exactly two selected items to proceed.
  - Display inline guidance: “Select exactly two parties to merge.”
- **Confirm**
  - Present both parties; user selects survivor (the other becomes source).
  - Require justification text and acknowledgement checkbox before enabling submission.
- **Merge submission**
  - Call backend merge service with `sourcePartyId`, `survivorPartyId`, `justification`.
  - On success, navigate to result screen and display returned details.
  - On failure, remain on confirm screen and show error mapping (see Service Contracts).

### State changes (frontend)
- Local UI state only:
  - `searchCriteria`
  - `searchResults`
  - `selectedPartyIds[2]`
  - `survivorPartyId`
  - `justification`
  - submission `loading/error` states

### Service interactions
- `crm.party.search` (read; exact name TBD)
- `crm.party.merge` (write/transaction; exact name TBD)
- `crm.party.get` (read; used for party detail navigation; must handle 409 PARTY_MERGED per DECISION-INVENTORY-014)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Search requires at least one criterion: `name` OR `email` OR `phone` (DECISION-INVENTORY-014: no unfiltered browse).
- Selection must be exactly two distinct parties.
- Survivor and source must be different.
- Justification is required (text; 5–500 chars).
- Acknowledgement checkbox must be checked before enabling “Merge Parties”.
- Backend is authoritative for:
  - “Only merge same subtype” (DECISION-INVENTORY-014)
  - “Survivor wins” merge resolution (DECISION-INVENTORY-014)

### Enable/disable rules
- “Continue to Merge” disabled unless exactly two parties selected.
- “Merge Parties” disabled unless:
  - survivor selected
  - justification valid
  - acknowledgement checked
  - not currently submitting

### Visibility rules
- Result screen shows merge audit/redirect details only if provided by backend response.
- Merged parties should not appear in search results by default (DECISION-INVENTORY-014).
- If a merged party is loaded via direct navigation (party detail), show merged banner and redirect option using `mergedToPartyId` from 409 payload (DECISION-INVENTORY-014).

### Error messaging expectations
- Self-merge: “Cannot merge a party with itself.”
- Cross-subtype merge: “Only parties of the same type can be merged.”
- Party already merged: “One of the selected parties has already been merged. Refresh and try again.”
- Unauthorized: “You don’t have permission to merge parties.”
- Conflict/concurrency: “This party record changed since you loaded it. Refresh and try again.”
- Generic failure: “Merge failed. No changes were applied.”

---

## 8. Data Requirements

### Entities involved (CRM domain)
- **Party** (read/select; post-merge status update happens server-side)
- **MergeAudit** (created server-side; displayed if returned)
- **PartyAlias / merged mapping** (server-side; UI consumes via merge response and/or 409 PARTY_MERGED payload) (DECISION-INVENTORY-014)

### Fields required for UI display (minimum)
For each Party in search results and confirm:
- `partyId` (UUID, required; canonical identifier per DECISION-INVENTORY-001)
- `partyType` (enum; required for merge constraints display; values backend-owned)
- Display name (one of):
  - `displayName` (preferred single field), OR
  - Person: `firstName`, `lastName`, OR
  - Org: `organizationName`
- Primary contact points (optional, if backend provides in summary DTO):
  - `primaryEmail` (string)
  - `primaryPhone` (string; may be normalized)
- `status` (optional; if present, used to render non-selectable merged rows)

For merge result:
- `survivorPartyId` (UUID)
- `sourcePartyId` (UUID)
- `mergeAuditId` (UUID, optional)
- `sourcePartyFinalStatus` (string/enum, optional; expected `MERGED`)
- `redirectToPartyId` or `mergedToPartyId` (UUID, optional)

For merged-party read error payload (party detail navigation):
- `errorCode` = `PARTY_MERGED`
- `mergedToPartyId` (UUID) (DECISION-INVENTORY-014)

### Read-only vs editable by state/role
- All Party fields shown are read-only in this flow.
- Editable inputs:
  - search filters
  - survivor selection
  - justification
  - acknowledgement checkbox

### Derived/calculated fields
- “Selected count” derived in UI.
- Source party derived as “the selected party that is not survivor”.

---

## 9. Service Contracts (Frontend Perspective)

> Exact service names/endpoints are not provided in the inputs. UI must call Moqui services (not direct entity-find) and rely on backend enforcement. This story remains **blocked** until contracts are confirmed.

### Load/view calls
1. **Search Parties**
   - Purpose: find candidate duplicates (no browse)
   - Request params:
     - `name` (string, optional)
     - `email` (string, optional)
     - `phone` (string, optional)
     - pagination: `pageIndex` (int, default 0), `pageSize` (int, default 25)
     - sorting: `sortBy` (string, optional), `sortOrder` (`asc|desc`, optional)
   - Response:
     - `items`: array of Party summary DTOs (fields per Data Requirements)
     - `pageIndex`, `pageSize`, `total`

2. **Get Party (for navigation / merged handling)**
   - Purpose: open party detail; must handle merged parties deterministically
   - Request: `partyId`
   - Success response: Party detail DTO (out of scope for this story; only used for navigation)
   - Error response:
     - `409` with `{ errorCode: "PARTY_MERGED", mergedToPartyId: "<uuid>" }` (DECISION-INVENTORY-014)

### Create/update calls
- None (frontend does not edit Party attributes in this story)

### Submit/transition calls
1. **Merge Parties**
   - Request (required):
     - `sourcePartyId` (UUID)
     - `survivorPartyId` (UUID)
     - `justification` (string, required)
   - Response (preferred):
     - `mergeAuditId` (UUID, optional)
     - `sourcePartyId` (UUID)
     - `survivorPartyId` (UUID)
     - `sourcePartyFinalStatus` (string/enum, optional)
     - `redirectToPartyId` (UUID, optional) OR `aliasCreated` (boolean, optional)

### Error handling expectations (UI mapping)
- `400` validation → show banner + field-level errors if provided; keep on same screen
- `403` forbidden → show permission error; disable merge action
- `404` party not found → inform user; offer to go back to search
- `409` conflict:
  - If `errorCode=PARTY_MERGED` → show merged message and offer redirect to `mergedToPartyId` (DECISION-INVENTORY-014)
  - Otherwise → prompt refresh and retry
- `500` → generic failure; do not assume partial changes

---

## 10. State Model & Transitions

### Allowed states (Party - backend-owned)
- `ACTIVE`
- `INACTIVE`
- `MERGED` (terminal for source) (DECISION-INVENTORY-014)

### Role-based transitions
- Only users with merge permission can initiate merge action (permission key TBD; DECISION-INVENTORY-007 requires explicit permissions and fail-closed behavior).

### UI behavior per state
- Parties with `status=MERGED` (if returned in search results) are non-selectable and labeled “Merged”.
- If a user attempts to open a merged party detail:
  - UI handles `409 PARTY_MERGED` and offers navigation to `mergedToPartyId` (DECISION-INVENTORY-014).

---

## 11. Alternate / Error Flows

1. **Empty search results**
   - Show message: “No parties found. Try adjusting your search.”
2. **Only one result**
   - Same as above; cannot proceed to merge.
3. **Selecting more/less than two**
   - CTA disabled; helper message displayed.
4. **Self-merge attempt**
   - Prevented by UI selection rules; also handle backend `400` with message.
5. **Backend rejects due to subtype constraint**
   - Show error: “Only parties of the same type can be merged.” Keep on confirm screen.
6. **Party already merged between search and confirm**
   - Backend returns `409 PARTY_MERGED` (or other 409). UI shows message and offers redirect if `mergedToPartyId` provided; otherwise instruct refresh.
7. **Concurrency conflict (409)**
   - Show “Refresh results” action that re-runs the search and resets selection.
8. **Unauthorized (403)**
   - Show access denied state; hide/disable merge actions; do not display partial data.
9. **Direct navigation to confirm/result without selection**
   - UI detects missing required state (no selectedPartyIds) and redirects to search with an error banner “Select two parties to merge.”

---

## 12. Acceptance Criteria

### Scenario 1: Search requires criteria and returns candidate parties
**Given** I am authenticated as an Admin with permission to merge parties  
**When** I open the Party Merge screen  
**Then** I must provide at least one search criterion (name, email, or phone) before searching  
**When** I search parties by name "John Smith"  
**Then** I see a paginated list of matching parties with partyId and display name  
**And** merged parties are not included by default

### Scenario 2: Enforce selecting exactly two parties
**Given** I have performed a party search and results are displayed  
**When** I select 1 party  
**Then** the “Continue to Merge” action is disabled  
**And** I see guidance indicating I must select exactly 2 parties  
**When** I select 2 distinct parties  
**Then** the “Continue to Merge” action becomes enabled  
**When** I select 3 parties  
**Then** the “Continue to Merge” action is disabled

### Scenario 3: Confirm survivor, require justification, and submit merge successfully
**Given** I have selected exactly two distinct parties A and B  
**When** I continue to the merge confirmation screen  
**Then** I can choose A as the survivor and B as the source  
**And** I must enter a justification and acknowledge the merge is irreversible before submission  
**When** I submit the merge  
**Then** the system displays a success result including survivorPartyId and sourcePartyId  
**And** the result includes a merge audit reference if provided by the backend

### Scenario 4: Prevent merging a party with itself (tampered state)
**Given** I am on the merge confirmation screen  
**When** the survivorPartyId equals the sourcePartyId (via tampered URL or invalid state)  
**Then** the UI must block submission  
**And** if submission is attempted, the backend error is shown as “Cannot merge a party with itself.”

### Scenario 5: Backend enforces same-subtype merge
**Given** I have selected two parties of different partyType values  
**When** I attempt to merge them  
**Then** the backend rejects the request  
**And** the UI shows “Only parties of the same type can be merged.”  
**And** no success result is shown

### Scenario 6: Merged party read returns deterministic redirect payload
**Given** party B has been merged into party A  
**When** I navigate to party B’s detail route  
**Then** the UI handles a 409 response with errorCode "PARTY_MERGED"  
**And** the UI displays the mergedToPartyId  
**And** the UI offers a link to open party A

### Scenario 7: Unauthorized access is fail-closed
**Given** I am authenticated without the merge permission  
**When** I attempt to access the Party Merge screen or call the merge service  
**Then** the backend returns 403  
**And** the UI shows an “Access denied” state without partial data

---

## 13. Audit & Observability

### User-visible audit data
- On success, display if returned:
  - `mergeAuditId`
  - survivor/source party IDs
  - server timestamp if present in response

### Status history
- Not required to display full Party history in this story.
- If backend returns `sourcePartyFinalStatus`, display it.

### Traceability expectations
- If backend returns a request/correlation ID header/value, display it in an expandable “Technical details” section for Admin troubleshooting.
- Client telemetry must not include PII beyond what is already visible on-screen; do not log full email/phone values in console.

---

## 14. Non-Functional UI Requirements

- **Performance:** Search results render efficiently for typical page sizes (default 25).
- **Accessibility:** All actions keyboard accessible; survivor radio group and acknowledgement checkbox have labels; error messages announced via ARIA live region.
- **Responsiveness:** Works on tablet width; results table may scroll horizontally.
- **i18n/timezone/currency:** Not applicable beyond standard string externalization.

---

## 15. Applied Safe Defaults

- **SD-UX-PAGINATION-01**: Default search results to paginated loading (pageSize=25); safe UI ergonomics only. (Impacted: UX Summary, Service Contracts, Alternate / Error Flows)
- **SD-UX-EMPTY-STATE-01**: Provide explicit empty-state messaging and retry guidance on no results; presentation-only. (Impacted: UX Summary, Alternate / Error Flows)
- **SD-ERR-MAP-01**: Map HTTP 400/403/404/409/500 to standard user-facing banners while preserving backend message text where safe; does not alter business logic. (Impacted: Service Contracts, Alternate / Error Flows, Business Rules)

---

## 16. Open Questions

1. **Backend contract (blocking):** What are the exact Moqui service names/endpoints and DTO schemas for:
   - Party search (filters, pagination, returned summary fields)
   - Party merge command (required fields; response payload including mergeAuditId and redirect/alias fields)
2. **Permissions (blocking):** What is the exact permission key for party merge (e.g., `crm.party.merge`) and should the UI hide the entry point or show an access-denied screen when missing? (Backend must enforce either way per DECISION-INVENTORY-007.)
3. **Justification storage (blocking):** Does the merge command require `justification` and is it stored in MergeAudit? If required, confirm min/max length and whether it is visible in audit views.
4. **Search matching rules (non-blocking if backend already exists):** Are name/email/phone searches exact, prefix, or contains? Any minimum lengths (especially for phone/email) to prevent expensive queries?
5. **Merged exclusion (non-blocking):** Does search always exclude merged parties, or is there a supported `includeMerged` toggle for Admin-only troubleshooting?

════════════════════════════════════════
ISSUE #172: [FRONTEND] [STORY] Contacts: Maintain Contact Roles and Primary Flags
LABELS: domain:crm,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:crm
BODY:
## 1. Story Header

### Title
Contacts: Maintain Contact Roles and Primary Flags (Billing / Approver / Driver)

### Primary Persona
CSR (Customer Service Representative)

### Business Value
Ensures downstream workflows (estimate approval and invoice delivery) consistently target the correct contact(s) by role, with deterministic “single primary per role” behavior owned by CRM.

---

## 2. Story Intent

### As a / I want / So that
- **As a** CSR  
- **I want** to assign one or more roles (Billing, Approver, Driver) to contacts on a customer account and optionally mark one contact as “primary” per role  
- **So that** estimate approvals and invoicing use the correct person automatically and consistently.

### In Scope
- View existing contacts for a customer account and their role assignments.
- Assign/unassign one or more roles to a contact for that account.
- Mark/unmark a contact as **Primary** for a given role.
- Enforce **single-primary-per-role per account** using CRM’s auto-demotion policy.
- Enforce validation: if `invoiceDeliveryMethod=EMAIL`, require a billing contact with a **primary email** (configuration scope safe-to-defer; enforcement is backend-owned).
- UI error handling and messaging for validation and authorization failures.
- Moqui screen/form/service wiring for the above.

### Out of Scope
- Creating/editing the underlying Contact / Party record details (name, phone, email) beyond displaying identifiers needed for selection.
- Managing the master list of roles (CRUD of role definitions).
- Implementing downstream consumers (work order execution approvals, invoice sending); this story only maintains CRM-owned role data used by them.
- Any operator actions beyond CRUD of role assignments (no bulk actions, no audit export).

---

## 3. Actors & Stakeholders
- **CSR**: assigns roles and primary flags.
- **Billing/Invoicing process** (consumer): uses Billing role + primary to determine invoice recipient.
- **Work Order / Estimate approval process** (consumer): uses Approver role to determine approver(s).
- **Dispatch/Operations** (consumer): may use Driver role to identify driver contact(s).
- **Security/Admin**: maps permissions to roles; backend enforces RBAC.

---

## 4. Preconditions & Dependencies
- A **Customer Account** exists and is accessible to the CSR.
- The account has **one or more Contacts** associated (via CRM-owned party relationships).
- CRM is the **system of record** for account-contact roles and primary policy. (DECISION-INVENTORY-002)
- Backend provides endpoints/services to:
  - Load account contacts and current role assignments.
  - Update role assignments and primary flags with proper validation and atomic auto-demotion.
  - Provide account `invoiceDeliveryMethod` and contact points (at least primary email presence) sufficient to validate the billing-contact rule. (DECISION-INVENTORY-002)
- Permissions exist to control CSR access to view and modify roles. (DECISION-INVENTORY-007)

**Decision rationale (applied):**
- **SoR**: CRM owns account-contact roles; downstream domains consume read-only to avoid split-brain. (DECISION-INVENTORY-002)
- **Primary behavior**: setting a new primary auto-demotes the prior primary atomically to reduce operator friction and race windows. (DECISION-INVENTORY-002)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Customer Account** profile screen: “Contacts” tab/section → “Manage Roles”.
- From a **Contact row** within an account: “Edit Roles”.

### Screens to create/modify
1. **Screen: `crm/Account/AccountDetail` (existing)**
   - Add/extend a “Contacts” section to show contacts associated to the account.
   - Add a “Roles” summary per contact and an “Edit Roles” action (if permitted).
2. **Screen: `crm/Account/ContactRolesEdit` (new; modal or sub-screen)**
   - Inputs: `partyId` (account), `contactPartyId` (contact), optional `returnUrl`.
   - Shows role assignments and primary toggles.
   - Save/Cancel transitions.
3. **Optional Screen: `crm/Account/RoleOverview` (defer unless requested)**
   - Per-role view of assigned contacts and current primary.

### Navigation context
- All role operations are scoped to:
  - `partyId` = account partyId (canonical identifier; do not introduce `accountId` as a separate primary key in routes). (DECISION-INVENTORY-001)
  - `contactPartyId` = contact partyId.
- Breadcrumb: Account (`partyId`) → Contacts → Roles (for `contactPartyId`).

### User workflows (happy + alternate)
**Happy path (assign roles):**
1. CSR opens account profile → Contacts section.
2. CSR clicks “Edit Roles” for a contact.
3. CSR checks one or more roles (Billing/Approver/Driver).
4. CSR optionally sets Primary for any selected role.
5. CSR clicks Save → UI persists and refreshes the Contacts list.

**Alternate path (change primary):**
1. CSR sets another contact as Primary for a role.
2. Backend auto-demotes previous primary atomically.
3. UI refresh shows the new primary.

**Alternate path (billing contact rule):**
1. Account invoice delivery method is EMAIL.
2. CSR attempts to save changes that would result in no Billing contact with a primary email.
3. Save fails with a clear validation error; UI remains in edit mode.

---

## 6. Functional Behavior

### Triggers
- Enter account contacts screen.
- Click “Edit Roles” for a contact.
- Toggle a role checkbox.
- Toggle “Primary” for a role.
- Click Save.

### UI actions
- Load contacts + existing role assignments for the account.
- Load the selected contact’s current role assignments (can be embedded in the account load).
- Allow selecting multiple roles for a contact.
- For each role selected, allow setting “Primary” for that role.
- On Save:
  - Submit role assignment changes for the selected contact.
  - Display success confirmation.
  - Refresh account contacts + role summaries.

### State changes
- Edit form tracks dirty state; Save disabled until changes exist.
- While saving: disable inputs to prevent double-submit.
- After successful save: return to account contacts view and show updated summaries.

### Service interactions
- Load: fetch account contacts, role assignments, and account invoice delivery method.
- Save: call CRM update service; handle validation errors and authorization errors deterministically.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Canonical identifiers**: UI routes and service calls use `partyId` for the account and `contactPartyId` for the contact. (DECISION-INVENTORY-001)
- **Role ownership**: roles are CRM-owned; UI treats downstream as read-only consumers. (DECISION-INVENTORY-002)
- **Primary requires role**: UI must not allow setting Primary unless the role is selected.
- **Single primary per role per account**:
  - UI allows selecting primary on any contact.
  - Backend auto-demotes prior primary atomically; UI refreshes after save. (DECISION-INVENTORY-002)
- **Billing contact rule (EMAIL delivery)**:
  - If `invoiceDeliveryMethod=EMAIL`, backend enforces: at least one Billing contact exists **and** that billing contact has a **primary email** available.
  - UI surfaces backend validation errors; UI may show a pre-save warning if it can determine missing primary email from loaded contact points. (DECISION-INVENTORY-002; config scope safe-to-defer)

### Enable/disable rules
- Primary toggle disabled unless corresponding role checkbox is selected.
- Save disabled when:
  - No changes, or
  - Form invalid (should be prevented by UI controls).

### Visibility rules
- “Edit Roles” action visible only if user has edit permission; otherwise show read-only role summaries. (DECISION-INVENTORY-007)
- If user navigates directly to edit screen without permission, screen must show access denied and not load sensitive data beyond what backend returns under 403.

### Error messaging expectations
- Validation errors:
  - Show a general error summary at top of dialog and field-level messages where applicable.
  - Example: “Billing contact with a primary email is required when invoice delivery method is Email.”
- Authorization:
  - “Access denied: you do not have permission to update contact roles for this account.”
- Not found:
  - “Account or contact not found. Return to account and try again.”

---

## 8. Data Requirements

### Entities involved (conceptual; frontend consumption)
- **Party** (Account) — `partyId` (UUID)
  - `invoiceDeliveryMethod` (string; must include `EMAIL` at minimum)
- **Party** (Contact) — `contactPartyId` (UUID)
  - `displayName` (string)
- **PartyRelationship / AccountContactRole** (CRM-owned relationship model) (DECISION-INVENTORY-002)
  - `partyId` (account)
  - `contactPartyId` (contact)
  - `roleCode` (string; e.g., `BILLING`, `APPROVER`, `DRIVER`)
  - `isPrimary` (boolean; primary within account+role)
- **ContactPoint** (for validation support; read-only in this story)
  - `partyId` (contact)
  - `kind` (`EMAIL`/`PHONE`)
  - `isPrimary` (boolean)
  - `emailAddress` (string; optional display)
  - Note: contact point kind is immutable; not edited here. (DECISION-INVENTORY-003)

### Fields (type, required, defaults)
- `partyId` (UUID, required)
- `contactPartyId` (UUID, required)
- `roleCode` (string, required)
- `isPrimary` (boolean, default `false`)

### Read-only vs editable by state/role
- Users with edit permission can modify role assignments and primary flags.
- Users without edit permission can view role summaries only.

### Derived/calculated fields (UI)
- `rolesSummary` per contact: derived display string from assignments.
- `hasPrimaryEmail` per contact (optional derived): true if contact has a primary email contact point (if provided by backend).

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking note:** Exact service names and DTO shapes must be confirmed/implemented in backend/Moqui. This story defines required capabilities and minimum DTO fields; UI implementation should bind to these contracts once finalized.

### Load/view calls
1. **`crm.account.getContactsAndRoles`** (suggested Moqui service name; exact TBD)
   - Inputs:
     - `partyId` (UUID, required)
     - `pageIndex` (int, optional)
     - `pageSize` (int, optional)
   - Returns (minimum):
     - `partyId`
     - `invoiceDeliveryMethod`
     - `contacts[]`: `{ contactPartyId, displayName }`
     - `roleAssignments[]`: `{ contactPartyId, roleCode, isPrimary }` (or embedded per contact)
     - Optional: `contactEmailSummary[]`: `{ contactPartyId, hasPrimaryEmail }` (preferred to support pre-save warnings without exposing full emails)

2. **`crm.account.getContactRoles`** (optional if not embedded)
   - Inputs: `partyId`, `contactPartyId`
   - Returns: `{ roles[]: { roleCode, isPrimary } }`

### Create/update calls
1. **`crm.account.updateContactRoles`** (suggested; exact TBD)
   - Inputs:
     - `partyId` (UUID, required)
     - `contactPartyId` (UUID, required)
     - `roles[]`: array of `{ roleCode, isPrimary }`
   - Backend requirements:
     - Validate role codes.
     - Enforce “primary requires role”.
     - Enforce single primary per role per account via atomic auto-demotion. (DECISION-INVENTORY-002)
     - Enforce billing contact rule when `invoiceDeliveryMethod=EMAIL`: require at least one Billing contact with primary email. (DECISION-INVENTORY-002)
   - Returns:
     - Updated assignments for the account or for the contact (must be sufficient for UI refresh).

### Submit/transition calls
- None.

### Error handling expectations
- `400` validation error:
  - Body includes `errorCode`, `message`, optional `fieldErrors` keyed by logical field paths (e.g., `roles[0].roleCode`, `rolesBillingRequirement`).
- `403` forbidden:
  - Body includes `errorCode=FORBIDDEN` and message.
- `404` not found:
  - Body includes `errorCode=NOT_FOUND`.
- `409` conflict:
  - Only if backend introduces optimistic locking for role assignments; if used, include `errorCode=CONFLICT` and guidance.

---

## 10. State Model & Transitions

### Allowed states
- Role assignments are active relationship records; no lifecycle states are introduced by this story.

### Role-based transitions
- With permission `crm.account.contactRoles.update` (permission key TBD; see Open Questions):
  - Add/remove roles.
  - Set/unset primary.
- Without permission:
  - View-only.

### UI behavior per state
- Loading: show loading indicator.
- Loaded (editable): enable “Edit Roles”.
- Loaded (read-only): hide/disable edit actions.
- Saving: disable inputs and Save.
- Error: remain on screen and show error summary.

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid role code:
  - UI shows backend message; user remains in edit screen.
- Primary set without role:
  - UI prevents; if backend returns error, show it and reload.
- EMAIL billing requirement violated:
  - UI shows validation error and does not close dialog.

### Concurrency conflicts
- If backend returns `409 CONFLICT`:
  - UI shows “Roles were updated by another user. Reload and try again.”
  - UI reloads account roles and discards local changes.

### Unauthorized access
- If load or save returns 403:
  - UI shows access denied state.
  - No partial data should be rendered beyond what backend returns.

### Empty states
- No contacts associated to account:
  - Show empty state message and no edit actions.

---

## 12. Acceptance Criteria

### Scenario 1: Assign multiple roles to a contact
**Given** an account (`partyId`) with a contact (`contactPartyId`) that has no assigned roles  
**When** the CSR opens “Edit Roles”, selects `BILLING` and `APPROVER`, and clicks Save  
**Then** the UI calls `crm.account.updateContactRoles` with `roles` containing `BILLING` and `APPROVER`  
**And** the account contacts view refreshes and shows the contact with both roles in the roles summary.

### Scenario 2: Designate a primary billing contact
**Given** an account with two contacts both assigned `BILLING` and neither is primary  
**When** the CSR sets Contact A as Primary for `BILLING` and saves  
**Then** after refresh Contact A is shown as `BILLING (Primary)`  
**And** Contact B is shown as `BILLING` (not primary).

### Scenario 3: Change the primary billing contact (auto-demote behavior)
**Given** an account where Contact A is `BILLING (Primary)` and Contact B has `BILLING`  
**When** the CSR sets Contact B as Primary for `BILLING` and saves  
**Then** Contact B becomes `BILLING (Primary)`  
**And** Contact A is no longer primary for `BILLING`  
**And** no intermediate UI step is required to unset Contact A first (auto-demotion).

### Scenario 4: Enforce billing contact rule when invoice delivery is EMAIL
**Given** an account where `invoiceDeliveryMethod=EMAIL`  
**And** the only `BILLING` contact does not have a primary email (or the CSR removes the last billing role)  
**When** the CSR clicks Save  
**Then** the backend returns `400` with an error indicating a billing contact with a primary email is required  
**And** the UI displays the error and remains on the edit screen without applying changes.

### Scenario 5: Prevent setting Primary without role
**Given** the CSR is editing roles for a contact  
**When** the CSR has not selected the `BILLING` role  
**Then** the UI disables the Primary toggle for `BILLING`  
**And** the UI cannot submit a payload where `isPrimary=true` for an unselected role.

### Scenario 6: Unauthorized user cannot modify roles
**Given** a user without role-edit permission  
**When** they open the account contacts view  
**Then** the UI does not show “Edit Roles” actions  
**When** they navigate directly to the edit URL  
**Then** the backend returns `403` and the UI shows an access denied state.

### Scenario 7: Correlation-safe identifiers in routes
**Given** the CSR navigates to edit roles  
**When** the URL is constructed  
**Then** it uses `partyId` and `contactPartyId` (not `customerId` or `accountId`) as route parameters.

---

## 13. Audit & Observability

### User-visible audit data
- After successful save, show a confirmation message.
- If backend returns audit fields (optional): show “Last updated at/by” in the edit screen.

### Status history
- Not required for MVP; do not add UI history without a backend contract.

### Traceability expectations
- Moqui server-side logs should include `partyId` and `contactPartyId` for update attempts.
- Client telemetry must avoid emitting PII (emails/phones) and should not log full identifiers beyond what the project’s telemetry policy allows. (Align with DECISION-INVENTORY-004/006 principles.)

---

## 14. Non-Functional UI Requirements
- **Performance:** Account contacts + roles load within 2s for typical accounts; list must support pagination if backend provides it.
- **Accessibility:** All checkboxes/toggles keyboard accessible; error summary announced to screen readers.
- **Responsiveness:** Edit screen usable on tablet widths; avoid horizontal overflow.
- **i18n:** Role labels should be displayable via i18n keys if the project uses i18n; otherwise use backend-provided display labels (see Open Questions).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a non-destructive empty state when an account has no contacts; qualifies as safe because it does not affect domain rules and only improves usability. (Impacted: UX Summary, Alternate/Empty states)
- SD-UX-DOUBLE-SUBMIT: Disable Save while request in-flight to prevent duplicate submissions; qualifies as safe because it is UI ergonomics with no policy impact. (Impacted: Functional Behavior, Error Flows)
- SD-ERR-STANDARD-MAP: Map common HTTP errors (400/403/404/409/5xx) to user-friendly messages while preserving backend message text when provided; qualifies as safe because it’s standard error presentation without changing business logic. (Impacted: Service Contracts, Error Flows)

---

## 16. Open Questions
1. **[BLOCKER] Backend contract finalization:** What are the exact Moqui service names (or REST endpoints) and DTO shapes for:
   - Loading account contacts + role assignments + `invoiceDeliveryMethod`
   - Updating a contact’s roles and primary flags
   Include required params, returned fields, and error payload schema (`errorCode`, `message`, `fieldErrors`).
2. **[BLOCKER] Permission keys:** What permission(s) gate:
   - Viewing role assignments
   - Updating role assignments  
   (DECISION-INVENTORY-007 requires explicit permissions; exact keys/role mapping is not provided here.)
3. **[BLOCKER] Role code source:** Are role codes strictly limited to `BILLING|APPROVER|DRIVER` for MVP, or must the UI load an allowed role list from backend (with display labels and ordering)?
4. **Billing EMAIL rule data dependency:** For enforcing “billing contact with primary email required”, will the load DTO include `hasPrimaryEmail` per contact (preferred), or must UI infer from contact points (which may expose PII)?

════════════════════════════════════════
ISSUE #171: [FRONTEND] [STORY] Contacts: Store Communication Preferences and Consent Flags
LABELS: domain:crm,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:crm-domain-agent
BODY:
## 1. Story Header

### Title
[FRONTEND] [STORY] Contacts: Manage Communication Preferences & Consent Flags (Per Person)

### Primary Persona
Customer Service Representative (CSR)

### Business Value
Ensure outbound communications (notifications/marketing) follow the customer’s stated preferred channel and consent choices, improving compliance and customer experience while providing an auditable record of changes.

---

## 2. Story Intent

### As a / I want / So that
- **As a** CSR  
- **I want** to view and update a person’s communication preferences (preferred channel + email/SMS consent flags)  
- **So that** communications adhere to customer preferences and consent, with a clear audit trail.

### In-scope
- UI to **view** and **edit** a person’s CRM-owned communication preferences:
  - preferred communication channel
  - email marketing consent flag
  - SMS notification consent flag
  - “last updated” timestamp and “update source” (viewable; source may be system-populated)
- Moqui screen(s), forms, transitions, and service calls required for:
  - load existing preferences for a person (by `partyId`)
  - create initial preference record if missing
  - update existing preference record
- Standard error handling and empty states
- Role-gating for CSR access (permission keys must be confirmed; fail-closed)

### Out-of-scope
- Defining or changing CRM domain business rules beyond what is specified in CRM domain docs (no new policy invention)
- Customer dedup/merge behavior
- Workexec notification sending logic (consumer use is “stubbed”)
- Bulk updates across multiple people
- Managing contact points (emails/phones) themselves

---

## 3. Actors & Stakeholders
- **CSR (primary user):** updates preferences on behalf of a customer/person.
- **Customer/Person (data subject):** whose preferences are recorded.
- **Downstream consumers (e.g., Workexec):** read preferences to choose channel; not modified here.
- **CRM backend services:** system of record for preferences and audit metadata.
- **Security/Authorization stakeholders:** define permission-to-role mapping (DECISION-INVENTORY-007 indicates explicit permissions; mapping safe-to-defer).

---

## 4. Preconditions & Dependencies
- CSR is authenticated in the POS frontend.
- CSR is operating in a selected person/customer context identified by **`partyId`** (canonical identifier per DECISION-INVENTORY-001).
- Backend provides CRM services for communication preferences (load + upsert) with:
  - stable request/response DTOs
  - error payloads including `errorCode`, `message`, and optional `fieldErrors` (pattern used in CRM docs for other endpoints; exact contract for this feature is not provided and is blocking)
- Frontend has a consistent mechanism to:
  - attach correlation/request IDs to requests (if applicable)
  - handle 401/403/404/409/500 consistently

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an existing **Contact/Person detail** area in POS:
  - “Communication Preferences” section/tab/panel.
- Direct navigation URL (route must use canonical `partyId`):
  - `/crm/contact/preferences?partyId=<partyId>` (exact base path must match repo conventions)

### Screens to create/modify
- **Modify existing Contact/Person detail screen** to include a “Communication Preferences” section with:
  - read-only summary (when not editing)
  - Edit action (only when permitted)
- **New or nested screen** for edit flow if not inline:
  - Example screen name (illustrative; align with repo conventions): `apps/pos/screens/crm/contact/CommunicationPreferences.xml`

### Navigation context
- Breadcrumb: Contacts → {Person Name} → Communication Preferences
- Must maintain selected person context (`partyId`) across transitions.
- If invoked from another flow, preserve return navigation (standard Moqui return pattern if used elsewhere in repo).

### User workflows (happy + alternate paths)

**Happy path (existing preferences)**
1. CSR opens person record.
2. UI loads current preference record for `partyId`.
3. CSR enters edit mode.
4. CSR edits preferred channel and/or consent flags.
5. CSR saves; UI shows success and updated “last updated/source”.

**Happy path (no preferences yet)**
1. CSR opens person record.
2. UI shows “No preferences recorded yet”.
3. CSR enters values and saves.
4. UI shows persisted values + audit metadata.

**Alternate paths**
- CSR cancels edits → no changes persisted.
- Backend validation error → show field-level errors where possible.
- Unauthorized → show access denied and disable editing.
- Party not found → show not found state and link back to search.
- Concurrency conflict (if backend supports optimistic locking) → prompt reload.

---

## 6. Functional Behavior

### Triggers
- Entering the Communication Preferences view for a specific `partyId`.
- Clicking “Edit” (if read-only view by default) or editing inline.
- Clicking “Save”.

### UI actions
- View mode:
  - Display preferred channel, consent flags, last updated timestamp (UTC rendered in local time), update source.
- Edit mode:
  - Preferred channel selection control (controlled vocabulary from backend).
  - Consent flags toggles/controls for:
    - Email marketing consent
    - SMS notification consent
  - Save/Cancel actions.
- Save action:
  - Calls backend upsert (create-or-update) service if available; otherwise conditional create/update based on load result (blocking until contract confirmed).
  - Shows success toast/alert and returns to view mode.

### State changes (frontend)
- `loading` → `loaded`
- `editing` toggles
- `saving` → `saved` or `error`
- Local dirty-tracking to prevent accidental navigation loss (confirm dialog)

### Service interactions (frontend → Moqui/backend)
- On load: fetch preferences by `partyId`.
- On save:
  - Submit payload including editable fields and any required concurrency token (if provided by backend).
  - `updateSource` handling must be confirmed (see Open Questions).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Canonical identifier**
  - UI routes and service calls MUST use `partyId` as the identifier (DECISION-INVENTORY-001).
- **Preferred channel**
  - Must be one of backend-provided enum values.
  - UI must prevent submission if required and unset (requirement depends on backend contract; do not assume Not Null).
- **Consent flags**
  - UI must submit booleans or null per backend contract.
  - UI must not invent consent semantics beyond display guidance; if backend defines “null treated as opt-out”, UI may display that as informational only.
- **updateSource**
  - UI must either:
    - send `updateSource` explicitly, or
    - rely on backend to populate from authenticated context.
  - This is a blocking contract decision.

### Enable/disable rules
- If user lacks edit permission:
  - Fields are read-only; hide/disable Save; show informational banner.
- While saving:
  - Disable inputs and Save to prevent duplicate submits.

### Visibility rules
- If no record exists:
  - Show empty-state copy and “Add preferences” CTA.
- Always show audit metadata when available:
  - `updatedAt`/`updatedTimestampUTC`
  - `updateSource`

### Error messaging expectations
- 400 validation errors:
  - Show a top-level “Fix the highlighted fields” message.
  - Map known field errors to corresponding controls.
- 403:
  - “You don’t have permission to update communication preferences.”
- 404:
  - If party not found: “Contact not found.”
  - If preference not found (but party exists): treat as empty state (only if backend uses 404 for missing preference; must be confirmed).
- 409:
  - If optimistic locking is implemented: “Preferences were updated by someone else. Reload and try again.”

---

## 8. Data Requirements

### Entities involved (conceptual; CRM-owned)
- `CommunicationPreference` (primary record for a party/person)
- **No separate `ConsentRecord` is assumed in the UI** unless backend contract explicitly requires it. The original story mentions `ConsentRecord`, but CRM domain docs do not define it as a required separate UI-managed entity for this feature; therefore this remains contract-dependent and is a blocking clarification.

### Fields (type, required, defaults)

**Identifier/context**
- `partyId` (UUID) — required for load/save (DECISION-INVENTORY-001).

**Editable (exact names TBD by backend DTO)**
- `preferredCommunicationChannel` (Enum/String) — requiredness TBD by backend.
- `emailMarketingConsent` (Boolean|null) — nullable allowed (contract TBD).
- `smsNotificationConsent` (Boolean|null) — nullable allowed (contract TBD).

**Read-only (display)**
- `updatedAt` / `updatedTimestampUTC` (DateTime, UTC) — optional if backend provides.
- `updateSource` (String) — optional if backend provides.

### Read-only vs editable by state/role
- CSR with edit permission: editable fields above.
- Without permission: all fields read-only.

### Derived/calculated fields
- Display helper for consent:
  - `true` → “Opted in”
  - `false` → “Opted out”
  - `null` → “Not set” (and if backend defines null-as-opt-out, show secondary text “Treated as opted out”)

---

## 9. Service Contracts (Frontend Perspective)

> Blocking note: CRM domain docs provide patterns for DTO/error payloads but do not define the specific communication-preferences endpoints/services. This story requires a concrete contract (TASK-CRM-CONTRACT-* style dependency) before implementation can be finalized.

### Load/view calls
- **Operation:** Get communication preferences for a party/person
- **Input:** `partyId` (UUID)
- **Expected outcomes (must be confirmed):**
  - `200 OK` with `CommunicationPreference` DTO
  - `404 Not Found` if party does not exist
  - Missing preference record behavior:
    - either `200` with `null`/empty DTO, or
    - `404` with a specific `errorCode` indicating “PREFERENCES_NOT_FOUND” (preferred if using 404)

### Create/update calls
- **Operation:** Upsert communication preferences for a party/person
- **Input payload (DTO fields must be confirmed):**
  - `partyId` (UUID)
  - `preferredCommunicationChannel`
  - `emailMarketingConsent`
  - `smsNotificationConsent`
  - `updateSource` (if required by backend)
  - `version`/`etag` (if optimistic locking is used)
- **Expected outcomes:**
  - `200 OK` (update) and/or `201 Created` (create) — confirm which codes are used
  - `400 Bad Request` with `errorCode` and optional `fieldErrors`
  - `403 Forbidden` if unauthorized
  - `404 Not Found` if party missing
  - `409 Conflict` if concurrency/version conflict (if implemented)

### Submit/transition calls
- Not a lifecycle workflow; no additional transitions beyond save/cancel UI transitions.

### Error handling expectations
- Errors must be surfaced non-destructively with:
  - preserved form state
  - clear message
  - ability to retry
- Client telemetry must not log PII beyond `partyId` already present in route context.

---

## 10. State Model & Transitions

### Allowed states
(UI-level)
- `VIEW` (loaded, not editing)
- `EDIT` (dirty tracking enabled)
- `SAVING`
- `ERROR` (recoverable)

### Role-based transitions
- CSR with permission:
  - VIEW → EDIT → SAVING → VIEW
- CSR without permission:
  - VIEW only; EDIT not allowed

### UI behavior per state
- VIEW: show values + metadata; show Edit button if permitted.
- EDIT: show inputs + Save/Cancel; show warning on navigation if dirty.
- SAVING: disable inputs; show progress indicator.
- ERROR: show error banner and allow retry or cancel.

---

## 11. Alternate / Error Flows

### Validation failures (400)
- Backend returns validation errors (invalid enum, wrong types, missing required fields).
- UI maps:
  - preferred channel invalid → field error “Select a valid channel.”
  - consent invalid → field error “Consent must be yes/no/unset.”
  - missing updateSource → blocking error (should not occur if backend infers or UI injects)

### Concurrency conflicts (409) — if supported
- When save returns 409:
  - UI prompts reload; offer “Reload preferences” action that re-fetches and discards local edits (after confirmation).
  - If backend returns `currentVersion`, UI should store it and reattempt only after user confirms.

### Unauthorized access (401/403)
- 401: redirect to login/session renewal per app convention.
- 403: stay on page, disable editing, show banner.

### Empty states
- No preference record:
  - Show empty state + Add button (enters EDIT with blank form).
- No person context / missing `partyId`:
  - Show error and link back to Contacts search.

---

## 12. Acceptance Criteria

### Scenario 1: View existing communication preferences
**Given** I am an authenticated CSR with permission to view CRM contacts  
**And** I am viewing a person identified by `partyId` with an existing communication preferences record  
**When** I open the “Communication Preferences” section  
**Then** I see the preferred communication channel  
**And** I see the email marketing consent value  
**And** I see the SMS notification consent value  
**And** I see “last updated” timestamp and “update source” when provided by the backend.

### Scenario 2: Create preferences when none exist
**Given** I am an authenticated CSR with permission to edit CRM contacts  
**And** I am viewing a person identified by `partyId` with no existing communication preferences record  
**When** I choose “Add preferences”  
**And** I set preferred channel to a valid value (e.g., “EMAIL”)  
**And** I set email marketing consent to opt-in  
**And** I set SMS notification consent to opt-out  
**And** I click “Save”  
**Then** the system persists the preferences via the upsert/create service  
**And** I return to view mode showing the saved values  
**And** the “last updated” timestamp is populated if the backend provides it  
**And** the “update source” is populated according to the backend contract (either inferred or provided).

### Scenario 3: Update only the preferred channel and keep other fields unchanged
**Given** I am an authenticated CSR with permission to edit CRM contacts  
**And** a person has existing preferences with preferred channel “EMAIL” and email marketing consent set to opt-in  
**When** I edit the preferences and change preferred channel to “SMS”  
**And** I click “Save”  
**Then** the preferred channel is “SMS”  
**And** the email marketing consent remains opt-in  
**And** the SMS notification consent remains unchanged  
**And** the “last updated” timestamp is updated if the backend provides it.

### Scenario 4: Display null consent as “Not set” (and treated as opted out if backend defines it)
**Given** I am an authenticated CSR with permission to view CRM contacts  
**And** a person’s SMS notification consent is null  
**When** I view the Communication Preferences section  
**Then** the UI indicates SMS consent is “Not set”  
**And** if the backend contract states null is treated as opted out, the UI also indicates that treatment as informational text  
**And** the raw value remains unchanged unless I explicitly set it.

### Scenario 5: Validation error on invalid preferred channel
**Given** I am an authenticated CSR with permission to edit CRM contacts  
**When** I attempt to save preferences with an invalid preferred channel value  
**Then** the save fails with a 400 validation error  
**And** I see an error message indicating the channel is invalid  
**And** my entered values remain on screen for correction.

### Scenario 6: Unauthorized edit attempt
**Given** I am an authenticated CSR without permission to edit CRM contacts  
**When** I open the Communication Preferences section  
**Then** I can view the existing values if I have view permission  
**And** I cannot edit or save changes  
**And** I see a message indicating I lack permission to update preferences.

### Scenario 7: Missing preference record is treated as empty state (contract-dependent)
**Given** I am an authenticated CSR with permission to edit CRM contacts  
**And** the backend indicates “no preferences exist yet” for the `partyId` (either via 404 PREFERENCES_NOT_FOUND or via 200 with empty payload)  
**When** I open the Communication Preferences section  
**Then** the UI shows the empty state and allows “Add preferences”  
**And** it does not show a generic error banner.

### Scenario 8: Concurrency conflict (only if backend implements optimistic locking)
**Given** I am an authenticated CSR with permission to edit CRM contacts  
**And** I load preferences and begin editing  
**And** another user updates the same preferences before I save  
**When** I click “Save”  
**Then** the backend returns 409 Conflict  
**And** the UI shows a reload prompt  
**And** I can reload to see the latest values and re-apply changes.

---

## 13. Audit & Observability

### User-visible audit data
- Display (when provided by backend):
  - `updatedAt`/`updatedTimestampUTC` rendered in user locale/timezone
  - `updateSource` (string identifier)
- Do not display actor identifiers unless explicitly provided and permitted (not required by this story).

### Status history
- Not required unless backend provides an audit history endpoint (out of scope). Only “last updated” is required.

### Traceability expectations
- Frontend should include correlation headers/IDs per platform standard (if available).
- Log/telemetry capture:
  - load failures
  - save failures
  - 403/409 occurrences
- Client telemetry must not include PII beyond `partyId`; do not log emails/phones.

---

## 14. Non-Functional UI Requirements
- **Performance:** Preference load should not block rendering of the rest of contact detail; show skeleton/loading indicator for this section.
- **Accessibility:** All controls keyboard-navigable; toggles have accessible labels; error messages announced (ARIA).
- **Responsiveness:** Works on tablet-sized POS devices; form fields stack vertically on narrow widths.
- **i18n/timezone:** Render UTC timestamp in local timezone; all labels/messages use i18n keys if project convention exists.
- **Security:** Do not expose preferences in console logs; respect authorization errors without leaking details.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a standard empty-state message and “Add preferences” CTA when no preference record exists; safe because it does not change business rules, only UI affordance. (Impacted: UX Summary, Error Flows, Acceptance Criteria)
- SD-ERR-MAP-HTTP: Map HTTP 400/401/403/404/409/500 into consistent toast/banner patterns; safe because it follows backend status semantics without inventing policies. (Impacted: Business Rules, Service Contracts, Error Flows)
- SD-UX-DIRTY-CONFIRM: Add dirty-form navigation confirmation on unsaved edits; safe because it’s UI ergonomics only. (Impacted: Functional Behavior, UX Summary)

---

## 16. Open Questions
1. **Backend contract (blocking):** What are the exact Moqui service names and/or REST endpoints for:
   - load communication preferences by `partyId`
   - upsert (create/update) communication preferences by `partyId`  
   Include request/response DTO field names, required fields, and error payload shape (`errorCode`, `message`, `fieldErrors`).
2. **Missing record semantics (blocking):** When a party exists but has no preferences yet, does the backend return:
   - `404` with a specific `errorCode` (preferred), or
   - `200` with an empty/null payload?
3. **updateSource handling (blocking):** Is `updateSource` required on write? If yes, should:
   - the frontend send a constant value (what exact value?), or
   - Moqui/backend infer it from the authenticated client/app context?
4. **Consent model (blocking):** Are consent flags stored only on the communication preferences DTO, or is there a separate `ConsentRecord` entity/DTO the UI must manage? If separate, define how they relate and which service(s) write them.
5. **Permissions (blocking):** What are the explicit permission keys for:
   - viewing communication preferences
   - editing communication preferences  
   Confirm whether view is allowed when edit is denied (DECISION-INVENTORY-007 requires explicit permissions and fail-closed).
6. **Optimistic locking (blocking):** Is optimistic locking required for this record? If yes, what field is used (`version`, `lastUpdatedStamp`, ETag), and what is the expected 409 response payload (e.g., `currentVersion`) and UI resolution flow?

---

## Original Story (Unmodified – For Traceability)

Title: [FRONTEND] [STORY] Contacts: Store Communication Preferences and Consent Flags — URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/171

════════════════════════════════════════
ISSUE #169: [FRONTEND] [STORY] Vehicle: Create Vehicle Record with VIN and Description
LABELS: domain:crm,type:story,status:draft,blocked:clarification,risk:incomplete-requirements,agent:story-authoring,agent:crm-domain-agent
BODY:
## 1. Story Header

**Title**  
[FRONTEND] [STORY] CRM Vehicle: Create Vehicle Record (VIN, Unit #, Description, Optional Plate)

**Primary Persona**  
Service Advisor (POS user)

**Business Value**  
Creates a stable `vehicleId` in CRM so downstream flows (estimate/workorder creation, service history, billing) can reliably attach activity to the correct vehicle.

---

## 2. Story Intent

**As a** Service Advisor  
**I want** to create a vehicle record by entering VIN, unit number, description (make/model/year free text), and optional license plate  
**So that** workorders/estimates/invoices can reference a stable `vehicleId` and future visits can find the same vehicle quickly.

### In-scope
- A Moqui screen flow to create a Vehicle in CRM
- Client-side validations (basic VIN sanity, required fields)
- Submit to Moqui service/API and handle success/error responses
- Post-create navigation to a vehicle detail view (or confirmation view) with the new `vehicleId`

### Out-of-scope
- External VIN decode (optional stub only; no real integration)
- Vehicle ownership association (linking to account/party) unless explicitly required by backend contract
- Advanced dedupe/merge logic
- Editing vehicle after creation (separate story)

---

## 3. Actors & Stakeholders
- **Service Advisor**: creates vehicle records during customer intake or workorder prep
- **CRM domain (system of record)**: persists vehicles and enforces invariants
- **Workexec** (consumer): stores `vehicleId` on estimates/workorders
- **Billing** (consumer): uses `vehicleId` to link invoices/history
- **Support/Admin**: cares about auditability of created records

---

## 4. Preconditions & Dependencies
- User is authenticated in the frontend.
- User has permission to create vehicles (permission key(s) must be confirmed; backend must enforce fail-closed per DECISION-INVENTORY-007).
- Moqui exposes a dedicated create-vehicle service (screen must call service; not direct entity writes).
- Moqui exposes a dedicated load-vehicle-by-`vehicleId` service for the post-create view.
- **Dependency (blocking):** exact service names/routes and DTO schemas must be confirmed (see Open Questions #3).
- **Dependency (blocking):** VIN uniqueness scope and duplicate error payload must be confirmed (see Open Questions #1).
- **Dependency (blocking):** whether create requires `partyId`/account context must be confirmed (see Open Questions #2).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
At least one entry path must exist:
- From a customer/account context: “Add Vehicle”
- From a general vehicle search/list: “Create Vehicle”

### Screens to create/modify
1. **Screen:** `crm/VehicleCreate`  
   - Purpose: data entry + submit
2. **Screen:** `crm/VehicleView` (or reuse an existing vehicle detail screen if present)  
   - Purpose: show created vehicle summary including `vehicleId`

### Navigation context
- If launched from within a customer context, preserve caller return navigation and context parameters through the create flow.
- If launched globally, allow create without customer context **unless backend requires it** (blocking).

### User workflows (happy + alternate)
**Happy path**
1. Service Advisor opens Create Vehicle screen.
2. Enters required fields: VIN, Unit Number, Description.
3. Optionally enters License Plate.
4. Submits.
5. UI navigates to Vehicle View with returned `vehicleId`.

**Alternate paths**
- Cancel → return to caller (return URL) without changes.
- Backend reports duplicate/conflict → remain on form; show banner + field-level error where possible.
- Backend returns 403 → show access denied state; do not show form actions.

---

## 6. Functional Behavior

### Triggers
- User selects “Create Vehicle” from an entry point.

### UI actions
- Inputs:
  - VIN
  - Unit Number
  - Description (free text “Make/Model/Year”)
  - License Plate (optional)
- Actions:
  - **Create** (primary)
  - **Cancel** (secondary)

### State changes (frontend)
- Form state: pristine/dirty, per-field validation errors.
- Submission state: in-flight disables inputs and Create button.
- On success: navigate to view screen with `vehicleId` as route parameter; optionally show a one-time success banner.

### Service interactions
- **On submit:** call Moqui create-vehicle service with normalized payload.
- **On success:** call is complete; navigation to VehicleView triggers load service for persisted values.
- **On failure:** map service error payload to banner and field errors (see Service Contracts + Error Flows).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (client-side; blocks submit)
- Required:
  - `vin`
  - `unitNumber`
  - `description`
- VIN sanity (UI-only validation; backend remains authoritative):
  - Trim whitespace; normalize to uppercase before validation and submission.
  - Must be exactly 17 characters.
  - Must match `^[A-HJ-NPR-Z0-9]{17}$` (excludes I, O, Q).
- License plate:
  - Optional; trim whitespace.
  - If empty after trim, submit as null/omitted (match backend contract once known).

### Enable/disable rules
- Create disabled when:
  - form invalid, or
  - submission in progress

### Visibility rules
- No VIN decode UI is required. If a placeholder is present, it must be non-blocking and clearly marked as not implemented; it must not mutate fields automatically.

### Error messaging expectations
- Client-side validation: inline errors per field.
- Backend 400: show banner “Fix validation errors” and map `fieldErrors` if provided.
- Backend 409: show banner “A vehicle with this VIN already exists” (do not reveal any other vehicle details unless backend explicitly returns safe, authorized duplicate candidates).
- Backend 401/403: show access denied; do not attempt to infer existence of duplicates.

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Vehicle** (CRM-owned; created by service)
- **Vehicle identifiers** are treated as simple fields unless backend requires nested structure.

### Fields (create form + payload)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| `vin` | string | Yes | none | Trim + uppercase; validate 17 chars excluding I/O/Q |
| `unitNumber` | string | Yes | none | Trim |
| `description` | string | Yes | none | Free text make/model/year |
| `licensePlate` | string | No | null | Trim; null/omit if empty (contract-dependent) |
| `partyId` | UUID | TBD | none | Only if backend requires association-at-create (blocking) |
| `vehicleId` | UUID | Returned | n/a | Read-only, generated by backend |

### Read-only vs editable by state/role
- Create screen: all inputs editable.
- View screen: all fields read-only in this story.

### Derived/calculated fields
- `vinNormalized` (UI-only): uppercase/trimmed VIN used for validation and submission.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui must expose dedicated services (not direct entity-find from the browser). Exact names/routes are **blocking** until confirmed.

### Load/view calls
- **Load Vehicle (VehicleView)**
  - Input: `vehicleId` (UUID)
  - Output (minimum):
    - `vehicleId`
    - `vin`
    - `unitNumber`
    - `description`
    - `licensePlate` (nullable)
    - audit fields if available: `createdAt`, `createdByUserId`/`createdByUserName`

### Create/update calls
- **Create Vehicle**
  - Input (minimum):
    - `vin` (normalized)
    - `unitNumber`
    - `description`
    - `licensePlate` (optional)
    - `partyId` (only if required by backend)
  - Output (required):
    - `vehicleId`
  - Output (preferred):
    - persisted vehicle summary fields (same as load) to support immediate confirmation without extra load

### Submit/transition calls
- None beyond create.

### Error handling expectations (contract shape)
Frontend expects a consistent error payload shape:
- `errorCode` (string)
- `message` (string, safe for display)
- optional `fieldErrors` (map of fieldName → message)

HTTP mapping:
- `400`: validation errors; may include `fieldErrors`
- `401/403`: forbidden; no partial data
- `409`: conflict/duplicate; `errorCode` should distinguish duplicate (e.g., `DUPLICATE_VIN`) if available
- `404` on view: vehicle not found
- `5xx`: generic error; retry allowed

---

## 10. State Model & Transitions

### Allowed states
- No explicit vehicle lifecycle state is defined in CRM docs for this feature; treat created vehicles as immediately usable.

### Role-based transitions
- Create action available only to users with the create-vehicle permission (permission key TBD; backend must enforce per DECISION-INVENTORY-007).

### UI behavior per state
- N/A (no lifecycle state in this story).

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing required fields → block submit; show inline errors.
- Invalid VIN pattern/length → block submit; show inline error: “VIN must be 17 characters and cannot include I, O, or Q.”

### Backend validation failures (400)
- Show banner “Fix validation errors”.
- If `fieldErrors` present, map to fields and keep user input intact.

### Duplicate/conflict (409)
- Remain on create screen.
- Show banner indicating duplicate VIN.
- If backend returns safe duplicate references (e.g., existing `vehicleId`) and user is authorized, optionally show a link to view the existing vehicle; otherwise do not show any identifying details.

### Unauthorized access (401/403)
- Direct navigation to create URL:
  - If unauthenticated: route to login per app standard.
  - If authenticated but forbidden: show access denied state; do not render form submission controls.

### Empty states / not found (VehicleView 404)
- Show “Vehicle not found” with navigation back to caller (or vehicle search).

### Concurrency conflicts
- Not applicable for create beyond uniqueness conflicts.

---

## 12. Acceptance Criteria

### Scenario 1: Successful vehicle creation
**Given** the Service Advisor is authenticated and authorized to create vehicles  
**And** they are on the Vehicle Create screen  
**When** they enter VIN `1hgcm82633a004352`, unit number `TRK-102`, and description `2018 Ford F-150`  
**And** they enter license plate ` ABC123 `  
**And** they submit the form  
**Then** the frontend must submit VIN as `1HGCM82633A004352` (trimmed + uppercased)  
**And** the backend returns a new `vehicleId`  
**And** the UI navigates to Vehicle View for that `vehicleId`  
**And** Vehicle View loads and displays the persisted vehicle fields.

### Scenario 2: Client-side validation blocks missing required fields
**Given** the Service Advisor is on the Vehicle Create screen  
**When** they leave `unitNumber` empty  
**And** they click Create  
**Then** the form must not submit  
**And** an inline error indicates `unitNumber` is required.

### Scenario 3: Client-side validation blocks invalid VIN format
**Given** the Service Advisor is on the Vehicle Create screen  
**When** they enter VIN `1HGCM82633A00435I`  
**And** they click Create  
**Then** the form must not submit  
**And** an inline error indicates VIN cannot include I, O, or Q.

### Scenario 4: Backend rejects duplicate VIN (409)
**Given** a vehicle already exists that conflicts with VIN `1HGCM82633A004352` per backend uniqueness policy  
**When** the Service Advisor submits a create request with VIN `1HGCM82633A004352` and other valid fields  
**Then** the backend responds with HTTP 409 and an `errorCode` indicating a duplicate/conflict  
**And** the UI remains on the create form  
**And** the UI displays a non-sensitive error message indicating the VIN already exists.

### Scenario 5: Unauthorized user cannot access create
**Given** a user is authenticated but lacks permission to create vehicles  
**When** they attempt to open the Vehicle Create screen  
**Then** the UI shows an access denied state  
**And** no create request can be submitted from that screen.

### Scenario 6: Vehicle view not found
**Given** the user navigates to Vehicle View with a `vehicleId` that does not exist  
**When** the Vehicle View load call returns 404  
**Then** the UI shows “Vehicle not found” and provides a way to navigate back.

---

## 13. Audit & Observability

### User-visible audit data
- On VehicleView, display if provided by backend:
  - `createdAt` (rendered in user timezone)
  - `createdBy` (user display name or ID)

### Status history
- Not applicable.

### Traceability expectations
- Moqui server-side should inject/propagate `X-Correlation-Id` and `traceparent` per platform standards (DECISION-INVENTORY-004 for correlation semantics; apply same header approach for CRM services).
- Frontend telemetry/logging:
  - Must not log VIN or license plate values.
  - May log `vehicleId` on success.

---

## 14. Non-Functional UI Requirements
- **Performance:** Disable duplicate submissions; show immediate loading state on submit.
- **Accessibility:** Inputs have labels; errors are programmatically associated with fields; keyboard-only flow works.
- **Responsiveness:** Usable on tablet POS layouts.
- **i18n/timezone/currency:** No currency; timestamps (if shown) render in user timezone; strings are i18n-ready.

---

## 15. Applied Safe Defaults
- **SD-UI-EMPTY-STATE**: Provide a “Vehicle not found” empty state on 404 in VehicleView; safe UI ergonomics. (Sections: UX Summary, Error Flows)
- **SD-UI-SUBMIT-LOCK**: Disable Create and inputs during in-flight request to prevent double submits; safe UX pattern. (Sections: Functional Behavior, Non-Functional)
- **SD-ERR-GENERIC-5XX**: Map unknown/5xx errors to a generic retryable message; safe standard error handling. (Sections: Service Contracts, Error Flows)

---

## 16. Open Questions
1. **VIN uniqueness scope (blocking):** Is VIN uniqueness **global** across all vehicles or **scoped** (e.g., per party/account/location)? What `errorCode` is returned on duplicate (e.g., `DUPLICATE_VIN`) and does it ever include a safe reference to an existing `vehicleId`?
2. **Association-at-create (blocking):** Does create-vehicle require a `partyId` (canonical CRM identifier per DECISION-INVENTORY-001) or any account/customer context? If yes, is it required or optional, and what is the expected behavior when omitted?
3. **Moqui service/API contract (blocking):** What are the exact Moqui service names or REST endpoints for:
   - create vehicle
   - load vehicle by `vehicleId`  
   Include request/response DTO fields and the standard error payload shape (`errorCode`, `message`, `fieldErrors`).
4. **Authorization model (blocking):** What permission key(s) gate vehicle creation and vehicle view? (Recommend a dedicated permission per DECISION-INVENTORY-007, e.g., `crm.vehicles.create` and `crm.vehicles.read`, but exact keys must match Security mapping.)
5. **License plate structure (clarification):** Is license plate stored as a single string only, or does backend require plate + region (state/province/country)? If region is required, provide field names and validation rules.

