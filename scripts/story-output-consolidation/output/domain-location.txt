════════════════════════════════════════
ISSUE #141: [FRONTEND] [STORY] Locations: Create Bays with Constraints and Capacity
LABELS: type:story,status:draft,blocked:clarification,risk:incomplete-requirements,domain:location,agent:story-authoring,agent:location-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Locations: Create Bays with Constraints and Capacity

## Primary Persona
Shop Administrator (Admin)

## Business Value
Enables accurate scheduling/dispatch by allowing admins to define each service bay’s operational status, capacity, and constraint references (supported services + required skills), reducing mis-assignments and improving throughput.

---

# 2. Story Intent

## As a / I want / So that
**As a** Shop Administrator  
**I want** to create a service bay under a location with bay type, status, capacity, and constraint references  
**So that** scheduler/dispatch can select an appropriate ACTIVE bay that meets service/skill requirements.

## In-Scope
- Admin UI to **create** a Bay under a selected Location.
- Capture and validate Bay fields: `name`, `bayType`, `status`, `capacity.maxConcurrentVehicles`, `supportedServiceIds[]`, `requiredSkillRequirements[]`.
- Enforce Bay name uniqueness within a Location (server-side) and map conflict errors to the Name field. (Decision rationale: LOCATION_DOMAIN_NOTES “Bay Name Uniqueness Within Location”; uniqueness is per location, trim whitespace before submit.)
- Basic admin UI to confirm the created bay exists (post-create view/return to list).
- Error handling for validation and conflict responses (`400`, `401`, `403`, `404`, `409`) and generic `5xx`.
- Moqui screens/forms/transitions wired to backend endpoints using the Location REST convention prefix `/rest/api/v1/location/...` (Decision rationale: DECISION-LOCATION-006).

## Out-of-Scope
- Implementing scheduling/dispatch assignment logic (consumer responsibility).
- Enforcing “out-of-service blocks assignments” beyond surfacing/storing status and ensuring list filtering supports `status=ACTIVE`.
- Creating/updating other location resources (mobile units, service areas, travel buffer policies).
- Advanced bay editing flows (PATCH/update) unless already present; this story focuses on **create** plus immediate confirmation.
- Defining/owning Service Catalog or Skills data (pickers are read-only lookups; authoritative domains own the data). (Decision rationale: DECISION-LOCATION-012.)

---

# 3. Actors & Stakeholders
- **Shop Administrator (Primary user)**: Creates and configures bays for a location.
- **Scheduler/Dispatch (Downstream consumer)**: Reads bays filtered by status and constraints for assignment decisions.
- **Work Execution (Downstream consumer)**: Displays bay context (read-only usage of bay metadata).
- **Security/Authorization system**: Determines whether the user can manage bays (frontend must handle forbidden/unauthenticated responses).
- **Service Catalog domain (external stakeholder)**: Provides authoritative service IDs/names for supported services picker (read-only).
- **People/Skills domain (external stakeholder)**: Provides authoritative skill IDs/names for required skills picker (read-only).

---

# 4. Preconditions & Dependencies
- A `Location` already exists and is navigable in the frontend.
- User is authenticated.
- User has permission to manage location resources:
  - Read-only access: `location:view`
  - Mutations (create bay): `location:manage` (Decision rationale: DECISION-LOCATION-007 permission split).
- Backend endpoints available (paths are normalized to Location REST convention; exact route names may differ but must be documented in the implementing PR per DECISION-LOCATION-006):
  - Create Bay: `POST /rest/api/v1/location/locations/{locationId}/bays`
  - List Bays: `GET /rest/api/v1/location/locations/{locationId}/bays`
  - View Bay: `GET /rest/api/v1/location/locations/{locationId}/bays/{bayId}`
- Dependency for constraint picking UX (blocking until confirmed):
  - Service Catalog list/search endpoint(s) for services (authoritative IDs) **must exist**.
  - People/Skills list/search endpoint(s) for skills (authoritative IDs) **must exist**.
- Error contract dependency (blocking until confirmed):
  - Backend must provide a stable error payload shape (field errors and error codes) or the frontend must implement a generic fallback mapping.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From Location detail screen: “Bays” section/tab → “Create Bay” action.
- Optional: From Location list → select location → navigate to Location detail → Bays.

## Screens to create/modify
1. **Modify**: Location detail screen to include navigation to Bays list (if not already present).
2. **Create/Modify**: Location Bays list screen (scoped to a location) with an action to create a bay.
3. **Create**: Bay Create screen/form under a location context.
4. **Create/Modify**: Bay Detail screen (or reuse existing) to display the created bay after submission.

> Moqui screen path suggestion (adjust to repo conventions):  
`apps/pos/screen/location/LocationDetail.xml`  
`apps/pos/screen/location/bay/BayList.xml`  
`apps/pos/screen/location/bay/BayCreate.xml`  
`apps/pos/screen/location/bay/BayDetail.xml`

## Navigation context
- All bay screens are scoped under a selected location: `locationId` is required in the URL and screen context.
- Breadcrumb: Locations → {Location Name} → Bays → Create Bay
- Navigation placement: under Admin / Location Management (Decision rationale: DECISION-LOCATION-010).

## User workflows (happy + alternate paths)

### Happy path
1. Admin navigates to a Location’s Bays.
2. Admin clicks “Create Bay”.
3. Admin enters:
   - Name
   - Bay Type (enum)
   - Status (default ACTIVE)
   - Capacity (max concurrent vehicles)
   - Supported Services (multi-select IDs; optional)
   - Required Skills (multi-row: skillId + optional minLevel; optional)
4. Admin submits.
5. App shows success and routes to Bay Detail (preferred) or back to Bay List with the new bay visible.

### Alternate paths
- Admin cancels → returns to Bay List without changes.
- Admin submits with missing/invalid data → inline errors + form remains editable.
- Duplicate name conflict → error shown on name field and as global form error.
- Service/skills lookup temporarily unavailable → show retryable error for the picker; allow saving without constraints (constraints are optional) unless backend requires at least one constraint (not indicated by current rules).

---

# 6. Functional Behavior

## Triggers
- User presses “Create Bay” submit action on the create form.

## UI actions
- Load screen context:
  - Ensure `locationId` exists; if missing, show not-found/invalid route state.
  - Load location summary (name/code) for page context when endpoint exists; otherwise show `locationId` only.
- In-form actions:
  - Add/remove supported services selections (multi-select).
  - Add/remove required skill requirement rows.
  - Change status between `ACTIVE` and `OUT_OF_SERVICE`.
- Submit action:
  - Client-side validation (required fields, numeric bounds, trimming).
  - Call backend create endpoint.
  - On success: navigate to Bay Detail (preferred) or return to list.

## State changes
- Form state: `dirty/clean`, `submitting`, `submitError`.
- After success: clear transient form state; persist created `bayId` in route.

## Service interactions (Moqui)
- Use Moqui screen `transition` with `service-call` (or REST call mechanism used by the repo) to call backend endpoints.
- Include `locationId` from screen parameters in the REST path.
- Map backend validation errors to field-level messages where possible; otherwise show a global error with a request/correlation ID if provided.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- **Required fields on create**:
  - `name` (non-empty, trimmed)
  - `bayType` (must be one of allowed enum values)
  - `status` (default `ACTIVE`)
  - `capacity.maxConcurrentVehicles` (required; integer; must be `>= 1`)
- **Bay name uniqueness within a Location**:
  - Trim whitespace before submit.
  - If backend returns `409 Conflict` with code `BAY_NAME_TAKEN_IN_LOCATION` (as documented in LOCATION_DOMAIN_NOTES), show:
    - Field error on `name`: “Bay name must be unique within this location.”
    - Global error summary: “A bay with this name already exists in this location.”
  - Case sensitivity: treat as backend-defined; do not implement client-side case-folding uniqueness checks (Decision rationale: notes specify case-sensitive uniqueness after trimming; UI should not diverge).
- **Constraint references must be IDs** (no free text):
  - `supportedServiceIds[]` values must come from a service picker backed by an authoritative lookup API.
  - `requiredSkillRequirements[].skillId` values must come from a skills picker backed by an authoritative lookup API.
  - If backend returns `400` with invalid IDs, show which selections are invalid and allow user to remove/fix.
- **Skill min level**:
  - If `minLevel` is provided, validate as integer `>= 1`.
  - If omitted, do not send the field (avoid implying a default).

## Enable/disable rules
- Disable submit while:
  - Submitting request
  - Required fields invalid
- Disable “Create Bay” action and hide mutation controls if the user lacks `location:manage` (or if backend returns 403 on attempted action).

## Visibility rules
- Always show status selector; default to ACTIVE.
- Only show `minLevel` input when a `skillId` is selected for a row.

## Error messaging expectations
- Form-level error banner for general errors (network, 500, unexpected payload).
- Field-level error messages for validation issues.
- Preserve user-entered data on error.

---

# 8. Data Requirements

## Entities involved
- **Location** (read context): `locationId`, display name/code.
- **Bay** (create payload; returned resource).
- **Service** (lookup only; external SoR): used to populate supported services picker.
- **Skill** (lookup only; external SoR): used to populate required skills picker.

## Fields (type, required, defaults)

### Bay (Create)
- `locationId` (opaque ID, required) — from route context; not user-editable.
- `name` (string, required)
  - Trim whitespace before submit.
- `bayType` (enum, required) — allowed values must be sourced from backend contract; until confirmed, UI must treat the list as a backend-provided enum or configuration.
  - If a static list is used initially, it must match backend exactly and be documented in the implementing PR.
- `status` (enum, required; default `ACTIVE`)
  - Allowed values: `ACTIVE`, `OUT_OF_SERVICE` (per checklist).
- `capacity` (object, required)
  - `maxConcurrentVehicles` (integer, required, `>= 1`)

### Constraints (Create)
- `supportedServiceIds` (array of opaque IDs, optional; default empty array)
- `requiredSkillRequirements` (array, optional; default empty array)
  - item:
    - `skillId` (opaque ID, required if row exists)
    - `minLevel` (integer, optional; if present `>= 1`)

## Read-only vs editable by state/role
- Create screen: all above fields editable when authorized.
- `locationId` is read-only and derived from navigation context.
- Authorization is enforced by backend; frontend must handle forbidden.

## Derived/calculated fields
- Trimmed `name` before submit.
- No other derived fields.

---

# 9. Service Contracts (Frontend Perspective)

> Contract convention: use `/rest/api/v1/location/...` for Location domain endpoints (DECISION-LOCATION-006). Exact endpoint names and response envelopes must be confirmed and documented in the implementing PR.

## Load/view calls
- **Location context (recommended)**  
  `GET /rest/api/v1/location/locations/{locationId}`  
  Purpose: display location name in header/breadcrumb and validate location exists.  
  Fallback: if not available, show `locationId` and rely on create endpoint 404 handling.

- **Post-create confirm**  
  `GET /rest/api/v1/location/locations/{locationId}/bays/{bayId}`  
  Purpose: show created bay details after redirect.

- **List bays (for return-to-list flow)**  
  `GET /rest/api/v1/location/locations/{locationId}/bays?status=ALL&pageIndex=0&pageSize=25`  
  Purpose: show list and confirm new bay appears.  
  Note: pagination/envelope must follow platform conventions (items + totalCount) but is not yet confirmed for Bays.

- **Service lookup (blocking until confirmed)**  
  `GET /rest/api/v1/<catalog-or-product-domain>/services?q=<query>&pageIndex=0&pageSize=25`  
  Purpose: populate supported services picker.

- **Skills lookup (blocking until confirmed)**  
  `GET /rest/api/v1/<people-domain>/skills?q=<query>&pageIndex=0&pageSize=25`  
  Purpose: populate required skills picker.

## Create/update calls
- **Create bay**  
  `POST /rest/api/v1/location/locations/{locationId}/bays`  
  Request body (minimum):
  ```json
  {
    "name": "Alignment Rack 1",
    "bayType": "ALIGNMENT",
    "status": "ACTIVE",
    "capacity": { "maxConcurrentVehicles": 1 },
    "supportedServiceIds": ["svc-..."],
    "requiredSkillRequirements": [{ "skillId": "skill-...", "minLevel": 2 }]
  }
  ```
  Response: `201 Created` with full bay payload including `bayId` (field name must be confirmed).

## Submit/transition calls
- None (no separate workflow state machine beyond status enum).

## Error handling expectations
- `400 Bad Request`: show field errors; if response includes invalid IDs, highlight invalid selections.
- `401 Unauthorized`: route to login (or show auth required) per app convention.
- `403 Forbidden`: show “You do not have permission to manage bays for this location.”
- `404 Not Found`: show location not found (if on create) or bay not found (if redirect failed).
- `409 Conflict`: duplicate bay name; map to name field. Prefer backend error code `BAY_NAME_TAKEN_IN_LOCATION` when present.
- `409 OPTIMISTIC_LOCK_FAILED`: not expected for create; if received, show “This record was updated by someone else. Please reload.” (generic fallback).
- Network/5xx: show retryable global error; preserve form state.
- Correlation/request ID: if backend provides a request ID header or field, display it in the error banner as “Reference ID”.

---

# 10. State Model & Transitions

## Allowed states (Bay.status)
- `ACTIVE`
- `OUT_OF_SERVICE`

## Role-based transitions
- Shop Administrator with `location:manage` can set status on create.

## UI behavior per state
- If status is `OUT_OF_SERVICE`, UI displays advisory text: “Out-of-service bays are excluded from availability queries.”
- No additional conditional validation based on status in v1.

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- Missing name → block submit; message “Name is required.”
- Missing bayType → block submit; message “Bay type is required.”
- Capacity not integer or `< 1` → block submit; message “Max concurrent vehicles must be a whole number ≥ 1.”
- Skill row with no `skillId` → block submit and highlight the row.

## Validation failures (server-side)
- Duplicate bay name within location → `409` mapped to Name field.
- Invalid service IDs or skill IDs → `400` mapped to picker selections; allow remove and resubmit.
- Unknown locationId → `404` show not found state and provide link back to Locations list.

## Concurrency conflicts
- Create is not versioned; only handle `409` duplicate name.
- If backend returns `OPTIMISTIC_LOCK_FAILED` unexpectedly, treat as retryable with reload guidance.

## Unauthorized access
- `401`: redirect to login; after login return to create page if app supports returnUrl.
- `403`: show forbidden screen; do not show form fields; disable/hide create actions in navigation when permission is known.

## Empty states
- If service/skill pickers have no available options (empty catalog), show empty-state help text and allow creating bay without constraints (constraints optional).
- If lookup endpoints are unavailable (e.g., 503), show retry UI for the picker; do not block saving unless the user has already selected values that cannot be validated server-side (server remains authoritative).

---

# 12. Acceptance Criteria

### Scenario 1: Admin creates a bay under a location (happy path)
**Given** I am authenticated as a Shop Administrator with `location:manage`  
**And** a Location exists with id `<locationId>`  
**When** I open “Create Bay” for `<locationId>`  
**And** I enter a unique name, select a bay type, keep status as ACTIVE, and set capacity maxConcurrentVehicles to 1  
**And** I submit the form  
**Then** the system creates the bay via `POST /rest/api/v1/location/locations/<locationId>/bays`  
**And** I am navigated to the created bay detail (or the bay list) showing the new bay.

### Scenario 2: Duplicate bay name is rejected within the same location
**Given** a bay named “Alignment Rack 1” already exists under `<locationId>`  
**When** I attempt to create another bay under `<locationId>` with name “Alignment Rack 1”  
**Then** the backend responds with `409 Conflict`  
**And** the UI shows a field error on the Name input indicating the name must be unique within this location  
**And** my other form inputs remain intact for correction.

### Scenario 3: Create bay with constraints (services + skills) persists and is queryable
**Given** I am on the Create Bay form for `<locationId>`  
**And** the Services lookup endpoint returns selectable services including IDs `S1` and `S2`  
**And** the Skills lookup endpoint returns selectable skills including ID `K1`  
**When** I select supported services `[S1, S2]` and required skills `[{skillId: K1, minLevel: 2}]`  
**And** I submit the form  
**Then** the create request includes `supportedServiceIds` and `requiredSkillRequirements`  
**And** on the Bay Detail screen (via `GET /rest/api/v1/location/locations/<locationId>/bays/<bayId>`), the constraints and capacity are displayed.

### Scenario 4: Out-of-service status is stored and communicated
**Given** I am creating a bay under `<locationId>`  
**When** I set status to `OUT_OF_SERVICE` and submit successfully  
**Then** the created bay detail shows status `OUT_OF_SERVICE`  
**And** the UI displays an advisory that out-of-service bays are excluded from availability queries.

### Scenario 5: Unknown constraint references return validation errors
**Given** I attempt to create a bay under `<locationId>`  
**When** I submit `supportedServiceIds` or `requiredSkillRequirements.skillId` values that do not exist  
**Then** the backend responds with `400 Bad Request`  
**And** the UI shows a validation error indicating which IDs/selections are invalid  
**And** I can remove/fix the invalid selections and resubmit.

### Scenario 6: Unauthorized users cannot access create bay
**Given** I am not authenticated  
**When** I navigate to the Create Bay URL for `<locationId>`  
**Then** I am prompted to authenticate (or redirected to login).

**Given** I am authenticated but lack `location:manage`  
**When** I navigate to the Create Bay URL for `<locationId>`  
**Then** the UI does not allow submission  
**And** if I attempt to submit (or the UI calls the create endpoint), the backend responds `403 Forbidden`  
**And** the UI shows an access denied state.

### Scenario 7: Bay name is trimmed before submission
**Given** I am creating a bay under `<locationId>`  
**When** I enter the name `"  Bay 1  "` and submit  
**Then** the request body sends `"Bay 1"` as the name  
**And** the created bay displays name `"Bay 1"`.

---

# 13. Audit & Observability

## User-visible audit data
- On Bay Detail (post-create), show read-only metadata if provided by backend:
  - `createdAt`, `updatedAt`
  - `createdBy` (optional)
  - `version` (optional; if present, display as read-only)

## Status history
- Not required for v1 UI unless backend exposes it; do not invent history.

## Traceability expectations
- Frontend logs a structured event on create attempt/success/failure (using the app’s standard logger):
  - `locationId`, `bayName`, `bayType`, `status`, and `bayId` on success
  - Include correlation/request ID if provided by backend (header or response field)
- Do not log full payloads containing potentially sensitive data beyond IDs and names.

---

# 14. Non-Functional UI Requirements
- **Performance**: Create form renders quickly; pickers must support search/autocomplete and pagination if the lookup endpoints are large.
- **Accessibility**: All form inputs labeled; validation errors announced (ARIA); keyboard navigable; error summary links to fields.
- **Responsiveness**: Usable on tablet; form sections stack vertically on narrow screens.
- **i18n/timezone/currency**: Not applicable (no monetary values; timezone not involved).

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: If service/skills catalogs are empty/unavailable, show an empty-state message and allow proceeding without constraints (constraints are optional). Qualifies as safe because it does not change domain policy—only UI ergonomics. Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- SD-ERR-STANDARD-MAP: Standard mapping of HTTP 400/401/403/404/409/5xx to inline vs global errors and preserving form state. Qualifies as safe because it is generic error handling without altering business rules. Impacted sections: Service Contracts, Alternate / Error Flows, Acceptance Criteria.

---

# 16. Open Questions
1. What are the **actual lookup endpoints** (paths) and **response envelopes** for:
   - Services (for `supportedServiceIds[]`)
   - Skills (for `requiredSkillRequirements[].skillId`)
   Including required query params for search/pagination and the fields for `{id, displayName}`.
2. What is the **ID type** for `supportedServiceIds` and `skillId` (UUID vs string code)? Frontend must treat IDs as opaque, but needs to know validation/display expectations and example values.
3. What is the **Bay API response shape** for create and view?
   - Confirm the identifier field name (`bayId` vs `id`) and whether the response includes `capacity` and constraints.
4. What is the **standard error payload** for validation and conflicts?
   - Confirm whether errors include `code`, `message`, `fieldErrors[]`, and a correlation/request ID, and provide an example for `BAY_NAME_TAKEN_IN_LOCATION`.
5. Confirm the frontend route/screen conventions in this repo for location subresources:
   - Should URLs be `/locations/:locationId/bays/new` and `/locations/:locationId/bays/:bayId`, or another pattern aligned to existing Moqui screens?

════════════════════════════════════════
ISSUE #139: [FRONTEND] [STORY] Scheduling: Create Appointment with CRM Customer and Vehicle
LABELS: type:story,status:draft,blocked:clarification,risk:incomplete-requirements,domain:location,agent:story-authoring,agent:location-domain-agent
BODY:
## Title
[FRONTEND] [STORY] Scheduling: Create Appointment with CRM Customer and Vehicle (Moqui Screens)

## Primary Persona
Service Advisor

## Business Value
Enable service advisors to schedule work with verified customer/vehicle context from CRM and persist an immutable snapshot for accurate downstream execution, billing context, and auditability.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor  
- **I want** to create a new appointment by selecting an existing CRM customer and one of their vehicles, then specifying requested services and a scheduled time window  
- **So that** the shop has reliable, validated context for future work and communications, even if CRM data changes later.

## In-Scope
- Frontend flow to **create** an Appointment in `SCHEDULED` status (draft creation is out of scope per backend reference).
- CRM-backed lookup/selection of:
  - `crmCustomerId`
  - `crmVehicleId` (validated association)
- Capture and submit appointment details:
  - time window (`startAt`, `endAt`)
  - requested service(s)
  - notes (optional)
- Display creation success and navigate to the created appointment detail view (or confirmation state).
- Moqui screen/form implementation consistent with project conventions.

## Out-of-Scope
- Appointment rescheduling/cancellation flows.
- Editing an appointment after creation.
- Draft appointment creation.
- Notification delivery mechanics for `AppointmentCreated` (backend responsibility).
- Defining permissions/roles beyond enforcing “must be authorized” error handling.
- Catalog-backed service selection (IDs/codes) unless an existing picker is already available and explicitly wired by backend contract.

---

# 3. Actors & Stakeholders
- **Primary Actor:** Service Advisor (frontend user)
- **Systems of Record (SoR):**
  - **Shop Management (shopmgr)**: SoR for Appointment entity authoring/scheduling and operational schedule truth (per workexec domain guide DECISION-INVENTORY-010; appointments are shopmgr entities).
  - **CRM**: SoR for customer/vehicle identity and association.
- **Consumers/Stakeholders:** Work execution (workexec) consumes appointment linkage via `appointmentId`; billing, analytics/reporting consume appointment context indirectly.

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in the POS frontend and has access to Scheduling features.
- CRM lookup endpoints are reachable.
- Shop management appointment create endpoint is reachable.

## Dependencies
- Must use canonical Moqui appointment screen in `durion-shopmgr` (DECISION-INVENTORY-002).
- Requires CRM customer search + customer vehicle list endpoints (paths and DTOs not provided in this issue).
- Requires appointment create endpoint (path and DTO not provided in this issue).
- Timezone semantics must be consistent with shop UX (DECISION-INVENTORY-016), but the source of shop timezone is not confirmed for this repo.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Global navigation: `Scheduling → Appointments → Create` (menu item under shop management).
- Optional contextual entry: from a Customer detail context (only if already exists in the app; otherwise omit).

## Screens to create/modify
### Screens to Create/Modify (Canonical)
- **Modify / implement**: `durion-shopmgr/AppointmentEdit.xml`
  - Add a “Create Appointment” mode (new record) if not already supported.
  - Embed CRM customer/vehicle pickers and requested services/time window fields.
- **Use existing**: `durion-shopmgr/AppointmentEdit.xml` as the post-create detail view (same screen, now with `appointmentId`).

> Decision rationale: Canonical appointment screens live in shopmgr, not workexec (DECISION-INVENTORY-002, DECISION-INVENTORY-010). This story must extend shopmgr screens rather than creating new workexec-owned routes.

## Navigation context
- Breadcrumb: `Scheduling / Appointments / Create`
- After successful creation: redirect to `durion-shopmgr/AppointmentEdit?appointmentId=<id>` (or the canonical parameter name used by the screen).

## User workflows (happy + alternate paths)

### Happy path
1. Service Advisor opens **Create Appointment**.
2. Searches and selects **CRM Customer**.
3. Selects **CRM Vehicle** (filtered by selected customer).
4. Adds **one or more requested services** (free-text descriptions).
5. Sets **startAt** and **endAt**.
6. Optionally adds notes.
7. Submits; sees success; navigates to appointment detail.

### Alternate paths
- User changes customer after selecting a vehicle → vehicle selection is cleared and must be reselected.
- CRM returns no results → show empty state and guidance.
- Submit blocked due to validation errors (missing fields, invalid time range).
- CRM temporarily unavailable during search → show non-blocking warning; allow retry.
- Create fails due to CRM validation errors (customer/vehicle not found or mismatch) → show blocking error; keep entered data.

---

# 6. Functional Behavior

## Triggers
- User navigates to create appointment screen.
- User types in customer search input (debounced).
- User selects customer → triggers vehicle list load.
- User submits create form.

## UI actions
- **Customer lookup**
  - Search input with debounce.
  - Results list with select action.
  - On select: set `crmCustomerId` and show a read-only preview (display fields from CRM response).
- **Vehicle selection**
  - Disabled until customer selected.
  - Loads vehicles for selected customer.
  - On select: set `crmVehicleId` and show a read-only preview.
- **Requested services**
  - Add/remove rows.
  - Each row requires `description` (free text).
- **Date/time**
  - `startAt` and `endAt` required.
  - UI displays timezone label for entered times (see timezone rules).
- **Notes**
  - Optional free text.

## State changes
- Local form state: `idle → editing → submitting → success|error`
- No client-side draft persistence beyond in-memory form state.

## Service interactions
- CRM customer search (endpoint TBD).
- CRM vehicles-by-customer list (endpoint TBD).
- Appointment create (endpoint TBD).
- On success: navigate to appointment detail screen with returned `appointmentId`.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
Client-side (pre-submit):
- `crmCustomerId` required (opaque string; do not validate UUID format).
- `crmVehicleId` required (opaque string; do not validate UUID format).
- At least 1 requested service row required.
- Each requested service row requires non-empty `description` (trimmed).
- `startAt` and `endAt` required.
- `endAt` must be strictly after `startAt`.
- Notes optional.

Server-side (authoritative):
- Customer existence validation.
- Vehicle existence validation.
- Vehicle belongs to customer validation.
- Appointment is created in `SCHEDULED` status (no draft creation in this story).

Decision rationale:
- IDs must be treated as opaque strings (DECISION-INVENTORY-003).
- Backend is authoritative for association validation; UI only prevents obvious missing inputs.

## Enable/disable rules
- Vehicle selector disabled until customer selected.
- Submit disabled while submitting or while client-side validation fails.

## Visibility rules
- Show selected customer preview after selection.
- Show selected vehicle preview after selection.
- Show inline field errors after blur or on submit attempt.

## Error messaging expectations
Use standard error envelope parsing when available (DECISION-INVENTORY-011). Map known error codes:
- `CUSTOMER_NOT_FOUND` (404): “Selected customer no longer exists in CRM. Please re-search and select again.”
- `VEHICLE_NOT_FOUND` (404): “Selected vehicle no longer exists in CRM. Please re-select a vehicle.”
- `VEHICLE_CUSTOMER_MISMATCH` (409): “That vehicle is not associated with the selected customer. Please choose a different vehicle.”
- `403`: “You don’t have permission to create appointments.”
- `503` (CRM unavailable): “CRM is temporarily unavailable. Try again later.”
- Unknown errors: show generic banner with `correlationId` if present.

---

# 8. Data Requirements

## Entities involved
- `durion.shopmgr.DurShopAppointment` (appointment create target; shopmgr SoR)
- Appointment requested services line items (entity name TBD; may be embedded or separate)
- CRM Customer (read-only lookup DTO)
- CRM Vehicle (read-only lookup DTO)

## Fields (type, required, defaults)

### Appointment (Create Request)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| crmCustomerId | id (opaque string) | yes | none | Selected from CRM |
| crmVehicleId | id (opaque string) | yes | none | Must belong to customer (server-validated) |
| startAt | datetime (ISO-8601) | yes | none | Send with offset or UTC per API contract (Open Question) |
| endAt | datetime (ISO-8601) | yes | none | Must be after startAt |
| notes | string | no | empty | Free text |
| serviceRequests | array | yes | none | At least 1 item |

### AppointmentServiceRequest (Create Request)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| description | string | yes | none | Free text |

## Read-only vs editable
- CRM preview fields are read-only.
- All create fields editable until submit.

## Derived/calculated fields
- Optional UI-only `durationMinutes` derived from start/end for display; do not send unless API requires.

---

# 9. Service Contracts (Frontend Perspective)

> Exact REST paths and DTOs are not provided in this issue; Moqui may implement via screen transitions/services rather than REST. This story requires explicit contracts to be confirmed.

## Load/view calls

1) **Search CRM Customers**
- Method: `GET`
- Endpoint: **TBD**
- Query params: `query` (string), pagination (`pageIndex`, `pageSize`) if supported
- Response (minimum):
  ```json
  {
    "data": [
      { "crmCustomerId": "CUST-1", "displayName": "Jane Doe", "phone": "..." }
    ],
    "pageIndex": 0,
    "pageSize": 20,
    "totalCount": 1
  }
  ```

2) **List Vehicles for CRM Customer**
- Method: `GET`
- Endpoint: **TBD**
- Params: `crmCustomerId`
- Response (minimum):
  ```json
  {
    "data": [
      { "crmVehicleId": "VEH-1", "year": 2020, "make": "Toyota", "model": "Camry", "vin": "..." }
    ]
  }
  ```

## Create/update calls

1) **Create Appointment**
- Method: `POST`
- Endpoint: **TBD**
- Headers:
  - `Idempotency-Key`: required for create/submit operations (DECISION-INVENTORY-012)
- Request body (minimum):
  ```json
  {
    "crmCustomerId": "CUST-1",
    "crmVehicleId": "VEH-1",
    "startAt": "2026-01-18T15:00:00Z",
    "endAt": "2026-01-18T16:00:00Z",
    "notes": "Optional notes",
    "serviceRequests": [
      { "description": "Oil change" }
    ]
  }
  ```
- Success: `201 Created`
  ```json
  { "appointmentId": "APPT-1" }
  ```

## Submit/transition calls
- None beyond create; created appointment is `SCHEDULED`.

## Error handling expectations
- Errors normalized to standard envelope when possible:
  ```json
  {
    "code": "VEHICLE_CUSTOMER_MISMATCH",
    "message": "…",
    "correlationId": "c-123",
    "fieldErrors": [{ "field": "crmVehicleId", "message": "…" }]
  }
  ```
- `409` duplicates: if appointment create can duplicate (not specified), backend should return `existingResourceId` (DECISION-INVENTORY-011). UI should offer “Open existing” if present.

---

# 10. State Model & Transitions

## Allowed states
- Appointment initial state on create: `SCHEDULED` (only state relevant to this story).

## Role-based transitions
- Not in scope. Only creation is in scope; authorization enforced by backend and reflected in UI gating if capability signal exists.

## UI behavior per state
- After create, appointment detail shows `statusId = SCHEDULED` as read-only.

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- Missing customer/vehicle/services/times → inline errors; prevent submit.
- `endAt <= startAt` → inline error; prevent submit.

## Backend validation failures (400/404/409)
- Show banner + field errors if provided.
- For `CUSTOMER_NOT_FOUND` or `VEHICLE_NOT_FOUND`: clear the invalid selection(s) and require re-selection; keep other form inputs.

## Concurrency conflicts
- Not expected for create. If backend returns `409` due to scheduling conflict, show conflict banner and keep data (Open Question: define code and UX).

## Unauthorized access
- `401`: redirect to login.
- `403`: show access denied; disable submit.

## Empty states
- No customers found → show empty state and guidance.
- No vehicles for customer → show empty state; allow changing customer.

---

# 12. Acceptance Criteria

## Scenario 1: Create Scheduled Appointment (Happy Path)
**Given** CRM is available  
**And** the Service Advisor is authenticated and authorized to create appointments  
**And** a CRM customer exists  
**And** a CRM vehicle exists and is associated with that customer  
**When** the user selects the customer and vehicle  
**And** enters at least one requested service description  
**And** enters a valid start and end time  
**And** submits the form  
**Then** the system sends a create request containing `crmCustomerId`, `crmVehicleId`, `startAt`, `endAt`, and `serviceRequests[]`  
**And** includes an `Idempotency-Key` header  
**And** receives `201 Created` with an `appointmentId`  
**And** navigates to the canonical appointment detail screen for that `appointmentId`  
**And** the appointment status displayed is `SCHEDULED`.

## Scenario 2: Vehicle Not Associated with Customer
**Given** CRM is available  
**And** the user selected a customer  
**When** the user submits the create form  
**And** the backend returns `409 Conflict` with error code `VEHICLE_CUSTOMER_MISMATCH`  
**Then** the UI shows a blocking error message explaining the mismatch  
**And** the appointment is not created  
**And** the user remains on the create form with previously entered fields intact.

## Scenario 3: CRM Unavailable During Create
**Given** CRM is unavailable  
**When** the user submits the create form  
**And** the backend returns `503 Service Unavailable`  
**Then** the UI shows “CRM is temporarily unavailable. Try again later.”  
**And** the appointment is not created  
**And** the form data remains intact for retry.

## Scenario 4: Customer Not Found
**Given** CRM is available  
**When** the user submits with a `crmCustomerId` that no longer exists  
**And** the backend returns `404` with error code `CUSTOMER_NOT_FOUND`  
**Then** the UI shows an error instructing the user to re-search/select a customer  
**And** clears the selected customer and vehicle fields  
**And** keeps the entered time window, notes, and service request descriptions intact.

## Scenario 5: Client-side Validation Prevents Submit
**Given** the Create Appointment screen is open  
**When** the user has not selected a customer or vehicle  
**Or** has not added any requested services  
**Or** the end time is not after start time  
**Then** the UI prevents submission and shows inline validation errors  
**And** no create API call is made.

## Scenario 6: Double-submit Does Not Create Duplicate (Idempotency)
**Given** the user has completed the form with valid inputs  
**When** the user submits  
**And** the network times out and the user retries submission  
**And** the UI reuses the same `Idempotency-Key` for the retry  
**Then** the backend returns the same outcome (same `appointmentId` or a deterministic duplicate response)  
**And** the UI navigates to the created appointment without creating a second appointment.

---

# 13. Audit & Observability

## User-visible audit data
- On appointment detail screen, display if available:
  - `createdDate` / `createdAt`
  - `createdByUserId` or display name
- If not available, show only appointment identifiers and status.

## Status history
- Not required for creation-only story.

## Traceability expectations
- Include `Idempotency-Key` on create.
- Capture and display `correlationId` from error envelope in the error banner for support.

---

# 14. Non-Functional UI Requirements

## Performance
- Customer search input debounced (250–400ms).
- Vehicle list loaded once per customer selection; cache in-memory for the session.

## Accessibility
- All form controls have labels.
- Errors are programmatically associated with inputs.
- Keyboard navigation supported for search results and selection.

## Responsiveness
- Usable on tablet-width layouts.

## i18n/timezone/currency
- Display timestamps in user timezone and label the timezone used (DECISION-INVENTORY-016).
- Date-bucket semantics are not applicable here; for entered start/end, UI must be explicit about timezone and send ISO-8601 per API contract (Open Question).

---

# 15. Applied Safe Defaults
- **SD-UX-SEARCH-DEBOUNCE**: Debounce CRM search input by ~300ms to reduce calls; safe UI ergonomics choice. Impacted sections: UX Summary, Functional Behavior, Non-Functional.
- **SD-UX-EMPTY-STATES**: Provide explicit empty-state messages for no results; safe UI ergonomics choice. Impacted sections: UX Summary, Alternate / Error Flows.
- **SD-ERR-STANDARD-BANNER**: Use standard error banner + inline field errors when available; safe mapping of backend errors to UX without changing business rules. Impacted sections: Business Rules, Error Flows, Acceptance Criteria.

---

# 16. Open Questions

1. **Domain/ownership confirmation (blocking):** This story creates and authors Appointments, which per DECISION-INVENTORY-010 are shopmgr SoR. Should this story be labeled `domain:shopmgmt` instead of `domain:workexec`/`domain:location`? Provide the correct single `domain:*` label for scheduling/appointments in this repo.
2. **Canonical screen route (blocking):** Confirm the exact Moqui screen path and parameter name for appointment create/detail (e.g., `/webroot/durion-shopmgr/AppointmentEdit` and `appointmentId`), and whether create is “new record” mode of the same screen.
3. **API contract (blocking):** What are the exact endpoints (or Moqui services invoked by transitions) for:
   - CRM customer search
   - CRM vehicles-by-customer list
   - Appointment create
   Include request/response DTOs and error codes.
4. **Timezone contract (blocking):** For `startAt`/`endAt`, must the UI send UTC (`Z`) or local offset? If local offset is allowed, what timezone should be used (user vs shop)? How does the frontend obtain shop timezone (if required)?
5. **Requested services structure (blocking):** Are requested services free-text only, or must they reference catalog service IDs/codes? If IDs are required, provide the lookup endpoint/picker contract.
6. **Scheduling conflicts (non-blocking unless required by backend):** Does appointment create validate overlaps and return a specific conflict code? If yes, provide the code and required UX (suggest alternate times vs simple error).

