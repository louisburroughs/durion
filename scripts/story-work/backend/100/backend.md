Title: [BACKEND] [STORY] Billing: Define Account Billing Rules
URL: https://github.com/louisburroughs/durion-positivity-backend/issues/100
Labels: payment, type:story, domain:billing, status:ready-for-dev, agent:story-authoring, agent:billing

## üè∑Ô∏è Labels (Current)
### Required
- type:story
- domain:billing
- status:ready-for-dev

### Recommended
- agent:billing
- agent:story-authoring

---
**Rewrite Variant:** integration-conservative
**Conflict Resolution:** Resolved ‚Äî `domain:billing` confirmed as primary owner (see resolution comment from 2026-01-14 generated by `clarification-resolver.sh`).
---

## Story Intent
As a Billing Clerk, I want to define and manage a specific set of billing rules for each commercial account, so that the automated invoicing process is consistently accurate, adheres to client agreements, and requires minimal manual intervention.

## Actors & Stakeholders
- **Billing Clerk** (Primary Actor): The user responsible for configuring and maintaining billing rules for commercial accounts.
- **System (Billing Service)**: System of record for Billing Rules; owns persistence, validation, and APIs.
- **System (CRM Service)**: System of record for Commercial Account entities; emits account lifecycle events.
- **System (Work Execution Service)**: Consumes billing rules once per work item lifecycle and enforces PO-required behavior using a persisted snapshot.
- **Auditor**: Needs a history of changes to billing rules for compliance and financial controls.

## Preconditions
1. The Billing Clerk is authenticated and authorized to manage billing rules.
2. The target commercial account exists in CRM and has a stable `accountId`.
3. The Billing service has a system-wide default Billing Rules template configured.

## Functional Behavior

### UC-1: Create / Update Billing Rules (Idempotent Upsert)
- **Trigger:** A Billing Clerk initiates ‚ÄúManage Billing Rules‚Äù for an `accountId`.
- **API (Billing-owned):** `PUT /billing-rules/{accountId}`
- **Behavior:** Billing validates and persists the Billing Rules for the account (create if missing; update if present).
- **Configurable fields (minimum):**
  - `isPoRequired` (Boolean): Whether a PO number is mandatory for work orders.
  - `paymentTermsId` (Reference): Agreed payment terms (e.g., `NET_30`).
  - `invoiceDeliveryMethod` (Enum): e.g., `EMAIL`, `PORTAL`, `MAIL`.
  - `invoiceGroupingStrategy` (Enum): e.g., `PER_WORK_ORDER`, `PER_VEHICLE`, `SINGLE_INVOICE`.
- **Outcome:** The active Billing Rules for `accountId` are stored and immediately retrievable.
- **Side-effect (audit):** A structured audit event is generated with field-level before/after values.

### UC-2: Retrieve Billing Rules for Processing
- **Trigger:** An internal service (Billing or Work Execution) needs the current billing rules for an account.
- **API (Billing-owned):** `GET /billing-rules/{accountId}`
- **Outcome:** Returns the currently active Billing Rules.

### UC-3: Default Billing Rules Provisioning (Event-Driven)
- **Trigger:** Billing receives an ‚ÄúAccountCreated‚Äù (commercial) event from CRM.
- **Behavior:** Billing creates default Billing Rules for that `accountId` using the system default template.
- **Idempotency:** Provisioning is idempotent (safe on retries / duplicate events).

### UC-4: Work Execution Enforcement Contract (Snapshot)
- **Trigger:** Work Execution creates a Work Order / Estimate (or transitions into a stage where PO enforcement becomes relevant).
- **Behavior:** Work Execution fetches Billing Rules from Billing once and stores an internal snapshot for enforcement and traceability.
- **Enforcement:** Estimate approval uses the snapshot:
  - If `poRequiredAtApproval=true` and PO is missing/invalid ‚Üí block approval.
- **Rule change behavior:** Changes to Billing Rules apply to new work items; existing work items retain their snapshot unless a separate explicit refresh flow is invoked.

## Alternate / Error Flows
- **Billing Rules Not Found:** If Billing Rules do not exist for `accountId` (e.g., provisioning lag), Billing returns `404 Not Found`.
- **Invalid Rule Value:** If a request contains an invalid value (e.g., non-existent `paymentTermsId`), return `400 Bad Request` with an actionable error message.
- **Insufficient Permissions:** If the caller is not authorized to modify rules, return `403 Forbidden`.
- **Concurrent Modification:** If optimistic concurrency is enabled (ETag/version), stale updates are rejected with `409 Conflict`.

## Business Rules
1. **Domain Ownership / SoR:** `domain:billing` is the system of record for Billing Rules; CRM is not authoritative for rule values.
2. **Defaulting:** New commercial accounts receive a system-wide default Billing Rules configuration created by Billing.
3. **Central enumerations:** Options for `paymentTermsId`, `invoiceDeliveryMethod`, `invoiceGroupingStrategy` are centrally managed and not defined per account.
4. **Auditability:** All create/update operations must be recorded in an immutable audit log, capturing actor, timestamp, accountId, and field-level before/after changes.
5. **Work Execution enforcement uses snapshot:** Work Execution must enforce PO-required behavior using a persisted snapshot, not by calling Billing on every approval.

## Data Requirements
### Entity: `BillingRules` (Billing-owned)
- `id` (UUID, PK)
- `accountId` (Indexed, Not Null, Unique)
- `isPoRequired` (Boolean, Not Null, Default false)
- `paymentTermsId` (String/UUID, Not Null)
- `invoiceDeliveryMethod` (Enum, Not Null, Default `EMAIL`)
- `invoiceGroupingStrategy` (Enum, Not Null, Default `PER_WORK_ORDER`)
- `version` (Integer, Not Null) ‚Äî for optimistic concurrency (optional but recommended)
- `createdAt` (Timestamp, Not Null)
- `updatedAt` (Timestamp, Not Null)
- `updatedBy` (String/UUID, Not Null)

### Work Execution Snapshot (Workexec-owned)
- `accountId` (UUID)
- `poRequiredAtApproval` (Boolean)
- `billingRulesVersion` or `billingRulesUpdatedAt` (for traceability)

## Acceptance Criteria

### AC-1: Upsert Creates Billing Rules
- **Given** a Billing Clerk is authorized
- **When** they `PUT /billing-rules/{accountId}` for an account with no prior rules
- **Then** the system returns success (`201 Created` or `200 OK`)
- **And** a subsequent `GET /billing-rules/{accountId}` returns the configured rules
- **And** an audit event `BillingRules.Created` is recorded.

### AC-2: Upsert Updates Billing Rules
- **Given** an account has existing Billing Rules
- **When** an authorized user updates `paymentTermsId` via `PUT /billing-rules/{accountId}`
- **Then** `GET /billing-rules/{accountId}` returns the updated value
- **And** an audit event `BillingRules.Updated` is recorded with before/after fields.

### AC-3: Defaults Are Provisioned on Commercial Account Creation
- **Given** CRM emits a commercial account-created event for `accountId`
- **When** Billing consumes the event
- **Then** Billing creates Billing Rules for `accountId` using the system default template
- **And** reprocessing the same event does not create duplicates (idempotent).

### AC-4: Workexec Enforces PO Requirement Using Snapshot
- **Given** Billing Rules indicate `isPoRequired=true` for an account
- **And** Work Execution has created a work item and stored a snapshot with `poRequiredAtApproval=true`
- **When** estimate approval is attempted without a PO
- **Then** approval is blocked with an actionable error
- **And** Work Execution does not require a real-time Billing call during the approval command.

## Audit & Observability
- **Audit:** Emit `BillingRules.Created` and `BillingRules.Updated` with `accountId`, `actorId`, `timestamp`, and a field-level changeSet.
- **Logging:**
  - INFO on successful create/update (include `accountId` + principal)
  - WARN on validation or permission failures
- **Metrics:**
  - Counter `billing_rules.upserts.total`
  - Counter `billing_rules.upserts.failures.total{reason=...}`

## Open Questions
None. All previously blocking questions are resolved by the decision record in the 2026-01-14 issue comment generated by `clarification-resolver.sh`.

---
## Original Story (Unmodified ‚Äì For Traceability)
# Issue #100 ‚Äî [BACKEND] [STORY] Billing: Define Account Billing Rules

## Current Labels
- backend
- story-implementation
- payment

## Current Body
## Backend Implementation for Story

**Original Story**: [STORY] Billing: Define Account Billing Rules

**Domain**: payment

### Story Description

/kiro
# User Story

## Narrative
As a **Billing Clerk**, I want **to set billing rules for a commercial account** so that **invoicing is correct and consistent**.

## Details
- Rules: PO required, payment terms, invoice delivery (email/portal), invoice grouping (per vehicle/per workorder).
- Rule changes audited and permissioned.

## Acceptance Criteria
- Create/update rules.
- Rules returned on account lookup.
- Rule changes audited and access-controlled.

## Integration Points (Workorder Execution)
- Estimate approval enforces PO rules.
- Invoicing uses delivery + grouping defaults.

## Data / Entities
- BillingRule
- PaymentTerm
- DeliveryPreference

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Backend Requirements

- Implement Spring Boot microservices
- Create REST API endpoints
- Implement business logic and data access
- Ensure proper security and validation

### Technical Stack

- Spring Boot 3.2.6
- Java 21
- Spring Data JPA
- PostgreSQL/MySQL

---
*This issue was automatically created by the Durion Workspace Agent*