Title: [BACKEND] [STORY] Putaway: Replenish Pick Faces from Backstock (Optional)
URL: https://github.com/louisburroughs/durion-positivity-backend/issues/30
Labels: type:story, domain:inventory, status:needs-review

## üè∑Ô∏è Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:needs-review

### Recommended
- agent:inventory
- agent:story-authoring

---
**Rewrite Variant:** inventory-flexible
---

## Story Intent
**As an** Inventory Manager,
**I want** the system to automatically generate replenishment tasks for primary picking locations when their stock levels fall below a defined minimum,
**so that** we can proactively move inventory from backstock to ensure parts are always available for mechanics, minimizing order fulfillment delays and preventing stockouts at the point of work.

## Actors & Stakeholders
- **Primary Actor:**
  - **Inventory Service (System):** The automated process responsible for monitoring stock levels and creating replenishment tasks.
- **Key Stakeholders:**
  - **Inventory Manager:** Oversees inventory health and relies on this process to maintain optimal stock levels in picking locations.
  - **Warehouse Associate:** Executes the replenishment tasks generated by the system.
  - **Mechanic / Service Technician:** The end consumer who benefits from consistently stocked pick faces, enabling faster job completion.

## Preconditions
1.  A clear distinction between "Pick Face" (primary picking) and "Backstock" (overflow/storage) location types exists within the system.
2.  `ReplenishmentPolicy` records exist and are associated with specific Item-Location pairs, defining their `minimumQuantity` and `maximumQuantity` thresholds.
3.  The inventory system has real-time, accurate quantity-on-hand data for all items in all defined locations.
4.  The functionality to create and persist a `ReplenishmentPolicy` is already implemented or will be completed as a prerequisite.
5.  An `InventoryDecremented` event is published whenever inventory is reduced in any location.

## Functional Behavior
The system shall provide an automated mechanism to generate inventory replenishment tasks using a hybrid triggering approach.

### Trigger Mechanism (Hybrid Model)

**Primary Trigger: Event-Driven**
- **Trigger:** An `InventoryDecremented` event is received.
- **Conditions:** The replenishment check is triggered **only when**:
  1. The decrement occurs in a **Pick Face** location (`isPickFace = true`), **AND**
  2. The resulting on-hand quantity falls **at or below** the `minimumQuantity` threshold (`onHandQty <= minQty`)
- **Debouncing:** To control system load, implement per-tuple debouncing: `(productId, pickFaceLocationId)` ‚Äì maximum once every 60 seconds.
- **Purpose:** Provides responsive, near-real-time replenishment for active picking operations.

**Secondary Trigger: Scheduled Batch Job**
- **Schedule:** Runs every 5-15 minutes.
- **Purpose:** Acts as a safety net to:
  - Catch missed events
  - Recover from transient failures
  - Reconcile inventory after bulk adjustments
  - Scan all pick faces systematically
- **Process:** Scans all Pick Face locations and evaluates their current inventory against their `ReplenishmentPolicy`.

### Replenishment Process
1.  The system identifies an item in a Pick Face location where the `currentQuantityOnHand` has dropped at or below the `minimumQuantity` specified in its `ReplenishmentPolicy`.
2.  Upon detection, the system calculates the required replenishment quantity: `quantityToMove = maximumQuantity - currentQuantityOnHand`.
3.  The system queries for available stock of the same item in "Backstock" locations using the **deterministic sourcing hierarchy** (see Backstock Sourcing Logic below).
4.  If sufficient backstock is found, the system creates a `ReplenishmentTask` with a `PENDING` status.
5.  The task must contain all necessary information for a warehouse associate to execute the move:
    -   `itemSKU`
    -   `quantityToMove`
    -   `sourceLocationId` (the identified backstock location)
    -   `destinationLocationId` (the pick face location needing replenishment)
    -   `triggerType` (EVENT or BATCH)
    -   `decisionReason` (BELOW_MIN or SAFETY_SCAN)

### Backstock Sourcing Logic (Deterministic Hierarchy)

When selecting which backstock location to source from, the system shall apply the following prioritized rules:

1. **FEFO/FIFO Compliance (if applicable)**
   - If the item is lot-controlled or has expiry tracking:
     - Choose backstock with the **earliest expiry date** (FEFO)
     - If no expiry, use earliest receipt date (FIFO)

2. **Sufficient Quantity**
   - Prefer a **single backstock location** that can fully satisfy the `quantityToMove`

3. **Location Proximity (if topology data exists)**
   - Use lowest layout order: Zone ‚Üí Aisle ‚Üí Rack ‚Üí Bin
   - Prioritize locations physically closer to the destination pick face

4. **Highest On-Hand Quantity**
   - Final deterministic tie-breaker
   - Select the location with the most stock

**Note:** "Any location with sufficient quantity" is used **only** as a last-resort tie-breaker when no other differentiating factors exist. This ensures deterministic, auditable, and repeatable behavior.

## Alternate / Error Flows
- **Insufficient Backstock (Partial Replenishment):** If no single backstock location has sufficient quantity to fully satisfy `quantityToMove`, the system shall:
  - Create **multiple ReplenishmentTasks**, one for each source location
  - Each task follows the same sourcing hierarchy rules
  - Tasks are ordered by priority (FEFO/FIFO first)
  - The sum of all task quantities should equal the required `quantityToMove` (or less if insufficient total backstock)

- **No Backstock:** If there is zero available quantity of the item in any backstock location:
  - No `ReplenishmentTask` is created
  - Log as a `BACKSTOCK_UNAVAILABLE` event
  - Increment metric: `replenishment_backstock.unavailable.count`

- **Existing Open Task:** If a `PENDING` or `IN_PROGRESS` `ReplenishmentTask` already exists for the same item and destination location:
  - The system shall **not** create a duplicate task
  - Log as duplicate prevention event

- **Invalid Policy:** If a `ReplenishmentPolicy` is found where `minimumQuantity >= maximumQuantity`:
  - The system shall log a `POLICY_CONFIGURATION_ERROR`
  - Ignore that policy during evaluation
  - Alert inventory management team

- **Event Processing Failure:** If event-driven trigger fails:
  - The batch job safety net will catch and recover within 5-15 minutes
  - Log the failure for monitoring

## Business Rules
- A replenishment task is only triggered when `currentQuantityOnHand <= minimumQuantity` (at or below threshold).
- The target fill quantity for a replenishment is always the `maximumQuantity` defined in the policy.
- The system must prevent the creation of duplicate, open replenishment tasks for the same item-location pair using idempotency checks.
- Replenishment task creation must be idempotent per `(productId, pickFaceLocationId, thresholdCrossing)`.
- Event-driven triggers are debounced to once per 60 seconds per `(productId, pickFaceLocationId)` tuple.
- Backstock sourcing follows the deterministic hierarchy; random selection is not permitted.

## Data Requirements
### `ReplenishmentTask` (Entity)
| Field | Type | Description | Example |
|---|---|---|---|
| `taskId` | UUID | Unique identifier for the task. | `f47ac10b-58cc-4372-a567-0e02b2c3d479` |
| `itemSKU` | String | The unique identifier of the item to be moved. | `OIL-FILTER-001` |
| `quantity` | Integer | The number of units to move. | `10` |
| `sourceLocationId` | UUID | The ID of the backstock location to pick from. | `loc-bkstk-b2-s3` |
| `destinationLocationId`| UUID | The ID of the pick face location to replenish. | `loc-pick-a1-r2` |
| `status` | Enum | The current state of the task. | `PENDING`, `IN_PROGRESS`, `COMPLETED`, `CANCELLED` |
| `triggerType` | Enum | How this task was triggered. **[CLARIFIED]** | `EVENT`, `BATCH` |
| `decisionReason` | Enum | Why replenishment was needed. **[CLARIFIED]** | `BELOW_MIN`, `SAFETY_SCAN` |
| `sourcingReason` | String | The rule that selected this source location. **[CLARIFIED]** | `FEFO`, `FIFO`, `SUFFICIENT_QTY`, `PROXIMITY`, `HIGHEST_STOCK` |
| `createdAt` | Timestamp | Timestamp of task creation. | `2023-10-27T10:00:00Z` |
| `assignedTo` | UUID | (Optional) The user ID of the assigned associate. | `user-1234` |

### `ReplenishmentPolicy` (Reference Entity)
- `policyId` (UUID)
- `locationId` (UUID) - The ID of the Pick Face location this policy applies to.
- `itemSKU` (String)
- `minimumQuantity` (Integer)
- `maximumQuantity` (Integer)

## Acceptance Criteria
```gherkin
Scenario: Event-driven replenishment task is created when stock drops below minimum
  Given a "Pick Face" location "A1" has a Replenishment Policy for item "SKU-123" with min 5 and max 20
  And the current quantity of "SKU-123" in location "A1" is 6
  And a "Backstock" location "B2" has 50 units of "SKU-123"
  When an InventoryDecremented event reduces the quantity in "A1" to 4
  Then a new ReplenishmentTask must be created within 1 minute
  And the task's quantity must be 16 (20 - 4)
  And the task's source location must be "B2"
  And the task's destination location must be "A1"
  And the task's status must be "PENDING"
  And the task's triggerType must be "EVENT"
  And the task's decisionReason must be "BELOW_MIN"

Scenario: Batch job creates replenishment task during scheduled scan
  Given a "Pick Face" location "A1" has a Replenishment Policy for item "SKU-123" with min 5 and max 20
  And the current quantity of "SKU-123" in location "A1" is 3
  And a "Backstock" location "B2" has 50 units of "SKU-123"
  And the event-driven trigger was missed or failed
  When the scheduled batch replenishment job runs
  Then a new ReplenishmentTask must be created
  And the task's triggerType must be "BATCH"
  And the task's decisionReason must be "SAFETY_SCAN"

Scenario: FEFO backstock sourcing selects earliest expiry
  Given a "Pick Face" location "A1" needs replenishment for item "SKU-123" (expiry-controlled)
  And "Backstock" location "B2" has 30 units with expiry date 2024-06-30
  And "Backstock" location "B3" has 40 units with expiry date 2024-03-15
  When the replenishment evaluation process runs
  Then the task's source location must be "B3" (earliest expiry)
  And the task's sourcingReason must be "FEFO"

Scenario: Sufficient quantity rule prefers single-location fulfillment
  Given a "Pick Face" location "A1" needs 20 units of "SKU-456"
  And "Backstock" location "B2" has 10 units
  And "Backstock" location "B3" has 25 units
  And no expiry/lot control applies
  When the replenishment evaluation process runs
  Then the task's source location must be "B3"
  And the task's sourcingReason must be "SUFFICIENT_QTY"

Scenario: Multiple tasks created for partial replenishment
  Given a "Pick Face" location "A1" has a Replenishment Policy for item "SKU-123" with min 5 and max 20
  And the current quantity of "SKU-123" in location "A1" is 4
  And "Backstock" location "B2" has 10 units of "SKU-123"
  And "Backstock" location "B3" has 8 units of "SKU-123"
  When the replenishment evaluation process runs
  Then 2 ReplenishmentTasks must be created
  And the first task's quantity must be 10 from "B2"
  And the second task's quantity must be 6 from "B3"
  And the total quantity across tasks must be 16

Scenario: No replenishment task when stock is at minimum threshold
  Given a "Pick Face" location "A1" has a Replenishment Policy for item "SKU-123" with min 5 and max 20
  And the current quantity of "SKU-123" in location "A1" is 5
  When the replenishment evaluation process runs
  Then no new ReplenishmentTask should be created for "SKU-123" at location "A1"

Scenario: Event debouncing prevents duplicate tasks
  Given a "Pick Face" location "A1" needs replenishment for "SKU-123"
  When an InventoryDecremented event triggers replenishment at time T
  And another InventoryDecremented event occurs at time T+30 seconds
  Then only 1 ReplenishmentTask is created
  And the second event is debounced

Scenario: No duplicate task created when open task already exists
  Given a "Pick Face" location "A1" has a Replenishment Policy for item "SKU-123" with min 5 and max 20
  And the current quantity of "SKU-123" in location "A1" is 3
  And a "PENDING" ReplenishmentTask already exists for "SKU-123" to location "A1"
  When the replenishment evaluation process runs
  Then no new ReplenishmentTask should be created for "SKU-123" at location "A1"

Scenario: No task created when no backstock is available
  Given a "Pick Face" location "A1" has a Replenishment Policy for item "SKU-123" with min 5 and max 20
  And the current quantity of "SKU-123" in location "A1" is 3
  And there is 0 quantity of "SKU-123" in all backstock locations
  When the replenishment evaluation process runs
  Then no ReplenishmentTask is created
  And a BACKSTOCK_UNAVAILABLE event is logged
  And the metric replenishment_backstock.unavailable.count is incremented
```

## Audit & Observability
- **Audit Log:** The creation of every `ReplenishmentTask` must be recorded in an immutable audit log, including:
  - State of inventory and policy that triggered it
  - `triggerType` (EVENT or BATCH)
  - `decisionReason` (BELOW_MIN or SAFETY_SCAN)
  - `sourcingReason` (which hierarchy rule selected the source location)
  - `occurredAt` timestamp
  - Source backstock location(s) evaluated and selected

- **Events:** A `ReplenishmentTaskCreated` event must be published to a message bus (e.g., Kafka, RabbitMQ) upon successful task creation. The event payload should contain all task details including trigger metadata.

- **Metrics:** The Inventory service should expose metrics for monitoring:
  - `replenishment_tasks.created.count` (counter, tagged by location/item/triggerType)
  - `replenishment_evaluation.duration.ms` (timer, separate tags for event-driven vs batch)
  - `replenishment_backstock.unavailable.count` (counter for when no backstock is found)
  - `replenishment_event.debounced.count` (counter for debounced events)
  - `replenishment_tasks.partial.count` (counter for partial replenishment requiring multiple tasks)
  - `replenishment_sourcing.fefo.count` (counter for FEFO-based selections)
  - `replenishment_sourcing.fifo.count` (counter for FIFO-based selections)
  - `replenishment_batch.scan.duration.ms` (timer for batch job execution)

## Clarification Resolution

**Decision from Issue #228:**

### 1. Triggering Mechanism: **Hybrid Model**

**Primary Trigger:** Event-driven on `InventoryDecremented` events
- Only triggers when:
  - Decrement occurs in a Pick Face location, AND
  - Resulting on-hand ‚â§ minimum threshold
- Debounced to once per 60 seconds per `(productId, pickFaceLocationId)`
- Provides responsive, near-real-time replenishment

**Secondary Trigger:** Scheduled batch job every 5-15 minutes
- Acts as safety net for:
  - Missed events
  - Transient failures
  - Bulk adjustments
  - System reconciliation

**Why Hybrid:**
- Event-driven alone risks missed replenishment due to failures
- Batch alone introduces unacceptable latency
- Hybrid is industry standard for inventory correctness

### 2. Backstock Sourcing Logic: **Deterministic Hierarchy**

The system uses a **prioritized, deterministic hierarchy** (not "any location"):

1. **FEFO/FIFO Compliance** (if item is lot/expiry-controlled)
   - Earliest expiry date (FEFO)
   - Earliest receipt date (FIFO)

2. **Sufficient Quantity**
   - Prefer single backstock location that can fully satisfy the requirement

3. **Location Proximity** (if topology data exists)
   - Lowest layout order (Zone ‚Üí Aisle ‚Üí Rack ‚Üí Bin)

4. **Highest On-Hand Quantity**
   - Final deterministic tie-breaker

**Clarification on "Any Location":**
- "Any location with sufficient quantity" is only used as a **last-resort tie-breaker**
- NOT the primary rule
- Ensures deterministic, auditable, repeatable behavior
- Prevents FEFO/FIFO violations

### 3. Additional Required Behaviors

**Partial Replenishment:**
- If no single location has sufficient quantity, create **multiple tasks**
- Ordered by same sourcing hierarchy

**Idempotency:**
- Tasks are idempotent per `(productId, pickFaceLocationId, thresholdCrossing)`

**Audit Requirements:**
- Record `triggerType`, `sourceBackstockLocationId(s)`, `decisionReason`, `occurredAt`

---

## Original Story (Unmodified ‚Äì For Traceability)
# Issue #30 ‚Äî [BACKEND] [STORY] Putaway: Replenish Pick Faces from Backstock (Optional)

## Current Labels
- backend
- story-implementation
- user

## Current Body
## Backend Implementation for Story

**Original Story**: [STORY] Putaway: Replenish Pick Faces from Backstock (Optional)

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As an **Inventory Manager**, I want replenishment moves so that pick locations stay stocked.

## Details
- Define min/max for pick bins.
- Create replenishment tasks when below min.

## Acceptance Criteria
- Replenishment tasks created.
- Moves recorded.
- Audited.

## Integrations
- Improves mechanic pick speed; reduces stockouts.

## Data / Entities
- ReplenishmentPolicy, ReplenishmentTask, InventoryLedgerEntry(Transfer)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Backend Requirements

- Implement Spring Boot microservices
- Create REST API endpoints
- Implement business logic and data access
- Ensure proper security and validation

### Technical Stack

- Spring Boot 3.2.6
- Java 21
- Spring Data JPA
- PostgreSQL/MySQL

---
*This issue was automatically created by the Durion Workspace Agent*