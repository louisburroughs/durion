‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
DOMAIN: shopmgmt
Total Stories: 3
Generated: dim. 18 janv. 2026 12:03:02 EST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #74: [FRONTEND] [STORY] Appointment: Show Assignment (Location/Bay/Mobile + Mechanic) ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/74
File: ./scripts/story-work/frontend/74/after.md
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## üè∑Ô∏è Labels (Proposed)

### Required
- type:story
- domain:shopmgmt
- status:draft

### Recommended
- agent:shopmgmt-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] Appointment: Show Assignment (Bay/Mobile + Mechanic) with Near-Real-Time Updates

### Primary Persona
Service Advisor

### Business Value
Service Advisors can quickly confirm where work will be performed (bay vs mobile) and who is assigned (mechanic), improving customer expectation setting and reducing operational confusion.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to view the current appointment assignment (bay or mobile unit, mechanic, and notes)  
- **So that** I can set accurate expectations with the customer and coordinate internally.

### In-scope
- Read-only display of assignment details on Appointment detail view (and a compact summary in list contexts if present in current UI).
- Near-real-time refresh behavior (push subscription if available; polling fallback; manual refresh).
- Role-based access control for viewing assignments.
- Display assignment notes read-only for most roles; (optional) allow edit only for permitted roles *if frontend supports the write endpoint*.
- Degraded-mode display if assignment/mechanic identity cannot be loaded.

### Out-of-scope
- Creating/updating appointments, scheduling, or assignment decision logic.
- Automated customer notifications on assignment changes.
- Reverse geocoding mobile GPS coordinates (unless already available as a backend field).
- Mechanic HR profile management.

---

## 3. Actors & Stakeholders

### Primary
- **Service Advisor** (views assignment to communicate with customer)

### Secondary
- **Shop Manager / Dispatcher** (may have additional visibility and possible note-edit permissions)
- **Mechanic** (stakeholder of assignment, not primary UI user here)
- **Customer** (impacted indirectly)

### Systems
- **shopmgmt backend**: system of record for assignment data
- **People/HR backend**: system of record for mechanic identity (name/photo/certs) as referenced by shopmgmt
- **Audit**: captures viewing-sensitive actions and any overrides/edits (notes edits if enabled)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- User has permission to view appointment details for a given facility.
- Appointment exists and is accessible within facility scope.

### Dependencies
- Backend endpoint(s) to fetch `AssignmentView` for an appointment.
- Backend strategy for real-time updates:
  - Push (WebSocket/SSE) channel/event name(s) for `ASSIGNMENT_UPDATED`, **or**
  - Polling endpoint that returns updated `AssignmentView`.
- Optional backend endpoint to update assignment notes (only if enabling notes edit).

> Note: Backend reference story states these decisions are resolved, but the exact API paths/event channel identifiers are not provided in the input. This story is therefore blocked on contract clarification (see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Appointment Detail** screen (primary).
- If Appointment List screen exists: show compact assignment summary per row (secondary, only if already present in the frontend IA).

### Screens to create/modify (Moqui)
- **Modify**: `apps/pos/screen/appointment/AppointmentDetail.xml` (or equivalent appointment detail screen)
  - Add an ‚ÄúAssignment‚Äù section driven by a `screen-service` call to load assignment data.
- **Optional Modify**: `apps/pos/screen/appointment/AppointmentList.xml` (or equivalent)
  - Add compact assignment summary column/line.

### Navigation context
- Within appointment context: requires `appointmentId` in parameters.
- Facility scoping: ensure facility context is included (from session/user context or explicit param), and passed to services if required by contract.

### User workflows

#### Happy path (assignment exists)
1. User opens Appointment Detail.
2. UI loads appointment context + assignment view.
3. UI shows:
   - Assignment type: **Bay** *or* **Mobile Unit**
   - Assigned bay/mobile identifier (and location if applicable)
   - Assigned mechanic identity
   - Notes (if any)
   - Timestamps (assigned at / last updated) if available
4. Assignment updates appear automatically (push) or within 30s (poll), with a visible ‚ÄúUpdated‚Äù indicator/banner.

#### Alternate path: unassigned / partially assigned
- UI shows ‚ÄúUnassigned‚Äù for missing components (no bay/mobile, no mechanic).
- If assignment status indicates pending skills/awaiting fulfillment (if field exists), show it as read-only status.

#### Alternate path: mobile GPS staleness
- If mobile assignment includes `lastUpdatedAt` and coordinate fields, show last update time and warn when stale per backend rules (see Business Rules section).

---

## 6. Functional Behavior

### Triggers
- Enter Appointment Detail screen.
- User clicks ‚ÄúRefresh assignment‚Äù.
- Real-time update event received OR polling interval fires while screen is visible.
- (Optional) user with permission edits notes and saves.

### UI actions
- Load and display assignment block.
- Show a non-blocking banner/toast when assignment changes while viewing:
  - ‚ÄúAssignment updated: Bay changed from X to Y‚Äù (message content can be generic if diff not available).
- Provide manual refresh control.

### State changes (frontend)
- Local view model transitions:
  - `idle` ‚Üí `loading` ‚Üí `loaded`
  - `loaded` ‚Üí `refreshing` (on event/poll/manual) ‚Üí `loaded`
  - `error` with retry option
- Track last-seen assignment `version` or `lastUpdatedAt` if provided to detect changes.

### Service interactions
- Fetch assignment view from shopmgmt.
- If mechanic identity is not fully contained in assignment payload:
  - Fetch mechanic details from People/HR using mechanicId(s) present in AssignmentView.
- Subscribe to assignment update events for the current appointment (if supported).
- Fallback polling every 30 seconds when:
  - push is unavailable, or
  - user is not connected to push channel, or
  - subscription fails.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- No creation/update validation except:
  - If notes editing is enabled: enforce max length **500 characters** client-side (and still rely on server validation).
  - Require a non-empty ‚Äúreason‚Äù only if backend requires it for note edits (unknown; open question).

### Enable/disable rules
- Assignment view section is visible only when user has `VIEW_ASSIGNMENTS` (or equivalent) permission.
- Notes field:
  - Read-only by default.
  - Editable only if user has `EDIT_ASSIGNMENT_NOTES`.

### Visibility rules
- Appointment states visible:
  - Allow viewing in `SCHEDULED`, `IN_PROGRESS`, `AWAITING_PARTS`, `READY`.
  - For `CANCELLED`: hide assignment unless user has `VIEW_CANCELLED_APPOINTMENTS`.
  - If appointment status is unknown/unavailable, rely on backend authorization and show ‚ÄúNot authorized‚Äù when denied.

### Error messaging expectations
- Permission denied: show ‚ÄúYou don‚Äôt have permission to view assignments for this facility.‚Äù
- Backend unavailable: show ‚ÄúAssignment data is temporarily unavailable. Showing last known data.‚Äù (only if cached/previously loaded) else show retry CTA.
- HR data unavailable: show mechanic as ‚ÄúMechanic ID: <id>‚Äù with warning ‚ÄúMechanic details unavailable.‚Äù

### Mobile GPS staleness warnings (from backend decisions)
- If assignment type is `MOBILE_UNIT` and `lastUpdatedAt` present:
  - If `now - lastUpdatedAt > 30 minutes`: show ‚ÄúLocation may be stale‚Äù.
  - If `now - lastUpdatedAt > 60 minutes`: show ‚ÄúMobile unit unavailable (stale location)‚Äù and visually de-emphasize location fields.

> If the assignment payload does not include GPS fields, only show `lastUpdatedAt` staleness warning (no maps).

---

## 8. Data Requirements

### Entities / View Models (frontend-facing)
- `AssignmentView` (from shopmgmt)
- `LocationRef` (bay or mobile reference)
- `MechanicRef` (mechanic reference or ID)
- (Optional) `AssignmentUpdatedEvent` payload for live updates

### Fields (type, required, defaults)

#### AssignmentView (expected)
- `appointmentId` (string/UUID, required)
- `facilityId` (string/UUID, required or inferred by context)
- `assignmentType` (enum: `BAY` | `MOBILE_UNIT` | `UNASSIGNED`, required)
- `bay` (object|null)
  - `bayId` (string/UUID)
  - `bayNameOrNumber` (string)
  - `locationName` (string, optional)
- `mobileUnit` (object|null)
  - `mobileUnitId` (string/UUID)
  - `mobileUnitName` (string, optional)
  - `lastKnownLat` (number, optional)
  - `lastKnownLon` (number, optional)
  - `lastUpdatedAt` (datetime, optional)
- `mechanic` (object|null)
  - `mechanicId` (string/UUID, optional if unassigned)
  - `displayName` (string, optional if HR call needed)
  - `photoUrl` (string, optional)
- `assignmentNotes` (string, optional; max 500)
- `assignedAt` (datetime, optional)
- `lastUpdatedAt` (datetime, optional)
- `version` (number, optional but preferred for change detection)
- `assignmentStatus` (enum, optional; e.g., `AWAITING_SKILL_FULFILLMENT`)

**Read-only vs editable**
- All fields read-only for Service Advisor.
- Only `assignmentNotes` may be editable for roles with `EDIT_ASSIGNMENT_NOTES` *if supported by backend contract*.

**Derived/calculated**
- `gpsStalenessState` derived from `mobileUnit.lastUpdatedAt` vs current time.
- `displayAssignmentSummary` derived string for list:  
  - `Bay <name> - <mechanic>` / `Mobile - <mechanic>` / `Unassigned`

---

## 9. Service Contracts (Frontend Perspective)

> API paths, request/response schemas, and event channel names are not included in provided inputs. The following defines **required contract shape**; exact endpoints are Open Questions.

### Load/view calls
1. `GET AssignmentView by appointmentId`
   - Inputs: `appointmentId`, (optional) `facilityId`
   - Output: `AssignmentView`
   - Errors:
     - 401/403 unauthorized
     - 404 appointment not found or not accessible
     - 503 shopmgmt unavailable

2. `GET Mechanic by mechanicId` (only if AssignmentView lacks display fields)
   - Inputs: `mechanicId`
   - Output: `MechanicRef` (min: displayName, optional photo/certs summary)
   - Errors: degraded display if unavailable

### Create/update calls (optional)
- `PUT/PATCH Assignment Notes`
  - Inputs: `appointmentId`, `assignmentNotes`, (optional) `expectedVersion`
  - Requires permission: `EDIT_ASSIGNMENT_NOTES`
  - Errors:
    - 409 concurrency/version mismatch
    - 400 validation (length > 500)
    - 403 permission denied

### Submit/transition calls
- None (this is display-only; no appointment workflow transitions).

### Error handling expectations
- Map backend validation errors to field-level errors for notes editing.
- Map 409 to ‚ÄúThis assignment changed while you were editing. Reload and try again.‚Äù
- Map network/503 to non-blocking banner + retry.

---

## 10. State Model & Transitions

### Allowed states (appointment context)
- Appointment status gating (view visibility):
  - Allowed: `SCHEDULED`, `IN_PROGRESS`, `AWAITING_PARTS`, `READY`
  - Conditional: `CANCELLED` only with `VIEW_CANCELLED_APPOINTMENTS`

### Role-based transitions
- None (read-only story). Optional notes edit is not a state transition.

### UI behavior per state
- If appointment is in a viewable status and user authorized:
  - Show assignment section.
- If appointment is CANCELLED and user lacks permission:
  - Hide assignment section and show ‚ÄúNot available for cancelled appointments.‚Äù
- If assignmentType is `UNASSIGNED`:
  - Show empty-state text and last updated if present.

---

## 11. Alternate / Error Flows

### Validation failures (notes edit only)
- Notes length > 500:
  - Prevent submit; show inline error.
- Server returns validation error:
  - Show inline error based on response message/code.

### Concurrency conflicts
- If backend returns 409/version mismatch on notes save:
  - UI reloads AssignmentView and informs user of updated value; user may retry.

### Unauthorized access
- If user lacks `VIEW_ASSIGNMENTS`:
  - Do not call assignment service (if permission is known client-side), or handle 403 gracefully.
  - Display permission error block in place of assignment.

### Empty states
- No assignment exists:
  - Show ‚ÄúNo resources assigned yet.‚Äù
- Mechanic unassigned but bay/mobile assigned:
  - Show ‚ÄúMechanic: Unassigned‚Äù
- Bay/mobile missing but mechanic assigned (should not happen but possible):
  - Show ‚ÄúLocation: Unassigned‚Äù and still show mechanic.

### Service outage / degraded data
- shopmgmt unreachable:
  - If previous data exists in memory, keep showing it with warning and allow refresh.
  - If no data, show error state + retry.
- People/HR unreachable:
  - Show mechanicId only (if present), with warning.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View assignment on appointment detail (assigned bay + mechanic)
**Given** I am authenticated as a Service Advisor with `VIEW_ASSIGNMENTS` for Facility A  
**And** an appointment in Facility A exists with a BAY assignment and a mechanic assigned  
**When** I open the Appointment Detail screen for that appointment  
**Then** I see the assigned bay identifier  
**And** I see the assigned mechanic name (or mechanic ID with a warning if HR is unavailable)  
**And** I see assignment notes if present  
**And** the assignment section is read-only.

### Scenario 2: Unassigned appointment shows empty state
**Given** I am authenticated as a Service Advisor with `VIEW_ASSIGNMENTS`  
**And** an appointment exists with no bay/mobile and no mechanic assigned  
**When** I open Appointment Detail  
**Then** I see ‚ÄúNo resources assigned yet‚Äù  
**And** no edit controls are shown.

### Scenario 3: Mobile unit assignment shows staleness warning
**Given** I am authenticated with `VIEW_ASSIGNMENTS`  
**And** an appointment has a MOBILE_UNIT assignment with `lastUpdatedAt` older than 30 minutes  
**When** I view the assignment section  
**Then** I see a warning that the mobile location may be stale  
**And** if `lastUpdatedAt` is older than 60 minutes, I see an ‚Äúunavailable‚Äù indication for the mobile unit.

### Scenario 4: Near-real-time updates reflect changes while viewing
**Given** I am viewing an appointment‚Äôs assignment section  
**And** the assignment changes in shopmgmt (e.g., bay changes or mechanic changes)  
**When** the frontend receives an assignment update event or detects the change via polling within 30 seconds  
**Then** the assignment section updates to show the latest assignment  
**And** I see a visible banner/toast indicating the assignment was updated.

### Scenario 5: Permission denied prevents viewing assignments
**Given** I am authenticated as a user without `VIEW_ASSIGNMENTS`  
**When** I open Appointment Detail  
**Then** I do not see assignment details  
**And** I see a message indicating I lack permission to view assignments.

### Scenario 6 (Optional): Notes editable only for authorized roles
**Given** I am authenticated as a Shop Manager with `EDIT_ASSIGNMENT_NOTES`  
**And** the backend supports updating assignment notes  
**When** I edit the assignment notes and save  
**Then** the updated notes are displayed  
**And** the save action is audited (backend)  
**And** a user without `EDIT_ASSIGNMENT_NOTES` cannot edit notes on the same screen.

---

## 13. Audit & Observability

### User-visible audit data
- If `assignedAt` / `lastUpdatedAt` fields are provided, display them read-only.
- If notes are edited (optional), show ‚ÄúLast edited at/by‚Äù only if backend provides fields; otherwise omit (do not invent).

### Status history
- Out of scope to display full assignment history unless backend provides a history endpoint (not provided).

### Traceability expectations
- Frontend should include correlation/trace id headers if Moqui integration supports it (standard pattern).
- Log (client-side) subscription/polling failures and show non-blocking UI warning.

---

## 14. Non-Functional UI Requirements

- **Performance**: Assignment section load should not block the rest of Appointment Detail rendering; show skeleton/loading state.
- **Accessibility**: Status messages (errors, updated banners) must be announced via ARIA live region; controls keyboard accessible.
- **Responsiveness**: Assignment section should render correctly on tablet POS layouts; avoid dense tables.
- **i18n/timezone**: Display timestamps in facility/local timezone if available; otherwise user‚Äôs timezone. (Need confirmation from project convention‚Äîopen question if strict.)
- **Security**: Do not expose assignment data across facilities; enforce scoping via backend and do not cache across facility context.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit ‚ÄúUnassigned‚Äù/empty-state messaging for missing assignment fields; qualifies as UI ergonomics and does not affect domain policy. Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- SD-UX-POLLING-FALLBACK: If push updates are unavailable, poll every 30s while screen is visible; matches backend decision and is a recoverable UI behavior. Impacted sections: Functional Behavior, Service Contracts, Acceptance Criteria.
- SD-UX-RETRY-ACTION: Provide a manual ‚ÄúRefresh assignment‚Äù action on error/loaded states; UI ergonomics only. Impacted sections: UX Summary, Alternate / Error Flows.

---

## 16. Open Questions

1. **API Contract**: What are the exact Moqui-accessible endpoints/services for:
   - Load `AssignmentView` by `appointmentId` (path/service name, request params, response schema)?
   - Load mechanic identity (is it embedded in `AssignmentView` or must we call People/HR; if so, endpoint/service name)?
2. **Real-time Updates**: What is the exact mechanism and identifiers for push updates in this frontend?
   - WebSocket vs SSE?
   - Channel/topic naming and event payload for `ASSIGNMENT_UPDATED` (and whether it includes full AssignmentView vs partial delta)?
3. **Facility scoping**: Is `facilityId` required explicitly in requests, or inferred from session/context in Moqui services?
4. **Appointment status source**: Do we already have appointment status available on the Appointment Detail screen to enforce ‚Äúexclude CANCELLED unless permitted‚Äù, or should backend enforce this entirely?
5. **Notes editing scope**: Should this frontend story include notes editing for authorized roles now, or remain strictly read-only? If included, confirm:
   - endpoint/service and payload
   - whether optimistic concurrency uses `version` and returns 409
   - whether ‚Äúreason‚Äù is required for note edits
6. **Timestamp formatting convention**: What is the project standard for timezone display (facility timezone vs user timezone) in the POS UI?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Appointment: Show Assignment (Location/Bay/Mobile + Mechanic) ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/74

---

FRONTEND STORY (FULL CONTEXT)

Title: [FRONTEND] [STORY] Appointment: Show Assignment (Location/Bay/Mobile + Mechanic)  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/74  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Appointment: Show Assignment (Location/Bay/Mobile + Mechanic)

**Domain**: user

### Story Description

/kiro  
# User Story

## Narrative  
As a **Service Advisor**, I want to see assigned resources so that I can set expectations.

## Details  
- Display assigned bay/mobile unit and mechanic.  
- Show notes (optional).

## Acceptance Criteria  
- Assignment displayed.  
- Updates reflect changes.  
- Read-only for most roles.

## Integrations  
- Shopmgr provides assignment data; HR provides mechanic identity.

## Data / Entities  
- AssignmentView, LocationRef, MechanicRef

## Classification (confirm labels)  
- Type: Story  
- Layer: Experience  
- domain :  Point of Sale

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #75: [FRONTEND] [STORY] Appointment: Reschedule Appointment with Notifications ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/75
File: ./scripts/story-work/frontend/75/after.md
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## üè∑Ô∏è Labels (Proposed)

### Required
- type:story
- domain:shopmgmt
- status:draft

### Recommended
- agent:shopmgmt-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

**Title**  
[FRONTEND] [STORY] Appointment: Reschedule Appointment with Notifications

**Primary Persona**  
Scheduler (Service Advisor / Dispatcher)

**Business Value**  
Keep shop operations coordinated by allowing authorized users to reschedule appointments while preserving estimate/work order links, preventing/handling conflicts correctly, recording an auditable reason trail, and triggering downstream notifications/updates.

---

## 2. Story Intent

**As a** Scheduler  
**I want** to reschedule an existing appointment (date/time) with a required reason and optional notes and notifications  
**So that** schedule changes are coordinated across shop operations, downstream systems, and affected parties with a complete audit trail.

### In-scope
- UI workflow to reschedule an existing appointment:
  - Select new date/time
  - Select reason (enum) and enter notes where required
  - See conflicts (hard/soft), choose alternate slot or override if permitted
  - Choose whether to notify customer/mechanic (subject to backend enforcement)
- Display resulting update status:
  - New scheduled time
  - Assignment preserved/cleared outcome
  - Notification status summary (if provided by backend)
- Facility-scoped permission gating and error feedback
- Audit visibility (who/why/when) at least in ‚Äúview appointment‚Äù context if API provides it

### Out-of-scope
- Creating appointments
- Editing estimate/work order links (must remain immutable)
- Recurring/series reschedules
- Implementing conflict detection logic on the frontend (frontend only renders backend results)
- Building notification delivery UI (compose templates, channel management) beyond toggles and status display

---

## 3. Actors & Stakeholders
- **Scheduler**: initiates reschedule
- **Shop Manager / Dispatcher**: may approve overrides depending on permission
- **Customer**: may receive reschedule notifications
- **Assigned Mechanic**: may be notified and/or unassigned
- **Shop Management (shopmgmt) backend**: system of record for appointment schedule/assignment
- **Work Execution service**: consumes reschedule events for planned time updates (indirect from frontend)
- **Notification service**: sends notifications (indirect from frontend)
- **Audit service/log**: records immutable audit entries (indirect from frontend)

---

## 4. Preconditions & Dependencies

### Preconditions
- Appointment exists and is in a reschedulable state (backend-enforced; frontend must handle denials gracefully).
- User is authenticated and scoped to a facility that contains the appointment.
- User has `RESCHEDULE_APPOINTMENT` permission (backend-enforced; frontend should hide/disable entry points if permission info available).

### Dependencies
- Backend endpoints/services for:
  - loading appointment details (including current schedule, assignments, reschedule eligibility, and reschedule count if applicable)
  - conflict-check / preview (optional but strongly preferred for UX)
  - reschedule submit (with reason/notes/notify flags/override metadata)
  - (optional) audit log retrieval and notification status retrieval

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Appointment detail screen: ‚ÄúReschedule‚Äù action/button (visible only when appointment is reschedulable and user has permission, if those flags are available).
- From Appointment list/board: contextual action ‚ÄúReschedule‚Äù (navigates to appointment detail then reschedule modal/page, or opens directly).

### Screens to create/modify (Moqui)
- **Modify**: `apps/pos/screen/shopmgmt/AppointmentDetail.xml` (name illustrative)
  - Add ‚ÄúReschedule‚Äù action and reschedule history/audit snippet area (if data available)
- **Create**: `apps/pos/screen/shopmgmt/AppointmentReschedule.xml`
  - Can be a dialog-style screen or dedicated route screen
  - Contains form for new date/time, reason, notes, notify flags, and override section
- **Optional Create/Modify**: reusable widget/form:
  - `component://.../screen/shopmgmt/widget/AppointmentRescheduleForm.xml`

### Navigation context
- Route includes `appointmentId` and preserves facility context (from session or explicit parameter).
- After success, navigate back to Appointment detail with a toast/banner indicating the updated schedule and any assignment/notification outcomes.

### User workflows
**Happy path**
1. Scheduler opens Appointment Detail ‚Üí clicks ‚ÄúReschedule‚Äù.
2. Reschedule form loads current schedule + reschedule rules/limits (if available).
3. Scheduler selects new date/time, selects reason, adds notes if required, leaves notify on (default as provided by backend/UI).
4. UI performs conflict check (either on change or on ‚ÄúCheck conflicts‚Äù action).
5. If no hard conflicts, scheduler submits.
6. UI shows confirmation state, then returns to Appointment Detail showing updated time and audit entry.

**Alternate paths**
- Conflicts detected (soft): show warning list, allow proceed.
- Conflicts detected (hard): block submit; if user has override permission, allow entering override reason/notes and proceed.
- Minimum-notice or reschedule-limit rule violated: backend returns policy error; UI explains and (if applicable) indicates ‚Äúmanager approval required‚Äù (without inventing the workflow).
- Mechanic/bay no longer available: backend reschedules but clears assignment; UI shows assignment status and prompts to go to assignment workflow (link to existing screen if any).

---

## 6. Functional Behavior

### Triggers
- User clicks ‚ÄúReschedule‚Äù from appointment context.
- User changes proposed date/time in the reschedule form.
- User clicks ‚ÄúCheck conflicts‚Äù (if implemented) and/or ‚ÄúSubmit reschedule‚Äù.

### UI actions (must be deterministic)
- Load appointment snapshot for reschedule:
  - current scheduled datetime
  - current assignment (bay/mobile unit, mechanic)
  - reschedule eligibility + reason enum list (if API supports)
- Collect inputs:
  - `newScheduledDateTime` (required)
  - `rescheduleReason` (required enum)
  - `rescheduleReasonNotes` (optional unless reason=OTHER or override used)
  - notification toggles (see Open Questions)
  - override flag and override reason fields only when hard conflicts present and user has override permission
- Display conflict results:
  - categorize and render hard vs soft
  - show suggested alternatives if provided
- Submit reschedule:
  - call backend submit service
  - on success: show updated schedule + assignment outcome + notification outcome (if provided)
  - on failure: map errors to field-level or banner-level messages

### State changes (frontend perspective)
- Local UI state transitions: `idle ‚Üí loading ‚Üí editing ‚Üí validatingConflicts ‚Üí readyToSubmit ‚Üí submitting ‚Üí success|error`
- No frontend-owned domain state; all domain state is backend-driven.

### Service interactions (frontend perspective)
- `loadAppointmentForReschedule(appointmentId)`
- optional `checkRescheduleConflicts(appointmentId, newScheduledDateTime, preserveAssignmentPreference?)`
- `rescheduleAppointment(payload)`

---

## 7. Business Rules (Translated to UI Behavior)

> Backend is authoritative for rule enforcement. Frontend must *collect required inputs*, *request conflict evaluation*, and *render decisions*.

### Validation
- New scheduled date/time is required and must be a valid datetime in shop timezone (timezone source must be explicit; see Open Questions).
- Reschedule reason is required (enum).
- Notes required when:
  - reason = `OTHER`
  - an override is applied (hard conflict override and/or policy override), per backend rule
- If backend returns ‚Äúnot reschedulable state‚Äù ‚Üí show blocking banner and disable submit.
- If backend returns ‚Äúmin notice requires approval‚Äù ‚Üí show blocking banner and disable submit unless backend indicates override allowed with user permission.

### Enable/disable rules
- Disable ‚ÄúSubmit‚Äù until required fields present and conflict check completed **if** backend requires conflict check token/version (unknown; see Open Questions). Otherwise allow submit and handle conflict response.
- Override UI elements enabled only when:
  - backend reports hard conflicts OR backend returns an error requiring override
  - and user has `OVERRIDE_SCHEDULING_CONFLICT` (if permission info available)
- Notify toggles:
  - default state should come from backend if provided; otherwise do not assume mandatory behavior beyond allowing a toggle (see Open Questions)

### Visibility rules
- Show ‚ÄúAssignment impact‚Äù section if backend returns assignment preservation/clearing decision.
- Show ‚ÄúNotification result‚Äù section if backend returns statuses (or show a generic ‚Äúnotification queued‚Äù message if only a boolean confirmation is returned).

### Error messaging expectations
- Field-level: missing reason, invalid datetime, missing notes when required.
- Banner-level:
  - permission denied
  - reschedule limit exceeded without approval
  - hard conflicts without override permission
  - backend/service unavailable (retry guidance)

---

## 8. Data Requirements

### Entities involved (frontend read/write)
- **Appointment** (read)
- **AppointmentUpdate** (write model for reschedule)
- **Conflict** (read model)
- **AuditLog** (read, optional)
- **NotificationOutbox / NotificationStatus** (read, optional)

### Fields
**Appointment (read)**
- `appointmentId` (string/ID, required)
- `facilityId` (string/ID, required)
- `scheduledDateTime` (datetime, required)
- `state/status` (enum/string, required)
- `estimateId` (ID, nullable)
- `workOrderId` (ID, nullable)
- assignment:
  - `bayId` (ID, nullable)
  - `mobileUnitId` (ID, nullable)
  - `mechanicId` (ID, nullable)

**AppointmentUpdate (submit)**
- `appointmentId` (required)
- `newScheduledDateTime` (required datetime)
- `rescheduleReason` (required enum: CUSTOMER_REQUEST, SHOP_CAPACITY, EQUIPMENT_ISSUE, MECHANIC_UNAVAILABLE, PARTS_DELAY, WEATHER, EMERGENCY, MANAGER_DISCRETION, OTHER)
- `rescheduleReasonNotes` (string, required when reason=OTHER; also required when overriding)
- `notifyCustomer` (boolean, optional/required? see Open Questions)
- `notifyMechanic` (boolean, optional/derived? see Open Questions)
- `overrideHardConflicts` (boolean, only when needed)
- `overrideReason` (string, required when overrideHardConflicts=true)
- `overrideApprovedBy` (ID/string, **do not implement collection unless backend requires**; see Open Questions)
- `clientRequestId` (string idempotency key; if supported)

**Conflict result (read)**
- `conflicts[]`: each with
  - `code` (string)
  - `severity` (HARD|SOFT)
  - `message` (string)
  - `resourceType` (BAY|MECHANIC|CAPACITY|HOURS|OTHER)
- `suggestedAlternatives[]` (optional): datetime list and/or resource suggestions

### Read-only vs editable
- estimate/workOrder link fields are read-only and must not be editable.
- previous scheduled time is read-only display.

### Derived/calculated fields (display-only)
- ‚ÄúNotice window‚Äù indicator (e.g., ‚Äú<24h‚Äù) should only be shown if backend provides computed policy evaluation; do not compute policy locally unless explicitly defined.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui services/screen actions must call backend services; exact service names/endpoints are not provided in inputs, so these are contract placeholders.

### Load/view calls
1. `shopmgmt.Appointment.get#ForReschedule`
   - Request: `appointmentId`
   - Response: appointment snapshot + eligibility + rescheduleCount + allowedReasons + permissions (optional) + timezone (preferred)

2. Optional: `shopmgmt.Appointment.check#RescheduleConflicts`
   - Request: `appointmentId`, `newScheduledDateTime`
   - Response: `conflicts[]`, `suggestedAlternatives[]`, `canOverride` (optional)

### Create/update calls
- none (reschedule is an update/transition)

### Submit/transition calls
1. `shopmgmt.Appointment.reschedule#Submit`
   - Request: `AppointmentUpdate` (see Data Requirements)
   - Response (preferred): updated appointment + assignment outcome + notification outcome + audit reference

### Error handling expectations
- 400/validation: map to field errors (reason missing, notes missing, datetime invalid)
- 403/permission: show access denied, disable action
- 409/conflict: show conflicts; if overridable, prompt for override reason and re-submit with override flag
- 404: appointment not found ‚Üí navigate back to list with error banner
- 5xx/network: show retry banner; keep form inputs intact

---

## 10. State Model & Transitions

### Allowed states (relevant to reschedule)
- Reschedulable: `SCHEDULED`, `CONFIRMED`, `AWAITING_PARTS` (per backend reference)
- Not reschedulable: `COMPLETED`, `CANCELLED` and others (backend authoritative)

### Role-based transitions
- Scheduler with `RESCHEDULE_APPOINTMENT`: can request reschedule when eligible and no blocking hard conflicts/policy blocks.
- Users with `OVERRIDE_SCHEDULING_CONFLICT`: can override hard conflicts with reason.
- Users with `APPROVE_RESCHEDULE`: can approve policy exceptions (minimum notice / reschedule count) if backend supports such override.

### UI behavior per state
- If appointment state not reschedulable: hide/disable ‚ÄúReschedule‚Äù and show tooltip/message (if state is known).
- If reschedulable: allow entering reschedule.
- If override required and user lacks permission: block submission with clear message.

---

## 11. Alternate / Error Flows

1. **Validation failure (client-side)**
   - Missing reason or datetime ‚Üí inline errors, prevent submit.
   - Notes missing for OTHER or override ‚Üí inline error.

2. **Hard conflicts detected**
   - Display conflicts as blocking.
   - If user has override permission: show override reason input, allow submit.
   - If not: disable submit and provide instruction to contact manager/dispatcher.

3. **Soft conflicts detected**
   - Display warnings; allow proceed (submit enabled).

4. **Concurrency conflict**
   - Backend returns 409 ‚Äúappointment changed/version mismatch‚Äù (if supported):
     - UI prompts user to reload appointment snapshot, preserving their proposed inputs where possible.

5. **Unauthorized**
   - Backend returns 403:
     - UI navigates to appointment detail with ‚ÄúNot authorized to reschedule‚Äù banner.

6. **External service degradation (notifications/workexec)**
   - If backend returns partial success (reschedule succeeded but notification failed/queued):
     - UI must show reschedule success and surface notification status and manual follow-up prompt (if status provided).

7. **Empty states**
   - No suggested alternatives returned ‚Üí show ‚ÄúNo alternatives provided‚Äù and allow user to pick a different time.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Reschedule succeeds with no conflicts
Given a Scheduler has `RESCHEDULE_APPOINTMENT` permission for the facility  
And an appointment exists in state SCHEDULED with an estimate/work order link  
When the Scheduler selects a new scheduled date/time and a reschedule reason (not OTHER)  
And submits the reschedule request  
Then the UI shows the updated scheduled date/time on the Appointment Detail screen  
And the estimate/work order links remain unchanged and read-only  
And an audit record summary (who/why/when) is visible or linked if provided by the backend.

### Scenario 2: Reschedule blocked due to hard conflict without override permission
Given a Scheduler has `RESCHEDULE_APPOINTMENT` permission but not `OVERRIDE_SCHEDULING_CONFLICT`  
And the backend reports a HARD conflict for the selected new date/time  
When the Scheduler attempts to submit the reschedule  
Then the UI blocks submission  
And displays the hard conflict(s) as blocking errors  
And does not change the appointment scheduled time.

### Scenario 3: Reschedule proceeds with soft conflict warning
Given a Scheduler has `RESCHEDULE_APPOINTMENT` permission  
And the backend reports only SOFT conflicts for the selected new date/time  
When the Scheduler submits the reschedule request  
Then the UI allows submission after showing the warning(s)  
And on success shows the updated scheduled date/time.

### Scenario 4: Hard conflict override requires reason and permission
Given a user has `RESCHEDULE_APPOINTMENT` and `OVERRIDE_SCHEDULING_CONFLICT` permissions  
And the backend reports a HARD conflict for the selected new date/time  
When the user enters an override reason (and notes if required)  
And submits the reschedule request with override enabled  
Then the reschedule succeeds  
And the UI indicates that an override was applied  
And the audit trail includes the override reason (as provided by backend).

### Scenario 5: Reason OTHER requires notes
Given a Scheduler is rescheduling an eligible appointment  
When the Scheduler selects reschedule reason OTHER  
And leaves notes empty  
Then the UI prevents submission and shows a field-level error for notes  
When the Scheduler enters notes and submits  
Then the reschedule request is sent successfully (subject to backend validation).

### Scenario 6: Notification failure is surfaced without losing reschedule success
Given a Scheduler reschedules an appointment successfully  
And the backend response indicates notification delivery failed or requires manual follow-up  
When the UI displays the result  
Then the UI shows reschedule success  
And displays notification failure status and a prompt to manually contact affected parties.

---

## 13. Audit & Observability

### User-visible audit data
- Show at minimum:
  - rescheduledBy (actor)
  - rescheduledAt (timestamp)
  - reason (enum) and notes (if allowed to display)
  - previous vs new scheduled datetime
  - whether override applied

### Status history
- If backend provides reschedule history (previous schedule times): render in a simple list/table.

### Traceability expectations
- Include `appointmentId` in all frontend logs.
- Propagate correlation/request ID if backend supports it (e.g., `X-Request-Id` or Moqui context).

---

## 14. Non-Functional UI Requirements

- **Performance**: conflict check and submit interactions should keep UI responsive; show loading state; avoid repeated calls on every keystroke (debounce datetime changes if auto-checking).
- **Accessibility**: all form controls have labels; errors are announced; keyboard operable.
- **Responsiveness**: works on tablet widths used in shop environments.
- **i18n/timezone**:
  - Datetime display and input must be consistent with facility timezone (source must be clarified if not provided).
  - No currency handling in this story.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Show explicit empty state when no conflicts or no alternatives are returned; qualifies as UI ergonomics; impacts UX Summary / Alternate Flows.
- SD-UX-LOADING: Standard loading and disabled-submit states during service calls; qualifies as UI ergonomics; impacts Functional Behavior / Error Flows.
- SD-ERR-MAP: Map 400‚Üífield errors, 403‚Üíunauthorized banner, 409‚Üíconflict/concurrency banner, 5xx‚Üíretry; qualifies as standard error-handling mapping; impacts Service Contracts / Alternate Flows.

---

## 16. Open Questions

1. **Rewrite Variant conflict**: This story‚Äôs domain is `shopmgmt`, but the required variant mapping table does not include `domain:shopmgmt`. Which variant should be used for shopmgmt stories? (Currently set to `workexec-structured` as the closest operational-flow variant, but this needs confirmation.)
2. **Backend service contract names**: What are the exact Moqui services/endpoints for:
   - loading appointment for reschedule
   - conflict checking
   - submitting reschedule
   Provide request/response schemas or entity fields actually exposed.
3. **Timezone source of truth**: Should scheduling input/display use facility timezone from backend, user profile timezone, or browser timezone? Is it returned in appointment payload?
4. **Conflict-check UX contract**: Is conflict checking a separate call returning suggested alternatives, or is it only returned on submit (409 with conflict payload)? Does backend require a ‚ÄúconflictCheckToken/version‚Äù to submit?
5. **Notification toggles**: Does the frontend collect `notifyCustomer` and `notifyMechanic`, or is notification behavior determined entirely by backend policy? If toggles exist, what are defaults and when are they forced on (e.g., within 24h)?
6. **Manager approval flow**: For minimum notice (<24h / <4h) and ‚Äúmax 2 reschedules‚Äù rules, how is approval represented in the UI?
   - Is it just permission-based self-approval (`APPROVE_RESCHEDULE`)?
   - Or is there an explicit approver identity capture / second factor / workflow?
7. **Audit visibility**: Is there an API to retrieve audit entries for an appointment, or does the reschedule response include audit metadata? What fields are allowed to display (PII constraints)?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Appointment: Reschedule Appointment with Notifications ‚Äî URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/75

Labels: frontend, story-implementation, user

### Story Description

/kiro  
# User Story

## Narrative  
As a **Scheduler**, I want to reschedule appointments so that changes are coordinated.

## Details  
- Reschedule maintains link to estimate/workorder.  
- Capture reason and notify downstream systems (optional).

## Acceptance Criteria  
- Reschedule updates shopmgr.  
- Conflicts prevented.  
- Audit includes who/why.

## Integrations  
- Shopmgr update API; workexec sees updated planned time.

## Data / Entities  
- AppointmentUpdate, NotificationOutbox, AuditLog

## Classification (confirm labels)  
- Type: Story  
- Layer: Experience  
- domain :  Point of Sale

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ISSUE #76: [FRONTEND] [STORY] Appointment: Create Appointment from Estimate or Order  
File: ./scripts/story-work/frontend/76/after.md
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STOP: Clarification required before finalization

## üè∑Ô∏è Labels (Proposed)

### Required
- type:story
- domain:shopmgmt
- status:draft

### Recommended
- agent:shopmgmt-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title:** [FRONTEND] Appointment: Create Appointment from Estimate or Work Order (Shop Scheduler)

**Primary Persona:** Scheduler (Service Advisor / Dispatcher)

**Business Value:** Enables schedulers to convert an approved estimate or active work order into a scheduled appointment with resource requirements, conflict visibility, and immutable source linkage‚Äîreducing manual entry and preventing double-booking.

---

## 2. Story Intent

### As a / I want / So that
As a **Scheduler**, I want to **create an appointment from an estimate or work order** so that **the work is scheduled with the right duration, skills, and bay/mobile requirements, and conflicts are surfaced before confirming**.

### In-scope
- Entry flow to create an appointment from:
  - an **Estimate** (eligible statuses) or
  - a **Work Order** (eligible statuses)
- Pre-population of appointment request fields:
  - service description (read-only display)
  - duration minutes (WorkExec-authoritative when available)
  - required/preferred skill tags
  - bay type requirements and/or mobile eligibility
- Interactive scheduling selection:
  - pick one scheduled start date/time (from allowed date range)
  - optionally choose bay preference and mechanic preference (if exposed by backend)
- Conflict check presentation and override flows:
  - hard vs soft conflicts
  - override permission + mandatory reason when applicable
- Successful create confirmation and navigation to appointment detail

### Out-of-scope
- Rescheduling an existing appointment (separate story)
- Editing assignment post-create (mechanic/bay changes) beyond what create flow allows
- Dispatch optimization / automatic slot selection beyond backend ‚Äúsuggested alternatives‚Äù
- Customer notification management UI (only show result/status if returned)
- Defining facility hours, bay inventory, or assignment strategies (configuration)

---

## 3. Actors & Stakeholders
- **Primary user:** Scheduler
- **Secondary users:** Shop Manager (may override), Dispatcher
- **Systems:**
  - Shop Management (shopmgmt) backend API (system of record)
  - Work Execution service (duration/skills authority, via shopmgmt)
  - People/HR service (mechanic qualification/availability, via shopmgmt)
  - Audit service (via shopmgmt)
  - Notification service (via shopmgmt)

---

## 4. Preconditions & Dependencies
- User is authenticated in POS and has facility context selected (facility scoping required).
- User has permission `CREATE_APPOINTMENT`.
- Source exists and is eligible:
  - Estimate in APPROVED/QUOTED (exact enum values must match backend)
  - Work order not COMPLETED/CANCELLED
- Source is not already linked to an active appointment unless `allowsMultipleAppointments=true` (backend-controlled).
- Dependency: shopmgmt backend endpoints for:
  - viewing source summary & eligibility
  - conflict checking (or included as part of create)
  - creating appointment (with optional override)
- Dependency: UI routes/screen patterns as defined in `durion-moqui-frontend` README (Moqui screens, transitions, forms).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
At least one of:
- From **Estimate detail**: action ‚ÄúCreate Appointment‚Äù
- From **Work Order detail**: action ‚ÄúCreate Appointment‚Äù
- (Optional) Global scheduler entry with source search is out-of-scope unless already present.

### Screens to create/modify
1. **Modify**: Estimate detail screen ‚Äî add transition/action to appointment create
2. **Modify**: Work order detail screen ‚Äî add transition/action to appointment create
3. **Create**: `AppointmentCreate` screen (source-driven)
4. **Create/Modify**: `AppointmentDetail` screen (or existing appointment view) for post-create navigation

> Moqui expectation: implement as a screen with a form for request fields, transitions for ‚ÄúCheck Conflicts‚Äù and ‚ÄúCreate Appointment‚Äù, and conditional sections for conflict results and override input.

### Navigation context
- Breadcrumb includes Source ‚Üí Create Appointment.
- On success: navigate to Appointment Detail (appointmentId).

### User workflows
**Happy path**
1. Scheduler clicks ‚ÄúCreate Appointment‚Äù on eligible source.
2. Create screen loads pre-populated defaults (duration, skills, bay type requirements).
3. Scheduler chooses scheduled start date/time.
4. Scheduler clicks ‚ÄúCheck Conflicts‚Äù (or conflicts checked automatically‚ÄîTBD).
5. No conflicts ‚Üí clicks ‚ÄúCreate Appointment‚Äù.
6. Confirmation shown; redirect to appointment detail.

**Alternate paths**
- Soft conflicts returned ‚Üí show warning list + suggested alternatives; scheduler may proceed (with optional reason if required by backend).
- Hard conflicts returned ‚Üí block create; if user has `OVERRIDE_SCHEDULING_CONFLICT` and backend marks conflict overridable, allow override with mandatory reason.
- WorkExec duration mismatch warning shown ‚Üí allow scheduler override within allowed threshold with reason (if implemented in UI; otherwise keep duration read-only and display warning).

---

## 6. Functional Behavior

### Triggers
- User opens the create screen from an estimate/work order.
- User changes scheduled date/time or resource preferences.
- User requests conflict check (button) and/or submits create.

### UI actions
- **Load**: fetch source summary + appointment defaults.
- **Edit inputs**:
  - scheduledStartDateTime (required)
  - durationMinutes (editable only if backend allows override; otherwise read-only)
  - requiredSkills/preferredSkills (usually read-only; clarify)
  - bayTypeRequired / mobile flag (read-only if driven by service; clarify)
  - bay preference (optional)
  - mechanic preference (optional)
- **Check conflicts**: calls backend conflict check with current draft inputs.
- **Create**:
  - if conflicts present: enforce blocking rules
  - collect override flag + override reason when allowed
  - submit create request
- **Success**: show confirmation banner + navigate to appointment detail.
- **Failure**: map backend errors to form-field errors or page-level alerts.

### State changes (frontend-observable)
- Draft state in UI: `draft` ‚Üí `conflicts_checked` ‚Üí `ready_to_submit` (client-side only)
- Created appointment returns authoritative `appointmentId`, `appointmentStatus`, `assignmentStatus`.

### Service interactions (frontend perspective)
- `GET` source+defaults (or `GET` source then `GET` defaults)
- `POST` conflictCheck (optional but recommended)
- `POST` createAppointment

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (client + server)
Client-side (non-authoritative) validations:
- scheduledStartDateTime required and must be in the future (exact rule: at least ‚Äúnow‚Äù; clarify if minimum notice differs for create).
- If overrideConflict=true ‚Üí overrideReason required (non-empty, min length TBD).

Server-side enforcement (display results):
- Source eligibility enforced; show blocking message if not eligible.
- Conflict results:
  - **Hard conflicts**: disable ‚ÄúCreate Appointment‚Äù unless override permitted and user has permission.
  - **Soft conflicts**: allow ‚ÄúCreate Appointment‚Äù; show warnings and suggested alternatives.
- Duration authority / overrides:
  - If backend returns ‚ÄúdurationMismatch‚Äù warning, display it.
  - If backend allows editing duration:
    - allow override within ¬±25% with reason required
    - beyond that require `APPROVE_DURATION_OVERRIDE` (UI should block or request elevated permission‚ÄîTBD)

### Enable/disable rules
- Disable ‚ÄúCreate Appointment‚Äù until:
  - scheduledStartDateTime set
  - conflicts checked successfully OR backend indicates conflict check is embedded in create response (TBD)
- If conflicts include non-overridable hard conflicts: disable submit.
- If overridable hard conflicts: enable submit only when:
  - user has permission AND overrideReason provided.

### Visibility rules
- Show ‚ÄúConflict Results‚Äù section only after conflict check or after create attempt returns conflicts.
- Show ‚ÄúOverride‚Äù inputs only when conflicts exist and backend indicates override allowed and user has permission.

### Error messaging expectations
- Permission denied ‚Üí ‚ÄúYou don‚Äôt have permission to create appointments for this facility.‚Äù
- Source already linked ‚Üí ‚ÄúThis estimate/work order is already linked to an active appointment.‚Äù
- Conflict hard block ‚Üí show specific conflict codes/messages and suggested alternatives if provided.

---

## 8. Data Requirements

### Entities involved (frontend model)
- AppointmentRequest
- AppointmentRef (response)
- ConflictResult (response)
- SourceSummary (estimate/work order summary)

> Note: Actual Moqui entities and service names must match backend; treat these as view-models unless Moqui entities exist in frontend layer.

### Fields
**AppointmentRequest**
- `sourceType` (enum: `ESTIMATE` | `WORK_ORDER`) **required**
- `sourceId` (string/UUID) **required**
- `facilityId` (string/UUID) **required** (from session/context)
- `scheduledStartDateTime` (datetime, ISO-8601 w/ timezone) **required**
- `preferredDateTimeOptions[]` (datetime[]) optional (if UI supports multiple suggestions; likely omit for MVP)
- `durationMinutes` (int) required if editable; otherwise omit and let backend decide (TBD)
- `requiredSkills[]` (string[]) read-only display (TBD if editable)
- `preferredSkills[]` (string[]) read-only display (optional)
- `bayTypeRequired` (enum) read-only display (TBD)
- `isMobile` (bool) read-only display (TBD)
- `bayPreferenceId` (string) optional (if supported)
- `mechanicPreferenceId` (string) optional (if supported)
- `overrideConflict` (bool) optional, default false
- `overrideReason` (string) conditionally required
- `clientRequestId` (string) optional for idempotency (recommended; see Open Questions)

**AppointmentRef (response)**
- `appointmentId` **required**
- `appointmentStatus` (enum) required
- `assignmentStatus` (enum) required
- `scheduledStartDateTime`
- `estimatedDurationMinutes`
- `assignedBay` (nullable)
- `assignedMechanic` (nullable)
- `estimateId` (nullable)
- `workOrderId` (nullable)

### Read-only vs editable by state/role
- Scheduler:
  - editable: scheduledStartDateTime
  - editable only if permitted: overrideConflict, overrideReason, durationMinutes (if backend supports)
  - read-only: source linkage fields, required skills, bay type requirements
- Manager:
  - may see/perform overrides if permission present

### Derived/calculated fields
- ‚ÄúDuration mismatch‚Äù warning (derived from backend response)
- Conflict summary counts by severity (derived from ConflictResult)

---

## 9. Service Contracts (Frontend Perspective)

> Backend API details are marked TBD in domain guide; frontend must not guess exact endpoints. Implement via Moqui service calls consistent with existing project patterns (Open Questions).

### Load/view calls
- `loadSourceForAppointmentCreate(sourceType, sourceId, facilityId)` ‚Üí returns:
  - source summary (customer/vehicle/service description)
  - eligibility flags / reasons
  - default duration + mismatch warnings
  - required/preferred skills
  - bay/mobile requirements
  - whether multiple appointments allowed

### Conflict check calls
- `checkAppointmentConflicts(appointmentDraft)` ‚Üí returns ConflictResult:
  - `hasConflicts`
  - list of conflicts with:
    - `severity` (HARD|SOFT)
    - `code`
    - `message`
    - `overridable` (bool)
  - `suggestedAlternatives[]` (datetime options and/or bay/mechanic suggestions)

### Create/update calls
- `createAppointmentFromSource(appointmentRequest)` ‚Üí returns AppointmentRef or error payload including conflicts.

### Error handling expectations
- Validation errors: map field errors to inputs (scheduledStartDateTime, overrideReason, durationMinutes).
- Permission errors: show blocking banner; do not retry.
- Concurrency/duplicate link: show error with action to open existing appointment if appointmentId returned.
- Service unavailable (WorkExec/People): show degraded warning if backend returns partial data; still allow create if backend allows.

---

## 10. State Model & Transitions

### Allowed states (display-only)
- `appointmentStatus`: (TBD by backend; display as returned)
- `assignmentStatus`: e.g., `ASSIGNED`, `DEFERRED`, `AWAITING_SKILL_FULFILLMENT` (display as returned)

### Role-based transitions (frontend)
- Scheduler with `CREATE_APPOINTMENT` can submit create.
- Override path requires `OVERRIDE_SCHEDULING_CONFLICT`.
- Duration override beyond threshold requires `APPROVE_DURATION_OVERRIDE` (if UI supports duration edit).

### UI behavior per state
- If returned `assignmentStatus=AWAITING_SKILL_FULFILLMENT`, show prominent banner: ‚ÄúAppointment created but requires skill resolution.‚Äù
- If `assignedBay` null, indicate ‚ÄúBay assignment deferred.‚Äù

---

## 11. Alternate / Error Flows

- **Ineligible source**
  - Show reasons and disable submit
  - Provide link back to source
- **Conflicts present**
  - Soft: allow proceed; show warnings
  - Hard non-overridable: block submit; show alternatives if available
  - Hard overridable: require permission + reason
- **Concurrent link created by another user**
  - Create returns duplicate/link error; show existing appointment link if provided
- **Unauthorized**
  - On load or submit, show access denied; do not render sensitive data
- **Empty states**
  - No suggested alternatives: show ‚ÄúNo alternatives available; adjust date/time.‚Äù

---

## 12. Acceptance Criteria

### Scenario 1: Create appointment from eligible estimate with no conflicts
Given I am a Scheduler with `CREATE_APPOINTMENT` in facility F  
And I open ‚ÄúCreate Appointment‚Äù from an estimate in an eligible status  
When I select a scheduled start date/time  
And I run conflict check  
And no conflicts are returned  
And I submit create  
Then an appointment is created  
And the response includes an appointmentId and immutable link to the estimate  
And I see a success confirmation  
And I am navigated to the appointment detail screen.

### Scenario 2: Soft conflicts are shown but allow creation
Given I am a Scheduler with `CREATE_APPOINTMENT`  
And conflict check returns one or more SOFT conflicts  
When I review the conflict list  
And I submit create without override permission  
Then the appointment is created successfully  
And the conflicts are recorded by backend (implied)  
And the UI displays that conflicts existed (warning banner) and shows the appointment detail.

### Scenario 3: Hard conflict blocks creation without override
Given I am a Scheduler with `CREATE_APPOINTMENT` but without `OVERRIDE_SCHEDULING_CONFLICT`  
And conflict check returns a HARD conflict marked non-overridable  
When I attempt to submit create  
Then the UI blocks submission  
And I see the hard conflict details and any suggested alternatives.

### Scenario 4: Hard conflict can be overridden with permission and reason
Given I am a Scheduler with `CREATE_APPOINTMENT` and `OVERRIDE_SCHEDULING_CONFLICT`  
And conflict check returns a HARD conflict marked overridable  
When I choose to override  
And I provide an override reason  
And I submit create  
Then the appointment is created  
And I see confirmation that an override was applied (based on backend response).

### Scenario 5: Source already linked to active appointment
Given I open ‚ÄúCreate Appointment‚Äù from a source already linked to an active appointment  
When the create screen loads (or when I attempt to create)  
Then I see a blocking message indicating the source is already linked  
And I am provided a link to view the existing appointment if appointmentId is available.

---

## 13. Audit & Observability
- UI must display (when returned by backend):
  - createdBy/createdAt (if present in response)
  - override flag and override reason summary (if present)
- Frontend observability:
  - Log screen entry with sourceType/sourceId (no PII)
  - Log conflict check outcome counts (hard/soft) (no PII)
  - Log create success/failure with appointmentId when available
  - Propagate correlation/request IDs if the frontend framework supports it (TBD by repo conventions)

---

## 14. Non-Functional UI Requirements
- **Performance:** initial load and conflict check should feel responsive; avoid repeated polling.
- **Accessibility:** all form fields labeled; conflict list readable by screen readers; focus moves to first error on submit failure.
- **Responsiveness:** usable on tablet widths common in shops.
- **i18n/timezone:** datetimes displayed in facility/local timezone; ensure ISO submission to backend (timezone handling must match backend expectations‚ÄîTBD).
- **Security:** do not expose mechanic/customer PII in logs; enforce permission-gated rendering.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-01: Provide empty-state copy when no conflicts/suggestions are returned; qualifies as UI ergonomics; impacts UX Summary, Error Flows.
- SD-UX-ERRORMAP-01: Standard mapping of backend validation errors to field-level messages and top banner for non-field errors; qualifies as standard error-handling; impacts Service Contracts, Error Flows.
- SD-OBS-BOILER-01: Emit basic frontend logs/events for screen load, conflict check, and create submit with correlation ID (no PII); qualifies as observability boilerplate; impacts Audit & Observability.

---

## 16. Open Questions
1. What are the **exact Moqui screen route conventions** in this repo for Estimate Detail, Work Order Detail, Appointment Create, and Appointment Detail (screen paths and parameter names)?
2. What are the **actual backend endpoints/service names** for:
   - load defaults/eligibility
   - conflict check
   - create appointment  
   (Need request/response schemas and error code shapes for implementation.)
3. Is **conflict checking required as a separate call** before create, or is it embedded in create (returning conflicts and requiring a second ‚Äúconfirm override‚Äù submit)?
4. Is `durationMinutes` **editable in the UI**? If yes:
   - what is the allowed override range for Scheduler without approval?
   - what permission gates the wider override?
   - is override reason mandatory for any duration change?
5. Are `requiredSkills`, `bayTypeRequired`, and `isMobile` **editable** at create time, or strictly derived from source/service catalog?
6. What are the **exact eligible statuses** for estimates and work orders (enum values) that frontend should display and interpret?
7. Should frontend generate and send a **clientRequestId/idempotency key** for create to prevent duplicate appointments on retries? If yes, what header/field name?
8. How should facility **operating hours** be surfaced in UI when backend blocks scheduling outside hours (message only vs show hours + next available)?
9. What fields are returned in AppointmentRef needed for the confirmation screen (appointment number, scheduled time display, assignment summary)?

---

## Original Story (Unmodified ‚Äì For Traceability)

Title: [FRONTEND] [STORY] Appointment: Create Appointment from Estimate or Order  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/76  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Appointment: Create Appointment from Estimate or Order

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Scheduler**, I want to create an appointment from an estimate/order so that the work is scheduled and resources assigned.

## Details
- Appointment includes preferred times, service duration, skill tags, bay/mobile requirements.
- Linked to estimate/workorder if applicable.

## Acceptance Criteria
- Appointment created with confirmation.
- Linked refs stored.
- Conflicts surfaced.

## Integrations
- Shopmgr appointment create API; workexec duration hints (optional).

## Data / Entities
- AppointmentRequest, AppointmentRef, ConflictResult

## Classification (confirm labels)
- Type: Story
- Layer: Experience
- domain :  Point of Sale

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

