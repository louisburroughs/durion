â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DOMAIN: crm
Total Stories: 16
Generated: dim. 18 janv. 2026 12:03:02 EST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #156: [FRONTEND] [STORY] Integration: Inbound Event Handler for Workorder-Originated Updates  
File: ./scripts/story-work/frontend/156/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] CRM Integration Admin UI: View & Triage Inbound Workorder-Originated Events (Processing Log + Suspense/DLQ)

### Primary Persona
- **Integration Support Engineer / Admin User** (human operator using the POS frontend)
- Secondary: **Data/Integration Engineer** (uses UI for debugging & validation during rollout)

### Business Value
Provide an operator-facing way to **monitor, audit, and triage inbound Workorder Execution events** processed by CRM so that failures (schema violations, missing entities, retries exhausted) can be detected, diagnosed, and re-driven without direct database access.

---

## 2. Story Intent

### As a / I want / So that
- **As an Integration Support Engineer**, I want to **view inbound event processing status and inspect failed events routed to suspense/DLQ**, so that **I can resolve integration issues quickly and keep CRM data current**.

### In-Scope
- Moqui/Quasar frontend screens to:
  - List and view **ProcessingLog** records.
  - List and view **Suspense/DLQ** items (failed/unprocessable events).
  - Display **traceability** (eventId, correlationId/workorder reference, type/version/source, timestamps, status, failure reason/notes).
- Filtering and search for operational triage (by status/type/date range/correlationId/eventId).
- Role-gated access to integration monitoring screens.
- Standard error handling and empty states.

### Out-of-Scope
- Implementing the actual event consumer/handler (backend processing).
- Defining or changing event schemas for `VehicleUpdated`, `ContactPreferenceUpdated`, `PartyNoteAdded`.
- Remediation actions that mutate backend state (e.g., â€œreplay eventâ€, â€œacknowledgeâ€, â€œreprocessâ€, â€œdelete from DLQâ€) **unless clarified**.
- Customer data CRUD driven by events (vehicle/contact/note updates themselves are backend responsibility).

---

## 3. Actors & Stakeholders

### Actors
- **Integration Support Engineer (Admin UI user)**: monitors processing and triages failures.
- **Service Advisor (indirect stakeholder)**: benefits from up-to-date CRM data.
- **Moqui Frontend App**: calls Moqui services/screens to fetch logs and suspense items.
- **Moqui Backend Services**: expose view/query APIs for logs and suspense queue.

### Stakeholders
- **CRM Domain Owner / Integration Engineer**: defines what is visible, what actions are permitted, and data retention/redaction.
- **Security/Compliance**: ensures no sensitive payloads/PII are exposed improperly in UI.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend application.
- User has required permission (see Open Questions on exact permission name/role mapping).

### Dependencies (Blocking if unavailable)
- Backend provides read access to:
  - `ProcessingLog` (query + detail)
  - `SuspenseQueue` / DLQ items (query + detail)
- Backend defines what fields are safe to expose in UI (payload visibility/redaction rules).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Left-nav / Admin menu (or Integration menu) entry:
  - `Integration â†’ Inbound Events` (name TBD)

### Screens to create/modify
Create new Moqui screens (names are implementation suggestions; adjust to repo conventions):
1. **`apps/pos/screen/integration/InboundEventList.xml`**
   - Tabs or subviews:
     - â€œProcessing Logsâ€
     - â€œSuspense / DLQâ€
2. **`apps/pos/screen/integration/ProcessingLogDetail.xml`**
3. **`apps/pos/screen/integration/SuspenseEventDetail.xml`**

### Navigation context
- From `InboundEventList`:
  - Click a row â†’ navigate to detail screen with `eventId` (and/or suspense item id).
- Detail screen includes â€œBack to listâ€ preserving filters (via query params).

### User workflows
#### Happy path: triage by status/type
1. User opens `Integration â†’ Inbound Events`.
2. Defaults to Processing Logs tab.
3. User filters to `status=FAILURE` or `status=SKIPPED_DUPLICATE` and a date range.
4. User opens a specific event detail.
5. User copies `eventId`/`correlationId` for troubleshooting.

#### Alternate path: suspense queue investigation
1. User opens Suspense/DLQ tab.
2. User filters by failure reason (schema vs business rule vs retries exhausted).
3. Opens item detail to view envelope metadata and (if allowed) payload excerpt.

---

## 6. Functional Behavior

### Triggers
- Screen load triggers read/query calls to backend services/entities.
- User filter changes trigger re-query.

### UI actions
- **List views**
  - Sort by processed timestamp (ProcessingLog) or received timestamp (Suspense) descending by default.
  - Filter controls:
    - eventType (enum)
    - status (ProcessingLog enum)
    - correlationId (text exact/containsâ€”see Open Questions)
    - eventId (exact)
    - date range (start/end)
- **Detail views**
  - Read-only display of fields.
  - Copy-to-clipboard for `eventId`, `correlationId`.
  - (Optional) show raw JSON payload in a collapsible block **if allowed**.

### State changes
- Frontend does not change processing state in this story (read-only) unless clarified.

### Service interactions
- Calls to backend to query and retrieve details (see Service Contracts).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Filter validation:
  - Date range: end date must be â‰¥ start date; show inline validation message.
  - UUID fields: if user enters `eventId`, must be UUID format; otherwise show â€œInvalid eventId formatâ€.

### Enable/disable rules
- â€œView Detailâ€ action enabled only when row has required identifier (e.g., `eventId`).
- If backend indicates user unauthorized (403), screen shows access-denied state and does not display data.

### Visibility rules
- Payload visibility:
  - Payload display area must be hidden or redacted unless backend explicitly returns a safe-to-display field (see Open Questions).
- Notes/error details:
  - Display `notes` and failure reason, but do not render stack traces unless backend returns a sanitized message.

### Error messaging expectations
- Query failures show non-technical error banner:
  - â€œUnable to load inbound event logs. Try again.â€
- Detail not found (404) shows:
  - â€œThis event record no longer exists or you donâ€™t have access.â€

---

## 8. Data Requirements

> Note: Entities are referenced from the story inputs; actual Moqui entity names/fields must match backend implementation. If entities differ, map them in service layer.

### Entities involved
- `ProcessingLog` (internal log of event processing)
- `EventEnvelope` (inbound event metadata; may be embedded in SuspenseQueue item)
- `SuspenseQueue` (DLQ/suspense items for failed events)

### Fields (type, required, defaults)

#### ProcessingLog (list + detail)
- `eventId` (UUID, required, primary key)
- `correlationId` (String, required) â€” â€œworkorder referenceâ€
- `status` (Enum String, required): `SUCCESS | FAILURE | SKIPPED_DUPLICATE`
- `processedTimestamp` (Datetime, required)
- `eventType` (String/Enum, **required?**) *(not explicitly in ProcessingLog spec; may come from envelopeâ€”Open Question)*
- `notes` (String, optional)

#### SuspenseQueue item (list + detail)
Minimum required for triage (exact fields TBD by backend):
- `suspenseId` (UUID or String, required) â€” unique ID for suspense record
- `eventId` (UUID, required)
- `eventType` (Enum String, required)
- `eventVersion` (String, required)
- `sourceSystem` (String, required; expected â€œWorkorderExecutionâ€)
- `correlationId` (String, required)
- `timestamp` (Datetime, required) â€” when event generated
- `failureReason` (String, required) â€” e.g., â€œSchema Validation Failedâ€, â€œEntity Not Foundâ€, â€œProcessing Failed After Retriesâ€
- `payload` (JSON, optional / restricted)
- `routedTimestamp` (Datetime, optional) â€” when moved to suspense/DLQ

### Read-only vs editable by state/role
- All fields are **read-only** in this story.

### Derived/calculated fields
- `age` (derived): â€œtime since processed/routedâ€ (optional UI convenience). If implemented, derived purely in UI from timestamps.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui can query entities directly via screens, but for security and payload redaction, prefer service endpoints that enforce RBAC and return safe DTOs.

### Load/view calls

#### Processing logs list
- **Service**: `crm.integration.ProcessingLogFind` (name TBD)
- **Inputs**:
  - `eventId` (optional exact)
  - `correlationId` (optional)
  - `status` (optional enum)
  - `eventType` (optional) *(if available)*
  - `fromTs`, `thruTs` (optional)
  - `pageIndex`, `pageSize` (optional)
  - `orderByField` (default `processedTimestamp DESC`)
- **Outputs**:
  - `results[]` with fields listed in Data Requirements
  - `totalCount`

#### Processing log detail
- **Service**: `crm.integration.ProcessingLogGet`
- **Inputs**: `eventId` (required)
- **Outputs**: ProcessingLog detail DTO

#### Suspense/DLQ list
- **Service**: `crm.integration.SuspenseEventFind`
- **Inputs**: similar filters (eventType, correlationId, eventId, reason, date range, paging)
- **Outputs**: list DTO + totalCount

#### Suspense/DLQ detail
- **Service**: `crm.integration.SuspenseEventGet`
- **Inputs**: `suspenseId` (required) OR `eventId` (if suspense keyed by eventIdâ€”Open Question)
- **Outputs**:
  - envelope metadata
  - sanitized error details
  - payload (optional/redacted)

### Create/update calls
- none (read-only story)

### Submit/transition calls
- none (unless â€œreprocessâ€/â€œackâ€ is later clarified)

### Error handling expectations
- `401`: redirect to login (project standard).
- `403`: show access denied.
- `404`: show not found on detail view.
- `400`: show validation message (filters).
- `5xx`/network: show retry affordance (â€œRetryâ€ button).

---

## 10. State Model & Transitions

### Allowed states
#### ProcessingLog.status
- `SUCCESS`
- `FAILURE`
- `SKIPPED_DUPLICATE`

#### SuspenseQueue â€œstateâ€
- Not explicitly defined. UI treats items as â€œin suspenseâ€ records with a failure reason and timestamps.

### Role-based transitions
- None in this story (read-only).

### UI behavior per state
- ProcessingLog list:
  - `SUCCESS`: neutral styling
  - `FAILURE`: highlighted; encourages click-through
  - `SKIPPED_DUPLICATE`: informational
- Suspense list:
  - Always treated as requiring attention; filter by `failureReason`.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Invalid UUID in `eventId` filter â†’ prevent query; show inline error.
- Invalid date range â†’ prevent query; show inline error.

### Concurrency conflicts
- If a record disappears between list and detail:
  - detail service returns 404 â†’ show â€œRecord not foundâ€ and link back.

### Unauthorized access
- If user lacks scope/role:
  - list screens render access denied; no partial data shown.

### Empty states
- No results for filters:
  - Show empty state with suggestion to broaden filters and a â€œClear filtersâ€ action.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View processing logs with filtering
**Given** I am logged in as a user with permission to view inbound event monitoring  
**When** I navigate to `Integration â†’ Inbound Events` and open the â€œProcessing Logsâ€ view  
**Then** I see a paginated list of processing log records including `eventId`, `correlationId`, `status`, and `processedTimestamp`  
**And** I can filter the list by `status` and date range  
**And** the results update to match my filters

### Scenario 2: View processing log detail
**Given** I am viewing the â€œProcessing Logsâ€ list  
**When** I select a log record  
**Then** I am taken to a detail view showing `eventId`, `correlationId`, `status`, `processedTimestamp`, and `notes`  
**And** I can copy `eventId` and `correlationId`

### Scenario 3: View suspense/DLQ list and detail
**Given** I am logged in as a user with permission to view inbound event monitoring  
**When** I open the â€œSuspense / DLQâ€ view  
**Then** I see a paginated list of suspense items including `eventId`, `eventType`, `correlationId`, and `failureReason`  
**When** I open a suspense item  
**Then** I see the event envelope metadata and the failure reason/details  
**And** I see payload content only if the backend provides an allowed/sanitized payload field

### Scenario 4: Client-side validation prevents invalid queries
**Given** I am on the inbound event list screen  
**When** I enter an invalid `eventId` value that is not a UUID and attempt to apply filters  
**Then** the UI shows an inline validation error  
**And** no backend query is executed

### Scenario 5: Unauthorized user cannot access monitoring
**Given** I am logged in as a user without permission to view inbound event monitoring  
**When** I navigate to `Integration â†’ Inbound Events`  
**Then** I see an access denied message  
**And** no processing logs or suspense items are displayed

### Scenario 6: Detail record not found
**Given** I navigate directly to a processing log detail URL with an `eventId` that does not exist  
**When** the screen loads  
**Then** I see a â€œnot foundâ€ message  
**And** a link to return to the list view

---

## 13. Audit & Observability

### User-visible audit data
- Display fields that support traceability:
  - `eventId`
  - `correlationId` (workorder reference)
  - `sourceSystem`
  - timestamps (`timestamp`, `processedTimestamp`, `routedTimestamp`)
  - processing status / failure reason

### Status history
- Not defined in inputs. If backend provides multiple attempts/retry history, UI may show a read-only â€œAttemptsâ€ table (Open Question).

### Traceability expectations
- The UI must prominently display `eventId` and `correlationId` to correlate with backend logs/metrics.

---

## 14. Non-Functional UI Requirements

- **Performance**: list queries should return within 2s for typical page sizes (e.g., 25â€“50) assuming indexed fields; UI must paginate (no unbounded loads).
- **Accessibility**: keyboard navigable filters and table rows; proper labels on inputs; sufficient contrast for status indicators.
- **Responsiveness**: usable on tablet widths; tables may switch to stacked rows on small screens.
- **i18n/timezone**: timestamps displayed in userâ€™s locale/timezone (project standard); raw ISO may be shown in tooltip if needed.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide consistent empty-state messaging and â€œClear filtersâ€ action; safe because it doesnâ€™t change domain behavior and only affects UI ergonomics. (Sections: UX Summary, Alternate / Error Flows)
- SD-UX-PAGINATION: Default page size 25 with server-side paging; safe because it is standard UI behavior and avoids unbounded queries. (Sections: UX Summary, Service Contracts, Non-Functional)
- SD-ERR-STANDARD: Map HTTP 401/403/404/5xx to standard UI states; safe because it is generic error-handling without altering business policy. (Sections: Business Rules, Service Contracts, Error Flows)

---

## 16. Open Questions

1. **Backend contract for frontend**: What are the exact Moqui services (or entity views) to query `ProcessingLog` and `SuspenseQueue`? Please provide service names, required parameters, and returned fields.
2. **Suspense/DLQ identity**: Is the suspense record addressed by `eventId` or by a separate `suspenseId`/messageId?
3. **Payload visibility/redaction**: Can the frontend display raw `payload` JSON? If yes, what redaction rules apply (PII, secrets), and is there a safe â€œpayloadSummaryâ€ field instead?
4. **Permissions/RBAC**: What role(s) or permission key(s) gate access to these screens (e.g., `crm.integration.monitor.read`)? Are there environment-based restrictions (prod vs non-prod)?
5. **Filter semantics**: Should `correlationId` filtering be exact match only, prefix match, or contains? (Impacts performance and indexing.)
6. **Retry/attempt details**: Should the UI expose retry count / last error / next retry timestamp (if available), or only final status?
7. **Operator actions** (explicitly out-of-scope unless confirmed): Should the UI support â€œreprocess/retryâ€, â€œacknowledgeâ€, â€œexportâ€, or â€œmark resolvedâ€? If yes, define allowed actions and audit requirements.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Integration: Inbound Event Handler for Workorder-Originated Updates  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/156  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Integration: Inbound Event Handler for Workorder-Originated Updates

**Domain**: user

### Story Description

/kiro  
# User Story

## Narrative  
As a **CRM System**, I want **to ingest workorder events that update CRM data** so that **CRM stays current based on operational reality**.

## Details  
- Handle: VehicleUpdated, ContactPreferenceUpdated, PartyNoteAdded.  
- Validate event envelope; idempotent processing; route failures to suspense queue.

## Acceptance Criteria  
- Events processed once.  
- Invalid events routed to suspense/dead-letter.  
- Audit includes source workorder reference.

## Integration Points (Workorder Execution)  
- Workorder Execution emits events via Positivity service layer; CRM consumes and applies changes.

## Data / Entities  
- EventEnvelope  
- ProcessingLog  
- SuspenseQueue

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: CRM

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #158: [FRONTEND] [STORY] Promotions: Record Promotion Redemption from Invoicing  
File: ./scripts/story-work/frontend/158/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Promotions: View Promotion Redemption Records (from Invoice Finalization)

**Primary Persona:** Customer Service Representative (CSR) / Marketing Manager (read-only)

**Business Value:** Provide UI visibility into promotion redemption activity recorded by CRM so staff can support customers, audit usage, and detect potential abuse without querying databases or logs.

---

## 2. Story Intent

### As a / I want / So that
- **As a** CSR or Marketing Manager  
- **I want** to view promotion redemption records associated to a promotion and filter them by work order/invoice/customer/time  
- **So that** I can confirm whether a promotion was redeemed, by whom, and on which invoice/work order, and spot duplicates/abuse patterns.

### In-scope
- Moqui UI screens to **search/list** promotion redemptions.
- A **detail view** of a single redemption record.
- Filters for common identifiers: `promotionId`, `workOrderId`, `invoiceId`, `customerId`, date range.
- Read-only display of relevant redemption fields and any processing/idempotency indicators that are persisted.
- Authorization gating (frontend enforcement + backend error handling display).

### Out-of-scope
- Consuming the `PromotionRedeemed` event (backend responsibility).
- Editing/redacting redemption records.
- Enforcing usage limits at invoice finalization (policy/ownership is unclear; see Open Questions).
- Creating promotions or configuring limits.

---

## 3. Actors & Stakeholders
- **CSR (primary user):** Verifies redemption presence for customer support.
- **Marketing Manager (stakeholder):** Reviews usage/efficacy and identifies suspicious patterns.
- **System (CRM backend):** Source of truth for redemption records.
- **Workorder Execution domain (external):** Emits redemption events; referenced identifiers appear in UI for cross-system support.

---

## 4. Preconditions & Dependencies
- User is authenticated in the frontend.
- User has required permission to view promotion/redemption data (exact permission name TBD; see Open Questions).
- CRM backend exposes **read APIs** (or Moqui services) to list and retrieve redemption records. If not available, this story is blocked.
- Redemption records exist (or empty-state UI is shown).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Promotions area (TBD route): â€œPromotion Redemptionsâ€ list.
- From a Promotion detail screen (if exists): â€œView redemptions for this promotionâ€.

### Screens to create/modify
1. **Screen:** `apps/pos/screen/crm/promotions/PromotionRedemptions.xml` (list/search)
2. **Screen:** `apps/pos/screen/crm/promotions/PromotionRedemptionDetail.xml` (detail)
3. **Optional integration point:** add navigation link from existing Promotions screen (if present in repo).

### Navigation context
- Breadcrumb: CRM â†’ Promotions â†’ Redemptions
- Support direct deep-links:
  - `/crm/promotions/redemptions` (list)
  - `/crm/promotions/redemptions/:promotionRedemptionId` (detail)
  - `/crm/promotions/:promotionId/redemptions` (filtered list shortcut)

### User workflows
- **Happy path (list):**
  1. User opens Redemptions list.
  2. Applies filters (e.g., promotionId + date range).
  3. Views paginated results; selects a row.
  4. Navigates to Detail screen.
- **Alternate paths:**
  - Deep-link with `workOrderId` or `invoiceId` query param pre-fills filters.
  - No results â†’ show empty state with guidance to adjust filters.
  - Backend returns 403 â†’ show â€œNot authorizedâ€ state.
  - Backend unavailable â†’ show retry.

---

## 6. Functional Behavior

### Triggers
- Enter list screen: load initial list (either empty until filter applied, or last-used filters; see Safe Defaults).
- Change filter / submit search: reload list.
- Enter detail screen: load redemption record by ID.

### UI actions
- Search form submit.
- Clear filters.
- Click row â†’ open detail.
- Copy-to-clipboard for IDs (optional but helpful; if not supported by existing component patterns, omit).

### State changes
- Frontend-only view state: loading, loaded, empty, error.
- No domain state mutations (read-only).

### Service interactions
- Call backend to:
  - List redemptions with filters + pagination + sort.
  - Fetch a single redemption by `promotionRedemptionId`.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Filter inputs:
  - `promotionId`, `workOrderId`, `invoiceId`, `customerId`, `promotionRedemptionId`: non-empty string; trim whitespace.
  - Date range: `from <= to`; show inline error if invalid.
- Do **not** validate or infer idempotency logic in UI; only display what backend persists.

### Enable/disable rules
- Search button disabled while request in-flight.
- Clear filters enabled when any filter has a value.

### Visibility rules
- Columns/fields shown only if present in response (to avoid implying missing backend fields).
- If backend provides a â€œduplicate/processing statusâ€ indicator, render it; otherwise omit.

### Error messaging expectations
- 400 validation error: show message â€œInvalid filterâ€ plus backend-provided detail.
- 403: â€œYou donâ€™t have permission to view promotion redemptions.â€
- 404 on detail: â€œRedemption not found.â€
- 500/network: generic failure with retry.

---

## 8. Data Requirements

> Note: Backend story references multiple entities (`PromotionUsage`, `RedemptionEvent`, `ProcessingLog`) but the backend reference content primarily defines `PromotionRedemption`. Frontend must not invent fields; it should bind to the API schema once confirmed.

### Entities involved (frontend read models)
- `PromotionRedemption` (primary)
- `Promotion` (optional: for context display if list is filtered by promotionId; only if API returns it)
- Optional processing/idempotency read model if available:
  - `ProcessingLog` or a `dedupeKey/eventId` field

### Fields to display (minimum viable)
For each redemption record:
- `promotionRedemptionId` (string/UUID, required, read-only)
- `promotionId` (string/UUID, required, read-only)
- `customerId` (string/UUID, optional/nullable per backend; read-only)
- `workOrderId` (string/UUID or external ID, required, read-only)
- `invoiceId` (string/UUID or external ID, optional/nullable; read-only)
- `redemptionTimestamp` (datetime, optional/nullable; read-only)
- `createdAt` (datetime, optional/nullable; read-only)

### Derived/calculated fields
- None (do not calculate counters/limits on frontend).

---

## 9. Service Contracts (Frontend Perspective)

> Moqui frontend typically interacts via Moqui screens/actions/services. Exact service names/endpoints are not provided in inputs, so these are **placeholders** that must be confirmed.

### Load/view calls
1. **List redemptions**
   - **Service (proposed):** `crm.promotionRedemption.search`
   - **Inputs:**
     - `promotionId?`, `customerId?`, `workOrderId?`, `invoiceId?`
     - `fromDate?`, `toDate?` (ISO-8601)
     - `pageIndex` (0-based) / `pageSize`
     - `orderBy` default `-redemptionTimestamp` or `-createdAt` (TBD)
   - **Outputs:**
     - `items[]` (PromotionRedemption)
     - `totalCount`

2. **Get redemption detail**
   - **Service (proposed):** `crm.promotionRedemption.get`
   - **Inputs:** `promotionRedemptionId` (required)
   - **Outputs:** `item` (PromotionRedemption)

### Create/update calls
- None (read-only story).

### Submit/transition calls
- None.

### Error handling expectations
- Standard mapping:
  - 400 â†’ field-level error when possible, else banner.
  - 403/401 â†’ route to auth/forbidden screen per app conventions.
  - 404 â†’ not found state on detail.
  - 409 â†’ display conflict (unlikely for read; handle generically).

---

## 10. State Model & Transitions

### Allowed states
- UI view states: `idle`, `loading`, `loaded`, `empty`, `error`.

### Role-based transitions
- If unauthorized:
  - list/detail screens transition to `error(forbidden)` and must not display any partial data.

### UI behavior per state
- `loading`: show skeleton/spinner, disable search controls that would create duplicate requests.
- `empty`: show â€œNo redemptions foundâ€ + suggestion to broaden filters.
- `error`: show retry; preserve filter values.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- User selects `fromDate > toDate`:
  - Prevent search; show inline error at date range controls.

### Backend validation failures (server-side 400)
- Backend rejects filter combination:
  - Show banner with backend message; keep form state.

### Concurrency conflicts
- Not applicable for read-only; still handle stale detail:
  - If detail record deleted between list and click â†’ detail returns 404; show not-found state.

### Unauthorized access
- 401: redirect to login (per app convention).
- 403: show forbidden message; do not retry automatically.

### Empty states
- No matching redemptions: empty table/list state, not an error.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View list of redemptions filtered by promotionId
**Given** I am authenticated and authorized to view promotion redemptions  
**When** I navigate to the Promotion Redemptions list screen  
**And** I enter a valid `promotionId` filter and submit search  
**Then** the system requests redemption records from the backend using the provided filter  
**And** I see a paginated list of matching redemption records including `promotionRedemptionId`, `promotionId`, `workOrderId`, and `invoiceId` (if present)

### Scenario 2: No results returns empty state
**Given** I am authenticated and authorized to view promotion redemptions  
**When** I search with filters that match no redemption records  
**Then** I see an empty-state message indicating no results  
**And** no error banner is shown

### Scenario 3: View redemption detail
**Given** I am viewing the Promotion Redemptions list with at least one result  
**When** I select a redemption record  
**Then** I navigate to the redemption detail screen  
**And** the system loads the redemption by `promotionRedemptionId`  
**And** I see read-only fields for `promotionId`, `workOrderId`, `invoiceId` (if present), and timestamps (if present)

### Scenario 4: Unauthorized access is blocked
**Given** I am authenticated but not authorized to view promotion redemptions  
**When** I navigate to the Promotion Redemptions list screen  
**Then** the backend returns 403 Forbidden  
**And** the UI displays a not-authorized message  
**And** no redemption data is displayed

### Scenario 5: Invalid date range prevented client-side
**Given** I am on the Promotion Redemptions list screen  
**When** I set `fromDate` later than `toDate`  
**And** I attempt to submit search  
**Then** the UI blocks the request  
**And** I see an inline validation message indicating the date range is invalid

---

## 13. Audit & Observability

### User-visible audit data
- Display (if provided by backend): `createdAt` and `redemptionTimestamp`.
- Display identifiers needed for traceability: `promotionId`, `workOrderId`, `invoiceId`, `customerId`.

### Status history
- Not applicable unless backend returns processing status/attempts; if such fields exist, render them as read-only in detail.

### Traceability expectations
- Each backend call should include correlation ID headers if thatâ€™s a project convention (TBD). Frontend should log (non-PII) failures with request context (screen, filters excluding PII).

---

## 14. Non-Functional UI Requirements
- **Performance:** List screen should support pagination; avoid loading unbounded results.
- **Accessibility:** All form controls labeled; table supports keyboard navigation; error messages announced (Quasar accessibility patterns).
- **Responsiveness:** Works on tablet width; filters collapse/stack vertically.
- **i18n/timezone:** Render timestamps in user locale/timezone if app supports it; otherwise ISO display (needs confirmation). Currency not applicable.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a standard empty-results state with guidance; safe as UI-only ergonomics; impacts UX Summary, Error Flows, Acceptance Criteria.
- SD-UX-PAGINATION: Paginate list results with configurable page size; safe as it does not alter domain logic; impacts UX Summary, Service Contracts, Non-Functional.
- SD-ERR-STD-MAPPING: Map HTTP 400/401/403/404/500 to standard banners/states; safe because it follows backend signals; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Frontend scope confirmation:** This story is primarily backend/event-driven. What exact frontend user experience is expectedâ€”(A) a read-only redemption viewer (as specified above), (B) a promotion detail enhancement showing redemption count/history, or (C) no UI at all (purely backend)?  
2. **API/service contract:** What are the actual Moqui service names or REST endpoints for listing and retrieving `PromotionRedemption` records (including pagination, sorting, and filter parameters)?  
3. **Authorization model:** What permission/role(s) are required to view promotion redemptions in the POS frontend (e.g., `crm.promotions.read`, `crm.redemptions.read`), and should Marketing vs CSR have different access?  
4. **Data model alignment:** Which entity is the canonical read model exposed to the frontend: `PromotionRedemption` only, or also `PromotionUsage`, `RedemptionEvent`, `ProcessingLog`? What fields from these are available/required in UI?  
5. **Usage limits enforcement visibility:** Acceptance criteria mention â€œUsage limits enforced when configured.â€ Should the frontend display any â€œlimit reachedâ€ indicators for a promotion, and if yes, what is the backend-provided field/source (CRM vs Workorder Execution)?  
6. **Identifier formats:** Are `workOrderId` and `invoiceId` UUIDs generated within this system, or external human-readable references? This affects validation and display formatting.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Promotions: Record Promotion Redemption from Invoicing  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/158  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Promotions: Record Promotion Redemption from Invoicing

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **System**, I want **to record when a promotion is redeemed against a finalized invoice/workorder** so that **we can track usage and prevent abuse**.

## Details
- On invoice finalization, Workorder Execution emits PromotionRedeemed.
- CRM records redemption once (idempotent) and updates counters.

## Acceptance Criteria
- Redemption recorded once.
- Usage limits enforced when configured.
- Redemption links to Workorder/Invoice reference.

## Integration Points (Workorder Execution)
- Workorder Execution emits PromotionRedeemed; CRM consumes and updates usage.

## Data / Entities
- PromotionUsage
- RedemptionEvent
- ProcessingLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #163: [FRONTEND] [STORY] Billing: Expose CRM Snapshot (Account + Contacts + Vehicles + Rules) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/163
File: ./scripts/story-work/frontend/163/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

# 1. Story Header

## Title
[FRONTEND] [STORY] CRM Snapshot Viewer: Fetch & Display CRM Snapshot (Account + Contacts + Vehicles + Preferences) via Moqui

## Primary Persona
Service Advisor / CSR (POS user) using the Durion frontend to view customer context quickly during estimate creation and refresh.

## Business Value
Provide a fast, consistent â€œsingle viewâ€ of customer/account, contacts, vehicles, and billing-relevant contactability/preferences to speed estimate creation and reduce errors from inconsistent customer context.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor / CSR  
- **I want** to retrieve and view a CRM-owned snapshot of account/person, contacts, vehicles, and billing-relevant preferences by **partyId and/or vehicleId**  
- **So that** estimate creation and customer context lookup are fast, consistent, and refreshable without navigating multiple screens.

## In-Scope
- A Moqui screen flow that:
  - Accepts `partyId` and/or `vehicleId` as inputs
  - Calls `GET /v1/crm-snapshot`
  - Displays snapshot metadata (version/timestamp), account summary, contacts (including primary), vehicles, and preferences
  - Handles error cases (400/403/404/500) with clear user messaging
  - Supports â€œrefresh snapshotâ€ action
- Frontend service integration (Moqui service call / REST call) consistent with project conventions.

## Out-of-Scope
- Editing CRM data (contacts, vehicles, preferences) from this UI
- Defining or changing CRM snapshot backend contract (this story consumes it)
- Workorder/estimate creation screens themselves (only provide a viewer/lookup to support them)
- Any deduplication/merge, customer lifecycle state changes

---

# 3. Actors & Stakeholders

- **Primary User:** Service Advisor / CSR (interactive UI user)
- **Downstream Consumer Context:** Workorder Execution (benefits from same snapshot contract)
- **System of Record / Provider:** CRM backend endpoint `GET /v1/crm-snapshot` (SoR for snapshot)
- **Stakeholders:** Billing (consumes billing-relevant preferences), CRM domain owners, POS frontend team, QA

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated into the POS frontend.
- Frontend has a valid server-side capability to call the CRM snapshot endpoint (either directly from Moqui server or via configured API gateway) with required credentials.
- Caller must be authorized per backend rules (allowlisted identity + scope `crm.snapshot.read`), but enforcement occurs server-side.

## Dependencies
- Backend endpoint exists and matches backend story contract:
  - `GET /v1/crm-snapshot?partyId={uuid}&vehicleId={uuid}`
  - At least one identifier required
  - Error codes and status codes as specified (notably `VEHICLE_HAS_NO_ACTIVE_PARTY` on 404)
- Project conventions for Moqui REST calls, screen routing, and Vue/Quasar embedding are assumed but not provided in this prompt (see Open Questions for any needed repo-specific details).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From an â€œEstimate Draftâ€ or â€œCustomer Lookupâ€ context: a navigation link/button labeled â€œCRM Snapshotâ€ that opens the snapshot viewer.
- Direct route access for debugging/support: user can open the snapshot viewer screen and input IDs manually.

## Screens to create/modify
- **Create:** `apps/pos/screen/crm/Snapshot.xml` (name indicative; final path must follow repo conventions)
  - Contains:
    - Input form: `partyId` (UUID), `vehicleId` (UUID)
    - Actions: `Load Snapshot`, `Refresh`
    - Display sections: Snapshot Metadata, Account, Contacts, Vehicles, Preferences
- **Modify (optional):** Navigation/menu screen to add link into CRM/Customer tools area (only if such menu exists in repo conventions).

## Navigation context
- URL route pattern suggestion (to be aligned to repo conventions):
  - `/crm/snapshot` (manual input)
  - `/crm/snapshot?partyId=...`
  - `/crm/snapshot?vehicleId=...`
- If entered with query params, screen should auto-load snapshot.

## User workflows
### Happy path (partyId)
1. User opens snapshot viewer (possibly pre-populated with `partyId`).
2. Clicks **Load Snapshot** (or auto-load occurs).
3. UI shows snapshot content and metadata.

### Happy path (vehicleId only)
1. User enters `vehicleId`, clicks **Load Snapshot**.
2. UI shows resolved primary party snapshot (no need to show resolution rules; backend handles it).

### Alternate paths
- Missing both fields â†’ inline validation prevents submit.
- 404 not found / vehicle has no active party â†’ show specific message and keep input values for correction.
- 403 unauthorized â†’ show â€œNot authorizedâ€ message and guidance to contact admin.
- 500 unexpected â†’ show generic error + correlation ID if provided.

---

# 6. Functional Behavior

## Triggers
- Screen load with `partyId` and/or `vehicleId` query parameters present â†’ auto-trigger snapshot load once.
- User clicks `Load Snapshot` or `Refresh` â†’ trigger snapshot load.

## UI actions
- **Load Snapshot**
  - Validates at least one identifier is provided
  - Calls a Moqui service to perform the GET request (server-side recommended to avoid exposing service tokens)
- **Refresh**
  - Repeats load with same identifiers
  - Updates displayed snapshot and metadata version/timestamp
- **Clear**
  - Clears inputs and snapshot display (optional but allowed as UI ergonomics)

## State changes (frontend)
- `idle` â†’ `loading` â†’ `loaded` or `error`
- When new request is made, previous snapshot remains visible until replaced OR is cleared immediately (must be deterministic; see Business Rules section)

## Service interactions
- Invoke `GET /v1/crm-snapshot` with query params.
- Handle status codes:
  - `200`: render snapshot
  - `400`: show validation error (missing identifiers)
  - `403`: unauthorized
  - `404`: not found; if `errorCode=VEHICLE_HAS_NO_ACTIVE_PARTY` show specialized message
  - `500`: show generic failure; include correlation ID if present in payload/headers

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- **Rule:** At least one of `partyId` or `vehicleId` must be provided before issuing a request.
  - UI: block submit and show message: â€œEnter a Party ID or Vehicle ID to load a snapshot.â€
- **UUID format validation (UI-level):** If value is non-empty and not a UUID, show inline error and block submit.
  - Message examples:
    - â€œParty ID must be a valid UUID.â€
    - â€œVehicle ID must be a valid UUID.â€

## Enable/disable rules
- Disable `Load Snapshot` and `Refresh` while request is `loading`.
- Disable `Refresh` when there is no last successful load (no snapshot currently loaded).

## Visibility rules
- Snapshot display sections are visible only when a snapshot is loaded.
- Error banner visible only in `error` state.
- Show empty-state guidance when idle: â€œEnter Party ID and/or Vehicle ID to view CRM snapshot.â€

## Error messaging expectations
- 404 + `VEHICLE_HAS_NO_ACTIVE_PARTY`: â€œVehicle exists but has no active associated party. Associate an owner/driver in CRM.â€
- Generic 404: â€œNo snapshot found for the provided identifier(s).â€
- 403: â€œYou are not authorized to view CRM snapshots. Contact your administrator.â€
- 500: â€œUnable to load CRM snapshot due to a server error. Try again. If the issue persists, provide this correlation ID: {id}.â€

---

# 8. Data Requirements

## Entities involved (frontend perspective)
- **External DTO:** CRM Snapshot DTO returned by `GET /v1/crm-snapshot`
- **No local persistence** required; store in screen/view state only.

## Fields (type, required, defaults)

### Inputs
- `partyId`: string (UUID), optional
- `vehicleId`: string (UUID), optional

### Snapshot response (must render if present)
- `snapshotMetadata.snapshotId`: string (UUID), required for display if provided by backend
- `snapshotMetadata.createdAt`: string (ISO-8601 timestamp), required for display if provided
- `snapshotMetadata.version`: string, required for display if provided

- `account.partyId`: string (UUID), required
- `account.accountNumber`: string, optional
- `account.accountName`: string, required/expected
- `account.accountType`: enum `INDIVIDUAL | BUSINESS`, optional unless backend guarantees

- `contacts[]`:
  - `contactId`: UUID
  - `isPrimary`: boolean
  - `name`: string
  - `roles[]`: string array
  - `phoneNumbers[]`: objects `{ type, number }`
  - `emailAddresses[]`: objects `{ type, address }`
  - `preferences`: object with booleans/enums as in backend reference (render as read-only)

- `vehicles[]`:
  - `vehicleId`: UUID
  - `vin`: string
  - `licensePlate`: string nullable
  - `make/model/year`: optional

- `preferences` (account-level):
  - `marketingOptOut`: boolean
  - `doNotContact`: boolean
  - `invoiceDeliveryMethod`: enum `EMAIL | MAIL | NONE`

## Read-only vs editable
- All snapshot fields are **read-only** in this screen.

## Derived/calculated fields (UI-only)
- Display â€œPrimaryâ€ badge/indicator for `contacts[].isPrimary === true`.
- Format timestamps to user locale/timezone per app defaults (no business logic changes).

---

# 9. Service Contracts (Frontend Perspective)

> Note: Backend contract is authoritative from backend story #99. Frontend must not invent new fields.

## Load/view calls
- **Operation:** Load CRM snapshot
- **Method/URL:** `GET /v1/crm-snapshot`
- **Query params:**
  - `partyId` optional
  - `vehicleId` optional
- **Client rule:** must send at least one param.

## Create/update calls
- None (read-only UI).

## Submit/transition calls
- None.

## Error handling expectations
- `400 Bad Request`: treat as user-correctable (input problem). Show inline + banner message.
- `403 Forbidden`: treat as authorization failure; no retries; show banner message.
- `404 Not Found`: treat as user-correctable (wrong ID / no relationship). Show banner message; preserve inputs.
- `500 Internal Server Error`: allow retry; show correlation ID if returned.

---

# 10. State Model & Transitions

## Allowed states (screen/view model)
- `idle`: no request yet
- `loading`: request in progress
- `loaded`: snapshot present
- `error`: last request failed

## Role-based transitions
- No additional role-based UI transitions defined beyond backend authorization result (403).
- If the frontend has roles that gate access to the screen, that must be configured (see Open Questions).

## UI behavior per state
- `idle`: show input form + help text; no snapshot sections.
- `loading`: disable inputs/actions; show loading indicator; keep existing snapshot visible OR hide it consistently:
  - **Rule for determinism:** keep existing snapshot visible but visually indicate â€œRefreshingâ€¦â€ (prevents blanking UI).
- `loaded`: show snapshot sections and metadata; enable Refresh.
- `error`: show error banner; keep input values; if prior snapshot existed, it may remain visible but must be clearly marked as â€œstaleâ€ (optional; see Open Questions).

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- If both IDs empty â†’ do not call service; show inline message.
- If UUID format invalid â†’ do not call service; show inline message per field.

## Backend 400
- Show message: â€œRequest must include partyId or vehicleId.â€ (or backend-provided message).
- Keep user inputs.

## Backend 403
- Show not-authorized banner.
- Do not auto-retry.
- Provide guidance to contact administrator.

## Backend 404
- If payload indicates `errorCode=VEHICLE_HAS_NO_ACTIVE_PARTY` â†’ show specialized message.
- Else â†’ generic not-found.

## Backend 500 / network failure
- Show generic failure and retry option.

## Concurrency conflicts
- Not applicable (read-only). If backend uses ETag/version, frontend displays version only; no optimistic locking.

## Empty states
- If snapshot returns empty arrays (`contacts=[]`, `vehicles=[]`), render â€œNo contacts foundâ€ / â€œNo vehicles foundâ€ messages.

---

# 12. Acceptance Criteria

## Scenario 1: Load snapshot by partyId (success)
**Given** I am an authenticated POS user with access to the CRM snapshot viewer  
**And** I enter a valid `partyId` UUID  
**When** I click â€œLoad Snapshotâ€  
**Then** the app calls `GET /v1/crm-snapshot?partyId={partyId}`  
**And** I see account summary, contacts list, vehicles list, and preferences  
**And** I see snapshot metadata including `version` and `createdAt` (when provided)

## Scenario 2: Load snapshot by vehicleId only (success)
**Given** I am an authenticated POS user with access to the CRM snapshot viewer  
**And** I enter a valid `vehicleId` UUID  
**When** I click â€œLoad Snapshotâ€  
**Then** the app calls `GET /v1/crm-snapshot?vehicleId={vehicleId}`  
**And** I see a snapshot for the resolved primary party (as returned by backend)  
**And** the UI does not require me to select a party manually

## Scenario 3: Client-side validation blocks missing identifiers
**Given** I am on the CRM snapshot viewer  
**And** `partyId` is empty  
**And** `vehicleId` is empty  
**When** I click â€œLoad Snapshotâ€  
**Then** no network/service request is made  
**And** I see an inline validation message telling me to enter a Party ID or Vehicle ID

## Scenario 4: 404 vehicle has no active party relationship
**Given** I enter a valid `vehicleId` UUID that exists but has no active party relationship  
**When** I load the snapshot  
**Then** the UI shows an error message indicating the vehicle has no active associated party  
**And** the UI keeps the entered `vehicleId` so I can correct it

## Scenario 5: Unauthorized access (403)
**Given** the backend returns `403 Forbidden` for my request  
**When** I load the snapshot  
**Then** the UI shows a not-authorized error state  
**And** the UI does not repeatedly retry the request

## Scenario 6: Server error (500) exposes correlation ID when present
**Given** the backend returns `500 Internal Server Error` with a correlation ID in the response (header or body)  
**When** I load the snapshot  
**Then** the UI displays a generic error message  
**And** includes the correlation ID value for support troubleshooting

---

# 13. Audit & Observability

## User-visible audit data
- Display `snapshotMetadata.createdAt` and `snapshotMetadata.version` (and `snapshotId` if present) to support â€œwhat am I looking at?â€ traceability.

## Status history
- Not applicable (read-only snapshot viewer). No entity state changes.

## Traceability expectations
- Frontend should attach/request a correlation ID for the call if project conventions support it (e.g., header propagation).
- Log (frontend or Moqui server logs) should include:
  - actor/user id (if available on server side)
  - queried `partyId`/`vehicleId` (avoid logging if considered sensitive; see Open Questions)
  - outcome status code
  - correlation id

---

# 14. Non-Functional UI Requirements

- **Performance:** initial snapshot load should feel responsive; show loading indicator within 200ms of action.
- **Accessibility:** form controls labeled; error messages associated to fields; keyboard navigation supported.
- **Responsiveness:** screen usable on tablet resolutions (common POS form factor).
- **i18n/timezone:** render timestamps in user locale/timezone using existing app conventions; no currency requirements in this story.

---

# 15. Applied Safe Defaults

- SD-UX-EMPTY-STATES: Display â€œNo contacts foundâ€ / â€œNo vehicles foundâ€ when arrays are empty; safe because itâ€™s pure presentation and does not affect domain rules. Impacted sections: UX Summary, Error Flows.
- SD-UX-LOADING-DISABLE: Disable actions during in-flight request; safe because it prevents duplicate calls and doesnâ€™t change business outcomes. Impacted sections: Functional Behavior, State Model.
- SD-ERR-STATUS-MAP: Standard mapping of HTTP 400/403/404/500 to user-facing banners with retry only for 500; safe because it follows backend-implied semantics without inventing policies. Impacted sections: Service Contracts, Error Flows, Acceptance Criteria.

---

# 16. Open Questions

1. **Moqui integration pattern:** Should the frontend call `GET /v1/crm-snapshot` directly from the browser, or must it be proxied via a Moqui service (server-side) to satisfy allowlist + `crm.snapshot.read` scope requirements?  
2. **Route and screen placement:** What is the canonical screen path/module for CRM tools in `durion-moqui-frontend` (e.g., `/apps/pos/screen/crm/...` vs another structure)?  
3. **Error payload shape:** For 404 with `errorCode=VEHICLE_HAS_NO_ACTIVE_PARTY`, is `errorCode` returned in JSON body, and what is the exact field name/path?  
4. **Correlation ID source:** Where should the UI read the correlation ID (response header name like `X-Correlation-Id` vs JSON body field)?  
5. **PII logging policy (frontend/server):** Are partyId/vehicleId considered sensitive identifiers for logging in this workspace? If yes, what masking is required?  
6. **Access control at UI layer:** Is there a frontend role/permission that should hide/disable access to the Snapshot viewer screen even before backend 403 (e.g., â€œCSRâ€ vs â€œTechâ€)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Billing: Expose CRM Snapshot (Account + Contacts + Vehicles + Rules) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/163


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Billing: Expose CRM Snapshot (Account + Contacts + Vehicles + Rules)
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/163
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Billing: Expose CRM Snapshot (Account + Contacts + Vehicles + Rules)

**Domain**: payment

### Story Description

/kiro
# User Story

## Narrative
As a **Workorder System**, I want **a single endpoint to fetch account/person, contacts, vehicles, rules, and preferences** so that **estimate creation can be fast and consistent**.

## Details
- Endpoint accepts partyId and/or vehicleId.
- Returns normalized snapshot with version/timestamp.
- Cache-friendly response model.

## Acceptance Criteria
- Returns expected fields.
- Includes timestamps/version.
- Not-found handled cleanly.

## Integration Points (Workorder Execution)
- Workorder Execution calls snapshot at estimate draft and on-demand refresh.

## Data / Entities
- CRM Snapshot DTO / API

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================


BACKEND STORY REFERENCES (FOR REFERENCE ONLY)

----------------------------------------------------------------------------------------------------

Backend matches (extracted from story-work):


[1] backend/99/backend.md

    Labels: type:story, domain:crm, status:ready-for-dev, agent:story-authoring, agent:crm, agent:workexec, agent:billing


----------------------------------------------------------------------------------------------------

Backend Story Full Content:



### BACKEND STORY #1: backend/99/backend.md

------------------------------------------------------------

Title: [BACKEND] [STORY] Billing: Expose CRM Snapshot (Account + Contacts + Vehicles + Rules)
URL: https://github.com/louisburroughs/durion-positivity-backend/issues/99
Labels: type:story, domain:crm, status:ready-for-dev, agent:story-authoring, agent:crm, agent:workexec, agent:billing

## Story Intent
As a consuming system (initially Workorder Execution, and also Billing), I need a stable, efficient, CRM-owned read endpoint to retrieve a point-in-time snapshot of core customer relationship data (Account/Party, Contacts, Vehicles, and contactability + billing-relevant preferences), so downstream workflows can operate quickly and consistently without re-deriving CRM association rules.

## Actors & Stakeholders
- **Provider / SoR:** CRM service (`domain:crm`) owns the API and contract.
- **Consumers:** Workorder Execution (`domain:workexec`), Billing (`domain:billing`).
- **Indirect user:** Service Advisor (benefits from faster, consistent estimate creation).

## Preconditions
- Caller is service-to-service authenticated.
- Caller is authorized by **both**:
  - allowlisted service identity, and
  - required scope: `crm.snapshot.read`
- Request includes at least one identifier: `partyId` or `vehicleId`.

## Functional Behavior
### Endpoint
- `GET /v1/crm-snapshot`
- Query params:
  - `partyId` (optional)
  - `vehicleId` (optional)
- Rule: request MUST include at least one of `partyId` or `vehicleId`.

### Snapshot Retrieval (partyId)
- If `partyId` is provided, CRM returns a snapshot for that party/account, including:
  - account summary
  - active contacts (with one primary contact indicated)
  - associated vehicles (active)
  - preferences (v1 scope defined below)

### Snapshot Retrieval (vehicleId-only)
When only `vehicleId` is provided, CRM MUST resolve a single â€œprimary partyâ€ deterministically:
1. Find all **active vehicle-party relationships** for the vehicle.
2. Select primary party by precedence:
   1. `PRIMARY_OWNER` (ACTIVE)
   2. else `OWNER` (ACTIVE; most recent)
   3. else `LESSEE/DRIVER` (ACTIVE; most recent)
   4. else any ACTIVE relationship (most recent)
3. Tie-breaker for â€œmost recentâ€: latest `effectiveFrom`, then latest `updatedAt`.
4. If **no active relationships**, return `404` with error code `VEHICLE_HAS_NO_ACTIVE_PARTY`.
5. Return contacts:
   - all active contacts for the resolved primary party/account
   - mark one as `isPrimary=true` using CRMâ€™s primary-contact flag; if none exists, choose most recently updated contact.

## Alternate / Error Flows
- Missing identifiers (`partyId` and `vehicleId` both absent) â†’ `400 Bad Request`
- Party not found (invalid `partyId`) â†’ `404 Not Found`
- Vehicle not found (invalid `vehicleId`) â†’ `404 Not Found`
- Vehicle has no active party relationship â†’ `404 Not Found` with `errorCode=VEHICLE_HAS_NO_ACTIVE_PARTY`
- Unauthorized (valid auth, but not allowlisted and/or missing scope) â†’ `403 Forbidden`
- Unexpected aggregation failure â†’ `500 Internal Server Error` with correlation ID logged

## Business Rules
- **Domain ownership (Decision):** `domain:crm` owns this read API as a CRM read model. Billing/Workexec are consumers.
- **Contract stability:** response schema is versioned (`/v1/...`) and changes must be backward compatible within a version.
- **Preferences scope (Decision, v1):** â€œrules and preferencesâ€ means **contactability + billing-relevant preferences only**; explicitly exclude Workexec/Billing workflow/policy rules.
- **Authorization (Decision):** NOT open to â€œany internal callerâ€; restricted to allowlisted service identities + required scope.

## Data Requirements
### Response (v1) â€” shape (illustrative)
```json
{
  "snapshotMetadata": {
    "snapshotId": "uuid",
    "createdAt": "ISO-8601-Timestamp",
    "version": "string | ETag"
  },
  "account": {
    "partyId": "uuid",
    "accountNumber": "string",
    "accountName": "string",
    "accountType": "INDIVIDUAL | BUSINESS"
  },
  "contacts": [
    {
      "contactId": "uuid",
      "isPrimary": true,
      "name": "string",
      "roles": ["string"],
      "phoneNumbers": [{ "type": "MOBILE", "number": "string" }],
      "emailAddresses": [{ "type": "PRIMARY", "address": "string" }],
      "preferences": {
        "emailOptIn": true,
        "smsOptIn": false,
        "phoneOptIn": true,
        "doNotContact": false,
        "preferredContactMethod": "EMAIL | SMS | PHONE | NONE",
        "preferredLanguage": "string"
      }
    }
  ],
  "vehicles": [
    {
      "vehicleId": "uuid",
      "vin": "string",
      "licensePlate": "string",
      "make": "string",
      "model": "string",
      "year": 2024
    }
  ],
  "preferences": {
    "marketingOptOut": false,
    "doNotContact": false,
    "invoiceDeliveryMethod": "EMAIL | MAIL | NONE"
  }
}
```

## Acceptance Criteria
- **AC-1: Successful snapshot retrieval by partyId**
  - Given a valid `partyId` exists with contacts and vehicles
  - When calling `GET /v1/crm-snapshot?partyId={partyId}`
  - Then the service returns `200 OK` with the correct snapshot DTO and `snapshotMetadata.version`.

- **AC-2: Successful snapshot retrieval by vehicleId using deterministic party resolution**
  - Given a valid `vehicleId` exists with active relationships
  - When calling `GET /v1/crm-snapshot?vehicleId={vehicleId}`
  - Then the service returns `200 OK`
  - And selects the primary party using precedence `PRIMARY_OWNER > OWNER > LESSEE/DRIVER > any active` with â€œmost recentâ€ tie-breaker.

- **AC-3: Vehicle has no active party relationship**
  - Given a valid `vehicleId` exists but has no active party relationship
  - When calling `GET /v1/crm-snapshot?vehicleId={vehicleId}`
  - Then the service returns `404 Not Found` with `errorCode=VEHICLE_HAS_NO_ACTIVE_PARTY`.

- **AC-4: Missing identifier rejected**
  - Given any state
  - When calling `GET /v1/crm-snapshot` with no query params
  - Then the service returns `400 Bad Request`.

- **AC-5: Authorization is allowlist + scope enforced**
  - Given a valid service token
  - When the caller is not allowlisted and/or missing `crm.snapshot.read`
  - Then the service returns `403 Forbidden`.

- **AC-6: Preferences scope (v1) is limited**
  - Given a valid snapshot request
  - Then the response contains only contactability + billing-relevant preferences
  - And does not contain Workexec/Billing workflow/policy rules.

## Audit & Observability
- **Audit:** log caller identity + queried identifiers + timestamp.
- **Rate limiting:** per-caller rate limits to protect CRM.
- **Metrics:** request count, latency, and status codes, tagged by caller identity.
- **Logging:** structured logs with correlation IDs for all errors (4xx/5xx).

## Open Questions
- None. Decisions were supplied in the issue comments (Decision Record generated by `clarification-resolver.sh` on 2026-01-14).

---
## Original Story (Unmodified â€“ For Traceability)
# Issue #99 â€” [BACKEND] [STORY] Billing: Expose CRM Snapshot (Account + Contacts + Vehicles + Rules)

## Current Labels
- backend
- story-implementation
- payment

## Current Body
## Backend Implementation for Story

**Original Story**: [STORY] Billing: Expose CRM Snapshot (Account + Contacts + Vehicles + Rules)

**Domain**: payment

### Story Description

/kiro
# User Story

## Narrative
As a **Workorder System**, I want **a single endpoint to fetch account/person, contacts, vehicles, rules, and preferences** so that **estimate creation can be fast and consistent**.

## Details
- Endpoint accepts partyId and/or vehicleId.
- Returns normalized snapshot with version/timestamp.
- Cache-friendly response model.

## Acceptance Criteria
- Returns expected fields.
- Includes timestamps/version.
- Not-found handled cleanly.

## Integration Points (Workorder Execution)
- Workorder Execution calls snapshot at estimate draft and on-demand refresh.

## Data / Entities
- CRM Snapshot DTO / API

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Backend Requirements

- Implement Spring Boot microservices
- Create REST API endpoints
- Implement business logic and data access
- Ensure proper security and validation

### Technical Stack

- Spring Boot 3.2.6
- Java 21
- Spring Data JPA
- PostgreSQL/MySQL

---
*This issue was automatically created by the Durion Workspace Agent*

------------------------------------------------------------

====================================================================================================

END BACKEND REFERENCES

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #165: [FRONTEND] [STORY] Vehicle: Ingest Vehicle Updates from Workorder Execution  
File: ./scripts/story-work/frontend/165/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Vehicle: Ingest Vehicle Updates from Workorder Execution (Admin Processing Log UI)

### Primary Persona
- **CRM Data Steward / Support Engineer** (internal user)
- Secondary: **System** (event ingestion service) observed/operated by support staff

### Business Value
Provide an **operational UI in Moqui** to view and troubleshoot `VehicleUpdated` event ingestion outcomes (success/duplicate/error/pending review), enabling faster resolution of data sync issues and ensuring CRM vehicle data accuracy over time.

---

## 2. Story Intent

### As a / I want / So that
- **As a** CRM Data Steward / Support Engineer  
- **I want** a Moqui screen to search and inspect VehicleUpdated event processing logs (by vehicleId/workorderId/eventId/status/time) and drill into the affected Vehicle  
- **So that** I can audit ingestion, detect duplicates/errors, and take appropriate follow-up actions when conflicts or not-found errors occur.

### In-scope
- Moqui **screens + forms + transitions** for:
  - Listing/searching ingestion processing records (ProcessingLog)
  - Viewing a single processing recordâ€™s details (including workorder reference)
  - Linking to a Vehicle detail view (read-only for this story unless already exists)
- UI handling for empty states, loading, and error responses
- Role-gated access to these operational screens

### Out-of-scope
- Implementing the actual event consumer / ingestion logic (backend responsibility)
- Defining/implementing the conflict resolution policy (blocked)
- Manual remediation actions (e.g., â€œreprocess eventâ€, â€œoverride vehicleâ€) unless explicitly clarified

---

## 3. Actors & Stakeholders

- **Actor:** CRM Data Steward / Support Engineer
- **Stakeholders:**
  - Service Advisors (indirect consumers of accurate vehicle data)
  - Engineering/Operations (monitoring ingestion health)
  - Workorder Execution domain team (producer of `VehicleUpdated` events)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS/Moqui UI.
- User has permission to access CRM operational ingestion screens (role TBD).

### Dependencies
- Backend must expose data to support this UI, at minimum:
  - A queryable `ProcessingLog` store for `VehicleUpdated` ingestion attempts
  - Vehicle read endpoint/service for drill-in by `vehicleId`
- Backend must record the following (per original story):
  - `eventId`, `workorderId` (and/or estimateId), `vehicleId`, timestamps, status, and details/error payload

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation (suggested): **CRM â†’ Vehicles â†’ Ingestion Logs (VehicleUpdated)**  
  (Exact menu placement depends on existing Durion frontend conventions; if none, add under CRM admin/tools section.)

### Screens to create/modify
1. **New Screen:** `apps/crm/screen/vehicle/IngestionLog.xml` (list/search)
2. **New Screen:** `apps/crm/screen/vehicle/IngestionLogDetail.xml` (detail view)
3. **Modify (if exists):** Vehicle detail screen to add â€œIngestion Logsâ€ related link/tab (optional; clarify)

### Navigation context
- List screen supports drill-down to:
  - ProcessingLog detail
  - Vehicle detail (by `vehicleId`)
- Breadcrumbs:
  - CRM > Vehicles > Ingestion Logs
  - CRM > Vehicles > Ingestion Logs > Log Detail

### User workflows

#### Happy path (investigate recent ingestion)
1. User opens **Ingestion Logs**
2. Filters by **Status = ERROR_NOT_FOUND** and date range
3. Opens a log record, reviews `details`, copies `eventId`, clicks vehicle link (if vehicle exists)
4. Uses workorder reference to coordinate with Workorder Execution team

#### Alternate path (duplicate verification)
1. Filter Status = DUPLICATE
2. Confirm same `eventId` appears with prior SUCCESS
3. No remediation action; informational only

#### Alternate path (pending review)
1. Filter Status = PENDING_REVIEW
2. Open record and review conflict info in `details`
3. Follow runbook externally (out-of-scope) unless remediation actions are later defined

---

## 6. Functional Behavior

### Triggers
- User navigates to the ingestion log list screen.
- User submits search/filter form.
- User clicks a row to open detail.
- User clicks `vehicleId` link to navigate to vehicle view.

### UI actions
- List view:
  - Filter fields: `eventId`, `workorderId` (and estimateId if provided), `vehicleId`, `status`, `receivedTimestamp` range
  - Sort by `receivedTimestamp desc` default
  - Pagination
- Detail view:
  - Read-only display of all ProcessingLog fields
  - Display `details` in a readable format (pretty JSON if stored as JSON/text)
  - Provide copy-to-clipboard for `eventId` and `workorderId` (UI ergonomics; safe default)

### State changes
- UI itself does not mutate ingestion state in this story.
- (If later clarified) transitions for manual review resolution would be separate.

### Service interactions
- Query ProcessingLog list with filters/pagination
- Load single ProcessingLog by `logId` (or composite key)
- Load Vehicle by `vehicleId` for drill-in link validation (optional; can just navigate)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Search form:
  - If `eventId` provided: must be UUID format (client-side validation + server-side enforcement)
  - If date range: `from <= to`
  - If `status` provided: must be one of allowed enums

### Enable/disable rules
- â€œView Vehicleâ€ link:
  - Enabled when `vehicleId` present
  - If vehicle load returns 404, show non-blocking message â€œVehicle not found in CRMâ€ and keep user on log detail

### Visibility rules
- Screen is visible only to authorized roles (see Open Questions)
- `details` content must be displayed but avoid exposing sensitive data if present (masking rules unclear; see Open Questions)

### Error messaging expectations
- Network/service error: show user-friendly banner â€œUnable to load ingestion logs. Try again.â€ with correlation/request id if available.
- Unauthorized (403): redirect to unauthorized screen or show â€œYou do not have access.â€

---

## 8. Data Requirements

### Entities involved
- `ProcessingLog` (CRM operational/audit entity for ingestion)
- `Vehicle` (CRM master entity, read-only for drill-in)

### Fields

#### ProcessingLog (read-only in UI)
- `logId` (string/UUID) â€” required
- `eventId` (string/UUID) â€” required, indexed
- `workorderId` (string) â€” required, indexed  
  - **Note:** Acceptance criteria mention Workorder/Estimate ID; if both exist, add `estimateId` field (see Open Questions)
- `vehicleId` (string/UUID) â€” required, indexed
- `receivedTimestamp` (datetime, ISO-8601) â€” required
- `processedTimestamp` (datetime, ISO-8601) â€” optional
- `status` (enum) â€” required  
  Allowed values (per backend reference):  
  `SUCCESS | DUPLICATE | ERROR_VALIDATION | ERROR_NOT_FOUND | PENDING_REVIEW`
- `details` (json/text) â€” optional but recommended

#### Vehicle (for navigation)
- `vehicleId` (string/UUID) â€” required
- Display fields for context (if vehicle screen exists): `vin`, `unitNumber`, `description`, `licensePlate`, `mileage` (types/ownership per CRM)

### Read-only vs editable by state/role
- All fields in this story are **read-only**.

### Derived/calculated fields
- `processingLatencySeconds = processedTimestamp - receivedTimestamp` (optional display; safe default only if timestamps exist)

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names/endpoints are not provided in inputs; this story defines required frontend-facing contracts and flags as clarification if naming differs.

### Load/view calls

1. **Search Processing Logs**
- **Service (proposed):** `crm.vehicle.ProcessingLogSearch`
- **Inputs:**
  - `eventId?`, `workorderId?`, `vehicleId?`, `status?`
  - `receivedFrom?` (datetime), `receivedTo?` (datetime)
  - `pageIndex` (int), `pageSize` (int)
  - `orderBy` (string, default `-receivedTimestamp`)
- **Outputs:**
  - `items[]` with ProcessingLog summary fields
  - `totalCount`

2. **Get Processing Log Detail**
- **Service (proposed):** `crm.vehicle.ProcessingLogGet`
- **Inputs:** `logId` (required)
- **Outputs:** full ProcessingLog record

3. **Get Vehicle (for drill-in)**
- **Service (existing or proposed):** `crm.vehicle.VehicleGet`
- **Inputs:** `vehicleId`
- **Outputs:** vehicle fields for vehicle detail screen

### Create/update calls
- None.

### Submit/transition calls
- None.

### Error handling expectations
- `400` invalid filter inputs â†’ show inline validation messages (e.g., â€œInvalid UUIDâ€)
- `401/403` â†’ show unauthorized handling and prevent data display
- `404` on log detail â†’ show â€œLog record not foundâ€ with back link
- `5xx` â†’ generic error banner, preserve filters for retry

---

## 10. State Model & Transitions

### Allowed states (ProcessingLog.status)
- `SUCCESS`
- `DUPLICATE`
- `ERROR_VALIDATION`
- `ERROR_NOT_FOUND`
- `PENDING_REVIEW`

### Role-based transitions
- None (read-only UI).

### UI behavior per state
- List:
  - Display status badge for quick scanning
  - Default filter: none (shows recent by date) OR status not filtered (safe default; see Applied Safe Defaults)
- Detail:
  - For `PENDING_REVIEW`, show prominent notice â€œRequires review (policy pending)â€ and display details
  - For error statuses, show error summary extracted from `details` when possible

---

## 11. Alternate / Error Flows

### Validation failures
- User enters invalid UUID in `eventId` filter:
  - Block search submission client-side
  - Show â€œEvent ID must be a UUIDâ€

### Concurrency conflicts
- Not applicable (read-only).

### Unauthorized access
- User without required role opens URL directly:
  - Return 403 from backend; UI shows Unauthorized page/message

### Empty states
- No logs found for filters:
  - Show â€œNo ingestion logs match your filtersâ€ and suggest clearing filters

---

## 12. Acceptance Criteria

### Scenario 1: View recent ingestion logs
**Given** I am an authorized CRM support user  
**When** I navigate to CRM â†’ Vehicles â†’ Ingestion Logs  
**Then** I see a paginated list of ProcessingLog records sorted by receivedTimestamp descending  
**And** each row shows eventId, workorderId, vehicleId, receivedTimestamp, status

### Scenario 2: Filter logs by status and vehicleId
**Given** I am on the Ingestion Logs screen  
**When** I filter by `status = ERROR_NOT_FOUND` and `vehicleId = "V-999"` and submit  
**Then** only matching records are shown  
**And** the active filters remain visible after results load

### Scenario 3: View log detail
**Given** a ProcessingLog record exists with `logId = "L-1"`  
**When** I open the record detail view  
**Then** I see all ProcessingLog fields including details and timestamps  
**And** I can copy eventId and workorderId from the page

### Scenario 4: Vehicle drill-in link handles missing vehicle
**Given** I am viewing a ProcessingLog detail with `vehicleId = "V-999"`  
**And** the Vehicle does not exist in CRM  
**When** I click â€œView Vehicleâ€  
**Then** the UI shows â€œVehicle not found in CRMâ€  
**And** I remain on the ProcessingLog detail view

### Scenario 5: Client-side validation prevents invalid search
**Given** I am on the Ingestion Logs screen  
**When** I enter `eventId = "not-a-uuid"` and submit  
**Then** the search is not executed  
**And** I see an inline validation message indicating the UUID format requirement

### Scenario 6: Access control enforced
**Given** I am authenticated but do not have the required CRM support permission  
**When** I navigate to the Ingestion Logs URL  
**Then** I receive an unauthorized experience (403 handling)  
**And** no ProcessingLog data is displayed

---

## 13. Audit & Observability

### User-visible audit data
- ProcessingLog records are the audit surface:
  - Show `receivedTimestamp`, `processedTimestamp`, `status`, and `workorderId` reference
  - Display correlation identifiers when available (eventId)

### Status history
- Not in scope unless ProcessingLog stores multiple attempts; if it does, UI may show â€œattempt countâ€ (clarify).

### Traceability expectations
- From a log detail, user can:
  - Copy `eventId`
  - Copy `workorderId` (and `estimateId` if present)
  - Navigate to Vehicle (if exists)

---

## 14. Non-Functional UI Requirements

- **Performance:** List screen should load first page within 2 seconds for typical usage (assuming indexed fields).
- **Accessibility:** All interactive elements keyboard-navigable; status indicated with text (not color only).
- **Responsiveness:** Works on tablet viewport; list uses responsive table/card mode per Quasar defaults.
- **i18n/timezone:** Timestamps displayed in user locale/timezone (do not convert business logic; display only).
- **Security:** Do not render raw HTML from `details`; treat as text/JSON to prevent injection.

---

## 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE**
  - **Assumed:** Provide standard empty-state messaging and â€œClear filtersâ€ action.
  - **Why safe:** UI-only ergonomics; does not affect domain policy.
  - **Impacted sections:** UX Summary, Alternate / Error Flows, Acceptance Criteria

- **SD-UX-PAGINATION**
  - **Assumed:** Default pagination (pageSize 25) and sort by `receivedTimestamp desc`.
  - **Why safe:** Presentation default; does not change stored data or policies.
  - **Impacted sections:** UX Summary, Functional Behavior, Service Contracts

- **SD-ERR-GENERIC-MAPPING**
  - **Assumed:** Map 400/401/403/404/5xx to standard UI banners and inline messages.
  - **Why safe:** Standard error handling consistent with backend HTTP semantics.
  - **Impacted sections:** Business Rules, Service Contracts, Alternate / Error Flows

---

## 16. Open Questions

1. **Blocking (Policy):** What is the conflict resolution policy for `VehicleUpdated` events (e.g., mileage decreases, VIN changes)? Does `PENDING_REVIEW` exist and when is it used vs last-write-wins?
2. **Blocking (Data):** Does the ProcessingLog include **estimateId** in addition to workorderId (story mentions Workorder/Estimate ID)? If yes, what field name should UI use?
3. **Blocking (Security):** What roles/scopes are required to view ingestion logs (e.g., `crm.audit.read`, `crm.vehicle.read`, internal support role)? Any restrictions by location/org?
4. **Blocking (Backend contract):** What are the actual Moqui service names / screen paths / endpoints to query ProcessingLog and Vehicle? Are these entity-backed (entity-find) or REST endpoints?
5. **Risk (PII/sensitive):** Can `details` contain sensitive customer data or notes? If yes, what masking/redaction rules apply in UI?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Vehicle: Ingest Vehicle Updates from Workorder Execution  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/165  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Vehicle: Ingest Vehicle Updates from Workorder Execution

**Domain**: user

### Story Description

/kiro  
# User Story

## Narrative
As a **System**, I want **to update vehicle details captured during service (VIN correction, mileage, notes)** so that **CRM remains accurate over time**.

## Details
- Accept updates via event envelope from Workorder Execution.
- Apply idempotency and audit against workorder reference.

## Acceptance Criteria
- Vehicle updates are processed once.
- Audit includes source Workorder/Estimate ID.
- Conflicts handled (last-write or review queue; define policy).

## Integration Points (Workorder Execution)
- Workorder Execution emits VehicleUpdated events.
- CRM persists updates and exposes updated snapshot.

## Data / Entities
- Vehicle
- EventEnvelope
- ProcessingLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #166: [FRONTEND] [STORY] Vehicle: Store Vehicle Care Preferences â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/166
File: ./scripts/story-work/frontend/166/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Vehicle: Store Vehicle Care Preferences (Capture, Edit, View, and Audit)

**Primary Persona:** Service Advisor

**Business Value:** Ensure vehicle service is consistently performed according to customer/vehicle-specific expectations (tire brand, rotation interval, alignment preference, torque notes, and general notes), and make these preferences visible wherever service decisions are made (estimate and work order), with an auditable change history.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to add and update vehicle-specific care preferences and service notes from the vehicle context  
- **So that** technicians and advisors can reliably see and follow these preferences during estimating and execution, reducing rework and improving customer satisfaction.

### In-scope
- A vehicle-level UI section to **view**, **create**, and **update** care preferences + service notes.
- Preferences displayed **read-only** in:
  - Estimate view (when vehicle present)
  - Work Order view (when vehicle present)
- **Audit visibility** of changes (at minimum: who/when; ideally before/after if provided).
- Validation and error handling on save.

### Out-of-scope
- Defining/implementing CRM backend data model/services (frontend consumes).
- Deduplication/merge rules, customer identity rules.
- Workflow/state logic inside Workorder Execution beyond *displaying* the preferences.
- Bulk-edit across vehicles or importing preferences.

---

## 3. Actors & Stakeholders
- **Service Advisor (Primary):** Captures/updates preferences and notes.
- **Technician/Mechanic (Secondary):** Consumes preferences on work order during execution.
- **Shop Manager (Stakeholder):** Wants consistency and accountability (audit).
- **CRM System (SoR):** Stores vehicle preferences/notes and audit trail.
- **Workorder Execution UI (Downstream consumer):** Displays preferences within Estimate/WO context.

---

## 4. Preconditions & Dependencies
1. User is authenticated in the POS frontend.
2. User has authorization to:
   - View vehicle record
   - Edit vehicle care preferences (exact permission/scope **TBD**, see Open Questions)
3. A **Vehicle** record exists and user can navigate to it (vehicleId available in route params).
4. Backend endpoints (Moqui services or REST resources) exist/are exposed for:
   - Loading vehicle preferences/notes
   - Saving vehicle preferences/notes
   - Loading audit history (or audit summary) for these changes
5. Estimate/Work Order screens can access vehicleId (or vehicle reference) to load preferences for display.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Vehicle Profile** screen: â€œVehicle Care Preferences & Notesâ€ section/card/tab.
- From **Estimate** view screen: read-only â€œVehicle Preferencesâ€ panel.
- From **Work Order** view/execution screen: read-only â€œVehicle Preferencesâ€ panel.

### Screens to create/modify
1. **Modify:** `Vehicle` profile screen  
   - Add a section for preferences/notes with:
     - Read-only display mode
     - Edit mode (form)
     - Save/Cancel actions
     - â€œLast updated by/atâ€ summary
     - Link/button to â€œView change historyâ€ (audit)
2. **Modify:** `Estimate` view screen  
   - Add read-only rendering of preferences/notes for the vehicle on the estimate.
3. **Modify:** `Work Order` view/execution screen  
   - Add read-only rendering of preferences/notes for the vehicle on the WO.
4. **Add or Modify (optional depending on backend):** Audit modal/subscreen  
   - A modal dialog or child screen listing audit entries for this vehicleâ€™s preferences.

### Navigation context
- Vehicle profile route includes `vehicleId`.
- Estimate/WO view routes include identifier for estimate/WO; vehicleId must be derivable:
  - either present directly, or fetched from estimate/WO header.

### User workflows
**Happy path (Vehicle profile)**
1. Service Advisor opens Vehicle profile.
2. System loads existing preferences/notes (if any) and displays them.
3. Advisor clicks â€œEditâ€.
4. Advisor updates structured fields and/or free-form notes.
5. Advisor clicks â€œSaveâ€.
6. System validates, saves, shows success toast, and returns to read-only view with updated summary + audit link.

**Alternate path: create first-time**
- If no preferences exist, section shows empty state with â€œAdd preferencesâ€ CTA leading into edit mode.

**Alternate path: view audit**
- Advisor clicks â€œChange historyâ€ and sees list of changes (timestamp, actor, changed fields/values if available).

**Read-only in Estimate/WO**
- User sees preferences and notes; no editing actions exposed.

---

## 6. Functional Behavior

### Triggers
- Screen load of Vehicle profile, Estimate view, Work Order view.
- User actions: Edit, Save, Cancel, View History.

### UI actions
- **Vehicle Profile**
  - `Edit` toggles form inputs enabled.
  - `Save` submits to backend.
  - `Cancel` discards unsaved changes and reverts to last loaded state.
  - `View change history` opens modal/subscreen that loads audit entries.
- **Estimate/WO**
  - Render a consistent, compact, read-only view:
    - Preferred tire brand/line
    - Rotation interval (+ unit)
    - Alignment preference
    - Torque spec notes
    - Service notes

### State changes (UI-level)
- `loading` (initial fetch)
- `empty` (no record exists)
- `view` (record exists, read-only)
- `edit` (form dirty/clean)
- `saving`
- `error` (load/save failures)

### Service interactions
- On load: call a â€œget preferences by vehicleIdâ€ service.
- On save:
  - If record exists: update service.
  - If missing: create service (or upsert if backend supports).
- On audit open: call â€œget audit entries by vehicleIdâ€ service.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `rotationInterval` must be numeric integer if provided; reject non-numeric input.
- Email/phone/VIN not in scope here (do not validate beyond field-level requirements below).

**Blocking clarification:** whether rotation interval is required, allowed min/max, and unit enum are not fully defined (see Open Questions). Until clarified, frontend must only enforce â€œinteger if presentâ€ and rely on backend for additional constraints.

### Enable/disable rules
- Edit controls enabled only if user has edit permission (TBD permission check mechanism).
- Save button disabled when:
  - Form is pristine (no changes), OR
  - Currently saving, OR
  - Client-side validation fails (e.g., rotation interval not integer)

### Visibility rules
- Estimate/WO: section visible if vehicle exists on the document.
- If no preferences exist: show â€œNo vehicle preferences recordedâ€ and hide empty fields; still show notes area as â€œNoneâ€ (or omitted) per UI ergonomics.

### Error messaging expectations
- Field-specific error for rotation interval invalid input: â€œRotation interval must be a whole number.â€
- Backend validation errors should be surfaced at:
  - field level if backend returns field mapping
  - otherwise as a banner/toast with backend message.

---

## 8. Data Requirements

### Entities involved (frontend perspective; backend SoR = CRM)
- `Vehicle` (already exists; provides `vehicleId`)
- `VehiclePreference` (or `VehicleCarePreference`) **TBD exact name**
- `VehicleNote` (if separate entity) **TBD**
- `AuditLog` / `ChangeHistory` entries **TBD**

### Fields (type, required, defaults)

**Vehicle Care Preferences record (view/edit)**
- `vehicleId` (UUID/string) â€” required, read-only (from route/context)
- `preferredTireBrand` (string) â€” optional
- `preferredTireLine` (string) â€” optional
- `rotationInterval` (integer) â€” optional (client validates integer if provided)
- `rotationIntervalUnit` (enum string: `MILES`/`KM` etc.) â€” optional; default behavior **TBD**
- `alignmentPreference` (string) â€” optional
- `torqueSpecNotes` (string) â€” optional (short text)
- `serviceNotes` (text) â€” optional (multi-line)
- `lastUpdatedAt` (datetime) â€” read-only (if provided)
- `lastUpdatedBy` (user display) â€” read-only (if provided)

**Audit entry (read-only)**
- `changedAt` (datetime)
- `changedBy` (user identifier/display)
- `changeType` (CREATED/UPDATED)
- `diff` (before/after or changed fields) â€” **TBD based on backend**

### Read-only vs editable by state/role
- Vehicle profile:
  - Editable: preference fields + notes (only in edit mode and with permission)
  - Read-only: vehicleId, audit summary fields
- Estimate/WO:
  - All fields read-only

### Derived/calculated fields
- â€œDisplay rotation intervalâ€ derived string: `${rotationInterval} ${rotationIntervalUnit}` when both present; otherwise display whichever exists.
- â€œLast updated summaryâ€ derived from audit or record metadata if available.

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not provided in this frontend issue. The story requires explicit Moqui service names/paths to be implementable; until clarified, the UI should be structured to call these services via a single adapter/composable.

### Load/view calls
- **Get vehicle preferences**
  - Input: `vehicleId`
  - Output: preference record or â€œnot found/emptyâ€
  - Expected outcomes:
    - 200 with record
    - 404/empty meaning no preferences exist yet (treated as empty state)

### Create/update calls
- **Upsert or Create/Update vehicle preferences**
  - Input: `vehicleId` + preference payload fields
  - Output: saved record with updated metadata
  - Expected outcomes:
    - 200/201 success
    - 400 validation error (field-level if possible)
    - 403 unauthorized
    - 409 conflict (concurrency) **TBD if versioning is used**
    - 500 unexpected

### Submit/transition calls
- None (no lifecycle state transitions defined for preferences).

### Error handling expectations
- Map backend HTTP/service errors to:
  - 403: show â€œYou donâ€™t have permission to edit vehicle preferences.â€
  - 404 on load: show empty state
  - 400: show validation banner + field errors if provided
  - 409: show â€œPreferences were updated by someone else. Reload to continue.â€ (requires concurrency info; TBD)
  - 500: generic â€œUnable to save vehicle preferences right now.â€

---

## 10. State Model & Transitions

### Allowed states (UI)
- `EMPTY` (no preference record exists)
- `VIEW` (record exists, read-only)
- `EDIT` (record being edited)
- `SAVING`
- `ERROR_LOADING`
- `ERROR_SAVING`

### Role-based transitions
- Users with edit permission:
  - `EMPTY/VIEW -> EDIT` via Edit/Add
  - `EDIT -> SAVING -> VIEW/EMPTY` via Save
- Users without edit permission:
  - Cannot enter EDIT; always VIEW/EMPTY read-only

### UI behavior per state
- `EMPTY`: show CTA to add (if permitted) else show message only.
- `VIEW`: show fields in read-only plus â€œEditâ€ (if permitted).
- `EDIT`: inputs enabled, Save/Cancel shown.
- `SAVING`: disable inputs and buttons; show spinner.
- `ERROR_LOADING`: show retry action.
- `ERROR_SAVING`: keep user in EDIT with inline banner.

---

## 11. Alternate / Error Flows

1. **Validation failure (client-side)**
   - rotation interval contains non-numeric characters
   - Prevent save; show field message; keep in edit mode.

2. **Validation failure (backend)**
   - Backend returns validation error payload
   - Display banner â€œPlease correct the highlighted fields.â€
   - Apply field errors when mappings exist; otherwise show backend message.

3. **Vehicle not found**
   - Vehicle profile route has invalid vehicleId
   - Show â€œVehicle not foundâ€ and hide preference editor.

4. **Concurrent update**
   - Backend indicates conflict (409) (if supported)
   - Prompt user to reload; do not silently overwrite.

5. **Unauthorized access**
   - User can view vehicle but cannot edit preferences
   - Hide edit actions; if user tries direct action (e.g., deep link), show permission message.

6. **Empty state on Estimate/WO**
   - If no preferences exist, show â€œNo vehicle preferences recordedâ€ (read-only).

---

## 12. Acceptance Criteria

### Scenario 1: Create vehicle care preferences from vehicle profile
**Given** I am authenticated as a Service Advisor with permission to edit vehicle preferences  
**And** I am viewing a vehicle profile for a valid `vehicleId` that has no saved preferences  
**When** I click â€œAdd preferencesâ€  
**And** I enter a preferred tire brand and service notes  
**And** I click â€œSaveâ€  
**Then** the system saves the preferences associated to that `vehicleId`  
**And** I see the saved values in read-only mode  
**And** I see a success confirmation message

### Scenario 2: Update existing preferences
**Given** I am authenticated as a Service Advisor with permission to edit vehicle preferences  
**And** a vehicle has existing saved preferences  
**When** I click â€œEditâ€  
**And** I change the rotation interval and torque spec notes  
**And** I click â€œSaveâ€  
**Then** the updated values are persisted and displayed in read-only mode  
**And** the â€œlast updatedâ€ summary reflects the latest change (if provided by backend)

### Scenario 3: Client-side validation prevents save
**Given** I am editing vehicle preferences  
**When** I enter â€œabcâ€ into the rotation interval field  
**And** I click â€œSaveâ€  
**Then** the save is not submitted  
**And** I see an inline error stating rotation interval must be a whole number

### Scenario 4: Preferences visible on Estimate view
**Given** a vehicle has saved preferences and notes  
**And** an Estimate exists that references that vehicle  
**When** I view the Estimate  
**Then** I see the vehicle preferences and notes displayed read-only on the Estimate screen

### Scenario 5: Preferences visible on Work Order view/execution
**Given** a vehicle has saved preferences and notes  
**And** a Work Order exists that references that vehicle  
**When** I view the Work Order  
**Then** I see the vehicle preferences and notes displayed read-only on the Work Order screen

### Scenario 6: Audit history is accessible and shows changes
**Given** a vehicle has had its preferences created or updated  
**And** I am an authorized user to view audit history  
**When** I open â€œChange historyâ€ from the vehicle preferences section  
**Then** I see a list of changes including timestamp and actor  
**And** I can distinguish created vs updated entries (if provided)

### Scenario 7: Unauthorized user cannot edit
**Given** I am authenticated but do not have permission to edit vehicle preferences  
**When** I view a vehicle profile  
**Then** I can view existing preferences read-only  
**And** I do not see edit/add actions  
**And** if I attempt to save via any UI path, I receive a permission error and nothing is changed

---

## 13. Audit & Observability

### User-visible audit data
- Display â€œLast updated atâ€ and â€œLast updated byâ€ in Vehicle profile preferences section **if backend provides**.
- Provide â€œChange historyâ€ view showing:
  - timestamp
  - actor
  - change type (created/updated)
  - changed fields/before-after when available

### Status history
- Not applicable (no lifecycle states defined for preferences), but change history acts as status/audit trail.

### Traceability expectations
- All save operations should include correlation/trace id if the frontend framework supports it (pass through headers if configured).
- Do not log full free-form notes client-side in console logs (avoid PII leakage).

---

## 14. Non-Functional UI Requirements
- **Performance:** Preference load should not block entire vehicle profile rendering; load section asynchronously with a local spinner/skeleton.
- **Accessibility:** All form controls labeled; error messages associated with fields; keyboard navigable modal for audit history.
- **Responsiveness:** Works on tablet widths commonly used in bays; form fields stack appropriately.
- **i18n/timezone:** Display timestamps in shop/user locale/timezone (using existing frontend conventions). Currency not applicable.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Show a clear empty state (â€œNo vehicle preferences recordedâ€) with an Add CTA when permitted; qualifies as safe because itâ€™s pure UI ergonomics and does not alter domain policy. (Impacted: UX Summary, Alternate/Error Flows)
- SD-UX-ASYNC-SECTION-LOAD: Load preferences section asynchronously with local loading indicator; safe because it affects only perceived performance and not business behavior. (Impacted: UX Summary, Non-Functional)
- SD-ERR-GENERIC-BANNER: Use a generic save/load failure banner when backend does not provide field-mapped errors; safe because itâ€™s standard error handling without changing rules. (Impacted: Service Contracts, Error Flows)

---

## 16. Open Questions

1. **Backend contract required (blocking):** What are the exact Moqui endpoints/services for:
   - load vehicle preferences by `vehicleId`
   - create/update (or upsert) vehicle preferences
   - load audit history  
   Please provide service names, parameter names, and response schema (including error format and field-level errors).

2. **Structured key/values vs fixed schema (blocking):** Are the preference fields a **fixed schema** (brand/line/interval/alignment/torque notes + free notes), or must the frontend support **dynamic key/value preferences** (EAV/JSON) that can change without UI redeploy?

3. **Authorization (blocking):** What permission(s)/role(s) govern:
   - viewing vehicle preferences
   - editing vehicle preferences
   - viewing audit history  
   Is this enforced via Moqui artifact auth, a permission service, or route-level guards?

4. **Audit payload detail (blocking):** Will audit history provide field-level diffs/before-after values, or only â€œwho/when/what entityâ€? The UI design depends on this.

5. **Concurrency/versioning (blocking):** Does the preference record include a version field (optimistic locking) or `lastUpdatedStamp` that must be submitted on update? If yes, what is the expected 409 conflict behavior?

6. **Rotation interval unit enum (blocking):** What are the allowed units (MILES/KM/â€¦)? Is unit required when interval is provided? Any min/max constraints?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Vehicle: Store Vehicle Care Preferences â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/166

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Vehicle: Store Vehicle Care Preferences
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/166
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Vehicle: Store Vehicle Care Preferences

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Service Advisor**, I want **to record vehicle-specific care preferences and service notes** so that **the shop can deliver service aligned with customer expectations**.

## Details
- Preferences: preferred tire brand/line, rotation interval, alignment preference, torque spec notes.
- Structured key/values + free-form notes.

## Acceptance Criteria
- Add/update preferences.
- Preferences visible on estimate/workorder.
- Changes audited.

## Integration Points (Workorder Execution)
- Workorder Execution displays preferences at estimate and during execution.

## Data / Entities
- VehiclePreference
- VehicleNote

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #167: [FRONTEND] [STORY] Vehicle: Vehicle Lookup by VIN/Unit/Plate â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/167
File: ./scripts/story-work/frontend/167/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

## 1. Story Header

**Title**  
[FRONTEND] [STORY] Vehicle: Vehicle Lookup by VIN/Unit/Plate (Search + Select Snapshot)

**Primary Persona**  
Service Advisor

**Business Value**  
Reduce time and errors when identifying the correct customer asset so the advisor can start an estimate/workflow on the correct vehicle with owner context.

---

## 2. Story Intent

**As a** Service Advisor  
**I want** to search vehicles by VIN, unit number, or license plate (supporting partial search) and select a result  
**So that** I can quickly confirm the right vehicle and load a full vehicle + owner snapshot to begin an estimate.

### In-scope
- A dedicated vehicle lookup UI in the frontend (Vue 3 + Quasar) reachable from the POS workflow.
- Search by a single free-text query that matches VIN, unit number, or license plate.
- Display ranked results including owner account context.
- Selecting a result loads â€œfull vehicle + owner snapshotâ€ and returns it to the calling context (e.g., estimate creation flow) in a deterministic way.
- Error/empty/loading states, basic input validation, and accessibility.

### Out-of-scope
- Creating/editing vehicles, owners, or contacts (CRM is SoR; this story is lookup/select only).
- Vehicle deduplication/merge flows.
- Defining backend ranking algorithm, backend pagination strategy, or the definitive snapshot schema (frontend will follow backend contract once confirmed).
- Implementing estimate creation itself (only integration handoff).

---

## 3. Actors & Stakeholders

- **Service Advisor (end user):** Performs search and selection at counter/in shop intake.
- **Workorder Execution (downstream workflow):** Consumes selected `vehicleId` (and possibly snapshot payload) to initialize estimate context.
- **CRM domain services (backend):** Executes vehicle search and returns vehicle+owner snapshot.
- **Security/RBAC policy owners:** Define which roles/scopes can view vehicle and owner data in POS.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User has permission to search and view vehicle and owner/account context (exact permission/scope TBD â†’ Open Questions).
- CRM backend endpoints for:
  - vehicle search (by query)
  - vehicle+owner snapshot retrieval by `vehicleId`
  are available and reachable from Moqui.

### Dependencies
- Backend story reference: `durion-positivity-backend#103` (currently indicates clarification required on ranking, partial match definition, snapshot schema, and result limits).
- Moqui frontend app routing/screen conventions from `durion-moqui-frontend` README (not provided here; must be followed by implementer).
- Workorder Execution integration: calling screen/workflow must define how it receives the selected vehicle context (callback/return parameters).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an â€œStart Estimateâ€ (or similar intake) flow: user opens **Vehicle Lookup** to find/select a vehicle.
- Secondary: standalone â€œVehicle Searchâ€ tool screen for quick lookup (optional; only if aligned with existing navigation).

### Screens to create/modify
1. **Screen:** `VehicleLookup` (new)
   - Contains:
     - Search input form
     - Results list/grid
     - Selection action per result
2. **(Optional) Subscreen/Dialog:** `VehicleLookupResults` (if project pattern separates search/results)
3. **Transition return target:** a transition that returns selected vehicle context to caller (details depend on existing Moqui screen flow conventions).

### Navigation context
- `VehicleLookup` should accept optional input parameters from caller:
  - `returnScreen` (string) or `returnUrl` (string) (TBD by Moqui convention)
  - `sourceWorkflow` (e.g., `estimate-create`) for audit/observability tags
- On selection, navigate back to caller with:
  - `vehicleId`
  - optionally `ownerAccountId` and/or snapshot payload (TBD)

### User workflows
#### Happy path
1. Advisor opens Vehicle Lookup.
2. Enters query (VIN/unit/plate) and submits.
3. Sees ranked results with enough detail to confirm the correct vehicle.
4. Clicks/selects a result.
5. System loads full vehicle+owner snapshot.
6. System returns to caller with selected vehicle context and indicates success.

#### Alternate paths
- Broad search returns many results â†’ show â€œrefine your searchâ€ guidance and limited list (limit behavior depends on backend).
- No matches â†’ show empty state and allow user to change query.
- Backend errors â†’ show inline error banner and allow retry.

---

## 6. Functional Behavior

### Triggers
- User submits search form (Enter key or Search button).
- User selects a vehicle from results.

### UI actions
- Search input:
  - Single text field `query`
  - Search button disabled until minimum length requirement met (TBD; if undefined, do not enforce beyond non-empty).
- Results:
  - Each row shows:
    - `description` (e.g., year/make/model or description string)
    - VIN (possibly masked/shortened display)
    - unit number
    - license plate
    - owner account name
  - â€œSelectâ€ action per result

### State changes (frontend)
- `idle` â†’ `searching` â†’ `showingResults | empty | error`
- On selection: `selecting` â†’ `selected | error`
- Persist selected vehicle context only in-memory for the current workflow unless caller specifies persistence.

### Service interactions (Moqui-oriented)
- Search submit invokes a Moqui service call (or REST call through Moqui) to CRM search endpoint.
- Selection invokes a second service call to load full snapshot for selected `vehicleId`.
- Both calls must capture and surface:
  - `400` invalid input
  - `403` unauthorized
  - `404` vehicle not found (on snapshot load)
  - `409` conflict (if backend uses it for concurrent updates)
  - `5xx` server errors

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `query` is required (non-empty after trim).
- If backend defines minimum characters for partial search, enforce same rule client-side to reduce unnecessary calls (TBD â†’ Open Questions).
- No client-side assumptions about VIN format beyond trimming whitespace; backend remains source of truth for validation.

### Enable/disable rules
- Disable Search button when:
  - query is empty/whitespace
  - currently searching
- Disable Select action while snapshot is loading for a selected row (prevent double select).

### Visibility rules
- Results area visible after first search attempt.
- Empty state visible when search returns 0 results.
- Error banner visible when service call fails; include retry action.

### Error messaging expectations
- Map backend validation errors to field-level message on `query` when possible.
- For authorization errors (403), show â€œYou donâ€™t have access to search vehiclesâ€ (do not leak details).
- For server errors, show generic message plus correlation/reference if available.

---

## 8. Data Requirements

> Note: Backend contract is not finalized; below lists required fields as implied by story, plus â€œTBDâ€ placeholders.

### Entities involved (conceptual)
- **Vehicle** (CRM-owned)
- **Owner Account / Party** (CRM-owned)
- **Customer Snapshot / Vehicle Snapshot** (CRM read model)

### Fields (type, required, defaults)

#### Search request
- `query` (string, required, trimmed, no default)

#### Search result item (summary)
- `vehicleId` (UUID/string, required)
- `vin` (string, optional in display but expected present)
- `unitNumber` (string, optional)
- `licensePlate` (string, optional)
- `description` (string, required for identification in UI; if missing, construct from available fields only if backend provides year/make/modelâ€”otherwise show â€œ(No description)â€)
- `owner.accountId` (UUID/string, required)
- `owner.name` (string, required)

#### Snapshot on selection (minimum needed by downstream)
- `vehicleId` (required)
- `owner.accountId` (required)
- Additional snapshot fields: **TBD by backend contract** (Open Question)

### Read-only vs editable
- All fields are read-only in this story.

### Derived/calculated fields (frontend)
- `displayVin`: if VIN is long, show last 6â€“8 characters with prefix masking (ONLY if allowed by security policy; otherwise show full VIN or omitâ€”TBD).
- `displayTitle`: prefer `description`; else combine `unitNumber`/`licensePlate`.

---

## 9. Service Contracts (Frontend Perspective)

> Backend references show proposed endpoints but not confirmed. Frontend must implement against the actual Moqui service layer once finalized.

### Load/view calls
- None on initial entry (unless caller passes a pre-filled query).

### Create/update calls
- None.

### Submit/transition calls
1. **Vehicle search**
   - Proposed: `POST /api/v1/vehicles/search` with body `{ "query": "<string>" }`
   - Response: `200 OK` with `{ results: [ ... ] }` or `[]` depending on final contract (TBD).
2. **Vehicle snapshot retrieval**
   - Proposed: `GET /api/v1/vehicles/{vehicleId}?include=owner`
   - Response: `200 OK` with snapshot payload.

### Error handling expectations
- `400`: show field-level error (query) if message indicates invalid query; otherwise show banner.
- `403`: show authorization error; do not retry automatically.
- `404` (snapshot): show â€œVehicle no longer availableâ€ and return to results.
- `409`: show â€œVehicle data changed; please retryâ€ and allow reload.
- `5xx`: show banner with retry.

---

## 10. State Model & Transitions

### Allowed UI states
- `idle`
- `searching`
- `results`
- `empty`
- `error`
- `loadingSnapshot`
- `snapshotError`
- `completed` (handoff to caller)

### Role-based transitions
- If user lacks required permission:
  - entering screen: either block entirely (redirect/403 screen) or show disabled UI with message (TBD by app pattern).
- Otherwise:
  - `idle â†’ searching â†’ results|empty|error`
  - `results â†’ loadingSnapshot â†’ completed|snapshotError`

### UI behavior per state
- `searching`: show spinner, keep query editable but disable Search to prevent concurrent submissions.
- `results`: enable selection.
- `loadingSnapshot`: disable all selects; optionally show row-level progress.
- `error/snapshotError`: preserve last successful results if available; allow retry.

---

## 11. Alternate / Error Flows

1. **Empty query submission**
   - Prevent submit client-side; show â€œEnter VIN, unit number, or plateâ€.
2. **No matches**
   - Show â€œNo vehicles foundâ€ with suggestion to broaden/adjust query.
3. **Too many matches / truncated results**
   - If backend indicates truncation (flag/field TBD), show â€œResults limited; refine searchâ€.
4. **Unauthorized (403)**
   - Show access error and provide â€œBackâ€ to caller.
5. **Network timeout**
   - Show retry banner; do not clear query.
6. **Concurrency/conflict (409) on snapshot**
   - Show message and allow reselect/reload.
7. **Vehicle deleted between search and select (404)**
   - Show message; remove/refresh results on next search.

---

## 12. Acceptance Criteria

### Scenario 1: Search by exact VIN returns ranked matches
**Given** the Service Advisor is authenticated and authorized to search vehicles  
**And** the CRM backend contains a vehicle with VIN `1FTFW1E54KFA12345` and owner account name `FleetCo Inc.`  
**When** the advisor enters `1FTFW1E54KFA12345` and submits search  
**Then** the UI displays a results list containing a row with VIN `1FTFW1E54KFA12345`  
**And** that row shows owner account context including `FleetCo Inc.`

### Scenario 2: Partial unit number search returns multiple matches
**Given** the advisor is authorized  
**And** vehicles exist with unit numbers `FLEET-A501` and `FLEET-A502`  
**When** the advisor searches for `FLEET-A5`  
**Then** the UI displays both matching vehicles in results  
**And** each result includes `vehicleId` and owner account name

### Scenario 3: No matches shows empty state
**Given** the advisor is authorized  
**When** the advisor searches for `NONEXISTENT`  
**Then** the UI shows â€œNo vehicles foundâ€  
**And** no results rows are displayed

### Scenario 4: Selecting a result loads full snapshot and returns context to caller
**Given** a prior search returned a result with `vehicleId = veh-abc-123`  
**When** the advisor selects that result  
**Then** the frontend requests the vehicle snapshot for `veh-abc-123`  
**And** on success, the frontend returns to the calling workflow with `vehicleId = veh-abc-123`  
**And** the calling workflow can access owner account context from the returned payload/params (exact mechanism TBD)

### Scenario 5: Backend validation error is shown to user
**Given** the advisor is authorized  
**When** the advisor submits an invalid query and the backend responds `400` with a validation message  
**Then** the UI displays an error message associated with the search input or as a banner  
**And** the advisor can correct the query and retry

### Scenario 6: Unauthorized access is handled safely
**Given** the user is authenticated but not authorized to search vehicles  
**When** the user navigates to Vehicle Lookup or submits a search  
**Then** the UI shows an authorization error state  
**And** no vehicle/owner data is displayed

---

## 13. Audit & Observability

### User-visible audit data
- Not required for this UI (lookup only).

### Status history
- Not applicable.

### Traceability expectations
- Frontend should include in logs/telemetry (per workspace conventions):
  - `sourceWorkflow` (if provided)
  - search query length (avoid logging full VIN/plate if considered sensitive; policy TBD)
  - result count
  - selected `vehicleId`
  - correlation/request ID from backend if available

---

## 14. Non-Functional UI Requirements

- **Performance:** search should render results quickly; avoid excessive calls (debounce optional; see Safe Defaults).
- **Accessibility:** keyboard submit (Enter), focus management to results, accessible labels for inputs and buttons, screen-reader friendly empty/error states.
- **Responsiveness:** usable on typical POS tablet/desktop sizes.
- **i18n/timezone/currency:** not applicable (no monetary fields). Text must be compatible with i18n if project uses it (no hard-coded concatenations that break translation, where feasible).

---

## 15. Applied Safe Defaults

- **SD-UI-EMPTY-STATE**
  - **Assumed:** Explicit empty state when results are empty (â€œNo vehicles foundâ€).
  - **Why safe:** Pure UI ergonomics; does not change domain rules.
  - **Impacted sections:** UX Summary, Alternate / Error Flows, Acceptance Criteria
- **SD-UI-LOADING-STATE**
  - **Assumed:** Loading indicators and disabling actions during in-flight requests.
  - **Why safe:** Standard UI behavior; no domain policy impact.
  - **Impacted sections:** Functional Behavior, State Model & Transitions
- **SD-ERR-MAP-HTTP**
  - **Assumed:** Standard mapping of HTTP 400/403/404/409/5xx to user-facing errors with retry where appropriate.
  - **Why safe:** Error-handling mapping derived from implied backend contract.
  - **Impacted sections:** Service Contracts, Alternate / Error Flows, Acceptance Criteria

---

## 16. Open Questions

1. **Backend API contract confirmation (blocking):** What are the exact endpoints, methods, and response shapes for (a) vehicle search and (b) vehicle+owner snapshot? (The story references `POST /api/v1/vehicles/search` and `GET /api/v1/vehicles/{vehicleId}?include=owner` but marks snapshot schema as unclear.)
2. **Ranking logic (blocking):** What ranking rules should the UI expect (exact match vs starts-with vs contains), and does backend provide an explicit `rankScore`/`matchType` field?
3. **Partial search rules (blocking):** Is there a minimum query length before search is allowed? Is matching `contains` or `startsWith` for VIN/unit/plate?
4. **Result limiting/pagination (blocking):** What is the maximum results count returned? Will backend indicate truncation and/or support pagination parameters?
5. **Permission model (blocking):** What roles/scopes authorize vehicle search and snapshot view in the POS frontend (e.g., `crm.vehicle.read`, `crm.snapshot.read`), and what should the UI do on missing permission (hard block vs read-only message)?
6. **PII/sensitive display policy (blocking):** Are full VIN and license plate allowed to be displayed and logged in the POS UI? If masking is required, what masking standard should be used?
7. **Caller handoff mechanism (blocking):** In Moqui screens, how should VehicleLookup return the selected context to the estimate creation flow (return transition with parameters, shared context, or redirect with query params)? Which calling screen/route is the primary integration target?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Vehicle: Vehicle Lookup by VIN/Unit/Plate â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/167


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Vehicle: Vehicle Lookup by VIN/Unit/Plate
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/167
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Vehicle: Vehicle Lookup by VIN/Unit/Plate

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Service Advisor**, I want **to search vehicles by VIN, unit number, or plate** so that **I can quickly start an estimate for the correct asset**.

## Details
- Partial VIN and unit searches.
- Return matches including owner account context.

## Acceptance Criteria
- Search returns ranked matches.
- Selecting a match returns full vehicle + owner snapshot.

## Integration Points (Workorder Execution)
- Estimate creation uses vehicle search/selection.

## Data / Entities
- Vehicle search endpoint/index

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #168: [FRONTEND] [STORY] Vehicle: Associate Vehicles to Account and/or Individual  
File: ./scripts/story-work/frontend/168/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- none

**Rewrite Variant:** crm-pragmatic

---

# 1. Story Header

**Title:** [FRONTEND] [STORY] Vehicle: Associate Vehicles to Account and/or Individual

**Primary Persona:** Fleet Account Manager

**Business Value:** Ensure workorders default to the correct billing entity and contacts by maintaining authoritative vehicle ownership (commercial account) and optional primary driver (individual), including reassignment history.

---

# 2. Story Intent

### As a / I want / So that
- **As a** Fleet Account Manager  
- **I want** to link a vehicle to a commercial account (owner) and optionally assign a primary driver (person)  
- **So that** downstream workflows (Workorder Execution, Billing) can reliably default to the correct billing entity and contact context.

### In-scope
- Frontend screens and flows to:
  - View current vehicle associations (active OWNER + optional active PRIMARY_DRIVER).
  - Create an initial OWNER association.
  - Reassign OWNER (implicit reassignment that end-dates prior owner, atomically).
  - Assign or change PRIMARY_DRIVER (requires active OWNER).
  - View association history (effective dating; non-destructive).
- Validation and error handling aligned to backend rules (400/404/409).
- Moqui screen/actions wiring and service calls to CRM endpoints/services.

### Out-of-scope
- Creating/editing the underlying Vehicle master record (VIN, plate, etc.) unless required for association flow navigation.
- Customer/Party creation, deduplication, merge, or identity rules.
- Authorization policy design (roles/scopes); frontend only enforces via guarded UI + handling 403 responses.
- Workorder Execution UI changes.

---

# 3. Actors & Stakeholders

- **Primary Actor:** Fleet Account Manager
- **Secondary Actors:** CSR / Dispatcher (read-only use cases may exist but not required)
- **Service Owner / System of Record:** **CRM** for vehicleâ†”party associations
- **Downstream Consumers (read-only):** Workorder Execution, Billing
- **Stakeholders:** Accounting/Billing operations (consume defaults), CRM administrators (data integrity/audit)

---

# 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User is authorized to manage vehicle associations for the commercial account(s) involved.
- Target **Vehicle** exists.
- Target **Commercial Account** exists (Organization party).
- Optional **Driver** exists (Person party).

### Dependencies
- CRM backend capability as defined in backend story #104:
  - Enforce â€œexactly one active OWNER per vehicleâ€ and â€œzero or one active PRIMARY_DRIVER per vehicleâ€.
  - Implicit owner reassignment behavior (end-date old owner; idempotent no-op if same).
  - Driver assignment requires active owner.
  - Conflict detection for overlapping historical segments (409).
- Frontend must have access to:
  - Vehicle lookup (at least by vehicleId context).
  - Party lookup/search for selecting an owner account and driver person (exact endpoints/services TBD; see Service Contracts section).

---

# 5. UX Summary (Moqui-Oriented)

### Entry points
- From a **Vehicle detail** context screen (preferred): â€œAssociationsâ€ or â€œOwnership & Driverâ€.
- From an **Account** context (optional): â€œVehiclesâ€ list â†’ select vehicle â†’ manage associations.

### Screens to create/modify (Moqui)
1. **Vehicle Detail Screen** (existing, modify)
   - Add navigation to â€œAssociationsâ€ sub-screen.
2. **Vehicle Associations Screen** (new)
   - Displays:
     - Current active OWNER association (account).
     - Current active PRIMARY_DRIVER association (person) if present.
     - Association history table (OWNER and PRIMARY_DRIVER segments with start/end).
   - Actions:
     - â€œAssign/Reassign Ownerâ€
     - â€œAssign/Change Driverâ€
     - â€œUnassign Driverâ€ (end-date active PRIMARY_DRIVER) **only if supported by backend contract** (see Open Questions if not available).
3. **Owner Selection Dialog/Screen** (new or embedded)
   - Search/select commercial account party.
   - Choose effective start date/time (default now).
4. **Driver Selection Dialog/Screen** (new or embedded)
   - Search/select person party.
   - Choose effective start date/time (default now).

### Navigation context
- URL should include `vehicleId` as path or parameter to maintain context.
- Breadcrumb: Vehicles â†’ Vehicle <identifier> â†’ Associations.

### User workflows
**Happy path: initial owner assignment**
1. User opens Vehicle Associations screen.
2. No active owner shown.
3. User selects â€œAssign Ownerâ€, searches account, confirms.
4. UI shows success; active owner now displayed; history includes segment.

**Happy path: owner reassignment**
1. Active owner shown.
2. User selects â€œReassign Ownerâ€, chooses a different account, confirms.
3. UI refresh shows new active owner; history shows prior owner end-dated exactly at new start.

**Happy path: assign/change primary driver**
1. Active owner exists.
2. User selects â€œAssign/Change Driverâ€, searches person, confirms.
3. UI shows driver as active; history updated.

**Alternate path: driver assignment without owner**
- UI blocks action (disabled) and explains requirement; if attempted via direct route, backend 400 is handled and shown.

---

# 6. Functional Behavior

### Triggers
- Entering Vehicle Associations screen triggers load of:
  - Vehicle summary (identifier fields for header context if available).
  - Current active associations for vehicle.
  - Association history for vehicle.

### UI actions
- **Assign/Reassign Owner**
  - Opens selector for Organization party.
  - Collects `effectiveStartDate` (default: current date-time).
  - Submits create association request (`associationType=OWNER`).
- **Assign/Change Driver**
  - Enabled only if active owner exists.
  - Opens selector for Person party.
  - Collects `effectiveStartDate` (default: current date-time).
  - Submits create association request (`associationType=PRIMARY_DRIVER`).
- **View History**
  - Tabular list with filters (OWNER/PRIMARY_DRIVER, active-only toggle).

### State changes (frontend)
- After successful submit:
  - Re-fetch current associations + history to reflect server-side atomic end-dating and idempotency outcomes.
  - Show toast/inline confirmation message including key result (new owner/driver name, effective start).

### Service interactions (Moqui)
- Screen actions call Moqui services (which in turn call CRM backend endpoints or Moqui faÃ§ade services depending on project architecture).
- All write actions are transactional on backend; frontend handles outcomes via status codes and response payload.

---

# 7. Business Rules (Translated to UI Behavior)

### Validation
- **Owner required fields:** `vehicleId`, selected `partyId` (organization), `effectiveStartDate`.
- **Driver required fields:** `vehicleId`, selected `partyId` (person), `effectiveStartDate`.
- **Driver requires active owner:** UI disables â€œAssign/Change Driverâ€ when no active owner is present and shows helper text: â€œAssign an owner before selecting a primary driver.â€
- **No destructive deletes:** UI must not present â€œdelete associationâ€; only â€œend-date/unassignâ€ if explicitly supported.

### Enable/disable rules
- â€œAssign/Change Driverâ€ disabled if:
  - No active OWNER association returned from backend.
- â€œReassign Ownerâ€ label shown if active owner exists; otherwise â€œAssign Ownerâ€.

### Visibility rules
- Show â€œCurrent Ownerâ€ and â€œCurrent Primary Driverâ€ summary cards/sections when present.
- Show empty state messaging when none exists (especially no owner).

### Error messaging expectations
- `400 Bad Request`: show validation message from backend; map to field errors if error payload identifies fields.
- `404 Not Found`: show â€œVehicle or selected party not found. Refresh and try again.â€
- `403 Forbidden`: show â€œYou do not have permission to manage vehicle associations for this account.â€
- `409 Conflict`: show â€œAssociation dates conflict with existing history. Please adjust effective start date or review history.â€ Provide link/scroll to history section.

---

# 8. Data Requirements

### Entities involved (CRM-owned)
- `VehiclePartyAssociation`
- `Vehicle` (for context display; read-only)
- `Party` (Organization for owner; Person for driver; read-only selection/search)

### Fields (type, required, defaults)
**VehiclePartyAssociation (display & submit)**
- `associationId` (UUID, read-only, server-generated)
- `vehicleId` (UUID, required)
- `partyId` (UUID, required)
- `associationType` (enum, required): `OWNER` | `PRIMARY_DRIVER`
- `effectiveStartDate` (datetime, required; default in UI: now)
- `effectiveEndDate` (datetime, nullable; read-only in UI except possibly via â€œUnassignâ€ action if supported)
- Audit fields (read-only): createdBy, createdDate, lastUpdated*, etc. (if exposed)

### Read-only vs editable (by state/role)
- All historical rows are read-only.
- User can only create new associations (and possibly end-date active driver if supported); cannot edit historical segments in-place.
- Role constraints are enforced server-side; UI should hide/disable actions if authorization info is available, otherwise handle 403.

### Derived/calculated fields
- â€œActiveâ€ computed client-side as `effectiveEndDate == null` (or endDate > now if backend uses timestamps); however, UI should prefer backend â€œcurrent associationsâ€ response if provided.

---

# 9. Service Contracts (Frontend Perspective)

> Note: Exact endpoint/service names in Moqui project are not provided in inputs. The frontend story defines required contract shape; implementation must map to actual Moqui services/endpoints used in this repo.

### Load/view calls
1. **Get vehicle associations (current)**
   - Input: `vehicleId`
   - Output:
     - currentOwner: `{associationId, partyId, partyDisplayName, effectiveStartDate}`
     - currentPrimaryDriver (optional): same shape
2. **Get vehicle association history**
   - Input: `vehicleId`, optional filters: `associationType`, `activeOnly`
   - Output: list of associations with `partyDisplayName`, type, start/end

3. **Party search (owner selection)**
   - Input: query text, filters `partyType=ORGANIZATION` (commercial accounts)
   - Output: list `{partyId, displayName, keyIdentifiers...}`

4. **Party search (driver selection)**
   - Input: query text, filters `partyType=PERSON`
   - Output: list `{partyId, displayName, maybe phone/email for disambiguation (if allowed)}`

### Create/update calls
1. **Create association (OWNER or PRIMARY_DRIVER)**
   - Input:
     - `vehicleId` (UUID)
     - `partyId` (UUID)
     - `associationType` (`OWNER` or `PRIMARY_DRIVER`)
     - `effectiveStartDate` (datetime)
   - Behavior (backend enforced):
     - If creating OWNER and an active OWNER exists:
       - End-date existing active OWNER at new start and create new OWNER (atomic).
       - If same party as current owner: no-op / idempotent success.
     - If creating PRIMARY_DRIVER:
       - Requires active OWNER; ensures only one active primary driver (end-date prior driver if backend supports implicit reassignment; if not, backend should errorâ€”UI must handle either behavior via response).

### Submit/transition calls
- No additional workflow transitions beyond create association operations in this story.

### Error handling expectations
- Handle HTTP: 200/201 success, 400 validation, 403 forbidden, 404 missing, 409 conflict, 500 unexpected.
- Frontend must display backend-provided error messages; do not expose stack traces.

---

# 10. State Model & Transitions

### Allowed â€œstatesâ€ (association lifecycle)
For each `VehiclePartyAssociation` record:
- **Active:** `effectiveEndDate = null` (or end > now)
- **Inactive (historical):** `effectiveEndDate != null` (and end <= now)

### Role-based transitions
- Fleet Account Manager:
  - Can create OWNER association (initial or reassignment).
  - Can create PRIMARY_DRIVER association when OWNER exists.
  - Can view history.
- Other roles: read-only or no access (enforced by backend; UI should be prepared for 403).

### UI behavior per state
- When no active OWNER:
  - Show empty state for owner.
  - Disable driver assignment action with explanation.
- When active OWNER exists:
  - Show owner summary and â€œReassign Ownerâ€.
  - Enable driver assignment.
- When active PRIMARY_DRIVER exists:
  - Show driver summary and â€œChange Driverâ€ (and â€œUnassignâ€ only if supported).

---

# 11. Alternate / Error Flows

### Validation failures (400)
- Assign driver without owner:
  - UI prevents; if still occurs, show backend error and keep user on dialog.
- Invalid date/time:
  - Show field-level error (e.g., â€œEffective start date must be a valid date-timeâ€).

### Concurrency conflicts (409)
- If user selects an effectiveStartDate that overlaps with existing historical segments and backend returns 409:
  - UI shows conflict banner and highlights history list; user can retry with a different start date.

### Unauthorized access (403)
- Attempt to load associations:
  - Show â€œNot authorizedâ€ page/state.
- Attempt to submit changes:
  - Show inline error and disable further submits.

### Empty states
- No association history:
  - Show â€œNo associations recorded yet.â€
- Vehicle not found (404):
  - Show not-found state with link back to vehicle search/list.

---

# 12. Acceptance Criteria

### Scenario 1: View current owner and driver
**Given** I am an authorized Fleet Account Manager  
**And** a vehicle exists with an active OWNER association and an active PRIMARY_DRIVER association  
**When** I open the Vehicle Associations screen for that vehicle  
**Then** I see the current owner account displayed with its effective start date  
**And** I see the current primary driver displayed with its effective start date  
**And** I can view a history list that includes both associations.

### Scenario 2: Assign initial owner when none exists
**Given** I am an authorized Fleet Account Manager  
**And** a vehicle exists with no active OWNER association  
**When** I choose â€œAssign Ownerâ€, select a commercial account, and confirm with an effective start date of now  
**Then** the system creates an OWNER association for the vehicle  
**And** the Vehicle Associations screen refreshes showing the selected account as the current owner  
**And** the association appears in history as active (no end date).

### Scenario 3: Reassign owner with implicit end-dating
**Given** I am an authorized Fleet Account Manager  
**And** a vehicle exists with an active OWNER association to Account A  
**When** I reassign the owner to Account B with effective start date T  
**Then** the system end-dates Account Aâ€™s OWNER association at T  
**And** creates a new active OWNER association to Account B starting at T  
**And** the history shows no overlap between the two OWNER associations.

### Scenario 4: Assign primary driver requires active owner (UI guard + backend)
**Given** I am an authorized Fleet Account Manager  
**And** a vehicle exists with no active OWNER association  
**When** I view the Vehicle Associations screen  
**Then** the â€œAssign/Change Driverâ€ action is disabled with messaging indicating an owner is required.  

**And Given** I still attempt to call the driver assignment action (e.g., via direct route or forced submit)  
**When** the backend responds with 400 indicating an owner is required  
**Then** the UI shows the backend validation error and does not display a current primary driver.

### Scenario 5: Handle 409 conflict on overlapping history
**Given** I am an authorized Fleet Account Manager  
**And** a vehicle has existing historical OWNER associations  
**When** I attempt to create an OWNER association with an effective start date that conflicts with history  
**Then** the backend returns 409 Conflict  
**And** the UI displays a conflict message and prompts me to choose a different effective start date  
**And** no changes are shown as applied.

### Scenario 6: Authorization enforced
**Given** I am logged in without permission to manage vehicle associations for the target account  
**When** I attempt to assign or reassign an owner or driver  
**Then** the backend returns 403 Forbidden  
**And** the UI displays an authorization error and prevents further submission attempts.

---

# 13. Audit & Observability

### User-visible audit data
- On the history list, display:
  - associationType, party display name, effectiveStartDate, effectiveEndDate
  - (If available) createdBy and createdDate for traceability

### Status history
- History is the authoritative record (end-dated rows retained); UI must not hide inactive rows by default unless user toggles active-only.

### Traceability expectations
- All submit actions should include correlation identifiers if supported by the frontend framework (e.g., request ID header via Moqui/web client conventions).
- UI should log (client-side) minimal event: â€œvehicle_association_update_attemptâ€ and result (success/error) without PII beyond IDs.

---

# 14. Non-Functional UI Requirements

- **Performance:** Association screen should load within 2 seconds under normal conditions; history list should paginate if large.
- **Accessibility:** All dialogs/forms keyboard navigable; labels associated with inputs; validation errors announced to screen readers (Quasar best practices).
- **Responsiveness:** Usable on tablet widths typical for POS operations.
- **i18n/timezone:** Display effective dates in the userâ€™s local timezone; store/send date-times in ISO-8601 per backend expectation.
- **Security/PII:** Party search results should not expose sensitive fields beyond what is necessary to disambiguate (prefer displayName + minimal identifiers).

---

# 15. Applied Safe Defaults

- Default ID: UI-EMPTY-STATE-001  
  - What was assumed: Provide explicit empty-state messaging when no active owner/driver or no history exists.  
  - Why it qualifies as safe: Pure UI ergonomics; does not change domain rules or data.  
  - Impacted sections: UX Summary, Alternate / Error Flows.

- Default ID: UI-PAGINATION-001  
  - What was assumed: Paginate association history list (server- or client-side depending on API), with a sensible default page size.  
  - Why it qualifies as safe: Presentation-only; avoids performance issues without altering business behavior.  
  - Impacted sections: UX Summary, Non-Functional UI Requirements, Service Contracts.

- Default ID: UI-ERROR-MAP-001  
  - What was assumed: Standard mapping of HTTP 400/403/404/409 to user-friendly messages with inline field errors when possible.  
  - Why it qualifies as safe: Error handling is implied by backend contract; mapping does not invent policies.  
  - Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows.

---

# 16. Open Questions

- none

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Vehicle: Associate Vehicles to Account and/or Individual  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/168  
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Vehicle: Associate Vehicles to Account and/or Individual

**Domain**: payment

### Story Description

/kiro
# User Story

## Narrative
As a **Fleet Account Manager**, I want **to link a vehicle to a commercial account and optionally a primary driver** so that **workorders default to the right billing entity and contacts**.

## Details
- Vehicle associated to an account (owner) and optionally an individual (driver).
- Support reassignment with history.

## Acceptance Criteria
- Create/update associations.
- History preserved on reassignment.

## Integration Points (Workorder Execution)
- Workorder Execution fetches owner/driver for selected vehicle.

## Data / Entities
- VehiclePartyAssociation (owner/driver, dates)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #169: [FRONTEND] [STORY] Vehicle: Create Vehicle Record with VIN and Description â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/169
File: ./scripts/story-work/frontend/169/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

## 1. Story Header

**Title**  
[FRONTEND] [STORY] CRM Vehicle: Create Vehicle Record (VIN, Unit #, Description, Optional Plate)

**Primary Persona**  
Service Advisor (POS user)

**Business Value**  
Creates a stable `vehicleId` in CRM so downstream flows (estimate/workorder creation, service history, billing) can reliably attach activity to the correct vehicle.

---

## 2. Story Intent

**As a** Service Advisor  
**I want** to create a vehicle record by entering VIN, unit number, description (make/model/year free text), and optional license plate  
**So that** workorders/estimates/invoices can reference a stable `vehicleId` and future visits can find the same vehicle quickly.

### In-scope
- A Moqui screen flow to create a Vehicle in CRM
- Client-side validations (basic VIN sanity, required fields)
- Submit to Moqui service/API and handle success/error responses
- Post-create navigation to a vehicle detail view (or confirmation view) with the new `vehicleId`

### Out-of-scope
- External VIN decode (optional stub only; no real integration)
- Vehicle ownership association (linking to account/party) unless explicitly required by backend contract
- Advanced dedupe/merge logic
- Editing vehicle after creation (separate story)

---

## 3. Actors & Stakeholders
- **Service Advisor**: creates vehicle records during customer intake or workorder prep
- **CRM domain (system of record)**: persists vehicles and enforces invariants
- **Workorder Execution** (consumer): stores `vehicleId` on workorders/estimates
- **Billing** (consumer): uses `vehicleId` to link invoices/history
- **Support/Admin**: cares about auditability of created records

---

## 4. Preconditions & Dependencies
- User is authenticated in the frontend and has permission to create vehicles (exact permission/scope TBD â†’ see Open Questions).
- Moqui has an available service/API endpoint to create a vehicle and return `vehicleId` (backend story #105 indicates this exists but the exact route/service name is not provided).
- VIN uniqueness scope decision is made (global vs per-account) and reflected in backend responses (409 vs validation error).
- If â€œaccount/customer contextâ€ is required to create a vehicle (backend reference mentions `accountId`), the frontend must know the current `accountId` context and pass it.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
At least one entry path must exist (exact navigation depends on app IA):
- From a customer/account context: â€œAdd Vehicleâ€
- From a general vehicle search/list: â€œCreate Vehicleâ€

### Screens to create/modify
1. **Screen:** `VehicleCreate`  
   - Purpose: data entry + submit
2. **Screen:** `VehicleView` (or reuse an existing vehicle detail screen if present)  
   - Purpose: show created vehicle summary including `vehicleId`

### Navigation context
- If launched from within an account: preserve account context parameters (e.g., `accountId`) through the create flow and on success.
- If launched globally: no account context required unless backend mandates it (OQ).

### User workflows
**Happy path**
1. Service Advisor opens Create Vehicle screen.
2. Enters required fields: VIN, Unit Number, Description.
3. Optionally enters License Plate.
4. Submits.
5. UI shows success confirmation and navigates to vehicle view screen (or stays with success banner and a â€œView Vehicleâ€ action).

**Alternate paths**
- User cancels â†’ returns to previous screen without changes.
- Backend reports duplicate VIN (per uniqueness policy) â†’ user remains on form with field-level error and/or top banner.
- Validation failures (missing required, invalid VIN format) â†’ block submit and show inline errors.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œCreate Vehicleâ€ action from allowed entry points.

### UI actions
- Form input for:
  - VIN
  - Unit Number
  - Description (free text â€œMake/Model/Yearâ€)
  - License Plate (optional)
- Buttons:
  - **Save/Create** (primary)
  - **Cancel** (secondary)

### State changes (frontend)
- Form state: pristine/dirty, validation errors
- Submission state: loading/disabled while request in-flight
- On success: store returned `vehicleId` in navigation parameters and/or local state for the next screen

### Service interactions
- On load: none required (unless backend requires account context lookup)
- On submit: call Moqui service/API to create the vehicle record
- On success: navigate to VehicleView with `vehicleId`
- On failure: map error to user-visible messages (details in Service Contracts + Error Flows)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Required fields** (block submit; show inline error):
  - `vin` required
  - `unitNumber` required
  - `description` required
- **VIN basic sanity** (block submit; show inline error):
  - length must be exactly 17
  - must not include letters `I`, `O`, `Q`
  - allowed characters: Aâ€“Z and 0â€“9 (uppercase normalization allowed in UI)
- **License plate** optional; if provided, trim whitespace.

### Enable/disable rules
- â€œCreateâ€ button disabled while:
  - form invalid, or
  - submission in progress

### Visibility rules
- If VIN decode stub is present (optional), it must be clearly marked as â€œnot yet implementedâ€ and must not affect creation.

### Error messaging expectations
- Inline field errors for client-side validation.
- For backend validation (400): show top banner â€œFix validation errorsâ€ plus field mapping when possible.
- For duplicate/conflict (409): show message indicating likely duplicate vehicle; ideally highlight VIN field.

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Vehicle** (CRM-owned)
- **VehicleIdentifier** (if backend models identifiers separately; frontend treats as fields unless API requires nested structure)

### Fields
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| `vin` | string | Yes | none | Normalize to uppercase; trim |
| `unitNumber` | string | Yes | none | Trim |
| `description` | string | Yes | none | Free text make/model/year |
| `licensePlate` | string | No | null/empty | Trim; store null if empty |
| `accountId` | UUID/string | TBD | none | Only if backend requires vehicle creation within account context |
| `vehicleId` | UUID/string | Returned | n/a | Read-only, generated by backend |

### Read-only vs editable
- On create screen: all inputs editable.
- On post-create view: `vehicleId` read-only; display the submitted fields as persisted values.

### Derived/calculated fields
- `vinNormalized` (UI-only): uppercase/trimmed VIN used for validation and submission.

---

## 9. Service Contracts (Frontend Perspective)

> Backend story reference exists but does not specify concrete endpoint/service names for Moqui. This story defines required frontend expectations; exact wiring must align with actual Moqui services.

### Load/view calls
- **VehicleView load**
  - Input: `vehicleId`
  - Output: vehicle fields (vin, unitNumber, description, licensePlate, accountId if applicable)

### Create/update calls
- **Create Vehicle**
  - Input payload (minimum):
    - `vin`
    - `unitNumber`
    - `description`
    - `licensePlate` (optional)
    - `accountId` (if required)
  - Output:
    - `vehicleId` (required)
    - persisted vehicle summary (optional but preferred)

### Submit/transition calls
- None beyond create.

### Error handling expectations
- `400 Bad Request`: validation error(s) with field identifiers if possible.
- `401/403`: show â€œNot authorizedâ€ and prevent access to create screen (or show error state).
- `409 Conflict`: duplicate vehicle according to uniqueness rule; show duplicate message (VIN-focused).
- `5xx`: show generic â€œSomething went wrongâ€ with retry option.

---

## 10. State Model & Transitions

### Allowed states
- No explicit vehicle lifecycle states were provided; treat Vehicle as â€œactiveâ€ upon creation with no user-managed state.

### Role-based transitions
- Service Advisor can create (permission name TBD).

### UI behavior per state
- N/A (no lifecycle state in this story).

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing VIN/unit/description â†’ block submit; show inline error messages per field.
- Invalid VIN format â†’ block submit; message: â€œVIN must be 17 characters and cannot include I, O, or Q.â€

### Backend validation failures (400)
- Display returned message(s).
- Keep user-entered values intact.
- If backend returns field list, map to fields; else show banner only.

### Concurrency conflicts
- Not applicable for create; but if backend returns 409 due to uniqueness, treat as conflict and guide user.

### Unauthorized access (401/403)
- If user navigates directly to create URL: show access denied screen (or route to login if unauthenticated).
- Do not reveal existence of vehicles in conflict messaging beyond â€œalready existsâ€ (no sensitive data).

### Empty states
- If VehicleView load fails with 404: show â€œVehicle not foundâ€ and provide navigation back.

---

## 12. Acceptance Criteria

### Scenario 1: Successful vehicle creation
**Given** the Service Advisor is authenticated and authorized to create vehicles  
**And** they are on the Vehicle Create screen  
**When** they enter a valid VIN `1HGCM82633A004352`, unit number `TRK-102`, and description `2018 Ford F-150`  
**And** they optionally enter license plate `ABC123`  
**And** they submit the form  
**Then** the frontend sends a create request with those fields (VIN normalized to uppercase)  
**And** the backend returns a new `vehicleId`  
**And** the UI shows a success confirmation  
**And** the UI navigates to Vehicle View with that `vehicleId` (or displays the created record including `vehicleId`).

### Scenario 2: Client-side validation blocks missing required fields
**Given** the Service Advisor is on the Vehicle Create screen  
**When** they leave `unitNumber` empty  
**And** they click Create  
**Then** the form must not submit  
**And** an inline error indicates `unitNumber` is required.

### Scenario 3: Client-side validation blocks invalid VIN format
**Given** the Service Advisor is on the Vehicle Create screen  
**When** they enter VIN `12345`  
**And** they click Create  
**Then** the form must not submit  
**And** an inline error indicates VIN must be 17 characters.

### Scenario 4: Backend rejects duplicate VIN (409)
**Given** VIN uniqueness scope is defined by the backend  
**And** a vehicle already exists that conflicts with VIN `1HGCM82633A004352` per that policy  
**When** the Service Advisor submits a create request with VIN `1HGCM82633A004352` and other valid fields  
**Then** the backend responds with HTTP 409  
**And** the UI remains on the create form  
**And** the UI displays an error message indicating the VIN already exists (without exposing sensitive details).

### Scenario 5: Unauthorized user cannot access create
**Given** a user is authenticated but lacks permission to create vehicles  
**When** they attempt to open the Vehicle Create screen  
**Then** the UI denies access (403 handling) and does not show the create form.

---

## 13. Audit & Observability

### User-visible audit data
- On VehicleView, display at minimum:
  - `vehicleId`
  - created timestamp and created-by (only if backend exposes; otherwise omit)

### Status history
- Not applicable (no lifecycle states defined).

### Traceability expectations
- Frontend must include correlation/request id headers if standard in the project (if Moqui config provides).
- Log (frontend console/logger) a single info-level event on successful creation including `vehicleId` (no VIN in logs unless workspace policy allows PII-like data; VIN may be considered sensitiveâ€”treat cautiously).

---

## 14. Non-Functional UI Requirements
- **Performance:** Create submit should show loading state immediately; avoid duplicate submissions.
- **Accessibility:** All inputs labeled; validation errors announced to screen readers; keyboard navigable.
- **Responsiveness:** Form usable on tablet widths typical for POS.
- **i18n/timezone/currency:** No currency; timestamps (if shown) must render in user timezone per app standard; strings should be compatible with i18n (no hardcoded concatenation).

---

## 15. Applied Safe Defaults
- **SD-UI-EMPTY-STATE**: Provide a simple â€œVehicle not foundâ€ empty state on 404 in VehicleView; safe because itâ€™s UI ergonomics and does not alter domain logic. (Sections: UX Summary, Error Flows)
- **SD-UI-SUBMIT-LOCK**: Disable the Create button and show loading during in-flight request to prevent double submits; safe UX pattern with no domain policy impact. (Sections: Functional Behavior, Non-Functional)
- **SD-ERR-GENERIC-5XX**: Map unknown/5xx errors to a generic retryable message; safe because itâ€™s standard error handling without changing business rules. (Sections: Service Contracts, Error Flows)

---

## 16. Open Questions
1. **VIN uniqueness scope (blocking):** Is VIN uniqueness **global** across all accounts or **scoped per account**? How should the frontend message differ (if at all)?
2. **Account context requirement (blocking):** Does vehicle creation require an `accountId`/customer context? If yes, what is the source in the frontend routing (route param, session context, selected customer)?
3. **Moqui service/API contract (blocking):** What are the exact Moqui service names or REST endpoints for:
   - create vehicle
   - load vehicle by `vehicleId`
   Include request/response schema and error payload shape for field-level mapping.
4. **Authorization model (blocking):** What permission/scope/role gates vehicle creation in the frontend? (e.g., `crm.vehicle.create`)
5. **License plate structure (clarification):** Is license plate stored as a single string, or plate + state/province? (Story implies single field; confirm.)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Vehicle: Create Vehicle Record with VIN and Description â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/169


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Vehicle: Create Vehicle Record with VIN and Description
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/169
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Vehicle: Create Vehicle Record with VIN and Description

**Domain**: payment

### Story Description

/kiro
# User Story

## Narrative
As a **Service Advisor**, I want **to create a vehicle record with VIN, unit number, and description** so that **future service and billing can be linked to the correct vehicle**.

## Details
- Capture VIN, make/model/year (free text initially), unit number, license plate (optional).
- Minimal VIN format validation; external decode optional stub.

## Acceptance Criteria
- Can create vehicle with VIN.
- Vehicle has stable Vehicle ID.
- VIN uniqueness rule defined (global or per account).

## Integration Points (Workorder Execution)
- Workorder Execution selects vehicle for estimate/workorder; Vehicle ID stored on workorder.

## Data / Entities
- Vehicle
- VehicleIdentifier (VIN, unit, plate)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #170: [FRONTEND] [STORY] Contacts: Capture Multiple Contact Points â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/170
File: ./scripts/story-work/frontend/170/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] CRM Contacts: Manage Multiple Contact Points (Email/Phone) with Primary per Kind

**Primary Persona:** CSR (Customer Service Representative)

**Business Value:** Enables reliable customer communication by storing multiple labeled emails/phone numbers and selecting a primary per kind for downstream usage (e.g., approvals and invoice delivery in Workorder Execution).

---

## 2. Story Intent

**As a** CSR,  
**I want** to add, edit, remove, and mark primary phone numbers and email addresses for a customer (person or account),  
**So that** I can contact them using the correct method and downstream systems can display the right contact details.

### In-scope
- View a customerâ€™s existing contact points (EMAIL/PHONE) with label tags (WORK/HOME/MOBILE/OTHER) and primary indicator per kind.
- Add a new contact point (kind + value + optional label + primary flag).
- Edit an existing contact point (value, label, primary flag).
- Remove an existing contact point.
- Enforce â€œsingle primary per kindâ€ behavior in UI (and reflect backend enforcement).
- Basic formatting validation for email and phone **on the client** (non-authoritative; backend remains source of truth).

### Out-of-scope
- Customer deduplication/merge, golden record rules, uniqueness policy beyond what backend enforces.
- Customer hierarchy/relationships management.
- Communication consent/preferences (SMS/email marketing consent).
- Workorder Execution UI changes (consumer behavior only referenced).
- Bulk import/export of contact points.

---

## 3. Actors & Stakeholders

- **CSR (Primary Actor):** Manages contact points on a customer record.
- **Customer (Subject):** Person or account whose contact points are stored.
- **Workorder Execution (Downstream Consumer):** Reads contact points for approvals/invoice delivery display.
- **CRM Domain Services (System):** Provides authoritative validation, persistence, and â€œsingle primary per kindâ€ enforcement.

---

## 4. Preconditions & Dependencies

### Preconditions
- CSR is authenticated in the frontend session.
- CSR is authorized to view and manage contact points for the selected customer.

### Dependencies
- A customer context exists (at minimum a `partyId`/`customerId` identifier) to load/save contact points.
- Backend endpoints or Moqui services exist (or will be delivered) to:
  - List contact points for a customer
  - Create contact point
  - Update contact point
  - Delete contact point
  - Enforce single-primary-per-kind server-side

### Blocking dependency (needs clarification)
- Confirm whether contact points attach to **Person only**, **Account/Organization only**, or **generic Party (Person or Organization)** and what identifier the frontend should use (`partyId` vs `personId` vs `accountId`).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a **Customer Detail** screen (person/account), via a navigation item/tab: **â€œContactsâ€** or **â€œContact Pointsâ€**.

### Screens to create/modify
1. **Modify existing customer detail screen** to include a â€œContact Pointsâ€ section OR create a child screen:
   - Suggested path (placeholder): `apps/pos/screen/crm/customer/CustomerDetail.xml` with a subscreen `ContactPoints.xml`
2. **ContactPoints screen/component**:
   - Displays list grouped by `kind` (EMAIL, PHONE) with primary marked.
   - Actions: Add, Edit, Remove; Set Primary (either via edit or quick action).

### Navigation context
- Breadcrumb: Customer Search â†’ Customer Detail â†’ Contact Points.
- Customer identity header should show minimal context (e.g., customer display name and ID) without exposing sensitive data beyond whatâ€™s already allowed.

### User workflows
**Happy path**
1. CSR opens customer â†’ Contact Points.
2. CSR clicks â€œAdd Emailâ€ or â€œAdd Phoneâ€.
3. CSR enters value, label, optionally sets as primary â†’ Save.
4. List refreshes, primary indicators updated.

**Alternate paths**
- Edit existing contact point: change label/value, optionally toggle primary.
- Remove contact point: confirm deletion; list refreshes.
- Set primary when another primary exists: UI warns/indicates that previous primary will be demoted; after save, list shows only one primary for that kind.

---

## 6. Functional Behavior

### Triggers
- Screen load with `customerId/partyId` parameter.
- User actions: add/edit/delete/set primary.

### UI actions
- **Load list:** On screen render, call load service to fetch contact points for customer.
- **Add:** Open modal/dialog or inline form for new contact point.
- **Edit:** Open modal/dialog prefilled with selected contact point fields.
- **Delete:** Show confirmation dialog; on confirm, call delete; refresh list.
- **Set primary:** Either:
  - via edit form checkbox `isPrimary`, or
  - via list action â€œMake Primaryâ€ that triggers update with `isPrimary=true`.

### State changes (client-side)
- Local form state transitions: `idle â†’ editing â†’ saving â†’ success|error`.
- After any successful create/update/delete, re-fetch contact points to reflect server-side demotion logic.

### Service interactions (Moqui)
- Use Moqui screen transitions calling services (or REST calls if frontend uses API gatewayâ€”must be clarified by repo conventions).
- Service errors map to field-level or form-level messages (see Â§9).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (client-side, non-authoritative)
- `kind` required; must be `EMAIL` or `PHONE`.
- `value` required.
- If `kind=EMAIL`: must match basic email pattern (e.g., contains `@` and domain). On failure: block save and show â€œInvalid email formatâ€.
- If `kind=PHONE`: basic phone validation (digits + allowed separators). On failure: block save and show â€œInvalid phone number formatâ€.
- `label` optional; if provided must be one of `WORK`, `HOME`, `MOBILE`, `OTHER`.
- `isPrimary` defaults false.

### Enable/disable rules
- Save disabled until required fields valid.
- While saving, disable inputs and prevent duplicate submits.

### Visibility rules
- Show primary indicator per contact point (e.g., â€œPrimaryâ€ badge).
- Group or filter by kind (EMAIL/PHONE) for clarity.

### Error messaging expectations
- Backend validation errors should be shown near the relevant field when possible; otherwise as a form banner.
- Duplicate contact point attempt should show a specific message if backend returns a recognizable error (e.g., â€œThat email already exists for this customer.â€).

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `ContactPoint` (CRM-owned)
- Customer identifier entity/context: `Party` / `Person` / `Organization` (needs clarification which identifier is used by frontend).

### Fields
**ContactPoint**
- `id` (UUID, read-only, required for edit/delete)
- `customerId` or `partyId` (UUID, read-only in UI; supplied from page context)
- `kind` (enum: `PHONE`, `EMAIL`; required; editable on create; **clarify** if editable on update)
- `label` (enum: `WORK`, `HOME`, `MOBILE`, `OTHER`; optional)
- `value` (string; required)
- `isPrimary` (boolean; required; default false)

### Read-only vs editable by state/role
- CSR with proper permission: may create/update/delete.
- If CSR lacks permission: screen shows read-only list and hides add/edit/delete actions; unauthorized service calls must show â€œNot authorizedâ€.

### Derived/calculated fields
- `displayValue` (derived formatting for phone/email for display; non-persistent).
- `kindGroupTitle` (EMAIL/PHONE headings; non-persistent).

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact service names/REST routes must follow `durion-moqui-frontend` conventions (needs repo confirmation). Below defines required capabilities and expected payloads.

### Load/view calls
- **LoadContactPoints**
  - Input: `{ customerId|partyId: UUID }`
  - Output: `{ contactPoints: ContactPoint[] }` sorted with primary first within each kind (preferred but not required; UI may sort).

### Create/update calls
- **CreateContactPoint**
  - Input: `{ customerId|partyId, kind, value, label?, isPrimary }`
  - Success: returns created `ContactPoint` (including `id`) OR 201 + id.
  - Errors:
    - 400 validation (invalid format, invalid enums)
    - 409 conflict (duplicate contact point) â€” if backend uses it
    - 403 unauthorized
- **UpdateContactPoint**
  - Input: `{ id, value, label?, isPrimary }` (+ `kind` only if backend allows changing kind; must be clarified)
  - Success: returns updated ContactPoint.
  - Side-effect: if `isPrimary=true`, backend demotes prior primary of same kind.

### Delete calls
- **DeleteContactPoint**
  - Input: `{ id }`
  - Success: 204 or success response.
  - If deleting primary: allowed; no auto-promotion (UI must reflect that after refresh).

### Error handling expectations
- Map structured backend errors to:
  - field errors: attach to `value`, `label`, `kind`
  - general errors: show banner
- Always re-enable UI after error; do not lose user input on validation failures.

---

## 10. State Model & Transitions

### Allowed states (UI-level)
- `Viewing` (list)
- `Adding` (create form active)
- `Editing` (edit form active)
- `Saving` (pending service response)
- `Error` (recoverable; user can retry/correct)

### Role-based transitions
- Authorized CSR:
  - Viewing â†’ Adding/Editing â†’ Saving â†’ Viewing
  - Viewing â†’ Deleting(confirm) â†’ Saving â†’ Viewing
- Unauthorized user:
  - Viewing only; any attempted transition to Saving should be blocked client-side if permissions known; otherwise handle 403.

### UI behavior per state
- Saving: disable form, show spinner/progress, prevent navigation if it would lose unsaved changes (confirm dialog).

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid email/phone format: block save; show inline error on `value`.
- Missing required: show required indicators; save disabled.

### Concurrency conflicts
- If backend returns 409/412 due to stale update (if supported): show â€œThis contact was updated by someone else. Refresh and try again.â€ and refresh list.

### Unauthorized access
- On 403 during load: show â€œYou do not have access to this customerâ€™s contact details.â€
- On 403 during mutation: show â€œNot authorized to modify contact points.â€

### Empty states
- No contact points: show empty state text:
  - â€œNo email addresses on file.â€ and â€œNo phone numbers on file.â€
  - Provide Add action if authorized.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View contact points
**Given** I am an authorized CSR  
**And** a customer exists with 1 email and 1 phone contact point  
**When** I open the customerâ€™s Contact Points screen  
**Then** I see the email and phone displayed with their labels and primary indicators  
**And** the primary contact point for each kind is clearly indicated

### Scenario 2: Add a non-primary phone contact point
**Given** I am an authorized CSR  
**And** I am viewing a customerâ€™s Contact Points  
**When** I add a new PHONE contact point with label MOBILE, value "555-123-4567", and isPrimary=false  
**Then** the new contact point appears in the PHONE list after save  
**And** no existing primary PHONE contact point is changed

### Scenario 3: Add an email as primary when none exists
**Given** I am an authorized CSR  
**And** the customer has no primary EMAIL contact point  
**When** I add a new EMAIL contact point with isPrimary=true  
**Then** it is displayed as the primary EMAIL contact point after save

### Scenario 4: Change primary within a kind (demotion)
**Given** I am an authorized CSR  
**And** the customer has two PHONE contact points where Phone A is primary and Phone B is not  
**When** I update Phone B to set isPrimary=true  
**Then** Phone B is shown as primary after save  
**And** Phone A is shown as not primary after save  
**And** there is only one primary PHONE contact point displayed

### Scenario 5: Delete a contact point
**Given** I am an authorized CSR  
**And** the customer has at least one EMAIL contact point  
**When** I delete one EMAIL contact point and confirm deletion  
**Then** it no longer appears in the EMAIL list after save

### Scenario 6: Client-side invalid email format is blocked
**Given** I am an authorized CSR  
**When** I attempt to add an EMAIL contact point with value "invalid-email-address"  
**Then** the Save action is disabled or blocked  
**And** I see an error message â€œInvalid email formatâ€ associated with the value field

### Scenario 7: Backend rejects duplicate contact point
**Given** I am an authorized CSR  
**And** the customer already has an EMAIL contact point with value "a@b.com"  
**When** I attempt to add another EMAIL contact point with value "a@b.com"  
**Then** the save fails  
**And** I see an error message indicating the contact point already exists  
**And** no duplicate is added to the list

### Scenario 8: Unauthorized user cannot edit
**Given** I am authenticated but not authorized to modify customer contact points  
**When** I open the Contact Points screen  
**Then** I can view contact points if permitted  
**And** I do not see Add/Edit/Delete actions  
**When** I attempt to call a mutation action (e.g., via direct URL or intercepted request)  
**Then** the UI shows a â€œNot authorizedâ€ error and no changes occur

---

## 13. Audit & Observability

### User-visible audit data
- Not required to display audit history in this story.

### Status history
- Not applicable (no lifecycle states beyond primary flags).

### Traceability expectations
- Frontend should include correlation/request ID headers if that is a project convention (needs repo confirmation).
- Log (frontend console/dev logging per conventions) minimal contextual info on failures: customerId, contactPointId (if applicable), operation typeâ€”avoid logging contact `value` to reduce PII leakage.

---

## 14. Non-Functional UI Requirements

- **Performance:** Initial load should render list within 1s under normal conditions once data is returned; avoid unnecessary reloads (but refresh after mutations is required).
- **Accessibility:** All actions keyboard-navigable; dialogs have focus trap; form fields have labels and error text announced (Quasar best practices).
- **Responsiveness:** Works on tablet resolutions commonly used at POS; list layout adapts without horizontal scrolling where possible.
- **i18n/timezone/currency:** Not applicable (no currency/time). Text should be written in a way compatible with future i18n (no concatenated hard-coded fragments in logic).

---

## 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE**
  - **Assumed:** Provide explicit empty-state messaging per kind and show Add action if authorized.
  - **Why safe:** Pure UX guidance; does not change domain rules or persistence.
  - **Impacted sections:** UX Summary, Alternate / Error Flows, Acceptance Criteria.
- **SD-UX-POST-MUTATION-REFRESH**
  - **Assumed:** Re-fetch contact points after create/update/delete to reflect server-side primary demotion and canonical ordering.
  - **Why safe:** Ensures UI matches source-of-truth backend outcomes; no policy invented.
  - **Impacted sections:** Functional Behavior, Service Contracts, Acceptance Criteria.
- **SD-ERR-MAP-GENERIC**
  - **Assumed:** Map unknown server errors to a generic banner message and preserve user input.
  - **Why safe:** Standard error handling; does not alter business logic.
  - **Impacted sections:** Business Rules, Service Contracts, Alternate / Error Flows.

---

## 16. Open Questions

1. **Customer Identifier / Attachment:** Are contact points attached to a generic **Party** (person or organization) or specifically to **Person** and/or **Account**? What is the canonical identifier passed in routes and service calls (`partyId`, `personId`, `customerId`)?
2. **Kind Mutability:** Is `kind` editable on an existing contact point (e.g., change EMAIL â†’ PHONE), or immutable after creation?
3. **UI Location/Route Convention:** What is the correct Moqui screen path and navigation entry for customer contact points in this repo (which customer detail screen is authoritative)?
4. **Backend Contract Shape:** Are we calling Moqui services directly (screen transitions) or a REST API layer? If REST, what are the exact endpoints and error payload schema for validation/duplicate conflicts?
5. **Phone Validation Policy:** What constitutes â€œbasic formatting validationâ€ for phones in this product (E.164, digits-only, allow extensions)? Client-side validation needs an explicit rule to avoid blocking valid numbers.
6. **Permissions Model:** What role/scope controls â€œmanage contact pointsâ€ vs â€œview contact pointsâ€ for CSRs in the frontend?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Contacts: Capture Multiple Contact Points â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/170


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Contacts: Capture Multiple Contact Points
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/170
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Contacts: Capture Multiple Contact Points

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **CSR**, I want **to store multiple phone numbers and emails per person/account** so that **I can reach them via the right contact point**.

## Details
- Support type tags: work, mobile, home.
- Basic formatting validation.

## Acceptance Criteria
- Add/update/remove contact points.
- Identify primary contact point per type.

## Integration Points (Workorder Execution)
- Workorder Execution displays contact points during approval/invoice delivery.

## Data / Entities
- ContactPoint (type, value, primaryFlag)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #171: [FRONTEND] [STORY] Contacts: Store Communication Preferences and Consent Flags â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/171
File: ./scripts/story-work/frontend/171/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Contacts: Manage Communication Preferences & Consent Flags (Per Person)

### Primary Persona
Customer Service Representative (CSR)

### Business Value
Ensure outbound communications (notifications/marketing) follow the customerâ€™s stated preferred channel and consent choices, improving compliance and customer experience while providing an auditable record of changes.

---

## 2. Story Intent

### As a / I want / So that
- **As a** CSR  
- **I want** to view and update a personâ€™s communication preferences (preferred channel + email/SMS consent flags)  
- **So that** communications adhere to customer preferences and consent, with a clear audit trail.

### In-scope
- UI to **view** and **edit** a personâ€™s:
  - preferred communication channel
  - email marketing consent flag
  - SMS notification consent flag
  - â€œlast updatedâ€ timestamp and â€œupdate sourceâ€ (viewable; source may be system-populated)
- Moqui screen(s), forms, transitions, and service calls required for:
  - load existing preferences for a person
  - create initial preference record if missing
  - update existing preference record
- Standard error handling and empty states
- Basic role-gating for CSR access (exact permission name is an open question)

### Out-of-scope
- Defining or changing CRM domain business rules (controlled vocabularies, lifecycle policies)
- Customer dedup/merge behavior
- Workorder Execution notification sending logic (consumer use is â€œstubbedâ€)
- Bulk updates across multiple people
- Managing contact points (emails/phones) themselves

---

## 3. Actors & Stakeholders
- **CSR (primary user):** updates preferences on behalf of a customer/person.
- **Customer/Person:** whose preferences are recorded.
- **Downstream consumers (e.g., Workorder Execution):** read preferences to choose channel; not modified here.
- **CRM backend services:** system of record for preferences and audit metadata.

---

## 4. Preconditions & Dependencies
- CSR is authenticated in the POS frontend.
- CSR is authorized to view/edit CRM contact data (permission/scope naming TBD).
- A **Person/Party** record exists and the CSR is operating in that personâ€™s context (personId/partyId).
- Backend endpoints/services exist (or will exist per backend story #107) to:
  - retrieve a personâ€™s communication preference record
  - create/update it
- Frontend has a consistent mechanism to attach correlation/request IDs and handle 401/403/404/409/500.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an existing **Contact/Person detail** area in POS:
  - â€œCommunication Preferencesâ€ section/tab/panel.
- Direct navigation URL (suggested Moqui route; exact base path depends on app conventions):
  - `/crm/contact/preferences?partyId=<id>` or nested under contact detail screen.

### Screens to create/modify
- **Modify existing Contact/Person detail screen** to include a â€œCommunication Preferencesâ€ section.
- **New or nested screen** for edit flow if not inline:
  - Screen: `apps/pos/screens/crm/contact/CommunicationPreferences.xml` (name illustrative; align with repo conventions)

### Navigation context
- Breadcrumb: Contacts â†’ {Person Name} â†’ Communication Preferences
- Must maintain the selected person context (partyId/personId) across transitions.

### User workflows
**Happy path (existing preferences)**
1. CSR opens person record.
2. UI loads current preference record.
3. CSR edits preferred channel and/or consent flags.
4. CSR saves; UI shows success and updated â€œlast updated/sourceâ€.

**Happy path (no preferences yet)**
1. CSR opens person record.
2. UI shows â€œNo preferences recorded yetâ€.
3. CSR enters values and saves.
4. UI now shows persisted values + audit metadata.

**Alternate paths**
- CSR cancels edits â†’ no changes persisted.
- Backend validation error â†’ show field-level errors where possible.
- Unauthorized â†’ show access denied message and disable editing.
- Person not found â†’ show not found state and link back to search.

---

## 6. Functional Behavior

### Triggers
- Entering the Communication Preferences view for a specific person.
- Clicking â€œEditâ€ (if read-only view by default) or editing inline.
- Clicking â€œSaveâ€.

### UI actions
- View mode:
  - Display preferred channel, consent flags, last updated timestamp (UTC rendered in local time), update source.
- Edit mode:
  - Preferred channel selection control (controlled vocabulary).
  - Consent flags toggles (Email marketing, SMS notifications).
  - Save/Cancel actions.
- Save action:
  - Calls backend create/update service.
  - Shows success toast/alert and returns to view mode.

### State changes (frontend)
- `loading` â†’ `loaded`
- `editing` toggles
- `saving` â†’ `saved` or `error`
- Local dirty-tracking to prevent accidental navigation loss (confirm dialog)

### Service interactions (frontend â†’ Moqui/backend)
- On load: fetch preference by person identifier.
- On save:
  - If record exists: update call.
  - If record missing: create call (or upsert if backend supports).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Preferred channel:
  - Must be one of allowed enum values: `EMAIL`, `SMS`, `PHONE`, `NONE` (from backend story).
  - UI must prevent submission if not selected **(unless backend allows null; backend says Not Null)**.
- Consent flags:
  - UI must submit booleans or null per backend contract.
  - UI must clearly communicate that â€œunset/nullâ€ is treated as **opt-out** downstream (per backend rule).
- updateSource:
  - Mandatory per backend rule.
  - UI must provide a value or ensure the integration layer supplies it consistently.

### Enable/disable rules
- If user lacks edit permission:
  - Fields are read-only; hide/disable Save; show informational banner.
- While saving:
  - Disable inputs and Save to prevent duplicate submits.

### Visibility rules
- If no record exists:
  - Show empty-state copy and â€œAdd preferencesâ€ CTA.
- Always show audit metadata when available:
  - `updatedTimestampUTC`
  - `updateSource`

### Error messaging expectations
- 400 validation errors:
  - Show a top-level â€œFix the highlighted fieldsâ€ message.
  - Map known field errors to corresponding controls (channel/consents).
- 403:
  - â€œYou donâ€™t have permission to update communication preferences.â€
- 404:
  - If person not found: â€œContact not found.â€
  - If preference not found (but person exists): treat as empty state, not error (depends on backend response; see Open Questions).
- 409:
  - Show â€œPreferences were updated by someone else. Reload and try again.â€ (if backend supports optimistic locking/versioning; otherwise open question).

---

## 8. Data Requirements

### Entities involved (conceptual; CRM-owned)
- `CommunicationPreference` (primary)
- `ConsentRecord` (mentioned in frontend prompt; backend story uses two boolean fieldsâ€”needs clarification whether a separate entity exists)

### Fields (frontend)
**Identifier/context**
- `partyId` or `customerId` (UUID) â€” required context to load/save.

**Editable**
- `preferredCommunicationChannel` (Enum; required)
- `emailMarketingConsent` (Boolean nullable)
- `smsNotificationConsent` (Boolean nullable)

**Read-only (display)**
- `updatedTimestampUTC` (DateTime UTC)
- `updateSource` (String)

### Defaults
- Consent flags:
  - If backend returns null: display as â€œNot given / Opted out (default)â€ (wording must be confirmed).
- Preferred channel:
  - No default should be assumed unless backend defines one (do not guess).

### Read-only vs editable by state/role
- CSR with edit permission: editable fields above.
- Without permission: all fields read-only.

### Derived/calculated fields
- â€œEffective consentâ€ display helper:
  - If value is `true` â†’ â€œOpted inâ€
  - If `false` or `null` â†’ â€œOpted outâ€ (but preserve null vs false in edit UI if backend distinguishes)

---

## 9. Service Contracts (Frontend Perspective)

> Note: exact service names/routes in Moqui are not provided in inputs; these are **integration placeholders** and require confirmation (see Open Questions). The frontend must be written to a stable contract.

### Load/view calls
- **Operation:** Get communication preferences for a person
- **Input:** `partyId` (UUID)
- **Expected outcomes:**
  - `200 OK` with `CommunicationPreference` payload
  - `404 Not Found` if person does not exist
  - Either `404` (preference missing) or `200` with empty/null object (needs clarification)

### Create/update calls
- **Operation:** Create or update preferences
- **Input payload:**
  - `partyId`/`customerId` (UUID)
  - `preferredCommunicationChannel` (Enum)
  - `emailMarketingConsent` (Boolean|null)
  - `smsNotificationConsent` (Boolean|null)
  - `updateSource` (String) â€” must be sent or injected
- **Expected outcomes:**
  - `201 Created` for initial create OR `200 OK` for update (exact codes TBD)
  - `400 Bad Request` for validation issues
  - `403 Forbidden` if unauthorized
  - `404 Not Found` if person missing
  - `409 Conflict` if concurrency/version conflict (if implemented)

### Submit/transition calls
- Not a lifecycle workflow; no additional transitions beyond save/cancel UI transitions.

### Error handling expectations
- Errors must be surfaced non-destructively with:
  - preserved form state
  - clear message
  - ability to retry
- Logs/telemetry: client-side capture of failure with correlation id (if available) without exposing PII.

---

## 10. State Model & Transitions

### Allowed states (UI-level)
- `VIEW` (loaded, not editing)
- `EDIT` (dirty tracking enabled)
- `SAVING`
- `ERROR` (recoverable)

### Role-based transitions
- CSR with permission:
  - VIEW â†’ EDIT â†’ SAVING â†’ VIEW
- CSR without permission:
  - VIEW only; EDIT not allowed

### UI behavior per state
- VIEW: show values + metadata; show Edit button if permitted.
- EDIT: show inputs + Save/Cancel; show warning on navigation if dirty.
- SAVING: disable inputs; show progress indicator.
- ERROR: show error banner and allow retry or cancel.

---

## 11. Alternate / Error Flows

### Validation failures (400)
- Backend returns validation errors (invalid enum, wrong types).
- UI maps:
  - `preferredCommunicationChannel` invalid â†’ field error â€œSelect a valid channel.â€
  - consent invalid â†’ field error â€œConsent must be yes/no/unset.â€
  - missing updateSource â†’ blocking error (should not occur if UI injects)

### Concurrency conflicts (409) â€” if supported
- When save returns 409:
  - UI prompts reload; offer â€œReload preferencesâ€ action that re-fetches and discards local edits (after confirmation).

### Unauthorized access (401/403)
- 401: redirect to login/session renewal per app convention.
- 403: stay on page, disable editing, show banner.

### Empty states
- No preference record:
  - Show empty state + Add button (enters EDIT with blank form).
- No person context / missing partyId:
  - Show error and link back to Contacts search.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View existing communication preferences
**Given** I am an authenticated CSR with permission to view CRM contacts  
**And** I am viewing a person with an existing CommunicationPreference record  
**When** I open the â€œCommunication Preferencesâ€ section  
**Then** I see the preferred communication channel  
**And** I see the email marketing consent value  
**And** I see the SMS notification consent value  
**And** I see â€œlast updatedâ€ timestamp and â€œupdate sourceâ€.

### Scenario 2: Create preferences when none exist
**Given** I am an authenticated CSR with permission to edit CRM contacts  
**And** I am viewing a person with no existing CommunicationPreference record  
**When** I choose â€œAdd preferencesâ€  
**And** I set preferred channel to â€œEMAILâ€  
**And** I set email marketing consent to opt-in  
**And** I set SMS notification consent to opt-out  
**And** I click â€œSaveâ€  
**Then** the system persists the preferences  
**And** I return to view mode showing the saved values  
**And** the â€œlast updatedâ€ timestamp is populated  
**And** the â€œupdate sourceâ€ is populated with the configured CSR source identifier.

### Scenario 3: Update only the preferred channel and keep other fields unchanged
**Given** I am an authenticated CSR with permission to edit CRM contacts  
**And** a person has existing preferences with preferred channel â€œEMAILâ€ and email marketing consent set to opt-in  
**When** I edit the preferences and change preferred channel to â€œSMSâ€  
**And** I click â€œSaveâ€  
**Then** the preferred channel is â€œSMSâ€  
**And** the email marketing consent remains opt-in  
**And** the SMS notification consent remains unchanged  
**And** the â€œlast updatedâ€ timestamp is updated.

### Scenario 4: Display null consent as opt-out (informational)
**Given** I am an authenticated CSR with permission to view CRM contacts  
**And** a personâ€™s SMS notification consent is null  
**When** I view the Communication Preferences section  
**Then** the UI indicates SMS consent is not granted (treated as opted out by default)  
**And** the raw value remains unchanged unless I explicitly set it.

### Scenario 5: Validation error on invalid preferred channel
**Given** I am an authenticated CSR with permission to edit CRM contacts  
**When** I attempt to save preferences with an invalid preferred channel value  
**Then** the save fails with a validation error  
**And** I see an error message indicating the channel is invalid  
**And** my entered values remain on screen for correction.

### Scenario 6: Unauthorized edit attempt
**Given** I am an authenticated CSR without permission to edit CRM contacts  
**When** I open the Communication Preferences section  
**Then** I can view the existing values (if authorized to view)  
**And** I cannot edit or save changes  
**And** I see a message indicating I lack permission to update preferences.

---

## 13. Audit & Observability

### User-visible audit data
- Display:
  - `updatedTimestampUTC` (rendered in user locale/timezone)
  - `updateSource` (string identifier)
- If backend provides actor name/id, show only if permitted and not sensitive (not required by this story).

### Status history
- Not required unless backend provides audit history endpoint (out of scope). Only â€œlast updatedâ€ is required.

### Traceability expectations
- Frontend should attach/request a correlation ID (if app standard) and log:
  - page load failures
  - save failures
  - 403/409 occurrences
- Do not log customer PII beyond identifiers already in URL/context.

---

## 14. Non-Functional UI Requirements
- **Performance:** Preference load should not block rendering of the rest of contact detail; show skeleton/loading indicator for this section.
- **Accessibility:** All controls keyboard-navigable; toggles have accessible labels; error messages announced (ARIA).
- **Responsiveness:** Works on tablet-sized POS devices; form fields stack vertically on narrow widths.
- **i18n/timezone:** Render UTC timestamp in local timezone; all labels/messages use i18n keys if project convention exists.
- **Security:** Do not expose preferences in console logs; respect authorization errors without leaking details.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a standard empty-state message and â€œAdd preferencesâ€ CTA when no preference record exists; safe because it does not change business rules, only UI affordance. (Impacted: UX Summary, Error Flows)
- SD-ERR-MAP-HTTP: Map HTTP 400/401/403/404/409/500 into consistent toast/banner patterns; safe because it follows backend status semantics without inventing policies. (Impacted: Business Rules, Service Contracts, Error Flows)
- SD-UX-DIRTY-CONFIRM: Add dirty-form navigation confirmation on unsaved edits; safe because itâ€™s UI ergonomics only. (Impacted: Functional Behavior, UX Summary)

---

## 16. Open Questions
1. **Identifier naming:** In frontend context, is the person key `partyId`, `personId`, or `customerId`? Which is passed in routes and to services?
2. **Backend contract specifics:** What are the exact endpoints or Moqui services to call for:
   - load preferences
   - create/update preferences  
   (Include request/response schemas and error payload format.)
3. **Missing record behavior:** When a person exists but has no preferences yet, does the backend return:
   - `404` (preference not found), or
   - `200` with null/empty payload?
4. **updateSource handling:** Should the frontend send `updateSource` explicitly (e.g., constant `CSR_PORTAL`), or will Moqui/backend infer it from authenticated client/app? If constant, what is the exact required value?
5. **ConsentRecord entity:** Does the frontend need to manage a separate `ConsentRecord` entity, or are consent flags only fields on `CommunicationPreference` (as in backend story #107)?
6. **Authorization model:** What permission/role controls viewing vs editing communication preferences in the POS frontend (exact roles/scopes)? Should view be allowed when edit is denied?
7. **Optimistic locking:** Is there a version/ETag field to include for concurrency control? If yes, what field and how should 409 be resolved (reload vs overwrite)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Contacts: Store Communication Preferences and Consent Flags â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/171

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Contacts: Store Communication Preferences and Consent Flags
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/171
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Contacts: Store Communication Preferences and Consent Flags

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **CSR**, I want **to record preferred channel and opt-in/opt-out flags** so that **communications follow customer preferences**.

## Details
- Per-person preferences: preferred channel; basic consent flags for SMS/email.
- Track last-updated and source.

## Acceptance Criteria
- Can set/get preferences.
- Consent flags are available via API.
- Audit is captured.

## Integration Points (Workorder Execution)
- Workorder Execution uses preferences to select notification channel (stubbed initially).

## Data / Entities
- CommunicationPreference
- ConsentRecord

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

BACKEND STORY REFERENCES (FOR REFERENCE ONLY)

----------------------------------------------------------------------------------------------------

Backend matches (extracted from story-work):


[1] backend/107/backend.md

    Labels: type:story, domain:crm, status:ready-for-dev

----------------------------------------------------------------------------------------------------

END BACKEND REFERENCES

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #172: [FRONTEND] [STORY] Contacts: Maintain Contact Roles and Primary Flags  
File: ./scripts/story-work/frontend/172/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm
- agent:story-authoring

### Blocking / Risk
- blocked:domain-conflict
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** integration-conservative

## 1. Story Header

### Title
Contacts: Maintain Contact Roles and Primary Flags (Billing / Approver / Driver)

### Primary Persona
CSR (Customer Service Representative)

### Business Value
Ensures downstream workflows (estimate approval and invoice delivery) consistently target the correct contact(s) by role, with an optional enforcement rule for billing contacts when invoices are delivered by email.

---

## 2. Story Intent

### As a / I want / So that
- **As a** CSR  
- **I want** to assign one or more roles (Billing, Approver, Driver) to contacts on a customer account and optionally mark one contact as â€œprimaryâ€ per role  
- **So that** estimate approvals and invoicing use the correct person automatically and consistently.

### In Scope
- View existing contacts for a customer account and their role assignments.
- Assign/unassign one or more roles to a contact for that account.
- Mark/unmark a contact as **Primary** for a given role (enforce single-primary-per-role per account).
- Enforce validation when configured: **at least one Billing contact required** when invoice delivery method is **EMAIL** (scope/config TBD).
- UI error handling and messaging for validation and authorization failures.
- Moqui screen/form/service wiring for the above.

### Out of Scope
- Creating/editing the underlying Contact / Party record details (name, phone, email) beyond displaying identifiers needed for selection.
- Managing the master list of roles (i.e., CRUD of role definitions) unless already provided elsewhere.
- Implementing downstream consumers (work order execution approvals, invoice sending); this story only maintains role data used by them.

---

## 3. Actors & Stakeholders
- **CSR**: assigns roles and primary flags.
- **Billing/Invoicing process** (consumer): uses Billing role + primary to determine invoice recipient.
- **Work Order / Estimate approval process** (consumer): uses Approver role to determine approver(s).
- **Dispatch/Operations** (consumer): may use Driver role to identify driver contact(s).
- **System admin/config owner**: sets/controls whether â€œbilling contact required for EMAIL invoicesâ€ is enforced (configuration scope TBD).

---

## 4. Preconditions & Dependencies
- A **Customer Account** exists and is accessible to the CSR.
- The account has **one or more Contacts** associated (via PartyRelationship or equivalent).
- Backend provides (or will provide) endpoints/services to:
  - Load account contacts and current role assignments.
  - Update role assignments and primary flags with proper validation.
- Backend provides the **invoice delivery method** for the customer account (at least â€œEMAILâ€ vs other).
- Permissions exist to control CSR access to modify contacts/roles.

**Dependency note (blocking):** Backend reference story indicates domain conflict (CRM vs Payment). Frontend needs a stable SoR/service boundary and endpoints. Until clarified, this story remains blocked.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Customer Account** context (e.g., account detail screen): â€œContactsâ€ tab/section â†’ â€œRolesâ€ management.
- From **Contact detail** within an account: â€œRolesâ€ panel.

### Screens to create/modify
1. **Screen: Account Contacts List (existing or new)**
   - Add a column/summary showing assigned roles and primary markers (e.g., â€œBilling (Primary), Approverâ€).
   - Add action: â€œEdit Rolesâ€ per contact.
2. **Screen/Dialog: Edit Contact Roles (new)**
   - For selected account + contact: show role checkboxes and â€œPrimaryâ€ toggle per role where applicable.
   - Save/Cancel actions.
3. **Optional Screen: Account Role Overview (new if needed)**
   - Shows, per role, which contact is primary and all contacts assigned.

### Navigation context
- All role operations are **scoped to a customer account** (accountId) and a contact (partyId/contactId).
- Breadcrumb: Account â†’ Contacts â†’ (Contact) â†’ Roles (modal/panel).

### User workflows
**Happy path (assign roles):**
1. CSR opens account contacts list.
2. CSR selects a contact â†’ â€œEdit Rolesâ€.
3. CSR checks roles (Billing/Approver/Driver).
4. CSR optionally sets Primary for Billing (and/or other roles if supported).
5. CSR clicks Save â†’ UI persists and refreshes list.

**Alternate path (change primary):**
1. CSR sets another contact as Primary Billing.
2. System demotes previous primary automatically.
3. UI reflects new primary on refresh.

**Alternate path (configured validation):**
1. Account invoice delivery method is EMAIL.
2. CSR attempts to remove Billing role from the last billing contact.
3. Save fails with a clear validation error; UI remains in edit mode.

---

## 6. Functional Behavior

### Triggers
- Enter account contacts screen.
- Click â€œEdit Rolesâ€ for a contact.
- Toggle a role checkbox.
- Toggle â€œPrimaryâ€ for a role.
- Click Save.

### UI actions
- Load contacts + existing role assignments.
- Allow selecting multiple roles for a contact.
- For each role assigned, allow setting Primary (if role supports primary; see Open Questions).
- On Save:
  - Submit role assignment changes.
  - Display success toast/message.
  - Refresh displayed role summaries.

### State changes (UI-level)
- Edit form has dirty tracking; Save disabled until changes exist.
- While saving: show spinner/disable inputs to prevent double-submit.
- After successful save: close modal/panel and refresh list.

### Service interactions
- Load: fetch account contacts, role assignments, invoice delivery method (if needed for validation display).
- Save: call update service; handle validation errors and authorization errors explicitly (see Error Flows).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Role validity:** UI must only allow selecting from the backend-provided role list OR the known enumerated set (BILLING/APPROVER/DRIVER) *if and only if backend confirms it*. If backend may change list, UI must load roles from backend.
- **Single primary per role per account:** When user marks a contact as primary for a role:
  - UI may allow it and rely on backend to demote prior primary automatically.
  - UI must refresh after save to reflect the resulting primary.
- **Primary requires role:** UI must not allow setting Primary for a role unless that role is selected for the contact.
- **Billing contact required when invoice delivery is EMAIL (configurable):**
  - UI should display a warning/inline requirement when invoice delivery is EMAIL and enforcement is enabled.
  - UI must surface backend validation error if user attempts to violate rule.

### Enable/disable rules
- Primary toggle disabled unless role checkbox is selected.
- Save disabled if:
  - No changes, or
  - Form has invalid state (e.g., Primary toggled while role unchecked; should be impossible via UI).

### Visibility rules
- Show â€œPrimaryâ€ controls only for roles that support a primary designation (assumed all roles unless clarified; see Open Questions).
- If CSR lacks permission: screen may be view-only (no Edit Roles action) or Save fails with 403; must handle both.

### Error messaging expectations
- Validation errors shown inline at top of dialog and/or on the relevant control:
  - Example: â€œAt least one Billing contact is required when invoice delivery method is Email.â€
- Authorization: â€œYou do not have permission to update contact roles for this account.â€
- Not found: â€œAccount or contact not found. Refresh and try again.â€

---

## 8. Data Requirements

### Entities involved (conceptual; frontend consumption)
- **CustomerAccount** (or Party representing account)
  - invoiceDeliveryMethod (needs value â€œEMAILâ€ at minimum)
- **Contact** (Party)
  - contactId / partyId
  - displayName
  - email/phone (optional display)
- **ContactRoleAssignment** (name TBD; backend references â€œContactRoleâ€ and â€œPartyRelationshipâ€)
  - accountId
  - contactId
  - roleName (enum/string: BILLING, APPROVER, DRIVER)
  - isPrimary (boolean)

### Fields (type, required, defaults)
- `roleName`: string/enum, required for each assignment row.
- `isPrimary`: boolean, default false.
- `contactId`, `accountId`: required identifiers.

### Read-only vs editable by state/role
- Editable only for users with appropriate permission (permission name TBD).
- If no edit permission: role list is read-only; no Save.

### Derived/calculated fields (UI)
- `rolesSummary` per contact (derived for display): join of roles + â€œ(Primary)â€ where applicable.
- `isLastBillingContact` (derived at runtime): computed from loaded assignments for the account, used only to display caution; backend is authoritative for enforcement.

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking note:** Concrete service names/endpoints are not provided in inputs. Below are required capabilities and suggested Moqui service patterns; exact names must be confirmed.

### Load/view calls
- **GetAccountContactsAndRoles**
  - Inputs: `accountId`
  - Returns:
    - account: `invoiceDeliveryMethod` (and whether enforcement is enabled, if exposed)
    - contacts: list with ids + displayName (+ email)
    - roleAssignments: list of `{contactId, roleName, isPrimary}` or embedded per contact
    - validRoles: list of role codes/labels (optional but preferred)

### Create/update calls
- **UpdateContactRolesForAccount**
  - Inputs:
    - `accountId`
    - `contactId`
    - `roles`: array of `{roleName, isPrimary}` (or separate arrays)
  - Backend behavior required:
    - Validate roleName is valid.
    - Enforce â€œprimary requires roleâ€.
    - Enforce single primary per role per account (auto-demote prior primary OR reject; must be clarified).
    - Enforce billing-contact-required-if-email when configured.

### Submit/transition calls
- None beyond update; no workflow state machine implied for this UI.

### Error handling expectations
- 400 validation error: return structured message(s) that UI can display (field-level preferred, else general).
- 403: show permission error; keep UI in view-only or block save.
- 404: show not-found; recommend refresh/navigation back.
- Concurrency: if backend uses optimistic locking/versioning, return conflict code; UI should reload and prompt user (see Error Flows).

---

## 10. State Model & Transitions

### Allowed states
No explicit entity lifecycle states provided for role assignments. Treat assignments as simple active records.

### Role-based transitions
- CSR with edit permission:
  - Can add/remove roles and set primary.
- CSR without edit permission:
  - View only.

### UI behavior per state
- Loading: skeleton/spinner.
- Loaded + editable: Edit Roles enabled.
- Loaded + read-only: Edit Roles hidden/disabled, role info visible.
- Saving: disable inputs, show progress.
- Save failed: remain in dialog with errors displayed.

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid role (backend rejects):
  - UI shows: â€œSelected role is not valid.â€ and refreshes valid roles list (if endpoint supports).
- Primary flag without role:
  - UI prevents this by disabling primary toggle; if backend still returns error, show it.
- Removing last Billing contact when EMAIL invoicing and enforcement enabled:
  - UI shows the backend error; does not close dialog.

### Concurrency conflicts
- If backend indicates role assignments changed since load:
  - UI shows: â€œRoles were updated by another user. Reloading latest values.â€
  - UI reloads and discards local changes (unless versioned merge is supported; not assumed).

### Unauthorized access
- If user opens edit but save returns 403:
  - UI shows permission error, disables Save, and offers Close.

### Empty states
- Account has no contacts:
  - Show empty state: â€œNo contacts found for this account.â€ Provide navigation to contact creation (if exists) or informational text (no creation in scope).

---

## 12. Acceptance Criteria

### Scenario 1: Assign multiple roles to a contact
**Given** a customer account with a contact â€œJane Doeâ€ with no assigned roles  
**When** the CSR opens â€œEdit Rolesâ€ for Jane Doe and selects roles â€œBILLINGâ€ and â€œAPPROVERâ€ and clicks Save  
**Then** the system saves the role assignments successfully  
**And** the contacts list displays Jane Doe with both roles shown in the roles summary.

### Scenario 2: Designate a primary billing contact
**Given** a customer account with contacts â€œJane Doeâ€ and â€œJohn Smithâ€ both assigned the â€œBILLINGâ€ role and neither is primary  
**When** the CSR sets â€œJane Doeâ€ as Primary for â€œBILLINGâ€ and saves  
**Then** Jane Doe is shown as â€œBILLING (Primary)â€ after refresh  
**And** John Smith is shown as â€œBILLINGâ€ (not primary).

### Scenario 3: Change the primary billing contact (auto-demote behavior)
**Given** a customer account where â€œJane Doeâ€ is â€œBILLING (Primary)â€ and â€œJohn Smithâ€ has â€œBILLINGâ€  
**When** the CSR sets â€œJohn Smithâ€ as Primary for â€œBILLINGâ€ and saves  
**Then** John Smith becomes â€œBILLING (Primary)â€  
**And** Jane Doe is no longer primary for â€œBILLINGâ€.

### Scenario 4: Enforce required billing contact rule when invoice delivery is EMAIL (when enabled)
**Given** a customer account configured with invoice delivery method â€œEMAILâ€  
**And** â€œJane Doeâ€ is the only contact assigned the â€œBILLINGâ€ role  
**When** the CSR removes the â€œBILLINGâ€ role from Jane Doe and clicks Save  
**Then** the system rejects the save with a validation error indicating a billing contact is required  
**And** the UI keeps the CSR in the edit dialog with the error message visible.

### Scenario 5: Prevent setting Primary without role
**Given** the CSR is editing roles for a contact  
**When** the CSR has not selected the â€œBILLINGâ€ role  
**Then** the UI does not allow toggling â€œPrimaryâ€ for â€œBILLINGâ€  
**And** no request is sent that sets `isPrimary=true` for an unassigned role.

### Scenario 6: Unauthorized user cannot modify roles
**Given** a user without permission to edit contact roles opens the account contacts page  
**When** they attempt to access role editing (via direct URL or UI action)  
**Then** the UI prevents editing (Edit action hidden/disabled) or the save fails with 403  
**And** the UI displays an authorization error message.

---

## 13. Audit & Observability

### User-visible audit data
- After save, show success message including contact name.
- If available from backend, show â€œLast updated by / atâ€ for role assignments (optional; do not assume exists).

### Status history
- Not required unless backend exposes role-assignment change history.

### Traceability expectations
- Frontend should include `accountId`, `contactId` in logs for role update attempts (without exposing PII beyond displayName in UI).

---

## 14. Non-Functional UI Requirements
- **Performance:** Contacts + roles load within 2s for typical accounts; handle pagination if large contact lists (only if existing screen supports it).
- **Accessibility:** All controls keyboard-accessible; primary toggles and role checkboxes have accessible labels; validation errors announced.
- **Responsiveness:** Dialog/panel usable on tablet widths; avoid wide tables without wrapping.
- **i18n/timezone/currency:** Not applicable (no currency). Role labels should be displayable via i18n keys if the frontend supports it; do not hardcode user-facing strings without i18n mechanism if the project requires it (unknown â†’ see Open Questions).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a non-destructive empty state when an account has no contacts; qualifies as safe because it does not affect domain rules and only improves usability. (Impacted: UX Summary, Alternate/Empty states)
- SD-UX-DOUBLE-SUBMIT: Disable Save while request in-flight to prevent duplicate submissions; qualifies as safe because it is UI ergonomics with no policy impact. (Impacted: Functional Behavior, Error Flows)
- SD-ERR-STANDARD-MAP: Map common HTTP errors (400/403/404/409/5xx) to user-friendly messages while preserving backend message text when provided; qualifies as safe because itâ€™s standard error presentation without changing business logic. (Impacted: Service Contracts, Error Flows)

---

## 16. Open Questions
1. **[BLOCKER] Domain ownership / SoR:** Is the authoritative domain for managing contact roles `CRM` (recommended) or `Payment/Billing` (as current labels suggest)? Frontend needs to know which Moqui component/screen tree and services own these updates.
2. **[BLOCKER] Backend contract:** What are the exact Moqui service names (or REST endpoints) and payload shapes for:
   - Loading account contacts + role assignments + invoice delivery method
   - Updating a contactâ€™s roles and primary flags
3. **[BLOCKER] Primary behavior:** When setting a new primary for a role, should the system **auto-demote** the prior primary (as assumed in backend reference), or **reject** until the existing primary is cleared?
4. **[BLOCKER] Config scope for â€œbilling contact required for EMAILâ€:** Is this enforcement:
   - Global system configuration,
   - Per customer account configuration,
   - Or derived strictly from invoice delivery method with no separate toggle?
5. **Role list source of truth:** Is the role list fixed to {BILLING, APPROVER, DRIVER} for MVP, or must UI load from backend to support future extensibility?
6. **Which roles support â€œPrimaryâ€:** Only Billing, or any role can have a single primary per account?
7. **Permissions:** What permission(s)/roles gate editing contact roles in the frontend (e.g., `CSR_CONTACT_EDIT`, `ACCOUNT_MAINTAIN`)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Contacts: Maintain Contact Roles and Primary Flags  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/172  
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Contacts: Maintain Contact Roles and Primary Flags

**Domain**: payment

### Story Description

/kiro  
# User Story

## Narrative
As a **CSR**, I want **to set contact roles (billing, approver, driver) and primary flags** so that **the correct person is used in approvals and invoicing**.

## Details
- Allow multiple roles per person/account.
- Optionally enforce at least one billing contact when invoice delivery is email.

## Acceptance Criteria
- Can assign roles.
- Primary billing contact can be designated.
- Validation enforced when configured.

## Integration Points (Workorder Execution)
- Estimate approval uses approver role.
- Invoice delivery uses billing contact.

## Data / Entities
- ContactRole
- PartyRelationship

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #173: [FRONTEND] [STORY] Party: Search and Merge Duplicate Parties (Basic) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/173
File: ./scripts/story-work/frontend/173/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Party: Search and Merge Duplicate Parties (Basic)

**Primary Persona:** Admin (back-office / data steward)

**Business Value:** Reduce duplicate customer records so POS workorder customer selection and downstream history are clean, consistent, and resolvable after merges.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Admin  
- **I want** to search for potential duplicate Parties and merge exactly two Parties by selecting a survivor  
- **So that** customer selection and history remain accurate and references to prior Party IDs remain resolvable for downstream systems (e.g., Workorder Execution)

### In-scope
- A Moqui-based UI flow to:
  - search Parties by name/email/phone
  - select exactly two Party records
  - choose survivor vs source
  - confirm merge
  - show merge result (audit reference and alias/redirect behavior as supported by backend)
- Basic UX protections: preventing self-merge, enforcing â€œexactly twoâ€ selection, confirm dialog, error display.
- Displaying post-merge resolution guidance (e.g., â€œsource party now redirects to survivorâ€) **if backend provides it**.

### Out-of-scope
- Complex â€œfield-by-field conflict resolutionâ€ UI (choose which email/name/etc. to keep) unless backend contract explicitly supports it.
- Bulk merging (more than two at once).
- â€œUnmergeâ€ / rollback UI.
- Defining or changing CRM data model/business policy (backend-owned).
- Editing Party details beyond whatâ€™s necessary to initiate the merge.

---

## 3. Actors & Stakeholders

- **Admin (Primary Actor):** Executes searches, selects Parties, initiates merge, confirms.
- **CSR / Service Advisor (Indirect Stakeholder):** Benefits from cleaner workorder selection and customer history.
- **Workorder Execution (Downstream Stakeholder):** Requires merged IDs to remain resolvable (alias/redirect) for historical references.
- **CRM Backend Services (System Actor):** Performs merge transaction, audit creation, aliasing/redirection.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend.
- User has authorization to perform Party merges (role/scope must be defined by backend/security configuration).
- At least two Party records exist.

### Dependencies (blocking where undefined)
- Backend endpoints/services for:
  - Party search (by name/email/phone; excluding merged parties)
  - Merge operation (sourcePartyId + survivorPartyId)
  - Optional: â€œresolve party idâ€ (alias/redirect lookup) or consistent read behavior after merge  
- Backend definition of Party â€œmergedâ€ behavior (status vs deletion) and redirect mechanics.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From CRM/Party area: **Party Search** screen includes an action â€œFind Duplicates / Mergeâ€.
- Direct navigation URL (proposed):  
  - `/crm/party/merge` (Search + selection)
  - `/crm/party/merge/confirm` (Confirmation)
  - `/crm/party/merge/result` (Result)

> If the repoâ€™s existing screen path conventions differ, implement within the existing CRM/Party screen tree.

### Screens to create/modify (Moqui Screens)
1. **Screen: PartyMergeSearch**
   - Search form: name/email/phone (at least one must be provided â€” see Open Questions if backend allows empty searches)
   - Results list (table) with multi-select (exactly two)
   - Action button: â€œContinue to Mergeâ€ enabled only when exactly two selected
2. **Screen: PartyMergeConfirm**
   - Shows the two selected parties (summary fields)
   - Requires user to pick survivor vs source (radio selection)
   - Confirmation checkbox/text acknowledging irreversibility (UI-level; backend still enforces)
   - Action: â€œMerge Partiesâ€ (calls merge service)
3. **Screen: PartyMergeResult**
   - Success message
   - Displays:
     - survivorPartyId
     - sourcePartyId
     - mergeAuditId (if returned)
     - alias/redirect status (if returned)
   - Link to open survivor Party detail screen
   - Optional: â€œTest resolutionâ€ input for partyId if backend supports resolve endpoint

### Navigation context
- Breadcrumb: CRM > Parties > Merge Duplicates
- After successful merge: route to result screen; provide link back to search.

### User workflows
- **Happy path:** Search â†’ select 2 â†’ choose survivor â†’ confirm â†’ merge success â†’ view survivor
- **Alternate path:** Search returns 0/1 results â†’ show empty state guidance
- **Alternate path:** User selects >2 results â†’ CTA disabled and helper message
- **Error path:** Backend validation error (e.g., cannot merge self, unauthorized, conflict) â†’ show error banner and keep user on confirm screen

---

## 6. Functional Behavior

### Triggers
- User submits search form
- User selects rows in results table
- User clicks â€œContinue to Mergeâ€
- User selects survivor on confirm screen
- User clicks â€œMerge Partiesâ€

### UI actions
- **Search:**
  - On submit, call backend search service with filters (name/email/phone)
  - Render results; exclude merged parties by default (frontend sends `excludeMerged=true` if supported; otherwise relies on backend default)
- **Selection:**
  - Enforce exactly two selected items to proceed
  - Display inline guidance: â€œSelect exactly two parties to mergeâ€
- **Confirm:**
  - Present both parties; user selects survivor (the other becomes source)
  - Confirm action requires explicit acknowledgement (checkbox) to reduce accidental merges
- **Merge submission:**
  - Call backend merge service with `sourcePartyId`, `survivorPartyId`
  - On success, navigate to result screen and display returned details
  - On failure, remain on confirm screen and show error mapping (see Service Contracts)

### State changes (frontend)
- Local UI state only:
  - `searchCriteria`
  - `searchResults`
  - `selectedPartyIds[2]`
  - `survivorPartyId`
  - submission `loading/error` states

### Service interactions
- `party.search` (read)
- `party.merge` (write/transaction)
- Optional `party.resolveId` or `party.get` that honors alias/redirect

---

## 7. Business Rules (Translated to UI Behavior)

> CRM domain rules apply; frontend enforces UX guardrails but backend remains authoritative.

### Validation
- Search requires at least one criterion: name OR email OR phone (blocking if backend supports empty search/pagination).
- Selection must be exactly two distinct parties.
- Survivor and source must be different.
- Confirm checkbox must be checked before enabling â€œMerge Partiesâ€.

### Enable/disable rules
- â€œContinue to Mergeâ€ disabled unless exactly two parties selected.
- â€œMerge Partiesâ€ disabled unless:
  - survivor selected
  - confirm acknowledged
  - not currently submitting

### Visibility rules
- Result screen shows merge audit/alias details only if provided by backend response.
- â€œMergedâ€ parties should not appear in search results (frontend requests exclusion if supported).

### Error messaging expectations
- Self-merge: â€œCannot merge a party with itself.â€
- Unauthorized: â€œYou donâ€™t have permission to merge parties.â€
- Conflict/concurrency: â€œThis party record changed since you loaded it. Refresh and try again.â€
- Generic failure: â€œMerge failed. No changes were applied.â€

---

## 8. Data Requirements

### Entities involved (CRM domain)
- **Party** (read/select; post-merge status update happens server-side)
- **MergeAudit** (created server-side; displayed if returned)
- **PartyAlias** (created server-side if redirect is supported; displayed if returned)

### Fields required for UI display (minimum)
For each Party in search results and confirm:
- `partyId` (UUID, required)
- `partyType` (enum: PERSON / ORG if available; optional for this story)
- Display name:
  - Person: `firstName`, `lastName` (or a `fullName` field if backend provides)
  - Org: `organizationName` (if applicable)
- Primary contact points (if available in search payload):
  - `primaryEmail` (string)
  - `primaryPhone` (string)
- Status (to confirm non-merged; ideally `status` enum)

### Read-only vs editable
- All Party fields shown are read-only in this flow.
- Only user input is search filters and survivor selection.

### Derived/calculated
- â€œSelected countâ€ derived in UI.
- Source party is derived as â€œthe selected party that is not survivorâ€.

---

## 9. Service Contracts (Frontend Perspective)

> Exact service names/endpoints are not provided; Moqui implementation must bind to actual services once confirmed. This story is **blocked** until backend contract is known.

### Load/view calls
1. **Search Parties**
   - Purpose: find candidate duplicates
   - Proposed request params:
     - `name` (string, optional)
     - `email` (string, optional)
     - `phone` (string, optional)
     - `excludeStatus=MERGED` or `excludeMerged=true` (optional)
     - pagination: `pageIndex`, `pageSize` (optional; safe default)
   - Response:
     - list of Party summaries with fields listed in Data Requirements
     - pagination metadata (optional)

2. **(Optional) Resolve Party ID**
   - Purpose: verify alias/redirect behavior for merged IDs (for Admin confidence)
   - Request: `partyId`
   - Response: canonical Party record or a payload indicating redirected-to ID

### Create/update calls
- None (frontend does not edit Party attributes in this story)

### Submit/transition calls
1. **Merge Parties**
   - Request (required):
     - `sourcePartyId` (UUID)
     - `survivorPartyId` (UUID)
     - `reason` (string, optional) **only if backend requires**
   - Response (preferred):
     - `mergeAuditId` (UUID)
     - `sourcePartyId`
     - `survivorPartyId`
     - `aliasCreated` (boolean) or `redirectToPartyId`
     - `sourcePartyFinalStatus` (e.g., `MERGED`)

### Error handling expectations (UI mapping)
- `400` validation â†’ show inline/banner with backend message; keep on same screen
- `403` forbidden â†’ show permission error; disable merge action
- `404` party not found â†’ inform user; offer to go back to search
- `409` conflict â†’ prompt refresh and retry
- `500` â†’ generic failure; do not assume partial changes

---

## 10. State Model & Transitions

### Allowed states (Party - backend-owned)
- `ACTIVE`
- `INACTIVE`
- `MERGED` (terminal for source)

### Role-based transitions
- Only Admin (or role with merge permission) can initiate merge action.

### UI behavior per state
- Parties with `status=MERGED` should be:
  - excluded from search results by default
  - if somehow shown (e.g., backend returns), display as non-selectable with helper text â€œMerged parties cannot be merged againâ€ (backend must confirm rule; otherwise treat as Open Question)

---

## 11. Alternate / Error Flows

1. **Empty search results**
   - Show message: â€œNo parties found. Try adjusting your search.â€
2. **Only one result**
   - Same as above; cannot proceed to merge
3. **Selecting more/less than two**
   - CTA disabled; helper message displayed
4. **Self-merge attempt**
   - Prevented by UI selection rules; also handle backend `400` with message
5. **Backend rejects due to constraints**
   - Show backend-provided error; no navigation; keep selections
6. **Concurrency conflict (409)**
   - Show â€œRefresh resultsâ€ action that re-runs the search and resets selection
7. **Unauthorized (403)**
   - Show error and hide/disable merge entry points

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Search returns candidate parties
**Given** I am authenticated as an Admin with permission to merge parties  
**When** I search parties by name "John Smith"  
**Then** I see a list of matching parties with their partyId and display name  
**And** I can select parties from the list for merging

### Scenario 2: Enforce selecting exactly two parties
**Given** I have performed a party search and results are displayed  
**When** I select 1 party  
**Then** the â€œContinue to Mergeâ€ action is disabled  
**And** I see guidance indicating I must select exactly 2 parties  
**When** I select 2 distinct parties  
**Then** the â€œContinue to Mergeâ€ action becomes enabled  
**When** I select 3 parties  
**Then** the â€œContinue to Mergeâ€ action is disabled

### Scenario 3: Confirm survivor and submit merge successfully
**Given** I have selected exactly two distinct parties A and B  
**When** I continue to the merge confirmation screen  
**Then** I can choose A as the survivor and B as the source  
**And** I must acknowledge the merge is permanent before submission  
**When** I submit the merge  
**Then** the system displays a success result including survivorPartyId and sourcePartyId  
**And** the result includes a merge audit reference if provided by the backend

### Scenario 4: Prevent merging a party with itself
**Given** I am on the merge confirmation screen  
**When** the survivorPartyId equals the sourcePartyId (via tampered URL or invalid state)  
**Then** the UI must block submission  
**And** if submission is attempted, the backend error is shown as â€œCannot merge a party with itself.â€

### Scenario 5: Merged parties excluded from search results
**Given** a party has been merged and is in status MERGED  
**When** I search using criteria that would match that party  
**Then** that merged party does not appear in results (default behavior)  

### Scenario 6: Backend conflict handling
**Given** I am on the merge confirmation screen with parties A and B selected  
**When** I submit the merge and the backend responds with a 409 Conflict  
**Then** I see an error telling me to refresh and try again  
**And** no success result is shown

---

## 13. Audit & Observability

### User-visible audit data
- On success, display:
  - `mergeAuditId` (if returned)
  - timestamp (if returned; otherwise omit)
  - survivor/source IDs

### Status history
- Not required to display full Party history in this story.
- If backend returns `sourcePartyFinalStatus`, display it.

### Traceability expectations
- Frontend logs (console/network) must not expose PII beyond what is shown in UI.
- For troubleshooting, include correlation/request ID in error UI if backend returns it (safe default only if present).

---

## 14. Non-Functional UI Requirements

- **Performance:** Search results should render efficiently for typical page sizes (safe default pageSize 25).
- **Accessibility:** All actions keyboard accessible; confirmation checkbox and survivor radio group have labels; error messages announced (ARIA live region via Quasar alert where applicable).
- **Responsiveness:** Works on tablet width; tables may scroll horizontally if needed.
- **i18n/timezone/currency:** Not applicable beyond basic string externalization if project already uses i18n.

---

## 15. Applied Safe Defaults

- **SD-UX-PAGINATION-01**: Default search results to paginated loading (pageSize=25) if backend supports it; qualifies as safe UI ergonomics without changing domain rules. (Impacted: UX Summary, Service Contracts, Error Flows)
- **SD-UX-EMPTY-STATE-01**: Provide explicit empty-state messaging and retry guidance on no results; safe because it affects presentation only. (Impacted: UX Summary, Alternate / Error Flows)
- **SD-ERR-MAP-01**: Map HTTP 400/403/404/409/500 to standard user-facing banners while preserving backend message text where safe; safe because it doesnâ€™t alter business logic. (Impacted: Service Contracts, Alternate / Error Flows, Business Rules)

---

## 16. Open Questions

1. **Backend contract:** What are the exact Moqui service names/endpoints and response schemas for:
   - party search (filters, pagination, exclude merged)
   - merge (required fields, response payload incl. mergeAuditId / alias info)
2. **Search requirements:** Is it allowed to search with no criteria (browse) or must at least one of name/email/phone be provided?
3. **Alias/redirect behavior:** Is `PartyAlias` always created on merge, optional, or environment-configured? How should the UI reflect this when not supported?
4. **Party types:** Are we merging only Persons, only Orgs, or both? If both, are cross-type merges allowed?
5. **Authorization:** What role/scope gates the merge UI and merge service (e.g., `crm.party.merge`)? Should unauthorized users see the screen but be blocked, or not see entry points at all?
6. **Post-merge visibility:** Should the UI ever show MERGED parties in results (e.g., with a filter toggle), or always exclude?
7. **Conflict resolution policy:** For â€œbasicâ€ merge, does backend enforce â€œsurvivor winsâ€ for primitive/conflicting attributes, and does UI need to warn about discarded data?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Party: Search and Merge Duplicate Parties (Basic) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/173


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Party: Search and Merge Duplicate Parties (Basic)
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/173
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Party: Search and Merge Duplicate Parties (Basic)

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Admin**, I want **to identify and merge obvious duplicate parties** so that **workorder selection remains clean and accurate**.

## Details
- Search by name/email/phone.
- Merge workflow: choose survivor, move relationships/vehicles/contacts, record merge audit.
- Optional alias/redirect record for merged IDs.

## Acceptance Criteria
- Can list possible duplicates.
- Can merge with an audit record.
- References remain resolvable after merge.

## Integration Points (Workorder Execution)
- Workorder Execution references must remain resolvable after merge (alias/redirect lookup).

## Data / Entities
- Party
- MergeAudit
- PartyAlias (optional)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #174: [FRONTEND] [STORY] Party: Associate Individuals to Commercial Account â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/174
File: ./scripts/story-work/frontend/174/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- none

**Rewrite Variant:** crm-pragmatic

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Party: Associate Individuals to Commercial Account

## Primary Persona
Fleet Account Manager

## Business Value
Ensure workorder approval and billing contacts for a commercial account are unambiguous by maintaining CRM-owned, effective-dated relationships with controlled roles and a single primary billing contact.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Fleet Account Manager  
- **I want** to associate existing individual (Person) records to an existing commercial account (Organization) with relationship role(s) and effective dates, including managing the accountâ€™s primary billing contact  
- **So that** downstream processes (Workorder Execution, Billing) can reliably retrieve approvers and billing contacts.

## In-scope
- View a commercial accountâ€™s current and historical (inactive) linked individuals by role.
- Create a new relationship between an Organization and a Person with:
  - roleType (APPROVER or BILLING; system-defined)
  - effectiveStartDate (required)
  - optional effectiveEndDate (set by deactivation)
  - optional `isPrimaryBillingContact` (only meaningful for BILLING)
- Deactivate an existing relationship (logical end-date; no delete).
- Assign (or change) the single **primary billing contact** for the commercial account, with automatic demotion of any existing primary billing contact (atomic, backend-enforced).
- Frontend integration with Moqui screens/forms/transitions and the CRM service endpoints referenced by the backend story.

## Out-of-scope
- Creating or editing Person/Organization master data (names, addresses, etc.).
- Customer deduplication, merge, â€œgolden recordâ€ logic.
- Defining/creating new role types (roles are system-defined).
- Workorder Execution UI or behavior (consumer only).
- Permission model design beyond enforcing 401/403 responses and hiding actions when unauthorized info is available.

---

# 3. Actors & Stakeholders

## Actors
- **Fleet Account Manager (primary):** manages account contacts/approvers/billing contacts.
- **Service Advisor (secondary/read-only):** may view contacts for operational context.

## Stakeholders
- **Billing Department:** depends on accurate billing contact designation.
- **Workorder Execution domain:** consumes approvers/billing contacts read API (no writes).
- **CRM service owner:** system of record for PartyRelationship data.

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in the POS frontend.
- User has authorization to manage relationships for the selected commercial account (backend will enforce; UI should respect 403).
- The commercial account (Organization party) exists.
- Individuals (Person parties) to be linked already exist in CRM.

## Dependencies
- Backend CRM endpoints (from backend story #110) must exist and be reachable:
  - `GET /crm/commercial-accounts/{commercialAccountId}/contacts`
  - Create relationship endpoint (not fully specified in backend story; see Service Contracts section)
  - Deactivate relationship endpoint (not fully specified; see Service Contracts section)
  - Set primary billing contact (could be part of create/update; see Service Contracts section)
- Controlled vocabulary for relationship roles includes at minimum: `APPROVER`, `BILLING`.
- Moqui security configuration provides a way to determine current user identity for audit fields (via backend).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From Commercial Account detail context (e.g., â€œCommercial Accountâ€ screen): tab/section â€œContacts & Relationshipsâ€ (naming can match existing app conventions).

## Screens to create/modify
1. **Screen:** `CommercialAccount/Contacts` (new or extend existing account detail screen)
   - Purpose: view/manage individuals linked to the account with roles and effective dates.
2. **Dialog/Subscreen:** `CommercialAccount/AddContactRelationship` (new)
   - Purpose: create a new PartyRelationship between account and person.
3. **Dialog/Subscreen:** `CommercialAccount/DeactivateRelationship` (new)
   - Purpose: confirm and set deactivation (effectiveEndDate).
4. **Optional:** `CommercialAccount/SetPrimaryBillingContact` (may be integrated into list actions)
   - Purpose: assign primary billing contact among active BILLING relationships.

## Navigation context
- Route parameter: `commercialAccountId` (Organization party id).
- Screen should load contacts for this account on entry and after any mutation.

## User workflows

### Happy path: create relationship (APPROVER or BILLING)
1. User opens Commercial Account â†’ Contacts & Relationships.
2. User clicks â€œAdd Individualâ€.
3. User selects an existing Person (lookup/search control; must return `personId`).
4. User selects roleType (`APPROVER` or `BILLING`).
5. User selects effectiveStartDate.
6. If roleType = BILLING, user may check â€œSet as primary billing contactâ€.
7. User saves â†’ list refreshes, new relationship appears as Active.

### Happy path: set/change primary billing contact
1. User identifies an active BILLING relationship row.
2. User clicks â€œSet as Primary Billing Contactâ€.
3. UI calls backend; on success, list refresh shows exactly one primary billing contact.

### Happy path: deactivate relationship
1. User clicks â€œDeactivateâ€ on an active relationship row.
2. UI prompts for effectiveEndDate (default to today, editable).
3. User confirms â†’ relationship becomes Inactive (end-dated) and no longer appears in Active-only view.

### Alternate: view inactive/historical relationships
- User toggles filter `status=INACTIVE` or `ALL` to see end-dated relationships.

---

# 6. Functional Behavior

## Triggers
- Screen load: entering Contacts & Relationships for a commercial account.
- User actions: create relationship, set primary billing contact, deactivate relationship, change filters (roles/status).

## UI actions
- **List display:** show relationships with columns:
  - Individual (name + personId reference)
  - roleType
  - effectiveStartDate
  - effectiveEndDate (blank if active)
  - status (derived: ACTIVE if endDate null or in future per backend semantics; otherwise INACTIVE)
  - primary billing indicator (only relevant for BILLING)
- **Filtering:**
  - Roles filter (multi-select): APPPROVER, BILLING
  - Status filter: ACTIVE (default), INACTIVE, ALL
- **Row actions (conditional):**
  - â€œSet Primary Billing Contactâ€ visible only when:
    - roleType includes BILLING (or equals BILLING, depending on backend representation)
    - relationship is ACTIVE
    - relationship is not already primary
  - â€œDeactivateâ€ visible only when relationship is ACTIVE
- **Create action:** â€œAdd Individualâ€ opens create dialog.

## State changes (frontend)
- Maintain local loading and error states for:
  - contacts list fetch
  - create relationship submit
  - primary billing set submit
  - deactivate submit
- After any successful mutation, re-fetch the contacts list using current filters to reflect backend-atomic changes (especially primary demotion).

## Service interactions
- On screen load and after mutations: call `GET /crm/commercial-accounts/{id}/contacts` with query params based on UI filters.
- On create relationship: call CRM create endpoint (see Section 9).
- On set primary: call CRM update endpoint (see Section 9).
- On deactivate: call CRM deactivate endpoint (see Section 9).

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Create relationship requires:
  - `commercialAccountId` (from route/context)
  - `personId` (selected)
  - `roleType` (must be one of allowed enums; UI should restrict to allowed list)
  - `effectiveStartDate` (required, valid date)
- Deactivation requires:
  - `effectiveEndDate` (required; valid date)
- If backend returns `400` for invalid role/date/format â†’ show field-level error if mapped; otherwise show form-level error summary.

## Enable/disable rules
- Disable â€œSaveâ€ button until required fields present.
- Disable mutation actions while the request is in-flight.
- Disable â€œSet Primary Billing Contactâ€ if row already primary or inactive.

## Visibility rules
- Primary billing contact indicator only displayed for BILLING role rows.
- Inactive relationships show effectiveEndDate and have no actions except view.

## Error messaging expectations
- `404` (account/person/relationship not found): show non-field error â€œRecord not found. Refresh and try again.â€
- `409` duplicate/overlap constraint: show â€œA relationship with this person and role overlaps an existing active date range.â€
- `403` forbidden: show â€œYou donâ€™t have access to manage contacts for this account.â€
- `500` unexpected: show generic error with correlation id if available.

---

# 8. Data Requirements

## Entities involved (conceptual; CRM-owned)
- `PartyRelationship`
- `Party` (Organization/Person) (read-only in this story)

## Fields (type, required, defaults)

### PartyRelationship (as used by frontend)
- `partyRelationshipId` (UUID, read-only)
- `fromPartyId` (UUID, required; commercialAccountId, read-only on edit)
- `toPartyId` (UUID, required; personId, read-only on edit)
- `roleType` (enum string, required; values at least `APPROVER`, `BILLING`)
- `isPrimaryBillingContact` (boolean, optional; only meaningful if roleType=BILLING; default false if null)
- `effectiveStartDate` (date/datetime, required)
- `effectiveEndDate` (date/datetime, optional; set on deactivation)
- Audit (read-only display if provided by API): `createdAt`, `createdBy`, `updatedAt`, `updatedBy`

### Derived/calculated (frontend)
- `status` derived for display/filtering:
  - ACTIVE when backend returns it as active OR effectiveEndDate is null (prefer backendâ€™s explicit status if provided; otherwise simple derivation based on null end date only, no policy guessing about â€œfuture end dateâ€ unless backend provides).

## Read-only vs editable by state/role
- If relationship is ACTIVE:
  - editable via actions: set primary billing (affects `isPrimaryBillingContact`), deactivate (sets end date)
  - not editable: fromPartyId/toPartyId/roleType/effectiveStartDate in this story
- If relationship is INACTIVE:
  - all fields read-only (no reactivation in scope)

---

# 9. Service Contracts (Frontend Perspective)

> Note: Backend story explicitly defines only the **read** endpoint; mutation endpoints are not fully specified. Frontend will implement integration using Moqui services once the exact endpoints/services are confirmed. Until then, UI wiring should be structured to call a single Moqui facade service per action (create/deactivate/setPrimary) so endpoint changes are localized.

## Load/view calls

### Load contacts
- **HTTP:** `GET /crm/commercial-accounts/{commercialAccountId}/contacts`
- **Query params:**
  - `roles` optional comma-separated (e.g., `APPROVER,BILLING`)
  - `status` optional default `ACTIVE`: `ACTIVE|INACTIVE|ALL` (if backend only supports ACTIVE/INACTIVE, map ALL to no param or two callsâ€”must be confirmed)
  - `includeIndividuals` optional default `true`
- **Expected response (minimum frontend needs):**
  - List of contact relationship records including:
    - partyRelationshipId
    - personId/toPartyId and display name
    - roleType
    - isPrimaryBillingContact
    - effectiveStartDate/effectiveEndDate
    - (optional) status

## Create/update calls (to be confirmed; frontend expectation)

### Create relationship
- **Proposed shape (needs confirmation):**
  - `POST /crm/commercial-accounts/{commercialAccountId}/contacts`
  - body: `{ personId, roleType, effectiveStartDate, isPrimaryBillingContact? }`
- **Success:** 201 Created (returns created relationship) OR 200 OK (returns updated list)
- **Errors:** 400, 403, 404, 409

### Set primary billing contact
- **Proposed shape (needs confirmation):**
  - `POST /crm/commercial-accounts/{commercialAccountId}/contacts/{partyRelationshipId}/set-primary-billing`
  - or `PATCH ...` with `{ isPrimaryBillingContact: true }`
- **Semantics:** backend demotes any existing primary atomically.
- **Success:** 200 OK

### Deactivate relationship
- **Proposed shape (needs confirmation):**
  - `POST /crm/party-relationships/{partyRelationshipId}/deactivate`
  - body: `{ effectiveEndDate }`
- **Success:** 200 OK

## Moqui integration expectation
- Use Moqui `transition` actions to invoke services; services should be thin wrappers around REST calls (or direct entity services if CRM is within same Moqui runtimeâ€”must match repo convention).
- Each UI mutation action should call a dedicated Moqui service, e.g.:
  - `crm.PartyRelationship.createForCommercialAccount`
  - `crm.PartyRelationship.setPrimaryBillingContact`
  - `crm.PartyRelationship.deactivate`
- Service should return structured errors suitable for field mapping (Moqui message errors).

## Error handling expectations
- Map HTTP/service errors to:
  - field errors when backend identifies field (roleType, effectiveStartDate)
  - otherwise show top-of-form error banner
- Always keep the user on the same screen/dialog after failure with inputs preserved.

---

# 10. State Model & Transitions

## Allowed states (relationship validity)
- **ACTIVE:** effectiveEndDate is null (or backend status=ACTIVE)
- **INACTIVE:** effectiveEndDate is set (or backend status=INACTIVE)

## Role-based transitions
- Fleet Account Manager:
  - ACTIVE â†’ INACTIVE via Deactivate action
  - ACTIVE BILLING relationship: set as primary billing contact (primary flag swap occurs across relationships, but the clicked relationship becomes primary)

## UI behavior per state
- ACTIVE:
  - show Deactivate
  - show Set Primary Billing Contact (if BILLING and not primary)
- INACTIVE:
  - hide Deactivate and Set Primary actions
  - display effectiveEndDate prominently in row details (behavioral requirement: must be visible)

---

# 11. Alternate / Error Flows

## Validation failures
- Missing required fields on create/deactivate: prevent submit; show inline required indicators.
- Backend 400: show returned validation message(s); keep dialog open.

## Concurrency conflicts
- If backend responds 409 on primary update or relationship creation due to overlap/duplicate:
  - show conflict message
  - re-fetch list to reflect current server state
  - keep dialog open for user adjustment (for create) / keep user on list (for set primary)

## Unauthorized access
- 401: redirect to login (standard app behavior).
- 403: show access error; disable mutation controls; allow read-only view if read endpoint succeeds, otherwise show forbidden state.

## Empty states
- No ACTIVE contacts: show empty state with action â€œAdd Individualâ€.
- No results for selected filters: show â€œNo contacts match filtersâ€ with reset filters action.

---

# 12. Acceptance Criteria

## Scenario 1: View active approvers and billing contacts (default)
**Given** I am authenticated as a Fleet Account Manager  
**And** a commercial account exists with linked contacts of roles APPROVER and BILLING  
**When** I open the commercial accountâ€™s â€œContacts & Relationshipsâ€ screen  
**Then** the UI loads contacts using status=ACTIVE by default  
**And** I can see each contactâ€™s role, effectiveStartDate, and whether they are the primary billing contact (for BILLING)  

## Scenario 2: Create an APPROVER relationship
**Given** I am on a commercial accountâ€™s â€œContacts & Relationshipsâ€ screen  
**And** an individual Person exists in CRM  
**When** I add the individual with roleType=APPROVER and an effectiveStartDate  
**And** I save  
**Then** the relationship is created successfully  
**And** the contacts list refreshes and shows the new APPROVER relationship as active  

## Scenario 3: Create a BILLING relationship and set as primary
**Given** I am on a commercial accountâ€™s â€œContacts & Relationshipsâ€ screen  
**And** no primary billing contact is currently set OR another primary billing contact exists  
**When** I add the individual with roleType=BILLING and check â€œSet as primary billing contactâ€  
**And** I save  
**Then** the relationship is created successfully  
**And** exactly one relationship is shown as primary billing contact after refresh  
**And** if another primary billing contact existed previously, it is no longer primary after refresh  

## Scenario 4: Change primary billing contact (atomic demotion)
**Given** I am viewing active BILLING relationships for a commercial account  
**And** there is an existing primary billing contact  
**When** I click â€œSet as Primary Billing Contactâ€ on a different active BILLING relationship  
**Then** the selected relationship becomes primary  
**And** the previously primary relationship is no longer primary after the list refresh  
**And** no error is shown  

## Scenario 5: Deactivate a relationship
**Given** I am viewing an active relationship row  
**When** I deactivate the relationship and provide an effectiveEndDate  
**Then** the relationship is end-dated successfully  
**And** it no longer appears in the ACTIVE filter view after refresh  
**And** it appears in the INACTIVE or ALL filter view with effectiveEndDate displayed  

## Scenario 6: Prevent duplicate overlapping active relationship (conflict)
**Given** there is already an active relationship for the same person and role with an overlapping effective date range  
**When** I attempt to create another relationship that overlaps  
**Then** the UI shows a conflict error message  
**And** the relationship is not created  
**And** my entered values remain in the form for correction  

## Scenario 7: Unauthorized attempt
**Given** I am authenticated but not authorized to manage contacts for the commercial account  
**When** I attempt to create, deactivate, or set primary billing contact  
**Then** the backend returns 403  
**And** the UI shows an authorization error  
**And** no changes are applied  

---

# 13. Audit & Observability

## User-visible audit data
- If API returns audit fields, display in a relationship details view (e.g., expandable row detail):
  - createdAt/createdBy
  - updatedAt/updatedBy

## Status history
- Relationship history is represented via effectiveStartDate/effectiveEndDate and inclusion in INACTIVE filter.
- No separate â€œhistory timelineâ€ UI required beyond being able to view inactive relationships.

## Traceability expectations
- Each mutation request should include/propagate a correlation id (Moqui/HTTP header pattern per repo conventions) and log it in frontend error logs (without PII beyond IDs).
- Frontend should log action type and involved IDs (commercialAccountId, partyRelationshipId) at info level in dev tools (or Moqui logs if server-side screen actions), respecting safe logging (no names/emails/phones).

---

# 14. Non-Functional UI Requirements

- **Performance:** contacts list should load within 2 seconds under normal conditions for typical accounts (<200 relationships). If larger, UI should remain responsive (show loading state).
- **Accessibility:** all actions reachable by keyboard; dialogs have focus trapping; labels for form controls; error messages associated with fields.
- **Responsiveness:** usable on tablet; table may collapse to stacked rows/cards on small screens (implementation choice).
- **i18n/timezone:** dates displayed in the userâ€™s locale/timezone; input uses standard date picker; store/send ISO date/datetime as required by backend.

---

# 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Added explicit empty/filter-no-results states with a clear â€œAdd Individualâ€ CTA; qualifies as safe because it does not change business logic, only UX clarity. (Impacted: UX Summary, Alternate/Empty states)
- SD-UX-LOADING-AND-RETRY: Standard loading indicators and retry affordance on failed fetch; qualifies as safe because itâ€™s generic error-handling ergonomics. (Impacted: Functional Behavior, Alternate/Error flows)
- SD-ERR-HTTP-STATUS-MAP: Standard mapping of 400/403/404/409/500 to user-facing messages; qualifies as safe because it follows backend-implied semantics without inventing policies. (Impacted: Business Rules, Error Flows, Service Contracts)

---

# 16. Open Questions

- What are the **exact CRM mutation endpoints/service names** for:
  1) creating a PartyRelationship for a commercial account,  
  2) deactivating a PartyRelationship (setting effectiveEndDate),  
  3) setting primary billing contact (and whether itâ€™s part of create/update)?  
- Does the read endpoint `GET /crm/commercial-accounts/{id}/contacts` support `status=ALL`, or must the frontend implement ALL via multiple calls/client-side merging?
- Does the backend represent â€œrole(s)â€ as **one roleType per relationship record** (as in backend story) or multiple roles per relationship? (Frontend can support one-per-record per backend story; confirm to avoid mismatch.)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Party: Associate Individuals to Commercial Account â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/174

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Party: Associate Individuals to Commercial Account
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/174
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Party: Associate Individuals to Commercial Account

**Domain**: payment

### Story Description

/kiro
# User Story

## Narrative
As a **Fleet Account Manager**, I want **to link individuals to a commercial account with relationship types/roles** so that **workorder approval and billing contacts are unambiguous**.

## Details
- Relationship includes role(s) and effective dates.
- Allow one or more primary billing contacts per account.

## Acceptance Criteria
- Can create relationship with role.
- Primary billing contact can be designated.
- Relationship can be deactivated.

## Integration Points (Workorder Execution)
- Workorder Execution retrieves approvers/billing contacts for an account.

## Data / Entities
- PartyRelationship (roles, flags, effective dates)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #175: [FRONTEND] [STORY] Party: Create Individual Person Record  
File: ./scripts/story-work/frontend/175/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- none

**Rewrite Variant:** crm-pragmatic

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Party: Create Individual Person Record

## Primary Persona
Customer Service Representative (CSR)

## Business Value
Enable CSRs to create an individual person (Party/Person) with contact information so the person can later be associated to commercial accounts, vehicles, and work orders (e.g., for notifications/approvals).

---

# 2. Story Intent

## As a / I want / So that
- **As a** CSR  
- **I want** to create an individual person record with contact information (phones/emails) and a preferred contact method  
- **So that** the person can be referenced by downstream workflows (account association, vehicle association, work order notifications/approvals).

## In-scope
- A Moqui/Quasar/Vue screen flow to create a **Person** with:
  - required name fields (`firstName`, `lastName`)
  - required `preferredContactMethod` enum
  - optional multiple emails and phones (zero-to-many contact points)
- Client-side validations aligned with backend rules (required fields, email format)
- Submission to backend and handling success/error outcomes
- UX states: initial, submitting, success, and validation/error display

## Out-of-scope
- Role tags (billing contact, driver, approver) including any placeholder UI/schema
- Customer deduplication, merge, or â€œgolden recordâ€ workflows (duplicates explicitly allowed)
- Associating person to commercial accounts, vehicles, or work orders (only create the person record here)
- Editing an existing person record

---

# 3. Actors & Stakeholders

- **Primary Actor:** CSR (interactive user)
- **System of Record:** CRM (Party/Person master data)
- **Downstream Consumers (non-editing):** Workorder Execution, Billing (read/reference person identity)
- **Supporting Systems:** Moqui backend services handling Person and ContactPoint persistence

---

# 4. Preconditions & Dependencies

## Preconditions
- CSR is authenticated in the frontend and authorized to create person records.
- Moqui backend endpoints/services for â€œCreate Individual Personâ€ are reachable.

## Dependencies
- Backend contract as referenced by backend story **durion-positivity-backend#111** (Create Person, validations, enums, error codes).
- Controlled vocabulary for `preferredContactMethod`: `EMAIL | PHONE_CALL | SMS | NONE`.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- POS navigation entry: **CRM / Parties / Create Person** (exact menu location may follow existing frontend nav conventions).
- Optional secondary entry: from a â€œSelect/Create Personâ€ chooser flow (if exists) via a â€œCreate New Personâ€ action (link target to the same create screen).

## Screens to create/modify
- **Create:** `apps/pos/screen/crm/person/CreatePerson.xml` (screen name indicative; implement per repo conventions)
  - Contains a form for Person core fields and repeatable contact point inputs
- **Optional (if project uses separate components):**
  - Vue/Quasar component backing the form (e.g., `src/components/crm/person/CreatePersonForm.vue`) wired to Moqui screen via existing integration pattern in this repo.

## Navigation context
- Breadcrumb: CRM â†’ Parties â†’ Create Person
- After success: route/transition to a **Person Detail** screen if it exists; otherwise show an in-place success state with the new `personId` and a â€œCreate anotherâ€ action.

## User workflows
### Happy path
1. CSR opens Create Person screen.
2. CSR enters `firstName`, `lastName`.
3. CSR selects `preferredContactMethod` from allowed enum.
4. CSR optionally adds 0..N emails and 0..N phone numbers.
5. CSR clicks **Create**.
6. UI submits, shows loading, then success confirmation with returned `personId`.

### Alternate paths
- CSR submits with missing required fields â†’ inline validation messages; no request or request rejected.
- CSR enters invalid email â†’ inline validation; if still submitted backend returns 400; UI shows field-level error.
- CSR adds multiple emails/phones â†’ UI allows dynamic add/remove rows.

---

# 6. Functional Behavior

## Triggers
- Screen load: initialize form model with empty values and defaults.
- User actions: add/remove contact point rows; submit.

## UI actions
- **Add Email**: appends an email contact row with fields:
  - `value` (email string)
  - `isPrimary` (boolean)
- **Add Phone**: appends a phone contact row with fields:
  - `contactType` (enum for phone type; see Data Requirements)
  - `value` (phone string)
  - `isPrimary` (boolean)
- **Remove row**: removes row from local model (not persisted until submit)
- **Set Primary**: when marking a row primary, UI enforces only one primary per kind (EMAIL vs PHONE) in the client model (and shows conflict if user tries to set multiple).

## State changes (frontend view-model)
- `idle` â†’ `editing` (on load)
- `editing` â†’ `submitting` (on Create)
- `submitting` â†’ `success` (201)
- `submitting` â†’ `error` (4xx/5xx)
- `error` â†’ `editing` (on user correction or retry)

## Service interactions
- On submit, call backend create service with:
  - Person fields
  - contact points list (emails + phones)
- On success:
  - store returned `personId` in UI state
  - navigate to detail screen if available, else display success panel

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- `firstName` required (non-empty trimmed string)
- `lastName` required (non-empty trimmed string)
- `preferredContactMethod` required and must be one of: `EMAIL`, `PHONE_CALL`, `SMS`, `NONE`
- Each email `value` must match a valid email format (client-side validation); backend is authoritative
- Contact points are optional; zero contact points is valid

## Enable/disable rules
- Disable **Create** button while `submitting`
- Disable removing rows while `submitting` (to prevent model drift mid-request)

## Visibility rules
- Show contact point sections even if empty; provide empty-state guidance (â€œNo emails addedâ€ / â€œNo phones addedâ€)
- Only show success panel after 201

## Error messaging expectations
- For `400 Bad Request`: show a banner â€œPlease correct the highlighted fieldsâ€ and map backend field errors to inputs where possible.
- For `500+`: show non-PII generic error (â€œSomething went wrong creating the person. Please try again.â€) and keep user inputs intact for retry.

---

# 8. Data Requirements

## Entities involved (conceptual; frontend-facing)
- **Person**
- **ContactPoint**

## Fields

### Person (create payload)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| firstName | string | yes | none | trimmed |
| lastName | string | yes | none | trimmed |
| preferredContactMethod | enum | yes | NONE? (UI should require explicit selection) | allowed: `EMAIL \| PHONE_CALL \| SMS \| NONE` |

### ContactPoint (create payload; zero-to-many)
Backend reference specifies:
- `contactType` enum examples include `EMAIL`, `PHONE_MOBILE`, `PHONE_HOME`
- `value` string
- `isPrimary` boolean default false

Frontend must support:
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| contactType | enum | yes (per row) | for email rows: `EMAIL` | phone rows: must be chosen from allowed phone contact types if more than one |
| value | string | yes (per row) | none | email validated; phone minimally validated unless backend specifies format |
| isPrimary | boolean | no | false | UI enforces max one primary per kind (EMAIL vs PHONE) |

## Read-only vs editable by state/role
- All fields editable in `editing`
- All fields read-only in `submitting`
- On `success`, fields are read-only; user may choose â€œCreate anotherâ€ to reset state

## Derived/calculated fields
- None in scope (no dedup indicators, no computed display name rules defined)

---

# 9. Service Contracts (Frontend Perspective)

> Note: exact service names/routes must match Moqui implementation in this repo; below is the required contract behavior consistent with backend story #111.

## Load/view calls
- None required (create-only screen)

## Create/update calls
### Create Individual Person
- **Action:** create Person + ContactPoints in a single transaction
- **Method:** (expected) `POST`
- **Request body:**
  - `firstName`, `lastName`, `preferredContactMethod`
  - `contactPoints`: array of `{ contactType, value, isPrimary }` (or equivalent structure used by backend)
- **Success:**
  - `201 Created`
  - response includes `personId` (UUID)
- **Error cases:**
  - `400 Bad Request` for missing required fields or invalid formats (e.g., email)
  - `403 Forbidden` if not authorized
  - `500 Internal Server Error` on persistence failure (transaction rolled back)

## Submit/transition calls
- None (no state machine transitions defined for Person creation)

## Error handling expectations
- Parse backend error response:
  - If field-level validation errors present, bind to respective inputs
  - Otherwise show banner error with request correlation id if available (do not display sensitive info)

---

# 10. State Model & Transitions

## Allowed states (UI state, not domain lifecycle)
- `editing`
- `submitting`
- `success`
- `error`

## Role-based transitions
- CSR with create permission can transition `editing â†’ submitting`
- Unauthorized user:
  - can view screen shell but submit results in `403` handling (or screen access blocked depending on existing auth patterns)

## UI behavior per state
- `editing`: full form enabled; inline validations on blur and on submit
- `submitting`: disable inputs and show progress indicator
- `success`: show created `personId`; provide navigation actions
- `error`: show banner; preserve entered data; allow retry

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- Missing `firstName`/`lastName`/`preferredContactMethod`:
  - Prevent submit
  - Show inline required errors

## Validation failures (server-side 400)
- Invalid email format not caught client-side:
  - Show inline error on the offending email row if backend identifies it; otherwise show banner and keep values

## Concurrency conflicts
- Not applicable for create-only (no optimistic locking required)

## Unauthorized access
- `403` on submit:
  - Show â€œYou donâ€™t have permission to create a person record.â€
  - Do not clear form

## Empty states
- No emails/phones added:
  - Allowed; create proceeds with just Person fields

---

# 12. Acceptance Criteria

## Scenario 1: Minimal person create succeeds
**Given** I am an authenticated CSR with permission to create person records  
**And** I am on the Create Person screen  
**When** I enter `firstName` and `lastName`  
**And** I select `preferredContactMethod = NONE`  
**And** I click Create  
**Then** the system submits a create request  
**And** I receive a success response (201) with a `personId`  
**And** the UI shows confirmation including the new `personId`

## Scenario 2: Create with multiple emails and phones
**Given** I am an authenticated CSR with permission to create person records  
**When** I enter a valid name and select `preferredContactMethod = EMAIL`  
**And** I add 2 email contact rows with valid email values  
**And** I add 2 phone contact rows with values  
**And** I click Create  
**Then** the request includes 4 contact points  
**And** the create succeeds with 201 and returns a `personId`  
**And** the UI indicates success

## Scenario 3: Missing last name is blocked
**Given** I am on the Create Person screen  
**When** I enter `firstName` but leave `lastName` empty  
**And** I select a preferred contact method  
**And** I click Create  
**Then** the UI shows a required-field validation error for `lastName`  
**And** no create request is submitted (or if submitted, the UI displays backend 400 and no success state)

## Scenario 4: Invalid email is rejected and nothing is created
**Given** I am on the Create Person screen  
**When** I enter valid `firstName`, `lastName`, and preferred contact method  
**And** I add an email contact point with value `not-an-email`  
**And** I click Create  
**Then** the UI shows an email format error (client-side or from backend 400)  
**And** the UI remains in editing/error state with user input preserved  
**And** the UI does not show a created `personId`

## Scenario 5: Not authorized to create
**Given** I am authenticated but do not have permission to create person records  
**When** I attempt to create a person  
**Then** the backend returns 403 (or access is blocked before submit per app convention)  
**And** the UI shows an authorization error message  
**And** no success confirmation is shown

---

# 13. Audit & Observability

## User-visible audit data
- Not required in UI for this story (creation-only)

## Status history
- Not applicable (no lifecycle states defined for Person)

## Traceability expectations
- Frontend should include/request a correlation id where supported by existing Moqui frontend pattern.
- On successful create, backend emits `PERSON_CREATED` (reference), but UI does not need to display it.

---

# 14. Non-Functional UI Requirements

- **Performance:** Create submission should complete within acceptable interactive latency; UI must show loading state immediately on submit.
- **Accessibility:** All inputs have labels; validation errors are announced to screen readers; keyboard navigation supports add/remove contact point rows.
- **Responsiveness:** Usable on standard POS tablet/desktop breakpoints.
- **i18n/timezone/currency:** Not applicable (no monetary/time fields). Use existing i18n mechanism for labels/messages if present in repo.

---

# 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit empty-state text and â€œAdd Email/Add Phoneâ€ actions when no contact points exist; qualifies as safe because it does not change domain rules, only improves usability. Impacted sections: UX Summary, Alternate/Empty states.
- SD-UX-SUBMIT-DISABLE: Disable submit and inputs during in-flight request to prevent duplicate submits; safe because itâ€™s standard UI ergonomics and does not alter business logic. Impacted sections: Functional Behavior, Business Rules, Error Flows.
- SD-ERR-GENERIC-5XX: Show generic non-PII error for 5xx while preserving form state; safe because it aligns with secure error-handling and doesnâ€™t invent business policy. Impacted sections: Business Rules, Error Flows, Service Contracts.

---

# 16. Open Questions

- none

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Party: Create Individual Person Record  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/175  
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Party: Create Individual Person Record

**Domain**: payment

### Story Description

/kiro  
# User Story

## Narrative  
As a **CSR**, I want **to create an individual person record with contact information** so that **I can associate them to a commercial account and/or vehicles**.

## Details  
- Capture: name, phone(s), email(s), preferred contact method.  
- Support role tags later (billing contact, driver, approver).

## Acceptance Criteria  
- Can create person.  
- Can store multiple phones/emails.  
- Preferred contact method stored.

## Integration Points (Workorder Execution)  
- Workorder Execution can select a person for notifications/approvals.

## Data / Entities  
- Party/Person  
- ContactPoint  
- Preferences

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: CRM

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #176: [FRONTEND] [STORY] Party: Create Commercial Account  
File: ./scripts/story-work/frontend/176/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Party: Create Commercial Account

**Primary Persona:** Fleet Account Manager

**Business Value:** Enables consistent association of workorders/estimates/invoices to a single, stable commercial customer entity (CRM Party/Account), reducing duplicate customer creation and downstream billing errors.

---

## 2. Story Intent

### As a / I want / So that
**As a** Fleet Account Manager,  
**I want** to create a commercial customer account with legal name, billing profile (default billing terms), and optional identifiers,  
**So that** workorders and invoices can be consistently tied to the correct business entity via a stable CRM ID.

### In-scope
- A â€œCreate Commercial Accountâ€ UI flow in the Moqui frontend (Vue 3 + Quasar) to create a new Commercial Account/Party.
- Capture fields: legal name (required), DBA (optional), tax ID (optional), account status (default Active), default billing terms (required), external identifiers (optional).
- Duplicate warning UX at creation time based on â€œname + phone/email matchâ€ (non-blocking warning with user override).
- Post-create confirmation and ability to copy/view the newly created stable CRM ID (PartyId).
- Provide a predictable route/screen that downstream UX (e.g., workorder execution screens) can navigate back to or deep-link into (view page is optional but recommended as a follow-up; see Open Questions).

### Out-of-scope
- Editing/updating existing accounts (separate story).
- Full CRM account search UI (unless already exists; only ensure created accounts are retrievable by existing search).
- Defining billing terms master data management (assumed provided by backend/domain).
- Implementing backend services/entities (frontend story consumes Moqui services/endpoints).
- Complex dedupe algorithms beyond the specified basic match.

---

## 3. Actors & Stakeholders
- **Fleet Account Manager (primary)**: creates accounts and resolves duplicate warnings.
- **Workorder Execution users/systems (downstream)**: search/select account by name/ID; store CRM ID on estimate/workorder.
- **Billing/Invoicing stakeholders (downstream)**: rely on default billing terms and identifiers being correct.
- **System Admin / Support (secondary)**: may troubleshoot duplicates via audit trail (read-only concerns in this story).

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend.
- User has permission to create commercial accounts (exact permission artifact TBD; see Open Questions).
- Moqui backend provides:
  - A service to create a commercial account (and returns PartyId / CRM ID).
  - A service to run duplicate check (or create service performs it and returns potential matches).
  - A service to load billing terms list for selection.
- Connectivity to backend is available; standard error handling should surface service errors.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Primary entry from a CRM/Accounts area: â€œCreate Commercial Accountâ€ button.
- Secondary entry from Workorder Execution (optional): â€œCreate new accountâ€ from an account picker/search screen (if such a screen exists).

### Screens to create/modify
1. **New Screen:** `apps/durion/screen/party/CommercialAccountCreate.xml` (name illustrative; final path must follow repo conventions)
   - Presents a form for commercial account creation.
   - Performs duplicate check flow and confirmation/override if duplicates found.
2. **Optional/New or Existing Screen:** `.../party/CommercialAccountView.xml`
   - Display created account details including PartyId.
   - If an existing Party/Account view already exists, route to it after creation.

### Navigation context
- Breadcrumb/toolbar should clearly indicate â€œCreate Commercial Accountâ€.
- Cancel returns to prior screen (or Accounts list if no referrer).

### User workflows
**Happy path**
1. User opens Create Commercial Account.
2. Enters required fields and optional identifiers.
3. Submits.
4. If no duplicates: account created; user sees success confirmation with PartyId; navigates to view screen.

**Alternate path: duplicates found**
1. User submits.
2. Duplicate warning displayed with list of potential matches (minimum: name + PartyId; more fields if available).
3. User chooses:
   - â€œReview matchâ€ (opens view in new route/tab) OR
   - â€œCancelâ€ (return to form, no create) OR
   - â€œCreate anywayâ€ (explicit override â†’ proceed to create).

---

## 6. Functional Behavior

### Triggers
- User clicks â€œCreate Commercial Accountâ€ entry point.
- User clicks â€œSubmit/Createâ€ on the form.

### UI actions
- Form input for account fields.
- â€œSubmit/Createâ€ initiates:
  1) client-side required checks (presence only; no policy guessing), then
  2) server-side duplicate check / create attempt sequence (see Service Contracts).

### State changes (frontend)
- Local UI states:
  - `idle` â†’ `validating` â†’ `checkingDuplicates` â†’ (`duplicateWarning` | `creating`) â†’ (`success` | `error`)
- Duplicate override requires explicit user action (e.g., confirmation dialog with checkbox or secondary confirm step).

### Service interactions
- Load billing terms list on screen load (or lazy load on field focus).
- On submit:
  - Call duplicate check (if separate) and display warning when matches exist; OR
  - Call create service that may return a â€œduplicates foundâ€ response requiring confirmation (preferred if backend contract is like this; currently unclear).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Legal Name**: required, non-empty string.
  - UI: mark as required; block submit if empty.
  - Error message: â€œLegal name is required.â€
- **Default Billing Terms**: required selection.
  - UI: required dropdown/select; block submit if not selected.
  - Error message: â€œDefault billing terms is required.â€
- **Tax ID**: optional.
  - UI: no format assumptions unless backend returns validation errors; display backend error message mapped to field if provided.
- **Account Status**:
  - Defaults to `Active` on create.
  - UI: either show as prefilled `Active` (editable only if permittedâ€”unclear) or hide and let backend default (see Open Questions).

### Enable/disable rules
- Disable Submit while any service call in-flight.
- Disable â€œCreate anywayâ€ until user explicitly confirms they understand duplicates may exist (confirmation step required for auditability).

### Visibility rules
- Duplicate warning UI only appears when backend indicates potential duplicates.
- External identifiers section is optional and collapsible (safe UX default; no policy impact).

### Error messaging expectations
- Field-level errors should be shown inline when backend returns structured validation errors.
- Non-field errors shown as a banner/toast: â€œUnable to create account. Please try again.â€ plus correlation id if available (do not expose sensitive details).

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Party/Account (Commercial Account)**: the core CRM entity; returns stable `partyId` (CRM ID).
- **BillingTerms**: reference/master entity providing selectable billing terms.
- **ExternalId / Identifiers**: optional set of external identifiers (ERP/customer number).
- **Audit fields**: createdBy/createdAt etc (display only post-create if view screen exists).

### Fields
**Commercial Account Create Input**
- `legalName` (string, required)
- `dbaName` / `doingBusinessAs` (string, optional)
- `taxId` / `taxIdentifier` (string, optional)
- `accountStatus` (enum/string, default `Active`) **(unclear if user-editable)**
- `defaultBillingTermsId` (id/string, required)
- `externalIdentifiers` (structure TBD; see Open Questions)
- **Duplicate check inputs** (if required by backend): `phone` and/or `email` **(not mentioned in capture list but required for dedupe rule; see Open Questions)**

**Read-only outputs**
- `partyId` (string/UUID): stable CRM ID created by system.

### Read-only vs editable by state/role
- Create form: all input fields editable.
- Post-create: `partyId`, audit fields read-only.
- Status editability is unclear (policy/permissions).

### Derived/calculated fields
- None defined on frontend. Any normalization for duplicate detection must be owned by backend unless explicitly specified (not specified).

---

## 9. Service Contracts (Frontend Perspective)

> Naming is intentionally conservative because backend Moqui service names are not provided. These must be mapped to actual Moqui services during implementation.

### Load/view calls
1. **Load billing terms list**
   - Service: `BillingTerms.list` (placeholder)
   - Request: `{ activeOnly: true }` (if supported)
   - Response: `[{ billingTermsId, description, ... }]`
   - UI: populate select options.

2. **(Optional) Load duplicate candidates detail**
   - If duplicate check returns only IDs, UI may need a service to load candidate summaries.
   - Service: `Party.getAccountSummariesByIds` (placeholder)

### Create/update calls
1. **Create commercial account**
   - Service: `Party.createCommercialAccount` (placeholder)
   - Request payload:
     - `legalName`
     - `doingBusinessAs` (optional)
     - `taxIdentifier` (optional)
     - `defaultBillingTermsId`
     - `accountStatus` (optional; backend default Active)
     - `externalIdentifiers` (optional; structure TBD)
     - `duplicateOverride` (boolean, default false)
     - `duplicateCandidateIdsShown` (array, required when override true) (for audit) **(needs backend support; see Open Questions)**
   - Response (success): `{ partyId, ... }`
   - Response (duplicates): either
     - `{ duplicatesFound: true, candidates: [...] }` with 200, or
     - error code requiring confirmation (e.g., 409 with payload). **Needs clarification.**

### Submit/transition calls
- None beyond create.

### Error handling expectations
- Validation errors returned by service should map to fields when possible.
- Authorization errors (401/403): show â€œYou donâ€™t have permission to create accounts.â€ and do not retry.
- Duplicate conflict: handled as warning/confirm flow, not a hard failure (unless backend enforces).
- Network/timeouts: show retryable error; keep form data intact.

---

## 10. State Model & Transitions

### Allowed states (account status)
- At minimum: `Active` (default), plus any others if backend supports (`Inactive`, `OnHold` mentioned in backend reference but not authoritative for frontend without confirmation).

### Role-based transitions
- This story only covers creation.
- If status is editable at create time, role/permission gating is required (unclear).

### UI behavior per state
- New account defaults to `Active` in UI or backend; UI should display resulting status after creation if a view screen is shown.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing legal name / billing terms: block submit client-side.
- Backend validation errors: show inline; preserve all user-entered values.

### Concurrency conflicts
- Not applicable for create, except duplicate logic. If backend returns â€œalready existsâ€ (e.g., tax ID unique), show error with field mapping to tax ID when possible.

### Unauthorized access
- If user lacks permission:
  - Entry point may be hidden/disabled if permission is detectable client-side.
  - If accessed directly via URL, backend 403 should render an unauthorized message and prevent form usage.

### Empty states
- Billing terms list empty/unavailable:
  - Show â€œNo billing terms available. Contact admin.â€ and disable submit.

---

## 12. Acceptance Criteria

### Scenario 1: Create commercial account successfully with required fields
**Given** I am authenticated as a Fleet Account Manager with permission to create commercial accounts  
**And** billing terms are available to select  
**When** I enter a legal name and select default billing terms  
**And** I submit the create form  
**Then** the system creates a commercial account  
**And** I am shown a success confirmation containing the new stable CRM ID (PartyId)  
**And** I am navigated to the account view screen (or shown a link) for the created account

### Scenario 2: Required field validation blocks submission (legal name)
**Given** I am on the Create Commercial Account screen  
**When** I submit the form with legal name empty  
**Then** the UI prevents submission  
**And** I see â€œLegal name is required.â€  
**And** no create service call is made

### Scenario 3: Required field validation blocks submission (billing terms)
**Given** I am on the Create Commercial Account screen  
**When** I submit the form without selecting default billing terms  
**Then** the UI prevents submission  
**And** I see â€œDefault billing terms is required.â€  
**And** no create service call is made

### Scenario 4: Duplicate warning is shown when close matches exist
**Given** an existing commercial account exists that matches the duplicate rule for my entered data  
**When** I submit the create form  
**Then** I am shown a duplicate warning  
**And** I can see a list of potential matching accounts (at least name and ID)  
**And** I can choose to cancel or proceed with â€œCreate anywayâ€

### Scenario 5: Duplicate warning override creates account
**Given** a duplicate warning is shown with candidate matches  
**When** I explicitly choose â€œCreate anywayâ€ (override)  
**Then** the system creates a new commercial account  
**And** I am shown the new PartyId  
**And** the override action is sent to the backend in a way that can be audited (e.g., override flag + candidate IDs)

### Scenario 6: Backend validation error is rendered inline
**Given** I submit the create form with a tax ID that the backend rejects  
**When** the backend returns a field validation error for tax ID  
**Then** the UI shows the backend error message associated with the tax ID field  
**And** my other entered values remain intact

### Scenario 7: Unauthorized user cannot create
**Given** I am authenticated but do not have permission to create commercial accounts  
**When** I attempt to access the Create Commercial Account screen or submit the form  
**Then** I am shown an authorization error  
**And** no account is created

---

## 13. Audit & Observability

### User-visible audit data
- On success confirmation (and/or view screen), display:
  - `partyId`
  - created timestamp and created by (if available from backend response or subsequent load)

### Status history
- Not in scope unless view screen already supports it.

### Traceability expectations
- Frontend should pass/propagate a correlation/request ID if the project convention supports it (e.g., header or request param). If backend returns a correlation id on error, show it in the error banner for support.

---

## 14. Non-Functional UI Requirements
- **Performance:** Billing terms load and duplicate check/create should complete under typical LAN conditions; UI must show loading state within 200ms of action.
- **Accessibility:** All inputs have labels; required fields announced; duplicate warning dialog is keyboard navigable and focus-trapped.
- **Responsiveness:** Form usable on tablet-sized viewport (POS-friendly).
- **i18n/timezone/currency:** No currency required. Text should be compatible with i18n if project uses it (no hard-coded concatenations that block translation).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty state messaging for missing billing terms; qualifies as safe because it does not change domain policy, only improves clarity. (Impacted: UX Summary, Error Flows)
- SD-UX-LOADING-DISABLE: Disable submit buttons during in-flight requests to prevent double-submit; safe because it prevents duplicate requests without changing business rules. (Impacted: Functional Behavior, Error Flows)
- SD-ERR-PRESERVE-FORM: Preserve user-entered values on backend error; safe because itâ€™s purely UX ergonomics. (Impacted: Error Flows, Acceptance Criteria)

---

## 16. Open Questions
1. **Domain/System of Record confirmation:** This frontend story proposes `domain:crm` because it creates a Party/Account. The issue currently carries `payment` labeling. Can we confirm CRM is the SoR and domain label should be `domain:crm`?
2. **Duplicate detection inputs:** The dedupe rule references â€œname + phone/email matchâ€ but the capture list does not include phone/email. Should the Create Commercial Account form include primary phone and/or email fields, or is duplicate check performed against existing contact info captured elsewhere?
3. **Backend contract for duplicates:** Does the backend expose a separate `duplicateCheck` service, or does `createCommercialAccount` return a â€œduplicates foundâ€ response requiring confirmation? What is the exact response shape/status code?
4. **Account status field:** Is `accountStatus` user-selectable at creation time, or must it always default to `Active` and be immutable on create for this role?
5. **Billing terms source:** What Moqui service/entity provides â€œDefault Billing Termsâ€ options, and what fields should be displayed in the select (name vs description vs code)?
6. **External identifiers structure:** Are external identifiers free-form key/value, or constrained to a defined set (e.g., ERP customer number only)? If constrained, what keys and validation apply?
7. **Post-create navigation:** Is there an existing account view screen route in this frontend? If yes, provide route pattern. If not, should this story include implementing the view screen or just show success + PartyId?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Party: Create Commercial Account  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/176  
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Party: Create Commercial Account

**Domain**: payment

### Story Description

/kiro
# User Story

## Narrative
As a **Fleet Account Manager**, I want **to create a commercial customer account with legal name, billing profile, and identifiers** so that **workorders and invoices can be consistently tied to the correct business entity**.

## Details
- Capture: legal name, DBA, tax ID (optional), account status, default billing terms.
- Support external identifiers (ERP/customer number) as optional fields.
- Basic duplicate warning on create (name + phone/email match).

## Acceptance Criteria
- Can create account with required fields.
- Account has stable CRM ID.
- Duplicate warning presented when close matches exist.

## Integration Points (Workorder Execution)
- Workorder Execution can search/select the account by name/ID.
- Selected account CRM ID is stored on Estimate/Workorder.

## Data / Entities
- Party/Account
- ExternalId (optional)
- Audit fields

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #68: [FRONTEND] [STORY] Customer: Load Customer + Vehicle Context and Billing Rules â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/68
File: ./scripts/story-work/frontend/68/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:crm
- status:draft

### Recommended
- agent:crm-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** crm-pragmatic

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Customer: Load Customer + Vehicle Context and Billing Rules (Customer Snapshot Panel)

## Primary Persona
Service Advisor (POS user creating/managing an order)

## Business Value
Ensure order creation has fast, consistent access to customer account details, contacts, vehicles, and billing rule configuration so advisors can make correct billing/communication choices and downstream flows can reference billing rules without repeated lookups.

---

# 2. Story Intent

## As a / I want / So that
As a **Service Advisor**, I want to **load and view a Customer Snapshot** (account, contacts, vehicles, billing rules) for the selected customer so that **order creation can respect billing rules and preferred contacts** and I can validate the context quickly.

## In-scope
- Frontend screen/component(s) to fetch and display a **CustomerSnapshot** for a selected `accountId`
- Display: account metadata, contacts (including preferred contact method), vehicles (lightweight), billing rules (read-only)
- Explicit â€œRefreshâ€ behavior and visible â€œdata sourceâ€/stale indicators (cache vs API, stale if applicable)
- Error and empty states for missing contacts/vehicles/billing rules and for 403/404/5xx
- Moqui screen routing + transitions + service calls (frontend perspective)
- Hooks/structure for downstream â€œbilling rule enforcementâ€ (UI-level exposure of rule values to order flow), without implementing billing enforcement policies

## Out-of-scope
- Editing customer/contact/vehicle/billing rules (CRM is SoR; read-only here)
- Implementing business enforcement of billing rules (e.g., blocking checkout if PO missing) beyond exposing the rule values to the order draft/session
- Customer search/selection UI (assumed to exist elsewhere; this story starts from a known/selected `accountId`)
- Vehicle service history, tire specs, attachments, warranty, etc. (explicitly out of snapshot scope)
- Event-driven cache invalidation implementation (frontend will respond to metadata and manual refresh; backend handles invalidation)

---

# 3. Actors & Stakeholders

## Actors
- **Service Advisor**: Views snapshot while creating/managing an order
- **POS Frontend (Moqui screens)**: Initiates snapshot retrieval and renders it

## Stakeholders / Integrations
- **CRM backend**: Provides snapshot API (authoritative payload)
- **Workexec / Order creation flow**: Consumer of snapshot reference and billingRules values
- **Billing/Pricing domains**: Enforcement/meaning of rules (not implemented here)

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in POS
- User has permission to view the selected customer account (backend enforces; frontend must handle 403)
- A customer account has been selected, providing an `accountId` (UUID)

## Dependencies
- A reachable backend endpoint/service for â€œGet Customer Snapshot by accountIdâ€ that returns the schema described in backend story reference (CustomerSnapshot with `metadata.source`, `metadata.stale`, etc.)
- POS has an order draft/session concept to store a snapshot reference or the snapshot itself for reuse in order flow (exact storage location TBD â†’ Open Questions)

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From an **Order Draft / Order Create** screen when a customer is selected
- From a **Customer context panel** within the order workflow (side panel / section; layout not prescribed)

## Screens to create/modify
1. **Modify** existing Order Create / Order Draft screen to include a â€œCustomer Snapshotâ€ section that:
   - Accepts `accountId` (from selection) as input parameter
   - Loads snapshot on entry or when account changes
2. **Create (if needed)** a dedicated screen for customer context viewing:
   - Example: `apps/pos/screen/order/CustomerSnapshot.xml` (name TBD)
   - Used as an includable screenlet in order create

## Navigation context
- Screen parameters: `accountId` (required for load), optional `orderId`/`orderDraftId` (if available) for storing snapshot reference
- Add a â€œRefresh snapshotâ€ user action within the snapshot section

## User workflows

### Happy path
1. Advisor selects a customer (account)
2. Snapshot section loads and shows:
   - Account name/type/status
   - Contacts list with primary/preferred indicators
   - Vehicles list (VIN/description/unit/license plate)
   - Billing rules summary (PO required, tax exempt, payment terms, credit hold, etc.)
3. Advisor optionally clicks â€œRefreshâ€ to fetch a fresh snapshot
4. Snapshot values are available to the order draft/session as a read-only context/hook

### Alternate paths
- Account has no contacts â†’ show empty contacts state
- Account has no vehicles â†’ show empty vehicles state
- Billing rules missing/partial â†’ show defaults + warning indicator (based on payload content/metadata; do not invent policy)
- CRM unavailable â†’ show stale snapshot indicator if returned as stale; otherwise show error with retry/refresh option
- Unauthorized (403) â†’ show permission error and hide details

---

# 6. Functional Behavior

## Triggers
- Screen enter with `accountId`
- `accountId` changes (user selects a different customer)
- User clicks â€œRefresh snapshotâ€

## UI actions
- Load state: show loading indicator for snapshot panel
- Render snapshot sections when loaded
- Refresh action re-fetches snapshot (bypassing any client-side cache if present)
- Provide a â€œCopy identifiersâ€ action (accountId, vehicleId) if standard in project (safe UX default only if already a pattern; otherwise omit)

## State changes (frontend)
- `snapshotLoadState`: `idle | loading | loaded | error`
- `snapshot`: populated with last successful payload
- `lastError`: structured error info for display/logging
- Optional: `snapshotRef` stored into order draft/session (see Open Questions)

## Service interactions (frontend â†” backend)
- Call backend service/endpoint to fetch snapshot by `accountId`
- Pass auth context automatically via session
- Handle:
  - 200: render payload
  - 404: show â€œCustomer account not foundâ€
  - 403: show â€œNo permissionâ€
  - 5xx/timeout: show error; if payload includes stale snapshot use it and show warning

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- `accountId` must be present and must look like a UUID before attempting load
  - If missing/invalid: do not call backend; show inline error â€œCustomer account is requiredâ€
- Do not attempt to â€œfixâ€ or default domain data values on the client (billing rule defaults are backend responsibility per reference)

## Enable/disable rules
- â€œRefreshâ€ enabled only when:
  - `accountId` present AND not currently loading
- If 403 unauthorized:
  - Disable refresh and hide all customer details; show only the permission message

## Visibility rules
- Contacts section visible even if empty, but shows â€œNo contacts on fileâ€
- Vehicles section visible even if empty, but shows â€œNo vehicles associatedâ€
- Billing rules section visible even if missing; if missing in payload, show â€œBilling rules not configured (defaults applied)â€ ONLY if backend indicates defaults were applied (see Open Questions on how signaled)

## Error messaging expectations
- 404: â€œCustomer account not found. Verify the selected customer.â€
- 403: â€œYou do not have permission to view this customer.â€
- Network/5xx: â€œUnable to load customer snapshot. Try again.â€ plus â€œShow detailsâ€ expandable for a correlationId if available (do not show stack traces)

---

# 8. Data Requirements

## Entities involved (frontend read models)
- `CustomerSnapshot` (read-only view model)
- Nested: `contacts[]`, `vehicles[]`, `billingRules`, `metadata`

## Fields (type, required, defaults)
From backend reference schema (frontend must tolerate nullables):

### CustomerSnapshot
- `accountId`: UUID (required)
- `accountName`: string (required)
- `accountType`: enum `INDIVIDUAL|COMMERCIAL|FLEET` (required)
- `accountStatus`: enum `ACTIVE|INACTIVE|SUSPENDED` (required)
- `contacts`: array (required; may be empty)
- `vehicles`: array (required; may be empty)
- `billingRules`: object (required if backend always returns after defaulting; otherwise optional)
- `metadata`: object (required)
  - `retrievedAt`: ISO timestamp (required)
  - `source`: enum `CACHE|CRM_API` (required)
  - `stale`: boolean (required)
  - `staleSince`: ISO timestamp (optional)

### Contact
- `contactId`: UUID
- `name`: string
- `role`: string
- `phone`: string (optional)
- `email`: string (optional)
- `preferredContactMethod`: enum `PHONE|EMAIL|SMS|PORTAL|MAIL` (optional)
- `preferredFor`: list enum (optional)
- `doNotContact`: boolean (optional)
- `isPrimary`: boolean (required/expected)

### Vehicle
- `vehicleId`: UUID
- `vin`: string (expected 17 chars; display as-is)
- `make`: string
- `model`: string
- `year`: integer
- `mileage`: integer (optional)
- `description`: string (optional)
- `unitNumber`: string (optional)
- `licensePlate`: string (optional)

### BillingRules
- `poRequired`: boolean
- `taxExempt`: boolean
- `paymentTerms`: string
- `creditLimit`: decimal (optional)
- `creditHold`: boolean
- `invoiceDeliveryMethod`: enum `EMAIL|MAIL|PORTAL|EDI`
- `billingAddressId`: UUID (optional)
- `autoPayEnabled`: boolean
- `discountPolicyRef`: string (optional)
- `currency`: string ISO-4217 (optional)
- `extensions`: map (optional)

## Read-only vs editable by state/role
- All snapshot fields are **read-only** in this story (no edits)

## Derived/calculated fields (frontend only)
- â€œPreferred contact labelâ€ derived for display using backend-provided `isPrimary` / `preferredContactMethod` (do not re-run domain priority logic beyond simple highlighting; backend should provide stable ordering)
- â€œStale badgeâ€ derived from `metadata.stale == true`

---

# 9. Service Contracts (Frontend Perspective)

> Note: exact endpoint paths are not provided in frontend issue; must be confirmed.

## Load/view calls
- **Operation**: Get customer snapshot
- **Input**: `accountId` (UUID)
- **Output**: `CustomerSnapshot` JSON as defined above
- **Headers** (if supported): accept JSON; include auth session; correlation id response header should be captured if present

## Create/update calls
- none (read-only)

## Submit/transition calls
- Optional: store snapshot reference into order draft/session (Moqui service) (TBD â†’ Open Questions)

## Error handling expectations
- Map HTTP statuses:
  - 200 â†’ render
  - 400 â†’ show validation error (likely only if backend rejects accountId format)
  - 403 â†’ permission error state
  - 404 â†’ not found state
  - 409 â†’ concurrency/conflict (if backend uses ETag) show â€œUpdated elsewhere; refreshâ€
  - 5xx/timeout â†’ error; if response includes usable snapshot marked stale, render with warning

---

# 10. State Model & Transitions

## Allowed states (UI component)
- `idle`: no account selected yet
- `loading`: fetching snapshot
- `loaded`: snapshot displayed
- `error`: load failed (with message)

## Role-based transitions
- Service Advisor:
  - `idle â†’ loading` on selection
  - `loaded â†’ loading` on refresh
- Unauthorized user (403):
  - `loading â†’ error(unauthorized)` and remains blocked from viewing details

## UI behavior per state
- `idle`: show â€œSelect a customer to view detailsâ€
- `loading`: disable refresh, show spinner
- `loaded`: show sections + badges (source/stale)
- `error`: show error banner + retry (unless unauthorized)

---

# 11. Alternate / Error Flows

## Validation failures
- Missing/invalid `accountId`:
  - Do not call backend
  - Show inline message and keep snapshot panel in `idle` or `error` (implementation choice; must be consistent)

## Concurrency conflicts
- If backend supports ETag/snapshot version and returns 409:
  - Show message â€œCustomer data changed; refresh snapshotâ€
  - Provide refresh action

## Unauthorized access
- On 403:
  - Clear any previously loaded snapshot from UI (avoid data leakage when switching accounts)
  - Show permission message only

## Empty states
- Contacts empty: show empty state; no placeholder PII
- Vehicles empty: show empty state
- Billing rules missing: show â€œNot configuredâ€ only if backend indicates; otherwise show generic â€œUnavailableâ€

---

# 12. Acceptance Criteria

## Scenario 1: Load snapshot on customer selection (success)
Given I am a Service Advisor with permission to view customer account A  
And I navigate to an order draft where account A is selected  
When the Customer Snapshot section loads  
Then the UI requests the customer snapshot for account A  
And displays account metadata, contacts (may be empty), vehicles (may be empty), and billing rules  
And displays snapshot metadata including retrieved timestamp and source (CACHE or CRM_API)

## Scenario 2: Refresh snapshot
Given a customer snapshot for account A is displayed  
When I click â€œRefresh snapshotâ€  
Then the UI re-requests the snapshot for account A  
And updates the displayed data and metadata to match the latest response  
And shows a loading state while the refresh is in progress

## Scenario 3: Customer not found (404)
Given I attempt to load a snapshot for accountId X that does not exist  
When the backend responds with 404  
Then the UI shows â€œCustomer account not foundâ€  
And does not display any prior customerâ€™s snapshot data

## Scenario 4: Unauthorized (403)
Given I do not have permission to view account A  
When the UI requests the snapshot for account A  
And the backend responds with 403  
Then the UI shows â€œYou do not have permission to view this customerâ€  
And no customer details (contacts/vehicles/billing rules) are rendered

## Scenario 5: CRM/backend unavailable with stale snapshot returned
Given account A has a previously cached snapshot  
And the backend returns a snapshot response where metadata.stale is true  
When the UI renders the snapshot  
Then the UI shows a clear warning that the data is stale  
And displays staleSince when provided  
And still renders available snapshot sections

## Scenario 6: Network/5xx failure without snapshot
Given the backend is unavailable and no snapshot payload is returned  
When the snapshot request fails  
Then the UI shows a recoverable error message and a retry/refresh action  
And logs the failure with correlation information if available

---

# 13. Audit & Observability

## User-visible audit data
- Display `metadata.retrievedAt`, `metadata.source`, and stale indicator in the UI (non-PII)
- Do not display internal cache keys unless explicitly approved

## Status history
- Track last load time and last error in the UI state (not persisted unless order draft storage is defined)

## Traceability expectations
- Frontend logs/telemetry should include:
  - `accountId` (UUID)
  - result: success/error + HTTP status
  - latency (ms)
  - correlationId (if provided by backend)
- Avoid logging contact details (PII) in client logs

---

# 14. Non-Functional UI Requirements

- **Performance**: Snapshot panel should render within 2 seconds after response; show loading immediately on request start
- **Accessibility**: Loading and error states announced to screen readers; buttons have accessible labels
- **Responsiveness**: Works on tablet/desktop typical for POS
- **i18n/timezone**: Display timestamps in store/user timezone using standard app formatting (do not invent new formatting rules)
- **Security**: Do not cache PII in localStorage unless project convention explicitly allows (unknown â†’ Open Question)

---

# 15. Applied Safe Defaults

- SD-UX-EMPTY-STATES: Provide explicit empty states for contacts/vehicles sections; safe because it affects only UI ergonomics and does not change domain policy. Impacted sections: UX Summary, Error Flows, Acceptance Criteria.
- SD-UX-LOADING-RETRY: Standard loading indicator + retry action on transient failures; safe because it is generic error handling behavior. Impacted sections: Functional Behavior, Alternate/Error Flows, Acceptance Criteria.
- SD-OBS-CLIENT-LOG-SANITIZATION: Log only identifiers/status/correlationId and avoid PII; safe because it reduces risk and aligns with secure logging guidance. Impacted sections: Audit & Observability, Non-Functional UI Requirements.

---

# 16. Open Questions

1. What is the **exact Moqui service name and/or REST path** the frontend should call to retrieve `CustomerSnapshot` by `accountId` (and expected request/response envelope if not raw JSON)?
2. Where should the frontend store the snapshot for order creation: **order draft entity**, **server-side session**, or **client-only state**? If persisted, what is the entity/service contract for `orderDraft.customerSnapshotRef`?
3. How does the backend signal that **billing rule defaults were applied** (e.g., a flag in `metadata`, a warnings array, or always-returned fully-defaulted `billingRules`) so the UI can message accurately without guessing?
4. Is there an established convention for handling **stale snapshot** UI in this project (badge text, blocking vs non-blocking warning), and should any actions be disabled when `metadata.stale=true`?
5. Are there **role/permission scopes** the frontend should check client-side (in addition to backend 403 handling), or is backend-only authorization the standard?
6. Is client-side persistence (e.g., **localStorage**) allowed for snapshot caching, or must snapshot data remain in-memory only?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Customer: Load Customer + Vehicle Context and Billing Rules â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/68

Labels: frontend, story-implementation, payment

/kiro
# User Story

## Narrative
As a **Service Advisor**, I want a customer snapshot so that order creation respects billing rules and contacts.

## Details
- Show account, individuals, contacts, preferred contact method.
- Show vehicles and VIN/description.
- Show billing rules (PO required, tax exemption, terms).

## Acceptance Criteria
- Snapshot loads for selected customer.
- Billing rule enforcement hooks present.
- Cached/updated appropriately.

## Integrations
- CRM provides snapshot API; workexec can use same refs.

## Data / Entities
- CustomerSnapshot, VehicleRef, BillingRuleRef

## Classification (confirm labels)
- Type: Story
- Layer: Experience
- domain :  Point of Sale

