â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DOMAIN: workexec
Total Stories: 53
Generated: dim. 18 janv. 2026 12:03:02 EST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #109: [FRONTEND] [STORY] Rules: Maintain Substitute Relationships and Equivalency Types â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/109
File: ./scripts/story-work/frontend/109/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Rules: Maintain Substitute Relationships and Equivalency Types (Admin UI)

### Primary Persona
Product Admin (with inventory/catalog administration responsibilities)

### Business Value
Enable the business to define and manage part substitute relationships (equivalent/alternative/upgrade/downgrade) so execution workflows can suggest viable alternatives when an item is unavailable, while enforcing â€œauto-suggest vs approval-requiredâ€ policy and maintaining a complete audit trail.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Product Admin  
- **I want** to create, view, update, search, and deactivate substitute links between parts with an equivalency type and auto-suggest flag  
- **So that** work order execution can reliably query substitute candidates and respect policy (automatic suggestion vs requires approval), with traceable history for compliance.

### In-scope
- Moqui-based Admin UI screens to:
  - List/search substitute links
  - Create a substitute link
  - View substitute link details (including audit/metadata)
  - Update a substitute link with optimistic locking (`version`)
  - Deactivate (soft-delete) a substitute link
- â€œQuery substitutes for a partâ€ view (admin-facing) that uses the backend query endpoint and displays returned ranking/availability metadata.
- Frontend validation aligned with backend rules (required fields, enums, unique constraint handling, version conflicts).
- Display of audit-related metadata that is exposed by backend responses (created/updated fields, correlation id if provided).

### Out-of-scope
- Work order substitution application flow (`/api/v1/workorders/{workOrderId}/suggest-substitutes`) UI (technician/advisor runtime UX).
- Inventory availability ranking logic (server-side) beyond displaying returned metadata.
- Creating/editing parts/catalog items (owned by product/catalog domain).
- Defining approval policies beyond selecting the `isAutoSuggest` flag (policy configuration is not provided here).
- Building/defining backend endpoints or schemas (assumed to exist per backend reference).

---

## 3. Actors & Stakeholders
- **Primary user:** Product Admin
- **Secondary stakeholders:**
  - Service Advisor (consumer of accurate substitute data via workexec flows)
  - Technician/Mechanic (indirect consumer through suggested substitutes)
  - Inventory Manager (ensures substitutes make operational sense)
  - Compliance/Audit reviewer (needs traceability)

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend and authorized to manage substitutes.
- Backend endpoints exist and are reachable (see â€œService Contractsâ€):
  - `POST /api/v1/substitutes`
  - `PUT /api/v1/substitutes/{id}`
  - `GET /api/v1/substitutes/{id}`
  - `DELETE /api/v1/substitutes/{id}` (soft delete)
  - `GET /api/v1/parts/{partId}/substitutes?...`
- A way to select/identify â€œPartâ€ records in the UI exists:
  - either an existing part search/lookup endpoint/screen, or a minimal â€œenter partIdâ€ flow. (Currently unclear â†’ Open Questions)
- Backend supports optimistic locking via `version` on update and returns 409 on conflict.
- Backend handles unique constraint `(part_id, substitute_part_id)` and returns 409 with enough detail to show a meaningful message (unclear â†’ Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Admin navigation: **Rules â†’ Substitutes** (exact menu placement TBD by existing app nav conventions; implement as Moqui screen entry with menu item).

### Screens to create/modify
Create new Moqui screens under a consistent path, e.g.:
- `apps/pos/screen/rules/Substitutes.xml` (list/search)
- `apps/pos/screen/rules/SubstituteDetail.xml` (view/edit)
- `apps/pos/screen/rules/SubstituteCreate.xml` (create)

(Exact location/path may differ based on repo conventions â†’ if the frontend uses a different screen root, follow existing structure.)

### Navigation context
- From list â†’ click a row to open detail.
- From list â†’ â€œCreate Substitute Linkâ€ opens create screen.
- From detail â†’ â€œEditâ€ toggles to editable form or navigates to edit mode.
- From detail/list â†’ â€œDeactivateâ€ triggers confirmation then calls DELETE.

### User workflows
**Happy path: Create**
1. Product Admin opens Substitutes list screen.
2. Clicks â€œCreateâ€.
3. Selects Part and Substitute Part, selects Substitute Type, sets Auto Suggest, optional fields (priority/effective dates).
4. Saves â†’ system creates link, shows success, navigates to detail.

**Happy path: Update**
1. Admin opens link detail.
2. Clicks Edit, modifies fields, saves with current `version`.
3. On success, detail refreshes and shows updated metadata.

**Happy path: Query substitutes for a part (admin check)**
1. Admin opens a â€œSubstitutes for Partâ€ panel in detail or separate tab.
2. Enters/selects `partId`, optional `locationId`, `availableOnly`, `limit`.
3. UI calls backend query endpoint and renders ranked results and availability metadata.

**Alternate path: Duplicate link**
- If admin attempts to create a duplicate `(partId, substitutePartId)`, UI shows conflict message and links to existing resource when possible.

---

## 6. Functional Behavior

### Triggers
- Navigating to list/detail/create screens.
- Clicking Save/Update/Deactivate.
- Executing â€œQuery substitutesâ€ action.

### UI actions
- **List/Search**
  - Filter by `partId`, `substitutePartId`, `substituteType`, `isActive` (default active), and optionally â€œeffective nowâ€ (see Open Questions).
- **Create**
  - Collect required fields and post to backend.
- **Update**
  - Send updated fields + required optimistic `version`.
- **Deactivate**
  - Confirm modal then call DELETE; UI updates list/detail to show inactive.
- **Query substitutes**
  - Call query endpoint and render returned candidates in order.

### State changes (UI-level)
- Local UI state: loading, success toast/banner, inline field errors, conflict banner for 409, not found screen for 404.
- No frontend-owned domain state machines are introduced here; this story is CRUD/admin around substitute links.

### Service interactions
- Use Moqui `service-call` / REST calls per project convention for API integration.
- Ensure correlation/request id is propagated if the frontend already supports it (safe default only if it exists; otherwise leave).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
**Create/Update form validations (client-side, mirrored from backend):**
- `partId`: required
- `substitutePartId`: required and **must not equal** `partId`
- `substituteType`: required; must be one of:
  - `EQUIVALENT`, `APPROVED_ALTERNATIVE`, `UPGRADE`, `DOWNGRADE`
- `isAutoSuggest`: boolean; default false if not set
- `priority`: integer; default 100 if omitted (only if backend also defaults; otherwise leave blank â†’ Open Question)
- `effectiveFrom`, `effectiveTo`: optional; if both provided, `effectiveFrom <= effectiveTo`
- `version`: required for update

### Enable/disable rules
- â€œSaveâ€ disabled until required fields are present and basic validations pass.
- â€œDeactivateâ€ disabled if already inactive.
- â€œUpdateâ€ disabled if no changes detected (optional ergonomics).

### Visibility rules
- Audit metadata fields (createdBy/createdAt/updatedBy/updatedAt/version/isActive) displayed read-only on detail screen if present in response.
- Availability metadata in â€œQuery substitutesâ€ only shown when returned by the query endpoint.

### Error messaging expectations
- 400: show field-level errors if provided; otherwise a banner â€œValidation failedâ€.
- 403: show â€œYou do not have permission to manage substitutes.â€
- 404: show â€œSubstitute link not foundâ€ and link back to list.
- 409 (version conflict): show â€œThis substitute link was updated by someone else. Refresh and re-apply changes.â€
- 409 (duplicate): show â€œThis substitute relationship already exists.â€ If response includes existing `id`, show â€œView existingâ€ link.

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `SubstituteLink`
- `Part` (reference/lookup only; actual entity may be `part` or `product` depending on backend)
- Optional: `SubstituteAudit` or audit metadata (only if API exposes it)

### Fields
**SubstituteLink (as used by UI forms):**
- `id` (UUID/string) â€” read-only (assigned by backend)
- `partId` (string/uuid/long; exact type TBD) â€” required, editable on create; typically read-only after create (Open Question)
- `substitutePartId` (same type as partId) â€” required, editable on create; typically read-only after create (Open Question)
- `substituteType` (enum) â€” required, editable
- `isAutoSuggest` (boolean) â€” editable
- `priority` (int) â€” optional/editable
- `effectiveFrom` (datetime) â€” optional/editable
- `effectiveTo` (datetime) â€” optional/editable
- `isActive` (boolean) â€” read-only in UI; changed via Deactivate action
- `version` (int) â€” required for update; read-only display but must be sent
- `createdBy`, `createdAt`, `updatedBy`, `updatedAt` â€” read-only display if provided

**Query substitute candidates response (read-only table):**
- `substitutePartId`
- `substituteType`
- `priority`
- `availableQuantityByLocation[]` (structure TBD)
- `leadTimeDays` (optional)
- `estimatedTransferTimeHours` (optional)
- `priceDeltaMinor` (optional)

### Read-only vs editable by state/role
- Role enforcement is backend-owned; frontend should hide/disable create/edit/deactivate controls if user lacks permission **only if** frontend has an existing permission/role capability. Otherwise rely on backend 403.
- `id`, audit fields, `version` are read-only.
- `partId` and `substitutePartId` editability on update is unclear (Open Question).

### Derived/calculated fields
- None calculated on frontend beyond displaying derived metadata returned by server.

---

## 9. Service Contracts (Frontend Perspective)

> Note: API paths are taken from backend reference; if actual Moqui integration uses different base path/versioning, map accordingly.

### Load/view calls
- **List screen (optional if backend supports listing):**
  - Not specified in backend reference. If no list endpoint exists, the list screen must be backed by search-by-part flow (Open Question).
- **Get detail:**
  - `GET /api/v1/substitutes/{id}`
  - Success: 200 with SubstituteLink JSON
  - Errors: 404/403/500

### Create/update calls
- **Create:**
  - `POST /api/v1/substitutes`
  - Request JSON:
    - `partId`, `substitutePartId`, `substituteType`, `isAutoSuggest`, `priority?`, `effectiveFrom?`, `effectiveTo?`
  - Headers:
    - `Idempotency-Key` optional but recommended when supported (Open Question on frontend behavior)
  - Success: 201 Created with created resource JSON (must include `id` and `version`)
  - Errors:
    - 400 validation
    - 409 duplicate
    - 403 unauthorized

- **Update:**
  - `PUT /api/v1/substitutes/{id}`
  - Request includes changed fields and **must include `version`**
  - Success: 200 OK with updated resource JSON (new `version`)
  - Errors:
    - 400 validation
    - 409 version conflict
    - 403/404

### Submit/transition calls
- **Deactivate (soft delete):**
  - `DELETE /api/v1/substitutes/{id}`
  - Success: 200 or 204 (backend-dependent; treat both as success)
  - Errors: 403/404/409 (if backend blocks due to constraints; not specified)

### Query substitutes (for a given part)
- `GET /api/v1/parts/{partId}/substitutes?availableOnly=true&locationId=...&limit=10`
- Success: 200 array ordered by server ranking
- Errors: 400 (bad params), 404 (part not found), 403, 500

### Error handling expectations
- Map HTTP statuses to user-friendly messages (see Business Rules).
- Preserve and display backend-provided `correlationId` if included in error payload (Open Question: error schema).

---

## 10. State Model & Transitions

### Allowed states (SubstituteLink)
- `isActive = true|false` (active vs deactivated)
- Time effectiveness (optional): effective now vs not yet vs expired based on `effectiveFrom/effectiveTo` (display-only unless explicitly filtered)

### Role-based transitions
- Product Admin can:
  - Create link
  - Update link
  - Deactivate link
- Others:
  - May view/query depending on permission; not defined here (Open Question)

### UI behavior per state
- If inactive:
  - Show â€œInactiveâ€ status
  - Disable edit and deactivate
- If effective dates indicate not currently effective:
  - Show status badge â€œNot effective yetâ€ or â€œExpiredâ€ (display-only; safe UX default)

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required fields: inline errors; prevent submit.
- effective date range invalid: inline errors; prevent submit.
- partId == substitutePartId: inline error; prevent submit.

### Concurrency conflicts
- Update with stale `version` returns 409:
  - UI shows conflict banner
  - Provide â€œReloadâ€ action that refetches detail
  - If user had edits, warn they will be lost unless copied manually (do not auto-merge).

### Unauthorized access
- 403 on any action:
  - Show a permission error banner
  - Hide mutation controls after first 403 for that session/screen (optional)

### Empty states
- List view: â€œNo substitute links foundâ€ with CTA to create.
- Query substitutes: â€œNo substitutes configured for this partâ€ or â€œNo available substitutesâ€ depending on `availableOnly` toggle.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create a substitute link (happy path)
Given I am authenticated as a Product Admin  
And I am on the â€œCreate Substitute Linkâ€ screen  
When I enter a valid partId and substitutePartId  
And I select substituteType = "EQUIVALENT"  
And I set isAutoSuggest = false  
And I click Save  
Then the system creates the substitute link via POST `/api/v1/substitutes`  
And I see a success message  
And I am navigated to the substitute link detail screen showing the new link id and version.

### Scenario 2: Prevent creating a self-substitute
Given I am on the â€œCreate Substitute Linkâ€ screen  
When I set substitutePartId equal to partId  
Then the Save action is disabled or blocked  
And I see an inline error stating the substitute part must be different from the base part.

### Scenario 3: Handle duplicate substitute link conflict
Given a substitute link already exists for partId P and substitutePartId S  
And I am on the â€œCreate Substitute Linkâ€ screen  
When I attempt to create the same relationship again  
Then the backend responds with HTTP 409  
And the UI displays a conflict message indicating the relationship already exists  
And if the response includes the existing link id, the UI provides a link to open it.

### Scenario 4: Update a substitute link with optimistic locking
Given I am on a substitute link detail screen  
And the link has version V  
When I change priority and click Save  
Then the UI sends PUT `/api/v1/substitutes/{id}` including version V  
And on success I see the updated values  
And the displayed version increments (or updates) based on the response.

### Scenario 5: Update conflict due to stale version
Given I am editing a substitute link with version V  
And another user has updated the link so the current version is now V+1  
When I click Save with version V  
Then the backend responds with HTTP 409  
And the UI shows a concurrency conflict message  
And provides an action to reload the latest version.

### Scenario 6: Deactivate (soft delete) a substitute link
Given I am on a substitute link detail screen for an active link  
When I click Deactivate and confirm  
Then the UI calls DELETE `/api/v1/substitutes/{id}`  
And on success the UI shows the link as inactive  
And the Deactivate action is no longer available.

### Scenario 7: Query substitutes for a part with availability-only filter
Given I am on the â€œSubstitutes for Partâ€ query panel  
When I enter partId P and set availableOnly=true and locationId L  
And I submit the query  
Then the UI calls GET `/api/v1/parts/{partId}/substitutes` with those parameters  
And renders the returned candidates in the order received  
And displays availability metadata per candidate when provided.

### Scenario 8: Unauthorized user cannot modify substitutes
Given I am authenticated without substitute-management permission  
When I attempt to create, update, or deactivate a substitute link  
Then the backend responds with HTTP 403  
And the UI displays a permission error and does not apply the change.

---

## 13. Audit & Observability

### User-visible audit data
- On detail screen, display (if available from API):
  - createdAt/createdBy, updatedAt/updatedBy, version, isActive
- If backend exposes audit trail entries:
  - Provide an â€œAuditâ€ section listing operations (CREATE/UPDATE/DELETE), timestamp, actor, and (optional) correlation id.
  - If not exposed, do not invent (Open Question).

### Status history
- For SubstituteLink itself, only active/inactive is tracked in UI unless audit endpoint exists.

### Traceability expectations
- Ensure frontend includes correlation/request id header if project convention exists.
- Ensure errors surface correlation id to assist support.

---

## 14. Non-Functional UI Requirements

- **Performance:** list/detail views should load within 2s on typical network; query substitutes should show loading state and allow cancellation/navigation away.
- **Accessibility:** all form controls labeled; keyboard navigable; validation errors announced via ARIA where applicable (Quasar supports).
- **Responsiveness:** screens usable on tablet width; tables horizontally scroll if needed.
- **i18n/timezone:** display datetimes in userâ€™s locale/timezone if the app has a standard; otherwise display ISO with timezone indicator (Open Question about project standard).
- **Security:** do not expose internal-only fields; never log sensitive data in browser console; rely on backend auth.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging and CTA on list/query results; safe because it does not change domain logic; impacts UX Summary, Alternate/Empty states.
- SD-UX-LOADING-ERROR: Standard loading spinners and error banners per screen; safe because it only affects presentation; impacts UX Summary, Error Flows.
- SD-UX-PAGINATION: If list endpoint exists, paginate with a conservative default page size (e.g., 25) using standard table pagination; safe because itâ€™s UI ergonomics only; impacts UX Summary, Functional Behavior.

---

## 16. Open Questions

1. **Domain boundary/ownership confirmation:** This story is labeled `domain:workexec`, but it is â€œProduct/Parts Managementâ€ flavored. Is workexec definitively the owning frontend area for the admin UI, or should this be `domain:inventory` or a product domain label if one exists in this repo? (Blocking label may change.)
2. **Part lookup UX contract:** What existing endpoint/screen should the admin UI use to search/select parts (by SKU/name) rather than manually entering IDs? Please provide the API route(s) and response shape.
3. **List/search endpoint for SubstituteLink:** Do we have `GET /api/v1/substitutes` (with filters/pagination), or must the list screen be built around â€œquery by partIdâ€ only?
4. **Error payload schema:** When backend returns 400/409, what is the standard error response format (field errors, message, correlationId, existingResourceId on duplicates)?
5. **Idempotency-Key usage:** Should the frontend generate and send `Idempotency-Key` for create calls by default (e.g., UUID per submit) to protect against double-submits?
6. **Editability of key fields:** On update, are `partId` and `substitutePartId` immutable (recommended) or editable? If editable, how should uniqueness conflicts be handled?
7. **Defaults alignment:** Does backend default `priority=100` and `isAutoSuggest=false` when omitted, or must UI always send explicit values?
8. **Audit trail visibility:** Is there an API to fetch `SubstituteAudit` entries for display? If not, should UI only show basic created/updated metadata?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Rules: Maintain Substitute Relationships and Equivalency Types â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/109

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Rules: Maintain Substitute Relationships and Equivalency Types
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/109
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Rules: Maintain Substitute Relationships and Equivalency Types

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Product Admin**, I want substitute relationships so that workexec can suggest alternatives when items are unavailable.

## Details
- Types: Equivalent, ApprovedAlternative, Upgrade, Downgrade.
- Control whether suggestion is automatic or requires approval.

## Acceptance Criteria
- Create/update substitute link.
- Query substitutes.
- Policies enforced.
- Audited.

## Integrations
- Workexec uses substitute list; inventory availability ranks candidates.

## Data / Entities
- SubstituteLink, SubstituteType, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Product / Parts Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #113: [FRONTEND] [STORY] Workexec: Handle Substitution Pricing for Part Substitutions  
File: ./scripts/story-work/frontend/113/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Priced Part Substitution Picker for Work Order/Estimate Part Lines

### Primary Persona
Service Advisor

### Business Value
When an original part is unavailable, the advisor can quickly choose an authorized substitute with correct customer pricing and audit traceability, reducing delays and avoiding manual pricing math.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to fetch authorized substitute candidates for an unavailable part line and see availability + pricing (including policy flags)  
- **So that** I can select a substitute confidently and keep the estimate/work order accurate and auditable without manual math.

### In-Scope
- UI action on a specific **part line item** to â€œFind substitutesâ€
- Display of substitute candidates with:
  - availability status
  - price quote (or â€œPrice unavailableâ€)
  - substitution/policy flags (e.g., OEM/Aftermarket) as provided by backend
- Apply selected substitute to the target line item via backend call
- Enforce â€œcannot commit without price unless manual price permissionâ€ at UI level (based on backend response/permission signal)
- User cancel flow leaving the line unchanged
- Empty states and error states aligned to backend outcomes

### Out-of-Scope
- Authoring/editing substitution policies (parts/inventory domain configuration)
- Reprice workflow after a substitute is applied (explicit separate action/story)
- Inventory receiving/picking flows
- Notification delivery for any alerts
- Creating non-catalog parts or manual price entry UX (unless explicitly clarified as required here)

---

## 3. Actors & Stakeholders

### Actors
- **Service Advisor**: initiates substitute search and applies a substitute to a line
- **System (Moqui frontend)**: orchestrates calls to backend endpoints, renders candidates, blocks invalid commits

### Stakeholders
- **Parts Manager / Inventory team**: expects only policy-allowed substitutions shown
- **Service Manager**: expects fast workflow and correct pricing
- **Customer**: expects accurate estimate/invoice matching substituted part used
- **Audit/Compliance**: expects traceable, immutable substitution history

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated
- A Work Order or Estimate exists and is viewable by the user
- A target **part line item** exists and is eligible for substitution (original is unavailable per workflow context; backend is source of truth)

### Dependencies
- Backend endpoints exist and are reachable for:
  - retrieving substitute candidates (with availability + policy flags)
  - retrieving pricing (either embedded in candidate response or via backend aggregation)
  - applying a selected substitute to a line item
- Backend provides a permission/decision mechanism for â€œmanual price allowedâ€ if pricing unavailable (e.g., permission flag, capability field, or 403/409 responses)
- Moqui screen(s) already exist for viewing/editing work orders/estimates with part lines (this story will extend them)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Work Order detail** screen, within the **Parts** line items section, an action per line: `Find Substitutes`
- From **Estimate detail** screen, within the **Parts** line items section, an action per line: `Find Substitutes`

### Screens to create/modify
- **Modify** existing screens (expected):
  - `WorkOrderDetail` (or equivalent): add action & modal/dialog
  - `EstimateDetail` (or equivalent): add action & modal/dialog
- **Create** a reusable embedded screen/component:
  - `components/PartSubstitutionPicker` (Moqui screen include) to render candidate list and handle apply/cancel

> Exact screen names/paths must match repo conventions (see Open Questions).

### Navigation context
- Picker opens as a modal/dialog (Quasar `QDialog`) over the current detail screen
- On successful apply:
  - dialog closes
  - the line item row updates immediately (refresh line items) showing substitute part number/description and locked price

### User workflows

#### Happy path (priced candidate)
1. Advisor clicks `Find Substitutes` on a part line.
2. System loads candidates.
3. Advisor selects a candidate with an available price.
4. Advisor confirms apply.
5. System applies substitution; line updates; success message displayed.

#### Alternate path (pricing unavailable)
1. Candidate appears with `Price Unavailable`.
2. Advisor can view but cannot confirm apply unless manual price is allowed (per backend/permission).

#### Alternate path (no results)
- Show â€œNo authorized substitutes found.â€ or â€œNo substitutes are currently available.â€ depending on backend classification.

#### Cancel
- Advisor closes dialog without changes.

---

## 6. Functional Behavior

### Triggers
- User clicks `Find Substitutes` on a specific part line item for:
  - a Work Order, or
  - an Estimate

### UI actions
- Open picker dialog
- Show loading state while fetching candidates
- Show list of candidates:
  - part number, description
  - availability status text
  - price display (formatted currency) or â€œPrice Unavailableâ€
  - policy flags badges (as returned)
- Candidate selection:
  - single select
- Confirm:
  - calls apply endpoint
- Cancel:
  - closes without calling apply endpoint

### State changes (frontend)
- Local dialog state: `loading`, `loaded`, `error`
- Selected candidate state
- After apply success: refresh the parent screenâ€™s line item data from backend

### Service interactions
- Fetch candidates: 1 call on dialog open (or on explicit â€œSearchâ€ if required)
- Apply substitution: 1 call on confirm
- Refresh line: either:
  - re-fetch the full work order/estimate detail, or
  - re-fetch line items list, or
  - update line from apply response (preferred if backend returns updated line)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Must have `workOrderId` + `lineItemId` OR `estimateId` + `lineItemId` before opening picker
- Confirm/Apply button enabled only when:
  - a candidate is selected AND
  - candidate has a resolved price **OR** user is allowed to proceed via manual price override mechanism (see Open Questions)

### Enable/disable rules
- Disable `Find Substitutes` action if line is not eligible (only if backend provides an explicit flag like `canSubstitute=false`; otherwise show action but handle backend 409 with user-friendly message)

### Visibility rules
- Show policy flags only as provided; do not infer (no safe defaults)
- If backend indicates candidate exists but is not available:
  - either hide it or show it disabled; must align to backend payload semantics (Open Question)

### Error messaging expectations
- No substitutes: â€œNo authorized substitutes found.â€
- None available: â€œNo substitutes are currently available.â€
- Pricing failure for candidate: show candidate with â€œPrice Unavailableâ€
- Apply failure due to stale state/lock: â€œThis line changed since you opened substitutes. Refresh and try again.â€
- Unauthorized: â€œYou donâ€™t have permission to substitute parts on this document.â€

---

## 8. Data Requirements

### Entities involved (frontend-facing)
From backend story reference (for conceptual mapping):
- SubstituteLink
- SubstitutePolicy
- PriceQuoteResponse
- WorkOrder line item (part line)
- Estimate line item (part line)
- WorkOrderPartSubstitution (history record created server-side)

### Fields

#### Inputs (required)
- `workOrderId` (string/number) OR `estimateId` (string/number)
- `lineItemId` (string/number)
- `originalPartNumber` (string) **if required by backend** (Open Question: can backend derive from lineItemId?)

#### Candidate display fields (from backend)
- `partNumber` (string, required)
- `description` (string, optional but expected)
- `availabilityStatus` (enum/string, required)
- `availabilityMessage` (string, optional)
- `policyFlags` (string[], optional)
- `priceStatus` (enum: e.g., AVAILABLE | UNAVAILABLE, required)
- `unitPrice` / `finalPrice` (decimal, nullable)
- `currency` (ISO-4217 string, required if price present)
- optional: `pricingErrorCode` (string, optional; must be non-sensitive)

#### Apply payload fields (minimum)
- Selected substitute identifier:
  - `substitutePartNumber` (string) and/or `substituteProductId` (id)
- Optional: `reasonCode` (string) **(Open Question: required? UI not specified)**

### Read-only vs editable
- All candidate fields are read-only
- Selection is editable (radio/select)
- Apply confirm is an action, not editable data

### Derived/calculated fields
- Price formatting (currency)
- Availability label text mapping (frontend-only)

---

## 9. Service Contracts (Frontend Perspective)

> Backend reference provides high-level behavior but not exact endpoints for this substitution feature. Frontend must NOT guess final paths; see Open Questions.

### Load/view calls

**Contract A: Fetch substitution candidates**
- Purpose: return policy-filtered substitutes with availability + pricing (if available), plus flags
- Request (conceptual):
  - `GET /api/.../substitutes?workOrderId&lineItemId` or similar
- Response (conceptual):
  - `{ originalPartNumber, candidates:[{...fields above...}], constraints:{...} }`

### Create/update calls

**Contract B: Apply substitute to line item**
- Purpose: update line item to substitute and lock price; create substitution history
- Request (conceptual):
  - `POST /api/.../apply-substitute` with identifiers
- Response (conceptual):
  - updated line item snapshot and substitution id, or success + require refresh

### Submit/transition calls
- None beyond apply substitution

### Error handling expectations (HTTP mapping)
- `400` invalid request (missing ids)
- `401/403` unauthorized/forbidden
- `404` work order/estimate/line not found
- `409` conflict (line changed, state not eligible, price lock constraint, etc.)
- `5xx` backend failure â†’ show generic error with retry

---

## 10. State Model & Transitions

### Allowed states (domain)
This story does **not** define new workflow states. It respects:
- Estimate state machine (DRAFT/APPROVED/DECLINED/EXPIRED) for whether editing is allowed (backend source of truth)
- WorkOrder state machine (DRAFT/APPROVED/ASSIGNED/WORK_IN_PROGRESS/...) for whether substitution is allowed (backend source of truth)

### Role-based transitions
- Apply substitution is an authorized action; frontend displays action based on existing screen permissions if available (otherwise rely on backend 403)

### UI behavior per state
- If backend indicates the document is not editable / substitution not allowed:
  - disable `Find Substitutes` and show tooltip/message indicating why (if backend provides reason)
- If state becomes invalid while dialog open:
  - apply returns 409; UI prompts refresh

---

## 11. Alternate / Error Flows

### Validation failures
- Missing identifiers: do not open dialog; show inline error/log

### Concurrency conflicts
- If apply returns `409` because line changed or was already substituted:
  - close dialog or keep open with â€œRefresh candidatesâ€ action
  - force refresh of parent line items on user action

### Unauthorized access
- If fetch candidates returns `403`:
  - show â€œYou donâ€™t have permissionâ€¦â€ and do not render list

### Empty states
- No authorized substitutes: show message; no list
- Substitutes exist but none available: show message; optionally allow toggling â€œShow unavailableâ€ if backend returns them (Open Question)

---

## 12. Acceptance Criteria

### Scenario 1: View priced substitute candidates and apply
**Given** I am a Service Advisor viewing a Work Order with a part line item that is unavailable  
**When** I click â€œFind Substitutesâ€ for that part line  
**Then** I see a list of authorized substitute candidates including availability and final customer price (where available) and policy flags  
**When** I select a candidate with `priceStatus=AVAILABLE` and confirm  
**Then** the system applies the substitution via backend  
**And** the part line item updates to show the substitute part number/description and locked price  
**And** the original part is preserved for traceability (server-side)

### Scenario 2: No authorized substitutes
**Given** I am viewing a part line with no policy-authorized substitutes  
**When** I click â€œFind Substitutesâ€  
**Then** I see â€œNo authorized substitutes found.â€  
**And** no line item changes occur

### Scenario 3: Substitutes exist but none available
**Given** authorized substitutes exist but all have `availabilityStatus` indicating not available  
**When** I click â€œFind Substitutesâ€  
**Then** I see â€œNo substitutes are currently available.â€ (or equivalent backend-provided message)  
**And** I cannot apply a substitute  
**And** no line item changes occur

### Scenario 4: Pricing unavailable for an available substitute
**Given** a substitute candidate is available but pricing fails and it is returned with `priceStatus=UNAVAILABLE` and `unitPrice=null`  
**When** I view the candidate list  
**Then** I see that candidate with â€œPrice Unavailableâ€  
**And** the Apply/Confirm action is disabled for that candidate unless the backend indicates manual price is permitted

### Scenario 5: User cancels
**Given** the substitution picker is open  
**When** I cancel/close the dialog  
**Then** no backend apply call is made  
**And** the original line item remains unchanged

### Scenario 6: Concurrency conflict on apply
**Given** I opened substitutes for a line item  
**And** the line item changes on the server before I confirm  
**When** I attempt to apply a substitute  
**Then** I receive a conflict error (409)  
**And** the UI instructs me to refresh and try again  
**And** no partial UI state persists as â€œappliedâ€

---

## 13. Audit & Observability

### User-visible audit data
- After apply success, show a success toast including substitute part number
- If the screen has an â€œHistory/Activityâ€ section, refresh it (if available) so substitution appears (server-side audit remains authoritative)

### Status history
- Not creating a new state machine; rely on server audit entities/events

### Traceability expectations
- Frontend must pass identifiers sufficient for backend to:
  - record `selectedBy` and `selectedAt` (backend should derive user from auth context; do not send PII)
  - link substitution to workOrderId/estimateId and lineItemId
- Include correlation id header if project convention exists (Open Question)

---

## 14. Non-Functional UI Requirements

- **Performance:** Candidate fetch should render within 2s for typical lists (<50 candidates). Show loading state immediately.
- **Accessibility:** Dialog is keyboard navigable; focus trapped in dialog; selection accessible via keyboard; status text readable by screen readers.
- **Responsiveness:** Works on tablet layout; dialog content scrolls.
- **i18n/timezone/currency:** Currency formatting uses backend-provided currency code; no currency conversion performed on frontend.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit empty states (â€œNo authorized substitutes foundâ€, â€œNo substitutes currently availableâ€) to avoid blank lists; safe because itâ€™s UI ergonomics and does not change business policy. (Impacted: UX Summary, Error Flows)
- SD-ERR-HTTP-MAP: Standard mapping of HTTP 400/403/404/409/5xx to user-facing messages and retry behavior; safe because itâ€™s generic error handling and does not define domain policy. (Impacted: Service Contracts, Alternate/Error Flows)

---

## 16. Open Questions

1. **Backend API contract (blocking):** What are the exact endpoints and payload schemas for:
   - fetching substitution candidates for a *work order part line*?
   - fetching substitution candidates for an *estimate part line*?
   - applying a selected substitute to the target line?
2. **Document scope (blocking):** Is substitution supported on **both** Estimates and Work Orders in the frontend for this story, or only Work Orders? Backend story mentions â€œWork Order (or Estimate)â€ but UI scope must be confirmed.
3. **Eligibility source (blocking):** How does frontend determine the â€œoriginal is unavailableâ€ condition?
   - Is there a line-level field like `availabilityStatus=UNAVAILABLE`?
   - Or should the action always be available and backend enforces?
4. **Manual price override (blocking/security):** How does backend indicate the user has permission `ENTER_MANUAL_PRICE`, and what is the expected frontend behavior?
   - Is manual price entry required in this story or explicitly out-of-scope?
5. **Candidate inclusion rules (blocking):** Should the backend return:
   - only available candidates, or
   - both available and unavailable candidates with availability statuses?
   The backend story includes messaging for both; UI behavior depends on payload.
6. **Identity/audit (non-blocking if convention exists):** Does the frontend need to send `approvedBy/userId` style fields, or does backend derive user from auth? (Prefer derived.)
7. **Moqui screen routing (blocking for implementation):** What are the actual screen paths/names for Work Order detail and Estimate detail in `durion-moqui-frontend` to attach this feature?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Workexec: Handle Substitution Pricing for Part Substitutions  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/113  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Workexec: Handle Substitution Pricing for Part Substitutions

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Service Advisor**, I want substitutes priced when originals are unavailable so that work continues without manual math.

## Details
- Return substitute candidates with availability + prices.
- Enforce allowed substitution types.

## Acceptance Criteria
- Candidates returned with policy flags.
- Selection captured on estimate/WO line.

## Integrations
- Workexec integrates with substitution + availability queries.

## Data / Entities
- SubstituteLink, SubstitutePolicy, PriceQuoteResponse

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Product / Parts Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #123: [FRONTEND] [STORY] CrossDomain: Workexec Displays Operational Context in Workorder View  
File: ./scripts/story-work/frontend/123/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Work Order: Display Operational Context (Location/Bay/Team) with Pre-Start Update Rules and Audit

### Primary Persona
Mechanic (primary), Shop Manager / Service Advisor (secondary for privileged updates)

### Business Value
Mechanics can immediately see where to work (location/bay) and who theyâ€™re working with (team/assigned mechanics), reducing misrouting and improving shop-floor coordination; managers retain controlled ability to correct dispatch context with traceable audit.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Mechanic  
- **I want** the work order view to display operational context (location/bay/team/schedule/resources/constraints)  
- **So that** I know where to work and who/what is assigned before starting work.

### In-Scope
- Add an **Operational Context** panel/section to the Work Order view screen(s).
- Fetch and render operational context from **Shopmgr (system of record)** via Workexec/Shopmgr REST endpoints described in backend reference.
- Enforce **update/edit rules**:
  - Mechanic: read-only.
  - Manager override: allowed (privileged action) and **restricted after work start**.
- Display audit/trace info for context and overrides (who/when/reason/version).
- Handle partial/missing context and upstream unavailability gracefully.

### Out-of-Scope
- Creating/maintaining operational context as a writable independent record in frontend.
- Configuring bays/locations/teams or permissions model details (security domain).
- Event-stream consumption in the frontend (polling/refresh only unless specified).
- Work order start/transition UI beyond what is required to support â€œafter start lockâ€ behavior (we will only *react* to current work order status).

---

## 3. Actors & Stakeholders
- **Mechanic**: Views work order; needs operational context for execution.
- **Shop Manager**: May request/submit overrides to operational context when permitted.
- **Service Advisor**: May also act as manager-equivalent depending on RBAC (needs clarification).
- **Shopmgr (Shop Management System)**: System of record for operational context.
- **Workexec backend**: Provides work order status and may proxy override actions / lock context at work start.
- **Audit/Compliance stakeholders**: Require immutable traceability for overrides and lock-at-start behavior.

---

## 4. Preconditions & Dependencies
### Preconditions
- User is authenticated in the Moqui UI.
- Work Order exists and is viewable by the current user.
- Work Order has a current status available (e.g., `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, etc.).

### Dependencies (Backend/Contracts)
This frontend story depends on backend endpoints/contracts (from backend reference):
- **Shopmgr Operational Context**
  - `GET /shopmgr/v1/workorders/{workOrderId}/operational-context`
- **Manager Override (privileged)**
  - `POST /workexec/v1/workorders/{workOrderId}/operational-context:override`
- **Work order status (for â€œstartedâ€ determination)**
  - Workexec state machine statuses include: `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`.

### Moqui/Frontend Dependency
- Existing Work Order view route/screen must exist in `durion-moqui-frontend` (exact path/URL unknown from inputs).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From any work order list/search screen: user opens a Work Order detail view.
- Direct navigation via deep link to a Work Order view by ID.

### Screens to create/modify
- **Modify** existing Work Order detail screen (Moqui Screen) to add an â€œOperational Contextâ€ section.
  - If no Work Order view exists, create one (blocking clarification: confirm route conventions).

### Navigation context
- Operational context appears on the Work Order view page and refreshes when:
  - Page loads
  - User triggers explicit refresh
  - (Optional safe default) on standard pull-to-refresh / page refresh behavior

### User workflows
#### Happy path: Mechanic views operational context
1. Mechanic opens Work Order.
2. UI loads work order details (existing).
3. UI loads operational context from Shopmgr and renders:
   - Location, Bay, Dispatch Schedule, Assigned Mechanics, Resources, Constraints, last updated metadata, version.
4. UI indicates data source: â€œProvided by Shop Management (Shopmgr)â€.

#### Manager flow: request override (pre-start)
1. Manager opens Work Order in a pre-start status (e.g., `APPROVED` or `ASSIGNED`).
2. UI shows â€œRequest Overrideâ€ action.
3. Manager enters override fields + reason and submits.
4. UI calls override endpoint, then re-fetches operational context and displays updated version and audit note.

#### Alternate path: after work start
1. Work Order status indicates started (`WORK_IN_PROGRESS` or other in-progress sub-status).
2. UI disables inline override and indicates â€œChanges require manager actionâ€ (but backend reference implies overrides are possible with permission; the story input says after start require manager actionâ€”needs clarification whether *override action* remains available for managers after start).

---

## 6. Functional Behavior

### Triggers
- Screen load of Work Order view.
- Manual refresh action.
- Successful override submission.

### UI actions
- **View**: render operational context fields with placeholders for missing optional fields.
- **Override (privileged)**: open a modal/form to submit changes:
  - override fields (at minimum bay and/or schedule) + required reason.
- **Refresh**: re-fetch operational context.

### State changes (frontend)
- Loading states:
  - `loadingOperationalContext=true/false`
- Error states:
  - `operationalContextLoadError` populated on failure.
- Post-override:
  - show success toast/banner and refreshed context version.

### Service interactions (high-level)
- `GET` operational context from Shopmgr endpoint.
- `POST` override to Workexec endpoint with optimistic concurrency field if required (version).
- (If available/required) Load work order status from Workexec to determine â€œstartedâ€ and gate actions.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Override submission requires:
  - `reason` (non-empty)
  - At least one field in `overrides` set (e.g., bayId or scheduledStartAt, etc.) **(needs confirmation)**
  - If backend requires `actorId`, frontend must provide current user ID (from session context).
  - If backend requires `version` for optimistic concurrency, include current `version` (from latest GET).

### Enable/disable rules
- **Operational Context panel**: always visible if work order viewable.
- **Override action visibility**:
  - Visible only to users with `workexec:operational_context:override` permission (frontend may not be able to determine; can show and rely on 403 handling, but better if permission is available in sessionâ€”needs clarification).
- **Override action enabled/disabled based on work order status**:
  - If status is start-eligible (`APPROVED`, `ASSIGNED`): override allowed for permitted users.
  - If status is in-progress (`WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`): behavior unclear per inputs (see Open Questions).
  - If terminal (`COMPLETED`, `CANCELLED`): override disabled.

### Visibility rules
- Show â€œLocked at work startâ€ indicator if context includes `lockedAtWorkStart=true` (backend reference mentions this as a field; Shopmgr response schema does not include itâ€”needs clarification).

### Error messaging expectations
- Upstream load failure: â€œOperational context is temporarily unavailable. You can still view the work order.â€
- 403 on override: â€œYou do not have permission to override operational context.â€
- 409 on override (version conflict): â€œOperational context changed since you loaded this page. Refresh and try again.â€
- 400 validation: show field-level messages (reason required, invalid timestamps, etc.).
- 404: â€œWork order or operational context not found.â€

---

## 8. Data Requirements

### Entities involved (frontend view models)
- **WorkOrder** (from Workexec backend, existing in UI)
  - `id`
  - `status` (must map to known FSM statuses)
- **Operational Context** (from Shopmgr)
  - `workOrderId` (string/uuid)
  - `version` (number)
  - `location.locationId` (string/uuid)
  - `location.locationName` (string)
  - `bay.bayId` (string/uuid, nullable)
  - `bay.bayName` (string, nullable)
  - `bay.bayType` (string, nullable)
  - `dispatchSchedule.scheduledStartAt` (ISO timestamp, nullable)
  - `dispatchSchedule.scheduledEndAt` (ISO timestamp, nullable)
  - `assignedMechanics[]`:
    - `mechanicId` (string/uuid)
    - `name` (string)
    - `role` (string enum unknown: e.g., `LEAD`)
    - `assignedAt` (ISO timestamp)
  - `assignedResources[]`:
    - `resourceId`, `resourceType`, `resourceName`
  - `constraints[]`:
    - `constraintType`, `value`
  - `metadata.lastUpdatedAt` (ISO timestamp)
  - `metadata.lastUpdatedBy` (string)

### Fields: required vs optional
- Required to display minimally (per backend BR3):
  - Location name (required if present; if missing treat as unavailable)
  - Assigned mechanics (may be empty list but should render as â€œNone assignedâ€)
  - Work order status (from work order)
- Optional:
  - Bay, schedule, resources, constraints

### Read-only vs editable
- All operational context fields are **read-only** in Work Order view.
- Override form fields are editable inputs but do not directly mutate local â€œsource of truthâ€; they submit a request to backend.

### Derived/calculated fields
- â€œStartedâ€ boolean derived from Work Order status âˆˆ {`WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`} (this mapping must be confirmed; see Open Questions).
- Display-friendly schedule times derived from timestamps with shop timezone (timezone source unknown; see Open Questions).

---

## 9. Service Contracts (Frontend Perspective)

> Note: Moqui frontend may call Moqui services that proxy to backend APIs. Exact service names are not provided; below are required contracts at HTTP level plus expected Moqui service wrappers.

### Load/view calls
1. **Load Work Order (existing)**
   - Contract: existing Workexec endpoint used by current Work Order view.
   - Must provide: `status` at minimum.

2. **Load Operational Context**
   - `GET /shopmgr/v1/workorders/{workOrderId}/operational-context`
   - Success: `200` with schema per backend reference (RQ2).
   - Failures:
     - `404` not found
     - `503/504` upstream unavailable/timeout

### Create/update calls
- None (direct CRUD) in this story.

### Submit/transition calls
1. **Override Operational Context (privileged)**
   - `POST /workexec/v1/workorders/{workOrderId}/operational-context:override`
   - Request body (from backend reference RQ1):
     ```json
     {
       "overrides": {
         "bayId": "uuid",
         "scheduledStartAt": "2025-01-24T10:00:00Z"
       },
       "reason": "Emergency vehicle arrival; bay 3 required",
       "actorId": "uuid"
     }
     ```
   - Expected responses:
     - `200` or `201` (unclear) returning updated context or an acknowledgment (needs clarification).
     - `400` validation error
     - `403` forbidden
     - `409` conflict (version mismatch) â€” if optimistic concurrency is enforced

### Error handling expectations
- Map HTTP errors to user-facing banners/toasts + inline field errors for 400.
- Ensure errors do not leak internal details (display generic message, log detailed error).

---

## 10. State Model & Transitions

### Relevant states (Work Order status)
From workexec state machine reference:
- `DRAFT`
- `APPROVED`
- `ASSIGNED`
- `WORK_IN_PROGRESS`
- `AWAITING_PARTS`
- `AWAITING_APPROVAL`
- `READY_FOR_PICKUP`
- `COMPLETED`
- `CANCELLED`

### Role-based transitions (impact on UI)
- This story does **not** implement transitions, but uses status to gate override behavior:
  - Override allowed pre-start (at least `APPROVED`, `ASSIGNED`) for permitted users.
  - After start, behavior must follow policy (see Open Questions).

### UI behavior per state
- `DRAFT`: show context if available; overrides likely allowed for manager (unclear).
- `APPROVED`/`ASSIGNED`: show override action (permitted users).
- `WORK_IN_PROGRESS`/`AWAITING_*`: show â€œcontext locked for this work sessionâ€ indicator if available; disable/enable override based on clarified rules.
- `READY_FOR_PICKUP`/`COMPLETED`/`CANCELLED`: overrides disabled; show context read-only and audit.

---

## 11. Alternate / Error Flows

### Validation failures (override)
- Missing reason â†’ field error, prevent submit.
- No override fields set â†’ show form error â€œSelect at least one change to submit.â€
- Invalid timestamps (end before start) â†’ show field error (only if backend validates; frontend may also pre-validate if rules providedâ€”currently not).

### Concurrency conflicts
- Operational context version changes between load and override:
  - Backend returns `409`; UI shows conflict message and offers â€œRefresh contextâ€ action; preserve entered reason/inputs if possible.

### Unauthorized access
- Viewing context: if operational context endpoint returns `403`, show â€œNot authorized to view operational contextâ€ and hide details (unclear if possible; likely same as work order view auth).
- Override: handle `403` as described.

### Empty states
- No assigned mechanics: render â€œNo mechanics assignedâ€.
- No bay/schedule/resources/constraints: render â€œNot setâ€.

### Upstream unavailable
- If Shopmgr context load fails:
  - Render panel with â€œUnavailableâ€ state and retry button.
  - Do not block rest of Work Order screen.

---

## 12. Acceptance Criteria

### Scenario 1: Display full operational context
**Given** a work order exists and Shopmgr returns operational context containing location, bay, schedule, assigned mechanics, assigned resources, and constraints  
**When** a Mechanic opens the Work Order view  
**Then** the UI displays all returned operational context fields in the Operational Context section  
**And** the UI indicates the data source is Shopmgr  
**And** the UI displays the context `version` and `lastUpdatedAt` metadata.

### Scenario 2: Display partial context (graceful degradation)
**Given** Shopmgr returns operational context with location and assignedMechanics only, and bay/schedule/resources/constraints are null/empty  
**When** a Mechanic opens the Work Order view  
**Then** the UI displays location and assigned mechanics  
**And** the UI displays â€œNot setâ€ (or equivalent) for missing optional fields  
**And** the rest of the Work Order view remains usable.

### Scenario 3: Context unavailable
**Given** Shopmgr operational context request fails with a network error or 5xx  
**When** a user opens the Work Order view  
**Then** the UI shows â€œOperational context is temporarily unavailableâ€ within the Operational Context section  
**And** the UI provides a retry action  
**And** the Work Order details outside this section remain visible.

### Scenario 4: Manager override allowed before work start
**Given** the current user has permission to override operational context  
**And** the work order status is `APPROVED` (or `ASSIGNED`)  
**When** the user submits an override with a non-empty reason and at least one override field  
**Then** the UI calls `POST /workexec/v1/workorders/{workOrderId}/operational-context:override` with the override payload  
**And** on success, the UI re-fetches operational context  
**And** the updated context version/values are displayed.

### Scenario 5: Override rejected due to permission
**Given** the current user does not have permission to override operational context  
**When** they attempt to submit an override  
**Then** the UI displays an authorization error message  
**And** no local context is modified.

### Scenario 6: Override rejected due to version conflict
**Given** a manager loads operational context version N  
**And** Shopmgr updates the operational context to version N+1 before the manager submits  
**When** the manager submits an override based on version N  
**Then** the UI receives a `409 Conflict` response  
**And** the UI prompts the user to refresh  
**And** after refresh, the UI shows version N+1.

### Scenario 7: Edit rules after work start
**Given** the work order status is `WORK_IN_PROGRESS` (or any in-progress state)  
**When** a user views the Operational Context section  
**Then** the UI indicates the context is locked/recorded for the work start session (if lock metadata is available)  
**And** the UI enforces the configured rule for overrides after start (disabled or manager-only per clarification).

### Scenario 8: Audit visible
**Given** operational context contains metadata including lastUpdatedAt/lastUpdatedBy and version  
**When** the Work Order view is displayed  
**Then** the UI renders these audit fields in a user-visible manner  
**And** after a successful override, the UI reflects updated metadata/version.

---

## 13. Audit & Observability

### User-visible audit data
- Display:
  - `version`
  - `metadata.lastUpdatedAt`
  - `metadata.lastUpdatedBy`
- For overrides, display confirmation message including timestamp (from response if provided) and the submitted reason (if returned/available).

### Status history
- Out of scope to display full work order status transition history; only current status used for gating.

### Traceability expectations
- Frontend must include correlation/request ID headers if the project standard supports it (unknown; safe default only if already implemented globally).
- Log client-side error events (non-PII) with workOrderId and endpoint name for debugging.

---

## 14. Non-Functional UI Requirements
- **Performance**: Operational context fetch should not block initial Work Order render; load asynchronously; target < 2s fetch under normal conditions (from backend AC5 â€œreasonable timeframeâ€).
- **Accessibility**: All actions (refresh, override modal) must be keyboard navigable and have accessible labels.
- **Responsiveness**: Operational context section must adapt to mobile/tablet layouts (stack fields).
- **i18n/timezone**:
  - Timestamps must display in shop/user locale/timezone; source of timezone must be clarified.
  - No currency in this story.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Render â€œNot setâ€ / â€œNone assignedâ€ for missing optional context fields; qualifies as safe UI ergonomics. (Impacts: UX Summary, Error Flows, Acceptance Criteria)
- SD-UX-NONBLOCKING-ASYNC-LOAD: Load operational context asynchronously and do not block Work Order details render; qualifies as safe UI ergonomics/perf. (Impacts: UX Summary, Non-Functional UI Requirements)
- SD-ERR-STD-HTTP-MAP: Standard mapping of 400/403/404/409/5xx to banner + field errors; qualifies as safe error-handling boilerplate. (Impacts: Business Rules, Error Flows, Acceptance Criteria)

---

## 16. Open Questions

1. **Domain contract mismatch (blocking):** The frontend issue text labels domain as â€œShop Management/userâ€, but the backend reference is `domain:workexec` with Shopmgr as SoR. Confirm this frontend story should be owned/labeled `domain:workexec` (current proposal) and implemented in workexec UI screens.
2. **Override-after-start rule (blocking):** The issue says â€œUpdates allowed until work starts; after start require manager action.â€ Does that mean:
   - (A) no overrides allowed after start for anyone, or
   - (B) overrides allowed after start but **only** for managers (likely), or
   - (C) overrides allowed but must create a new future context version without altering locked-at-start version?
3. **Which Work Order statuses count as â€œwork startedâ€ in the UI gate?** Should â€œstartedâ€ be strictly `WORK_IN_PROGRESS` and in-progress sub-statuses only, or also include `READY_FOR_PICKUP`?
4. **Where does the frontend get current user permissions and userId (actorId)?** Is `actorId` required in override payload, and if so should it be session user UUID/ID? How is it accessed in this Moqui frontend project?
5. **Override response shape and status code:** Does the override endpoint return updated operational context (preferred) or an acknowledgment requiring a subsequent GET? What HTTP status should be treated as success (200 vs 201)?
6. **Optimistic concurrency for overrides:** Must the frontend include a `version` in the override request? If yes, what is the exact field name/path?
7. **â€œTeamâ€ definition:** The mechanic story says â€œteamâ€. Is â€œteamâ€ represented by `assignedMechanics[]` only, or is there a separate team entity/identifier to display?
8. **Routing/screen location:** What is the canonical Moqui screen path/route for viewing a work order in `durion-moqui-frontend` where this section should be added?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] CrossDomain: Workexec Displays Operational Context in Workorder View  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/123  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] CrossDomain: Workexec Displays Operational Context in Workorder View

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Mechanic**, I want workexec to display my assigned location/bay and team on the workorder so that I know where to work and who Iâ€™m working with.

## Details
- Workexec shows operational context fields.
- Updates allowed until work starts; after start require manager action.

## Acceptance Criteria
- Workorder shows location/resource/team.
- Update rules enforced.
- Audit visible.

## Integrations
- Shopmgr provides context; workexec renders it and emits statuses back.

## Data / Entities
- WorkorderOperationalContext (workexec domain)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #124: [FRONTEND] [STORY] Reporting: Daily Dispatch Board Dashboard  
File: ./scripts/story-work/frontend/124/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Reporting: Daily Dispatch Board Dashboard (Dispatch Board View + Exceptions)

**Primary Persona:** Dispatcher (also applicable: Shop Manager / Dispatch Coordinator)

**Business Value:** Provide an operational, at-a-glance view of todayâ€™s work orders, assignments, and exceptions so dispatch can proactively manage workload, reduce double-booking, and resolve blocking conflicts quickly.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Dispatcher  
- **I want** a Daily Dispatch Board dashboard that shows todayâ€™s work orders/appointments, mechanic availability signals, and conflict/exception indicators  
- **So that** I can dispatch jobs efficiently and avoid preventable scheduling conflicts

### In-scope
- A Moqui/Vue/Quasar dashboard screen that:
  - Filters by **location** and **date** (default today)
  - Loads a consolidated â€œdispatch boardâ€ view (work orders + mechanics + bays + exception indicators)
  - Auto-refreshes via polling every **30 seconds** plus manual refresh
  - Clearly surfaces exceptions (warning vs blocking) and stale-data/offline states
- Integration calls from the frontend to:
  - Workexec dispatch board endpoint (or equivalent)
  - People/HR availability endpoint (as defined in backend reference)
- Read-only visualization and exception highlighting (no automatic resolution)

### Out-of-scope
- WebSocket/push updates (explicitly â€œv2â€ in backend reference)
- Multi-location merged board (explicitly non-goal; one location per view)
- Configuration of default locations/bays/mechanic roles/skills
- Creating/updating work orders, estimates, approvals, receiving, picking
- Any payroll/billing effects

---

## 3. Actors & Stakeholders

- **Primary Actor:** Dispatcher (operates the board throughout the day)
- **Secondary Actors:** Shop Manager, Dispatch Coordinator
- **Data Providers (systems):**
  - `domain:workexec` (work orders, assignments, conflicts computed at dispatch time; board data endpoint)
  - People/HR service (real-time mechanic availability signal and advisory schedule/PTO)
  - Shop management/location resource source (service bays and occupancy) â€” consumed through the board payload
- **Stakeholders:** Shop Owner (throughput and utilization), Mechanics (impacted indirectly by dispatch decisions)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend and has access to a location.
- There exists (or may exist) work for the selected date/location.
- Backend provides an endpoint that returns dispatch board data, including exceptions, within SLA.

### Dependencies (blocking if absent)
- **Backend dispatch board endpoint** (referenced as `GET /dashboard/v1/today` in backend story) must exist and be reachable from Moqui frontend.
- People availability endpoint exists:
  - `GET /people/v1/availability?locationId=...&date=...&includeSchedule=true`
- Definition of frontend route/menu entry conventions in `durion-moqui-frontend` README (not provided in prompt).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Reporting â†’ Dispatch Board** (or Ops/Dispatch; exact menu placement TBD)
- Direct URL route for the screen (TBD by project routing conventions)

### Screens to create/modify (Moqui)
- **Create screen:** `apps/pos/screen/reporting/DispatchBoard.xml` (name/path to be aligned with repo conventions)
  - Parameters: `locationId` (required), `date` (required; defaults to today in user/store timezone)
- Optional child screens/widgets:
  - `DispatchBoard/Board.xml` (board content)
  - `DispatchBoard/Exceptions.xml` (exceptions panel/list)
  - `DispatchBoard/Mechanics.xml` (mechanic availability list)
  - `DispatchBoard/Bays.xml` (bay occupancy list)
  - (Use Moqui screen includes to keep responsibilities clear)

### Navigation context
- Top-of-screen filters: Location selector, Date picker
- Status line: â€œLast updated at â€¦ (as-of â€¦)â€ + stale indicator if needed
- Manual action: â€œRefresh Nowâ€

### User workflows
#### Happy path
1. User navigates to Dispatch Board.
2. Defaults load: location = current/last-used, date = today.
3. Dashboard renders:
   - Work orders/appointments grouped by status
   - Assignments by mechanic and by bay/mobile
   - Exceptions highlighted (warning vs blocking)
4. Dashboard auto-refreshes every 30 seconds; user can refresh manually.

#### Alternate paths
- User selects a different date (past/future): board reloads for that date.
- User switches location: board reloads for that location; no multi-location merge.
- No work orders exist: empty state explains â€œNo work scheduled for this date/location.â€

---

## 6. Functional Behavior

### Triggers
- Screen load
- Filter change: locationId/date
- Poll tick (every 30 seconds) while screen is active/visible
- Manual refresh button

### UI actions
- Select locationId
- Select date
- Click â€œRefresh Nowâ€

### State changes (frontend)
- Maintain a local UI state machine:
  - `idle` â†’ `loading` â†’ `loaded` (or `error`)
  - `loaded` plus sub-flags: `isStale`, `isOfflineReadOnly`
- Store:
  - `lastSuccessfulFetchAt` (client timestamp)
  - `boardAsOf` (server-provided timestamp, if available)
  - `selectedLocationId`, `selectedDate`

### Service interactions
- On load and on refresh:
  1. Fetch dispatch board data (workexec)
  2. Fetch people availability data (People/HR)
  3. Merge into a single view-model for rendering (frontend-only composition)
- If backend already aggregates People/bays into a single endpoint, the frontend should prefer the single endpoint to meet SLA (needs confirmation; see Open Questions).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `locationId` must be selected before loading; if missing, prompt user to select location.
- `date` must be valid ISO date (no time component in filter UI).

### Enable/disable rules
- While `loading`, disable refresh button to prevent request storms; allow â€œCancelâ€ only if project has standard cancellation pattern (TBD).
- If backend unreachable:
  - Enter read-only/offline mode with cached last successful payload if present
  - Disable filter actions only if they would require new data; otherwise allow but show â€œdata may be staleâ€ (see Open Questions)

### Visibility rules
- Exceptions must be visible without drilling into each work order:
  - At minimum show a count and list of exception indicators
  - Work orders/mechanics/bays with blocking exceptions must be visually distinguishable (exact styling left to UI implementation)

### Error messaging expectations
- If any load fails:
  - Show a non-technical error banner: â€œUnable to load dispatch board. Try again.â€
  - Provide retry action
- If People availability fails but board loads:
  - Show board with a warning: â€œMechanic availability is temporarily unavailable; showing work orders only.â€
  - Do not block full page (safe degradation)

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `DispatchBoardView` (read model/view DTO from backend)
- `ExceptionIndicator` (DTO)
- People availability response (DTO as defined in backend reference)

> Note: Moqui entities (DB) are not created/modified by this frontend story; this is a reporting UI consuming backend APIs.

### Fields (type, required, defaults)
#### Filter inputs
- `locationId` (string or numeric ID; **required**)
- `date` (ISO date string `YYYY-MM-DD`; **required**, default = today)

#### People availability (from `/people/v1/availability`)
- `asOf` (ISO timestamp; required)
- `location` (id; required)
- `people[]` (array; required)
  - `personId` (required)
  - `firstName`, `lastName` (required)
  - `currentStatus` (required enum: `CLOCKED_OUT`, `AVAILABLE`, `ON_JOB`, `ON_BREAK`, `PTO`)
  - `clock` (optional object)
  - `break` (optional object)
  - `pto[]` (optional array)
  - `scheduledAvailability[]` (optional array)

#### Dispatch board view (TBD schema)
- Must include at least:
  - Work orders/appointments for date/location, with:
    - `workOrderId`
    - status
    - scheduled start/end or ETA window (needed for â€œoverdue startsâ€ and overlap detection display)
    - assigned mechanic(s)
    - assigned bay/mobile indicator
  - Bay list with occupancy/unavailability reason
  - Exception indicators with:
    - severity (`WARNING`/`BLOCKING`)
    - message
    - target reference (workOrderId/mechanicId/bayId)
    - category/code (one of 8 enumerated conditions or equivalent identifier)

### Read-only vs editable
- Entire screen is **read-only** in this story (no dispatch assignment action is specified in the frontend story inputs).

### Derived/calculated fields (frontend)
- `isStale` = true if `now - lastSuccessfulFetchAt > 2 minutes` (from backend alternate flow guidance)
- Exception grouping counts by severity
- Overdue start highlighting: requires backend to provide â€œscheduled startâ€ and current job start status (otherwise cannot compute safely)

---

## 9. Service Contracts (Frontend Perspective)

> Endpoint names below reflect backend reference; exact base URL and auth headers follow project conventions (TBD).

### Load/view calls
1) **Dispatch Board**
- `GET /dashboard/v1/today?locationId={locationId}&date={YYYY-MM-DD}`  
  - **Expected:** 200 with board payload including work orders, bay status, exception indicators, and a server as-of timestamp if available.
  - **SLA:** P50 < 1.0s, P95 < 2.0s, P99 < 3.5s (gateway receipt â†’ JSON response), as per backend reference.

2) **People Availability**
- `GET /people/v1/availability?locationId={locationId}&date={YYYY-MM-DD}&includeSchedule=true`
  - **Expected:** 200 with schema provided in backend reference.

### Create/update calls
- None (read-only dashboard in this story).

### Submit/transition calls
- None.

### Error handling expectations
- 401/403: show â€œYou donâ€™t have access to Dispatch Board for this location.â€ and stop polling.
- 404: show â€œDispatch Board not available.â€ (misconfiguration) and stop polling.
- 409: if returned for concurrency/state (unlikely for GET), show retry suggestion.
- 5xx/network: show offline warning; keep cached data visible if available; continue polling with backoff (see safe defaults).

---

## 10. State Model & Transitions

### Allowed states (UI state)
- `loading-initial`
- `loaded-fresh`
- `loaded-stale`
- `error-initial` (no cached data)
- `offline-readonly` (cached data shown)

### Role-based transitions
- This story does not define roles/permissions beyond â€œDispatcher/Shop Manager can view.â€ Any finer RBAC requires clarification and may be enforced by backend (401/403 handling above).

### UI behavior per state
- `loading-initial`: show skeleton/loading indicator; no stale banner.
- `loaded-fresh`: show board + last-updated timestamps.
- `loaded-stale`: show board + â€œdata may be staleâ€ banner.
- `offline-readonly`: show board + offline banner; disable actions that require fresh data.
- `error-initial`: show error state with retry; no board content.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing locationId: show inline validation and prevent requests.
- Invalid date format: reset to today and show inline message (or block until corrected; TBD by UI standard).

### Concurrency conflicts
- If poll response includes an `asOf` older than previously received (clock skew/out-of-order):
  - Keep the newer dataset; log a warning in console (no user disruption).

### Unauthorized access
- On 401: redirect to login (if app pattern), preserve intended route.
- On 403: show access denied, stop polling, allow location change if user might have access elsewhere.

### Empty states
- No work orders: show â€œNo appointments/work orders for {date} at {location}.â€
- No mechanics returned: show â€œNo mechanics scheduled/available data for this date.â€ (do not block board display)

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Initial load defaults (today + location) and SLA
**Given** I am an authenticated Dispatcher with access to a location  
**When** I open the Dispatch Board screen  
**Then** the screen loads the board for today and my selected location  
**And** the dashboard renders work orders/appointments, mechanics availability, bay status, and exceptions  
**And** the initial load completes within the defined SLA targets (P50 < 1s, P95 < 2s, P99 < 3.5s) as measured in frontend instrumentation

### Scenario 2: Filter by location and date
**Given** I am viewing the Dispatch Board  
**When** I change the location filter to another location I have access to  
**Then** the dashboard reloads and displays only data for the newly selected location  
**When** I change the date filter to a different date  
**Then** the dashboard reloads and displays only data for that date

### Scenario 3: Auto-refresh polling
**Given** I am viewing the Dispatch Board  
**When** 30 seconds have elapsed since the last successful refresh  
**Then** the frontend requests updated board data  
**And** the displayed data updates to reflect changes

### Scenario 4: Manual refresh
**Given** I am viewing the Dispatch Board  
**When** I click â€œRefresh Nowâ€  
**Then** the frontend immediately requests updated data  
**And** the displayed data updates upon success

### Scenario 5: Exceptions visible with severity
**Given** the backend returns exception indicators including both WARNING and BLOCKING severities  
**When** the Dispatch Board renders  
**Then** I can see exceptions without drilling into each work order  
**And** exceptions are clearly distinguishable by severity  
**And** items with BLOCKING exceptions are visually indicated as blocked

### Scenario 6: Stale data indicator
**Given** I am viewing the Dispatch Board with previously loaded data  
**And** the backend becomes unreachable  
**When** more than 2 minutes pass since the last successful fetch  
**Then** the UI indicates the displayed data is stale  
**And** if cached data exists, it remains visible in read-only mode

### Scenario 7: People availability fails but board loads
**Given** the Dispatch Board endpoint responds successfully  
**And** the People availability endpoint fails with a 5xx or network error  
**When** the dashboard loads  
**Then** the dashboard still shows work orders and bays  
**And** it shows a warning that mechanic availability is unavailable

---

## 13. Audit & Observability

### User-visible audit data
- Show â€œLast updatedâ€ (client time) and â€œAs ofâ€ (server time if provided) for traceability.

### Status history
- Not required in this dashboard (reporting snapshot only). No work order transition history UI in scope.

### Traceability expectations
- Frontend telemetry should record:
  - `locationId`, `date` (non-PII identifiers)
  - request correlation id if returned by backend
  - fetch duration and success/failure
- Do **not** log personal data (full names) in client logs beyond what is needed for UI rendering.

---

## 14. Non-Functional UI Requirements

- **Performance:** Meet SLA as perceived in UI; avoid blocking rendering on secondary calls (People) if primary board call succeeds.
- **Accessibility:** Keyboard-operable filters; readable contrast for warning/blocking indicators; ARIA labels for refresh controls.
- **Responsiveness:** Must function on tablet and desktop dispatch stations.
- **i18n/timezone:** Dates/times must render in store/user timezone; backend timestamps are UTC (`asOf`); convert for display without altering underlying filter date. (Currency not applicable for this story.)

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit empty states for â€œno work ordersâ€ and â€œno mechanics dataâ€; safe because it does not alter domain logic. (Impacted sections: UX Summary, Alternate/Empty states)
- SD-OBS-FE-PERF-METRICS: Add standard frontend timing instrumentation around API calls to verify SLA; safe because it is observability-only. (Impacted: Acceptance Criteria, Audit & Observability)
- SD-ERR-NETWORK-DEGRADE: If a secondary dependency (People availability) fails, degrade gracefully while still rendering primary board data; safe because it does not change source-of-truth data or decisions. (Impacted: Error Flows, Service Contracts)

---

## 16. Open Questions

1. **Backend API contract for Dispatch Board:** What is the exact request/response schema for `DispatchBoardView` and `ExceptionIndicator` (fields, IDs, and enumerations) and the exact endpoint path (is it truly `GET /dashboard/v1/today` and does it accept `date` and `locationId`)?  
2. **Aggregation responsibility:** Does the dispatch board endpoint already include mechanic availability and bay occupancy, or must the frontend always call `/people/v1/availability` separately and merge? (Impacts SLA and composition logic.)  
3. **â€œAppointmentsâ€ vs â€œWork Ordersâ€:** In the frontend story, â€œappointmentsâ€ are mentioned. Are these represented as work orders with scheduled times, or a separate entity? If separate, what endpoint supplies them?  
4. **Routing/menu conventions:** What is the required Moqui screen path, menu name, and URL routing pattern for â€œReportingâ€ screens in `durion-moqui-frontend`?  
5. **RBAC expectations:** Which roles may view the Dispatch Board? Is it restricted by location membership only, or specific permission(s) (e.g., `DISPATCH_VIEW`)?  
6. **Exception definitions source:** Are exceptions computed entirely by backend (recommended), and does the frontend ever compute/derive exceptions like â€œoverdue startsâ€? If yes, define the rules precisely; if no, confirm backend provides â€œoverdue startâ€ indicators.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Reporting: Daily Dispatch Board Dashboard  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/124  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Reporting: Daily Dispatch Board Dashboard

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Dispatcher**, I want a dashboard showing todayâ€™s appointments, assignments, and exceptions so that I can manage the day efficiently.

## Details
- Show appointments by status, assigned mechanic, bay/mobile.
- Highlight overdue starts, conflicts, missing assignments.

## Acceptance Criteria
- Loads within SLA.
- Filters by location/date.
- Exceptions visible.

## Integrations
- Pulls status from workexec and availability/time signals from HR.

## Data / Entities
- DispatchBoardView, ExceptionIndicator

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #127: [FRONTEND] [STORY] Workexec: Update Appointment Status from Workexec Events  
File: ./scripts/story-work/frontend/127/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Consume Workexec Events to Update Appointment Status + Timeline (Moqui)

### Primary Persona
System (Shop Management / POS frontend runtime acting as event consumer) benefiting Dispatchers and Service Advisors.

### Business Value
Dispatch and advisors see near-real-time appointment status aligned with work execution progress, improving scheduling accuracy, customer communication, and operational visibility, with an auditable timeline and reopen signaling.

---

## 2. Story Intent

### As a / I want / So that
- **As a** system integrated with Workexec,
- **I want** to process Workexec work order events and reflect them onto the linked Appointmentâ€™s status, timeline, and reopen indicator,
- **So that** the appointment board reflects execution reality, even with duplicate or out-of-order event delivery.

### In-scope
- Moqui UI/admin screen(s) to view appointment status, reopen flag, and status timeline entries (read-only).
- Moqui service(s) to process incoming Workexec events (`WorkorderStatusChanged`, `InvoiceIssued`) with:
  - mapping Workexec status â†’ Appointment status
  - precedence rules
  - idempotency (no duplicate timeline entries)
  - orphan handling (no appointment mapping)
  - invalid mapping handling
- Storage of status timeline entries with source event identifier.

### Out-of-scope
- Defining/maintaining location configuration, work order lifecycle, or emitting Workexec events (owned by backend/workexec).
- Delivering notifications/alerts to external systems (only record/log for ops visibility).
- Creating the WorkOrder â†” Appointment mapping (assumed pre-existing; this story consumes it).

---

## 3. Actors & Stakeholders
- **System Actors**
  - Workexec event producer (external to this frontend repo)
  - Moqui runtime (event ingestion endpoint/job) acting as consumer
- **Human Stakeholders**
  - Dispatcher (needs real-time status for scheduling/dispatch board)
  - Service Advisor (needs accurate customer-facing updates)
  - Ops/Support (needs orphan/invalid mapping visibility)

---

## 4. Preconditions & Dependencies
- Appointment exists in Shop Management/POS domain (entity owned outside workexec, but updated here).
- A persistent mapping exists from `workOrderId` â†’ `appointmentId` (see backend reference â€œWorkOrderAppointmentMappingâ€).
- Workexec events delivered to Moqui via **one** of:
  - HTTP webhook endpoint in Moqui, or
  - message broker consumer integrated into Moqui, or
  - polling job reading an inbox table.
- Backend event payload includes (minimum): `eventId`, `workOrderId`, `newStatus`, `eventTimestamp`, `correlationId`.
- Appointment statuses include the 10-status enum listed in backend reference (SCHEDULED, CHECKED_IN, WORK_IN_PROGRESS, WAITING_FOR_PARTS, QUALITY_CHECK, READY_FOR_PICKUP, COMPLETED, CANCELLED, INVOICED, REOPENED).

**Dependency/clarification required:** exact event ingestion mechanism and existing entity names/fields in this Moqui frontend project (see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Workexec â†’ Appointment Status Timeline** (or **Shop Management â†’ Appointments â†’ <Appointment> â†’ Status**), depending on existing menu taxonomy.
- Direct route: `/workexec/appointments/{appointmentId}/status` (proposed).

### Screens to create/modify
1. **Screen: Appointment Detail (extend)**
   - Add read-only fields: `status`, `reopenFlag`
   - Add a timeline list/table of status changes (append-only)
2. **Screen: Orphaned Events / Processing Errors (optional but recommended)**
   - List recent failed event ingestions (appointment not found, invalid status mapping)
   - Filters by date, workOrderId, eventId, failure reason

### Navigation context
- From appointment list/dispatch board â†’ appointment detail â†’ status timeline.
- From ops/admin menu â†’ event processing errors â†’ drill into payload snapshot.

### User workflows
- **Happy path (viewer):**
  1. Dispatcher opens appointment detail.
  2. Sees current status updated based on latest processed Workexec event.
  3. Reviews timeline entries with timestamps and source event ids.
- **Alternate path (reopen):**
  1. Appointment shows `status=REOPENED` and `reopenFlag=true`.
  2. Timeline includes entry tied to reopen-causing event.
- **Ops path (failure):**
  1. Ops opens error list.
  2. Sees orphaned event with workOrderId and eventId.
  3. Uses it to remediate mapping outside this story.

---

## 6. Functional Behavior

### Triggers
- Receipt of a Workexec event:
  - `WorkorderStatusChanged`
  - `InvoiceIssued`

### UI actions
- No manual status changes in UI (read-only; state is event-driven).
- UI provides visibility into:
  - current appointment status
  - reopen flag
  - timeline entries
  - event processing failures (if optional screen implemented)

### State changes (Appointment)
On successful processing:
- Update `Appointment.status` to mapped appointment status (subject to precedence rules).
- If mapped status corresponds to â€œreopenedâ€ semantics:
  - set `Appointment.reopenFlag = true` (permanent once set).
- Append a `StatusTimelineEntry` (if not already present for that `sourceEventId` or equivalent idempotency key).

### Service interactions
- Ingestion service receives event payload.
- Lookup appointment via mapping table using `workOrderId` (primary key).
- Apply mapping and precedence logic.
- Persist appointment update + timeline entry atomically.
- Record processing outcome (success/failure) for observability.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Reject/route to failure handling if:
  - `eventId` missing/blank
  - `workOrderId` missing/blank
  - `newStatus` missing/blank for `WorkorderStatusChanged`
  - event type unrecognized
- If `workOrderId` does not map to an appointment:
  - mark event as failed/orphaned; do **not** create an appointment
- If `newStatus` has no mapping:
  - mark event as failed; do **not** update appointment

### Enable/disable rules
- Appointment status field is **not editable** in UI.
- Timeline entries are **not editable** in UI.

### Visibility rules
- Show `reopenFlag` only when true or always with boolean indicator (TBD; safe default: always show).
- Timeline list shows newest first (safe default).

### Error messaging expectations
- Viewer UI: if timeline cannot load, show non-destructive error â€œUnable to load status history. Try again.â€
- Admin/error screen: show failure reason + identifiers, but do not expose secrets/PII; allow viewing sanitized payload.

---

## 8. Data Requirements

### Entities involved (conceptual; exact Moqui entity names TBD)
- `Appointment`
  - `appointmentId` (PK)
  - `status` (enum/string; required)
  - `reopenFlag` (boolean; required; default false; once true never false)
- `StatusTimelineEntry` (append-only)
  - `statusTimelineEntryId` (PK)
  - `appointmentId` (FK; required)
  - `status` (enum/string; required)
  - `changeTimestamp` (datetime UTC; required)
  - `sourceEventId` (UUID/string; required; unique per appointment to ensure idempotency)
  - `sourceEventType` (string; required)
  - `workOrderId` (string; required for traceability)
  - `eventTimestamp` (datetime UTC; required)
  - `correlationId` (string/UUID; optional but recommended)
- `WorkOrderAppointmentMapping`
  - `workOrderId` (PK; required)
  - `appointmentId` (FK; required)
  - `status` (optional)
  - `createdAt` (datetime UTC)

Optional (for ops visibility):
- `WorkexecEventProcessingLog`
  - `eventId` (PK or unique; required)
  - `eventType` (required)
  - `workOrderId` (required)
  - `appointmentId` (nullable)
  - `processingStatus` (SUCCESS/FAILED)
  - `failureReason` (nullable string enum)
  - `receivedAt`, `processedAt` (UTC)
  - `payloadHash` or `payloadJson` (see Open Questions re: storage policy)

### Read-only vs editable
- All fields above are system-managed; UI is read-only for these aspects.

### Derived/calculated fields
- â€œCurrent statusâ€ is stored on Appointment; timeline is historical.
- â€œCurrently reopenedâ€ can be derived as `Appointment.status == REOPENED` (do not add new field in this story).

---

## 9. Service Contracts (Frontend Perspective)

> Moqui-specific implementation detail: in Moqui, services can be invoked by REST endpoints and screens can call services via transitions/actions.

### Load/view calls
- `workexec.AppointmentStatusDetail` (name illustrative)
  - Input: `appointmentId`
  - Output: appointment status, reopenFlag, timeline entries (paged)
- `workexec.ListEventProcessingFailures` (optional)
  - Input: filters (date range, workOrderId, eventType, failureReason)
  - Output: list of failures with identifiers

### Create/update calls (event-driven)
- `workexec.ProcessWorkexecEvent`
  - Input (payload):
    - `eventId` (required)
    - `eventType` (required: `WorkorderStatusChanged` | `InvoiceIssued`)
    - `workOrderId` (required)
    - `newStatus` (required for status-changed)
    - `eventTimestamp` (required)
    - `correlationId` (optional)
  - Output:
    - `processingStatus` (SUCCESS/FAILED)
    - `appointmentId` (if resolved)
    - `appointmentStatusApplied` (if success)
    - `idempotentNoop` (true if duplicate event)
    - `failureReason` (if failed)

### Error handling expectations
- 201/200 on success depending on ingestion style (TBD).
- 400 for invalid payload.
- 404 not used for orphaned event (should be processed into failure log + acknowledged; transport-level response depends on ingestion mechanism).
- 409 for concurrency conflict (e.g., optimistic lock) with retry guidance.
- Idempotency: same `eventId` processed twice returns SUCCESS with `idempotentNoop=true` and no additional timeline entry.

---

## 10. State Model & Transitions

### Workexec statuses (authoritative in backend reference)
Workexec â†’ Appointment mapping table (must be implemented exactly as provided in backend reference):

| Workexec Status | Appointment Status |
|---|---|
| CREATED | SCHEDULED |
| PENDING | SCHEDULED |
| ASSIGNED | SCHEDULED |
| CUSTOMER_ARRIVED | CHECKED_IN |
| CHECKED_IN | CHECKED_IN |
| IN_PROGRESS | WORK_IN_PROGRESS |
| STARTED | WORK_IN_PROGRESS |
| PARTS_PENDING | WAITING_FOR_PARTS |
| ON_HOLD | WAITING_FOR_PARTS |
| PARTS_ORDERED | WAITING_FOR_PARTS |
| INSPECTING | QUALITY_CHECK |
| QC_IN_PROGRESS | QUALITY_CHECK |
| WORK_COMPLETE | READY_FOR_PICKUP |
| AWAITING_CUSTOMER | READY_FOR_PICKUP |
| CLOSED | COMPLETED |
| DELIVERED | COMPLETED |
| CUSTOMER_PICKUP | COMPLETED |
| CANCELLED | CANCELLED |
| ABANDONED | CANCELLED |
| INVOICE_GENERATED | INVOICED |
| INVOICED | INVOICED |
| REOPENED | REOPENED |
| REWORK_REQUIRED | REOPENED |

### Precedence rules (apply during event processing)
1. `CANCELLED` is terminal â€” once appointment is CANCELLED, ignore subsequent updates **except** explicit reopen statuses (`REOPENED`, `REWORK_REQUIRED`).
2. `INVOICED` supersedes `COMPLETED` â€” if events arrive out of order, INVOICED wins.
3. `REOPENED` supersedes terminal statuses (`COMPLETED`, `CANCELLED`) until resolved (resolution semantics not defined here; appointment remains REOPENED until a non-reopen status arrives and is allowed by precedence).
4. Multiple events mapping to same appointment status are idempotent (no duplicate timeline entries).

### Role-based transitions
- No human-initiated transitions in UI for this story.

### UI behavior per state
- Always display current status.
- If `status == REOPENED` or `reopenFlag == true`, surface â€œReopenedâ€ indicator.
- Timeline shows sequence of status changes with timestamps and source event ids.

---

## 11. Alternate / Error Flows

### Validation failures (bad payload)
- Missing required identifiers/status:
  - Record failure with reason `INVALID_PAYLOAD`
  - Do not update appointment
  - Return 400 to sender if HTTP ingestion (TBD)

### Concurrency conflicts
- If appointment update fails due to concurrent write:
  - Service retries once (safe default) or returns 409 with `retryable=true` (TBD)
  - Ensure idempotency key prevents duplicate timeline insertion on retry

### Unauthorized access
- Ingestion endpoint/service requires authentication appropriate to integration (TBD).
- UI screens require authenticated user; error screen restricted to admin/ops roles (TBD).

### Empty states
- Appointment has no timeline entries: show â€œNo status changes recorded yet.â€
- Failure list empty: show â€œNo processing failures in selected period.â€

### Orphaned event (no mapping)
- Record failure reason `APPOINTMENT_NOT_FOUND`
- Persist event identifiers for later remediation
- Do not create/modify any appointment
- Mark as DLQ candidate (if broker integration exists) or store in failure log

### Invalid status mapping
- Record failure reason `INVALID_STATUS_MAPPING`
- Persist offending `newStatus` value
- Do not update appointment

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Successful status update from WorkorderStatusChanged
Given an Appointment exists with a mapping for workOrderId "WO-123"  
And the Appointment status is "SCHEDULED"  
When the system receives a WorkorderStatusChanged event with eventId "event-abc", workOrderId "WO-123", newStatus "IN_PROGRESS", and an eventTimestamp in UTC  
Then the Appointment status is set to "WORK_IN_PROGRESS"  
And a status timeline entry is appended with status "WORK_IN_PROGRESS" and sourceEventId "event-abc"  
And the entry includes the workOrderId "WO-123" and the eventTimestamp

### Scenario 2: Idempotent duplicate delivery does not duplicate timeline
Given the system has already processed eventId "event-abc" for workOrderId "WO-123"  
And the Appointment status is "WORK_IN_PROGRESS"  
When the system receives the same event again with eventId "event-abc"  
Then the Appointment status remains "WORK_IN_PROGRESS"  
And no additional timeline entry is created for sourceEventId "event-abc"  
And the processing result indicates idempotent no-op

### Scenario 3: Reopen sets permanent reopenFlag and status REOPENED
Given an Appointment exists mapped to workOrderId "WO-456"  
And the Appointment status is "COMPLETED"  
And reopenFlag is false  
When the system receives a WorkorderStatusChanged event with newStatus "REOPENED"  
Then the Appointment status is set to "REOPENED"  
And reopenFlag is set to true  
And a timeline entry is appended for the REOPENED status

### Scenario 4: ReopenFlag is never cleared
Given an Appointment has reopenFlag true  
When the system processes subsequent events that map to non-reopened statuses  
Then reopenFlag remains true

### Scenario 5: CANCELLED terminal rule blocks non-reopen updates
Given an Appointment status is "CANCELLED"  
When the system receives a WorkorderStatusChanged event that maps to "WORK_IN_PROGRESS"  
Then the Appointment status remains "CANCELLED"  
And no timeline entry is appended for that event  
And the processing result indicates the event was ignored due to precedence

### Scenario 6: CANCELLED can be superseded by reopen
Given an Appointment status is "CANCELLED"  
When the system receives a WorkorderStatusChanged event with newStatus "REWORK_REQUIRED"  
Then the Appointment status becomes "REOPENED"  
And reopenFlag is true  
And a timeline entry is appended for REOPENED

### Scenario 7: INVOICED supersedes COMPLETED with out-of-order delivery
Given an Appointment status is "COMPLETED"  
When the system receives an InvoiceIssued (or status-mapped INVOICED) event for the same workOrderId  
Then the Appointment status becomes "INVOICED"  
And a timeline entry is appended for INVOICED

### Scenario 8: Orphaned event (no appointment mapping) is recorded as failure
Given no appointment mapping exists for workOrderId "WO-999"  
When the system receives a WorkorderStatusChanged event for workOrderId "WO-999"  
Then the system records a processing failure with reason "APPOINTMENT_NOT_FOUND"  
And the event is not applied to any appointment

### Scenario 9: Invalid status mapping is recorded as failure
Given an Appointment mapping exists for workOrderId "WO-123"  
When the system receives a WorkorderStatusChanged event with newStatus "SOME_NEW_STATUS" that is not in the mapping table  
Then the system records a processing failure with reason "INVALID_STATUS_MAPPING"  
And the Appointment status is not changed  
And no timeline entry is appended

---

## 13. Audit & Observability

### User-visible audit data
- Appointment status timeline displays:
  - status
  - change timestamp (when processed)
  - event timestamp (when occurred)
  - source event id
  - correlation id (if present)

### Status history
- Timeline is append-only; UI does not allow edits/deletes.

### Traceability expectations
- Logs and stored failure records include: `eventId`, `workOrderId`, `appointmentId` (if resolved), `correlationId`.
- If payload storage is allowed, store only sanitized/minimal payload or hash (policy TBD).

---

## 14. Non-Functional UI Requirements

- **Performance:** Appointment detail loads timeline within 1s for last 50 entries (excluding network latency); support pagination for longer histories.
- **Accessibility:** Timeline table supports keyboard navigation and screen-reader labels for status and timestamps.
- **Responsiveness:** Appointment detail and timeline usable on tablet width (typical shop floor device).
- **i18n/timezone:** Display timestamps in userâ€™s locale/timezone, while storing timestamps in UTC.
- **Security:** Do not expose raw event payloads containing sensitive information in general user screens; restrict ops views.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for no timeline / no failures; qualifies as safe UI ergonomics; impacts UX Summary, Error Flows.
- SD-UX-PAGINATION-DEFAULT: Paginate timeline (default page size 50); safe to avoid large renders; impacts UX Summary, Data Requirements.
- SD-ERR-RETRY-ONCE: Retry once on transient concurrency failure; safe operational default; impacts Error Flows, Service Contracts.
- SD-OBS-CORRELATION-ID: Surface correlationId when provided; safe observability boilerplate; impacts Audit & Observability, Data Requirements.

---

## 16. Open Questions
1. **Event ingestion mechanism (blocking):** In this Moqui frontend repo, how are Workexec events delivered/handled?
   - HTTP webhook endpoint in Moqui?
   - Message broker consumer?
   - Polling job/inbox table?
2. **System of record / domain ownership (blocking):** Are `Appointment`, `WorkOrderAppointmentMapping`, and timeline entities already defined in this repo (Moqui entities), or are they provided by another service?
   - Provide exact Moqui entity names and field names to update.
3. **Routing / screen taxonomy (blocking):** What is the canonical route/menu location for Appointment detail in this frontend project so we extend the correct screen?
4. **Security (blocking):** What auth mechanism should protect the ingestion endpoint/consumer (shared secret, mTLS, signed JWT), and which roles can access the ops failure screen?
5. **Failure handling (blocking):** Should orphaned/invalid events be:
   - stored in a DLQ managed outside Moqui,
   - stored in Moqui DB for review,
   - or both?
6. **Idempotency key (blocking):** Is `eventId` guaranteed globally unique and stable across retries? If not, what composite key should be used (e.g., workOrderId + newStatus + eventTimestamp)?
7. **Invoice event semantics (blocking):** Does `InvoiceIssued` arrive with its own event type only, or as a status within `WorkorderStatusChanged`? Confirm which payload fields are present for `InvoiceIssued`.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Workexec: Update Appointment Status from Workexec Events  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/127  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Workexec: Update Appointment Status from Workexec Events

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **System**, I want appointments to reflect workexec status so that dispatch has real-time visibility.

## Details
- Map workexec states to appointment states.
- Handle reopen as exception.

## Acceptance Criteria
- Status updates idempotent.
- Reopen flagged.
- Timeline stored.

## Integrations
- Workexecâ†’Shopmgr WorkorderStatusChanged/InvoiceIssued events.

## Data / Entities
- AppointmentStatus, StatusTimeline, ExceptionFlag

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #128: [FRONTEND] [STORY] Workexec: Propagate Assignment Context to Workorder  
File: ./scripts/story-work/frontend/128/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Workexec: Display & Edit Work Order Assignment Context (Location/Resource/Mechanics) Until Work Starts

**Primary Persona:** Service Advisor / Shop Manager (POS user managing a work order)

**Business Value:** Ensures work order execution and reporting reflect the correct operational assignment context (location, bay/resource, assigned mechanics) and preserves an audit trail for pre-start changes.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor / Shop Manager  
- **I want** to view and update a Work Orderâ€™s assignment context (location, resource, mechanics) before work begins  
- **So that** the correct operational context is available to technicians and reporting, and changes are traceable.

### In-scope
- Show assignment context fields on Work Order detail.
- Allow updates **only while the Work Order is start-eligible / pre-start** (per workexec state machine gating).
- Persist updates through a backend service call and show user-friendly validation/errors.
- Display audit/transition history relevant to assignment-context changes (as available from backend).

### Out-of-scope
- Consuming `AssignmentUpdated` events from shopmgr in the frontend (system-to-system integration).
- Configuration of locations/resources/mechanics master data (owned by other domains).
- Defining mechanic authorization levels or permissions policy (security domain).
- Changing/creating new work order states beyond documented workexec FSM.

---

## 3. Actors & Stakeholders

- **Service Advisor / Shop Manager (primary user):** edits assignment context pre-start.
- **Mechanic (consumer):** uses assignment context; expects it to be immutable once work starts.
- **System (Workexec backend):** enforces state gating, auditing, and persistence.
- **Audit/Compliance stakeholder:** relies on immutable audit trail of changes.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- A Work Order exists and can be loaded by ID.
- Work Order has a `status` field aligned to workexec FSM (`DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, etc.).

### Dependencies (blocking if missing)
- Backend endpoint(s) to:
  - Load Work Order details including current assignment context and status.
  - Update assignment context (locationId/resourceId/mechanicIds) with state gating.
  - Retrieve audit/transition history for display (optional but story requires â€œaudit maintainedâ€ in UX).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order list â†’ select a Work Order â†’ navigate to Work Order detail screen.
- Direct route deep link: `/workorders/:workOrderId` (exact routing TBD per repo conventions).

### Screens to create/modify
- **Modify** existing Work Order detail screen to include an **â€œAssignment Contextâ€** section.
- **Optional add** a dedicated sub-screen: `workorders/WorkOrderDetail/AssignmentContext` if the project uses sub-tabs.

### Navigation context
- Work Order detail is the parent context; assignment context is a section/tab within it.

### User workflows
#### Happy path (pre-start edit)
1. User opens Work Order detail.
2. User views current `locationId`, `resourceId`, `mechanicIds`.
3. If Work Order status is **start-eligible / pre-start**, user clicks â€œEditâ€.
4. User selects/enters new values and saves.
5. UI confirms success and refreshes displayed values and audit/history section.

#### Alternate path (read-only after start)
1. User opens a Work Order already started (`WORK_IN_PROGRESS` or later).
2. Assignment context displays as read-only with a note: â€œAssignment context locked after work starts.â€

#### Alternate path (backend rejects due to state race)
1. User opens Work Order in `ASSIGNED`, starts edit.
2. Another actor starts the Work Order (status becomes `WORK_IN_PROGRESS`).
3. User clicks save.
4. Backend returns conflict/validation; UI shows error and refreshes the Work Order.

---

## 6. Functional Behavior

### Triggers
- Screen load triggers retrieval of Work Order detail (status + assignment context).
- Save action triggers update call for assignment context.

### UI actions
- View assignment context fields.
- â€œEditâ€ toggles form state.
- â€œSaveâ€ submits changes.
- â€œCancelâ€ reverts unsaved changes.

### State changes (frontend)
- Local UI state: view mode â†” edit mode.
- After save: re-fetch Work Order to reflect server truth.

### Service interactions
- Load: `GET WorkOrder` (details)
- Update: `POST/PUT WorkOrder assignment context` (exact endpoint TBD)
- Optional audit: `GET WorkOrder transitions/history` and/or `GET assignment sync log`

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Client-side validation (only ergonomic; backend is authoritative):
  - `locationId` optional/required is **unknown** â†’ do not enforce requiredness unless backend indicates.
  - `mechanicIds` may be empty â†’ allow empty unless backend rejects.
- Always validate types (IDs are string/UUID-like).

### Enable/disable rules
- **Editable only when Work Order is pre-start.**
  - Based on documented FSM: **start-eligible statuses are `APPROVED`, `ASSIGNED`**.
  - If status is anything else (including `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`), disable editing.

### Visibility rules
- Assignment Context section always visible.
- Edit controls visible only when status is `APPROVED` or `ASSIGNED` (unless overridden by permissions; see Open Questions).

### Error messaging expectations
- If backend rejects due to invalid status: show â€œCannot update assignment context after work has started.â€
- If backend returns 401/403: show â€œYou do not have permission to update assignment context.â€
- If backend returns 404: show â€œWork order not found.â€
- If backend returns 409: show â€œWork order changed since you opened it. Reloadingâ€¦â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `WorkOrder` (workexec-owned)
- `WorkOrderStateTransition` (audit trail; if exposed)
- Potentially `OperationalContext` / `AssignmentSyncLog` (mentioned in original synopsis; backend reference uses audit log concept)

### Fields
**WorkOrder**
- `id` (string/UUID, required, read-only)
- `status` (enum string, required, read-only)
- `locationId` (string/UUID, nullable, editable pre-start)
- `resourceId` (string/UUID, nullable, editable pre-start)
- `mechanicIds` (array of string/UUID, nullable/empty, editable pre-start)

**Audit/History (if available)**
- `transitionedAt` (datetime UTC, read-only)
- `transitionedBy` (user id/string, read-only)
- `fromStatus`, `toStatus` (enum string)
- `reason` (string, optional)

### Read-only vs editable by state/role
- By **state**: fields editable only in `APPROVED`/`ASSIGNED`.
- By **role**: unknown; do not implement role gating beyond what backend enforces (see Open Questions).

### Derived/calculated fields
- `isAssignmentEditable` derived from `status in [APPROVED, ASSIGNED]`.

---

## 9. Service Contracts (Frontend Perspective)

> Exact Moqui service names / REST paths are not provided in the inputs. This section defines required contracts; implementation must map to actual endpoints in the repo.

### Load/view calls
- `GET /api/workorders/{id}`
  - Response must include: `id`, `status`, `locationId`, `resourceId`, `mechanicIds`

### Create/update calls
- `PUT /api/workorders/{id}/assignment-context` (or equivalent)
  - Request body:
    ```json
    {
      "locationId": "uuid-or-null",
      "resourceId": "uuid-or-null",
      "mechanicIds": ["uuid", "uuid"]
    }
    ```
  - Success: 200 with updated WorkOrder (preferred) or 204 + subsequent GET

### Submit/transition calls
- None in this story (no start/stop transitions implemented here).

### Error handling expectations
- `400` validation error â†’ show field-level or banner message from backend.
- `401/403` â†’ show permission error; keep fields read-only.
- `404` â†’ show not found page/state.
- `409` â†’ show conflict banner; refresh Work Order from server.
- `5xx`/network â†’ show retry affordance; do not lose unsaved local draft until user cancels.

---

## 10. State Model & Transitions

### Allowed states (from workexec FSM reference)
- `DRAFT`
- `APPROVED`
- `ASSIGNED`
- `WORK_IN_PROGRESS`
- `AWAITING_PARTS`
- `AWAITING_APPROVAL`
- `READY_FOR_PICKUP`
- `COMPLETED`
- `CANCELLED`

### Role-based transitions
- Not in scope; only state-based edit gating is implemented in UI.

### UI behavior per state
- `APPROVED`, `ASSIGNED`: assignment context section editable.
- All other states: read-only; show locked message.

---

## 11. Alternate / Error Flows

### Validation failures
- Backend rejects missing/invalid IDs: highlight relevant field(s) if error provides field mapping; otherwise show banner.

### Concurrency conflicts
- If status changes between load and save, backend returns 409 or 400; UI:
  - shows message indicating status changed,
  - reloads Work Order and exits edit mode.

### Unauthorized access
- If user cannot view Work Order: show access denied.
- If user can view but cannot edit: hide/disable edit controls; show tooltip/banner on attempt.

### Empty states
- If assignment context is null/empty: display â€œNot assigned yetâ€ for each field.
- If mechanicIds empty: show â€œNo mechanics assignedâ€.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View assignment context on a work order
**Given** I am an authenticated user  
**And** a Work Order exists with status `APPROVED`  
**When** I open the Work Order detail screen  
**Then** I see the Assignment Context fields `locationId`, `resourceId`, and `mechanicIds` (or â€œNot assigned yetâ€ when null)  

### Scenario 2: Edit assignment context when work order is pre-start
**Given** I am an authenticated user with permission to edit assignment context  
**And** a Work Order exists with status `ASSIGNED`  
**When** I enter edit mode in the Assignment Context section  
**And** I change `locationId`, `resourceId`, and `mechanicIds`  
**And** I save  
**Then** the frontend sends an update request containing the full context object  
**And** the UI shows the updated values after success  
**And** the UI refreshes the Work Order from the server  

### Scenario 3: Editing is disabled after work starts
**Given** I am an authenticated user  
**And** a Work Order exists with status `WORK_IN_PROGRESS`  
**When** I open the Work Order detail screen  
**Then** the Assignment Context section is read-only  
**And** I do not see enabled edit/save controls  
**And** I see messaging that assignment context is locked after work starts  

### Scenario 4: Save rejected because status changed to in-progress during edit
**Given** I am editing assignment context for a Work Order currently shown as `ASSIGNED`  
**And** the Work Order status changes on the server to `WORK_IN_PROGRESS` before I save  
**When** I click Save  
**Then** the UI displays an error indicating the update cannot be applied after work started  
**And** the UI reloads the Work Order and exits edit mode  
**And** the displayed assignment context matches the server response  

### Scenario 5: Audit/history is accessible after a successful update (if endpoint exists)
**Given** I updated assignment context successfully for a pre-start Work Order  
**When** I view the History/Audit section on the Work Order detail  
**Then** I can see an entry indicating assignment context changed, including timestamp and actor (as provided by backend)  

---

## 13. Audit & Observability

### User-visible audit data
- Show a â€œHistoryâ€ section (or reuse existing one) that can list:
  - status transitions (from `GET /workorders/{id}/transitions`), and/or
  - assignment-context change audit events (if provided by backend).

### Status history
- Display transition list sorted newest-first with UTC timestamps rendered in user locale.

### Traceability expectations
- On successful save, include correlation/request ID in console logs (frontend) if available via headers.
- Do not display sensitive internal identifiers beyond IDs already shown.

---

## 14. Non-Functional UI Requirements

- **Performance:** Work Order detail load within 2s on typical broadband for single Work Order; history loads lazily if large.
- **Accessibility:** All form controls keyboard-navigable; labels associated; error messages announced via ARIA live region where applicable.
- **Responsiveness:** Assignment section usable on tablet widths (shop floor use).
- **i18n/timezone:** Display timestamps in local timezone; store/submit timestamps not required for this story.
- **Security:** Do not cache sensitive data beyond session; respect backend authorization responses.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Show â€œNot assigned yetâ€ for null `locationId`/`resourceId` and â€œNo mechanics assignedâ€ for empty `mechanicIds`; qualifies as safe because it is purely presentational and does not change domain behavior; impacted sections: UX Summary, Alternate/Empty states.
- SD-ERR-HTTP-MAP: Standard HTTP error-to-message mapping (400/401/403/404/409/5xx) without inventing domain policy; qualifies as safe because it follows generic transport semantics; impacted sections: Business Rules, Service Contracts, Error Flows.

---

## 16. Open Questions

1. **Backend contract:** What are the exact Moqui-facing endpoints/services for:
   - loading Work Order detail,
   - updating assignment context,
   - fetching audit/history for assignment-context changes?
2. **ID types & lookup UX:** Are `locationId`, `resourceId`, `mechanicIds` free-entry IDs, or should the UI provide searchable pickers backed by lookup endpoints? If pickers, what are the lookup APIs and display fields?
3. **Permission model:** Which roles are allowed to edit assignment context (Service Advisor only? Shop Manager? Dispatcher)? Should UI hide or disable edit controls based on a permission flag from backend?
4. **State gating nuance:** Is editability strictly limited to `APPROVED` and `ASSIGNED` only (per FSM â€œstart-eligibleâ€), or is `DRAFT` also editable? The current FSM doc defines start-eligible, but the story says â€œupdates allowed until work starts.â€
5. **Audit display source:** Should the frontend display:
   - generic work order transition history only,
   - a specific â€œAssignmentSyncLogâ€ list,
   - or both?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Workexec: Propagate Assignment Context to Workorder  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/128  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Workexec: Propagate Assignment Context to Workorder

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **System**, I want workorders to carry location/resource/mechanic context from shopmgr so that execution and reporting are accurate.

## Details
- Attach operational context at WO creation.
- Updates allowed until work starts.

## Acceptance Criteria
- Workorder has locationId/resourceId/mechanicIds.
- Updates applied pre-start.
- Audit maintained.

## Integrations
- Shopmgr emits AssignmentUpdated; workexec applies update rules; workexec emits StatusChanged.

## Data / Entities
- OperationalContext, AssignmentSyncLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #129: [FRONTEND] [STORY] Workexec: Create Draft Estimate from Appointment â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/129
File: ./scripts/story-work/frontend/129/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Create Draft Estimate from Appointment

### Primary Persona
Service Advisor

### Business Value
Reduce manual re-entry and ensure quote-to-cash starts from the authoritative appointment context (customer/vehicle/location/requested services) by creating a draft estimate directly from an appointment with idempotent behavior.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to create a **Draft** estimate in **workexec** from an appointment  
- **So that** the estimate is initialized with operational context and can immediately be reviewed/edited/approved through the normal estimate workflow.

### In-scope
- Add a **frontend action** from an Appointment context: â€œCreate Draft Estimateâ€.
- Call the backend operation to create the estimate from the appointment (idempotent).
- Handle â€œalready createdâ€ idempotent responses by navigating to the existing estimate.
- Persist/linkage visibility in UI (at least show resulting `estimateId` and that itâ€™s linked to this appointment).

### Out-of-scope
- Appointment creation/editing (shop management domain).
- Estimate line-item editing workflows beyond confirming the created draft exists (those belong to estimate authoring stories).
- Asynchronous event handling beyond what the frontend needs to proceed (unless clarified as required).
- Any changes to approval configuration logic or estimate state machine beyond ensuring initial status is `DRAFT`.

---

## 3. Actors & Stakeholders
- **Primary actor:** Service Advisor (POS user)
- **System actors:**
  - **Frontend (Moqui/Quasar UI)**: initiates create-from-appointment and routes to estimate view.
  - **Workexec backend**: system of record for Estimate lifecycle.
  - **Shopmgr backend (implied)**: system of record for Appointment (frontend likely loads appointment from here or via Moqui integration).
- **Stakeholders:** Shop Manager, Customer (indirect)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS.
- User can view the target appointment.
- Appointment is not cancelled (rule referenced in backend story).

### Dependencies (blocking to implement precisely)
1. **Backend endpoint contract for â€œCreate Estimate From Appointmentâ€ as available to the Moqui frontend** is not specified in provided frontend story text. Backend reference describes a command/event integration, but the Moqui UI needs a concrete callable interface.
2. Appointment retrieval contract (how the frontend obtains appointment context) is not provided.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an **Appointment detail** screen: primary action button **â€œCreate Draft Estimateâ€**.
- Optional: from Appointment list row action (if appointment list exists; only if already present in app navigation).

### Screens to create/modify
1. **Modify**: Appointment detail screen (existing) to add:
   - Action: â€œCreate Draft Estimateâ€
   - Display: linked `estimateId` (if already created)
2. **Create** (if not existing): A minimal **Estimate detail** screen route that can accept `estimateId` and show core status and header fields (or route to an existing estimate screen if already implemented).
3. **Create**: A lightweight **confirmation/result** panel or toast pattern after successful creation (may be inline, not a separate screen).

### Navigation context
- User is on `/appointments/:appointmentId` (exact route TBD per repo conventions).
- On success, navigate to `/workexec/estimates/:estimateId` (exact Moqui screen path TBD).

### User workflows
**Happy path**
1. SA opens an appointment.
2. Clicks â€œCreate Draft Estimateâ€.
3. UI shows loading state; calls create-from-appointment service.
4. UI receives `estimateId` and routes to estimate detail.

**Alternate paths**
- Estimate already exists for appointment: UI routes to that existing estimate and shows â€œEstimate already createdâ€ (non-error).
- Validation error (missing appointment fields): UI shows actionable error and stays on appointment.
- Backend unavailable/timeouts: UI shows retry affordance; request is safe to retry.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œCreate Draft Estimateâ€ on appointment detail.

### UI actions
- Disable the button while request is in-flight.
- Show spinner/progress indicator.
- On success:
  - show a non-blocking success message including `estimateId`
  - navigate to estimate detail
- On idempotent duplicate success:
  - show â€œExisting estimate foundâ€ message
  - navigate to estimate detail

### State changes (frontend)
- Maintain a local UI state: `createEstimateRequestStatus = idle|pending|success|error`.
- If appointment data model includes `linkedEstimateId`, update it from response (or refetch appointment).

### Service interactions
- Frontend calls a Moqui service (or REST call) that invokes workexec create-from-appointment.
- Frontend calls a view service to load the created estimate header for display after navigation.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Client-side pre-check before enabling click (only if appointment payload is present in UI model):
  - Must have `appointmentId`
  - Must have `customerId`
  - Must have `vehicleId`
  - Must have `locationId` (or shop/site id)
- If any missing: show inline error â€œAppointment is missing required fields: â€¦â€ and do not call backend.

### Enable/disable rules
- â€œCreate Draft Estimateâ€ button is:
  - disabled while request is pending
  - disabled if appointment is cancelled (if appointment has a `status` field available to UI)
  - optionally hidden if user lacks permission (permission contract is unclear â†’ see Open Questions)

### Visibility rules
- If an estimate is already linked to appointment (known `estimateId`):
  - show â€œEstimate: <estimateId>â€ with a â€œView Estimateâ€ link
  - show â€œCreate Draft Estimateâ€ either hidden or replaced with â€œOpen Estimateâ€ (behavior depends on whether duplicates are permitted; business rule says exactly one estimate per appointment â†’ so hide/replace)

### Error messaging expectations
- Map backend errors to user-actionable messages:
  - 400: â€œCannot create estimate: appointment data is incomplete.â€
  - 404: â€œAppointment not found or no longer available.â€
  - 409: â€œEstimate creation conflict. Refresh and try again.â€ (for concurrency)
  - 5xx/network: â€œService unavailable. You can retry safely.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Appointment** (shopmgr-owned; fields consumed by UI)
- **Estimate** (workexec-owned; created and then viewed)
- **WorkexecLink** (appointmentId â†’ estimateId) (workexec-owned; UI may display result)

### Fields
**Appointment (read-only in this story)**
- `appointmentId` (string/uuid, required)
- `customerId` (string/uuid, required)
- `vehicleId` (string/uuid, required)
- `locationId` (string/uuid, required)
- `requestedServices[]` (optional)
  - `code` (string, required if item exists)
  - `description` (string, required if item exists)
- `status` (string, optional but needed to enforce â€œnon-cancelledâ€ rule)

**Estimate (view after creation)**
- `estimateId` (uuid, required)
- `status` (enum string, required; must be `DRAFT` on create)
- `customerId`, `vehicleId`, `shopId/locationId` (for header display; exact naming TBD)

### Read-only vs editable by state/role
- In this story:
  - Appointment fields are read-only.
  - Estimate is not edited here; only displayed/navigated-to.

### Derived/calculated fields
- `hasLinkedEstimate` = boolean derived from appointment having `estimateId` link OR backend returning existing estimate on create.

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: concrete Moqui service names/paths are not provided. Below specifies required semantics; implementation may be via Moqui service facade over REST.

### Load/view calls
1. **Load appointment detail**
   - Input: `appointmentId`
   - Output: appointment fields listed above (+ any existing linked `estimateId`)
2. **Load estimate header**
   - Input: `estimateId`
   - Output: minimal estimate header fields (id, status, customer, vehicle, location)

### Create/update calls
1. **Create estimate from appointment (idempotent)**
   - Input (minimum): `appointmentId`
   - Output: `{ estimateId, status }`
   - Semantics:
     - If already exists for appointment, returns existing `estimateId` as success (200 or 201 acceptable; frontend must not rely on code alone).

### Submit/transition calls
- None in this story (estimate approval/decline handled elsewhere).

### Error handling expectations
- Must surface a stable error structure from Moqui service calls:
  - `errorCode` (string) and `errorMessage` (string) at minimum.
- Network/timeout: retryable; UI must offer retry without warning about duplicates (idempotent).

---

## 10. State Model & Transitions

### Estimate states (relevant subset)
- `DRAFT` (created state)
- Other states exist but are not transitioned here.

### Allowed transitions (in this story)
- None initiated; only ensure newly created estimate is `DRAFT`.

### Role-based transitions
- Not applicable in this story.

### UI behavior per state
- If loaded estimate status is not `DRAFT` after creation, show warning banner:
  - â€œEstimate is not Draft (status: X). Verify backend workflow.â€ (helps detect integration issues)

---

## 11. Alternate / Error Flows

1. **Idempotent duplicate**
   - User clicks create twice (double click or retry after timeout).
   - Backend returns same `estimateId`.
   - UI routes to estimate; show informational message.

2. **Missing required appointment data**
   - Backend returns 400 with missing-field details.
   - UI highlights that appointment data is incomplete and blocks creation.

3. **Appointment cancelled**
   - If UI can see appointment status = CANCELLED:
     - button disabled
     - message: â€œCannot create estimate from a cancelled appointment.â€

4. **Concurrency / conflict**
   - Another advisor creates estimate simultaneously.
   - Backend returns either existing estimate (preferred) or 409.
   - If 409: UI prompts user to refresh appointment; after refresh show linked estimate if present.

5. **Unauthorized**
   - Backend returns 403.
   - UI shows â€œYou donâ€™t have permission to create estimates from appointments.â€

6. **Empty state**
   - Appointment has no requested services: still allowed (per backend: requestedServices optional). UI should not block.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create draft estimate from appointment (happy path)
**Given** I am a Service Advisor viewing an appointment with `customerId`, `vehicleId`, and `locationId`  
**When** I click â€œCreate Draft Estimateâ€  
**Then** the system creates or retrieves an estimate in workexec in `DRAFT` status  
**And** I am navigated to the Estimate detail screen for the returned `estimateId`  
**And** the appointment displays a link to the created estimate.

### Scenario 2: Idempotent retry returns existing estimate
**Given** an estimate already exists in workexec linked to appointment `A1`  
**When** I click â€œCreate Draft Estimateâ€ on appointment `A1` again (or retry after a timeout)  
**Then** no second estimate is created  
**And** the same existing `estimateId` is returned  
**And** I am navigated to that estimate.

### Scenario 3: Appointment missing required fields blocks creation
**Given** I am viewing an appointment missing `vehicleId`  
**When** I attempt to create a draft estimate  
**Then** the UI prevents submission and displays an error indicating `vehicleId` is required  
**And** no create call is made.

### Scenario 4: Backend validation failure is shown to user
**Given** I am viewing an appointment  
**And** the create-from-appointment request is sent  
**When** the backend responds with `400 Bad Request` indicating a missing required field  
**Then** the UI shows an actionable error message  
**And** the user remains on the appointment screen  
**And** the â€œCreate Draft Estimateâ€ action becomes available again.

### Scenario 5: Unauthorized user
**Given** I am logged in without permission to create estimates  
**When** I click â€œCreate Draft Estimateâ€  
**Then** the backend responds with 403  
**And** the UI shows a permission error  
**And** no navigation occurs.

---

## 13. Audit & Observability

### User-visible audit data
- On the estimate detail screen, display:
  - `createdAt` and `createdBy` (if available from backend; otherwise omit without inventing)
- On appointment screen, display:
  - linked `estimateId` and (if available) â€œCreated at â€¦â€

### Status history
- Not required to render full history here, but ensure navigation to estimate allows later inspection.

### Traceability expectations
- Frontend must include a correlation ID header if the Moqui frontend conventions support it (otherwise rely on backend-generated request IDs).
- Log client-side action: `create_estimate_from_appointment` with appointmentId and returned estimateId (avoid customer PII).

---

## 14. Non-Functional UI Requirements

- **Performance:** create call should show feedback within 200ms of click (spinner) and complete under normal conditions without blocking UI thread.
- **Accessibility:** button and error messaging must be keyboard accessible; aria-live region for async error/success messages.
- **Responsiveness:** works on tablet viewport used at service desk.
- **i18n:** all user-facing strings via localization keys (project convention).
- **Timezone/currency:** not applicable in this story.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Allow appointments with no requested services; show â€œNo requested servicesâ€ text because requestedServices is optional and this is a UI-only ergonomics choice. (Impacted: UX Summary, Error Flows)
- SD-UX-LOADING-DISABLE: Disable primary action during in-flight request to prevent double submits; safe because backend is idempotent and this reduces accidental retries. (Impacted: Functional Behavior)
- SD-ERR-HTTP-MAP: Standard mapping of HTTP 400/403/404/409/5xx to user messages; safe because it does not change domain policy, only presentation. (Impacted: Business Rules, Error Flows)

---

## 16. Open Questions

1. **Backend callable contract for Moqui UI:** What is the exact endpoint/service the frontend should call to â€œCreate Estimate From Appointmentâ€?  
   - REST path? (Backend reference discusses `CreateEstimateFromAppointment` command but not a concrete HTTP path for Moqui.)  
   - Request body: is it only `appointmentId` or does frontend pass full appointment payload?

2. **Appointment source in this frontend:** Does the Moqui frontend load appointments from `shopmgr` via an existing Moqui service/screen, or is appointment data already present in this repository? Provide the existing screen path/entity/service used for appointment detail.

3. **Routing conventions:** What are the canonical Moqui screen paths for:
   - Appointment detail
   - Estimate detail (workexec)
   so navigation can be specified precisely?

4. **Link visibility & storage:** Should the appointment detail UI rely on reading a link from shopmgr (appointment has estimateId), or from workexec (lookup WorkexecLink by appointmentId), or both?

5. **Permissions:** What permission/role gates should control showing/enabling â€œCreate Draft Estimateâ€? (Do not want to assume advisor-only without the projectâ€™s security model.)

6. **Resource specificity:** The original notes say â€œlocation/resourceâ€. Do we need to pass and store a `resourceId` (bay/technician) in the draft estimate, and if so, is it available on appointment payload?

7. **Asynchronous event requirement:** Is the `Workexecâ†’Shopmgr EstimateCreated` event required for frontend correctness (e.g., appointment UI wonâ€™t show link until event processed), or can the frontend proceed purely from synchronous response?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Workexec: Create Draft Estimate from Appointment â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/129

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Workexec: Create Draft Estimate from Appointment
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/129
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Workexec: Create Draft Estimate from Appointment

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Service Advisor**, I want to create a draft estimate in workexec from an appointment so that quote-to-cash starts with operational context.

## Details
- Appointment provides customerId, vehicleId, location/resource, requested services.
- Workexec returns estimateId and shopmgr stores linkage.

## Acceptance Criteria
- Estimate created and linked.
- Idempotent retry safe.

## Integrations
- Shopmgrâ†’Workexec CreateEstimateFromAppointment; Workexecâ†’Shopmgr EstimateCreated.

## Data / Entities
- WorkexecLink(appointmentIdâ†’estimateId), CommandEnvelope

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #130: [FRONTEND] [STORY] Timekeeping: Approve Submitted Time for a Day/Workorder  
File: ./scripts/story-work/frontend/130/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Timekeeping: Approve/Reject Submitted Time (Day or Work Order) with Adjustments + Exception Resolution

### Primary Persona
Shop Manager

### Business Value
Locks approved labor time for payroll accuracy, prevents retroactive changes without audit, and ensures exceptions are explicitly handled before approval.

---

## 2. Story Intent

### As a / I want / So that
**As a** Shop Manager,  
**I want** to review submitted time entries by day and/or work order, resolve/waive any exceptions, optionally create audited adjustments, and approve or reject submissions,  
**so that** time becomes locked and finalized for payroll and downstream HR integration.

### In Scope
- A manager-facing Moqui screen flow to:
  - View time entries filtered by **work date** and/or **work order**
  - See entry status and exception badges
  - Approve one or more `PENDING_APPROVAL` time entries (lock after approval)
  - Reject one or more `PENDING_APPROVAL` time entries with a required reason
  - Create a **separate adjustment record** for an entry (delta/proposed times), without editing the original entry
  - View and act on exceptions (acknowledge/resolve/waive) based on severity
- Read-only display of approval/decision audit metadata (who/when/reason)

### Out of Scope
- Creating/submitting time entries by employees (separate workflow)
- Payroll/HR system UI or monitoring (integration is backend/event-driven)
- Defining pay rates, wage calculations, tax/benefits
- Configuring exception thresholds and approval methods (policy/config domain)

---

## 3. Actors & Stakeholders
- **Shop Manager (primary):** approves/rejects, creates adjustments, resolves/waives exceptions.
- **Technician / Employee (indirect):** submits time; may correct and resubmit after rejection.
- **HR/Payroll system (downstream):** consumes approval outputs/events (no synchronous dependency for UI).
- **Audit/Compliance (stakeholder):** requires immutable history of approvals, rejections, adjustments, and exception handling.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User has permission to approve/reject time entries (exact permission codes TBD; see Open Questions).
- There exist time entries in `PENDING_APPROVAL` for the selected day and/or work order.

### Dependencies (Backend/API)
This frontend story depends on the backend providing endpoints matching the referenced backend story (#66), plus exception and adjustment operations (some are only described conceptually in backend story text and need confirmation):
- Time entries list/view with status and decision metadata
- Approve/reject operations with validation and proper error codes
- Time exceptions list and mutation operations (acknowledge/resolve/waive)
- Time entry adjustment create/list + approval workflow (or at minimum create â€œproposedâ€ adjustment)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- POS main navigation: **Timekeeping â†’ Approvals**
- Deep links:
  - `/timekeeping/approvals` (queue by date default)
  - `/timekeeping/approvals?workDate=YYYY-MM-DD`
  - `/timekeeping/approvals?workOrderId=<id>`

### Screens to create/modify (Moqui)
Create new screen tree (names can be adjusted to repo conventions):
- **Screen:** `apps/pos/screen/Timekeeping/Approvals.xml`
  - Subscreens:
    - `Queue.xml` (list + filters + batch actions)
    - `EntryDetail.xml` (single entry view + exceptions + adjustments)
    - `AdjustmentDialog.xml` or inline dialog within `EntryDetail`
    - `ExceptionDetail.xml` (optional, can be dialog/panel)

### Navigation context
- Breadcrumb: `Timekeeping > Approvals`
- Filter chips show active scope: `Work Date` and/or `Work Order`

### User workflows

#### Happy path A â€” Approve entries for a day
1. Manager opens **Timekeeping > Approvals**
2. Selects a work date
3. Reviews list; entries with exceptions show badges
4. Resolves/waives any **BLOCKING** exceptions
5. Selects entries and clicks **Approve**
6. UI shows success and updates status to `APPROVED` + read-only lock indicator

#### Happy path B â€” Reject entries with reason
1. Manager selects one or more `PENDING_APPROVAL` entries
2. Clicks **Reject**
3. Modal requires a reason
4. Submits; entries become `REJECTED`, unlock for submitter (informational note)

#### Happy path C â€” Create adjustment (delta/proposed times)
1. From entry detail (or row action) manager chooses **Create Adjustment**
2. Enters reason code + either proposed start/end OR minutes delta (contract TBD)
3. Submits; adjustment appears in adjustments list as `PROPOSED` (or equivalent)
4. Manager proceeds to resolve exceptions then approve/reject time entry as allowed by backend rules

#### Alternate path â€” Approve by work order
- Filter by `workOrderId`, review all pending entries, approve/reject as above.

---

## 6. Functional Behavior

### Triggers
- Screen load: fetch approval queue for default date (today) or selected filters.
- Filter change: re-fetch queue.
- Row click: open entry detail.
- Approve/Reject button: perform batch action.
- Create Adjustment: submit adjustment request.
- Exception actions: acknowledge/waive/resolve (depending on capability).

### UI actions
- Select rows (multi-select) limited to eligible statuses (must be `PENDING_APPROVAL`).
- Approve: confirmation dialog (shows count and warns about locking).
- Reject: modal with required `rejectionReason`.
- Entry detail:
  - Read-only times, work order, employee, status, submittedAt
  - Exceptions section with severity and required actions
  - Adjustments section listing existing adjustments + create new

### State changes (frontend-visible)
- `PENDING_APPROVAL` â†’ `APPROVED` on success (entry becomes read-only; disable actions)
- `PENDING_APPROVAL` â†’ `REJECTED` on success (display rejection reason; allow no further manager action except view)
- Exception status changes: `OPEN` â†’ `ACKNOWLEDGED` / `RESOLVED` / `WAIVED`
- Adjustment status change is **not performed by this story** unless backend supports approving adjustments in same UI (TBD)

### Service interactions (Moqui)
- Use Moqui `service-call` from transitions/actions for:
  - Loading queue data
  - Performing approve/reject
  - Creating adjustments
  - Updating exception statuses

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Reject requires non-empty reason (client-side required + server-side enforced).
- Approve only allowed when:
  - Entry status is `PENDING_APPROVAL`
  - All `BLOCKING` exceptions are not `OPEN` (must be `RESOLVED` or `WAIVED`)
- Adjustments:
  - Must not edit original time entry directly.
  - Must require `reasonCode`. (Reason code set is TBD; do not invent values beyond examples.)
  - Must require either:
    - proposed start/end timestamps, **or**
    - minutes delta
  - If both provided, backend should reject; UI should prevent selecting both (pending contract confirmation).

### Enable/disable rules
- Approve button enabled only when selection contains at least one entry and all selected are `PENDING_APPROVAL`.
- Reject button enabled only when selection contains at least one entry and all selected are `PENDING_APPROVAL`.
- If any selected entry has `BLOCKING` exceptions still `OPEN`, Approve is disabled and UI explains why.
- For `APPROVED` entries: all edit/decision controls hidden/disabled; show â€œLockedâ€ indicator.

### Visibility rules
- Exceptions badge visible when entry has 1+ open exceptions (or any exceptions; TBD).
- Exception action buttons depend on severity and backend-permitted transitions:
  - `WARNING`: allow `ACKNOWLEDGED`
  - `BLOCKING`: require `RESOLVED` or `WAIVED` prior to approval

### Error messaging expectations
- 403: â€œYou do not have permission to approve/reject time entries.â€
- 409: â€œThis entry was updated by someone else. Refresh and try again.â€
- 400: show field-level error (e.g., missing rejection reason).
- 422 (if used): show validation summary for exceptions not resolved.

---

## 8. Data Requirements

### Entities involved (frontend view models)
From backend reference + resolved questions section:
- `TimeEntry`
- `TimeEntryAdjustment`
- `TimeException` (exception flags)

### Fields (type, required, defaults)

#### TimeEntry (read)
- `timeEntryId` (string/uuid) required
- `personId`/`employeeId` (string/uuid) required
- `workOrderId` (string/uuid or string) optional? required when tied to WO
- `workDate` (date) required (needed for day view) **TBD**
- `startAt`/`startTimeUtc` (timestamp) required
- `endAt`/`endTimeUtc` (timestamp) optional (missing clock-out exception)
- `status` enum required: at least `DRAFT|SUBMITTED/PENDING_APPROVAL|APPROVED|REJECTED` (naming mismatch exists; see Open Questions)
- `submittedAtUtc` required when pending/approved/rejected
- `decisionByUserId` required when approved/rejected
- `decisionAtUtc` required when approved/rejected
- `rejectionReason` required when rejected
- Derived (display-only):
  - `durationMinutes` (computed client-side if start/end present; do not treat as authoritative)
  - `hasBlockingExceptions` boolean (from exceptions list)

#### TimeEntryAdjustment (create + read)
- `adjustmentId` (uuid) read-only
- `timeEntryId` required (FK)
- `reasonCode` enum required
- `notes` string optional
- One-of input required:
  - `proposedStartAt` timestamp optional
  - `proposedEndAt` timestamp optional
  - `minutesDelta` integer optional
- `status` enum read-only (e.g., `PROPOSED|APPROVED|REJECTED`)
- audit fields read-only: `requestedBy`, `createdAt`, `approvedBy`, `approvedAt`

#### TimeException (read + update status)
- `exceptionId` uuid required
- `timeEntryId` uuid optional (nullable for day-level exceptions)
- `personId` uuid required
- `workDate` date required
- `exceptionCode` enum required
- `severity` enum required: `WARNING|BLOCKING`
- `status` enum required: `OPEN|ACKNOWLEDGED|RESOLVED|WAIVED`
- `resolutionNotes` string required when waiving (per backend narrative) **TBD**
- `resolvedBy`, `resolvedAt` read-only

### Read-only vs editable
- Managers can only change:
  - time entry decision (approve/reject) while pending
  - exception status (ack/resolve/waive) as permitted
  - create adjustment records (not mutate time entry)

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementation will call services or REST endpoints; exact names depend on backend exposure in this frontend repo. Below are required contracts; if not present, add Open Questions / blocking.

### Load/view calls
- `GET /api/time-entries?status=PENDING_APPROVAL&workDate=YYYY-MM-DD`
- `GET /api/time-entries?status=PENDING_APPROVAL&workOrderId=<id>`
- `GET /api/time-entries/{timeEntryId}`
- `GET /api/time-entries/{timeEntryId}/exceptions`
- `GET /api/time-entries/{timeEntryId}/adjustments`

### Create/update calls
- `POST /api/time-entries/{timeEntryId}/adjustments`
  - body: `{ reasonCode, notes?, proposedStartAt?, proposedEndAt?, minutesDelta? }`

### Submit/transition calls
- Approve (batch capable preferred):
  - `POST /api/time-entries/approve`
    - body: `{ timeEntryIds: [], approvedByUserId?, reason? }` (approvedBy from auth preferred)
- Reject (batch capable preferred):
  - `POST /api/time-entries/reject`
    - body: `{ timeEntryIds: [], reason: "..." }`

- Exception actions:
  - `POST /api/time-exceptions/{exceptionId}/acknowledge`
  - `POST /api/time-exceptions/{exceptionId}/resolve`
  - `POST /api/time-exceptions/{exceptionId}/waive` with `{ resolutionNotes }`

### Error handling expectations
- 401 unauthenticated â†’ redirect to login
- 403 unauthorized â†’ show permission error; keep screen read-only
- 404 not found â†’ show â€œEntry no longer existsâ€
- 409 conflict â†’ prompt refresh; do not assume idempotent success
- Validation errors â†’ map to form-level messages

---

## 10. State Model & Transitions

### TimeEntry states (as used by UI)
- `PENDING_APPROVAL` (or `SUBMITTED`) â€” eligible for manager approve/reject
- `APPROVED` â€” locked, immutable
- `REJECTED` â€” not locked; submitter can correct/resubmit (outside scope)
- Other states may exist (e.g., `DRAFT`), displayed read-only if encountered.

### Allowed transitions (UI-permitted)
- `PENDING_APPROVAL` â†’ `APPROVED` via Approve action (manager)
- `PENDING_APPROVAL` â†’ `REJECTED` via Reject action with reason (manager)

### Role-based transitions
- Only Shop Manager (or users with equivalent permissions) see enabled approve/reject controls.

### UI behavior per state
- `PENDING_APPROVAL`: selectable in queue; actions enabled subject to exception rules
- `APPROVED`: show locked, decision metadata; disable selection/actions
- `REJECTED`: show rejection metadata; disable selection/actions

---

## 11. Alternate / Error Flows

### Validation failures
- Reject without reason:
  - UI blocks submit; server 400 displayed if bypassed.
- Approve with unresolved blocking exceptions:
  - UI disables Approve and lists blocking exceptions; if bypassed, handle 422/400 with message.

### Concurrency conflicts
- Another manager approves while current manager viewing queue:
  - Approve attempt returns 409; UI refreshes queue and shows which entries failed.

### Unauthorized access
- User without permission loads screen:
  - Screen loads queue read-only (if backend allows) or blocks with 403 message.
  - Actions hidden/disabled.

### Empty states
- No pending entries for selected filters:
  - Show empty state with guidance: â€œNo time awaiting approval for this scope.â€

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View pending approvals for a day
Given I am authenticated as a Shop Manager  
When I navigate to Timekeeping Approvals for workDate "2026-01-15"  
Then I see a list of time entries with status "PENDING_APPROVAL" for that date  
And each row shows employee, work order (if any), start/end times, and exception indicator (if any)

### Scenario 2: Approve a pending time entry with no blocking exceptions
Given a time entry "T1" is in status "PENDING_APPROVAL"  
And "T1" has no exceptions with severity "BLOCKING" in status "OPEN"  
When I approve "T1"  
Then the system updates "T1" to status "APPROVED"  
And the UI shows decision metadata (approved by, approved at)  
And "T1" becomes read-only/locked in the UI

### Scenario 3: Reject a pending time entry requires reason
Given a time entry "T2" is in status "PENDING_APPROVAL"  
When I attempt to reject "T2" without entering a reason  
Then the UI prevents submission and displays "Rejection reason is required"  
When I reject "T2" with reason "Incorrect work order"  
Then the system updates "T2" to status "REJECTED"  
And the UI displays the rejection reason and decision metadata

### Scenario 4: Approval blocked by unresolved blocking exception
Given a time entry "T3" is in status "PENDING_APPROVAL"  
And "T3" has an exception "E1" with severity "BLOCKING" and status "OPEN"  
When I view "T3" in the approval queue  
Then the Approve action is disabled for "T3" (or blocked with explanation)  
When I waive exception "E1" with resolution notes "Reviewed; acceptable for payroll"  
And I approve "T3"  
Then "T3" transitions to "APPROVED"

### Scenario 5: Create an adjustment record for an entry
Given a time entry "T4" exists  
When I create an adjustment for "T4" with reasonCode "INCORRECT_WORKORDER" and minutesDelta "+15"  
Then an adjustment record is created and visible under "T4" adjustments  
And the original time entry timestamps are unchanged in the UI

### Scenario 6: Concurrency conflict on approve
Given a time entry "T5" is in status "PENDING_APPROVAL"  
And another manager approves "T5" before I do  
When I attempt to approve "T5"  
Then the system responds with a conflict error  
And the UI prompts me to refresh and shows "T5" is already approved

---

## 13. Audit & Observability

### User-visible audit data
- For each entry: submittedAt, decisionBy, decisionAt, rejectionReason (if rejected)
- For adjustments: createdBy/requestedBy, createdAt, status, approval metadata (if any)
- For exceptions: detectedAt, severity, status, resolvedBy/resolvedAt, resolution notes (if waived)

### Status history
- If backend supports history endpoints, provide a â€œHistoryâ€ panel:
  - approvals/rejections
  - exception state changes
  - adjustments lifecycle
(If not available, omit UI history and rely on backend audit; see Open Questions.)

### Traceability expectations
- UI includes identifiers in error details/logs: `timeEntryId`, `exceptionId`, correlation/request id (if exposed by backend headers).

---

## 14. Non-Functional UI Requirements
- **Performance:** Queue load for a single day should render within 2s for up to 200 entries (paging if more).
- **Accessibility:** All dialogs keyboard-navigable; form errors announced; table selection accessible.
- **Responsiveness:** Works on tablet (manager station) and desktop.
- **i18n/timezone:** Display timestamps in shop local timezone; store/submit in UTC as provided by API. (Timezone source TBD: user profile vs location.)

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty state messaging and â€œchange filtersâ€ guidance; safe as UI-only ergonomics. (Sections: UX Summary, Error Flows)
- SD-UX-PAGINATION: Paginate queue results when large; safe as it doesnâ€™t change domain logic. (Sections: UX Summary, Service Contracts)
- SD-ERR-HTTP-MAP: Standard mapping for 401/403/404/409 to user-facing messages; safe as it does not invent business rules. (Sections: Business Rules, Error Flows, Service Contracts)

---

## 16. Open Questions

1. **Domain label conflict:** The frontend issue states domain â€œuser / shop managementâ€, but the backend story is labeled `domain:workexec`. Should this frontend story be owned by `domain:workexec` (timekeeping within execution) or another domain (e.g., people/user)? This story is currently labeled `domain:workexec` to match the authoritative backend reference, but needs confirmation.  
2. **API contracts:** What are the actual backend endpoints exposed to the Moqui frontend for:
   - listing time entries by workDate/workOrder/status
   - approving/rejecting (single vs batch; request schema; whether approvedBy comes from auth)
   - adjustments create/list and whether adjustments require separate approval in this same UI  
3. **Status naming:** Backend reference uses both `PENDING_APPROVAL` and `SUBMITTED`. What are the canonical enum values returned by the API for time entry status?  
4. **Exception operations:** Are exception actions (ACKNOWLEDGED/RESOLVED/WAIVED) implemented as endpoints? If not, is exception handling read-only for v1 and enforced purely server-side on approval attempts?  
5. **Permission model:** What permission codes/roles does the frontend check to show approve/reject/exception actions (e.g., `TimeEntry:Approve`, `TimeEntry:Reject`)? Is there a distinct permission for waiving blocking exceptions?  
6. **Adjustment input rule:** Must the UI support both â€œproposed start/endâ€ and â€œminutes deltaâ€, or only one? If both are supported, are they mutually exclusive (one-of) as described?  
7. **Timezone source:** Should timestamps be displayed in the shop/location timezone or the managerâ€™s user preference timezone?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Timekeeping: Approve Submitted Time for a Day/Workorder  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/130  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Timekeeping: Approve Submitted Time for a Day/Workorder

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Shop Manager**, I want to approve time submissions so that time becomes locked for payroll.

## Details
- Approve/reject with reason.
- Adjustments via delta entry.

## Acceptance Criteria
- Approved locked.
- Adjustments tracked.
- Exceptions list supported.

## Integrations
- HR receives approval state and totals.

## Data / Entities
- TimeApproval, AdjustmentEntry, ExceptionFlag

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #131: [FRONTEND] [STORY] Timekeeping: Capture Mobile Travel Time Separately  
File: ./scripts/story-work/frontend/131/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Timekeeping: Capture Mobile Travel Time Separately (Travel Segments)

**Primary Persona:** Mobile Lead (and Mobile Technician as day-to-day actor)

**Business Value:** Ensure mobile technician availability is blocked during travel and travel time is captured accurately for downstream timekeeping/payroll workflows, reducing scheduling conflicts and payroll corrections.

---

## 2. Story Intent

**As a** Mobile Lead (or authorized Mobile Technician),  
**I want** to create and complete travel time segments for a mobile work assignment,  
**So that** scheduling accurately blocks availability during travel and timekeeping has the raw travel records needed for later approval/export to HR/payroll.

### In-scope
- View travel segments for a given mobile assignment / work order context
- Start a new travel segment (choose segment type)
- End the active in-progress travel segment
- Basic validation and user feedback for invalid actions (duplicate in-progress segment, non-mobile assignment, etc.)
- Show â€œavailability blocked / in transitâ€ indicator based on in-progress segment status (UI-derived from segment state)

### Out-of-scope
- Travel-time buffer/rounding policy application (explicitly owned by People/Timekeeping per backend reference)
- Time approval workflow and â€œsend to HRâ€ (frontend may display status but not implement approval/export unless endpoints exist)
- GPS tracking, geofencing, map routing
- Managing approval configurations or HR integration settings
- Post-approval corrections via adjustment records (backend concept exists; frontend editing of approved is out-of-scope unless API confirmed)

---

## 3. Actors & Stakeholders

- **Mobile Technician:** Starts/ends travel segments on their own assignment.
- **Mobile Lead / Service Advisor:** May create/edit on behalf (if permitted; see Open Questions).
- **Scheduler / Dispatch:** Consumes availability status; frontend must reflect blocked time in relevant views.
- **Payroll/HR System (downstream):** Ultimately receives approved travel time (not implemented here unless APIs confirmed).
- **Store/Location Manager:** Needs auditability for on-behalf edits and corrections.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- A **mobile** assignment exists and is accessible to the user (assignment identifier available in route params or context).
- Backend provides endpoints to:
  - Load assignment context (or load segments by assignment)
  - Create/start segment
  - End segment
  - List segments

### Dependencies (blocking if absent)
- Backend API contract for travel segments (paths, request/response, enums) is not defined in the provided frontend issue; backend reference #67 provides conceptual model but not definitive REST paths for segment start/stop.
- UI entry point location (where in app this lives) is not specified.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a **Mobile Assignment / Mobile Appointment** detail screen: â€œTravel Timeâ€ action/tab
- From a **Work Order (mobile)** detail screen: â€œTravel Timeâ€ action/tab (if work order is the primary context)

### Screens to create/modify
1. **New screen:** `apps/pos/screen/mobile/TravelSegmentList.xml` (name indicative)
   - Lists segments for the current assignment
   - Shows active segment (if any) with â€œEnd Segmentâ€ primary action
   - Shows â€œStart Segmentâ€ action when no segment is in progress
2. **Modify existing screen(s)** (if present in repo):
   - Mobile assignment detail screen: add navigation to Travel Segment screen
   - Work order detail (mobile): add navigation to Travel Segment screen

### Navigation context
- Route contains `mobileWorkAssignmentId` (preferred) or `workOrderId` with a way to resolve mobile assignment reference.
- Breadcrumb: Mobile Assignments â†’ Assignment Detail â†’ Travel Time

### User workflows
**Happy path**
1. User opens Travel Time screen for an assignment.
2. Sees current segments and whether one is in progress.
3. Clicks â€œStart Segmentâ€ â†’ selects segment type â†’ confirms.
4. UI shows segment as `IN_PROGRESS` with start timestamp.
5. On arrival, user clicks â€œEnd Segmentâ€ â†’ confirms.
6. UI shows completed segment with duration.

**Alternate paths**
- Start blocked because there is already an in-progress segment â†’ UI shows error and highlights active segment.
- Assignment is not mobile â†’ UI shows â€œTravel time can only be logged for mobile assignments.â€
- User is not authorized â†’ UI shows access denied and disables actions.

---

## 6. Functional Behavior

### Triggers
- Screen load (route entry): fetch assignment + segments
- Start Segment action
- End Segment action

### UI actions
- **Start Segment**
  - Opens a modal/dialog to select `segmentType` (enum-driven)
  - Confirm submits to backend
- **End Segment**
  - Available only when exactly one segment is `IN_PROGRESS` (or backend indicates activeSegment)
  - Confirm submits to backend with segmentId or assignmentId (depending on API)

### State changes (frontend-local)
- Maintain `segments[]` list and `activeSegment` computed from `status === IN_PROGRESS`
- On successful start/end: refresh list (or optimistic update if response includes updated segment)

### Service interactions (Moqui screen actions)
- `GET` load segments for assignment
- `POST` create/start segment
- `POST` end/complete segment

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Cannot start a segment if an `IN_PROGRESS` segment exists for the same assignment.
- Cannot end a segment if none is `IN_PROGRESS`.
- Segment type must be selected (required).
- Travel time can only be logged for **mobile assignments**; otherwise block start/end actions and show error.

### Enable/disable rules
- â€œStart Segmentâ€ disabled if active segment exists.
- â€œEnd Segmentâ€ enabled only if active segment exists.
- Segment type selector lists only supported types (v1 per backend reference):
  - `DEPART_SHOP`
  - `ARRIVE_CUSTOMER_SITE`
  - `DEPART_CUSTOMER_SITE`
  - `ARRIVE_SHOP`
  - `TRAVEL_BETWEEN_SITES`
  - `DEADHEAD`

### Visibility rules
- If segment was created/edited â€œon behalfâ€, show an indicator and audit snippet (requires API fields; otherwise omit and raise question).
- Show an â€œIn Transitâ€ banner/indicator when active segment exists.

### Error messaging expectations
- Duplicate in-progress: â€œYou already have an active travel segment. End it before starting a new one.â€
- Non-mobile: â€œTravel time can only be logged for mobile assignments.â€
- Unauthorized: â€œYou do not have permission to record travel time for this technician.â€

---

## 8. Data Requirements

### Entities involved (frontend view model)
- `TravelSegment`
- `MobileWorkAssignmentRef` (or `MobileWorkAssignment`)

### Fields
**TravelSegment**
- `travelSegmentId` (string/UUID) â€“ required
- `mobileWorkAssignmentId` (string/UUID) â€“ required
- `technicianId` (string/UUID) â€“ required (may be implied by assignment)
- `segmentType` (enum string) â€“ required
- `startAt` (ISO datetime, timezone/UTC) â€“ required
- `endAt` (ISO datetime, nullable) â€“ required for completed
- `status` (enum string: `IN_PROGRESS`, `COMPLETED`, `CANCELLED`) â€“ required
- `durationMinutes` (number, derived) â€“ read-only; display when completed

**Optional audit/on-behalf fields** (ONLY if backend supplies; otherwise Open Question)
- `createdBy`, `lastModifiedBy`, `lastModifiedAt`
- `actedByUserId`, `actedForPersonId`, `onBehalfReasonCode`

### Read-only vs editable
- Segments are not â€œeditableâ€ in this story; only start/end actions.
- Completed segments are read-only.

### Derived/calculated fields
- `durationMinutes` displayed if provided; otherwise compute in UI from `startAt/endAt` for display only (not persisted).

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: exact API paths/schemas for travel segment capture are not defined in provided frontend issue; backend reference shows concepts and an HR event schema, but not the segment CRUD endpoints.

### Load/view calls
- `GET /api/mobile-assignments/{mobileWorkAssignmentId}` (or equivalent) to confirm mobile context (if needed)
- `GET /api/mobile-assignments/{mobileWorkAssignmentId}/travel-segments`
  - Response: list of TravelSegment ordered by `startAt` asc

### Create/update calls
- `POST /api/mobile-assignments/{mobileWorkAssignmentId}/travel-segments`
  - Request: `{ "segmentType": "DEPART_SHOP" }` (+ possibly `technicianId` if on-behalf)
  - Response: `201` with TravelSegment

### Submit/transition calls
- `POST /api/travel-segments/{travelSegmentId}/end`
  - Request: optional `{ "endAt": "<now>" }` (or none; server uses now)
  - Response: `200` with updated TravelSegment

### Error handling expectations
- `400` validation errors â†’ show message from backend if provided; otherwise generic with field highlight.
- `401/403` â†’ show access denied; disable actions.
- `404` assignment/segment not found â†’ show not found state.
- `409` concurrency/active segment conflict â†’ refresh list and show conflict message.

---

## 10. State Model & Transitions

### TravelSegment states (from backend reference)
- `IN_PROGRESS`
- `COMPLETED`
- `CANCELLED` (not created by UI in this story unless API exists)

### Allowed transitions (UI-supported)
- Start segment: (no active) â†’ creates `IN_PROGRESS`
- End segment: `IN_PROGRESS` â†’ `COMPLETED`

### Role-based transitions
- Technician: start/end for self (assumed; confirm via Open Questions if needed)
- Mobile Lead/Service Advisor: on-behalf start/end (only if permitted; confirm)

### UI behavior per state
- `IN_PROGRESS`: show active banner + â€œEnd Segmentâ€
- `COMPLETED`: show duration + timestamps; no actions
- `CANCELLED`: show as cancelled; no actions

---

## 11. Alternate / Error Flows

### Validation failures
- Missing segment type â†’ prevent submit; show inline error â€œSegment type is required.â€
- Non-mobile assignment â†’ disable actions; show blocking message.

### Concurrency conflicts
- Another user started a segment â†’ start returns `409`; UI refreshes and shows the now-active segment.
- Segment ended elsewhere â†’ end returns `409/404`; UI refreshes and removes end action.

### Unauthorized access
- User lacks permission to access assignment or record travel â†’ show `403` screen state; hide action buttons.

### Empty states
- No segments yet â†’ show empty state with â€œStart Segmentâ€ CTA (if permitted).

---

## 12. Acceptance Criteria

### Scenario 1: Start a travel segment successfully
**Given** I am a Mobile Technician assigned to a mobile work assignment  
**And** there is no existing travel segment in `IN_PROGRESS` for that assignment  
**When** I open the Travel Time screen  
**And** I click â€œStart Segmentâ€ and select `DEPART_SHOP`  
**Then** a new travel segment is created with status `IN_PROGRESS` and a recorded `startAt` timestamp  
**And** the UI displays an â€œIn Transitâ€ indicator and an enabled â€œEnd Segmentâ€ action.

### Scenario 2: End an in-progress travel segment successfully
**Given** a travel segment for my mobile assignment is in status `IN_PROGRESS`  
**When** I click â€œEnd Segmentâ€  
**Then** the segment transitions to `COMPLETED` with `endAt` populated  
**And** the UI shows the segment duration (from `durationMinutes` or computed from timestamps)  
**And** the â€œIn Transitâ€ indicator is no longer shown.

### Scenario 3: Prevent starting a new segment when one is already active
**Given** a travel segment for the assignment is in status `IN_PROGRESS`  
**When** I attempt to start another travel segment  
**Then** the system rejects the action with a clear error message  
**And** the UI keeps the existing active segment visible and does not create a second active segment.

### Scenario 4: Block travel time logging for non-mobile assignments
**Given** I navigate to Travel Time from a non-mobile work order/assignment  
**When** the Travel Time screen loads  
**Then** the UI shows â€œTravel time can only be logged for mobile assignments.â€  
**And** Start/End actions are disabled or hidden.

### Scenario 5: Unauthorized user cannot record travel time
**Given** I am logged in without permission to create or end travel segments for this technician/assignment  
**When** I open the Travel Time screen  
**Then** I can view segments only if permitted  
**And** any record actions are hidden/disabled  
**And** attempting the action results in a `403` error message.

---

## 13. Audit & Observability

- UI must display basic audit metadata if provided by backend (created/modified timestamps and â€œon behalfâ€ indicator).
- Frontend should ensure requests include correlation/request ID headers if the project convention exists (Moqui typically supports trace headers; confirm in repo).
- Log (client-side) only non-PII diagnostic info on failures (endpoint, status code, assignmentId, segmentId).

---

## 14. Non-Functional UI Requirements

- **Performance:** Travel Time screen loads segments within 2s on typical mobile network for â‰¤100 segments (pagination if needed).
- **Accessibility:** All actions keyboard accessible; dialog has focus trap; labels announced.
- **Responsiveness:** Mobile-first layout; primary actions reachable on small screens.
- **i18n/timezone:** Display timestamps in userâ€™s local timezone; store/send ISO/UTC per backend.

---

## 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE**
  - Assumed: Provide an explicit empty state with a primary CTA when there are no segments.
  - Why safe: UI-only ergonomics; no domain policy implied.
  - Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- **SD-ERR-HTTP-MAP**
  - Assumed: Standard mapping of HTTP 400/401/403/404/409 to inline/toast errors plus optional refresh on 409.
  - Why safe: Pure error handling; consistent with common frontend practice without altering domain behavior.
  - Impacted sections: Service Contracts, Alternate / Error Flows.

---

## 16. Open Questions

1. **API contracts (blocking):** What are the exact backend endpoints and payloads for:
   - listing travel segments,
   - starting/creating a segment,
   - ending/completing a segment,
   and what are the exact enum values for `status` and `segmentType`?
2. **Primary context identifier (blocking):** Should the frontend route be keyed by `mobileWorkAssignmentId`, `workOrderId`, or both? If both, which is canonical for segment association?
3. **Permissions (blocking):** Confirm the RBAC rules for:
   - technician self-capture,
   - Mobile Lead/Advisor on-behalf capture,
   - whether viewing segments requires separate permission.
4. **On-behalf workflow (blocking):** If on-behalf edits are allowed, what UI is required to select â€œacted forâ€ technician and mandatory `reasonCode`? Provide the allowed reason code enum list.
5. **Cancellation (non-blocking unless required):** Is cancelling a segment in-scope for frontend v1? If yes, what are the rules and endpoint?
6. **Availability indicator source (blocking):** Should availability â€œIn Transitâ€ be derived solely from active segment state, or does backend expose a separate availability/status API that must be used?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Timekeeping: Capture Mobile Travel Time Separately  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/131  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Timekeeping: Capture Mobile Travel Time Separately

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Mobile Lead**, I want to record travel time for a mobile appointment so that availability and payroll are accurate.

## Details
- Travel segments depart/arrive/return.
- Policies may auto-apply buffers.

## Acceptance Criteria
- Segments recorded.
- Sent to HR.
- Availability blocked during travel.

## Integrations
- Shopmgrâ†’HR TravelTime events/API.

## Data / Entities
- TravelSegment, MobileAssignmentRef

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #132: [FRONTEND] [STORY] Timekeeping: Start/Stop Work Session for Assigned Work â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/132
File: ./scripts/story-work/frontend/132/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Timekeeping: Start/Stop Work Session (with Breaks + Overlap Guard) for Assigned Work Order Task

### Primary Persona
Mechanic

### Business Value
Capture accurate, auditable labor time against a specific work order task (net of breaks) to support operational execution and downstream payroll/job-costing consumption, while preventing invalid/overlapping time entries.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Mechanic  
- **I want** to start and stop a work session (and optionally record breaks) tied to my assigned work order task  
- **So that** my labor time is captured accurately for costing and downstream processing, without accidental overlaps or edits after locking/approval.

### In-scope
- UI to **start** a work session for a selected assigned work order task.
- UI to **stop** the currently active session (or active session for that task if backend supports).
- UI to **start/stop breaks** within an active work session (manual break segments).
- UI enforcement of **overlap prevention** and explicit **override path** when backend indicates it is allowed (config + permission + audit reason).
- UI enforcement that **locked/approved** sessions cannot be modified.
- Viewing basic session details and computed totals as returned by backend.

### Out-of-scope
- Manager approval/locking workflow UI (approve/reject) beyond enforcing immutability when locked.
- Configuration UI for overlap policies / approval methods.
- Payroll export screens and downstream integrations UI.
- Creating/assigning work order tasks; this story assumes tasks exist and are assigned.

---

## 3. Actors & Stakeholders
- **Mechanic (Primary)**: starts/stops sessions and records breaks.
- **Service Manager / Admin (Approver)**: approves/locks sessions (enforced as read-only here).
- **Workexec backend service (SoR)**: owns `WorkSession` lifecycle, validations, and computed duration.
- **Payroll / HR / Job Costing (Downstream)**: consume events; no direct UI scope here.

---

## 4. Preconditions & Dependencies
- User is authenticated in POS frontend.
- Mechanic has at least one assigned work order task that is eligible to start work (backend-enforced).
- Backend endpoints for work sessions exist and are reachable (see Service Contracts).
- Frontend has a way to identify:
  - current userId/mechanicId (from session/auth context)
  - selected workOrderId + workOrderTaskId (from navigation context)
  - current locationId (from POS context; if not available, backend must infer)
- Dependency: backend story referenced as implemented/available API contract (Durion backend issue #68). If endpoints differ from the high-level contract, this story remains at risk until confirmed.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a Work Order / Task execution screen: action button(s)
  - â€œStart Workâ€
  - â€œStop Workâ€
  - â€œStart Breakâ€
  - â€œEnd Breakâ€
- Optional global entry: â€œMy Active Sessionâ€ (header/toolbar quick access) if project conventions allow.

### Screens to create/modify
- **Modify** an existing Work Order Task screen (or create a sub-screen) to include timekeeping actions.
  - Example screen path (needs alignment to repo conventions):  
    `apps/pos/screen/workorder/TaskDetail.xml` (or equivalent in Moqui screens tree)
- **Create** a lightweight Work Session detail modal/panel screen for viewing session timing and break state:
  - `apps/pos/screen/timekeeping/WorkSessionPanel.xml` (name indicative)

### Navigation context
- Work order context params: `workOrderId`, `workOrderTaskId`
- User context: derived from Moqui user session; do not require manual entry.
- After start/stop/break actions, remain on the same task screen and refresh session state panel.

### User workflows
**Happy path: start â†’ break â†’ resume â†’ stop**
1. Mechanic opens assigned task.
2. Clicks **Start Work**.
3. UI shows session â€œIN_PROGRESSâ€, start timestamp, and enables break/stop actions.
4. Clicks **Start Break**, then **End Break**.
5. Clicks **Stop Work**; UI displays completed duration (net of breaks).

**Alternate: overlap prevented**
- Mechanic clicks Start Work but already has an active session; backend returns conflict â†’ UI explains and offers navigation to active session.

**Alternate: overlap override allowed**
- Backend indicates override is permitted only with explicit override and reason â†’ UI prompts for reason and retries via override-capable request (if supported by API).

**Alternate: locked**
- If session status is `APPROVED` or `locked=true`, all mutation actions are disabled; attempting deep-link action results in error banner.

---

## 6. Functional Behavior

### Triggers
- Button clicks: Start Work, Stop Work, Start Break, End Break
- Screen load: fetch current task + current active session state (if available) to set button enabled/disabled states.

### UI actions
- **Start Work**
  - Collect required identifiers: `workOrderId`, `workOrderTaskId`
  - Include `userId/mechanicId` only if backend requires (prefer backend deriving from auth if supported).
  - Call start service; on success, refresh session data.
- **Stop Work**
  - Call stop service (by sessionId if known; otherwise task-scoped stop if backend supports).
  - On success, refresh and show final totals.
- **Start Break / End Break**
  - Only available when session is `IN_PROGRESS`.
  - Call break start/stop endpoints with sessionId.
  - Refresh break list/state after each operation.

### State changes (frontend)
- No client-side authoritative state transitions; frontend reflects backend state.
- UI state derived from loaded `WorkSession.status`, `locked`, and â€œactive breakâ€ indicator from backend (or inferred from last break segment missing endAt if returned).

### Service interactions
- Load task context (existing work order/task services already used by app).
- Work session actions via workexec endpoints (see Service Contracts).
- Handle 409 conflicts for overlaps and concurrent actions.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Before calling Start Work:
  - Ensure `workOrderId` and `workOrderTaskId` present in route/context; if missing, block action and show error â€œTask context missing.â€
- Before calling Stop Work / Break actions:
  - Ensure an active `workSessionId` is loaded; if not, disable actions and show â€œNo active session.â€

### Enable/disable rules
- **Start Work** enabled only when:
  - No active session for this mechanic **OR** backend allows overlap override (requires server confirmation; see Open Questions about how frontend learns this)
  - Current session for this task is not already `IN_PROGRESS`
  - Not locked
- **Stop Work** enabled only when:
  - There is an active session in `IN_PROGRESS` (for the mechanic or for this task, depending on backend model)
  - Session is not locked
- **Start Break** enabled only when:
  - Session is `IN_PROGRESS`
  - No break currently active (if backend provides; otherwise infer)
  - Not locked
- **End Break** enabled only when:
  - Session is `IN_PROGRESS`
  - A break is currently active
  - Not locked

### Visibility rules
- Show â€œLocked/Approvedâ€ badge when `locked=true` or `status=APPROVED`.
- Show overlap warning banner when backend returns conflict on start due to existing active session.

### Error messaging expectations
- 400 validation: show field-level or banner message from backend (sanitize if needed).
- 403 unauthorized: â€œYou donâ€™t have permission to perform this action.â€
- 404 not found: â€œWork order/task/session not found or no longer available.â€
- 409 conflict:
  - Overlap: â€œYou already have an active session. Stop it before starting another.â€
  - Concurrent stop/start: â€œThis session changed since you loaded the page. Refresh and try again.â€

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `WorkSession`
- `BreakSegment`
- (Indirect) `WorkOrder`, `WorkOrderTask`

### Fields (type, required, defaults)
**WorkSession (read model as returned)**
- `workSessionId` (UUID/string) â€” required
- `mechanicId` (UUID/string) â€” required
- `workOrderId` (UUID/string) â€” required
- `workOrderTaskId` (UUID/string) â€” required
- `locationId` (UUID/string) â€” required (or backend-derived)
- `resourceId` (UUID/string|null) â€” optional
- `startAt` (ISO-8601 UTC string) â€” required
- `endAt` (ISO-8601 UTC string|null) â€” optional
- `status` (enum) â€” required: `IN_PROGRESS`, `COMPLETED`, `APPROVED`, `REJECTED` (as per backend reference)
- `locked` (boolean) â€” required
- `totalDurationSeconds` (int) â€” required on completed/approved (may be 0 while in progress depending on backend)
- Override audit (read-only):
  - `overlapOverrideUsed` (boolean)
  - `overrideReason` (string|null)
  - `overriddenByUserId` (UUID/string|null)
  - `overrideAt` (ISO-8601|null)

**BreakSegment (read model as returned)**
- `breakSegmentId` (UUID/string) â€” required
- `workSessionId` (UUID/string) â€” required
- `breakStartAt` (ISO-8601 UTC string) â€” required
- `breakEndAt` (ISO-8601 UTC string|null) â€” optional while active
- `breakType` (enum|null) â€” optional (`MEAL`, `REST`, `OTHER`)
- `notes` (string|null) â€” optional

### Read-only vs editable by state/role
- Mechanic can mutate only when session not locked and status is appropriate:
  - Create/start session
  - Stop session
  - Manage breaks
- When `locked=true` or `status=APPROVED`: all fields read-only; mutation calls should be blocked in UI and rejected by backend.

### Derived/calculated fields
- Display â€œNet durationâ€ using `totalDurationSeconds` from backend as source of truth.
- Optionally display human-friendly duration formatting (HH:MM:SS) derived in UI.

---

## 9. Service Contracts (Frontend Perspective)

> Note: Backend reference lists high-level endpoints; exact paths and payloads must be confirmed against the Moqui integration layer used in this repo. Until confirmed, treat as â€œcontract-at-riskâ€.

### Load/view calls
- **Get active session for mechanic** (recommended for UX; if exists)
  - `GET /api/work-sessions/active?mechanicId={id}` (or `/api/work-sessions/active` derived from auth)
  - Returns 200 with WorkSession or 204/404 when none.
- **Get work session by id**
  - `GET /api/work-sessions/{workSessionId}`
- **List breaks for session**
  - `GET /api/work-sessions/{workSessionId}/breaks`

### Create/update calls
- **Start work session**
  - `POST /api/work-sessions/start`
  - Request (minimum):
    - `workOrderId`
    - `workOrderTaskId`
    - `locationId` (if required)
    - optional: `resourceId`
    - optional: `overrideReason` (only when override path used)
  - Response: 201 with created WorkSession
- **Stop work session**
  - `POST /api/work-sessions/stop`
  - Request: either `{ workSessionId }` OR `{ workOrderTaskId }` (must be confirmed)
  - Response: 200 with updated WorkSession

### Submit/transition calls (breaks)
- `POST /api/work-sessions/{id}/breaks/start`
  - optional body: `breakType`, `notes`
- `POST /api/work-sessions/{id}/breaks/stop`
  - Response: updated BreakSegment or WorkSession

### Error handling expectations
- 400: invalid task state, missing required fields, break rules violated (overlap/containment)
- 403: lacking permission (including overlap override permission)
- 409: overlap conflict; concurrent mutation
- UI must surface backend-provided message keys/text; do not attempt to reproduce policy client-side beyond basic disabling.

---

## 10. State Model & Transitions

### Allowed states (WorkSession)
- `IN_PROGRESS`
- `COMPLETED`
- `APPROVED`
- `REJECTED` (present in backend data model; UI read-only display if returned)

### Role-based transitions (as reflected in UI)
- Mechanic:
  - `IN_PROGRESS` â†’ `COMPLETED` via Stop Work
  - create `IN_PROGRESS` via Start Work
  - manage breaks while `IN_PROGRESS`
- Manager/Admin (out-of-scope):
  - `COMPLETED` â†’ `APPROVED` (locks session)

### UI behavior per state
- `IN_PROGRESS`: show live state; enable Stop/Break actions (unless locked).
- `COMPLETED`: disable Start Break/End Break/Stop; allow Start Work on other task (subject to overlap policy).
- `APPROVED`: show locked badge; disable all mutations.
- `REJECTED`: show status; disable all mutations; show reason if backend provides (not defined in inputs).

---

## 11. Alternate / Error Flows

### Validation failures
- Missing context IDs: show blocking banner; do not call backend.
- Break start when already on break: backend 409/400; UI shows â€œBreak already active.â€

### Concurrency conflicts
- Two devices attempt stop/start: backend 409; UI instructs refresh and reload active session state.

### Unauthorized access
- Mechanic attempts override without permission: backend 403; UI: â€œOverride not permitted.â€

### Empty states
- No active session:
  - Task screen shows â€œNo active sessionâ€ and enables Start Work (if task eligible).
- No breaks:
  - Break list shows empty state â€œNo breaks recorded.â€

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Start work session successfully
**Given** I am logged in as a Mechanic  
**And** I am viewing an assigned Work Order Task eligible to start  
**And** I have no other active `IN_PROGRESS` work session (or overlap is permitted and I use the correct path)  
**When** I click â€œStart Workâ€  
**Then** the system creates a WorkSession with `status = IN_PROGRESS` and `startAt` in UTC  
**And** the UI displays the active session details and enables â€œStop Workâ€ and â€œStart Breakâ€.

### Scenario 2: Stop work session successfully
**Given** I have an active WorkSession in `IN_PROGRESS` for the current task  
**When** I click â€œStop Workâ€  
**Then** the system updates the session to `status = COMPLETED` with `endAt` in UTC  
**And** the UI shows `totalDurationSeconds` (net of breaks) returned by the backend  
**And** the UI disables break controls for that session.

### Scenario 3: Start break and end break within a session
**Given** I have an active WorkSession in `IN_PROGRESS`  
**When** I click â€œStart Breakâ€  
**Then** a BreakSegment is created with `breakStartAt` in UTC  
**And** the UI disables â€œStart Breakâ€ and enables â€œEnd Breakâ€  
**When** I click â€œEnd Breakâ€  
**Then** the BreakSegment is updated with `breakEndAt` in UTC  
**And** the UI re-enables â€œStart Breakâ€.

### Scenario 4: Overlap prevented by default
**Given** I am logged in as a Mechanic  
**And** I already have an `IN_PROGRESS` WorkSession  
**When** I attempt to start another WorkSession  
**Then** the backend responds with a conflict (HTTP 409)  
**And** the UI displays an overlap error message  
**And** no new session is shown as started.

### Scenario 5: Overlap override requires permission + reason
**Given** I already have an `IN_PROGRESS` WorkSession  
**And** the backend policy allows overlap only with config + permission + explicit override reason  
**When** I attempt to start a new WorkSession and provide an override reason  
**Then** the new WorkSession is created and includes override audit fields as returned  
**And** the UI indicates an override was used.  

### Scenario 6: Locked/approved sessions are immutable
**Given** a WorkSession is `APPROVED` or has `locked=true`  
**When** I view the session  
**Then** the UI disables Start/Stop/Break actions for that session  
**And** if I attempt a mutation via direct call/navigation, the backend rejects it and the UI displays an error.

---

## 13. Audit & Observability

### User-visible audit data
- Display (read-only) on the session panel when available:
  - `status`, `startAt`, `endAt`, `totalDurationSeconds`
  - `locked` indicator
  - If override used: `overrideReason`, `overrideAt`, `overriddenByUserId` (or â€œManager/Userâ€ if mapped)

### Status history
- Out-of-scope to render full transition history; but UI should not prevent backend from later adding it.
- If backend returns status changes/timestamps, display them read-only.

### Traceability expectations
- Each start/stop/break call should include standard correlation headers if the frontend stack supports it (per repo convention).
- UI should log (frontend console/logger) minimal action telemetry without PII beyond IDs already in route.

---

## 14. Non-Functional UI Requirements
- **Performance:** initial session panel load should complete within 2s on typical shop network; avoid excessive polling.
- **Accessibility:** all controls keyboard reachable; button labels descriptive; status changes announced via aria-live region where feasible in Quasar.
- **Responsiveness:** usable on tablet-sized devices used in bays; actions should be touch-friendly.
- **i18n/timezone:** display timestamps in shop/user local time while preserving UTC in payloads; show timezone indicator. (Do not change backend storage.)

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for â€œno active sessionâ€ and â€œno breaksâ€. Why safe: purely UI ergonomics, no policy impact. Impacted sections: UX Summary, Alternate/Empty states.
- SD-ERR-HTTP-MAP: Map HTTP 400/403/404/409/500 to consistent Quasar notifications/banners. Why safe: standard error-handling, no domain policy inference. Impacted sections: Business Rules, Error Flows, Service Contracts.

---

## 16. Open Questions
1. What are the **exact backend endpoint paths** and request/response schemas for:
   - start session, stop session
   - start/stop break
   - fetching active session and breaks  
   (Backend story lists high-level endpoints but Moqui frontend needs exact contracts.)
2. How should the frontend determine whether **overlap override is available** before attempting start?
   - Does the start endpoint return a structured 409 payload with â€œoverrideAllowedâ€ metadata, or is there a dedicated policy endpoint?
3. Is `mechanicId` derived from the authenticated user in the backend, or must the frontend pass `mechanicId/userId` explicitly?
4. How is `locationId` sourced in the frontend (POS context) and is it required by the backend for starting sessions?
5. Does the backend support stopping by `{workSessionId}` only, or can it stop by `{workOrderTaskId}` / â€œcurrent active sessionâ€?
6. Are there any **additional WorkSession statuses** beyond those listed that must be displayed (e.g., `PAUSED`), or is the enum fixed?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Timekeeping: Start/Stop Work Session for Assigned Work â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/132


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Timekeeping: Start/Stop Work Session for Assigned Work
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/132
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Timekeeping: Start/Stop Work Session for Assigned Work

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Mechanic**, I want to start/stop a work session tied to a workorder/task so that time is captured for payroll and costing.

## Details
- Work session includes mechanicId, workorderId, location/resource, start/end, breaks.
- Prevent overlap unless permitted.

## Acceptance Criteria
- Start/stop supported.
- Overlaps prevented.
- Lock after approval.

## Integrations
- Shopmgrâ†’HR WorkSession events/API.
- Optional: Workexec consumes labor actuals.

## Data / Entities
- WorkSession, BreakSegment, ApprovalStatus

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #133: [FRONTEND] [STORY] Dispatch: Override Conflict with Manager Permission  
File: ./scripts/story-work/frontend/133/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Dispatch: Override Scheduling Conflict with Manager Permission (Reason + Audit Flag)

### Primary Persona
Shop Manager (or other authorized dispatcher role with `shopmgr.appointment.override`)

### Business Value
Enable urgent/exception appointments to be scheduled despite system-detected conflicts while preserving auditability (who/when/why + what conflict was overridden) and ensuring downstream work execution receives an â€œoverride/expediteâ€ context flag.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Shop Manager  
- **I want** to override a scheduling conflict by providing a mandatory reason  
- **So that** urgent jobs can proceed while keeping a permanent audit trail and signaling downstream systems that the schedule was forced.

### In-scope
- Frontend affordance to override a detected scheduling conflict **only** when the user has permission `shopmgr.appointment.override`.
- Mandatory capture of override reason (non-empty).
- Persisting the schedule action with an override flag/context via backend call(s).
- Displaying â€œconflict overriddenâ€ indicator on the affected appointment/work order after success.
- Basic error handling for permission/validation/conflict/concurrency.

### Out-of-scope
- Implementing conflict detection itself (assumed backend provides conflict detection result).
- Defining scheduling resource models (tech/bay calendars) beyond displaying backend-provided conflict details.
- Creating/defining permission model beyond checking/handling `shopmgr.appointment.override`.
- Notification delivery to other parties.
- Any new workflow states beyond what backend exposes.

---

## 3. Actors & Stakeholders
- **Shop Manager (primary)**: may override conflicts with reason.
- **Dispatcher/Service Advisor (secondary)**: may see conflicts but cannot override without permission.
- **Auditor/Compliance**: needs immutable override record accessible via UI (at least indicator and reason visibility per policy).
- **Workexec downstream consumer**: needs `isConflictOverride` and override context to flow.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS UI.
- User is creating or editing an appointment (or scheduling a work order) and initiates â€œSave/Confirm Scheduleâ€.
- Backend returns a scheduling conflict response when applicable.

### Dependencies
- Backend endpoints to:
  - Detect conflicts and return conflict details in a structured payload **or** return a typed error indicating a conflict.
  - Perform the â€œoverride scheduleâ€ action and create an immutable OverrideRecord.
  - Provide permission/authorization enforcement for `shopmgr.appointment.override`.

**Note:** Backend reference exists (durion-positivity-backend issue #69) but the exact API path/schemas for the scheduling/dispatch module are not provided in the frontend issue textâ€”this blocks final, buildable Moqui wiring without confirmation.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Appointment create/edit screen â€œSave/Scheduleâ€ action when a conflict is detected.
- Potentially from a â€œDispatch Calendarâ€ view when placing/rescheduling an appointment into a conflicting slot.

### Screens to create/modify (Moqui)
1. **Modify existing dispatch/scheduling screen** (exact path TBD by repo conventions):
   - Add conflict-handling section/modal.
   - Add â€œOverride Conflictâ€ action gated by permission.
2. **New dialog screen or modal form**:
   - `Override Conflict` modal with required `reason` field and read-only conflict details.

### Navigation context
- User remains on scheduling flow; override is a continuation of the original schedule action.
- After successful override, user returns to the appointment/work order view in â€œscheduledâ€ state with override badge/flag visible.

### User workflows
#### Happy path
1. User attempts to schedule â†’ backend indicates conflict + provides details.
2. UI shows conflict details; if user has permission, show â€œOverride conflictâ€.
3. User clicks override â†’ modal prompts for required reason.
4. Submit override â†’ backend schedules and returns updated appointment/work order + override record id/flag.
5. UI displays success and an â€œOverriddenâ€ indicator.

#### Alternate paths
- User lacks permission â†’ conflict shown, override option hidden/disabled; user must adjust schedule.
- User cancels override modal â†’ no schedule saved; remains in conflict state.
- Backend rejects override (403/validation) â†’ show error; keep user in modal with reason preserved.

---

## 6. Functional Behavior

### Triggers
- Triggered when schedule save/reschedule attempt results in a **conflict response**.

### UI actions
- Display conflict summary + list of conflicts (if multiple).
- If authorized, allow â€œOverride conflictâ€ action.
- Collect override reason (required).
- Submit override request.

### State changes (frontend)
- Local UI state: `conflictDetected=true`, `overrideModalOpen=true`, `overrideReason=<text>`.
- After success: `conflictDetected=false`, show `isConflictOverride=true` on the appointment/work order view model.

### Service interactions (frontend â†” backend)
- Call scheduling â€œsaveâ€ endpoint normally.
- On conflict response: call override endpoint (or retry schedule with override payload) with:
  - appointment/workOrder identifier
  - reason
  - conflict details reference (if backend requires)
  - user context (implicit via auth token; do not send userId unless required by backend contract)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Override reason required**: non-empty, non-whitespace string.
  - UI must block submit until valid.
  - On backend validation failure, show inline error and keep modal open.

### Enable/disable rules
- â€œOverride conflictâ€ button is only enabled when:
  - conflict is present, and
  - user has `shopmgr.appointment.override`, and
  - override modal reason field is valid (for submit).

### Visibility rules
- If user lacks permission, override action is not shown (or shown disabled with â€œrequires permissionâ€ tooltip) â€” choose one consistent pattern per project conventions (needs confirmation).

### Error messaging expectations
- 403: â€œYou donâ€™t have permission to override scheduling conflicts.â€
- 409 (conflict changed/concurrency): â€œThe schedule changed; refresh and try again.â€
- 400 validation: â€œReason is required to override a conflict.â€
- 5xx: â€œCould not override conflict due to a system error. Try again.â€

---

## 8. Data Requirements

### Entities involved (frontend view models)
- **Appointment / WorkOrder (scheduled item)**:
  - `id` (string/number)
  - `isConflictOverride` (boolean, read-only from backend)
  - optional: `overrideRecordId` (string/number, read-only)
  - optional: `overrideContext` (object, read-only; contains reason/type)
- **OverrideRecord** (immutable, primarily for audit display):
  - `overrideId`
  - `appointmentId` (or scheduled entity id)
  - `overriddenByUserId` (read-only)
  - `overrideTimestamp` (read-only)
  - `overrideReason` (read-only after creation; input when creating)
  - `conflictDetails` (read-only; structured)
- **Conflict details** (from backend conflict response):
  - `type` (enum/string)
  - `resourceId` (string)
  - `conflictingAppointmentId` (string) optional
  - Additional fields as provided

### Fields (type, required, defaults)
- `overrideReason: string` (required; no default)
- `isConflictOverride: boolean` (default false; becomes true on successful override)

### Read-only vs editable
- Editable: `overrideReason` only during override action.
- Read-only: all audit fields and conflict details.

### Derived/calculated fields
- `conflictFlagLabel` derived from `isConflictOverride` (e.g., â€œOverriddenâ€).

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking:** exact endpoints/schemas for dispatch scheduling in this Moqui frontend are not specified in provided inputs. Below is the minimum contract the frontend needs; must be mapped to actual Moqui services/transitions.

### Load/view calls
- `GET appointment/workorder` details (existing):
  - Must include `isConflictOverride` and (if allowed) override metadata.

### Create/update calls
- **Schedule attempt** (existing):
  - `POST/PUT /api/.../appointments/{id}/schedule` (placeholder)
  - On conflict, returns either:
    - HTTP `409` with body containing `conflicts[]`, or
    - HTTP `200` with `conflictDetected=true` and details (less likely)

### Submit/transition calls
- **Override conflict** (new or existing variant):
  - Option A: `POST /api/appointments/{id}/override-conflict`
    - body: `{ reason: string, conflictDetails?: object }`
    - returns updated appointment + `overrideRecord`
  - Option B: retry schedule with `override=true` and `reason`
    - body: `{ ..., override: { reason } }`

### Error handling expectations
- 403 for missing permission (`shopmgr.appointment.override`).
- 400 for missing/invalid reason.
- 409 if conflict details changed or resource state moved (optimistic concurrency).

---

## 10. State Model & Transitions

### Allowed states (workexec-aligned, but scheduling-specific)
This story does **not** introduce new work order FSM states. It introduces a *flag/context* on a scheduled entity indicating it was scheduled via override.

### Role-based transitions
- Only users with `shopmgr.appointment.override` can execute the override action.

### UI behavior per state
- Conflict present: show conflict panel; possibly block scheduling unless override or schedule adjustment.
- After override: show â€œOverriddenâ€ indicator and allow normal navigation.

---

## 11. Alternate / Error Flows

1. **Validation failure (empty reason)**
   - UI blocks submit; backend 400 handled with inline error; keep modal open.

2. **Unauthorized (no permission)**
   - If backend returns 403, show permission error and do not schedule.
   - Ensure UI does not offer override action when permissions are absent (defense-in-depth).

3. **Conflict no longer applicable / changed**
   - Backend returns 409; UI prompts to refresh conflict details and reattempt.

4. **Network/server error**
   - Show non-technical message; allow retry.

5. **Empty state**
   - If backend returns conflicts array empty but still indicates conflict, show generic conflict message and log diagnostic details.

---

## 12. Acceptance Criteria

### Scenario 1: Authorized manager overrides conflict successfully
**Given** a user is logged in with permission `shopmgr.appointment.override`  
**And** the user attempts to schedule an appointment that results in a scheduling conflict  
**When** the UI presents the conflict details and the user selects â€œOverride conflictâ€  
**And** the user enters a non-empty reason â€œEmergency customer vehicleâ€  
**And** the user submits the override  
**Then** the appointment/work order is saved/scheduled successfully  
**And** the UI shows the appointment flagged as overridden (`isConflictOverride=true`)  
**And** an override record is created (backend-confirmed via response fields such as `overrideRecordId` or `overrideRecord`) containing the reason and conflict details.

### Scenario 2: User without permission cannot override
**Given** a user is logged in without permission `shopmgr.appointment.override`  
**And** the user attempts to schedule an appointment that results in a scheduling conflict  
**When** the conflict is displayed  
**Then** the UI does not present an enabled â€œOverride conflictâ€ action  
**And** the user cannot complete scheduling in the conflicting slot.

### Scenario 3: Override blocked when reason missing
**Given** a user is logged in with permission `shopmgr.appointment.override`  
**And** a scheduling conflict is detected  
**When** the user selects â€œOverride conflictâ€  
**And** leaves the reason empty or whitespace  
**Then** the UI prevents submission and shows â€œReason is requiredâ€  
**And** no override request is sent (or if sent, backend 400 is surfaced and appointment remains unscheduled).

### Scenario 4: Backend denies override (403) even if UI offered it (defense-in-depth)
**Given** a user attempts an override  
**And** the backend responds with HTTP 403 Forbidden  
**When** the UI receives the response  
**Then** the UI shows a permission error message  
**And** does not mark the appointment as overridden  
**And** keeps the user in the conflict resolution flow.

### Scenario 5: Downstream flag visibility after reload
**Given** an appointment was scheduled via conflict override  
**When** the user reloads the appointment/work order details screen  
**Then** the UI displays `isConflictOverride=true`  
**And** displays the override indicator consistently (e.g., â€œConflict overriddenâ€).

---

## 13. Audit & Observability

### User-visible audit data
- Display (if provided by backend and allowed by policy):
  - override timestamp
  - overridden by (name/id)
  - reason
  - conflict type/resource summary

### Status history
- No new lifecycle states; treat override as an auditable event attached to the appointment/work order.

### Traceability expectations
- UI should surface an override identifier if returned (e.g., `overrideRecordId`) for support/audit lookup.
- Ensure correlation/request IDs (if present in headers) are logged client-side per project conventions.

---

## 14. Non-Functional UI Requirements
- **Performance:** conflict modal opens immediately; avoid extra calls until user chooses override.
- **Accessibility:** modal is keyboard-navigable; reason field has label and error text; focus management on open/close.
- **Responsiveness:** works on tablet resolutions used in shop.
- **i18n:** reason validation/error strings use existing translation mechanism (if present); otherwise keep strings centralized.
- **Security:** do not expose internal conflict resource identifiers unless backend already exposes them; handle 403 safely.

---

## 15. Applied Safe Defaults
- none

---

## 16. Open Questions

1. **What are the actual Moqui screen routes and entity names for â€œDispatch/Schedulingâ€ in `durion-moqui-frontend`?** (Need target screen XML paths and navigation context to implement.)
2. **What is the authoritative backend API contract for conflict detection and override?**  
   - Is conflict reported via HTTP 409 with a payload, or via a normal response with a conflict flag?  
   - Is override done via a dedicated endpoint or by retrying schedule with override payload?
3. **What identifier is being scheduled/overridden in this frontend: Appointment ID, WorkOrder ID, or a separate Dispatch entity?** (Story text uses â€œappointment/work orderâ€ interchangeably.)
4. **Should users without permission see the override option disabled (with explanation) or hidden entirely?** (Affects UX and test expectations.)
5. **Should the UI display the full conflict details and override reason after success, or only a badge/flag?** (Audit visibility policy.)
6. **Does override require capturing any additional â€œimpactsâ€ fields beyond a free-text reason (e.g., impacted resource, urgency code), or is reason + conflictDetails sufficient?** (Story mentions â€œrecords rationale and impactsâ€ but doesnâ€™t define â€œimpactsâ€.)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Dispatch: Override Conflict with Manager Permission  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/133  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Dispatch: Override Conflict with Manager Permission

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Shop Manager**, I want to override a scheduling conflict with a reason so that urgent jobs can proceed with auditability.

## Details
- Requires shopmgr.appointment.override.
- Records rationale and impacts.

## Acceptance Criteria
- Permission required.
- Reason required.
- Conflict flagged.

## Integrations
- Workexec receives override/expedite flag via context.

## Data / Entities
- OverrideRecord, PermissionCheck

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #134: [FRONTEND] [STORY] Dispatch: Assign Mechanic and Resource (Bay/Mobile) to Appointment  
File: ./scripts/story-work/frontend/134/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Dispatch: Assign Mechanic(s) and Primary Resource (Bay/Mobile) to Appointment

## Primary Persona
Dispatcher

## Business Value
Enables dispatch to allocate labor and a primary work resource to a scheduled appointment with conflict/skills validation (and controlled override), ensuring the schedule is accurate, auditable, and ready for downstream work execution.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Dispatcher  
- **I want** to create or replace an assignment for an appointment by selecting one or more mechanics (lead/helper) and a primary resource (bay/mobile)  
- **So that** the appointment is staffed and resourced without conflicts (or with an authorized override), and the assignment is tracked and auditable.

## In-scope
- View current assignment (active) and assignment history for an appointment.
- Create a new assignment for an appointment using:
  - one primary resource (`resourceId`)
  - one or more mechanics with roles (`LEAD`, `ASSIST`) per rules
  - optional override block (with required reason/notes/checks) when validation fails but override is permitted.
- UX for surfacing validation failures and offering override flow when authorized.
- Frontend handling for backend error codes/statuses: 400/403/404/409/422.
- Basic audit visibility via assignment history listing (who/when/version/status if returned by API).

## Out-of-scope
- Building roster management (mechanics/resources creation, skills administration).
- Editing assignment status transitions (e.g., marking IN_PROGRESS/COMPLETED) unless exposed by existing backend endpoint.
- Full calendar/dispatch board UI; only the assignment workflow from an appointment context.
- Emitting domain events directly (frontend does not emit events; backend does).

---

# 3. Actors & Stakeholders
- **Dispatcher**: primary user creating/reassigning assignments.
- **Mechanic(s)**: assigned personnel; may be impacted by scheduling conflicts.
- **Workshop/Operations Manager**: reviews overrides and utilization (audit).
- **System (Moqui UI)**: orchestrates calls, shows conflicts, captures override justification.

---

# 4. Preconditions & Dependencies
- Appointment exists and is in **`SCHEDULED`** state (hard requirement; not overrideable).
- Appointment has `scheduledStartAt` and `scheduledEndAt` (time window source of truth).
- Backend endpoints available (see Â§9):
  - `GET /appointments/{appointmentId}/assignments`
  - `POST /appointments/{appointmentId}/assignments`
- AuthN in place; user has permission:
  - Base create: `workexec.assignment.create`
  - Override create (when used): `dispatch:assignment:override_create`
- Data required to populate selection lists (mechanics/resources) must be available to frontend (endpoint(s) TBD if not already present).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From an Appointment detail screen: action/button **â€œAssignâ€** (or â€œReassignâ€ if active assignment exists).

## Screens to create/modify
1. **Modify**: `apps/pos/screen/Appointment/AppointmentDetail.xml` (name indicative)
   - Add â€œAssignmentâ€ panel showing current active assignment summary + â€œAssign/Reassignâ€ action.
2. **Create**: `apps/pos/screen/Appointment/Assignment/AssignMechanicsResource.xml`
   - Wizard/dialog-style screen for selecting resource + mechanics and submitting.
3. **Create** (optional if not already in backend): `apps/pos/screen/Appointment/Assignment/AssignmentHistory.xml`
   - Shows list of assignments returned by GET, highlighting active assignment.

> Moqui implementation note: use a dedicated sub-screen under Appointment for assignment flow; route includes `appointmentId` in parameters.

## Navigation context
- Route pattern suggestion:
  - `/appointments/{appointmentId}` â†’ Appointment detail
  - `/appointments/{appointmentId}/assign` â†’ assignment creation screen (modal or full page)
- Breadcrumb: Appointments â†’ Appointment #{appointmentId} â†’ Assign

## User workflows

### Happy path: create assignment (no conflicts)
1. Dispatcher opens appointment detail.
2. Clicks â€œAssignâ€.
3. Selects:
   - Primary resource (one)
   - Mechanics (1+)
   - Roles auto/default (single mechanic defaults to LEAD; multi requires explicit roles)
4. Clicks â€œCreate Assignmentâ€.
5. UI shows success, returns to appointment detail, assignment panel updates.

### Alternate path: validation fails; dispatcher uses override
1. Dispatcher completes selections and submits.
2. Backend responds with 409/422 including error code(s).
3. UI displays blocking messages and offers â€œOverride and Createâ€ only if:
   - current user has override permission, and
   - failure category is overrideable, and
   - appointment is still SCHEDULED
4. Dispatcher enters:
   - override reason code
   - override notes
   - selects which checks to override (from backend error code mapping)
5. Submits override request; on success show banner indicating override was used.

### Alternate path: reassignment
- If an active assignment exists, the flow is the same, but UI text indicates it will replace the current assignment; after success, history shows previous assignment marked CANCELLED/SUPERSEDED (as returned by backend).

---

# 6. Functional Behavior

## Triggers
- User clicks â€œAssign/Reassignâ€ from appointment detail.

## UI actions
- Load assignment history for appointment.
- Collect assignment inputs (resource + mechanics + roles).
- Submit create request (with or without override).
- Display result and navigate back/update context.

## State changes (frontend-visible)
- Appointment screen shows â€œAssignedâ€ state in UI (display-only).
- Active assignment shown as:
  - resource
  - mechanics list with roles
  - status (expected `CONFIRMED` on create)
  - version (monotonic; create=1)
- If reassignment: prior active assignment shown as `CANCELLED`/`SUPERSEDED` depending on backend.

## Service interactions
- `GET /appointments/{appointmentId}/assignments` to show active/history.
- `POST /appointments/{appointmentId}/assignments` to create assignment.
- No frontend-side availability/skills computation; backend is source of truth.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation (client-side: basic; server-side: authoritative)
Client-side must validate before submit:
- Required:
  - `resourceId` selected
  - at least one `mechanic` selected
- Roles:
  - if exactly 1 mechanic: role field optional; UI may default to LEAD but should allow submission without explicit role.
  - if >1 mechanics:
    - each mechanic must have a role selected
    - exactly one LEAD
- Override block:
  - if override toggle enabled:
    - `reasonCode` required
    - `notes` required (non-empty)
    - `overriddenChecks[]` must be non-empty

Server-side errors must be surfaced clearly (see Â§11).

## Enable/disable rules
- Disable â€œCreate Assignmentâ€ until required fields valid.
- Show/enable â€œOverrideâ€ section only after a failed submission OR if user explicitly chooses â€œCreate with overrideâ€ and has permission (see Open Questions for whether proactive override is allowed).
- Disable override option if backend indicates hard-block (appointment not SCHEDULED) or if user lacks override permission.

## Visibility rules
- Show assignment history section only if GET returns items; otherwise show empty state â€œNo assignments yetâ€.
- If active assignment exists, show â€œReassignâ€ label and warning text: â€œCreating a new assignment will replace the active assignment.â€

## Error messaging expectations
- Map backend error codes to user-facing messages:
  - `MECHANIC_UNAVAILABLE` â†’ â€œOne or more selected mechanics are unavailable in the appointment time window.â€
  - `RESOURCE_UNAVAILABLE` â†’ â€œSelected resource is unavailable in the appointment time window.â€
  - `SKILL_MISMATCH` â†’ â€œSelected team does not meet required skills for this appointment.â€
  - `INVALID_ROLE_SET` â†’ â€œFor multiple mechanics, select exactly one Lead and assign roles for all mechanics.â€
  - `OVERRIDE_NOT_PERMITTED` (403) â†’ â€œYou donâ€™t have permission to override scheduling checks.â€
- Always display the appointment time window in conflict messages (start/end) to reduce ambiguity.

---

# 8. Data Requirements

## Entities involved (frontend concern; backend SoR)
- Appointment (read): `appointmentId`, `status`, `scheduledStartAt`, `scheduledEndAt`
- Assignment (read/write via API): `assignmentId`, `appointmentId`, `resourceId`, `status`, `version`, override fields
- AssignmentMechanic (read/write via API): `mechanicId`, `role`
- Mechanic roster + skills (read for selection UI) â€” **endpoint/entity TBD**
- Resource roster (bays/mobile units) (read for selection UI) â€” **endpoint/entity TBD**

## Fields (type, required, defaults)

### Create Assignment request (frontend payload)
- `resourceId` (UUID/string) â€” required
- `mechanics` (array) â€” required, min 1  
  - `mechanicId` (UUID/string) â€” required
  - `role` (enum `LEAD|ASSIST`) â€” optional if mechanics length == 1, required otherwise
- `override` (object) â€” optional
  - `used` (boolean) â€” required if override object present
  - `overriddenChecks` (array enum) â€” required if `used=true`, min 1
  - `reasonCode` (enum) â€” required if `used=true`
  - `notes` (string) â€” required if `used=true`

### Display fields (from GET assignments)
Minimum required for UI:
- `assignmentId`
- `status` (`CONFIRMED|IN_PROGRESS|COMPLETED|CANCELLED`)
- `version`
- `resourceId` (+ optionally resource display name)
- `mechanics[]` with role
- audit-ish fields if provided: `createdAt`, `createdBy`, `isOverridden`, `overrideReasonCode`

## Read-only vs editable
- Existing assignments are read-only in this story (no status edits).
- Only create/reassign via POST.

## Derived/calculated fields (frontend)
- â€œActive assignmentâ€ derived as first assignment with status in (`CONFIRMED`,`IN_PROGRESS`) returned by GET (or explicit `active` flag if backend provides).

---

# 9. Service Contracts (Frontend Perspective)

## Load/view calls

### Get assignment history (and active)
- **Method/Path**: `GET /appointments/{appointmentId}/assignments`
- **Success**: `200 OK` returns list (may be empty)
- **Frontend expectations**:
  - includes enough fields to render active summary + history (see Â§8)
  - order: newest-first preferred (if not specified, frontend sorts by `createdAt` if available)

## Create/update calls

### Create assignment (also used for reassignment)
- **Method/Path**: `POST /appointments/{appointmentId}/assignments`
- **Request body**: as defined in Â§8
- **Success**: `201 Created`
  - returns created assignment (preferred) OR an id reference; frontend then refreshes via GET.
- **Errors**:
  - `400 Bad Request`: malformed/missing required fields
  - `403 Forbidden`: permission denied; include code `OVERRIDE_NOT_PERMITTED` when applicable
  - `404 Not Found`: appointment not found
  - `409 Conflict`: availability conflict; include code `MECHANIC_UNAVAILABLE` or `RESOURCE_UNAVAILABLE`
  - `422 Unprocessable Entity`: skills/role validation; include code `SKILL_MISMATCH` or `INVALID_ROLE_SET`
  - `409 Conflict` may also be used for â€œone active assignment per appointmentâ€ race conditions

## Submit/transition calls
- None beyond POST create.

## Error handling expectations (UI)
- For 409/422: show inline, actionable errors; keep user selections.
- For 403: show blocking toast/banner and disable override UI.
- For 404: navigate back to appointments list with message â€œAppointment no longer exists.â€
- For network/5xx: show retry option; do not clear entered data.

---

# 10. State Model & Transitions

## Appointment state constraints (hard block)
- Assignment creation allowed only when appointment is `SCHEDULED`. If not scheduled:
  - hide/disable â€œAssign/Reassignâ€
  - if user reaches screen via deep link, screen must show blocking message and disable submit.

## Assignment statuses (display semantics)
- `CONFIRMED`, `IN_PROGRESS` â†’ considered â€œactiveâ€ and block availability
- `COMPLETED`, `CANCELLED` â†’ historical; do not block availability

## Role-based transitions (frontend gating)
- Dispatcher with `workexec.assignment.create` can attempt creation.
- Override submission requires `dispatch:assignment:override_create` and completion of override fields.

> Note: Work order/workexec events and state transitions are backend-managed.

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- Missing resource â†’ show â€œSelect a resource.â€
- No mechanics â†’ show â€œSelect at least one mechanic.â€
- Multi-mechanic without roles / multiple leads â†’ show role rule message; block submit.

## Backend conflicts (409)
- Mechanic unavailable:
  - Show list of selected mechanics (by display name if available) and message referencing window.
  - Offer override path if permitted.
- Resource unavailable:
  - Highlight selected resource; offer override if permitted.

## Backend semantic issues (422)
- Skill mismatch:
  - Show message; do not auto-change selection.
  - Offer override if permitted and backend categorizes as overrideable.
- Invalid role set:
  - Force user to correct roles; do not show override (overrideability for INVALID_ROLE_SET is **not** listed; treat as non-overrideable).

## Concurrency conflicts
- If POST fails with conflict due to â€œactive assignment already existsâ€ (race):
  - UI refreshes assignment history and informs user â€œAssignment was updated by someone else; review current assignment before retrying.â€

## Unauthorized access
- If user lacks create permission:
  - hide assign action from appointment detail (preferred)
  - if deep-linked, show 403 state with no submit.

## Empty states
- No assignments returned: show empty history state.
- No mechanics/resources available for selection: show empty picker state and guidance (contact admin).

---

# 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create assignment with single mechanic (defaults to LEAD)
**Given** an appointment is in `SCHEDULED` state with a defined start and end time  
**And** I have permission `workexec.assignment.create`  
**When** I select a primary resource and exactly one mechanic  
**And** I submit create assignment without specifying a role  
**Then** the system creates the assignment successfully  
**And** the appointment shows an active assignment with status `CONFIRMED`  
**And** the mechanic is shown as `LEAD` in the assignment display (either returned by API or inferred from response)

### Scenario 2: Create assignment with multiple mechanics requires exactly one Lead
**Given** an appointment is `SCHEDULED`  
**When** I select two mechanics  
**And** I do not assign roles for both mechanics  
**Then** the UI prevents submission and shows an error indicating roles are required  
**When** I set exactly one mechanic to `LEAD` and the other to `ASSIST`  
**Then** submission is enabled

### Scenario 3: Backend rejects due to mechanic availability conflict
**Given** an appointment is `SCHEDULED`  
**And** I have permission `workexec.assignment.create`  
**When** I submit an assignment that conflicts with an existing mechanic booking  
**Then** I see an error message indicating mechanic unavailability for the appointment time window  
**And** my selected inputs remain intact for editing

### Scenario 4: Override flow allowed and succeeds
**Given** an appointment is `SCHEDULED`  
**And** I have permissions `workexec.assignment.create` and `dispatch:assignment:override_create`  
**When** I submit an assignment that fails with error code `MECHANIC_UNAVAILABLE`  
**Then** the UI offers an override option  
**When** I enable override and provide a reason code, notes, and select `MECHANIC_AVAILABILITY` in overridden checks  
**And** I resubmit  
**Then** the assignment is created successfully  
**And** the UI indicates the assignment was created with an override (e.g., â€œOverride usedâ€ banner)

### Scenario 5: Override not permitted
**Given** an appointment is `SCHEDULED`  
**And** I have permission `workexec.assignment.create` but not `dispatch:assignment:override_create`  
**When** I submit an assignment and backend responds `403 Forbidden` with code `OVERRIDE_NOT_PERMITTED`  
**Then** the UI shows a permission error  
**And** the override UI is not available  
**And** no assignment is created

### Scenario 6: Hard block when appointment is not SCHEDULED
**Given** an appointment is not in `SCHEDULED` state  
**When** I navigate to the assign screen  
**Then** the UI displays a blocking message stating assignments can only be created for scheduled appointments  
**And** the submit action is disabled

### Scenario 7: Reassignment replaces active assignment
**Given** an appointment is `SCHEDULED` and currently has an active assignment  
**When** I create a new assignment for the same appointment  
**Then** the appointment shows only one active assignment  
**And** the previous assignment appears in history with a non-active status (e.g., `CANCELLED`/`SUPERSEDED`) as returned by the backend

---

# 13. Audit & Observability

## User-visible audit data
- Assignment history list must show (when provided by API):
  - created timestamp
  - created by (user display name/id)
  - status + version
  - override indicator + reason code (if overridden)

## Status history
- Use `GET /appointments/{appointmentId}/assignments` as the primary source for history.
- If the API includes versioning, display version to support traceability.

## Traceability expectations
- Frontend must include correlation/request ID if project convention exists (Moqui often uses request attributes; otherwise log locally).
- On create success/failure, log structured console/app log entries with appointmentId and error code (no PII).

---

# 14. Non-Functional UI Requirements

- **Performance**: assignment history load should complete within 2s on typical LAN; show loading state.
- **Accessibility**: all form controls labeled; errors associated with fields; keyboard navigable role selection.
- **Responsiveness**: usable on tablet width; mechanics list supports scrolling.
- **i18n/timezone**: display appointment times in shop/location timezone if available; otherwise user timezone (no guessingâ€”use existing app convention).

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for â€œno assignmentsâ€, â€œno mechanicsâ€, â€œno resourcesâ€ to avoid blank panels; qualifies as safe UI ergonomics. (Impacted: UX Summary, Alternate/waswo Flows)
- SD-ERR-STD-MAPPING: Map HTTP 400/403/404/409/422/5xx into consistent banner + inline field errors while preserving form state; qualifies as safe error-handling boilerplate. (Impacted: Service Contracts, Alternate / Error Flows, Acceptance Criteria)

---

# 16. Open Questions
1. What existing backend endpoints (or Moqui services) should the frontend use to **list/select mechanics and resources** (including display names, skills, and availability hints)? If none exist, should this story include building minimal selection endpoints or is it dependent on another story?
2. Does the backend `GET /appointments/{appointmentId}/assignments` return **createdAt/createdBy/isOverridden/overrideReasonCode** fields needed for the audit/history UI, or should the frontend display a reduced history?
3. Should the UI allow a **proactive override** toggle before first submission, or only after receiving an overrideable failure response?
4. What is the canonical **Appointment detail route/screen name** in this Moqui frontend repo (so implementation wires into the correct navigation and menu patterns)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Dispatch: Assign Mechanic and Resource (Bay/Mobile) to Appointment  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/134  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Dispatch: Assign Mechanic and Resource (Bay/Mobile) to Appointment

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Dispatcher**, I want to assign mechanics and a resource to an appointment so that work can be executed efficiently.

## Details
- Validate mechanic/resource availability + required skills.
- Support team assignment (lead/helper).

## Acceptance Criteria
- Assignment created only if checks pass (or override).
- Changes audited.
- Schedule updated.

## Integrations
- Emit AssignmentCreated/Updated to workexec when linked.

## Data / Entities
- Assignment, AssignmentRole, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #135: [FRONTEND] [STORY] Dispatch: Determine Mechanic Availability for a Time Window  
File: ./scripts/story-work/frontend/135/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements
- risk:external-dependency

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title**  
[FRONTEND] [STORY] Dispatch: Determine Mechanic Availability for a Time Window

**Primary Persona**  
Dispatcher

**Business Value**  
Enables dispatchers to assign work without double-booking by showing mechanic availability for a requested time window with explainable conflict reason codes.

---

## 2. Story Intent

**As a** Dispatcher  
**I want** to query and view mechanic availability for a specific time window (optionally filtered to selected mechanics)  
**So that** I can schedule/assign work confidently and understand why a mechanic is unavailable.

### In-scope
- UI to input a time window and location, optionally select mechanic(s)
- Calling an availability API and presenting results per mechanic
- Displaying overall availability status and conflict blocks with standardized reason codes
- Handling API failures (including upstream HR dependency failures) and invalid input validation

### Out-of-scope
- Creating/editing shifts, PTO, assignments, or travel blocks
- Persisting new travel blocks from the frontend
- Implementing the backend aggregation logic (assumed provided by backend)
- Notification/event subscription UI (e.g., consuming AvailabilityChanged events)

---

## 3. Actors & Stakeholders

- **Dispatcher (primary user):** performs availability checks to plan assignments
- **Service Advisor / Shop Manager (stakeholders):** rely on accurate scheduling outcomes
- **Mechanic (subject):** schedule is queried; no direct interaction in this story
- **External HR system (dependency):** provides shift/PTO data (surfaced via backend)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User has permission to access dispatch/scheduling functions and view mechanic availability for a location.

### Dependencies
- Backend availability endpoint exists and is reachable from Moqui frontend.
- Backend returns reason codes and timestamps in UTC per business rules.
- Mechanic directory/listing capability for selection (either from existing UI state or an API).

**Blocking dependency (needs clarification):** definitive backend endpoint path(s) and payload schema for availability query/result.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Dispatch/Scheduling area: â€œCheck Mechanic Availabilityâ€
- From a work assignment flow: â€œCheck availabilityâ€ action before assigning

### Screens to create/modify (Moqui)
- **New screen**: `apps/pos/screen/dispatch/AvailabilityCheck.xml` (name indicative)
  - Purpose: capture query inputs + show results list
- **Optional embedded section**: an includeable screenlet for reuse inside assignment flows (if project conventions support)

### Navigation context
- Route under a dispatch namespace, e.g. `/dispatch/availability` (exact path must match repo conventions; confirm during implementation)
- Breadcrumb: Dispatch â†’ Availability

### User workflows
**Happy path**
1. Dispatcher opens Availability Check screen.
2. Enters:
   - Location
   - Start time (UTC or local w/ conversionâ€”see Open Questions)
   - End time
   - Optional mechanic filter (multi-select)
3. Clicks â€œSearch/Checkâ€.
4. UI shows list of mechanics with:
   - OverallStatus: AVAILABLE / UNAVAILABLE / PARTIALLY_AVAILABLE
   - Conflicts timeline list with reasonCode and start/end

**Alternate paths**
- No mechanics returned: show empty state â€œNo mechanics found for this location/filter.â€
- Mechanic has no conflicts: show AVAILABLE and â€œNo conflicts in windowâ€.
- Partial availability: show conflict blocks and the remaining free time implied (display-only; do not compute scheduling suggestions beyond showing blocks).

---

## 6. Functional Behavior

### Triggers
- User action: â€œCheck Availabilityâ€ button submits query.
- Optional: auto-run when arriving with prefilled window/location from another flow (only if navigation provides params; otherwise out of scope).

### UI actions
- Validate inputs client-side before calling backend:
  - startTime required
  - endTime required
  - locationId required
  - startTime < endTime
- Submit query to backend service (see Service Contracts).
- Render loading state; disable submit while in-flight.
- Render results:
  - Sort mechanics deterministically (default: by name if available; else by mechanicId)
  - For each mechanic show overallStatus and conflict blocks sorted by startTime ascending
- Provide â€œRetryâ€ on error.

### State changes (frontend)
- Local UI state: query form model, loading flag, results model, error banner model.
- No persistent state changes required.

### Service interactions
- Call availability query endpoint.
- Optional call to load mechanics list for selection if not already available.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Time window validity:** if startTime â‰¥ endTime, block submit and show inline error: â€œStart time must be before end time.â€
- **Required location:** block submit and show inline error: â€œLocation is required.â€

### Enable/disable rules
- Disable submit while loading.
- Disable mechanic selector until location is chosen (to avoid cross-location confusion), unless mechanics are global.

### Visibility rules
- Show conflicts section only when overallStatus â‰  AVAILABLE OR conflicts array non-empty.
- Show external dependency error messaging distinctly when backend indicates HR dependency failure (503).

### Error messaging expectations
- 400: show validation message from backend if provided; otherwise â€œInvalid request. Please review the time window and try again.â€
- 401/403: â€œYou donâ€™t have access to view mechanic availability.â€
- 404: â€œAvailability service not foundâ€ (should not happen in prod; still handle).
- 409: â€œAvailability changed; please retry.â€ (only if backend uses concurrency semantics; otherwise generic)
- 503: â€œAvailability is temporarily unavailable because a required scheduling system is down. Please try again later.â€

---

## 8. Data Requirements

### Entities involved (frontend models)
- `AvailabilityQuery`
- `AvailabilityResult`

### Fields

**AvailabilityQuery (request)**
- `startTime` (datetime, required, UTC ISO-8601 string)
- `endTime` (datetime, required, UTC ISO-8601 string)
- `locationId` (id/uuid, required)
- `mechanicIds` (array<id/uuid>, optional)

**AvailabilityResult (response)**
- `queryWindow.startTime` (datetime UTC)
- `queryWindow.endTime` (datetime UTC)
- `mechanicAvailabilities[]`
  - `mechanicId` (id/uuid)
  - `overallStatus` enum: `AVAILABLE` | `UNAVAILABLE` | `PARTIALLY_AVAILABLE`
  - `conflicts[]`
    - `startTime` (datetime UTC)
    - `endTime` (datetime UTC)
    - `reasonCode` enum: `ON_PTO` | `OFF_SHIFT` | `ASSIGNED_WORK_ORDER` | `TRAVEL_BLOCK`

### Read-only vs editable
- All returned availability data is read-only.

### Derived/calculated fields (frontend)
- None required beyond formatting timestamps for display.
- Do not derive availability beyond what backend returns (avoid policy guessing).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is currently not fully specified for the Moqui frontend; below is the required contract shape for implementation. Exact paths must be confirmed (Open Questions).

### Load/view calls
1. **(Optional) Load mechanics list for location**
   - `GET /api/mechanics?locationId=...` (placeholder; must be confirmed)
   - Response: list with `{ mechanicId, displayName }`

### Create/update calls
- None.

### Submit/transition calls
1. **Availability query**
   - Preferred: `POST /api/v1/availability/query` (placeholder) or `POST /api/workexec/availability` (placeholder)
   - Request body: `AvailabilityQuery`
   - Response 200: `AvailabilityResult`
   - Error codes:
     - 400 invalid window/inputs
     - 401/403 unauthorized
     - 503 upstream HR unavailable (distinct)

### Error handling expectations (Moqui/Vue)
- Map non-2xx to a user-visible banner + retain form values for retry.
- Preserve correlation/request id if backend returns it in headers (log it; display only if project convention allows).

---

## 10. State Model & Transitions

### Applicable state model
- This is a **query-only** UI; no workexec entity state transitions occur in this frontend story.

### UI behavior per availability status (per mechanic)
- `AVAILABLE`: show â€œAvailableâ€ and no conflicts (or â€œNo conflictsâ€)
- `UNAVAILABLE`: show â€œUnavailableâ€ and list all conflicts in window
- `PARTIALLY_AVAILABLE`: show â€œPartially availableâ€ and list conflicts in window

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing location/start/end: prevent submit; highlight fields.
- startTime â‰¥ endTime: prevent submit.

### Backend validation failure (400)
- Show inline banner; if backend provides field errors, map them to fields (if schema provided; otherwise generic banner).

### Concurrency conflicts
- If backend returns 409 (e.g., recalculated schedule), show â€œAvailability changed; please retry.â€

### Unauthorized access
- 401: redirect to login (per app convention) or show session expired.
- 403: show access denied page/banner.

### Empty states
- No mechanics returned: show empty results state with suggestion to adjust filters.
- Mechanics returned but conflicts empty: show as available.

### External dependency failure
- 503: show dependency-down message; keep last successful results visible but visually marked as â€œstaleâ€ **only if** project already uses stale patterns (otherwise do not assume; show error and clear results).

---

## 12. Acceptance Criteria

### Scenario 1: Available mechanic, no conflicts
**Given** I am an authenticated Dispatcher  
**And** I select a location and enter a valid start and end time window  
**When** I submit the availability check  
**And** the API returns a mechanic with `overallStatus` = `AVAILABLE` and `conflicts` = `[]`  
**Then** the UI shows that mechanic as Available  
**And** the UI shows no conflict blocks for that mechanic

### Scenario 2: Unavailable due to PTO
**Given** I submit a valid availability check  
**When** the API returns a mechanic with `overallStatus` = `UNAVAILABLE`  
**And** at least one conflict with `reasonCode` = `ON_PTO` and a start/end time  
**Then** the UI shows that mechanic as Unavailable  
**And** the UI lists the PTO conflict with its time range and reason code

### Scenario 3: Partially available due to assignment
**Given** I submit a valid availability check  
**When** the API returns a mechanic with `overallStatus` = `PARTIALLY_AVAILABLE`  
**And** a conflict block with `reasonCode` = `ASSIGNED_WORK_ORDER`  
**Then** the UI shows that mechanic as Partially available  
**And** the UI lists the assignment conflict block in chronological order

### Scenario 4: Invalid time window blocked client-side
**Given** I am on the Availability Check screen  
**When** I enter a start time that is after or equal to the end time  
**Then** the Check Availability action is blocked  
**And** I see an inline validation error stating start time must be before end time  
**And** no API request is sent

### Scenario 5: Upstream HR dependency down
**Given** I submit a valid availability check  
**When** the API responds with HTTP 503 indicating an upstream scheduling dependency is unavailable  
**Then** the UI shows an error banner explaining availability cannot be determined right now  
**And** the UI provides a Retry action  
**And** the form inputs remain populated

### Scenario 6: Permission denied
**Given** I submit a valid availability check  
**When** the API responds with HTTP 403  
**Then** the UI shows an access denied message  
**And** results are not displayed

---

## 13. Audit & Observability

### User-visible audit data
- Not applicable (query UI).

### Status history
- Not applicable.

### Traceability expectations
- Frontend logs (console/log pipeline per project conventions) should include:
  - query window (start/end) and locationId
  - count of mechanics returned
  - request/correlation id if provided by backend
- Do not log PII beyond mechanicId/locationId.

---

## 14. Non-Functional UI Requirements

- **Performance:** Results view should render smoothly for typical location mechanic counts (define threshold if known; otherwise keep implementation efficientâ€”virtual list optional but not required without data).
- **Accessibility:** All form controls labeled; errors announced to screen readers; keyboard navigable results list.
- **Responsiveness:** Works on tablet widths used in shop environments.
- **i18n/timezone:** Display times in shop local time if app standard; keep request/response in UTC. (Blocking until clarified if app standard is unknown.)

---

## 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE**
  - **Assumed:** Provide a standard empty state when no mechanics/results are returned.
  - **Why safe:** Pure UI ergonomics; does not alter domain policy or calculations.
  - **Impacted sections:** UX Summary, Alternate / Error Flows, Acceptance Criteria
- **SD-UX-LOADING-DISABLE-SUBMIT**
  - **Assumed:** Disable submit button while request is in-flight and show loading indicator.
  - **Why safe:** Prevents duplicate submissions; no business semantics changed.
  - **Impacted sections:** Functional Behavior, Business Rules
- **SD-ERR-STD-HTTP-MAPPING**
  - **Assumed:** Map common HTTP errors (400/401/403/503) to user-friendly banners while preserving inputs.
  - **Why safe:** Standard error handling; does not invent authorization or workflow rules.
  - **Impacted sections:** Business Rules, Service Contracts, Alternate / Error Flows

---

## 16. Open Questions

1. What is the **exact backend endpoint** for mechanic availability query for the Moqui frontend (path, method, auth), and does it match the backend storyâ€™s `/api/v1/...` concept or something else?
2. What is the **authoritative request/response JSON schema** (including field names, ID types uuid vs long, and error payload shape) for `AvailabilityQuery` and `AvailabilityResult`?
3. How should the frontend handle **timezone presentation**:
   - Input times entered in shop-local timezone then converted to UTC for API?
   - Or require UTC input (unlikely for users)?
4. Is there an existing **mechanic directory/list API** or store in the frontend to populate the optional mechanic filter? If yes, what is the contract?
5. For `reasonCode` values, is the enumerated list strictly the four codes shown (`ON_PTO`, `OFF_SHIFT`, `ASSIGNED_WORK_ORDER`, `TRAVEL_BLOCK`), or can additional codes appear? If additional codes can appear, what should the UI do (e.g., show â€œOtherâ€ + raw code)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Dispatch: Determine Mechanic Availability for a Time Window  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/135  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Dispatch: Determine Mechanic Availability for a Time Window

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Dispatcher**, I want to see which mechanics are available for a time window so that I can assign work without double-booking.

## Details
- Availability includes shifts/PTO (HR), existing assignments, mobile travel blocks.
- Explainability via reason codes.

## Acceptance Criteria
- API returns availability + reasons.
- Conflicts detected.

## Integrations
- Shopmgr queries HR availability endpoint or consumes AvailabilityChanged events.

## Data / Entities
- AvailabilityQuery, AvailabilityResult

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #137: [FRONTEND] [STORY] Scheduling: Reschedule or Cancel Appointment with Audit  
File: ./scripts/story-work/frontend/137/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)
### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Scheduling: Reschedule or Cancel Appointment with Audit (Moqui Screens)

**Primary Persona:** Dispatcher

**Business Value:** Keep the shop plan accurate by allowing Dispatchers to reschedule/cancel scheduled appointments with a complete audit trail and downstream notification when the appointment is linked to an Estimate or Work Order.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Dispatcher  
- **I want** to reschedule or cancel a previously scheduled appointment  
- **So that** the schedule remains accurate, changes are auditable, and work execution workflows stay in sync when an appointment is linked to an Estimate/Work Order.

### In-scope
- View an Appointment and its current scheduling details.
- Reschedule an appointment by changing:
  - scheduled time window (start/end)
  - optionally assigned resource (technician/resource)
- Cancel an appointment by providing:
  - cancellation reason code (required)
  - cancellation notes (optional)
- Display audit history (AppointmentAudit) for reschedule/cancel actions.
- Ensure backend is notified (via backend API) when appointment is linked to Estimate/Work Order (frontend just calls API; it does not emit events itself).
- Frontend validation and error handling consistent with backend rules:
  - only `Scheduled` appointments can be rescheduled/cancelled
  - handle conflicts (resource unavailable) and invalid state

### Out-of-scope
- Creating appointments.
- Defining/configuring cancellation reason codes (source-of-truth list management).
- Notifications to customer (SMS/email).
- Editing/creating Work Orders/Estimates as a result of changes (only linkage awareness).

---

## 3. Actors & Stakeholders
- **Dispatcher (Primary):** performs reschedule/cancel actions.
- **Service Advisor (Secondary stakeholder):** may rely on accurate appointment status.
- **Technician/Resource (Secondary):** assignment changes affect workload.
- **Workexec domain services (System):** appointment update/cancel APIs, audit persistence, and domain event emission when linked.

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend and has permission to modify appointments (exact permission names TBD).
- Appointment exists and can be loaded by ID.
- Backend endpoints exist and are reachable:
  - Load appointment details
  - Reschedule appointment
  - Cancel appointment
  - Load audit history
- Backend enforces state rules and resource availability checks.
- If cancellation reason codes are a controlled list, frontend must retrieve them from backend or configuration (TBD).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an appointment detail view (e.g., Schedule/Calendar view â†’ click appointment â†’ â€œView Detailsâ€).
- From an appointment list/search screen (optional if exists): open appointment â†’ actions.

### Screens to create/modify
1. **Screen: `apps/pos/scheduling/AppointmentDetail.xml`** (new or extend existing)
   - Shows appointment summary, status, scheduled window, assigned resource, linkage indicators (Estimate/Work Order).
   - Actions:
     - `Reschedule` (enabled only when status == `Scheduled`)
     - `Cancel` (enabled only when status == `Scheduled`)
   - Tab/section: `Audit History` (read-only list)

2. **Dialog/Screen transition: `RescheduleAppointment`**
   - Form to edit:
     - New start datetime
     - New end datetime
     - Assigned resource (optional)
   - Submit triggers backend reschedule call.

3. **Dialog/Screen transition: `CancelAppointment`**
   - Form to input:
     - CancellationReasonCode (required)
     - CancellationNotes (optional)
   - Submit triggers backend cancel call.

### Navigation context
- After successful reschedule/cancel, remain on AppointmentDetail and refresh data and audit list.
- Ensure browser back does not re-submit actions (PRG pattern: Post/Redirect/Get via Moqui transition redirect).

### User workflows
- **Happy path (Reschedule):** Open appointment â†’ Reschedule â†’ choose new window/resource â†’ Save â†’ confirm success â†’ updated details + audit entry visible.
- **Happy path (Cancel):** Open appointment â†’ Cancel â†’ select reason + notes â†’ Confirm â†’ status becomes Cancelled + audit entry visible.
- **Alternate path:** Backend reports resource conflict â†’ show conflict message; keep user in reschedule form with inputs preserved.
- **Alternate path:** Appointment not modifiable due to state â†’ show â€œcannot modifyâ€ and disable actions after refresh.

---

## 6. Functional Behavior

### Triggers
- Dispatcher clicks **Reschedule** or **Cancel** on AppointmentDetail.

### UI actions
- Reschedule:
  - Open reschedule form prefilled with current scheduled window and assigned resource (if present).
  - Client-side validation:
    - start < end
    - both start and end present
- Cancel:
  - Open cancel form.
  - Client-side validation:
    - reason code required

### State changes (frontend-observed)
- On success:
  - Reschedule updates `ScheduledTimeWindow` and possibly `AssignedResourceId` (displayed values change).
  - Cancel updates `Status` to `Cancelled`, and displays cancellation reason/notes (if returned by API).
- On failure:
  - No local optimistic update; show error and re-load appointment if needed (especially for 409 conflicts).

### Service interactions
- Load appointment on entering AppointmentDetail.
- On submit:
  - call reschedule or cancel endpoint
  - refresh appointment detail + audit list after success

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Only status `Scheduled` is modifiable**
  - If appointment status != `Scheduled`:
    - Hide/disable Reschedule and Cancel buttons.
    - If user somehow submits (stale UI), handle `409 Conflict` by showing message and refreshing appointment.

- **Cancellation reason must be from a predefined list**
  - UI must present a controlled selection (dropdown) backed by backend list/config.
  - If backend rejects reason as invalid (`400`), show inline validation.

- **Reschedule must respect availability**
  - Backend is authoritative for resource availability; UI handles `409 Conflict` with actionable message.

### Enable/disable rules
- Reschedule button enabled only when:
  - appointment.status == `Scheduled`
- Cancel button enabled only when:
  - appointment.status == `Scheduled`

### Visibility rules
- Link indicator section visible when appointment has a link to Estimate or Work Order (fields TBD).
- Audit section always visible; show empty state if none.

### Error messaging expectations
- 404: â€œAppointment not found.â€
- 409 invalid state: â€œAppointment cannot be modified because it is <status>.â€
- 409 resource conflict: â€œSelected resource is unavailable for that time window.â€
- 400 validation: field-specific messages (reason code, time window).

---

## 8. Data Requirements

### Entities involved (frontend view models)
- `Appointment`
- `AppointmentAudit`
- `WorkexecLinkRef` (or link fields on Appointment)

### Fields (type, required, defaults)
**Appointment**
- `appointmentId` (string/number, required, read-only)
- `status` (enum: `Scheduled`, `InProgress`, `Completed`, `Cancelled`, required, read-only)
- `scheduledStart` (datetime, required when Scheduled)
- `scheduledEnd` (datetime, required when Scheduled)
- `assignedResourceId` (string/number, optional)
- `workOrderLinkRef` (nullable; exact structure TBD)
- `estimateLinkRef` (nullable; exact structure TBD)
- `cancellationReasonCode` (string, nullable; required when Cancelled)
- `cancellationNotes` (string/text, nullable)

**AppointmentAudit**
- `auditId` (required, read-only)
- `appointmentId` (required, read-only)
- `timestamp` (datetime, required, read-only)
- `actorId` (required, read-only)
- `action` (enum: `CREATED`, `RESCHEDULED`, `CANCELLED`, required, read-only)
- `changes` (json/text, read-only)

### Read-only vs editable (by state/role)
- Editable only through actions and only when status == `Scheduled`:
  - scheduledStart/scheduledEnd/assignedResourceId via Reschedule flow
  - cancellationReasonCode/cancellationNotes via Cancel flow
- All other fields read-only.

### Derived/calculated fields
- `scheduledTimeWindowDisplay` derived from start/end in user timezone.

---

## 9. Service Contracts (Frontend Perspective)

> Note: Backend story shows example endpoints but does not specify Appointment endpoints concretely. These are **blocking** until confirmed.

### Load/view calls
- `GET /api/appointments/{appointmentId}`
  - Returns Appointment with link refs and cancellation fields.
- `GET /api/appointments/{appointmentId}/audit`
  - Returns list of AppointmentAudit entries sorted descending by timestamp.

### Create/update calls
- **Reschedule**
  - `POST /api/appointments/{appointmentId}/reschedule`
  - Request body:
    - `newScheduledStart` (ISO-8601)
    - `newScheduledEnd` (ISO-8601)
    - `newAssignedResourceId` (optional)
  - Success: `200 OK` with updated Appointment OR minimal success + requires reload.

- **Cancel**
  - `POST /api/appointments/{appointmentId}/cancel`
  - Request body:
    - `cancellationReasonCode` (string)
    - `cancellationNotes` (optional string)
  - Success: `200 OK` with updated Appointment OR minimal success + requires reload.

### Submit/transition calls
- Not applicable beyond the above action endpoints.

### Error handling expectations
- `400 Bad Request`: invalid time window, invalid reason code.
- `403 Forbidden`: user not authorized.
- `404 Not Found`: appointmentId unknown.
- `409 Conflict`: invalid state or resource conflict.
- `5xx`: show generic error; allow retry.

---

## 10. State Model & Transitions

### Appointment allowed states (as per backend reference)
- `Scheduled`
- `InProgress`
- `Completed`
- `Cancelled`

### Allowed transitions (frontend-relevant)
- `Scheduled` â†’ `Scheduled` (reschedule: time/resource change)
- `Scheduled` â†’ `Cancelled` (cancel with reason)
- No other transitions in scope.

### Role-based transitions
- Dispatcher can trigger reschedule/cancel (exact RBAC permissions TBD).
- UI must hide/disable actions if backend indicates unauthorized (403) and/or if a permission flag is available in response (TBD).

### UI behavior per state
- `Scheduled`: show enabled Reschedule/Cancel.
- `InProgress`, `Completed`, `Cancelled`: show actions disabled; show reason fields when Cancelled.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Reschedule with end <= start:
  - prevent submit; show inline message â€œEnd time must be after start time.â€
- Cancel without reason:
  - prevent submit; â€œReason is required.â€

### Backend conflicts
- `409 Conflict` invalid state:
  - Show message and refresh appointment detail; keep user on AppointmentDetail.
- `409 Conflict` resource unavailable:
  - Show message and keep reschedule dialog open with prior values preserved.

### Concurrency conflicts
- If appointment changed since loaded (backend may still return 409 or updated data):
  - On 409, reload appointment and display updated current window/status to user.

### Unauthorized access
- `403 Forbidden`:
  - Show â€œYou do not have permission to modify appointments.â€
  - Disable actions after response.

### Empty states
- Audit history empty:
  - Show â€œNo changes recorded yet.â€

---

## 12. Acceptance Criteria

### Scenario 1: Reschedule a Scheduled appointment successfully
**Given** I am logged in as a Dispatcher  
**And** an appointment exists with status `Scheduled`  
**When** I submit a reschedule with a new start/end window (end after start) and an available resource (or no resource)  
**Then** the appointment detail must display the updated scheduled window (and resource if changed)  
**And** an audit entry with action `RESCHEDULED` must be visible in the audit history  
**And** the UI must show a success confirmation without leaving the AppointmentDetail screen.

### Scenario 2: Cancel a Scheduled appointment successfully
**Given** I am logged in as a Dispatcher  
**And** an appointment exists with status `Scheduled`  
**When** I cancel the appointment providing a valid cancellation reason code  
**Then** the appointment status must display as `Cancelled`  
**And** the cancellation reason code (and notes if entered) must be displayed  
**And** an audit entry with action `CANCELLED` must be visible in the audit history.

### Scenario 3: Attempt to reschedule a Completed appointment is rejected
**Given** I am logged in as a Dispatcher  
**And** an appointment exists with status `Completed`  
**When** I attempt to reschedule the appointment  
**Then** the UI must prevent the action (button disabled) **or** if submitted from stale UI the API response must be handled  
**And** I must see an error message indicating the appointment cannot be modified in its current status  
**And** the displayed appointment data must remain unchanged after refresh.

### Scenario 4: Resource conflict during reschedule
**Given** I am logged in as a Dispatcher  
**And** an appointment exists with status `Scheduled`  
**When** I reschedule to a time window where the selected resource is unavailable  
**Then** the UI must display a conflict error message  
**And** the reschedule form must remain open with my entered values preserved  
**And** the appointment must not be updated.

### Scenario 5: Cancel fails without a valid reason code
**Given** I am logged in as a Dispatcher  
**And** an appointment exists with status `Scheduled`  
**When** I submit cancellation without a reason code or with an invalid reason code  
**Then** the UI must show an inline validation error (client-side for missing; server-side for invalid)  
**And** the appointment must not be updated.

---

## 13. Audit & Observability

### User-visible audit data
- AppointmentDetail must show an audit list with:
  - timestamp (localized display, stored UTC)
  - actor (ID or display name if available)
  - action type (RESCHEDULED/CANCELLED)
  - changed fields summary (derived from `changes` payload if available)

### Status history
- Audit list acts as status/change history; no separate timeline required.

### Traceability expectations
- After successful reschedule/cancel, UI should display the latest audit entry without requiring a full page reload (but a data refresh call is acceptable).
- Correlation ID handling:
  - If backend returns/request supports correlation IDs, frontend should pass through existing request ID header per project conventions (TBD by repo README).

---

## 14. Non-Functional UI Requirements

- **Performance:** Appointment detail load (appointment + audit) should render within 2s on typical network; audit list paginated if large.
- **Accessibility:** All actions must be keyboard accessible; dialogs have focus trap; form errors announced via aria-live (Quasar patterns).
- **Responsiveness:** Works on tablet and desktop; dialogs usable on narrow screens.
- **i18n/timezone:** Display datetimes in store/user timezone; send ISO-8601 to backend in UTC or with offset (must match backend expectationâ€”TBD).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Show explicit empty-state message for no audit entries; safe because it does not change domain behavior; impacts UX Summary, Alternate/Empty states.
- SD-UX-POST-REDIRECT-GET: Use PRG-style redirect after POST transitions to avoid double-submit; safe as itâ€™s a UI ergonomics pattern; impacts UX Summary, Error Flows.
- SD-UX-PAGINATION: Paginate audit list when > 50 entries; safe as itâ€™s presentation-only; impacts UX Summary, Data Requirements.

---

## 16. Open Questions

1. **Backend endpoints/paths:** What are the exact REST endpoints for loading an Appointment, rescheduling, cancelling, and fetching audit history (paths + request/response schemas)? (Blocking)
2. **CancellationReasonCode list source:** Is there an endpoint to retrieve valid cancellation reason codes (and display labels), or is it a static enum/config shipped to frontend? Provide the authoritative list and identifiers. (Blocking)
3. **RBAC/permissions:** What permission(s)/role(s) gate reschedule and cancel actions? Should frontend rely solely on 403 handling, or will the appointment payload include allowed-actions flags? (Blocking)
4. **Resource selection:** What is the â€œresourceâ€ entity for assignment (technician user? calendar resource?) and how is availability checked/exposed (do we need a â€œsearch available slots/resourcesâ€ endpoint)? (Blocking)
5. **Time handling:** Should frontend send timestamps in UTC (`Z`) or local with offset? What timezone should be used for display (user vs location/shop)? (Blocking)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Scheduling: Reschedule or Cancel Appointment with Audit  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/137  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Scheduling: Reschedule or Cancel Appointment with Audit

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Dispatcher**, I want to reschedule or cancel an appointment so that the plan stays accurate.

## Details
- Reschedule: change window/resource; Cancel: reason.
- Notify workexec if linked to estimate/WO.

## Acceptance Criteria
- Reschedule updates schedule.
- Cancel sets status+reason.
- Changes audited.

## Integrations
- Emit AppointmentUpdated/Cancelled to workexec when linked.

## Data / Entities
- Appointment, AppointmentAudit, WorkexecLinkRef

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #138: [FRONTEND] [STORY] Scheduling: View Schedule by Location and Resource â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/138
File: ./scripts/story-work/frontend/138/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Scheduling: View Daily Schedule by Location and Resource (with Conflict Flags)

### Primary Persona
Dispatcher

### Business Value
Enables dispatchers to view a single-day schedule organized by location and resource (bay/mobile/person where available) to manage capacity, identify overlaps, and prevent double-booking.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Dispatcher  
- **I want** to view a daily schedule for a selected location, grouped by resource (bays/mobile resources, and optionally people) with conflicts highlighted  
- **So that** I can manage workload, avoid resource collisions, and adjust assignments proactively.

### In Scope
- A daily schedule screen that:
  - Filters by **date**, **location**, **resource type**, and optional **resource**
  - Loads schedule data from a backend schedule view endpoint
  - Displays resources with their events for the day window
  - Highlights events flagged with conflicts and shows conflict details
  - Optionally requests an HR availability overlay and surfaces overlay status/warnings

### Out of Scope
- Editing schedule events (create/update appointments, blocks, etc.)
- Drag/drop rescheduling, assignment changes, or conflict resolution workflows
- Configuration of location hours, resource definitions, or approval/authorization policies
- Implementing the HR availability overlay provider (frontend only consumes status/data if present)

---

## 3. Actors & Stakeholders
- **Dispatcher (primary):** uses schedule view to manage capacity/conflicts
- **Service Advisor (secondary):** may reference schedule when coordinating customer work
- **Shop Manager (secondary):** may review schedule health and utilization
- **Scheduling backend service (system actor):** provides `ScheduleView` read model
- **Optional People/HR system (dependency):** provides availability overlay (soft dependency)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User has authorization to view schedules for the chosen location (backend enforces; frontend must handle 403 gracefully).
- Backend endpoint is available: `GET /api/v1/schedules/view`.

### Dependencies
- Backend story reference: `durion-positivity-backend` issue #74 (schedule view API contract).
- Frontend must have an existing way to select a location (or must provide one on this screen).
- If `includeAvailabilityOverlay=true` is offered in UI, backend must support it; overlay may return `UNAVAILABLE` with warnings while still returning schedule.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Scheduling â†’ Daily Schedule**
- Optional deep link (recommended): `/scheduling/daily?locationId=...&date=YYYY-MM-DD&resourceType=...&resourceId=...&overlay=0|1&range=...`

### Screens to create/modify
- **Create** Moqui screen (example name; final naming must match repo conventions):
  - `apps/pos/scheduling/DailySchedule.xml`
- **Optional**: add menu entry in scheduling navigation screen/menu config.

### Navigation context
- User remains in Scheduling context; changing filters updates the view without leaving the screen.
- Back navigation returns to Scheduling landing page (or prior screen).

### User workflows
**Happy path**
1. Dispatcher opens Daily Schedule.
2. Selects (or confirms) **Location** and **Date** (defaults allowed; see Applied Safe Defaults).
3. Optionally selects **Resource Type** (BAY/MOBILE_TECHNICIAN/PERSON if supported) and/or a specific resource.
4. Screen loads schedule view.
5. Dispatcher scans lanes/list; conflict events appear clearly flagged; selecting an event reveals conflict details.

**Alternate paths**
- Toggle â€œInclude availability overlayâ€ â†’ reloads view; shows overlay status and any warnings.
- Change range (LOCATION_HOURS vs FULL_DAY) â†’ reloads view.

---

## 6. Functional Behavior

### Triggers
- Screen load with required parameters present (at minimum: `locationId`, `date`).
- User changes any filter control:
  - date, location, resourceType, resourceId, includeAvailabilityOverlay, range

### UI actions
- **Load Schedule** action:
  - Disable/lock filter controls while request is in-flight (except â€œCancel/Backâ€).
  - Show loading indicator in the schedule content region.
- **Select resource/event** action:
  - Viewing event details (read-only) including time window, title, type, and conflict list.
- **Conflict interaction**:
  - For `hasConflict=true`, show severity and list conflicting event IDs; allow user to expand/collapse conflict list.

### State changes (frontend state only)
- Persist current filters in:
  - URL query params (preferred for shareable deep links)
  - Local component state for immediate reactivity
- Schedule view data state:
  - `idle` â†’ `loading` â†’ `loaded` OR `error`

### Service interactions
- Call backend `GET /api/v1/schedules/view` with query params.
- No writes/updates in this story.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **locationId** required before fetching schedule.
- **date** required, format `YYYY-MM-DD` before fetching schedule.
- If resourceType is set, it must be one of backend-supported enums:
  - `BAY | MOBILE_TECHNICIAN | PERSON` (PERSON may not be supported; see Open Questions)
- range must be `LOCATION_HOURS | FULL_DAY`.

### Enable/disable rules
- â€œLoad/Refreshâ€ auto-triggers on filter change; while loading:
  - Prevent multiple concurrent loads (debounce or cancel prior request).
- Resource selector:
  - If `resourceType` not selected: resourceId filter control disabled.
  - If schedule view returns `resources[]`, resourceId selector options should be derived from those resources (stable).

### Visibility rules
- Show **warnings** banner if `warnings[]` present (e.g., `HR_SYSTEM_UNAVAILABLE`).
- Show overlay status indicator if field returned:
  - `availabilityOverlayStatus = AVAILABLE | UNAVAILABLE`
- If conflicts exist:
  - Visual marker for conflict and severity on events
  - Conflict details shown on event detail expansion

### Error messaging expectations
- `400`: â€œInvalid schedule filters. Please verify location/date.â€
- `403`: â€œYou donâ€™t have access to this locationâ€™s schedule.â€
- `404`: â€œLocation or resource not found.â€
- Network/timeouts: â€œSchedule service unavailable. Try again.â€
- Overlay unavailable but schedule OK: non-blocking warning banner; schedule still renders.

---

## 8. Data Requirements

### Entities involved (read-only from frontend)
- `ScheduleView` (read model from backend)
- `ScheduleView.resources[]`
- `ScheduleEvent`
- `conflictDetails.conflictingEventIds`
- Optional overlay-related fields: `availabilityOverlayStatus`, `warnings`

### Fields (type, required, defaults)

**Request parameters (UI model)**
- `locationId` (string|number depending on backend; **required**)
- `date` (string `YYYY-MM-DD`, **required**)
- `resourceType` (enum string, optional)
- `resourceId` (string, optional)
- `includeAvailabilityOverlay` (boolean, optional; default false)
- `range` (enum string, optional; default `LOCATION_HOURS`)

**Response: ScheduleView**
- `locationId` (string) required for rendering header/context
- `date` (string) required
- `viewGeneratedAt` (UTC instant string) optional for display/debug
- `dayStartAt` (UTC instant string) required for day window rendering
- `dayEndAt` (UTC instant string) required
- `warnings` (string[]) optional
- `availabilityOverlayStatus` (string enum) optional
- `resources` (array) required (may be empty)

**Response: Resource**
- `resourceId` (string) required
- `resourceType` (string enum) required
- `resourceName` (string) required
- `events` (array) required (may be empty)
- (optional future) overlay fields per resource/person if returned

**Response: ScheduleEvent**
- `eventId` (string) required (stable id)
- `eventType` (string enum) required
- `subType` (string optional)
- `startTime` (UTC instant) required
- `endTime` (UTC instant) required
- `title` (string) required
- `hasConflict` (boolean) required
- `severity` (enum string; expected `BLOCKING|WARNING` when conflict) optional if `hasConflict=false`
- `conflictDetails.conflictingEventIds` (string[]) optional

### Read-only vs editable by state/role
- All fields in this story are **read-only**.
- Role impacts access only via backend authorization (403).

### Derived/calculated fields (frontend-only)
- `durationMinutes` derived from `startTime/endTime` for display.
- `isWithinDayWindow` derived by comparing event times to `dayStartAt/dayEndAt` (optional display hint only; no business decisions).
- Conflict badge severity label derived from `severity`.

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls
**GET** `/api/v1/schedules/view`

**Query params**
- `locationId` (required)
- `date` (required, `YYYY-MM-DD`, interpreted by backend in location timezone)
- `resourceType` (optional)
- `resourceId` (optional)
- `includeAvailabilityOverlay` (optional boolean)
- `range` (optional: `LOCATION_HOURS|FULL_DAY`)

**Success (200)**
- Body matches `ScheduleView` JSON shape (see backend reference).

### Create/update calls
- none

### Submit/transition calls
- none

### Error handling expectations
- Map HTTP statuses:
  - 400 â†’ show validation error banner; keep prior successful data visible if available
  - 403/404 â†’ show blocking empty state
  - 5xx/timeouts â†’ show retry option; do not clear prior successful data automatically
- If response is 200 with `warnings` including HR overlay issues:
  - treat as **non-blocking**; display warning banner but render schedule

---

## 10. State Model & Transitions

### Allowed states (screen-level)
- `idle` (no request yet; missing required filters)
- `loading` (in-flight request)
- `loaded` (rendering schedule)
- `error` (request failed; may still show last known good schedule)

### Role-based transitions
- Dispatcher can access screen; backend ultimately enforces.
- If user lacks permission for a location: transition to `error` with 403 messaging and disable schedule rendering.

### UI behavior per state
- `idle`: prompt user to select location and date.
- `loading`: show skeleton/loader; prevent duplicate fetches.
- `loaded`: show resources and events; allow filter adjustments.
- `error`: show error banner + retry; if last good data exists, keep it visible with â€œstaleâ€ indicator.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing location/date:
  - Do not call API; show inline prompt.
- Invalid enum selection (resourceType/range):
  - Prevent selection in UI by using fixed option lists; if backend returns 400 anyway, show error.

### Concurrency conflicts
- Not applicable (read-only). If user changes filters quickly:
  - Cancel prior request or ignore out-of-order responses (latest-wins).

### Unauthorized access
- On 403:
  - Render empty state with permission message
  - Keep filters visible so user can switch locations (if allowed)

### Empty states
- `resources[]` empty:
  - â€œNo schedulable resources found for this location/date.â€
- Resources exist but all `events[]` empty:
  - â€œNo scheduled events in the selected window.â€
- Conflicts none:
  - No special banner; conflict markers absent.

---

## 12. Acceptance Criteria

### Scenario 1: View daily schedule for a location
**Given** I am an authenticated Dispatcher  
**And** I have access to location `<locationId>`  
**When** I open the Daily Schedule screen for date `<date>` and location `<locationId>`  
**Then** the system requests `GET /api/v1/schedules/view?locationId=<locationId>&date=<date>`  
**And** I see a list of resources returned by the API  
**And** each resource shows its scheduled events within the returned `dayStartAt/dayEndAt` window.

### Scenario 2: Filter by resource type
**Given** I am viewing the daily schedule for a location and date  
**When** I select resourceType `BAY`  
**Then** the system reloads the schedule using `resourceType=BAY`  
**And** I only see resources of type `BAY` returned by the API.

### Scenario 3: Filter to a single resource
**Given** I am viewing the daily schedule for a location and date  
**And** the UI has a resource selector populated from the loaded resources  
**When** I select a specific resource `<resourceId>`  
**Then** the system reloads the schedule using `resourceId=<resourceId>`  
**And** I only see that one resource in the results.

### Scenario 4: Conflicts are clearly flagged with details
**Given** the API returns at least one event with `hasConflict=true` and `severity=BLOCKING`  
**When** I view the resourceâ€™s event list  
**Then** the conflicting event is visually flagged as a conflict  
**And** I can view the list of `conflictDetails.conflictingEventIds` for that event.

### Scenario 5: HR overlay failure is non-blocking
**Given** I enable â€œinclude availability overlayâ€  
**And** the API returns `200 OK` with `availabilityOverlayStatus=UNAVAILABLE` and `warnings` containing `HR_SYSTEM_UNAVAILABLE`  
**When** the schedule renders  
**Then** I see a non-blocking warning banner about HR availability  
**And** the schedule resources and events still render normally.

### Scenario 6: Unauthorized location access
**Given** I attempt to load a schedule for a location I am not authorized to view  
**When** the API responds with `403 Forbidden`  
**Then** the UI shows an access denied message  
**And** does not display schedule data for that location  
**And** I can change filters and retry with another location.

### Scenario 7: Performance expectation (frontend observable)
**Given** I load the schedule for a single location/day without overlay  
**When** the API responds successfully  
**Then** the UI renders the schedule view without unnecessary additional API calls  
**And** the UI records/prints the measured load time in client logs/telemetry (if enabled by project conventions).

---

## 13. Audit & Observability

### User-visible audit data
- Display (optional) `viewGeneratedAt` as â€œLast refreshed at â€¦â€ for dispatcher confidence.

### Status history
- Not applicable (read-only schedule view). No state transitions persisted by frontend.

### Traceability expectations
- Frontend should include correlation/request ID headers if already standardized in the project.
- Log client-side errors with:
  - locationId, date, resourceType/resourceId, overlay flag, range
  - HTTP status / error type

---

## 14. Non-Functional UI Requirements

- **Performance:** Avoid N+1 frontend calls; only call schedule endpoint per filter change (debounced). Use request cancellation or latest-wins to prevent UI thrash.
- **Accessibility:** All filter controls keyboard-navigable; conflict indicators conveyed via text (not color-only). Screen reader labels for severity and warnings.
- **Responsiveness:** Must work on tablet widths used in shop environments; resource lanes/list collapses appropriately (implementation-defined).
- **i18n/timezone:** Display times in the **locationâ€™s timezone** if available in frontend context; otherwise display in userâ€™s local timezone but clearly indicate timezone used. Do not change backend UTC handling.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATES: Provide explicit empty states for â€œno resourcesâ€ and â€œno eventsâ€; qualifies as safe because it changes only presentation, not domain logic. Impacted sections: UX Summary, Alternate/Empty States, Acceptance Criteria.
- SD-UX-DEBOUNCE-LATEST-WINS: Debounce filter-triggered loads and ignore out-of-order responses; qualifies as safe because it prevents duplicate reads without altering business rules. Impacted sections: Functional Behavior, Error Flows, Non-Functional.
- SD-ERR-HTTP-STATUS-MAP: Standard mapping of 400/403/404/5xx to user messages; qualifies as safe because it follows backend contract and affects only UI messaging. Impacted sections: Business Rules, Service Contracts, Error Flows.

---

## 16. Open Questions
1. Are **PERSON** resources supported in the frontend for v1, or should the UI only offer `BAY` and `MOBILE_TECHNICIAN` until confirmed by backend capabilities?
2. What is the canonical **location selector** source in this frontend (existing screen/component/service), and what identifier type is used for `locationId` (string vs numeric)?
3. Does the backend return (or does frontend already know) the **location timezone** needed to display times correctly? If not, should UI display UTC or user-local time with a timezone label?
4. Are there established Moqui screen naming/routing conventions for Scheduling modules in this repo (e.g., base path `/scheduling/*`), or should this story define the route?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Scheduling: View Schedule by Location and Resource â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/138

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Scheduling: View Schedule by Location and Resource  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/138  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Scheduling: View Schedule by Location and Resource

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As a **Dispatcher**, I want a daily schedule view by location/bay/mobile so that I can manage capacity and avoid conflicts.

## Details  
- Views: location calendar, bay lanes, mobile list.  
- Conflict highlighting and filters.

## Acceptance Criteria  
- Filter by date/location/resource.  
- Conflicts flagged.  
- Loads within SLA.

## Integrations  
- Optional HR availability overlay.

## Data / Entities  
- ScheduleView(read model), ConflictFlag

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Shop Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

END BACKEND REFERENCES

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #139: [FRONTEND] [STORY] Scheduling: Create Appointment with CRM Customer and Vehicle  
File: ./scripts/story-work/frontend/139/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

STOP: Clarification required before finalization

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Scheduling: Create Appointment with CRM Customer and Vehicle (Moqui Screens)

## Primary Persona
Service Advisor

## Business Value
Enable service advisors to schedule work with verified customer/vehicle context from CRM and persist an immutable snapshot for accurate downstream execution, billing context, and auditability.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor  
- **I want** to create a new appointment by selecting an existing CRM customer and one of their vehicles, then specifying requested services and a scheduled time window  
- **So that** the shop has reliable, validated context for future work and communications, even if CRM data changes later.

## In-Scope
- Frontend flow to **create** an Appointment in `SCHEDULED` status (draft creation is out of scope per backend reference).
- CRM-backed lookup/selection of:
  - `crmCustomerId`
  - `crmVehicleId` (validated association)
- Capture and submit appointment details:
  - time window (`startAt`, `endAt`)
  - requested service(s)
  - notes (optional)
  - contact hints (captured if supported by API; otherwise excluded and flagged)
- Display creation success and navigate to the created appointment detail view (or confirmation state).
- Moqui screen/form implementation consistent with project conventions.

## Out-of-Scope
- Appointment rescheduling/cancellation flows.
- Editing an appointment after creation.
- Draft appointment creation (explicitly out of scope in backend story).
- Notification delivery mechanics for `AppointmentCreated` (backend responsibility).
- Defining permissions/roles beyond enforcing â€œmust be authorizedâ€ error handling.

---

# 3. Actors & Stakeholders
- **Primary Actor:** Service Advisor (frontend user)
- **Systems:**
  - **Workexec backend**: System of Record for Appointment lifecycle and creation.
  - **CRM system**: System of Record for customer/vehicle identity and association; used for validation/selection.
- **Stakeholders/Consumers:** Work order execution, billing, analytics/reporting (consume AppointmentCreated event indirectly).

---

# 4. Preconditions & Dependencies
## Preconditions
- User is authenticated in the POS frontend and has access to Scheduling features.
- Backend endpoints for appointment creation and CRM lookup/validation are reachable.

## Dependencies
- Backend story reference indicates required behavior (validate CRM IDs; create `SCHEDULED`; snapshot immutable; emit event).
- **Blocking dependency (clarification):** exact frontend-to-backend API routes for CRM lookup and appointment create are not provided in the frontend issue body.

---

# 5. UX Summary (Moqui-Oriented)

## Entry Points
- Global navigation: `Scheduling â†’ Appointments â†’ Create`
- Optional contextual entry: `Customer â†’ Appointments â†’ Create` (only if existing navigation exists; otherwise not implemented)

## Screens to Create/Modify
### New Screens
1. `apps/pos/scheduling/AppointmentCreate.xml` (or project-standard location)
   - Single page wizard-like form (can be one screen with sections)
2. `apps/pos/scheduling/AppointmentDetail.xml`
   - Minimal detail display for post-create confirmation (if an existing detail screen doesnâ€™t already exist)

### Modified Screens (if already present)
- `AppointmentsList` screen: add â€œCreate Appointmentâ€ action linking to create screen.

## Navigation Context
- Breadcrumb: `Scheduling / Appointments / Create`
- After successful creation: redirect to `AppointmentDetail?appointmentId=<id>` (or list with toast + highlight)

## User Workflows
### Happy Path
1. Service Advisor opens **Create Appointment**.
2. Searches and selects **CRM Customer**.
3. Selects **CRM Vehicle** (filtered by selected customer).
4. Adds **one or more requested services**.
5. Sets **startAt** and **endAt**.
6. Optionally adds notes.
7. Submits; sees success; navigates to appointment detail.

### Alternate Paths
- User changes customer after selecting a vehicle â†’ vehicle selection is cleared and must be reselected.
- CRM returns no results â†’ show empty state and guidance.
- Submit blocked due to validation errors (missing fields, invalid time range).

---

# 6. Functional Behavior

## Triggers
- User clicks â€œCreate Appointmentâ€ entry point.
- User types in customer search input.
- User selects customer â†’ triggers vehicle list load.
- User submits create form.

## UI Actions
- Customer lookup component:
  - search text input
  - results list
  - select action sets `crmCustomerId` + displays snapshot preview (name/phone/email if returned)
- Vehicle selection component:
  - disabled until customer selected
  - list filtered by `crmCustomerId`
  - select sets `crmVehicleId` + displays vehicle preview (year/make/model/vin/licensePlate if returned)
- Service request entry:
  - Add/remove â€œrequested serviceâ€ rows
  - Each row has `description` (free text) unless catalog-backed service selection is supported (not specified)
- Date/time inputs:
  - `startAt` and `endAt` required
- Notes:
  - optional free text

## State Changes (Frontend)
- Local form state transitions:
  - `idle â†’ editing â†’ submitting â†’ success|error`
- No local â€œdraft appointmentâ€ persistence (out of scope)

## Service Interactions
- CRM search/list calls for customers and vehicles (contract unknown; see Open Questions).
- Create appointment call (must return `201` and `appointmentId` on success per backend story reference).
- Handle specific error codes: `CUSTOMER_NOT_FOUND`, `VEHICLE_NOT_FOUND`, `VEHICLE_CUSTOMER_MISMATCH`.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation (client-side, before submit)
- `crmCustomerId` is required.
- `crmVehicleId` is required.
- At least **1** requested service is required.
- `startAt` and `endAt` required.
- `endAt` must be after `startAt`.
- Notes optional.
- Do **not** attempt to compute or display backend snapshots; backend owns immutable snapshot creation.

## Enable/Disable Rules
- Vehicle selector disabled until customer selected.
- Submit button disabled while:
  - submitting, or
  - required fields missing, or
  - invalid time range.

## Visibility Rules
- Show selected customer and vehicle preview panels after selection.
- Show inline validation errors per field after blur or on submit attempt.

## Error Messaging Expectations
Map backend outcomes to user-readable messages:
- `404 CUSTOMER_NOT_FOUND`: â€œSelected customer no longer exists in CRM. Please re-search and select again.â€
- `404 VEHICLE_NOT_FOUND`: â€œSelected vehicle no longer exists in CRM. Please re-select a vehicle.â€
- `409 VEHICLE_CUSTOMER_MISMATCH`: â€œThat vehicle is not associated with the selected customer. Please choose a different vehicle.â€
- `503`: â€œCRM is temporarily unavailable. Try again later.â€
- Generic 400 validation: show field-level messages when possible; otherwise show summary banner.

---

# 8. Data Requirements

## Entities Involved (Frontend View Models)
- **Appointment (create request)**
- **AppointmentServiceRequest (create request line items)**
- **CRM Customer (read-only lookup)**
- **CRM Vehicle (read-only lookup)**

## Fields
### Appointment (Create)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| crmCustomerId | string/uuid | yes | none | Selected from CRM |
| crmVehicleId | string/uuid | yes | none | Selected from CRM (must belong to customer) |
| startAt | datetime (ISO-8601) | yes | none | Send in UTC or with offset (clarify) |
| endAt | datetime (ISO-8601) | yes | none | Must be after startAt |
| notes | string | no | empty | Free text |
| contactHints | object/string | unclear | none | Mentioned in original story; backend contract not specified |

### AppointmentServiceRequest (Create)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| description | string | yes | none | At least 1 row required |

## Read-only vs Editable
- CRM customer/vehicle fields are read-only previews.
- All create fields are editable until submit.

## Derived/Calculated Fields
- `durationMinutes` can be computed client-side for display only (do not send unless API expects it).

---

# 9. Service Contracts (Frontend Perspective)

> Backend API shapes are partially known from the backend reference, but exact URLs for CRM lookup are not provided in the frontend inputs. Contracts below define the minimum needed; unknowns are flagged.

## Load/View Calls
1. **Search CRM Customers**
   - **Purpose:** find customers to select
   - **Endpoint:** **TBD** (Open Question)
   - **Request:** query string `q` (search term), pagination optional
   - **Response:** list of customers with at least `crmCustomerId` + display fields

2. **List Vehicles for CRM Customer**
   - **Purpose:** select a vehicle associated with customer
   - **Endpoint:** **TBD** (Open Question)
   - **Request:** `crmCustomerId`
   - **Response:** list of vehicles with at least `crmVehicleId` + display fields

## Create/Update Calls
1. **Create Appointment**
   - **Endpoint:** **TBD** (backend reference does not provide exact path)
   - **Method:** `POST`
   - **Request body (minimum):**
     ```json
     {
       "crmCustomerId": "string",
       "crmVehicleId": "string",
       "startAt": "2026-01-18T15:00:00Z",
       "endAt": "2026-01-18T16:00:00Z",
       "notes": "string (optional)",
       "serviceRequests": [
         { "description": "Oil change" }
       ]
     }
     ```
   - **Success:** `201 Created` with:
     ```json
     { "appointmentId": "uuid-or-string" }
     ```

## Submit/Transition Calls
- None (creation results in `SCHEDULED` status directly per backend reference)

## Error Handling Expectations
- `400` validation errors: show field errors when returned as structured list; else show generic banner.
- `401/403`: show â€œYou are not authorizedâ€ and route user back to safe screen.
- `404` with codes above: handle as described in Business Rules.
- `409 VEHICLE_CUSTOMER_MISMATCH`: show specific message; keep user on form.
- `503`: show retry guidance; keep entered data intact.

---

# 10. State Model & Transitions

## Allowed States (Appointment)
- `SCHEDULED` is the initial and only state relevant for this story (created appointments must be scheduled).
- `DRAFT` creation is out of scope (even though original prompt mentioned Draft/Scheduled).

## Role-based Transitions
- Not defined here; creation requires authorization. Any further transitions not part of this story.

## UI Behavior per State
- N/A for create flow; after creation, detail screen should display status `SCHEDULED` prominently as read-only field.

---

# 11. Alternate / Error Flows

## Validation Failures (client-side)
- Missing required fields â†’ inline errors; prevent submit.
- endAt <= startAt â†’ inline error on endAt; prevent submit.

## Backend Validation Failures (400)
- Backend rejects payload â†’ show banner â€œUnable to create appointmentâ€ + show any returned field errors; keep form data.

## Concurrency Conflicts
- Not expected for create; if backend returns `409` for scheduling conflict (not specified), show generic conflict banner and keep data (Open Question: do we need conflict handling?).

## Unauthorized Access
- `401`: redirect to login.
- `403`: show access denied and hide submit.

## Empty States
- Customer search returns none â†’ â€œNo customers found. Refine your search.â€
- Vehicle list empty for selected customer â†’ â€œNo vehicles found for this customer.â€

---

# 12. Acceptance Criteria

## Scenario 1: Create Scheduled Appointment (Happy Path)
**Given** CRM is available  
**And** the Service Advisor is authenticated and authorized  
**And** a CRM customer exists  
**And** a CRM vehicle exists and is associated with that customer  
**When** the user selects the customer and vehicle  
**And** enters at least one requested service description  
**And** enters a valid start and end time  
**And** submits the form  
**Then** the system sends a create request with `crmCustomerId`, `crmVehicleId`, `startAt`, `endAt`, and service requests  
**And** receives `201 Created` with an `appointmentId`  
**And** navigates to Appointment Detail (or shows confirmation) for that `appointmentId`  
**And** the status displayed is `SCHEDULED`.

## Scenario 2: Vehicle Not Associated with Customer
**Given** CRM is available  
**And** the user selected a customer  
**When** the user attempts to submit with a vehicle that is not associated to that customer  
**And** the backend returns `409 Conflict` with error code `VEHICLE_CUSTOMER_MISMATCH`  
**Then** the UI shows a blocking error message explaining the mismatch  
**And** the appointment is not created  
**And** the user remains on the create form with previously entered fields intact.

## Scenario 3: CRM Unavailable During Create
**Given** CRM is unavailable  
**When** the user submits the create form  
**And** the backend returns `503 Service Unavailable`  
**Then** the UI shows â€œCRM is temporarily unavailable. Try again later.â€  
**And** the appointment is not created  
**And** the form data remains intact for retry.

## Scenario 4: Customer Not Found
**Given** CRM is available  
**When** the user submits with a `crmCustomerId` that no longer exists  
**And** the backend returns `404` with error `CUSTOMER_NOT_FOUND`  
**Then** the UI shows an error instructing the user to re-search/select a customer  
**And** clears the selected customer and vehicle fields (to avoid invalid references).

## Scenario 5: Client-side Validation Prevents Submit
**Given** the Create Appointment screen is open  
**When** the user has not selected a customer, vehicle, or has not added any requested services  
**Or** the end time is not after start time  
**Then** the Submit button is disabled (or submit shows inline errors)  
**And** no API create call is made.

---

# 13. Audit & Observability

## User-visible audit data
- On Appointment Detail, show:
  - created timestamp (from response if provided; otherwise loaded via detail endpointâ€”TBD)
  - created by (if available)
- If these fields are not available via API, omit and track as Open Question (do not invent).

## Status history
- Not required for creation-only story; no UI for state transitions.

## Traceability expectations
- Frontend must include correlation/request ID headers if project standard supports it (Moqui often supports request tracking). If not defined, rely on backend logging.
- Log frontend errors in console (dev) and use standard error banner for user.

---

# 14. Non-Functional UI Requirements

## Performance
- Customer search should debounce input (e.g., 250â€“400ms) to avoid excessive calls.
- Vehicle list should load once per customer selection and cache in-memory for the current form session.

## Accessibility
- All form controls labeled.
- Error messages associated to inputs.
- Keyboard navigable selection lists.

## Responsiveness
- Works on tablet-width layouts (common in service desk).

## i18n/timezone/currency
- Date/time entry and display must respect store/user timezone (clarify how timezone is determined) and send ISO timestamps per API expectation.

---

# 15. Applied Safe Defaults
- **SD-UX-SEARCH-DEBOUNCE**: Debounce CRM search input by ~300ms to reduce calls; safe UI ergonomics choice. Impacted sections: UX Summary, Functional Behavior, Non-Functional.
- **SD-UX-EMPTY-STATES**: Provide explicit empty-state messages for no results; safe UI ergonomics choice. Impacted sections: UX Summary, Alternate / Error Flows.
- **SD-ERR-STANDARD-BANNER**: Use standard error banner + inline field errors when available; safe mapping of backend errors to UX without changing business rules. Impacted sections: Business Rules, Error Flows, Acceptance Criteria.

---

# 16. Open Questions

1. **What are the exact API endpoints for CRM customer search and customer vehicle listing** used by the Moqui frontend (paths, query params, response shapes)?
2. **What is the exact appointment creation endpoint/path** in the Moqui backend layer (or gateway) for creating an appointment (method, path, request/response schema)?
3. **Timezone contract:** should `startAt`/`endAt` be sent in UTC (`Z`) always, or with local offset? How is the store/user timezone determined in the frontend?
4. **Requested services structure:** are service requests free-text `description` only, or should the UI select from a catalog (service IDs/codes)? If IDs are required, provide endpoint/lookup.
5. **â€œContact hintsâ€ field:** is there a supported field in the create API for contact hints (preferred contact method, best phone, etc.)? If yes, specify shape and validation.
6. **Post-create navigation:** is there an existing Appointment Detail screen/route naming convention we must use, or should this story add a new detail screen?
7. **Do we need to handle schedule conflicts** (e.g., overlapping appointments) with a defined backend error code? If yes, what is the error code and expected UX?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Scheduling: Create Appointment with CRM Customer and Vehicle  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/139  
Labels: frontend, story-implementation, payment  

## Frontend Implementation for Story

**Original Story**: [STORY] Scheduling: Create Appointment with CRM Customer and Vehicle

**Domain**: payment

### Story Description

/kiro
# User Story
## Narrative
As a **Service Advisor**, I want to create an appointment selecting customer and vehicle from durion-crm so that the shop has accurate context for service and billing.

## Details
- Capture: crmCustomerId, crmVehicleId, requested services, notes, preferred time window, contact hints.

## Acceptance Criteria
- Appointment created with status Draft/Scheduled.
- Customer/vehicle references validated.
- Audited.

## Integrations
- CRM lookup/snapshot.
- Optional AppointmentCreated event.

## Data / Entities
- Appointment, AppointmentServiceRequest, CRM references

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Shop Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #145: [FRONTEND] [STORY] Integration: Submit Job Time to workexec as Labor Performed (Idempotent)  
File: ./scripts/story-work/frontend/145/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Submit Job Time (TimeEntry) as Labor Performed (Idempotent)

### Primary Persona
Mechanic / Technician (primary), with system-integration behavior initiated from the POS UI context.

### Business Value
Ensure technician labor is recorded in `workexec` accurately and without duplication, with clear, actionable failures when the Work Order state prevents labor postingâ€”supporting correct execution tracking and downstream billing readiness.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Mechanic/Technician  
- **I want** my finalized job time (TimeEntry) submitted to Work Execution (`workexec`) as `LaborPerformed` in an idempotent way  
- **So that** labor performed lines are created/updated accurately without duplication, and I receive stable error feedback when submission is disallowed.

### In Scope
- Frontend UI flow to **initiate** (or re-initiate) submission of a TimeEntry to workexec.
- Frontend display of **submission status**, and **stable error codes**/messages returned by the integration.
- Idempotency behavior at the UI level: repeated â€œSubmitâ€ actions do not create duplicates; UI handles â€œreplayedâ€ success.
- Audit/traceability display elements (workOrder reference; correlation/idempotency key surfaced where appropriate).
- Moqui screens/forms/transitions wiring to a Moqui service that performs the POST to workexec.

### Out of Scope
- Authoring or editing TimeEntry time capture itself (People/Job-Time domain).
- Implementing the backend `workexec` endpoint (already referenced).
- Defining new Work Order state machine states (must follow workexec backend).
- Payroll/billing calculation rules based on labor time (explicitly not assumed).

---

## 3. Actors & Stakeholders
- **Mechanic/Technician (UI user):** initiates submit/retry and needs clear status.
- **Service Advisor (stakeholder):** needs confidence labor is recorded; may help resolve conflicts.
- **Workexec system (`pos-workexec`):** system of record for Work Orders and Labor Performed.
- **People/Job-Time system (upstream):** source of TimeEntry, provides `timeEntryId`, `workOrderId`, `technicianId`, time quantities.

---

## 4. Preconditions & Dependencies
- A `TimeEntry` exists and is eligible for submission (backend reference says â€œFINALIZEDâ€ is the trigger).
- Frontend can access:
  - `timeEntryId`
  - associated `workOrderId`
  - `technicianId`
  - `performedAt` timestamp
  - labor quantity in hours (decimal)
- Workexec endpoint is reachable:
  - `POST /api/workexec/labor-performed`
- Workexec supports idempotency:
  - Request header `Idempotency-Key: <timeEntryId>`
  - Returns `201 Created` on first success
  - Returns `200 OK` with header `Idempotency-Replayed: true` on replay success
  - Returns `409 Conflict` for terminal business conflict (e.g., work order state blocks)

**Dependency note:** This frontend story depends on an existing/available UI context where a technician can view a TimeEntry and submit it, or an integration queue UI. That context is not defined in the provided inputs (see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
At least one entry point must exist (to be confirmed):
1. From a **Time Entry detail** screen: â€œSubmit to Work Orderâ€ action.
2. From a **My Time Entries** list: bulk or per-row â€œSubmitâ€ / â€œRetryâ€.
3. From an **Integration/Outbox** admin screen: view failures and retry (if such UI exists).

### Screens to create/modify
- **Create/Modify**: `TimeEntryDetail` (or equivalent) screen to add:
  - submission status panel
  - submit/retry button
  - last attempt result (success/replayed/error code)
- **Optional** (if project has integration queue UI): `IntegrationSubmissionList` for failed submissions.

> Exact screen names/paths must match repo conventions; not provided here (blocking clarification).

### Navigation context
- Standard Moqui screen with transitions:
  - `transition submitLaborPerformed`
  - on success, refresh same screen with updated status
  - on error, show message + persist/display error details

### User workflows
**Happy path**
1. Mechanic opens a finalized TimeEntry.
2. Clicks â€œSubmit to Work Orderâ€.
3. UI shows in-progress state.
4. On `201` or `200 replay`, UI shows â€œSubmittedâ€ with workexec reference (if returned).

**Alternate paths**
- Mechanic clicks submit twice â†’ second call returns replay success; UI shows â€œAlready submittedâ€ (still success).
- Work order state blocks submission â†’ UI shows non-retriable failure with stable error code.
- Network/5xx transient errors â†’ UI indicates â€œTemporary failure, try againâ€ (UI-level retry only; no assumptions about background retry).

---

## 6. Functional Behavior

### Triggers
- User action: click â€œSubmit to Workexecâ€ / â€œRetry submissionâ€.

### UI actions
- Disable submit button while request is in-flight.
- On completion:
  - Success: show success banner + update status.
  - Replay success: show success banner noting already submitted (no duplication).
  - Failure: show error banner with stable error code + guidance.

### State changes (frontend-local)
- Store/display a local submission state for the TimeEntry view model:
  - `NOT_SUBMITTED` | `SUBMITTING` | `SUBMITTED` | `FAILED`
- Persisting these statuses requires a frontend-accessible store/entity or backend endpoint; not defined in inputs (blocking clarification). If not persisted, at minimum show last response in-session.

### Service interactions
- Moqui service call from screen transition invokes HTTP POST to:
  - `POST /api/workexec/labor-performed`
- Must include headers:
  - `Idempotency-Key = timeEntryId`
  - `Content-Type = application/json`
  - `X-Correlation-Id` if available (generate if missing)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
Before allowing submit, UI must validate presence of required fields:
- `timeEntryId` present
- `workOrderId` present
- `technicianId` present
- `performedAt` present and ISO-8601 serializable
- `labor.quantity` > 0
- `labor.unit` fixed to `HOURS`

If missing, block submission and show inline error: â€œCannot submit: missing required time entry fields: â€¦â€

### Enable/disable rules
- Submit button enabled only when:
  - TimeEntry is in eligible state (expected `FINALIZED`) **(needs confirmation from frontend-accessible field)**.
- Submit button disabled when:
  - request in-flight
  - TimeEntry is clearly not eligible (not finalized)

### Visibility rules
- Show â€œSubmission Resultâ€ panel if any submission attempt has been made (or if backend provides submission status).

### Error messaging expectations
- For `409` workexec conflict: show stable error code (e.g., `WORKEXEC_CONFLICT_WORKORDER_STATE`) and guidance: â€œWork order is not accepting labor in its current state.â€
- For `401/403`: show â€œNot authorized to submit labor performed.â€
- For `404`: show â€œWork order not found in workexec.â€
- For `422/400`: show validation failure details (field-level if provided).
- For `5xx/timeout`: show â€œTemporary failure; please retry.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `TimeEntry` (source)
- `LaborPerformed` (workexec target; likely not stored locally in POS frontend)
- Optional: local â€œsubmission recordâ€ entity (if system tracks attempts)

### Fields
**TimeEntry (read)**
- `timeEntryId` (string/uuid, required)
- `workOrderId` (string/uuid, required)
- `technicianId` (string/uuid, required)
- `performedAt` (datetime, required)
- `quantityHours` (decimal, required, > 0)
- `status` (enum; must indicate finalized/eligible)

**Submission payload (derived)**
- `labor.unit` = `"HOURS"` (constant)
- `source.system` = `"people"` (constant per backend reference)
- `source.sourceReferenceId` = `timeEntryId` (derived)

### Read-only vs editable
- All fields used for submission are read-only on this screen (submission action only).
- If any are editable today, this story does not change edit behavior.

### Derived/calculated fields
- None beyond payload mapping.

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls
- Load TimeEntry details (existing service/screen load). **Contract not provided**.
- Optional: load current submission status (if tracked). **Contract not provided**.

### Create/update calls (submission)
**Service:** `POST /api/workexec/labor-performed`  
**Headers:**
- `Idempotency-Key: <timeEntryId>` (required)
- `Content-Type: application/json`
- `X-Correlation-Id: <uuid>` (optional but recommended)

**Request body:**
```json
{
  "workOrderId": "uuid",
  "technicianId": "uuid",
  "performedAt": "2026-01-15T17:30:00Z",
  "labor": { "quantity": 1.50, "unit": "HOURS" },
  "source": { "system": "people", "sourceReferenceId": "uuid" }
}
```

**Success responses:**
- `201 Created` (new)
- `200 OK` with `Idempotency-Replayed: true` (replay, treat as success)

**Error handling expectations:**
- `409 Conflict`: terminal, show stable workexec error code; do not auto-retry in UI.
- `400/422`: show validation message(s).
- `401/403`: show authorization error.
- `404`: show not found.
- `408/429/5xx`: show transient error + allow user retry.

> Stable error envelope fields are not specified in the provided frontend inputs; must be clarified (see Open Questions).

---

## 10. State Model & Transitions

### Allowed states (relevant subset)
Work Order states that may block submission are specified by backend reference:
- `CANCELLED`, `CLOSED`, `INVOICED`, `VOIDED`, `ARCHIVED`
- `ON_HOLD`, `LOCKED_FOR_REVIEW`
- `COMPLETED` (unless reopened)
Allowed again when reopened/active (e.g., `REOPENED` or other active states).

### Role-based transitions
- Only authenticated users can submit.
- Mechanic role expected to be allowed, but exact permission/role mapping is not provided (blocking clarification; do not assume).

### UI behavior per state
- If workexec returns conflict due to blocked state:
  - UI marks submission as `FAILED (terminal)` and disables further retries unless user explicitly retries (still would fail) and/or state changes.
- If replay success:
  - UI shows `SUBMITTED` and disables submit (or changes button to â€œRe-submit (idempotent)â€ based on product decisionâ€”needs clarification).

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing required ids or quantity <= 0:
  - block submit, show inline validation.

### Workexec rejects due to work order state (409)
- Show code + message
- Provide link/navigation to Work Order detail (if exists) for state review.

### Concurrency conflicts / duplicate clicks
- Double-submit results in replay; treat as success.
- Ensure UI prevents multiple simultaneous posts by disabling button during in-flight.

### Unauthorized access
- If `401/403`, display and do not retry automatically.

### Empty states
- If TimeEntry cannot be loaded, show standard â€œNot foundâ€ state.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Submit labor performed successfully (first time)
**Given** I am viewing a TimeEntry with status `FINALIZED` and it has `timeEntryId`, `workOrderId`, `technicianId`, `performedAt`, and a positive hours quantity  
**When** I click â€œSubmit to Workexecâ€  
**Then** the system sends `POST /api/workexec/labor-performed` with header `Idempotency-Key = timeEntryId`  
**And** the request body maps the time entry to the labor-performed schema (unit `HOURS`, source.system `people`, sourceReferenceId = timeEntryId)  
**And** when workexec returns `201 Created`, the UI shows status `SUBMITTED`.

### Scenario 2: Idempotent replay is treated as success
**Given** a TimeEntry has already been submitted previously using `Idempotency-Key = timeEntryId`  
**When** I click â€œSubmit to Workexecâ€ again  
**Then** if workexec returns `200 OK` with header `Idempotency-Replayed: true`  
**Then** the UI displays success and does not indicate a duplicate was created  
**And** the UI state remains `SUBMITTED`.

### Scenario 3: Work order state blocks submission (terminal conflict)
**Given** I attempt to submit labor for a TimeEntry whose Work Order is in a blocking state in workexec  
**When** workexec responds `409 Conflict` with a stable error code indicating work order state conflict  
**Then** the UI shows an actionable error message including the stable error code  
**And** the UI marks the submission as failed (terminal) for that attempt  
**And** the UI does not automatically retry.

### Scenario 4: Transient failure allows manual retry
**Given** I attempt to submit labor for a valid TimeEntry  
**When** workexec responds with `503 Service Unavailable` (or the request times out)  
**Then** the UI shows a transient error message  
**And** provides an enabled â€œRetryâ€ action once the request is no longer in-flight.

### Scenario 5: Client-side validation prevents invalid submission
**Given** I am viewing a TimeEntry missing `workOrderId` (or hours quantity is `0`)  
**When** I click â€œSubmit to Workexecâ€  
**Then** the UI prevents the request from being sent  
**And** displays a validation error indicating which required field(s) are missing/invalid.

---

## 13. Audit & Observability
- UI should display (or make available in logs):
  - `timeEntryId` (idempotency key)
  - `workOrderId`
  - correlation id used (`X-Correlation-Id`) if generated
- Each submission attempt should be traceable in Moqui logs with:
  - correlation id
  - HTTP status code
  - workexec error code (if present)
- User-visible: show â€œLast attempted atâ€ timestamp (requires persistence; otherwise omit).

---

## 14. Non-Functional UI Requirements
- **Performance:** Submission action should return control within a reasonable time; show spinner/loading state while waiting.
- **Accessibility:** Buttons and status messages must be screen-reader friendly; errors announced (ARIA live region).
- **Responsiveness:** Works on tablet-sized UI (shop floor).
- **i18n:** Error messages should be localizable; do not hardcode long prose in service layer.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty/not-found state messaging for missing TimeEntry data; qualifies as safe because it does not affect business policy, only presentation. Impacted sections: UX Summary, Alternate/Error Flows.
- SD-UX-INFLIGHT-DISABLE: Disable submit button while request is in-flight to prevent accidental double posts; qualifies as safe because idempotency already exists and this only improves ergonomics. Impacted sections: Functional Behavior, Alternate/Error Flows.
- SD-ERR-TRANSIENT-RETRY-MANUAL: Treat 408/429/5xx/timeouts as transient and allow *manual* retry from UI; qualifies as safe because it does not introduce automated domain side effects and mirrors common HTTP semantics. Impacted sections: Service Contracts, Alternate/Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. **Where in the frontend does this action live?** What is the canonical screen route/name for TimeEntry list/detail in this Moqui frontend repo (so we can specify the exact screen(s) to modify)?
2. **What is the frontend-accessible TimeEntry contract?** Which endpoint/service loads TimeEntry details and what are the exact field names for: `id`, `status`, `workOrderId`, `technicianId`, `performedAt`, `hours quantity`?
3. **Should submission attempt status be persisted?** If yes, where (Moqui entity in this frontend app vs upstream People service), and what fields are required (lastStatusCode, lastErrorCode, lastAttemptAt, laborPerformedId)?
4. **What is the exact error envelope from workexec?** For non-2xx responses, what JSON fields contain the stable `workexecErrorCode` and message (e.g., `{code, message, details}`)? The ACs require â€œstable error codes,â€ but the response schema is unspecified in the provided frontend inputs.
5. **Authorization/permission expectation:** Which roles may invoke submission from UI (Mechanic only, or also Service Advisor/Admin)? Any feature flag?
6. **Post-success UX:** After `SUBMITTED`, should the button be hidden/disabled, or remain available as â€œRe-submit (idempotent)â€?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Integration: Submit Job Time to workexec as Labor Performed (Idempotent)  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/145  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Integration: Submit Job Time to workexec as Labor Performed (Idempotent)

**Domain**: user

### Story Description

/kiro  
# User Story

## Narrative
As a **Mechanic**, I want **to submit my job time to workexec** so that **labor performed lines are created/updated accurately**.

## Details
- Idempotent posting using timeEntryId as reference.
- Reject with actionable errors when workorder state disallows.

## Acceptance Criteria
- Posting creates or updates labor-performed without duplication.
- Failures provide stable error codes.
- Audit includes workorder reference.

## Integration Points (workexec)
- Outbound: JobTimePosted event and/or API call.

## Data / Entities
- LaborPerformed (workexec)
- TimeEntry (job)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: People Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #146: [FRONTEND] [STORY] Integration: Start/Stop Timer Against Assigned Workorder Task â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/146
File: ./scripts/story-work/frontend/146/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Workexec: Start/Stop Job Timer for Assigned Work Order Task

## Primary Persona
Mechanic (Technician)

## Business Value
Accurate, audit-friendly labor time capture tied to a work order (and optionally a specific task/labor code), reducing manual calculations and improving downstream job costing/billing accuracy.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Mechanic  
- **I want** to start and stop a job timer for my assigned work order/task  
- **So that** the system records accurate time entries automatically and prevents overlapping timers unless allowed by policy.

## In-scope
- UI to **view active timer state** and recover after refresh/login.
- UI actions to **start** a timer (with workOrderId required; optional workOrderItemId and/or laborCode if available in the UI context).
- UI actions to **stop** timer(s) for the authenticated mechanic.
- Frontend handling of backend constraint errors (single active timer by default).
- Display of resulting time entry summary after start/stop.
- Basic audit visibility (who/when) where returned by API.

## Out-of-scope
- Timer **pause/break handling**.
- Manual editing/adjustment of completed/auto-stopped time entries.
- Creating/assigning work orders or tasks.
- Clock-in/clock-out UI and the actual auto-stop jobs (handled by backend/system).
- Defining policy values/roles (concurrent timers configuration and permissions).

---

# 3. Actors & Stakeholders
- **Mechanic (Primary)**: starts/stops timers while working.
- **Service Advisor (Stakeholder)**: reviews time captured for billing accuracy (read-only impact).
- **System/Backend**: enforces assignment and timer constraints; creates immutable time entries.
- **Audit/Reporting (Downstream)**: consumes timer events/time entry records.

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in POS frontend.
- User is a Mechanic (or otherwise authorized to use timers).
- Work order exists and is in a â€œworkableâ€ state per backend (default mentioned: `IN_PROGRESS`).
- Mechanic is assigned to the work order (and to the item if item-level timing is used).

## Dependencies
- Backend endpoints available (from backend story #82):
  - `GET /api/workexec/time-entries/timer/active`
  - `POST /api/workexec/time-entries/timer/start`
  - `POST /api/workexec/time-entries/timer/stop`
- Work order/task context available in the UI (e.g., WorkOrderAssigned event or work order detail screen) to provide:
  - `workOrderId` (required)
  - `workOrderItemId` (optional)
  - `laborCode` (optional)
- Moqui security session provides authenticated principal; frontend must not supply mechanicId.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From **Work Order Detail / Execution** screen for an assigned work order (primary).
- From a **Mechanic dashboard / My Work** screen showing assigned work orders (secondary).
- Global â€œActive Timerâ€ indicator (optional UI element) that links to timer details (see Open Questions).

## Screens to create/modify (Moqui)
1. **Modify**: `WorkOrderDetail` (or equivalent existing workexec screen)
   - Add a â€œTimerâ€ section with Start/Stop actions and current timer status.
2. **Create**: `TimerPanel` screenlet / embedded screen
   - Reusable component to display active timer and controls.
3. **Create** (optional but recommended for recovery): `MyActiveTimer` screen
   - Dedicated screen to show active timer(s) and allow stop.

> Note: Exact screen names/paths must follow repo conventions; implement as Moqui screens with transitions calling REST services.

## Navigation context
- Work order context provides `workOrderId`.
- If user navigates away and returns, UI must re-load active timer via `GET â€¦/active`.

## User workflows

### Happy path: start then stop (single-timer mode)
1. Mechanic opens assigned work order.
2. UI loads active timer(s).
3. Mechanic taps **Start Timer**.
4. UI shows timer running (start time; elapsed time increments client-side).
5. Mechanic taps **Stop Timer**.
6. UI confirms timer stopped and shows recorded duration.

### Alternate: start blocked due to existing active timer
1. Mechanic taps Start Timer while another timer is active.
2. UI shows error and offers to:
   - View active timer details (via GET active)
   - Stop active timer(s)

### Recovery: refresh/relogin while timer active
1. Mechanic reloads app.
2. UI calls GET active on entry and shows running timer state.

---

# 6. Functional Behavior

## Triggers
- Screen load / route enter for timer-capable screens triggers active timer load.
- User clicks Start Timer.
- User clicks Stop Timer.

## UI actions
- **On load**:
  - Call `GET /api/workexec/time-entries/timer/active`
  - Render:
    - No active timer: show Start controls enabled (subject to having workOrderId context)
    - Active timer(s): show Stop controls enabled; Start controls disabled unless backend/policy supports multiple timers (frontend must not assume; see error handling)
- **Start Timer click**:
  - Validate required inputs present in UI context:
    - `workOrderId` required
    - If `workOrderItemId` supplied, include it
    - If `laborCode` supplied, include it
  - Call `POST â€¦/start` with body `{ workOrderId, workOrderItemId, laborCode }`
  - On success, update UI to running state using response summary.
- **Stop Timer click**:
  - Call `POST â€¦/stop` with empty body
  - On success, update UI to not-running state and show stopped entries summary.

## State changes (frontend)
- Maintain a local timer view state:
  - `timerState = NONE | ACTIVE | STOPPING | STARTING | ERROR`
- When ACTIVE, show:
  - startTime from server
  - elapsed time computed from (now - startTime) using client clock (display only; server remains authoritative)

## Service interactions
- All calls include auth token/session.
- Use correlation/request ID propagation if the frontend stack supports it (see Observability).

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Start Timer is blocked client-side if:
  - `workOrderId` is missing from context.
- Do **not** attempt to provide `mechanicId` in requests (backend derives it).
- Do not allow â€œStopâ€ if UI already knows there is no active timer, but still handle server 409.

## Enable/disable rules
- If GET active returns at least one ACTIVE timer:
  - Disable Start (to align with default single-timer policy)
  - Enable Stop
- If GET active returns none:
  - Enable Start (if workOrderId present)
  - Disable Stop

> If concurrent timers are enabled by backend policy, the UI may still receive 201 for start even when an active timer exists; therefore the UI must rely on backend responses and handle 409 gracefully rather than assuming policy.

## Visibility rules
- When timer ACTIVE:
  - Show workOrder reference and (if present) item/laborCode from the active timer response.
- When timer stopped:
  - Show last stopped duration and timestamps from response.

## Error messaging expectations
Map backend errors to user-facing messages (no sensitive details):
- `409 TIMER_ALREADY_ACTIVE`: â€œYou already have an active timer. Stop it before starting a new one.â€
- `409 NO_ACTIVE_TIMER`: â€œNo active timer to stop.â€
- `403 Forbidden`: â€œYou donâ€™t have permission to use timers.â€
- `404 Not Found`: â€œWork order/task not available.â€
- `409 Conflict` (other): â€œTimer action cannot be completed due to current work order status or assignment.â€

---

# 8. Data Requirements

## Entities involved (frontend view models)
- **TimeEntry** (job)
- **TimeException** (read-only awareness if returned; not created by frontend)

## Fields (type, required, defaults)

### TimeEntry (as consumed by frontend)
- `timeEntryId` (string/uuid) â€” required
- `mechanicId` (string/uuid) â€” returned only; not sent
- `workOrderId` (string/uuid) â€” required
- `workOrderItemId` (string/uuid|null) â€” optional
- `laborCode` (string|null) â€” optional
- `startTime` (ISO-8601 UTC string) â€” required
- `endTime` (ISO-8601 UTC string|null) â€” present when stopped
- `durationInSeconds` (number|null) â€” present when stopped
- `status` (enum: `ACTIVE|COMPLETED|AUTO_STOPPED`) â€” required

### Active timer response (expected)
- Either:
  - single active timer object
  - or a list of active timers (to support concurrent mode)
Frontend must be tolerant (see Open Questions on schema).

## Read-only vs editable
- All displayed fields are read-only in this story.
- Only actions are start/stop.

## Derived/calculated fields
- `elapsedDisplaySeconds = nowClient - startTimeServer` (display only)
- `durationDisplay = format(durationInSeconds)` when stopped

---

# 9. Service Contracts (Frontend Perspective)

## Load/view calls
### Get active timer(s)
- **Method/Path:** `GET /api/workexec/time-entries/timer/active`
- **Request:** none
- **Success (200):** active timer info for authenticated mechanic
- **Empty:** returns empty list or null/empty payload meaning none active (must handle both)

## Create/update calls
### Start timer
- **Method/Path:** `POST /api/workexec/time-entries/timer/start`
- **Request body:**
  ```json
  {
    "workOrderId": "uuid",
    "workOrderItemId": "uuid|null",
    "laborCode": "string|null"
  }
  ```
- **Success (201):** created time entry summary (must include at least id, status, startTime, links)

### Stop timer(s)
- **Method/Path:** `POST /api/workexec/time-entries/timer/stop`
- **Request body:** none
- **Success (200):**
  ```json
  {
    "stopped": [ /* one or more TimeEntry summaries */ ]
  }
  ```
  In single-timer mode this will be one; in concurrent mode it may be multiple.

## Submit/transition calls
- None beyond start/stop.

## Error handling expectations
- `409 TIMER_ALREADY_ACTIVE`:
  - UI should refresh by calling `GET â€¦/active` and render the active timer.
- `409 NO_ACTIVE_TIMER`:
  - UI should refresh by calling `GET â€¦/active` and render none.
- Generic network/5xx:
  - Show non-technical error and allow retry; do not duplicate actions automatically.

---

# 10. State Model & Transitions

## Timer states (TimeEntry.status)
- `ACTIVE` â†’ `COMPLETED` via Stop action
- `ACTIVE` â†’ `AUTO_STOPPED` via system (clock-out/job); UI may discover via refresh
- `COMPLETED` / `AUTO_STOPPED` are immutable via this UI

## Role-based transitions
- Mechanic (authorized): may start/stop for self (identity derived from auth)
- Others: depending on backend permissions; frontend should rely on 403/404/409 handling and hide controls if role is clearly not mechanic (if role info exists in session; otherwise do not guess)

## UI behavior per state
- ACTIVE: show running timer and Stop button
- COMPLETED/AUTO_STOPPED (as last action result): show summary; Start enabled if no active timers remain

---

# 11. Alternate / Error Flows

## Validation failures (client)
- Missing `workOrderId` in context:
  - Disable Start, show message â€œSelect a work order to start a timer.â€

## Backend conflict: timer already active
- Start returns 409 `TIMER_ALREADY_ACTIVE`:
  - UI displays message + fetches active timers to show what is running.

## Backend conflict: stop when none active
- Stop returns 409 `NO_ACTIVE_TIMER`:
  - UI displays message + refreshes active timers (should show none).

## Concurrency conflicts
- Rapid double-click start/stop:
  - UI must disable the action button while request is in-flight.
- Two devices:
  - If a timer is started/stopped elsewhere, GET active refresh reflects server truth.

## Unauthorized access
- 403:
  - Hide Start/Stop controls for the session after first 403 and show a permission message.

## Empty states
- No active timer:
  - Show â€œNo active timerâ€ and Start available (with context).

---

# 12. Acceptance Criteria

### Scenario 1: Load screen shows no active timer
**Given** I am authenticated as a mechanic  
**And** I open an assigned work order screen with a valid `workOrderId`  
**When** the screen loads  
**Then** the app calls `GET /api/workexec/time-entries/timer/active`  
**And** if no active timer exists, the UI shows â€œNo active timerâ€  
**And** the â€œStart Timerâ€ action is enabled  
**And** the â€œStop Timerâ€ action is disabled.

### Scenario 2: Start timer creates an active time entry
**Given** I have no active timer  
**And** I am viewing a work order with `workOrderId=W1`  
**When** I click â€œStart Timerâ€  
**Then** the app calls `POST /api/workexec/time-entries/timer/start` with `workOrderId=W1`  
**And** the API responds `201` with a `TimeEntry` having `status=ACTIVE` and `startTime`  
**And** the UI displays the timer as running.

### Scenario 3: Stop timer completes the time entry
**Given** I have an active timer running  
**When** I click â€œStop Timerâ€  
**Then** the app calls `POST /api/workexec/time-entries/timer/stop`  
**And** the API responds `200` with `stopped[]` containing at least one entry  
**And** each returned entry has `endTime`, `durationInSeconds`, and `status=COMPLETED` or `AUTO_STOPPED`  
**And** the UI displays the stopped summary and shows no active timer.

### Scenario 4: Prevent starting a second timer in single-timer mode
**Given** I already have an active timer  
**When** I attempt to start another timer  
**Then** the API responds `409` with error code `TIMER_ALREADY_ACTIVE`  
**And** the UI shows an error stating an active timer already exists  
**And** the UI refreshes by calling `GET /api/workexec/time-entries/timer/active` and displays the active timer.

### Scenario 5: Stop fails when no timer active
**Given** I have no active timer  
**When** I click â€œStop Timerâ€  
**Then** the API responds `409` with error code `NO_ACTIVE_TIMER`  
**And** the UI shows an error stating there is no active timer to stop  
**And** the UI refreshes active timer state via `GET /api/workexec/time-entries/timer/active`.

### Scenario 6: Recover after refresh
**Given** I started a timer and it is still active  
**When** I refresh the page or reopen the app  
**Then** the app calls `GET /api/workexec/time-entries/timer/active`  
**And** the UI shows the active timer as running using the returned `startTime`.

---

# 13. Audit & Observability

## User-visible audit data
- Display (if present in responses):
  - `startTime`, `endTime`, `status`
  - Work order/task identifiers
- Do not display mechanicId if considered sensitive; treat as internal unless required.

## Status history
- Not required to display full history; only current active timer and last stop result.
- If backend provides multiple stopped entries (concurrent stop), show all in a list.

## Traceability expectations
- Frontend should include a client-generated correlation ID header if the existing frontend stack supports it (align with repo conventions).
- Log (frontend) timer actions with:
  - route/screen
  - workOrderId/workOrderItemId (non-PII)
  - outcome (success/failure + error code)

---

# 14. Non-Functional UI Requirements

- **Performance:** Active timer load should complete quickly on screen entry; avoid polling by default (manual refresh acceptable).
- **Accessibility:** Timer controls must be keyboard accessible; provide text labels for screen readers; ensure sufficient contrast.
- **Responsiveness:** Controls usable on tablet-sized devices typical for shop floor.
- **i18n/timezone:** Display times in local UI timezone, but preserve UTC in data; duration is timezone-independent.

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Show explicit â€œNo active timerâ€ empty state and disable Stop when none active; qualifies as safe because itâ€™s purely presentational and does not change domain policy. (Impacted sections: UX Summary, Alternate/Empty states, Acceptance Criteria)
- SD-UX-INFLIGHT-GUARD: Disable Start/Stop buttons while request is in-flight to prevent double submission; qualifies as safe because it prevents duplicate calls without altering business rules. (Impacted sections: Error Flows, Functional Behavior)

---

# 16. Open Questions
1. What is the **exact response schema** for `GET /api/workexec/time-entries/timer/active` (single object vs `{ active: [] }` vs raw array)? Frontend will implement tolerant parsing, but needs a canonical contract for tests.
2. Does the frontend have an existing **Work Order Task / Item** concept and identifier (`workOrderItemId`) available in the UI context today, or is v1 limited to work-order-level timing only?
3. Should the UI expose a **global active timer indicator** (visible outside work order screens) as part of this story, or is it limited to within the work order detail?
4. Are there specific **role names/permissions** exposed to the frontend to pre-hide controls, or must we rely entirely on backend 403 responses?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Integration: Start/Stop Timer Against Assigned Workorder Task â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/146


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Integration: Start/Stop Timer Against Assigned Workorder Task
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/146
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Integration: Start/Stop Timer Against Assigned Workorder Task

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Mechanic**, I want **to start and stop a job timer for a workorder task** so that **I can accurately capture job time without manual calculations**.

## Details
- Timer references workOrderId and optional workOrderItemId/laborCode.
- Enforce one active timer per mechanic (default).

## Acceptance Criteria
- Start/stop timer produces a job time entry.
- Prevent multiple active timers unless configured.
- Audited.

## Integration Points (workexec)
- Inbound: WorkOrderAssigned for context.

## Data / Entities
- TimeEntry (job)
- JobLink

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: People Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #149: [FRONTEND] [STORY] Timekeeping: Mechanic Clock In/Out  
File: ./scripts/story-work/frontend/149/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Timekeeping: Mechanic Clock In/Out (Moqui Screen + Service Wiring)

### Primary Persona
Mechanic (authenticated POS user)

### Business Value
Accurate, auditable attendance time tracking by enabling a mechanic to clock in/out with server-authoritative timestamps and clear prevention of duplicate/open entries.

---

## 2. Story Intent

### As a / I want / So that
**As a** Mechanic,  
**I want to** clock in and clock out with a single action,  
**so that** my attendance time is recorded accurately and can be audited.

### In-scope
- A dedicated Moqui screen flow for a mechanic to:
  - View current clock status (clocked in vs clocked out)
  - Perform **Clock In** or **Clock Out** (one tap)
- Frontend enforcement + backend error handling for:
  - Preventing double clock-in without clock-out
  - Preventing clock-out when not clocked in
- Display of last/open TimeEntry context after load and after actions (timestamps + timezone)
- Audit-oriented UI exposure (read-only): show created/updated timestamps and who performed action when returned by backend
- Optional â€œshift context displayâ€ (if endpoint exists) as non-blocking enhancement (no new business logic)

### Out-of-scope
- Payroll calculations, wage rules, overtime policies
- Manager corrections/edits to TimeEntry records
- Defining/implementing authorization policy and role model (frontend will respect backend 401/403)
- Creating or changing domain state machines beyond the timekeeping open/closed entry behavior
- Notification workflows

---

## 3. Actors & Stakeholders
- **Mechanic (Primary Actor):** clocks in/out.
- **Shop Manager (Stakeholder):** relies on accurate attendance records; may review exceptions later.
- **Payroll/HR (Downstream):** consumes time entries (not implemented here).
- **System (Moqui UI):** orchestrates calls, displays status and errors.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- User has an identity mapping usable by backend as â€œmechanic/employeeâ€ (e.g., `userId`/`partyId` equivalent).
- Backend provides timekeeping endpoints (see Service Contracts) with server-generated UTC timestamps.

### Dependencies
- Backend story reference indicates open clarification around **location validation policy**. This frontend story is blocked until policy is decided because it affects UI behavior, error messaging, and possibly required inputs.
- A â€œcurrent location/shop contextâ€ must be available in frontend session/context OR user must select a location (unclear; see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Primary: POS navigation item **Timekeeping â†’ Clock In/Out**
- Secondary (optional): from Mechanic home/dashboard card â€œClock statusâ€

### Screens to create/modify
- **New Screen:** `apps/pos/screen/timekeeping/ClockInOut.xml` (name illustrative; follow repo conventions)
  - Uses a single view with:
    - Status panel: â€œClocked Inâ€ / â€œClocked Outâ€
    - Last clock-in time (if open entry)
    - Last clock-out time (if last entry closed)
    - Location display (current or selected)
    - Primary action button toggles between Clock In / Clock Out
- **Optional embedded component screenlet** for dashboard usage, if project uses screenlets.

### Navigation context
- Screen requires access to:
  - Authenticated user identity
  - Current shop/location context (or selection control if not implicit)

### User workflows
**Happy path â€“ Clock In**
1. Mechanic opens Timekeeping screen.
2. Screen loads current status and shows â€œClock Inâ€.
3. Mechanic taps â€œClock Inâ€.
4. UI disables button, shows in-progress indicator.
5. On success, UI shows â€œClocked Inâ€ and displays clock-in timestamp + timezone.

**Happy path â€“ Clock Out**
1. Mechanic opens Timekeeping screen while clocked in.
2. Screen shows â€œClock Outâ€.
3. Mechanic taps â€œClock Outâ€.
4. On success, UI shows â€œClocked Outâ€ and displays clock-out timestamp + timezone.

**Alternate path â€“ Location selection (only if required)**
- Mechanic selects a location before clocking in/out; selection persists for the session (frontend-only persistence unless backend requires otherwise).

---

## 6. Functional Behavior

### Triggers
- Screen load â†’ fetch current timekeeping status for the authenticated mechanic.
- Button press:
  - If status is â€œclocked outâ€ â†’ call Clock In
  - If status is â€œclocked inâ€ â†’ call Clock Out

### UI actions
- Show a single primary action button whose label and action is determined by loaded status.
- Disable action button during network request; prevent double-submission.
- On success:
  - Refresh status by using response payload OR reloading status endpoint (preferred for consistency if backend response is minimal).
- On failure:
  - Show inline error banner/toast with actionable message.
  - Maintain prior known status (do not optimistically flip state).

### State changes (frontend-local)
- `viewState.status`: `UNKNOWN | CLOCKED_OUT | CLOCKED_IN`
- `viewState.pendingAction`: `NONE | CLOCK_IN | CLOCK_OUT`
- `viewState.lastEntry`: last known TimeEntry (open or last closed)

### Service interactions
- `GET current status` on screen load (and after successful actions)
- `POST clock-in` and `POST clock-out` on action

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- UI MUST NOT allow Clock In when backend-reported status indicates an open entry (clocked in).
- UI MUST NOT allow Clock Out when backend-reported status indicates no open entry (clocked out).
- If backend rejects due to race/concurrency, UI must display backend message and reload status.

### Enable/disable rules
- Primary action button enabled only when:
  - Status is known (`CLOCKED_IN` or `CLOCKED_OUT`)
  - No request is pending
  - Required location input (if any) is satisfied

### Visibility rules
- If status unknown due to load failure:
  - Show retry action and disable clock action button.
- Show location context always (read-only if implicit; editable if selection is required).

### Error messaging expectations
Map these cases to user-facing messages (verbatim unless backend provides a better message):
- Double clock-in attempt: â€œYou are already clocked in. You must clock out before clocking in again.â€
- Clock-out without clock-in: â€œYou are not currently clocked in.â€
- Not authorized for location (if enforced): â€œClock-in failed: You are not authorized for this location.â€
- Generic system error: â€œUnable to record time right now. Please try again or contact a manager.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **TimeEntry** (attendance record)

### Fields (type, required, defaults)
Because backend contract is not fully specified for frontend payloads, frontend requires at minimum the following data shape for display and validation:

**TimeEntry (response)**
- `timeEntryId` (string/uuid, required)
- `mechanicId` (string/uuid, required)
- `locationId` (string/uuid, required)
- `clockInTimestampUtc` (ISO-8601 string, required when clocked in/out)
- `clockInTimezone` (IANA string, required when clocked in/out)
- `clockOutTimestampUtc` (ISO-8601 string, nullable)
- `clockOutTimezone` (IANA string, nullable)
- `createdAtUtc` (ISO-8601 string, optional but preferred)
- `updatedAtUtc` (ISO-8601 string, optional but preferred)

**TimekeepingStatus (response)**
- `status` enum: `CLOCKED_IN | CLOCKED_OUT`
- `openTimeEntry` (TimeEntry | null)
- `lastClosedTimeEntry` (TimeEntry | null) (optional but useful)

**Clock action request (frontend â†’ backend)**
- `locationId` (required **if** backend requires explicit location; unclear)
- No timestamps provided by frontend (server-authoritative UTC is required)

### Read-only vs editable
- Timestamps are **read-only**.
- Location:
  - Read-only if derived from terminal/session.
  - Editable only if required due to missing config/context (see Open Questions).

### Derived/calculated fields (frontend only)
- Local display time = convert `*TimestampUtc` into userâ€™s locale/timezone for display, but also display stored timezone value (or location timezone) for context.
- Duration (optional): if open entry, show elapsed time since clock-in (requires a safe default decision; not required).

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names and REST routes are not in provided inputs. Frontend will call backend REST endpoints as per backend reference; Moqui screens will use `rest`/`service-call` patterns consistent with the project.

### Load/view calls
1. **Get current timekeeping status**
   - **Request:** `GET /api/timekeeping/me/status` (placeholder; needs confirmation)
   - **Response (200):** TimekeepingStatus (see Data Requirements)
   - **Errors:**
     - 401 â†’ redirect to login/session expired handling
     - 403 â†’ show unauthorized message
     - 5xx/timeout â†’ show retry state, keep actions disabled

### Create/update calls
2. **Clock in**
   - **Request:** `POST /api/timekeeping/me/clock-in` with body `{ locationId? }`
   - **Response (201/200):** TimeEntry or TimekeepingStatus
   - **Errors:**
     - 409 conflict if already clocked in
     - 403 if not authorized for location (if enforced)
     - 400 validation errors (missing location, etc.)

3. **Clock out**
   - **Request:** `POST /api/timekeeping/me/clock-out` with body `{ locationId? }` (if needed)
   - **Response (200):** TimeEntry or TimekeepingStatus
   - **Errors:**
     - 409 conflict if not clocked in / no open entry
     - 403 unauthorized for location (if enforced)
     - 400 validation errors

### Submit/transition calls
- Not applicable beyond clock-in/out actions.

### Error handling expectations
- For 400/403/409: show a specific message (from backend `message` if provided; otherwise use mapped defaults above), then refresh status.
- For 5xx/network: show generic error and allow retry; do not change UI status.

---

## 10. State Model & Transitions

### Allowed states (timekeeping UI state)
- `CLOCKED_OUT` â†’ user can perform **Clock In**
- `CLOCKED_IN` â†’ user can perform **Clock Out**

### Role-based transitions
- Mechanic role (or equivalent) must be allowed to clock in/out.
- If other roles can do this (e.g., manager clocking on behalf), that is out-of-scope and must not be implied.

### UI behavior per state
- **CLOCKED_OUT**
  - Primary button: â€œClock Inâ€
  - Show last closed entry if available (clock-out time)
- **CLOCKED_IN**
  - Primary button: â€œClock Outâ€
  - Show open entry details (clock-in time, location)
- **UNKNOWN/ERROR**
  - Primary button disabled
  - Show retry

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required location input (if required by backend):
  - Show â€œSelect a location to continueâ€ and block action.
- Backend returns 400 with field errors:
  - Show first error message in banner; optionally highlight relevant input (location).

### Concurrency conflicts
- Mechanic clocks in on another device while this screen is open:
  - Clock-in request returns 409; UI shows â€œYou are already clocked inâ€¦â€ and reloads status.
- Mechanic clocks out on another device:
  - Clock-out request returns 409; UI shows â€œYou are not currently clocked in.â€ and reloads.

### Unauthorized access
- 401: route to login flow.
- 403: show â€œYou do not have permission to use timekeepingâ€ and hide/disable actions.

### Empty states
- No previous entries:
  - Show status and action button; omit â€œlast entryâ€ panel.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View clock status on load (clocked out)
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_OUT`  
**When** the mechanic opens the Timekeeping Clock screen  
**Then** the UI shows status `Clocked Out`  
**And** the primary action is `Clock In`  
**And** no clock-out action is available.

### Scenario 2: Successful clock in
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_OUT`  
**When** the mechanic taps `Clock In`  
**Then** the frontend sends a clock-in request to the backend  
**And** the UI disables the action while the request is pending  
**And** on success the UI shows status `Clocked In`  
**And** displays the server-recorded clock-in UTC timestamp and stored timezone.

### Scenario 3: Prevent double clock-in (UI + backend)
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_IN`  
**When** the mechanic views the Timekeeping Clock screen  
**Then** the `Clock In` action is not available  
**And** the primary action is `Clock Out`.

**And Given** the mechanic is `CLOCKED_IN`  
**When** the mechanic attempts to invoke clock-in (e.g., by rapid double-tap or stale UI)  
**Then** the backend responds with a conflict error  
**And** the UI displays â€œYou are already clocked in. You must clock out before clocking in again.â€  
**And** the UI reloads and displays the current status.

### Scenario 4: Successful clock out
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_IN` with an open TimeEntry  
**When** the mechanic taps `Clock Out`  
**Then** the frontend sends a clock-out request to the backend  
**And** on success the UI shows status `Clocked Out`  
**And** displays the server-recorded clock-out UTC timestamp and stored timezone.

### Scenario 5: Prevent clock-out when not clocked in
**Given** the mechanic is authenticated  
**And** the backend reports the mechanic status is `CLOCKED_OUT`  
**When** the mechanic attempts to clock out (via stale state or direct action)  
**Then** the backend responds with a conflict error  
**And** the UI displays â€œYou are not currently clocked in.â€  
**And** the UI reloads status.

### Scenario 6: Location authorization failure (if enforced)
**Given** location validation is enabled by policy  
**And** the mechanic is not authorized for the current/selected location  
**When** the mechanic taps `Clock In`  
**Then** the backend responds with 403 (or configured error)  
**And** the UI displays â€œClock-in failed: You are not authorized for this location.â€  
**And** no TimeEntry is created.

### Scenario 7: System/network failure
**Given** the mechanic is authenticated  
**And** the backend is unavailable or returns 5xx  
**When** the mechanic taps `Clock In` or `Clock Out`  
**Then** the UI shows â€œUnable to record time right now. Please try again or contact a manager.â€  
**And** the UI does not change the displayed clock status  
**And** the mechanic can retry.

---

## 13. Audit & Observability

### User-visible audit data
- Display (read-only) from backend when available:
  - last action timestamps (clock-in/out UTC)
  - associated location
  - stored timezone (IANA)
- Do not display sensitive internal IDs unless already standard in POS UI.

### Status history
- Out-of-scope for this story to build full history view.
- If backend provides last entry, show last closed entry summary.

### Traceability expectations
- Frontend should include correlation/request ID header if standard in the project; log client-side errors with route + action + timestamp (no PII beyond user ID if already available in auth context).

---

## 14. Non-Functional UI Requirements

- **Performance:** status load should render actionable UI within 1s on typical store network; show skeleton/loading state while fetching.
- **Accessibility:** action button reachable by keyboard; status changes announced (aria-live) if framework supports; sufficient color contrast.
- **Responsiveness:** usable on tablet and desktop.
- **i18n/timezone:** timestamps displayed in local device format; store timezone string displayed as provided (IANA). Currency not applicable.

---

## 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE:** Show a clear empty state when no prior TimeEntry exists; qualifies as safe because it does not change business logic, only presentation. (Impacted: UX Summary, Alternate/Empty states)
- **SD-UX-REQUEST-IN-FLIGHT-GUARD:** Disable primary action and prevent double-submit while request is pending; qualifies as safe because it prevents accidental duplicate requests without altering domain policy. (Impacted: Functional Behavior, Error Flows)
- **SD-ERR-HTTP-MAPPING:** Standard handling for 401/403/409/5xx with retry and message mapping; qualifies as safe because it follows common REST semantics and does not invent business rules. (Impacted: Service Contracts, Error Flows)

---

## 16. Open Questions

1. **Location validation policy (blocking):** Is â€œmechanic assigned to selected locationâ€ enforcement **Not enforced**, **Strict**, or **Soft/flagged**? This directly affects UI requirements (location selection, warnings vs blocking) and error handling.
2. **Location source (blocking):** How does the frontend determine `locationId` for timekeeping?
   - Derived implicitly from terminal/session context, or
   - Mechanic must select a location, or
   - Backend infers location and frontend sends none.
3. **Backend endpoints (blocking):** What are the exact REST paths and response schemas for:
   - current status
   - clock-in
   - clock-out  
   (Placeholders above must be replaced to be Moqui-buildable without guesswork.)
4. **Identity mapping (blocking):** Does backend identify mechanic via auth token (â€œmeâ€) or does frontend need to send `userId/requestedBy`? If sending IDs is required, which identifier (Moqui `userId`, `partyId`, employeeId) is canonical?
5. **Shift context integration (non-blocking):** If â€œshopmgr shift can be displayedâ€ is desired, what endpoint and minimal fields should be displayed?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Timekeeping: Mechanic Clock In/Out  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/149  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Timekeeping: Mechanic Clock In/Out

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Mechanic**, I want **to clock in and out** so that **my attendance time is recorded accurately**.

## Details
- Capture UTC timestamp and local timezone.
- Optional validation that mechanic is assigned to the selected location.

## Acceptance Criteria
- One-tap clock in/out.
- Prevent double clock-in without clock-out.
- Entries are auditable.

## Integration Points (workexec/shopmgr)
- shopmgr shift can be displayed for context (optional).

## Data / Entities
- TimeEntry (attendance)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: People Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #157: [FRONTEND] [STORY] Integration: Emit CRM Reference IDs in Workorder Artifacts  
File: ./scripts/story-work/frontend/157/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: Capture & Persist CRM Reference IDs on Estimate/Work Order Artifacts

### Primary Persona
System User (Service Advisor / POS User) operating the POS frontend

### Business Value
Ensures every Estimate and Work Order created/edited in the POS has durable CRM reference IDs (party, vehicle, contacts) for traceability and reporting, and preserves the original IDs even if CRM later merges entities.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor (POS user)  
- **I want** the Estimate and Work Order creation/edit flows to capture and send CRM reference IDs (`crmPartyId`, `crmVehicleId`, `crmContactIds`) to the backend and show them read-only on artifacts  
- **So that** work artifacts can always be correlated back to CRM records for reporting and audit, even if CRM later merges/aliases records.

### In-scope
- Frontend data-model + UI changes to:
  - include `crmPartyId`, `crmVehicleId`, `crmContactIds` in relevant create/update API requests for **Estimates** and **Work Orders**
  - display these fields on Estimate/Work Order detail views as read-only â€œintegration referencesâ€
- Frontend validation and error handling for missing required CRM IDs where backend requires them.
- Optional frontend support to display â€œresolved canonical IDâ€ if a CRM alias-resolution endpoint exists **and is provided** (see Open Questions).

### Out-of-scope
- Implementing CRM merge/alias resolution logic in the workexec backend (backend rules say workexec stores IDs as provided).
- Defining or changing CRM system-of-record policies, identifier formats, or merge rules.
- Creating/maintaining location/customer approval configuration (not related).
- Adding new workflow states to work orders/estimates.

---

## 3. Actors & Stakeholders
- **Actors**
  - Service Advisor / POS User: creates/edits estimates and work orders via Moqui screens.
  - POS Frontend (Moqui): collects CRM references from existing customer/vehicle/contact context and sends to backend.
- **Stakeholders**
  - Reporting/Analytics: relies on stable stored IDs.
  - Audit/Compliance: needs traceability between work artifact and CRM entities.
  - CRM System: authoritative for party/vehicle/contact entities and merge/alias resolution.

---

## 4. Preconditions & Dependencies
- A customer and vehicle are selected in the POS flow prior to creating an Estimate and/or Work Order (source of `crmPartyId` and `crmVehicleId`).
- The frontend has access to:
  - current selected customerâ€™s CRM party ID
  - current selected vehicleâ€™s CRM vehicle ID
  - associated contact IDs (0..n)
- Backend endpoints exist (or will exist) to accept these fields on create/update:
  - Estimate create/update
  - Work Order create/update (including conversion from Estimate â†’ Work Order)
- If â€œalias resolution displayâ€ is desired, a CRM resolution endpoint must be defined and reachable from the frontend (currently unspecified).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Estimate creation flow (from customer/vehicle context)
- Estimate detail screen (view/edit while Draft)
- Work Order creation flow (direct or via conversion from approved Estimate)
- Work Order detail screen

### Screens to create/modify
- **Modify** Estimate create/edit screen(s):
  - Ensure CRM reference IDs are present in request payloads.
  - Add a read-only â€œCRM Referencesâ€ section on detail view.
- **Modify** Work Order create/edit screen(s):
  - Ensure CRM reference IDs are present in request payloads.
  - Add read-only â€œCRM Referencesâ€ section on detail view.
- **Optional**: a small read-only â€œResolved CRM IDsâ€ subsection if alias resolution is implemented (blocked pending contract).

*(Exact Moqui screen names/routes depend on repo conventions; implementer should wire into existing estimate/workorder screens rather than creating new navigation.)*

### Navigation context
- These fields should be visible on the artifact â€œSummary/Detailsâ€ area and not interrupt primary workflows.
- No new top-level menu item.

### User workflows
- **Happy path (Estimate create)**:
  1. User selects customer + vehicle (and optionally contacts).
  2. User creates an Estimate.
  3. Frontend submits estimate with `crmPartyId`, `crmVehicleId`, `crmContactIds`.
  4. User can view the stored CRM references on the Estimate detail screen.
- **Happy path (Work Order create/convert)**:
  1. User creates Work Order directly *or* converts from an Estimate.
  2. Frontend ensures the Work Order payload includes the CRM references (either inherited from estimate or supplied from context).
  3. Work Order detail shows CRM references read-only.
- **Alternate path (contacts empty)**:
  - User has no contacts selected; frontend sends `crmContactIds: []` (not null) if supported by API contract.
- **Error path (missing party/vehicle)**:
  - User attempts create without required CRM IDs available; frontend blocks submission and shows actionable error.

---

## 6. Functional Behavior

### Triggers
- Submitting Estimate create
- Submitting Estimate update (where allowed)
- Submitting Work Order create
- Submitting Work Order update (where allowed)
- Converting Estimate â†’ Work Order (if that is a frontend action)

### UI actions
- On load of Estimate/WO detail: display stored CRM reference fields read-only.
- On submit:
  - include CRM IDs in request payload consistently.
  - if missing required IDs, prevent submission (client-side) and show validation.

### State changes
- No new workexec workflow states introduced.
- These fields are treated as â€œartifact metadataâ€; once persisted, they should be treated as immutable in UI unless backend explicitly allows update (see Open Questions).

### Service interactions
- Calls to backend to create/update Estimate/Work Order must include these fields.
- Optional call to CRM alias resolution endpoint to display canonical IDs (blocked).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `crmPartyId` **required** for create (per backend rule).
- `crmVehicleId` **required** for create (per backend rule).
- `crmContactIds`:
  - must be present and **non-null**
  - may be empty array `[]` (backend assumption, pending confirmation)

### Enable/disable rules
- Submit buttons disabled while required CRM IDs are absent from current context OR while a submission is in-flight.
- CRM reference fields on detail screens are read-only (not directly editable by user) unless backend supports editing.

### Visibility rules
- Always show â€œCRM Referencesâ€ section on Estimate/Work Order detail.
- If any field is absent in the loaded record (older records), show as â€œNot setâ€ with a non-blocking warning style.

### Error messaging expectations
- If backend returns 400 with missing/invalid CRM fields, surface message:  
  â€œCustomer/Vehicle reference is missing. Re-select customer and vehicle and try again.â€
- If backend returns 409 (conflict) on update, show:  
  â€œThis record was updated elsewhere. Refresh to continue.â€

---

## 8. Data Requirements

### Entities involved (frontend view models)
- Estimate (workexec)
- Work Order (workexec)

### Fields
For both Estimate and Work Order artifacts:

| Field | Type | Required | Default | Editable |
|------|------|----------|---------|----------|
| crmPartyId | string (format TBD) | Yes (on create) | none | Read-only in UI by default |
| crmVehicleId | string (format TBD) | Yes (on create) | none | Read-only in UI by default |
| crmContactIds | string[] | Yes (must be non-null) | `[]` | Read-only in UI by default |

### Read-only vs editable by state/role
- **Read-only** across all states in the frontend unless backend explicitly supports updating these values.
- If an Estimate is `DRAFT` and backend permits update, allow update only indirectly by changing selected customer/vehicle context and resubmitting (but this is **blocked** until backend contract is explicit).

### Derived/calculated fields
- Optional derived display:
  - â€œResolved Party IDâ€ / â€œResolved Vehicle IDâ€ from CRM alias resolution endpoint (blocked).

---

## 9. Service Contracts (Frontend Perspective)

> Exact Moqui service names are unknown from provided inputs; frontend must integrate with the backend REST endpoints listed in the domain docs.

### Load/view calls
- `GET /api/estimates/{id}` returns estimate including CRM reference fields.
- `GET /api/workorders/{id}` (or `/api/work-orders/{id}` depending on backend routing) returns work order including CRM reference fields.
  - **Open Question:** actual path naming consistency (workorders vs work-orders).

### Create/update calls
- Estimate create:
  - `POST /api/estimates` with body including `crmPartyId`, `crmVehicleId`, `crmContactIds`.
- Estimate update (if exists):
  - `PUT/PATCH /api/estimates/{id}` (contract TBD) must preserve fields; frontend must not drop them on update.
- Work order create:
  - `POST /api/workorders` (or similar) includes CRM fields.
- Work order update:
  - `PUT/PATCH /api/workorders/{id}` must preserve fields; frontend must not drop them.

### Submit/transition calls
- If work order is created by converting an estimate:
  - Whatever endpoint/flow performs conversion must ensure CRM fields propagate (either backend does it, or frontend supplies them).
  - **Do not assume**; see Open Questions.

### Error handling expectations
- 400: show field-level validation summary (missing party/vehicle, contacts null).
- 401/403: show â€œNot authorizedâ€ and navigate to login/stop action.
- 404: show â€œRecord not foundâ€ and provide back navigation.
- 409: prompt refresh/retry.
- 500: show generic error with correlation/trace id if provided by backend.

---

## 10. State Model & Transitions

### Allowed states
- No changes to existing Estimate state machine (`DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`) or Work Order state machine (per `WORKORDER_STATE_MACHINE.md`).

### Role-based transitions
- Not modified by this story.

### UI behavior per state
- Estimate:
  - In all states: CRM references visible read-only.
  - In `DRAFT`: if estimate editing is allowed, ensure CRM fields are preserved during saves.
- Work Order:
  - In all states: CRM references visible read-only.
  - During execution states: no special behavior besides display.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing selected customer â†’ cannot compute `crmPartyId`:
  - Block submit; show â€œSelect a customer to continue.â€
- Missing selected vehicle â†’ cannot compute `crmVehicleId`:
  - Block submit; show â€œSelect a vehicle to continue.â€

### Backend validation failures
- Backend 400 indicates missing `crmVehicleId`:
  - Show error and keep user on form with fields intact.

### Concurrency conflicts
- If update returns 409:
  - Prompt user to refresh; do not auto-resubmit.

### Unauthorized access
- 403 on load or submit:
  - Show authorization error and hide CRM references if record cannot load.

### Empty states / legacy records
- Loading an older Estimate/WO without CRM refs:
  - Display â€œNot setâ€ values and a note: â€œThis record was created before CRM references were required.â€

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create Estimate includes CRM references
**Given** a POS user has selected a customer with `crmPartyId` and a vehicle with `crmVehicleId`  
**And** the user has selected zero or more contacts (yielding `crmContactIds`)  
**When** the user submits â€œCreate Estimateâ€  
**Then** the frontend sends a create request containing `crmPartyId`, `crmVehicleId`, and `crmContactIds` (non-null; empty array allowed)  
**And** on successful creation, the Estimate detail screen displays the stored CRM reference fields read-only.

### Scenario 2: Prevent Estimate create when required CRM IDs are missing
**Given** a POS user has not selected a vehicle (no `crmVehicleId` available)  
**When** the user attempts to submit â€œCreate Estimateâ€  
**Then** the frontend blocks submission  
**And** shows an error indicating vehicle selection is required.

### Scenario 3: Work Order detail displays CRM references
**Given** a work order exists with stored `crmPartyId`, `crmVehicleId`, and `crmContactIds`  
**When** the user opens the Work Order detail screen  
**Then** the CRM reference fields are displayed read-only  
**And** the UI does not allow direct editing of these fields.

### Scenario 4: Updates do not drop CRM references
**Given** an estimate exists with CRM references set  
**And** the estimate is edited in a manner that triggers an update call (e.g., adding a line item)  
**When** the frontend submits the update request  
**Then** the request payload preserves the existing CRM reference values (does not omit or null them)  
**Or** the frontend uses a backend endpoint that guarantees preservation (explicitly documented in implementation).

### Scenario 5: Backend 400 is shown as actionable error
**Given** the backend responds `400 Bad Request` indicating `crmPartyId` is missing  
**When** the frontend receives the response  
**Then** the UI displays an actionable error message instructing the user to re-select customer/vehicle and retry  
**And** the userâ€™s in-progress form data is preserved.

---

## 13. Audit & Observability

### User-visible audit data
- On Estimate/WO detail, show:
  - CRM Party ID
  - CRM Vehicle ID
  - CRM Contact IDs count (and list if space allows)
- Do not expose any internal-only CRM fields beyond IDs.

### Status history
- No new status history requirements.

### Traceability expectations
- Frontend should pass through any backend correlation ID/trace ID in error banners if provided (e.g., from response headers).

---

## 14. Non-Functional UI Requirements
- **Performance**: Displaying CRM reference fields must not add additional blocking network calls; alias-resolution (if implemented) must be non-blocking and tolerant of failure.
- **Accessibility**: CRM reference section must be keyboard navigable and screen-reader labeled (IDs announced with clear field names).
- **Responsiveness**: CRM references render well on tablet layouts (wrap long IDs).
- **i18n/timezone/currency**: Not applicable (IDs only).

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE-01: Show â€œNot setâ€ for missing legacy CRM reference fields; safe because itâ€™s a non-decision UX fallback that doesnâ€™t alter domain policy. (Impacted: UX Summary, Error Flows)
- SD-ERR-MAP-01: Standard HTTP error-to-banner mapping (400/401/403/404/409/500) with non-destructive retry guidance; safe because it does not invent business rules, only displays backend outcomes. (Impacted: Service Contracts, Alternate/Error Flows)

---

## 16. Open Questions

1. **Backend contract for identifier types/formats**: What are the exact data types and validation formats for `crmPartyId`, `crmVehicleId`, and each element of `crmContactIds` (UUID, numeric, prefixed string)?  
2. **Exact API routes for Work Orders**: Are endpoints `/api/workorders/...` or `/api/work-orders/...` used by the backend the frontend will call? Provide canonical paths for load/create/update.  
3. **Immutability vs editability**: After creation, are CRM reference fields immutable on Estimate/Work Order? If customer/vehicle selection changes during Draft, should the frontend be allowed to update these IDs, or must a new Estimate be created?  
4. **Conversion behavior**: When converting an Estimate â†’ Work Order, does the backend automatically copy CRM references from the Estimate, or must the frontend supply them in the conversion/create request?  
5. **Alias resolution endpoint**: Does a CRM alias/redirect resolution API exist for party/vehicle/contact IDs? If yes, provide URL + request/response schema and whether frontend is expected to call it (read-only display) or leave it to downstream systems only.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Integration: Emit CRM Reference IDs in Workorder Artifacts  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/157  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Integration: Emit CRM Reference IDs in Workorder Artifacts

**Domain**: user

### Story Description

/kiro  
# User Story

## Narrative  
As a **System**, I want **workorders/estimates to store CRM partyId, vehicleId, and contactIds** so that **traceability and reporting are possible**.

## Details  
- Workorder domain stores foreign references to CRM.  
- CRM merges must not break references (aliases/redirects).

## Acceptance Criteria  
- Estimate/WO persist CRM references.  
- References resolvable back to CRM after merges.

## Integration Points (Workorder Execution)  
- Workorder Execution persists CRM IDs; CRM provides alias resolution endpoint if needed.

## Data / Entities  
- WO/Estimate reference fields  
- PartyAlias (optional)

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: CRM

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #162: [FRONTEND] [STORY] Billing: Enforce PO Requirement During Estimate Approval  
File: ./scripts/story-work/frontend/162/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Workexec: Enforce Purchase Order (PO) Requirement During Estimate Approval

## Primary Persona
Service Advisor

## Business Value
Reduce billing exceptions and rework by preventing estimate approval when customer billing rules mandate a PO, and ensure the captured PO reference is available downstream (e.g., invoice display).

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor  
- **I want** the Estimate approval flow to require a PO number (and optionally a PO attachment reference) when the customerâ€™s BillingRule mandates it  
- **So that** non-compliant estimates cannot be approved and downstream billing/invoicing has the PO reference.

## In-scope
- Frontend changes to the **Estimate approval step** to:
  - Determine whether PO is required (based on backend enforcement outcome / rule evaluation).
  - Capture `poNumber` and optional `attachmentId`.
  - Block approval client-side where possible and **always** handle backend validation failures deterministically.
  - Display stored PO reference on approved estimate/work order summary views that are already present in the frontend.
- Error handling for rule-unavailable / rule-not-configured and PO validation failures.

## Out-of-scope
- Implementing or changing CRM BillingRule configuration UI.
- Implementing attachment upload/storage system (only capturing an `attachmentId` reference if provided).
- Any backend changes (assumed available per referenced backend story).
- Invoice rendering changes outside of showing PO reference when invoice data already includes it (see Open Questions).

---

# 3. Actors & Stakeholders
- **Primary actor:** Service Advisor (approves estimates, enters PO)
- **Secondary actors:** 
  - Billing/Accounting consumers (read-only visibility of PO on invoice)
  - Admin/support (troubleshoot configuration/rule failures)
- **Systems:** 
  - Workexec backend (system of record for approval + PO reference)
  - CRM backend (rules provider; indirect via workexec)

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated and authorized to approve estimates.
- An Estimate exists and is in an approval-eligible state (backend controls; frontend should reflect).
- Estimate is associated to a customer/account such that workexec can evaluate BillingRule.

## Dependencies
- Backend endpoints (from authoritative references):
  - `POST /api/v1/estimates/{id}/approve?approvedBy={userId}` (existing approval)
  - Workexec enforcement on approval that may return domain errors:
    - `PurchaseOrderNumberMissing`
    - `PurchaseOrderNumberInvalidFormat`
    - `PurchaseOrderNumberTooLong`
    - `BillingRuleUnavailable` (retryable)
    - `BillingRuleNotConfigured`
    - attachment-related errors: `PurchaseOrderAttachmentInvalidId`, `PurchaseOrderAttachmentNotFound`, `PurchaseOrderAttachmentUnauthorized`
- Estimate read endpoint includes `purchaseOrderReference` when present (backend AC-5).
- Moqui frontend has an existing screen for viewing/approving estimates (exact route/screen name unknown; see Open Questions).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From Estimate detail / approval screen used by Service Advisors:
  - Primary action: â€œApprove Estimateâ€

## Screens to create/modify
- **Modify** existing Estimate detail/approval screen (Moqui Screen) to add a **PO Reference** section within the approval area.
- **Modify** existing Estimate/Work Order summary screen(s) to display `purchaseOrderReference` (read-only) after approval when present.

## Navigation context
- User is already in a specific Estimate context (`estimateId` in URL parameters).
- After successful approval, user remains on Estimate detail (now Approved) or is redirected to the standard post-approval destination (existing behavior; do not change without confirmation).

## User workflows

### Happy path (PO required)
1. Service Advisor opens Estimate pending approval.
2. System indicates PO is required (either via pre-check if available, or after first failed attempt).
3. Service Advisor enters PO number; optionally enters attachmentId (UUID).
4. Service Advisor clicks Approve.
5. Approval succeeds; status updates to Approved; PO reference shown on the record.

### Happy path (PO not required)
1. Service Advisor approves without entering PO.
2. Approval succeeds; PO reference remains blank/null.

### Alternate path (rule unavailable / not configured)
1. Service Advisor attempts approval.
2. Backend returns rule unavailable/not configured.
3. UI blocks completion, shows actionable message and retry guidance.

---

# 6. Functional Behavior

## Triggers
- User clicks â€œApprove Estimateâ€ from Estimate approval screen.

## UI actions
- Provide inputs:
  - `poNumber` (string)
  - `attachmentId` (UUID string, optional)
- Provide an â€œApproveâ€ action that calls backend approve API with PO payload (see Service Contracts).

## State changes (frontend-visible)
- On success:
  - Refresh estimate record data; update displayed status to `APPROVED`.
  - Display saved `purchaseOrderReference`.
- On failure:
  - Keep estimate in pre-approval state in UI (no optimistic status change).
  - Highlight PO inputs if validation-related.
  - Show blocking banner/dialog for rule/config errors.

## Service interactions
- Approval attempt always calls workexec approval endpoint.
- After approval success, fetch latest estimate (or rely on approve response if it returns updated entity; unknown).

---

# 7. Business Rules (Translated to UI Behavior)

## Validation (client-side, non-authoritative)
Client-side validation is **advisory only**; backend is authoritative.

- If UI currently knows PO is required (based on prior backend error or explicit flag if available):
  - `poNumber` must be present and non-empty after trim.
  - `poNumber` must be <= 64 chars.
  - `poNumber` should match regex: `^[A-Za-z0-9][A-Za-z0-9 _./-]{0,63}$`
- If `attachmentId` is provided:
  - Must parse as UUID format; otherwise show inline error and prevent submit.

## Enable/disable rules
- Disable Approve button while the approve request is in-flight.
- If PO is known-required and `poNumber` is invalid, disable Approve until corrected.

## Visibility rules
- PO section is always visible on approval screen, but:
  - Show â€œRequiredâ€ indicator only when requirement is known (see Service Contracts / Open Questions).
- On read-only/approved states, show PO values read-only.

## Error messaging expectations (mapping to backend errors)
- `PurchaseOrderNumberMissing` â†’ inline error on PO number: â€œPO number is required to approve this estimate.â€
- `PurchaseOrderNumberInvalidFormat` â†’ inline error: â€œPO number contains invalid characters.â€
- `PurchaseOrderNumberTooLong` â†’ inline error: â€œPO number must be 1â€“64 characters.â€
- `BillingRuleUnavailable` (503) â†’ blocking banner: â€œCannot verify PO requirement right now. Please try again.â€
- `BillingRuleNotConfigured` â†’ blocking banner: â€œBilling rules are not configured for this customer; approval is blocked. Contact an administrator.â€
- Attachment errors:
  - `PurchaseOrderAttachmentInvalidId` â†’ inline error: â€œAttachment ID must be a valid UUID.â€
  - `PurchaseOrderAttachmentNotFound` â†’ inline error: â€œAttachment not found.â€
  - `PurchaseOrderAttachmentUnauthorized` â†’ inline error: â€œYou do not have access to that attachment.â€

---

# 8. Data Requirements

## Entities involved (frontend perspective)
- `Estimate` (read + approve)
- `PurchaseOrderReference` (nested on estimate/work order):
  - `poNumber: string`
  - `attachmentId: UUID (string)`

## Fields
### Input fields (editable on approval attempt)
- `poNumber`
  - type: string
  - required: conditionally (only when rule requires)
  - default: empty
- `attachmentId`
  - type: string (UUID)
  - required: no
  - default: empty

### Read-only fields
- Estimate status (`DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED` per workexec approval workflow doc)
- Stored `purchaseOrderReference` after approval (read-only unless estimate is editable againâ€”no policy defined here; assume read-only once approved)

## Derived/calculated
- `isPoRequired` (UI-only flag)
  - Derived from either:
    - explicit backend-provided flag on estimate/config (preferred), OR
    - last backend error indicating PO required (fallback, safe).

---

# 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names are unknown; define integration at HTTP API level and implement via Moqui `service-call` / `rest` as per repo conventions.

## Load/view calls
- `GET /api/estimates/{id}`
  - Expected to return estimate including:
    - `status`
    - `customerId` (if needed for display)
    - `purchaseOrderReference` (nullable)
  - If backend also returns an â€œapplicable billing ruleâ€ or `requirePurchaseOrderOnEstimateApproval`, use it to set `isPoRequired`. (Unknown; see Open Questions.)

## Submit/transition calls
### Approve estimate
- `POST /api/v1/estimates/{estimateId}/approve?approvedBy={userId}`
- Request body (frontend must send if supported by backend; format must match backend):
  ```json
  {
    "purchaseOrderReference": {
      "poNumber": "string",
      "attachmentId": "uuid-string (optional)"
    }
  }
  ```
  If backend expects flat fields instead (unknown), adapt once clarified.

- Success:
  - HTTP 200/201 (backend doc implies approve returns Estimate; not specified)
  - UI refreshes entity and shows Approved state.

## Error handling expectations
- 400 â†’ validation errors (PO missing/invalid, attachment invalid format)
- 403 â†’ unauthorized
- 404 â†’ estimate not found
- 409 â†’ conflict/concurrency (if estimate changed state between load and approve)
- 503 â†’ billing rule unavailable (retryable)

Frontend must map backend error codes (string identifiers) to the UI messages listed in Business Rules.

---

# 10. State Model & Transitions

## Allowed states (Estimate)
From `CUSTOMER_APPROVAL_WORKFLOW.md`:
- `DRAFT`
- `APPROVED`
- `DECLINED`
- `EXPIRED`

## Allowed transitions relevant to this story
- `DRAFT` â†’ `APPROVED` via approve (this story adds PO enforcement at this boundary)
- (Other transitions exist but not modified here)

## Role-based transitions
- Service Advisor can initiate approval (authorization enforced server-side; UI should hide/disable approve action if backend indicates not permittedâ€”mechanism unknown).

## UI behavior per state
- `DRAFT` (approval-eligible): show PO inputs + Approve action.
- `APPROVED`: show PO reference read-only; hide/disable approval action.
- `DECLINED` / `EXPIRED`: approval action hidden/disabled; PO reference read-only if present (likely null).

---

# 11. Alternate / Error Flows

## Validation failures
- User clicks Approve with missing/invalid PO when required:
  - If client-side knows required: block submit and show inline errors.
  - If client-side doesnâ€™t know required: submit may fail; on backend error, show inline error and set `isPoRequired=true` for subsequent attempts.

## Concurrency conflicts
- If backend returns 409 because estimate status changed (e.g., already approved/declined elsewhere):
  - UI refreshes estimate data and shows â€œThis estimate was updated by another user; please review the current status.â€

## Unauthorized access
- 403 on approve:
  - Show blocking message: â€œYou are not authorized to approve estimates.â€
  - Keep user on page; do not change state.

## Empty states
- If estimate load returns no `purchaseOrderReference`, display â€œNoneâ€ in read-only contexts.

---

# 12. Acceptance Criteria

## Scenario 1: PO required and provided â†’ approval succeeds
**Given** an estimate is in `DRAFT` and backend BillingRule requires a PO  
**And** the Service Advisor enters a PO number matching the allowed format and â‰¤ 64 chars  
**When** the Service Advisor submits approval  
**Then** the UI calls the approve endpoint including `purchaseOrderReference.poNumber`  
**And** the estimate status updates to `APPROVED` after refresh  
**And** the PO number is visible on the approved estimate screen.

## Scenario 2: PO required and missing â†’ approval blocked with inline error
**Given** an estimate is in `DRAFT` and backend BillingRule requires a PO  
**When** the Service Advisor attempts approval without a PO number  
**Then** approval does not complete  
**And** the UI displays an inline error mapped to `PurchaseOrderNumberMissing`  
**And** the estimate remains not approved in the UI.

## Scenario 3: PO not required â†’ approval succeeds without PO
**Given** an estimate is in `DRAFT` and backend BillingRule does not require a PO  
**When** the Service Advisor approves without providing a PO number  
**Then** the approval succeeds  
**And** the stored `purchaseOrderReference` remains empty/null in the refreshed estimate display.

## Scenario 4: Billing rule unavailable â†’ fail-safe blocks approval and suggests retry
**Given** an estimate is in `DRAFT`  
**When** the Service Advisor attempts approval and the backend cannot retrieve BillingRule (503 / `BillingRuleUnavailable`)  
**Then** the UI shows a blocking message indicating the rule cannot be verified  
**And** the estimate remains unapproved  
**And** the user can retry approval.

## Scenario 5: AttachmentId invalid UUID â†’ client-side blocks submit
**Given** the PO attachment field is available  
**When** the Service Advisor enters an attachmentId that is not a valid UUID  
**Then** the UI shows an inline validation error on attachmentId  
**And** the Approve action is disabled (or submit blocked) until corrected.

## Scenario 6: Approved estimate displays PO reference for downstream visibility
**Given** an estimate has been approved with a `purchaseOrderReference`  
**When** the Service Advisor views the approved estimate (or associated work order summary view where invoice is accessed)  
**Then** the PO number (and attachmentId if present) is displayed read-only.

---

# 13. Audit & Observability

## User-visible audit data
- On approval failure, show a user-facing error message with a stable reason (mapped from backend error code).
- Do not display sensitive internal details (no stack traces, no raw payload hashes).

## Status history
- No new UI for history is required; rely on existing status display.
- If existing screen shows approval metadata, ensure PO reference does not overwrite/obscure it.

## Traceability expectations
- Frontend must include correlation/request ID headers if the project convention exists (unknown here).
- Log (frontend console/debug logger per conventions) the approve attempt outcome with:
  - `estimateId`
  - success/failure
  - backend error code (if any)
  - do **not** log PO number (treat as potentially sensitive business identifier).

---

# 14. Non-Functional UI Requirements

- **Performance:** Approval submit should show loading state immediately; avoid duplicate submits.
- **Accessibility:** Inputs must have labels; inline errors must be associated to fields; keyboard navigable submit.
- **Responsiveness:** PO inputs usable on tablet-size screens (service counter).
- **i18n/timezone/currency:** No new currency calculations. Error strings should be defined in the projectâ€™s translation/message system if used (unknown; default to existing pattern).

---

# 15. Applied Safe Defaults

- Default ID: UI-ERG-EMPTYSTATE-01  
  - What was assumed: When no PO reference exists, display â€œNoneâ€ rather than blank.  
  - Why it qualifies as safe: Purely presentational; does not change domain behavior.  
  - Impacted sections: UX Summary, Alternate / Error Flows.

- Default ID: UI-ERG-LOADING-01  
  - What was assumed: Disable Approve while request is in-flight and show a loading indicator.  
  - Why it qualifies as safe: Prevents duplicate submissions without affecting business rules.  
  - Impacted sections: Functional Behavior, Non-Functional UI Requirements.

- Default ID: ERR-MAP-STD-01  
  - What was assumed: Standard mapping of HTTP 400/403/404/409/503 to user messages, with domain error code mapping when provided.  
  - Why it qualifies as safe: Error handling is derived from backend contract and improves determinism.  
  - Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows, Acceptance Criteria.

---

# 16. Open Questions

1. **Where in the Moqui frontend is â€œEstimate approvalâ€ implemented (screen path / route / component name)?** Provide the canonical screen(s) to modify so routing/transition metadata is correct.  
2. **Does the estimate GET endpoint expose a flag indicating PO is required (e.g., `requirePurchaseOrderOnEstimateApproval`) or must the UI infer requirement only after a failed approval?**  
3. **What is the exact approve endpoint contract for sending PO reference from frontend?**  
   - Is it a request body with `purchaseOrderReference`, query params, or a different shape?  
4. **How should the optional attachment reference be captured?**  
   - Is there an existing attachment picker/uploader component that returns `attachmentId`, or is this a raw UUID input only?  
5. **â€œPO stored and visible on invoiceâ€**: which frontend view is considered â€œinvoiceâ€ in this repo, and does it already read PO reference from workexec/billing payload? If not, should this story also add invoice display changes or is that a separate story?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Billing: Enforce PO Requirement During Estimate Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/162  
Labels: frontend, story-implementation, payment

## Frontend Implementation for Story

**Original Story**: [STORY] Billing: Enforce PO Requirement During Estimate Approval

**Domain**: payment

### Story Description

/kiro
# User Story

## Narrative
As a **Service Advisor**, I want **the system to require a PO when account rules mandate it** so that **billing exceptions are reduced**.

## Details
- PO required triggers validation in Estimate approval step.
- Capture PO number and optional attachment reference.

## Acceptance Criteria
- Approval blocked without PO when required.
- PO stored and visible on invoice.

## Integration Points (Workorder Execution)
- Workorder Execution checks CRM billing rules and enforces PO before approval.

## Data / Entities
- PurchaseOrderRef (WO domain)
- CRM BillingRule reference

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: CRM


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #214: [FRONTEND] [STORY] Completion: Reopen Completed Workorder (Controlled)  
File: ./scripts/story-work/frontend/214/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Completion: Reopen Completed Workorder (Controlled)

### Primary Persona
Back Office Manager

### Business Value
Enable controlled correction of completed work orders prior to invoicing, with strict permission gating, mandatory justification, and auditable invalidation of invoice-ready scope to protect downstream accounting and billing integrity.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Back Office Manager  
- **I want** to reopen a completed work order by providing a mandatory reason  
- **So that** I can correct mistakes while preserving auditability and preventing invoicing until the work order is properly re-completed.

### In-scope
- Frontend UI to initiate â€œReopenâ€ for eligible work orders.
- Mandatory reason capture and submission.
- Permission-aware visibility/enablement of the action.
- Post-action UI state updates (reopened flag, invoice-ready revoked, snapshot superseded).
- Display of relevant audit/transition feedback to the user (confirmation + status indicators).
- Idempotency-safe UX for repeated submission attempts (prevent double-submit; handle 409/duplicate gracefully).

### Out-of-scope
- Credit/rebill workflows when an invoice is already issued/finalized.
- Defining or editing the editability policy itself (config/table management).
- Implementing backend event emission, accounting integration plumbing (frontend will rely on backend behavior).
- Any â€œsilent edit after completionâ€ outside of the reopen flow.

---

## 3. Actors & Stakeholders

### Actors
- **Back Office Manager** (primary): initiates reopen.
- **Service Advisor** (secondary): may later edit fields unlocked by policy (not fully implemented here; only ensure UI respects read-only status post-reopen as data indicates).
- **Unauthorized User**: must be blocked.

### Stakeholders
- **Accounting / Event consumers**: depend on a single `WorkorderReopened` event and snapshot invalidation semantics.
- **Billing/Invoicing**: must not allow invoicing until re-completion and re-snapshot.

---

## 4. Preconditions & Dependencies

### Preconditions
- Work order exists and is viewable in POS frontend.
- Work order is in `COMPLETED` status (per backend rule).
- No associated invoice is `ISSUED` or `FINALIZED` (backend blocks otherwise).
- User has permission `WORKORDER_REOPEN_COMPLETED` (backend enforces; frontend should also hide/disable action where possible).

### Dependencies
- Backend endpoints must exist and be accessible from Moqui frontend:
  - Reopen endpoint (exact path needs confirmationâ€”see Open Questions).
  - Work order detail endpoint providing `status`, `isReopened`, and invoice readiness indicator (name needs confirmation).
  - Billable scope snapshot info (at minimum: active snapshot id + status) OR a derived â€œinvoice-readyâ€ flag.
- Authentication/authorization context available in frontend (current userId, permissions/roles).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Work Order Detail screen (primary entry).
- Optional: Work Order list row actions (secondary entry) **only if** list provides sufficient eligibility info; otherwise keep only on detail.

### Screens to create/modify
- **Modify**: `WorkOrderDetail` screen (Moqui Screen)
  - Add an actions section with a `Reopen Work Order` action.
  - Add a modal/dialog to collect `reopenReason`.
- **Optional/Recommended**: `WorkOrderAudit/History` subsection or related screen region to show latest reopen audit event and snapshot status (read-only).

### Navigation context
- User is already viewing a specific work order (`workOrderId` in URL/parameters).
- After successful reopen, user remains on Work Order Detail and sees updated flags/status indicators.

### User workflows
#### Happy path
1. Back Office Manager opens a completed work order.
2. Clicks **Reopen Work Order**.
3. Enters mandatory reason.
4. Confirms.
5. UI shows success message; work order indicates reopened (`isReopened=true`), invoice-ready revoked, and (if available) snapshot now `SUPERSEDED`.

#### Alternate paths
- User without permission: action hidden or disabled; if forced via URL/action, backend returns 403 and UI shows access denied.
- Work order not `COMPLETED`: action hidden/disabled; backend returns 409/400 if invoked.
- Invoice already issued: backend blocks; UI shows explicit message (â€œCannot reopen a work order that has been invoiced.â€).
- Double-click / retry: UI prevents duplicate submissions; if backend responds conflict/duplicate, UI treats as non-fatal and refreshes work order.

---

## 6. Functional Behavior

### Triggers
- User clicks `Reopen Work Order` from Work Order Detail.

### UI actions
- Open dialog/form with:
  - `reopenReason` textarea (required).
  - Confirm and Cancel.
- Confirm triggers submit action calling backend service.
- On success:
  - Refresh work order detail data (re-fetch).
  - Display confirmation.
  - Update any invoice eligibility indicators and snapshot section.

### State changes (frontend-visible)
- Work order remains `status=COMPLETED` (per backend clarification), but:
  - `isReopened` becomes true.
  - Invoice-ready flag becomes false (field name TBD).
  - Active `BillableScopeSnapshot` becomes `SUPERSEDED` (if exposed).
- UI must treat reopened-completed work order as **not invoiceable** and as **locked unless policy allows** (policy data exposure TBD).

### Service interactions
- Submit reopen request with:
  - workOrderId
  - reopenReason
  - userId (if backend requires; otherwise backend derives from auth contextâ€”TBD)
- Then reload:
  - work order detail
  - (optional) snapshot data and/or audit event list

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `reopenReason` is mandatory:
  - Trim whitespace; must not be empty.
  - If empty: show inline error and disable confirm.
- Only allow initiating reopen when:
  - `workOrder.status == COMPLETED`
  - user has permission `WORKORDER_REOPEN_COMPLETED`
  - invoice not issued/finalized (if frontend has that info; otherwise rely on backend error)

### Enable/disable rules
- `Reopen Work Order` button:
  - **Visible + enabled** only when eligibility conditions true.
  - **Disabled** with tooltip/reason if status not eligible or invoice already issued (if known).
- Confirm button disabled until reason passes validation and submission not in progress.

### Visibility rules
- After reopen (`isReopened=true`), show a prominent read-only indicator:
  - â€œReopened: invoice eligibility revoked until re-completion.â€
- Show last reopen reason and metadata if backend returns (recommended; may require audit API).

### Error messaging expectations
- 403: â€œAccess denied: you are not authorized to reopen completed work orders.â€
- 409/400 invalid state: â€œThis work order cannot be reopened in its current state.â€
- 409 invoice already issued: â€œCannot reopen a work order that has been invoiced.â€
- 5xx/network: â€œReopen failed due to a system error. No changes were applied.â€ plus retry option.

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `Workorder`
- `BillableScopeSnapshot`
- `AuditEvent` (read-only display; creation done server-side)

### Fields
#### Workorder (read)
- `id` (string/number; required)
- `status` (enum string; required; must include `COMPLETED`)
- `isReopened` (boolean; required after reopen support exists)
- `invoiceReady` (boolean; **field name TBD**; required for UI gating)
- `lastReopenedAt` (datetime; optional if provided)
- `lastReopenedBy` (userId; optional if provided)
- `lastReopenReason` (string; optional if provided)

#### Reopen request (write)
- `workOrderId` (path or body; required)
- `reopenReason` (string; required)
- `userId` (number/string; **only if backend requires**; TBD)

#### BillableScopeSnapshot (read)
- `id` (required if returned)
- `status` (enum: must include `ACTIVE`, `SUPERSEDED`)
- `supersededAt` (datetime; optional)
- `supersededBy` (userId; optional)
- `supersededReason` (string; optional)

### Read-only vs editable by state/role
- This story does **not** implement editing unlocked fields; it ensures:
  - In `COMPLETED` and not reopened: fields remain read-only (no silent edits).
  - In `COMPLETED` and reopened: fields *may* become editable per policy, but **policy data contract is undefined** â†’ keep fields read-only until a separate story provides editability policy and UI enforcement details.

### Derived/calculated fields
- `canReopen` (derived client-side): based on permission + status + (optional) invoice status indicator.
- `reopenActionAvailableReason` (string): used for disabled tooltip.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui frontend may call REST endpoints via configured service facade; exact method names/paths must match backend.

### Load/view calls
- `GET /api/workorders/{id}` (or `/api/work-orders/{id}`): load work order detail including `status`, `isReopened`, invoice status/eligibility.
- Optional:
  - `GET /api/workorders/{id}/snapshots` or dedicated endpoint to fetch active billable scope snapshot
  - `GET /api/audit-events?entityType=WORKORDER&entityId={id}` or `/api/workorders/{id}/audit`

### Submit/transition calls
- **Reopen**: `POST /api/workorders/{id}/reopen` (TBD) with body `{ reopenReason, userId? }`
  - Success: 200/201 with updated Workorder or minimal acknowledgement; frontend must refresh via GET.

### Error handling expectations
- 400: validation failures (missing reason)
- 403: permission failure
- 404: work order not found
- 409: invalid state (not completed), invoice issued/finalized, idempotency conflict/duplicate
- 5xx: server failure; frontend shows retry and does not assume state changed

---

## 10. State Model & Transitions

### Allowed states (WorkOrderStatus, per workexec reference)
- `DRAFT`
- `APPROVED`
- `ASSIGNED`
- `WORK_IN_PROGRESS`
- `AWAITING_PARTS`
- `AWAITING_APPROVAL`
- `READY_FOR_PICKUP`
- `COMPLETED`
- `CANCELLED`

### Reopen semantics (per backend clarification)
- Reopen **does not change** `Workorder.status` away from `COMPLETED`.
- Reopen sets `Workorder.isReopened = true`.
- Re-completion later sets `isReopened = false` (frontend expects; not implemented here).

### Role-based transitions
- Reopen action requires permission `WORKORDER_REOPEN_COMPLETED`.
- Frontend must not offer transition to users lacking permission.

### UI behavior per state
- If `status != COMPLETED`: no reopen action.
- If `status == COMPLETED && isReopened == false`: show reopen action if permitted.
- If `status == COMPLETED && isReopened == true`: hide reopen action (or disable with â€œAlready reopenedâ€) and show â€œinvoice eligibility revokedâ€ banner.

---

## 11. Alternate / Error Flows

### Validation failures
- Empty reason: inline error; no API call.
- Excessive length (if backend enforces): show server-provided validation message (needs max length clarification).

### Concurrency conflicts
- If another user reopens first:
  - Backend returns 409 or returns already-reopened state.
  - Frontend refreshes and displays â€œWork order was already reopened by <user> at <time>.â€

### Unauthorized access
- If user lacks permission but UI allowed navigation:
  - Backend 403; show error; do not change UI state; keep dialog closed after acknowledging.

### Empty states
- If snapshot/audit history endpoint returns none:
  - Show â€œNo billing snapshot history availableâ€ / â€œNo audit history availableâ€ (read-only informational).

---

## 12. Acceptance Criteria

### Scenario 1: Authorized user successfully reopens a completed, not-invoiced work order
**Given** I am logged in as a Back Office Manager with permission `WORKORDER_REOPEN_COMPLETED`  
**And** a work order exists with `status = COMPLETED` and `isReopened = false`  
**And** the work order has no invoice in `ISSUED` or `FINALIZED` status  
**When** I click â€œReopen Work Orderâ€  
**And** I enter reopen reason â€œCorrected labor hoursâ€  
**And** I confirm the reopen action  
**Then** the UI sends a reopen request including the workOrderId and reopenReason  
**And** the UI shows a success confirmation  
**And** the work order detail refresh shows `isReopened = true`  
**And** the UI indicates invoice eligibility is revoked until re-completion  
**And** the UI shows the billing snapshot (if displayed) is no longer active (status `SUPERSEDED` when available).

### Scenario 2: Reopen requires a reason (client-side validation)
**Given** I am an authorized Back Office Manager viewing a completed work order eligible for reopen  
**When** I open the â€œReopen Work Orderâ€ dialog  
**And** I leave the reason blank (or only whitespace)  
**Then** the Confirm button is disabled  
**And** an inline validation message is shown indicating the reason is required  
**And** no reopen API request is sent.

### Scenario 3: Unauthorized user cannot reopen
**Given** I am logged in as a user without permission `WORKORDER_REOPEN_COMPLETED`  
**And** I am viewing a work order with `status = COMPLETED`  
**Then** the â€œReopen Work Orderâ€ action is not shown (or is disabled with an access message)  
**When** I attempt to invoke the reopen endpoint (e.g., via direct request)  
**Then** the UI displays â€œAccess deniedâ€ on a 403 response  
**And** the work order remains unchanged after refresh.

### Scenario 4: Cannot reopen if invoice is issued/finalized
**Given** I am an authorized Back Office Manager  
**And** I am viewing a work order with `status = COMPLETED`  
**And** the work order is associated to an invoice with status `ISSUED` (or `FINALIZED`)  
**When** I attempt to reopen with a valid reason  
**Then** the backend responds with an error (409 or domain error) indicating invoiced work orders cannot be reopened  
**And** the UI displays â€œCannot reopen a work order that has been invoiced.â€  
**And** the work order remains unchanged after refresh.

### Scenario 5: Idempotency/double-submit does not create duplicate effects
**Given** I am an authorized Back Office Manager viewing an eligible completed work order  
**When** I click Confirm twice quickly (or resubmit due to a retry) with the same reason  
**Then** the UI prevents duplicate submission while the first request is in-flight  
**And** if a duplicate request is still sent and the backend returns a conflict/duplicate indicator  
**Then** the UI treats it as non-fatal, refreshes the work order, and shows the work order as reopened  
**And** the UI does not show multiple success toasts for the same action.

---

## 13. Audit & Observability

### User-visible audit data
- After successful reopen, show (if provided by backend):
  - reopened timestamp
  - reopened by (user identifier)
  - reopen reason
- Provide a link/expand section to view audit history (if endpoint exists).

### Status history
- If transitions/snapshots endpoints exist, display in a read-only table:
  - last completion snapshot id and status (`SUPERSEDED`)
  - reopen audit event type `WORKORDER_REOPENED`

### Traceability expectations
- Frontend includes correlation/request id headers if standard in project (TBD by repo conventions).
- UI logs (console) should not include PII beyond the reason text; prefer not logging reason at all.

---

## 14. Non-Functional UI Requirements

- **Performance:** Reopen submission should complete within 2s under normal conditions; show loading state and disable inputs during submission.
- **Accessibility:** Dialog must be keyboard navigable; focus trapped within dialog; error messages announced (ARIA).
- **Responsiveness:** Works on tablet and desktop widths; dialog fits viewport with scroll for long reason.
- **i18n/timezone:** Display reopened timestamps in userâ€™s local timezone; strings i18n-ready (no hardcoded concatenation). Currency not applicable.

---

## 15. Applied Safe Defaults

- SD-UI-EMPTY-STATE: Provide explicit empty-state text for missing snapshot/audit history; qualifies as safe because it does not change domain behavior, only improves UX clarity. (Impacted sections: UX Summary, Alternate / Error Flows)
- SD-UI-DOUBLE-SUBMIT-GUARD: Disable confirm button and show spinner during submit to prevent accidental duplicate actions; qualifies as safe because it reduces duplicate requests without affecting business rules. (Impacted sections: Functional Behavior, Acceptance Criteria)
- SD-ERR-MAP-HTTP: Map standard HTTP codes (400/403/404/409/5xx) to user-friendly messages; qualifies as safe because it follows implied backend contract and does not invent domain policy. (Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows)

---

## 16. Open Questions

1. **Endpoint contract:** What is the exact backend endpoint for reopen? (`POST /api/workorders/{id}/reopen` vs another path) and does it require `userId` in body/query or derive from auth?
2. **Invoice status exposure:** Which field(s) does the work order detail endpoint expose to determine â€œinvoice issued/finalizedâ€ or â€œinvoice-readyâ€? (e.g., `invoiceStatus`, `hasIssuedInvoice`, `invoiceReady`).
3. **Reason constraints:** Is there a maximum length and/or allowed character set for `reopenReason`? Should the UI enforce max length client-side?
4. **Audit/snapshot read APIs:** Are there existing endpoints in the Moqui-integrated backend to fetch:
   - last `AuditEvent` for `WORKORDER_REOPENED`
   - active/superseded `BillableScopeSnapshot` for the work order?
5. **Post-reopen editability:** Will the backend return an explicit editability policy (editableFields/readOnlyFields) per the backend story, or is that handled separately? Until defined, should the frontend keep all fields read-only even when reopened?
6. **Idempotency signaling:** How does the backend signal a duplicate reopen attempt (409 with specific error code vs 200 returning current state)? What error code/message should frontend key off?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Completion: Reopen Completed Workorder (Controlled)  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/214  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Completion: Reopen Completed Workorder (Controlled)

**Domain**: user

### Story Description

[Durion_Accounting_Event_Contract_v1.pdf](https://github.com/user-attachments/files/24300018/Durion_Accounting_Event_Contract_v1.pdf)

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Back Office Manager

## Trigger
A completed workorder needs correction after completion.

## Main Flow
1. Authorized user selects 'Reopen' and provides a mandatory reason.
2. System records reopen audit event and transitions workorder to Reopened (or InProgress per policy).
3. System unlocks specific editable fields per policy.
4. System marks prior billable scope snapshot as superseded.
5. System requires re-completion and re-snapshot before invoicing.

## Alternate / Error Flows
- User lacks permission â†’ block.
- Invoice already issued â†’ block reopen or require credit/rebill workflow (out of scope).

## Business Rules
- Reopen is an exception workflow with strict permissions and audit.
- Reopening invalidates invoice-ready snapshot.

## Data Requirements
- Entities: Workorder, BillableScopeSnapshot, AuditEvent
- Fields: status, reopenReason, reopenedBy, reopenedAt, supersededSnapshotVersion

## Acceptance Criteria
- [ ] Only authorized users can reopen completed workorders.
- [ ] Reopen is auditable and requires a reason.
- [ ] Invoice-ready snapshot is invalidated and must be regenerated.
- [ ] Reopen emits a single WorkorderReopened event
- [ ] Any completion-related accounting state is reversible
- [ ] Invoice eligibility is revoked if not yet invoiced
- [ ] Reopen requires authorization and records reason
- [ ] Repeated reopen attempts do not emit duplicate events

## Integrations

### Accounting
- Emits Event: WorkorderReopened
- Event Type: Non-posting (reversal / invalidation signal)
- Source Domain: workexec
- Source Entity: Workorder
- Trigger: Authorized reopen of a completed workorder
- Idempotency Key: workorderId + reopenVersion


## Notes for Agents
Donâ€™t allow silent edits after completion; reopen is the controlled escape hatch.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #215: [FRONTEND] [STORY] Completion: Complete Workorder and Record Audit  
File: ./scripts/story-work/frontend/215/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Completion: Complete Workorder and Record Audit

### Primary Persona
Service Advisor / Shop Manager

### Business Value
Enables an explicit, auditable â€œComplete Workorderâ€ action that finalizes execution, locks billable scope from uncontrolled edits, and triggers downstream processing (audit/accounting event emission) without creating AR/revenue.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor (or Shop Manager)  
**I want** to complete a work order via an explicit, permission-controlled action  
**So that** the execution is finalized with an audit trail, completion metadata is captured, further scope edits are locked, and downstream systems can react to a single, idempotent `WorkCompleted` event.

### In-scope
- UI action to complete a work order (from eligible states only)
- Capture completion notes and optional inspection outcome(s)
- Call Moqui backend transition/service to complete
- Display success/failure results and updated status
- Enforce â€œlockedâ€ UI behavior after completion (disable/hide execution edits)
- View completion audit metadata (who/when) and status history (read-only)

### Out-of-scope
- Defining/implementing the *precondition validation rules* themselves (explicitly referenced as â€œcovered by validation storyâ€)
- Reopen workflow (only respect that it exists; no UI authoring unless already present)
- Accounting/WIP ledger postings logic (frontend just triggers completion and surfaces backend result)
- Notification delivery to customer

---

## 3. Actors & Stakeholders

- **Primary Actor:** Service Advisor / Shop Manager (initiates completion, records notes)
- **Secondary Actor:** Mechanic (impacted by lockout; cannot edit scope after completion)
- **System Stakeholders:**
  - Audit subsystem (consumes/records audit events and transition history)
  - Accounting integration (consumes `WorkCompleted`; may finalize WIP if enabled)
  - Billing domain (acts later; completion must not create invoice/AR in this story)

---

## 4. Preconditions & Dependencies

### Preconditions (must be true before enabling/allowing completion)
1. Work order exists and is loadable by current user.
2. User is authenticated.
3. User has permission to complete a work order (exact permission key to be confirmed; see Open Questions).
4. Work order is in an eligible state for transition to `COMPLETED` per `WORKORDER_STATE_MACHINE.md` (see State Model).
5. â€œCompletion preconditions are satisfiedâ€ (specific rules are external to this story; UI must handle backend failure response and present reasons).

### Dependencies
- Backend endpoint/service to complete/transition work order to `COMPLETED` (contract must be confirmed; see Open Questions).
- Backend exposes work order details including current status and completion metadata (`completedAt`, `completedBy`, etc.).
- Backend exposes transition history and/or audit events (preferred) or includes enough in work order view to show completion audit fields.
- Backend enforces idempotency and emits `WorkCompleted` event exactly once; frontend must not attempt to synthesize events.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order detail screen: action button **Complete Workorder**
- Optional: from Work Order list row actions (if list exists in frontend; do not add if not already present)

### Screens to create/modify (Moqui)
1. **Modify existing** `workorder/WorkOrderDetail` screen (name illustrative; align to repo conventions)
   - Add an actions section with `transition`/`link` to completion dialog screen.
   - Add a read-only â€œCompletionâ€ section showing `completedAt`, `completedBy`, `completionNotes`, `inspectionOutcome` (if present).
   - Ensure edit controls for execution scope are disabled/hidden when status is `COMPLETED`.

2. **Create** a modal/dialog screen for completion:
   - `workorder/CompleteWorkOrderDialog` (modal)
   - Contains form fields for completion notes and optional inspection outcome(s)
   - Confirm action calls backend service; cancel returns to detail without change

### Navigation context
- Completion dialog launched from within work order context (workOrderId in parameters).
- After successful completion:
  - return to Work Order detail (same workOrderId)
  - refresh the work order data
  - show a toast/banner success message with new status

### User workflows
**Happy path**
1. User opens Work Order detail for a work order in an eligible state.
2. User clicks **Complete Workorder**.
3. Dialog shows completion form; user enters optional notes and optional inspection outcomes.
4. User confirms completion.
5. UI calls backend completion service.
6. On success: status updates to `COMPLETED`, completion metadata displayed, execution edits locked.

**Alternate paths**
- User cancels dialog â†’ no changes.
- Backend rejects due to failed preconditions â†’ UI shows blocking errors and keeps work order uncompleted.
- Backend rejects due to invalid state (already completed / cancelled / not eligible) â†’ UI shows error and refreshes.

---

## 6. Functional Behavior

### Triggers
- User action: click **Complete Workorder** then **Confirm Complete**

### UI actions
- **Complete Workorder button visibility/enabledness**
  - Visible when the user can view the work order.
  - Enabled only when:
    - status is eligible for completion (see State Model)
    - user has completion permission
  - Disabled state must include tooltip/help text: â€œCannot complete: <reason>â€ when reason is known (e.g., status not eligible). For validation preconditions, reason comes from backend.

- **Completion dialog form**
  - Fields:
    - Completion Notes (optional, multiline)
    - Inspection Outcome (optional; exact structure TBD)
  - Confirm button:
    - disabled while submitting
    - shows spinner/progress
  - Cancel button closes dialog

### State changes (frontend-observed)
- Before completion: work order in in-progress-related state (or other eligible state per backend)
- After successful completion:
  - work order status becomes `COMPLETED`
  - completion fields populated (completedAt, completedBy)
  - UI locks scope edits (see Business Rules)

### Service interactions
- Load work order details on entry and after completion.
- Submit completion request via Moqui service call (REST or Moqui transition service).
- On success: refresh detail and optionally fetch transition/audit history for display.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Completion must be explicit:
  - require user confirmation (dialog confirm) before calling backend
- Completion preconditions:
  - UI does not attempt to evaluate domain rules beyond status/permission gating
  - UI must render backend validation failures clearly and non-destructively
- Idempotency:
  - UI must prevent double-submit:
    - disable confirm button on submit
    - if user retries due to network failure, UI must handle â€œalready completedâ€ response gracefully (treat as success after refresh, if backend indicates completed)

### Enable/disable rules
- If status is `COMPLETED`:
  - Hide or disable â€œComplete Workorderâ€ action
  - Disable/hide all execution-scope editing actions (add/edit/remove parts/labor/fees) in the Work Order UI surface controlled by this frontend
- If status is `CANCELLED`:
  - Completion must not be possible (disabled/hidden)
- If status is not eligible:
  - Completion action disabled with explanation (status-based)

### Visibility rules
- Completion section visible when status is `COMPLETED` OR when completion fields exist.
- Completion notes visible only if present; otherwise show â€œNoneâ€.

### Error messaging expectations
- Invalid state: â€œWork order cannot be completed from status <status>.â€
- Preconditions fail: show list of failed checks from backend (if provided), else generic â€œCompletion requirements not met.â€
- Unauthorized: â€œYou donâ€™t have permission to complete work orders.â€
- Concurrency/409: â€œWork order changed since you opened it. Refresh and try again.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `WorkOrder` (authoritative for status and completion metadata)
- `WorkOrderStateTransition` and/or `AuditEvent` (for who/when/why; depends on available endpoint)
- `InspectionRecord` (optional outcomes; structure unclear)

### Fields
**WorkOrder**
- `workOrderId` (string/number; must match backend)
- `status` (enum/string; includes `COMPLETED`)
- `completedAt` (datetime, UTC)
- `completedBy` (userId)
- `completionNotes` (string/text, optional)
- `inspectionOutcome` (TBD; optional)
- Optional but useful:
  - `version` / `lastUpdatedStamp` for optimistic concurrency (if provided)

**Audit / Transition display (read-only)**
- `fromStatus`, `toStatus`, `transitionedAt`, `transitionedBy`, `reason`

### Read-only vs editable
- Before completion:
  - CompletionNotes/InspectionOutcome editable only within completion dialog at time of completion
- After completion:
  - completion fields are read-only
  - execution edits are locked (read-only)

### Derived/calculated fields
- Display â€œCompleted by <userDisplayName> at <localized time>â€ derived from `completedBy` + user lookup (if available) and `completedAt`.
- If user display names are not available, display userId.

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking note:** backend endpoints for completion in workexec state machine docs show `/api/workorders/{id}/start` and transition history endpoints, but do not explicitly define a `/complete` endpoint. This must be confirmed.

### Load/view calls
- `GET /api/workorders/{id}` (or `/api/work-orders/{id}`)  
  Used to load current `status` and completion fields.

- Optional (for audit UI):
  - `GET /api/workorders/{id}/transitions`
  - `GET /api/workorders/{id}/snapshots`

### Create/update calls
- None directly for completion (completion is a transition/command)

### Submit/transition calls
One of the following must exist (confirm which):
- `POST /api/workorders/{id}/complete` with body: `{ userId, reason?, completionNotes?, inspectionOutcome? }`
- OR generic transition endpoint: `POST /api/workorders/{id}/transition` with `{ toStatus: "COMPLETED", userId, reason, ... }`
- OR Moqui service such as `workexec.WorkOrderStateMachine.completeWorkOrder`

**Request fields expected (frontend needs)**
- `userId` (can come from session; avoid passing if backend derives; confirm)
- `reason` (optional; can default â€œWork order completedâ€)
- `completionNotes` (optional)
- `inspectionOutcome` (optional; TBD)

**Response expectations**
- HTTP 200 with updated work order status and completion fields, OR
- HTTP 201 with transition record, OR
- HTTP 409 if already completed / concurrency conflict (exact mapping TBD)

### Error handling expectations
- 400: validation failures (missing required fields, preconditions fail) â†’ show inline + banner
- 403: permission denied â†’ banner, disable action
- 404: work order not found â†’ navigate back with error
- 409: conflict/invalid transition due to state change â†’ prompt refresh
- 5xx: system error â†’ retry guidance

---

## 10. State Model & Transitions

### Allowed states (authoritative from `WORKORDER_STATE_MACHINE.md`)
- `DRAFT`
- `APPROVED`
- `ASSIGNED`
- `WORK_IN_PROGRESS`
- `AWAITING_PARTS`
- `AWAITING_APPROVAL`
- `READY_FOR_PICKUP`
- `COMPLETED`
- `CANCELLED`

### Allowed transitions (relevant subset)
- Completion is transition to `COMPLETED` from one of:
  - `WORK_IN_PROGRESS`
  - `AWAITING_PARTS`
  - `AWAITING_APPROVAL`
  - `READY_FOR_PICKUP`
  - (Possibly other states per backend FSM implementation; must not guess beyond documented transitionsâ€”see Open Questions)

### Role-based transitions
- Service Advisor / Shop Manager: allowed to complete (subject to permission)
- Others: typically not allowed

### UI behavior per state
- `WORK_IN_PROGRESS` / `AWAITING_PARTS` / `AWAITING_APPROVAL` / `READY_FOR_PICKUP`:
  - show â€œComplete Workorderâ€ action if permission allows
- `COMPLETED`:
  - show completion metadata
  - lock execution edits
- `CANCELLED`:
  - no completion action; read-only
- `DRAFT` / `APPROVED` / `ASSIGNED`:
  - no completion action (must be started first); read-only or limited edits depending on existing screens (do not expand scope here)

---

## 11. Alternate / Error Flows

### Validation failures (preconditions not satisfied)
- Backend returns 400 with structured list of failed conditions (if available)
- UI displays:
  - banner â€œCannot complete work orderâ€
  - list of reasons
  - keeps dialog open for user to review notes/outcome and cancel

### Concurrency conflicts
- If backend returns 409 due to stale status/version:
  - UI shows â€œWork order updated. Refreshingâ€¦â€
  - refresh work order data
  - re-evaluate action availability

### Unauthorized access
- If backend returns 403:
  - show permission error
  - disable completion action until next reload (or indefinitely)

### Empty states
- If audit/transition history endpoint returns empty:
  - show â€œNo transitions recordedâ€ (but completion fields still shown if completed)

---

## 12. Acceptance Criteria

### Scenario 1: Complete work order successfully from eligible state
**Given** a work order exists in status `READY_FOR_PICKUP` (or another completion-eligible status)  
**And** the logged-in user has permission to complete work orders  
**And** completion preconditions are satisfied by the backend  
**When** the user clicks â€œComplete Workorderâ€, enters optional completion notes, and confirms  
**Then** the frontend sends a completion transition request for that work order  
**And** the work order status is displayed as `COMPLETED` after refresh  
**And** `completedAt` and `completedBy` are shown in the UI  
**And** execution edit actions (add/edit/remove parts/labor/fees) are disabled/hidden.

### Scenario 2: Attempt completion when backend preconditions fail
**Given** a work order is in a completion-eligible status  
**And** the logged-in user has permission to complete work orders  
**But** backend completion preconditions are not satisfied  
**When** the user confirms completion  
**Then** the backend responds with a validation failure  
**And** the UI shows a blocking error message (including specific failed checks if provided)  
**And** the work order remains not completed (status unchanged after refresh)  
**And** no success toast is shown.

### Scenario 3: Attempt completion for already completed work order (idempotent UX)
**Given** a work order is already in status `COMPLETED`  
**When** the user navigates to the work order detail  
**Then** the â€œComplete Workorderâ€ action is not available  
**And** completion metadata is displayed read-only.

### Scenario 4: Double-submit protection
**Given** a completion dialog is open for a completion-eligible work order  
**When** the user clicks confirm completion  
**Then** the confirm button is disabled while the request is in flight  
**And** repeated clicks do not send duplicate completion requests.

### Scenario 5: Unauthorized completion attempt
**Given** a work order is in a completion-eligible status  
**And** the logged-in user lacks completion permission  
**When** the user attempts to complete the work order (via direct URL or UI if visible)  
**Then** the backend responds with 403 (or equivalent)  
**And** the UI shows an authorization error  
**And** the work order remains unchanged.

### Scenario 6: Conflict due to concurrent update
**Given** a work order is open in the UI  
**And** another user changes its status such that completion is no longer valid  
**When** the first user attempts to complete it  
**Then** the backend responds with 409 (or invalid transition)  
**And** the UI refreshes the work order and shows an actionable conflict message.

---

## 13. Audit & Observability

### User-visible audit data
- On completed work order detail, show:
  - Completed timestamp (`completedAt`, localized for display; stored UTC)
  - Completing user (`completedBy`)
  - Completion notes
  - Optional inspection outcome summary (if stored)

### Status history
- Provide a read-only list of transitions if endpoint exists:
  - includes the transition to `COMPLETED` with who/when/reason
- If only completion fields exist, minimum audit is the completion section.

### Traceability expectations
- All completion actions must be correlated:
  - frontend should include correlation/request ID header if standard in project (safe default only if existing)
  - log client-side errors with workOrderId context (non-PII)

---

## 14. Non-Functional UI Requirements

- **Performance:** completion action should respond within 2 seconds under normal conditions; show loading state if longer.
- **Accessibility:** dialog is keyboard navigable; focus is trapped within modal; buttons have accessible labels.
- **Responsiveness:** works on tablet widths (service desk usage).
- **i18n/timezone:** display `completedAt` in userâ€™s locale/timezone; store/send timestamps as provided by backend (UTC).
- **Security:** do not expose internal accounting payloads; do not log completion notes in client console logs.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Show â€œNoneâ€ for missing optional completion notes/outcomes; safe as it is purely presentational and does not change domain behavior. (Impacted: UX Summary, Data Requirements)
- SD-UX-SUBMIT-LOCK: Disable confirm button during submit to prevent duplicate requests; safe UI ergonomics. (Impacted: Functional Behavior, Acceptance Criteria, Error Flows)
- SD-ERR-HTTP-MAP: Standard mapping of 400/403/404/409/5xx to user messages without guessing business policy; safe because itâ€™s generic transport-level handling. (Impacted: Service Contracts, Error Flows)

---

## 16. Open Questions

1. **Completion endpoint contract:** What is the exact backend API/service for completing a work order in this system (path, method, request/response)? Is it `POST /api/workorders/{id}/complete`, a generic transition endpoint, or a Moqui service call?
2. **Eligible â€œfromâ€ statuses for completion:** Which work order statuses are allowed to transition to `COMPLETED` (authoritative list)? The FSM doc lists overall states but not explicit completion-from states.
3. **Permission key(s):** What permission/role gate should the frontend use (e.g., `WORKORDER_COMPLETE`)? Is it derived from Moqui security groups or via backend authorization only?
4. **Inspection outcome structure:** What is `inspectionOutcome` exactly (enum, free text, structured checklist)? Is it stored on `InspectionRecord` and linked to WorkOrder, or embedded on WorkOrder?
5. **Lock semantics in UI:** Which specific â€œexecution editsâ€ must be locked in the frontend after completion (parts, labor, fees, notes, assignments)? Are any fields still editable post-completion (e.g., internal notes)?
6. **Audit data source:** Should the frontend display audit via `WorkOrderStateTransition` endpoints (`/transitions`) or via a generic `AuditEvent` endpoint? Which exists in the Moqui backend?
7. **Idempotency UX:** If the completion request is retried and backend returns â€œalready completedâ€, should UI treat that as success (refresh + show completed) or as an error message?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Completion: Complete Workorder and Record Audit  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/215  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Completion: Complete Workorder and Record Audit

**Domain**: user

### Story Description

[Durion_Accounting_Event_Contract_v1.pdf](https://github.com/user-attachments/files/24300007/Durion_Accounting_Event_Contract_v1.pdf)

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor / Shop Manager

## Trigger
Completion preconditions are satisfied.

## Main Flow
1. User selects 'Complete Workorder'.
2. System transitions workorder to Completed state.
3. System records completion timestamp and completing user.
4. System stores completion notes and optional inspection outcomes.
5. System locks execution edits except via controlled reopen workflow.

## Alternate / Error Flows
- Completion attempted with failing preconditions â†’ block (covered by validation story).

## Business Rules
- Completion transition must be explicit and auditable.
- Completion locks billable scope unless reopened with permissions.

## Data Requirements
- Entities: Workorder, AuditEvent, InspectionRecord
- Fields: status, completedAt, completedBy, completionNotes, inspectionOutcome

## Acceptance Criteria
- [ ] Workorder transitions to Completed only when preconditions pass.
- [ ] Completion is auditable (who/when).
- [ ] Workorder is locked against uncontrolled edits.
- [ ] WorkCompleted event is emitted once per completion
- [ ] Event includes final billable scope and totals snapshot
- [ ] WIP accounting (if enabled) is finalized correctly
- [ ] Completion does not create AR or revenue
- [ ] Repeated completion attempts do not duplicate events

## Integrations

### Accounting
- Emits Event: WorkCompleted
- Event Type: Non-posting or Posting (WIP â†’ Finished, if enabled)
- Source Domain: workexec
- Source Entity: Workorder
- Trigger: Workorder transitioned to Completed state
- Idempotency Key: workorderId + completionVersion


## Notes for Agents
Treat completion as a state transition with strong validations and audit.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #216: [FRONTEND] [STORY] Completion: Finalize Billable Scope Snapshot  
File: ./scripts/story-work/frontend/216/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Completion: Finalize Billable Scope Snapshot (Finalize Work Order for Billing)

### Primary Persona
Service Advisor (primary), Manager/FinanceManager (for correction initiation actions if present)

### Business Value
Create an immutable, versioned, invoice-ready snapshot of authorized completed work so invoicing uses a stable source of truth and is auditable, while blocking invalid billing (completed-but-unauthorized items) and gating price/tax variances.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** to finalize a Work Order for billing by creating a versioned Billable Scope Snapshot and marking items invoice-ready,  
**So that** Billing can generate an invoice from an immutable snapshot rather than mutable work order items, with a clear audit trail and variance controls.

### In-scope
- Frontend UI to initiate â€œFinalize for Billingâ€ for a work order.
- Display of validation failures (unauthorized completed items, no billable items, variance detected).
- Variance approval UI gate (capture reason code; require elevated permission where applicable).
- Display snapshot result (version, totals, createdBy/createdAt, variance flags) and expose for back office review.
- Read-only behavior expectations after finalization (work order/item editing blocked in this UI surface).
- Ability to view snapshot versions/history for a work order (at least list + open details).

### Out-of-scope
- Implementing invoice generation itself (billing domain).
- Defining pricing/tax calculation logic (backend responsibility); frontend only displays results/variance payload.
- Full â€œcorrection workflowâ€ implementation details beyond initiating action if API exists (see Open Questions).
- Notification delivery.

---

## 3. Actors & Stakeholders
- **Service Advisor**: initiates finalization; reviews variance and approves if permitted.
- **Manager / FinanceManager**: may initiate corrections and approve variance when elevated approval required.
- **Billing / Back Office**: views snapshot totals and versions for review.
- **Auditor**: relies on immutable snapshot and audit metadata.
- **System**: performs snapshot creation, versioning, and state transitions.

---

## 4. Preconditions & Dependencies
- User is authenticated in POS frontend.
- A Work Order exists and is in a state that permits finalization (backend-enforced).
- Work Order has work order items with execution/authorization status data available to UI (for pre-check display and/or backend error rendering).
- Backend endpoints exist for:
  - Finalize/create snapshot (and variance approval flow if separate).
  - Retrieve snapshot list/details by work order.
- Moqui screens framework routing and authz integration is configured for Work Order views.

**Dependencies / Contracts not provided in inputs (blocking)**
- Exact REST/API endpoints and payloads for snapshot finalization and retrieval on Moqui side (see Open Questions).
- Exact Work Order statuses relevant to â€œready to complete / finalizeâ€ in frontend (backend story references `WorkComplete`, `FinalizedForBilling`, etc. but workexec FSM doc doesnâ€™t list these explicitly).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order detail screen: primary action button **â€œFinalize for Billingâ€** shown when work order is eligible.
- From back office review area (optional): link/tab **â€œBillable Snapshot(s)â€** within Work Order.

### Screens to create/modify
1. **Modify**: `WorkOrderDetail` screen
   - Add â€œFinalize for Billingâ€ action + status/totals panel for snapshot summary if exists.
2. **Create**: `WorkOrderBillableSnapshots` screen
   - List snapshots for a work order (version, status, totals, createdBy/createdAt, hasVariance).
3. **Create**: `BillableScopeSnapshotDetail` screen
   - Header totals + variance metadata + line items (read-only).
4. **(Optional, if correction initiation is supported now)**: `WorkOrderCorrectionInitiate` dialog/screen
   - Capture required reasonCode and submit.

### Navigation context
- Route pattern should be nested under Work Order:
  - `/workorders/:workOrderId/billing-snapshots`
  - `/workorders/:workOrderId/billing-snapshots/:snapshotId`
- â€œFinalize for Billingâ€ stays on Work Order detail.

### User workflows
**Happy path**
1. Service Advisor opens Work Order.
2. Clicks â€œFinalize for Billingâ€.
3. UI calls finalize service.
4. On success: UI shows confirmation, updates Work Order status display, and navigates to Snapshot Detail (v1) or opens a summary panel.

**Alternate paths**
- Unauthorized completed items exist â†’ UI shows blocking message listing items and instructs to authorize/remove (no finalize).
- No billable items â†’ UI shows blocking message.
- Variance detected â†’ UI shows variance details and a gated approval action (if user has permission); after approval, finalize proceeds and snapshot created.
- Already finalized â†’ UI hides/disabled finalize and offers â€œView Snapshot(s)â€.

---

## 6. Functional Behavior

### Triggers
- User clicks **Finalize for Billing** on an eligible Work Order.
- User clicks **Approve Variance & Finalize** when variance gate occurs (if supported).

### UI actions
- Render eligibility:
  - Show finalize action only when backend indicates eligible OR allow click and rely on backend error (prefer backend-driven eligibility flag if available).
- On finalize click:
  - Confirm dialog: â€œFinalizing creates an immutable snapshot for invoicing. Continue?â€
  - Submit finalize request with `workOrderId` and current user context.
- On variance gate:
  - Display variance details (tax/price differences) from backend error payload.
  - Provide input for `varianceReasonCode` (and/or free-text if required by backend).
  - Provide submit action; enforce required fields client-side where specified.

### State changes (frontend-visible)
- Work Order status changes to `FinalizedForBilling` (or equivalent) after success.
- Work Order items involved change to `InvoiceReady` (or equivalent) after success.
- Snapshot list gains new `snapshotVersion` and `snapshotStatus: Active`; prior version becomes `Superseded` if this is a correction re-finalize.

### Service interactions
- Call finalize snapshot creation service.
- Call snapshot list/detail load services.
- (If separate) Call variance approval service and then re-attempt finalize, or single finalize endpoint that accepts variance approval payload.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (UI responsibilities vs backend)
- **BR: Completed but Unauthorized hard block**
  - UI must surface as a blocking error; do not present â€œforce finalizeâ€.
  - Error message must identify affected items (at minimum by description + ID).
- **BR: No billable items**
  - UI shows blocking error: â€œNo billable items are available to be finalized.â€
- **BR: Price/Tax variance hard stop with approval gate**
  - UI must stop the finalize flow and show variance details.
  - UI must require explicit user action to approve variance.
  - UI must collect `varianceReasonCode` (required) and pass approver identity (implicit from session unless backend requires explicit `approverId`).
  - If backend indicates elevated permission required, UI must show authorization error and instruct user to have a Manager/FinanceManager approve.

### Enable/disable rules
- â€œFinalize for Billingâ€ button disabled when:
  - Work Order already finalized (has active snapshot / status indicates finalized).
  - A finalize call is in-flight (prevent double submission).
- â€œApprove varianceâ€ button disabled until required fields (reason code) are populated.

### Visibility rules
- Snapshot panels/links visible when:
  - At least one snapshot exists for work order.
- Variance approval UI only visible when variance error returned.

### Error messaging expectations
- Use user-safe language; do not leak internal stack traces.
- For 403: â€œYou donâ€™t have permission to approve this variance. Ask a Manager or Finance Manager.â€
- For 409 concurrency: â€œThis work order changed since you loaded it. Refresh and try again.â€
- For 422/400 validation: show field-level messages (reasonCode required, etc.).

---

## 8. Data Requirements

### Entities involved (frontend read models)
- `WorkOrder`
- `WorkOrderItem` (service/part/labor lines as applicable)
- `BillableScopeSnapshot`
- `BillableScopeSnapshotItem`
- `TaxSnapshot` (as part of snapshot header or line taxDetails)

### Fields (type, required, defaults)

**WorkOrder (minimum required for UI)**
- `workOrderId` (string/number, required)
- `status` (enum/string, required)
- `billableSnapshotActiveId` (id, optional)
- `billableSnapshotActiveVersion` (int, optional)

**WorkOrderItem (for error display and invoice-ready confirmation)**
- `workOrderItemId` (id, required)
- `description` (string, required)
- `authorized` (boolean, required) *(or derived from status)*
- `status` (enum/string, required) including `Completed` and `InvoiceReady`

**BillableScopeSnapshot**
- `snapshotId` (id, required)
- `workOrderId` (id, required)
- `snapshotVersion` (int, required)
- `snapshotStatus` (enum: `Active|Superseded|PendingReview`, required)
- `subtotalAmount` (money, required)
- `taxTotalAmount` (money, required)
- `feeTotalAmount` (money, required)
- `grandTotalAmount` (money, required)
- `hasVariance` (boolean, required)
- `varianceApprovedBy` (id, nullable)
- `varianceApprovedAt` (datetime UTC, nullable)
- `varianceReasonCode` (string, nullable unless variance approved)
- `correctsSnapshotId` (id, nullable)
- `createdByUserId` (id, required)
- `createdAt` (datetime UTC, required)

**BillableScopeSnapshotItem**
- `snapshotItemId` (id, required)
- `sourceWorkOrderItemId` (id, required)
- `description` (string, required)
- `quantity` (number, required)
- `unitPrice` (money, required)
- `lineTotal` (money, required)
- `taxDetails` (json/structured, required/optional per backend)
- `feeDetails` (json/structured, required/optional per backend)

### Read-only vs editable by state/role
- Snapshot entities: always read-only in UI.
- Work Order and items: read-only once status is `FinalizedForBilling` (or snapshot exists), except via separate correction workflow (not implemented here unless clarified).

### Derived/calculated fields (UI)
- UI may compute display-only sums from snapshot items for verification, but must treat backend snapshot totals as authoritative.

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: Moqui service names and/or REST endpoints are not provided in inputs; below is the required contract shape. Final names must be confirmed.

### Load/view calls
1. Load work order detail (existing):
   - `GET /api/workorders/{workOrderId}` (or Moqui screen data)
2. List snapshots for a work order:
   - `GET /api/workorders/{workOrderId}/billable-snapshots`
   - Response: array of `BillableScopeSnapshot` headers
3. Load snapshot detail:
   - `GET /api/billable-snapshots/{snapshotId}`
   - Response: snapshot header + items

### Create/update calls
1. Finalize for billing (create snapshot):
   - `POST /api/workorders/{workOrderId}/finalize-billing`
   - Request body (minimum):
     - `reason` (optional?) *(not specified)*
     - `varianceApproval` (optional object if variance must be approved inline):
       - `varianceReasonCode` (required when provided)
   - Success:
     - `201` with `snapshotId`, `snapshotVersion`, totals, updated work order status
2. Variance approval (if separate step):
   - `POST /api/workorders/{workOrderId}/finalize-billing/approve-variance`
   - Body: `varianceReasonCode` (+ any required fields)

### Submit/transition calls (Moqui transitions)
- `transition` on WorkOrderDetail: `finalizeBilling`
- Optional `transition` for variance approval

### Error handling expectations (mapping)
- `400/422`: validation error (missing reasonCode, etc.) â†’ show field errors
- `403`: permission denied â†’ show role-required message
- `404`: work order or snapshot not found â†’ show not-found empty state
- `409`: conflict (already finalized, concurrent changes) â†’ offer refresh and link to existing snapshot
- `409` for â€œvariance pendingâ€ or â€œunauthorized completed itemsâ€ may be encoded as domain error; UI must parse structured error payload if provided, else display message.

---

## 10. State Model & Transitions

### Allowed states (known from provided references)
Work Order FSM doc (authoritative for execution) includes:
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

Backend snapshot story additionally references:
- `WorkComplete` (or similar) and `FinalizedForBilling`, `ReviewRequired`

**Conflict/Gap (blocking):**
- Finalization-related statuses (`FinalizedForBilling`, `ReviewRequired`, `WorkComplete`) are not present in the provided WorkOrder FSM doc. Frontend needs the actual enumerations to render status and eligibility deterministically.

### Role-based transitions
- Service Advisor: can initiate finalize-for-billing (assuming permission).
- Manager/FinanceManager: can approve variance when elevated approval required; can initiate correction (if endpoint exists).

### UI behavior per state
- If Work Order status indicates already finalized:
  - Disable/hide finalize action
  - Show link to active snapshot
- If Work Order is not in a â€œfinalizableâ€ completion state:
  - Hide finalize action or show disabled with tooltip â€œWork must be completed before finalizing for billing.â€

---

## 11. Alternate / Error Flows

### Validation failures
1. **Completed but Unauthorized items exist**
   - Show blocking error with list of items requiring authorization/removal.
   - Provide navigation to items section (anchor) but do not implement authorization in this story.
2. **No billable items**
   - Show error and keep user on Work Order detail.
3. **Variance detected**
   - Show variance modal with details and required approval.
   - If user lacks permission, show 403-style messaging and stop.

### Concurrency conflicts
- If finalize returns conflict because snapshot already exists / version advanced:
  - Reload work order and snapshots
  - Navigate to active snapshot
  - Show toast: â€œWork order was already finalized.â€

### Unauthorized access
- If user lacks permission to finalize:
  - Show authorization error; action remains disabled.

### Empty states
- Snapshot list empty: show â€œNo billable snapshots yet.â€
- Snapshot detail missing: show not found and link back to Work Order.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Finalize creates snapshot and marks invoice-ready (happy path)
**Given** a Work Order is eligible for billing finalization and has Work Order Items that are **Completed** and **Authorized**  
**When** the Service Advisor clicks â€œFinalize for Billingâ€ and confirms  
**Then** the system creates a new Billable Scope Snapshot with the next sequential version and status `Active`  
**And** the UI navigates to the Snapshot Detail view showing snapshot totals and createdBy/createdAt  
**And** the Work Order status displayed in the UI updates to the finalized-for-billing status  
**And** the included Work Order Items show invoice-ready status (or the UI reflects invoice-ready via refreshed data)

### Scenario 2: Hard block when any completed item is not authorized
**Given** a Work Order has at least one item that is **Completed** but not **Authorized**  
**When** the Service Advisor attempts to â€œFinalize for Billingâ€  
**Then** the finalization request fails and no snapshot is created  
**And** the UI shows a blocking error identifying the unauthorized completed item(s)  
**And** the â€œFinalize for Billingâ€ action remains available after the user addresses authorization outside this flow

### Scenario 3: Block when no billable items exist
**Given** a Work Order has no items that are both **Completed** and **Authorized**  
**When** the Service Advisor attempts to â€œFinalize for Billingâ€  
**Then** the request fails  
**And** the UI shows â€œNo billable items are available to be finalized.â€  
**And** no snapshot list entry is created

### Scenario 4: Variance detected requires explicit approval before snapshot creation
**Given** a Work Order has Completed and Authorized items  
**And** the backend detects a price or tax variance versus the authorized basis  
**When** the Service Advisor attempts to â€œFinalize for Billingâ€  
**Then** the UI shows a variance blocking message/modal including variance details  
**And** the UI requires a variance reason code before enabling â€œApprove Variance & Finalizeâ€  
**When** the user submits variance approval with a reason code  
**Then** the snapshot is created with `hasVariance=true` and variance approval metadata is visible on the snapshot detail

### Scenario 5: Variance approval requires elevated permission
**Given** variance approval requires elevated permission for the detected variance  
**When** a non-privileged Service Advisor attempts to approve the variance  
**Then** the request is rejected with an authorization error  
**And** the UI instructs the user to have a Manager/FinanceManager approve  
**And** no snapshot is created

### Scenario 6: Snapshot versions are viewable for back office review
**Given** a Work Order has one or more billable snapshots  
**When** the user opens â€œBillable Snapshot(s)â€ from the Work Order  
**Then** the UI lists snapshots with version, status, totals, and created metadata  
**And** selecting a snapshot opens a read-only detail view with line items and totals

### Scenario 7: Concurrencyâ€”already finalized by another user
**Given** the Work Order is finalized by another user while the Service Advisor is viewing it  
**When** the Service Advisor attempts to finalize  
**Then** the UI receives a conflict response  
**And** the UI refreshes and navigates to the active snapshot (if available)  
**And** the UI shows a message indicating it was already finalized

---

## 13. Audit & Observability

### User-visible audit data
- Snapshot detail must display:
  - `snapshotVersion`, `snapshotStatus`
  - `createdByUserId` (render as username if available) and `createdAt` (UTC-aware display)
  - `hasVariance` and, if true: `varianceApprovedBy`, `varianceApprovedAt`, `varianceReasonCode`
  - `correctsSnapshotId` if present (link to prior snapshot)

### Status history
- Snapshot list provides version history; if correction exists, show relationship (e.g., â€œCorrects v1â€).

### Traceability expectations
- Every snapshot item displays `sourceWorkOrderItemId` (may be hidden behind â€œDetailsâ€ but must be accessible).
- Frontend should pass a correlation/request id header if project convention exists (not provided; see safe defaults/observability boilerplate allowed).

---

## 14. Non-Functional UI Requirements
- **Performance**: Snapshot list and detail should render within 2s for up to 200 snapshot items; use pagination/virtual scroll if needed.
- **Accessibility**: Modal dialogs focus-trapped; buttons labeled; errors announced via ARIA live region.
- **Responsiveness**: Works on tablet resolutions used at service desk.
- **i18n/timezone/currency**:
  - Currency formatting based on store locale (if available) or user locale.
  - Timestamps displayed in shop local time with UTC stored value indicated (do not convert stored value).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for snapshot list/detail; qualifies as safe UI ergonomics; impacts UX Summary, Alternate/Empty states.
- SD-UX-INFLIGHT-GUARD: Disable submit buttons during in-flight finalize/approve calls to prevent double submit; safe because it doesnâ€™t alter domain rules; impacts Functional Behavior, Error Flows.
- SD-ERR-HTTP-MAP: Standard mapping of 400/403/404/409 to user messaging; safe because it follows implied backend contract and does not invent policy; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Backend/Moqui contract:** What are the exact Moqui service names or REST endpoints for:
   - finalizing for billing (snapshot creation),
   - listing snapshots by work order,
   - loading snapshot detail,
   - variance approval (inline vs separate)?
2. **Authoritative Work Order statuses:** What exact status enum values should the frontend use for:
   - â€œeligible to finalizeâ€ (e.g., `READY_FOR_PICKUP` vs `COMPLETED` vs `WorkComplete`),
   - â€œfinalized for billingâ€ (`FinalizedForBilling`),
   - â€œreview requiredâ€ (`ReviewRequired`)?
   The provided FSM doc does not include `FinalizedForBilling`/`ReviewRequired`.
3. **Variance payload shape:** When variance is detected, what structured fields are returned for display (line-level vs header-level variance, tax rate differences, thresholds, required approval role)?
4. **Variance approval input:** Is `varianceReasonCode` the only required field, or is free-text required as well? Is a controlled reason-code list required (and where is it sourced)?
5. **Who is recorded as initiator/approver:** Does backend infer `createdByUserId/varianceApprovedBy` from auth context, or must frontend pass explicit userId?
6. **Correction initiation scope:** Is â€œinitiate correctionâ€ part of this frontend story (and is there an API), or should the frontend only enforce read-only state and show snapshot versions?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Completion: Finalize Billable Scope Snapshot  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/216  
Labels: frontend, story-implementation, user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
Workorder is ready to be completed and prepared for invoicing.

## Main Flow
1. System compiles all authorized and completed items into a billable scope snapshot.
2. System validates quantities, pricing, taxes, and fees basis for invoicing.
3. System marks items as invoice-ready and stores snapshot version.
4. System records who initiated snapshot and when.
5. System exposes snapshot totals for back office review.

## Alternate / Error Flows
- Items completed but not authorized â†’ block or flag for approval per policy.
- Tax configuration changes since estimate â†’ store variance and require review.

## Business Rules
- Invoice derives from billable scope snapshot, not from live mutable items.
- Snapshot must be versioned and auditable.

## Data Requirements
- Entities: BillableScopeSnapshot, WorkorderItem, TaxSnapshot
- Fields: snapshotVersion, invoiceReadyFlag, taxAmount, feeTotal, grandTotal, varianceReason

## Acceptance Criteria
- [ ] System creates a billable scope snapshot that matches completed authorized work.
- [ ] Snapshot is versioned and retrievable.
- [ ] Items are marked invoice-ready.

## Notes for Agents
Snapshot is your source of truth for invoicing; do not compute invoices off mutable live items.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #217: [FRONTEND] [STORY] Completion: Resolve Approval-Gated Change Requests  
File: ./scripts/story-work/frontend/217/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Completion: Resolve Approval-Gated Change Requests

### Primary Persona
Service Advisor (Back Office / Front Counter)

### Business Value
Ensure work orders cannot be completed while approval-gated change requests are unresolved, and provide an explicit, auditable workflow to approve/decline/override change requests so the work order reflects authorized work and completion blockers are transparent.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to view and resolve all approval-gated change requests for a work order (approve, decline, and handle emergency denial acknowledgment where applicable)  
- **So that** the work order can move to completion states only when authorized work is correctly reflected and all compliance/audit requirements are met.

### In Scope
- Work order â€œCompletion blockersâ€ UI that highlights unresolved approval-gated change requests.
- List + detail view of change requests associated to a work order.
- Advisor actions to:
  - Approve a change request (with required approval note).
  - Decline a change request (with required approval note).
  - For emergency exceptions that were declined: record customer denial acknowledgment (to unblock closure).
- Read-only display of audit-relevant fields: who/when/what decision, approval notes, status.
- Integration with backend endpoints listed in `CHANGE_REQUEST_WORKFLOW.md` and work order â€œcan-closeâ€ check.

### Out of Scope
- Creating change requests (technician flow).
- Editing change request item lines, prices, or inventory allocation/consumption.
- Customer-facing approval capture methods (signature, electronic signature) for **estimates** (separate workflow).
- Work order state transitions UI beyond showing â€œblocked/unblockedâ€ and â€œcan closeâ€ status (unless already exists).

---

## 3. Actors & Stakeholders

- **Primary Actor:** Service Advisor
- **Supporting Actors:**
  - Back Office Manager (may handle escalations; see open questions re: override)
  - Technician (downstream consumer of approved items)
- **System Actors:** POS/Moqui UI, Workexec backend APIs
- **Stakeholders:** Audit/compliance, Shop management

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- A Work Order exists and is in an execution lifecycle state where change requests are relevant (backend rules mention `IN_PROGRESS` for creation; resolution should be allowed at least when CR exists).
- Work order has **one or more** associated Change Requests retrievable via:
  - `GET /api/work-orders/{workOrderId}/change-requests`

### Dependencies
- Backend endpoints available (from authoritative workexec docs):
  - `GET /api/work-orders/{workOrderId}/change-requests`
  - `GET /api/change-requests/{id}`
  - `POST /api/change-requests/{id}/approve`
  - `POST /api/change-requests/{id}/decline`
  - `POST /api/change-requests/{id}/acknowledge-denial`
  - `GET /api/work-orders/{workOrderId}/can-close`
- Work order status machine exists (from `WORKORDER_STATE_MACHINE.md`) and completion gating is enforced by backend.
- Moqui frontend project conventions for:
  - Screen routing / parameter naming (unknown from provided inputs; see Open Questions).
  - Auth token propagation to backend.

---

## 5. UX Summary (Moqui-Oriented)

### Entry Points
- From an existing Work Order detail screen: a â€œChange Requestsâ€ panel/section and/or a â€œResolve blockersâ€ callout shown when unresolved approval-gated change requests exist.
- From a â€œCompletionâ€ step/section: if completion is blocked, provide a direct navigation link to â€œResolve Change Requestsâ€.

### Screens to Create/Modify
1. **Modify**: Work Order detail screen (existing)
   - Add a â€œCompletion Blockersâ€ summary widget:
     - Shows if pending change requests exist.
     - Shows `canClose` result (true/false) and, if false, â€œwhyâ€ summary (minimum: â€œPending change requestsâ€ and/or â€œEmergency denial acknowledgment requiredâ€).
     - Link to Change Requests screen.
2. **Create**: `WorkOrderChangeRequests` screen
   - Route expects `workOrderId` parameter.
   - Displays list of change requests for the work order, grouped by status (at minimum: awaiting advisor review, approved, declined, cancelled).
   - Each list item navigates to detail/resolution screen.
3. **Create**: `ChangeRequestDetail` screen
   - Route expects `changeRequestId` and includes `workOrderId` for back navigation.
   - Shows request description, emergency flags/evidence fields, and associated items (services/parts) with their statuses.
   - Provides action buttons (Approve/Decline/Acknowledge Denial) depending on state.

### Navigation Context
- Breadcrumb-like behavior:
  - Work Order â†’ Change Requests â†’ Change Request Detail
- After action success (approve/decline/ack):
  - Return to Change Requests list with refreshed statuses and updated â€œcan closeâ€ status.

### User Workflows

#### Happy Path: Approve
1. Advisor opens work order; sees completion blocked due to pending change requests.
2. Advisor opens Change Requests list, selects a pending request.
3. Advisor clicks â€œApproveâ€, enters required approval note, confirms.
4. UI shows success; request moves to APPROVED; list refreshes; if all resolved and no other blockers, â€œcan closeâ€ becomes true.

#### Happy Path: Decline + Emergency Acknowledgment
1. Advisor declines an emergency exception request (status becomes DECLINED).
2. UI displays a required next step: â€œCustomer denial acknowledgment required before closing.â€
3. Advisor records acknowledgment via â€œAcknowledge Denialâ€.
4. UI refreshes `canClose` and removes the emergency acknowledgment blocker once satisfied.

#### Alternate: Customer Unreachable
- Advisor takes no action; request remains awaiting review; completion remains blocked.

---

## 6. Functional Behavior

### Triggers
- Screen load of Work Order detail triggers:
  - Load change request summary for the work order.
  - Load `can-close` status.
- Entering Change Requests list triggers:
  - Load list of change requests for work order.
- Entering Change Request detail triggers:
  - Load change request detail (optional if list payload is insufficient).

### UI Actions
- From Change Request detail:
  - **Approve**: opens modal form requiring `approvalNote`, then submits approve endpoint.
  - **Decline**: opens modal form requiring `approvalNote`, then submits decline endpoint.
  - **Acknowledge Denial**: confirmation dialog, then submits acknowledge endpoint.

### State Changes (Frontend-Visible)
- ChangeRequest `status` updates after approve/decline.
- For emergency denial acknowledgment:
  - associated emergency items get `customerDenialAcknowledged=true` (may not be returned; UI should refresh detail and/or can-close).
- Work order closure eligibility updates based on `GET can-close`.

### Service Interactions (Moqui-Oriented)
- Each action is implemented as a Moqui screen transition calling a service (service wraps REST call).
- Services must be invoked with:
  - authenticated context
  - correlation/request id if project supports it (safe default only for observability plumbing)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Approve/Decline requires **non-empty** `approvalNote`.
  - UI: block submit, show inline error â€œApproval note is required.â€
- Acknowledge Denial:
  - Only enabled if change request is flagged emergency exception **and** is in `DECLINED` status (per backend rules).
  - UI: hide/disable otherwise.

### Enable/Disable Rules
- Approve/Decline buttons enabled only when ChangeRequest status is `AWAITING_ADVISOR_REVIEW`.
- If work order is not in an allowed state for resolution (unclear), UI should still render read-only and rely on backend errors; see Open Questions.

### Visibility Rules
- Show â€œEmergency/Safetyâ€ section if:
  - change request `isEmergencyException=true` OR any item has emergency/safety flag.
- Show â€œCompletion blockedâ€ banner on work order if:
  - Any change request is awaiting advisor review OR
  - `can-close=false` due to emergency denial acknowledgment missing.

### Error Messaging Expectations
- For 400 validation errors: show field-level message when possible; otherwise show â€œUnable to submit: <message>â€.
- For 403: show â€œYou donâ€™t have permission to perform this action.â€
- For 409: show â€œThis change request was updated by another user. Refresh and try again.â€
- For 404: show â€œChange request not found.â€

---

## 8. Data Requirements

### Entities Involved (Frontend View Models)
- **WorkOrder** (read-only in this story)
  - `workOrderId`
  - `status` (from work order FSM)
- **ChangeRequest**
  - `id`
  - `workOrderId`
  - `requestedByUserId`
  - `requestedAt`
  - `status` (expected: `AWAITING_ADVISOR_REVIEW`, `APPROVED`, `DECLINED`, `CANCELLED`)
  - `description` (required)
  - `isEmergencyException` (boolean)
  - `exceptionReason` (string)
  - `approvalNote` (string; used as artifact for approve/decline per rules)
  - `approvedAt`, `approvedBy`
  - `declinedAt`
  - `supplementalEstimatePdfId` (optional, read-only)
- **WorkOrderService / WorkOrderPart** (as child display of change request)
  - `id`
  - `changeRequestId`
  - `status` (expected: `PENDING_APPROVAL`, `READY_TO_EXECUTE`, `CANCELLED`, etc.)
  - Emergency fields:
    - `isEmergencySafety` (boolean)
    - `photoEvidenceUrl` (string)
    - `photoNotPossible` (boolean)
    - `emergencyNotes` (string)
    - `customerDenialAcknowledged` (boolean)

### Field Types / Required / Defaults
- `approvalNote`: required on approve/decline; default empty in UI form.
- `exceptionReason`: display-only here; if backend supports entry for override, thatâ€™s a separate action (see Open Questions).

### Read-only vs Editable
- Editable in this story:
  - `approvalNote` input when approving/declining.
- Everything else read-only.

### Derived/Calculated Fields
- `hasPendingChangeRequests` derived from list where `status==AWAITING_ADVISOR_REVIEW`.
- `requiresEmergencyAcknowledgment` derived if:
  - exists change request with `isEmergencyException==true` AND `status==DECLINED` AND any associated emergency item `customerDenialAcknowledged==false`
  - If backend only returns `can-close` boolean, UI may not be able to derive â€œwhyâ€; see Open Questions.

---

## 9. Service Contracts (Frontend Perspective)

> Note: Backend contracts are partially specified; schemas are not fully defined. Frontend must treat response bodies as TBD beyond fields used.

### Load / View Calls
1. **List change requests for work order**
   - `GET /api/work-orders/{workOrderId}/change-requests`
   - Expected: array of ChangeRequest summaries; ideally includes status, description, emergency flag, requestedAt
2. **Load change request detail**
   - `GET /api/change-requests/{id}`
   - Expected: ChangeRequest plus associated services/parts (or references)
3. **Check if work order can close**
   - `GET /api/work-orders/{workOrderId}/can-close`
   - Expected: boolean response body (`true|false`) per doc

### Submit Calls
1. **Approve**
   - `POST /api/change-requests/{id}/approve`
   - Request body (per doc):
     ```json
     { "approvedBy": <userId>, "approvalNote": "<text>" }
     ```
2. **Decline**
   - `POST /api/change-requests/{id}/decline`
   - Request body (per doc):
     ```json
     { "approvalNote": "<text>" }
     ```
3. **Acknowledge Denial**
   - `POST /api/change-requests/{id}/acknowledge-denial`
   - No body

### Error Handling Expectations
- Map HTTP codes:
  - 400 â†’ validation (show message)
  - 401 â†’ session expired (redirect to login)
  - 403 â†’ permission denied
  - 404 â†’ missing entity
  - 409 â†’ concurrency conflict / invalid state transition
  - 5xx â†’ â€œSystem error, try againâ€

---

## 10. State Model & Transitions

### ChangeRequest State (from authoritative doc)
- `AWAITING_ADVISOR_REVIEW` (actionable)
- `APPROVED` (terminal for this story)
- `DECLINED` (terminal for decision; may require acknowledgment for emergency)
- `CANCELLED` (terminal)

### Allowed Transitions (UI-enforced)
- `AWAITING_ADVISOR_REVIEW` â†’ `APPROVED` via Approve action
- `AWAITING_ADVISOR_REVIEW` â†’ `DECLINED` via Decline action
- `DECLINED` + `isEmergencyException=true` â†’ (acknowledgment recorded; state may remain `DECLINED`)

### Role-based Transitions (UI expectations; authorization enforced by backend)
- Service Advisor: approve/decline
- Manager/Advisor: acknowledge denial (unclear if restricted)
- Technician: no actions in this story UI

### UI Behavior per State
- AWAITING_ADVISOR_REVIEW: show Approve/Decline actions; show blocking banner.
- APPROVED: show read-only decision info; no actions.
- DECLINED: show read-only decision info; if emergency exception, show acknowledgment status and â€œAcknowledge Denialâ€ if not yet acknowledged.
- CANCELLED: read-only.

---

## 11. Alternate / Error Flows

### Validation Failures
- Missing approval note on approve/decline:
  - UI prevents submit; if server returns 400, show message from server.
- Attempt acknowledge when not allowed:
  - UI should not present action; if forced (deep link), handle 400/409 gracefully.

### Concurrency Conflicts
- Another advisor resolves the change request while current user is viewing:
  - On submit â†’ backend returns 409 or 400 invalid state; UI shows â€œAlready resolvedâ€ and refreshes detail.

### Unauthorized Access
- If user lacks permission:
  - Action returns 403; UI keeps state, shows permission message, logs event.

### Empty States
- No change requests for work order:
  - Change Requests list shows â€œNo change requests for this work order.â€
  - Work order blockers widget shows none.

### Backend Unreachable / Timeout
- Show non-destructive error and retry option; do not change UI state optimistically unless project standard supports it (not specified).

---

## 12. Acceptance Criteria

### Scenario 1: Pending change requests are visible and block completion
**Given** a work order has at least one change request with status `AWAITING_ADVISOR_REVIEW`  
**When** the Service Advisor opens the Work Order detail screen  
**Then** the UI shows a completion blocker indicating pending change requests  
**And** the UI provides a navigation link to the Change Requests screen for that work order.

### Scenario 2: List change requests for a work order
**Given** a work order has change requests in multiple statuses  
**When** the Service Advisor navigates to the Work Order Change Requests screen  
**Then** the UI lists all change requests returned by `GET /api/work-orders/{workOrderId}/change-requests`  
**And** each list entry shows at minimum: description, status, requestedAt, and emergency flag (if present)  
**And** selecting an entry navigates to the Change Request detail view.

### Scenario 3: Approve requires an approval note and updates UI state
**Given** a change request is in status `AWAITING_ADVISOR_REVIEW`  
**When** the Service Advisor clicks â€œApproveâ€ and submits an empty approval note  
**Then** the UI blocks submission and displays â€œApproval note is required.â€  

**Given** a change request is in status `AWAITING_ADVISOR_REVIEW`  
**When** the Service Advisor submits â€œApproveâ€ with a non-empty approval note  
**Then** the UI calls `POST /api/change-requests/{id}/approve` with `approvedBy` and `approvalNote`  
**And** on success, the UI refreshes the change request data showing status `APPROVED`  
**And** the approve/decline actions are no longer available.

### Scenario 4: Decline requires an approval note and updates UI state
**Given** a change request is in status `AWAITING_ADVISOR_REVIEW`  
**When** the Service Advisor submits â€œDeclineâ€ with a non-empty approval note  
**Then** the UI calls `POST /api/change-requests/{id}/decline` with `approvalNote`  
**And** on success, the UI refreshes the change request data showing status `DECLINED`  
**And** the approve/decline actions are no longer available.

### Scenario 5: Declined emergency exception requires customer denial acknowledgment to close
**Given** a work order has a change request where `isEmergencyException=true` and status `DECLINED`  
**And** emergency items under the request have `customerDenialAcknowledged=false`  
**When** the Service Advisor opens the work order  
**Then** the UI indicates the work order cannot close (via `GET /api/work-orders/{workOrderId}/can-close` returning `false`)  
**And** the Change Request detail screen shows an â€œAcknowledge Denialâ€ action.

### Scenario 6: Acknowledge denial updates closure eligibility
**Given** a change request is flagged emergency exception and is in status `DECLINED`  
**When** the Service Advisor confirms â€œAcknowledge Denialâ€  
**Then** the UI calls `POST /api/change-requests/{id}/acknowledge-denial`  
**And** the UI refreshes `GET /api/work-orders/{workOrderId}/can-close`  
**And** if the backend returns `true`, the UI indicates the completion blocker is cleared.

### Scenario 7: Concurrency protection on approve/decline
**Given** a Service Advisor has a change request detail open in status `AWAITING_ADVISOR_REVIEW`  
**And** another user resolves the change request before submission  
**When** the first advisor submits approve/decline  
**Then** the UI shows a conflict message and refreshes the change request detail to show the latest status.

### Scenario 8: Permission denied
**Given** a user without permission attempts to approve a change request  
**When** they submit approval  
**Then** the backend returns 403  
**And** the UI shows a permission error and leaves the change request unchanged in the UI.

---

## 13. Audit & Observability

### User-visible Audit Data
- On Change Request detail, show:
  - status
  - requestedAt/requestedBy (if available)
  - approvedAt/approvedBy (if approved)
  - declinedAt (if declined)
  - approvalNote (read-only display; consider masking policy if requiredâ€”unknown)
  - emergency acknowledgment state per item (if returned)

### Status History
- Not implementing full transition history UI unless backend provides it for change requests (not specified).  
- At minimum, show current status + timestamps from the ChangeRequest resource.

### Traceability Expectations
- Each approve/decline/ack action should:
  - include workOrderId and changeRequestId in logs (frontend console logging is insufficient; use project logging mechanism if present).
  - preserve backend correlation id if Moqui supports it (implementation detail).

---

## 14. Non-Functional UI Requirements

- **Performance:** Change Requests list should load within 2 seconds on typical broadband for up to 50 change requests (pagination behavior depends on API; see safe defaults).
- **Accessibility:** All actions reachable via keyboard; dialogs have focus trap; form errors announced to screen readers.
- **Responsiveness:** Mobile-friendly layout; list and detail usable on tablet.
- **i18n/timezone:** Display timestamps in store/user-local time if application provides; otherwise display ISO with timezone indicator (needs project convention; see Open Questions).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging for â€œno change requestsâ€ because it is UI ergonomics and does not alter domain behavior. Impacted sections: UX Summary, Alternate/Empty states.
- SD-UX-RETRY: Provide a manual retry affordance on transient load failures because it is recoverable and does not change domain logic. Impacted sections: Alternate/Error flows.
- SD-UX-LIST-PAGINATION-CLIENT: If the API does not support pagination, render a client-side â€œshow first 50 + filterâ€ behavior to avoid UI stalls; safe as itâ€™s presentation-only. Impacted sections: Non-functional, UX Summary.

---

## 16. Open Questions

1. **Moqui routing & screen placement:** What are the canonical screen paths/parameter names for Work Order detail in `durion-moqui-frontend` (e.g., `/workorders/ViewWorkOrder?workOrderId=`)? We need this to wire entry points and transitions correctly.  
2. **Backend payload shapes:** Do `GET /api/work-orders/{workOrderId}/change-requests` and `GET /api/change-requests/{id}` return associated service/part items (including `customerDenialAcknowledged`), or only the ChangeRequest header? UI needs item-level acknowledgment visibility.  
3. **Approval â€œsubmitted for customer approvalâ€ step:** The provided frontend story mentions â€œsubmit requests for customer approval (if not already submitted)â€ but the authoritative change request workflow only describes advisor approve/decline (internal). Is there a separate â€œsend to customerâ€ action/endpoint for change requests? If yes, provide endpoint and states.  
4. **Emergency override semantics conflict:** The backend reference story describes â€œApproved-With-Exceptionâ€ and a manager override with `exceptionReason`, but the authoritative `CHANGE_REQUEST_WORKFLOW.md` does not include that state/action (it instead has emergency handling + denial acknowledgment). Which model is correct for frontend? If override exists, provide endpoint, required fields, and authorization.  
5. **Authorization rules:** Which roles can approve/decline/acknowledge-denial in the frontend? Are there separate permissions (e.g., advisor vs manager)? UI needs to hide/disable actions appropriately.  
6. **Work order completion gating UX:** Should the frontend attempt a â€œcomplete/ready-for-pickupâ€ transition and display the backendâ€™s failure reason (AC1 in backend story), or is completion handled elsewhere? If completion action exists in UI, provide the endpoint and error schema for â€œblocked by pending change requests.â€

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Completion: Resolve Approval-Gated Change Requests  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/217  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Completion: Resolve Approval-Gated Change Requests

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor / Back Office

## Trigger
Workorder contains one or more approval-gated change requests.

## Main Flow
1. User views outstanding change requests tied to the workorder.
2. User submits requests for customer approval (if not already submitted).
3. System records approval/rejection outcomes.
4. Approved requests add authorized items to the workorder; rejected requests remain excluded.
5. System clears the completion block when all requests are resolved.

## Alternate / Error Flows
- Customer unreachable â†’ leave request pending and keep workorder incomplete.
- Emergency exception policy invoked â†’ record exception and proceed per policy.

## Business Rules
- All approval-gated requests must be resolved before completion (unless exception).
- Approvals must be linked to added items.

## Data Requirements
- Entities: ChangeRequest, ApprovalRecord, WorkorderItem
- Fields: changeRequestId, status, approvalId, resolutionAt, resolutionBy, exceptionReason

## Acceptance Criteria
- [ ] Pending change requests block completion.
- [ ] Resolved approvals correctly add or exclude items.
- [ ] Resolution is auditable.

## Notes for Agents
Make resolution visible; operators should never guess whatâ€™s blocking completion.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #218: [FRONTEND] [STORY] Completion: Validate Completion Preconditions  
File: ./scripts/story-work/frontend/218/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Completion: Validate Completion Preconditions (Checklist + Block Completion)

### Primary Persona
Service Advisor (or any authorized user attempting to complete a Work Order)

### Business Value
Prevent invoice disputes and revenue leakage by ensuring a Work Order cannot be marked **COMPLETED** unless required work, parts/labor reconciliation, and approval-gated change requests are resolved, with clear actionable guidance for remediation.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor (or authorized user)
- **I want** the POS UI to validate Work Order completion preconditions and show a completion checklist
- **So that** I can only complete Work Orders when all required conditions pass, and I can quickly fix what is missing when they do not.

### In-scope
- A â€œComplete Work Orderâ€ user action that:
  - invokes a completion precondition validation
  - renders a structured checklist of failures (if any)
  - blocks the completion transition until all checks pass
  - proceeds to completion transition only when eligible
- Clear UX for the two explicitly-called out failure categories:
  - pending approval-gated change requests
  - unreconciled parts usage / labor entries
- Explicit Moqui screen flows, transitions, and service calls (frontend perspective)

### Out-of-scope
- Defining or changing backend policies/formulas for â€œreconciledâ€ (SoR is backend)
- Implementing inventory reconciliation workflows themselves (UI may deep-link, but does not execute reconciliation logic)
- Notification delivery for pending approvals / expiring approvals
- Creating/approving/declining change requests (covered by other workexec stories)

---

## 3. Actors & Stakeholders
- **Primary User Actor:** Service Advisor (authorized to complete Work Order)
- **Secondary Actors:** Service Manager (oversight), Technician (impacted by readiness/closure), Billing (needs correct completion state)
- **System Actor:** Moqui UI + backend services enforcing gate

---

## 4. Preconditions & Dependencies
- A Work Order exists and is viewable in the POS UI.
- Work Order is in a state where completion is meaningful (see State Model section).
- User is authenticated.
- Backend provides:
  - a completion preconditions validation capability returning a list of failed checks (as per story description and backend reference)
  - an endpoint/service to execute the completion transition (or generic transition)
- Dependency: Work Order state machine rules (workexec) must be respected; completion must not bypass validation.
- Dependency: Change request workflow exists such that â€œapproval-gatedâ€ and â€œpendingâ€ can be determined by backend.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order detail screen: action button **Complete Work Order**
- (Optional) From Work Order list row actions: **Complete** (only if user has permission; otherwise hidden/disabled)

### Screens to create/modify
- **Modify:** `apps/pos/screen/workorder/WorkOrderDetail.xml` (or equivalent work order detail screen)
  - Add â€œComplete Work Orderâ€ action and checklist dialog/panel
- **Create (if not present):** `apps/pos/screen/workorder/WorkOrderCompletionChecklist.xml`
  - A reusable screen/dialog rendering validation result + actionable list + retry/refresh
- **Modify (optional):** `apps/pos/screen/workorder/WorkOrderList.xml` to include quick access

### Navigation context
- User remains on Work Order context (same workOrderId).
- If validation fails, user stays on detail screen with checklist visible.
- If completion succeeds, user returns to detail screen with updated status and transition history visible/refreshable.

### User workflows
**Happy path**
1. User opens Work Order detail.
2. User clicks **Complete Work Order**.
3. UI calls â€œValidate completion preconditionsâ€.
4. UI receives `canComplete=true`.
5. UI calls â€œComplete/transition Work Order to COMPLETEDâ€.
6. UI refreshes Work Order detail (status now COMPLETED) and shows confirmation.

**Alternate paths**
- Validation fails: UI shows checklist grouped by category; completion action remains blocked until revalidated and passing.
- Unauthorized: UI hides or disables button; if invoked, handles 403 with clear message.
- Concurrency: if state changed by another user, UI refreshes and shows conflict.

---

## 6. Functional Behavior

### Triggers
- User presses **Complete Work Order** on a specific `workOrderId`.

### UI actions
- Show a modal/dialog (or inline panel) titled â€œCompletion Checklistâ€.
- Display loading state while validation runs.
- Render:
  - Overall eligibility (Eligible / Not eligible)
  - Failed checks list (each with code, message, linked entity when provided)
  - â€œRefresh checklistâ€ action to re-run validation
  - â€œProceed to Completeâ€ action enabled only when `canComplete=true`

### State changes
- Only after successful validation:
  - Trigger backend state transition to `COMPLETED` (or `READY_FOR_PICKUP` then `COMPLETED` if backend requires intermediate step; **see Open Questions**).
- UI must not optimistically set status without backend confirmation.

### Service interactions (frontend perspective)
1. `validateCompletionPreconditions(workOrderId)`
2. If eligible: `completeWorkOrder(workOrderId, userId, reason?)` or generic transition call

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (UI-enforced behavior, backend-authoritative)
- UI MUST invoke validation before attempting completion.
- UI MUST surface **all** failed checks returned (do not stop at first).
- UI MUST block completion when `canComplete=false`.

### Enable/disable rules
- â€œProceed to Completeâ€ button:
  - disabled until validation returns `canComplete=true`
  - disabled while validation or completion request is in-flight
- â€œComplete Work Orderâ€ entry action:
  - disabled/hidden if user lacks permission (if permission info is available; otherwise handle 403)

### Visibility rules
- Checklist panel visible after completion attempt OR user explicitly opens it.
- If no failures, show a concise â€œAll checks passedâ€ summary and enable â€œProceedâ€.

### Error messaging expectations
- Validation failure (business): show checklist items as actionable messages.
- System failure (5xx/network): show generic error â€œUnable to validate completion right now. Try again.â€ plus correlation/trace id if provided.
- 403: â€œYou do not have permission to complete this work order.â€
- 409: â€œWork order changed since you opened it. Refreshingâ€¦â€ then reload.

---

## 8. Data Requirements

### Entities involved (frontend consumption)
- `WorkOrder`
  - `id` (string/long)
  - `status` (enum: per workexec state machine)
- `WorkOrderItem`
  - `id`
  - `status`
  - `isRequiredForCompletion` (boolean) **(backend-defined)**
- `LaborEntry`
  - `id`
  - `status` (draft/pending/confirmed etc. **backend-defined**)
- `PartUsageEvent`
  - `id`
  - `status` (pending allocation, quantity mismatch, allocated/confirmed etc. **backend-defined**)
- `ChangeRequest`
  - `id`
  - `status`
  - `isApprovalGated` (boolean) **(backend-defined)**

### Checklist response model (required for UI rendering)
- `canComplete: boolean`
- `failedChecks: array` of:
  - `check: string` (e.g., `INCOMPLETE_REQUIRED_ITEMS`, `PENDING_APPROVALS`, `UNRECONCILED_PARTS`, `UNRECONCILED_LABOR`)
  - `message: string` (user-readable)
  - `entityType?: string` (e.g., `WorkOrderItem`, `ChangeRequest`, `PartUsageEvent`, `LaborEntry`)
  - `entityId?: string`
  - `entityRef?: object` (optional; minimal display fields if provided)
  - `severity?: 'BLOCKER'|'WARNING'` (if backend supports; otherwise omit)
  - `actionHint?: string` (optional hint text; safe default only if backend provides)

### Read-only vs editable
- Checklist is read-only.
- Completion â€œreasonâ€ field: **not defined in inputs**; do not add unless backend requires (Open Question).

### Derived/calculated
- â€œEligibleâ€ computed from `canComplete`.
- Grouping by `check` prefix/category is derived client-side.

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names are not provided in inputs. Frontend must integrate to existing backend API. This story defines expected contracts and error handling; implementation must map these to actual Moqui service-calls once confirmed.

### Load/view calls
- `GET WorkOrder detail` (already exists in UI)
  - Must include `status` at minimum.

### Validate completion preconditions
- **Expected:** `POST /api/workorders/{workOrderId}/completion/validate` OR equivalent
- **Request:** `{ workOrderId }` (or path param only)
- **Response 200:** `{ canComplete: boolean, failedChecks: [...] }`
- **Errors:**
  - 404 if workOrderId not found
  - 403 if user not authorized to complete/validate
  - 409 if work order state not eligible for completion validation (or changed)

### Complete transition call
- **Expected:** `POST /api/workorders/{workOrderId}/complete` OR generic transition endpoint
- **Request:** include `userId` if backend requires (many workexec endpoints do); otherwise rely on auth context (**Open Question**)
- **Response 200/201:** updated work order status and transition metadata
- **Errors:**
  - 400/409 if completion gate fails (must return failedChecks or a structured error that UI can render)
  - 403 unauthorized
  - 409 concurrency/state mismatch

### Error handling expectations (Moqui UI)
- Map backend structured failure payload (failedChecks) into checklist UI.
- If completion endpoint returns â€œgate failedâ€, UI should present returned checklist without requiring separate validate call.

---

## 10. State Model & Transitions

### Allowed states (from workexec state machine reference)
WorkOrder statuses include:
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

### Completion transition
- UI intent: transition to `COMPLETED`.
- Completion action should only be offered when Work Order is in an appropriate pre-completion state (likely `READY_FOR_PICKUP` or `WORK_IN_PROGRESS` variants). Exact allowed-from states for completion are **not explicitly provided** in the workexec state machine doc beyond general flow; treat as backend authoritative.

### Role-based transitions
- Roles/permissions are referenced but not enumerated in inputs.
- UI must rely on backend authorization and handle 403; if a permission flag is available in WorkOrder detail payload, use it to hide/disable completion action.

### UI behavior per state
- `COMPLETED` or `CANCELLED`: â€œComplete Work Orderâ€ action hidden/disabled; checklist can be view-only if needed.
- In other states: action visible if authorized; on attempt, always validate.

---

## 11. Alternate / Error Flows

### Validation failures
- If failed checks include pending approvals:
  - Show list of change requests with status and identifier if provided.
  - Provide â€œView Change Requestsâ€ navigation (link to existing work order change requests section/screen).
- If unreconciled parts usage:
  - Show each part usage event with mismatch/pending status.
  - Provide navigation to Parts/Inventory reconciliation screen if it exists; otherwise show message only and log Open Question for link target.
- If incomplete required work items:
  - Show list of WorkOrderItems not completed.

### Concurrency conflicts
- If validation returns 409:
  - Show message and prompt user to refresh.
  - Provide â€œRefresh Work Orderâ€ action that reloads detail and re-runs validation.

### Unauthorized access
- If 403 on validate or complete:
  - Show blocking toast/banner.
  - Ensure completion UI does not keep retrying automatically.

### Empty states
- If failedChecks is empty but canComplete=false (invalid response):
  - Show generic error â€œCompletion eligibility could not be determined.â€ and log.
- If API unreachable:
  - Show retry.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Completion succeeds when all preconditions pass
**Given** a Work Order exists and backend validation returns `canComplete=true` with an empty `failedChecks` list  
**When** the user selects â€œComplete Work Orderâ€ and confirms completion  
**Then** the UI calls the completion transition endpoint  
**And** the Work Order status is refreshed and shows `COMPLETED`  
**And** the UI shows a success confirmation message.

### Scenario 2: Block completion when required WorkOrderItems are incomplete
**Given** a Work Order exists and validation returns `canComplete=false`  
**And** `failedChecks` contains an item with `check=INCOMPLETE_REQUIRED_ITEMS` referencing at least one WorkOrderItem  
**When** the user selects â€œComplete Work Orderâ€  
**Then** the UI displays a completion checklist containing the incomplete item(s)  
**And** the â€œProceed to Completeâ€ action is disabled  
**And** no completion transition request is sent.

### Scenario 3: Block completion when approval-gated Change Requests are unresolved
**Given** a Work Order exists and validation returns `canComplete=false`  
**And** `failedChecks` contains an item with `check=PENDING_APPROVALS` referencing a ChangeRequest not in `APPROVED`  
**When** the user selects â€œComplete Work Orderâ€  
**Then** the UI displays a checklist item describing the pending approval(s)  
**And** the UI provides a navigation action to view the Change Request(s) (where available)  
**And** the UI blocks completion.

### Scenario 4: Block completion when parts usage is unreconciled
**Given** a Work Order exists and validation returns `canComplete=false`  
**And** `failedChecks` contains an item with `check=UNRECONCILED_PARTS` referencing a PartUsageEvent in a pending/mismatch state  
**When** the user selects â€œComplete Work Orderâ€  
**Then** the UI displays checklist items identifying the unreconciled parts usage  
**And** completion remains blocked until a re-validation returns `canComplete=true`.

### Scenario 5: Multiple failures are shown together
**Given** a Work Order exists and validation returns `canComplete=false`  
**And** `failedChecks` contains at least two different check types (e.g., `INCOMPLETE_REQUIRED_ITEMS` and `PENDING_APPROVALS`)  
**When** the user selects â€œComplete Work Orderâ€  
**Then** the UI displays all failed checks in the checklist  
**And** the UI does not hide subsequent failures after the first.

### Scenario 6: Unauthorized user cannot complete
**Given** a Work Order exists  
**And** the current user is not authorized to complete the Work Order  
**When** the user attempts to validate or complete the Work Order  
**Then** the backend returns 403  
**And** the UI displays an authorization error message  
**And** the Work Order status is not changed.

### Scenario 7: Work order changed concurrently
**Given** a Work Order is open in the UI  
**And** another user changes the Work Order state such that completion attempt conflicts  
**When** the user attempts to validate or complete and the backend returns 409  
**Then** the UI prompts the user to refresh  
**And** after refresh, the UI reflects the latest Work Order status and checklist state.

---

## 13. Audit & Observability

### User-visible audit data
- After completion attempt (success or failure), UI should display:
  - timestamp of last validation attempt (client-side)
  - outcome (passed/failed)
- If Work Order detail has â€œTransition Historyâ€ section (common in workexec), refresh it after completion.

### Status history
- On successful completion, UI must refresh and show the updated status and latest transition record (who/when/why if available).

### Traceability expectations
- All validate/complete requests should propagate correlation/trace id if the platform provides (Moqui typically supports request IDs); surface in error details when available.

---

## 14. Non-Functional UI Requirements
- **Performance:** validation call should complete within acceptable UX bounds; show spinner if >300ms; avoid duplicate calls on repeated clicks (debounce/in-flight guard).
- **Accessibility:** checklist must be keyboard navigable; modal must trap focus; errors announced via aria-live region.
- **Responsiveness:** usable on tablet resolutions commonly used in shops.
- **i18n/timezone/currency:** checklist messages are server-provided; UI chrome strings must be localizable. Timestamps displayed in shop/user timezone if already supported by app.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: If `failedChecks` is empty, show â€œNo blocking issues reportedâ€ and treat `canComplete` as authoritative; qualifies as safe because it does not change domain policy; impacts UX Summary, Error Flows.
- SD-UX-INFLIGHT-GUARD: Disable action buttons during in-flight validation/completion to prevent double-submit; qualifies as safe because it is standard UI ergonomics; impacts Functional Behavior, Error Flows.
- SD-ERR-GENERIC-RETRY: For network/5xx, show generic retry with no domain assumptions; qualifies as safe because it does not alter business rules; impacts Error Flows, Non-Functional.

---

## 16. Open Questions
1. **Backend contract:** What are the exact API endpoints (paths) and payload schema for:
   - completion precondition validation
   - completing/transitioning a work order to `COMPLETED`  
   The frontend needs exact routes to implement Moqui service-calls deterministically.
2. **Allowed-from states:** Which WorkOrder statuses are allowed to transition to `COMPLETED` (e.g., only `READY_FOR_PICKUP` vs also `WORK_IN_PROGRESS`/`AWAITING_PARTS` once checks pass)?
3. **Auth context:** Does the completion endpoint require `userId` in the request body/query (as in `/start`), or is it derived from the authenticated session?
4. **Checklist linking:** Are there existing POS screens/routes for:
   - viewing change requests for a work order
   - reconciling part usage events / labor entries  
   If yes, provide the target screen paths for deep links; if no, should UI only display identifiers without navigation?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Completion: Validate Completion Preconditions  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/218  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Completion: Validate Completion Preconditions

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
User attempts to complete a workorder.

## Main Flow
1. System checks required workorder items are marked complete per policy.
2. System verifies parts usage and labor entries are reconciled (no invalid quantities).
3. System checks there are no unresolved approval-gated change requests.
4. System generates a completion checklist and prompts for missing items.
5. System allows completion only when all checks pass.

## Alternate / Error Flows
- Pending approval exists â†’ block completion and show what is pending.
- Unreconciled parts usage â†’ block and show reconciliation steps.

## Business Rules
- Completion checks are configurable but must be enforced consistently.
- Completion requires resolving approval-gated items.

## Data Requirements
- Entities: Workorder, WorkorderItem, LaborEntry, PartUsageEvent, ChangeRequest
- Fields: status, completionChecklist, pendingApprovals, unreconciledItems

## Acceptance Criteria
- [ ] System blocks completion when required conditions are not met.
- [ ] System provides a clear checklist of what to fix.
- [ ] System allows completion when all conditions pass.

## Notes for Agents
Completion gate is the last chance to prevent invoice disputes and leakage.

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #219: [FRONTEND] [STORY] Execution: Apply Role-Based Visibility in Execution UI  
File: ./scripts/story-work/frontend/219/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Work Execution: Enforce Role-Based Visibility for Financial Fields in Work Order Execution UI (Moqui)

**Primary Persona:** Mechanic / Technician (restricted view) and Service Advisor / Back Office (full view)

**Business Value:** Prevents unauthorized visibility of sensitive pricing/cost/margin data during execution while preserving full financial truth for invoicing/reporting and ensuring consistent enforcement across execution screens.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Mechanic/Technician  
  **I want** the Work Order execution UI to hide pricing/cost/margin fields Iâ€™m not authorized to see  
  **So that** I can focus on completing work without being exposed to sensitive financial information.

- **As a** Service Advisor / Back Office user  
  **I want** the same screens to show full financial fields when Iâ€™m authorized  
  **So that** I can quote, explain, and prepare billing accurately.

### In Scope
- Frontend (Moqui screens + Vue/Quasar components integration points) enforcement of **role/permission-based visibility** for sensitive financial fields in Work Order execution views.
- Consistent behavior across:
  - Work order header/summary
  - Work order line items (parts/services)
  - Any execution-related subviews that display line item financials
- Secure fallback behavior when policy/permissions cannot be determined: **hide sensitive fields** and surface an admin-facing warning cue (non-sensitive).
- Optional audit logging **when sensitive fields are shown** (if supported by backend contract).

### Out of Scope
- Creating or editing visibility policies (owned by Security/Policy backend).
- Backend enforcement logic (assumed server-side filtering exists or will exist).
- Business calculations (pricing, margins, taxes).
- Defining new workflow states or changing work order state machine.

---

## 3. Actors & Stakeholders
- **Mechanic/Technician**: Uses execution UI; must not see restricted financials.
- **Service Advisor / Back Office**: Needs full visibility for pricing/cost.
- **System Administrator**: Needs misconfiguration signal (not policy authoring here).
- **Security/Policy Service (external dependency)**: System of record for permission scopes/visibility policies.
- **Workexec API**: Provides work order data (possibly already filtered by permissions).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend and has an identity context available to Moqui (session/userAccount).
- Work Order exists and is viewable by the user (`workexec:workorder:view` minimum).

### Dependencies (Blocking if absent/unknown)
- Backend endpoint(s) used by the execution UI to load work orders and items must either:
  1) **Return permission scopes** (or an equivalent â€œcapabilities/visibilityâ€ object) to the frontend, OR  
  2) **Server-side omit sensitive fields** reliably, allowing frontend to treat â€œmissing fieldâ€ as â€œnot visibleâ€.
- A definitive list of â€œsensitive financial fieldsâ€ to hide on the frontend (see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order list â†’ select Work Order â†’ Execution view
- Direct route to work order execution screen by ID

### Screens to create/modify (Moqui)
- **Modify** existing Work Order execution screen(s) (exact screen path TBD):
  - A root execution screen (e.g., `apps/pos/workexec/WorkOrderExecution.xml`)
  - Subscreens/components for:
    - Work order summary
    - Parts list
    - Services/labor list
    - Line item detail panel/modal (if exists)

### Navigation context
- Execution UI must render correctly for different roles without separate routes.
- No role-name checks in UI; use permission scopes/capabilities.

### User workflows
**Happy path (Mechanic)**
1. Mechanic opens Work Order execution UI.
2. Screen loads work order + line items.
3. UI shows operational fields (descriptions, quantities, statuses) but hides pricing/cost/margin fields.

**Happy path (Service Advisor)**
1. Advisor opens same work order.
2. UI shows all operational fields plus pricing/cost/margin fields.

**Alternate path (Policy missing/role misconfigured)**
1. User opens work order.
2. UI cannot determine visibility capabilities.
3. UI defaults to hiding sensitive fields and shows a non-sensitive â€œVisibility policy unavailable; using safe defaultsâ€ indicator (and logs client event).

---

## 6. Functional Behavior

### Triggers
- Work order execution screen is loaded for a given `workOrderId`.
- User opens a line item detail view (if applicable).
- User switches tabs/subscreens within the execution UI.

### UI actions
- Load work order data.
- Determine visibility for sensitive fields using one of:
  - Permission scopes provided by backend/session context, or
  - Presence/absence of fields in API response, or
  - Dedicated â€œcapabilitiesâ€ endpoint (preferred, but not defined here).

### State changes (frontend)
- Local UI state: `canViewPricing`, `canViewCost`, `canViewMargin` (derived booleans)
- UI rendering toggles:
  - Hide columns
  - Hide summary rows/totals that would reveal pricing/cost/margin
  - Hide inline editors for those fields (even if editable elsewhere)

### Service interactions
- Load work order + items via workexec API (see Service Contracts).
- Optionally post an â€œaudit accessâ€ event when sensitive fields are displayed (backend must support).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- If user lacks minimum permission to view work order (`workexec:workorder:view`):
  - UI must treat as unauthorized and show an access denied state (no data rendered).
- If sensitive-field visibility is unknown (capabilities missing, policy lookup fails):
  - UI must default to **hide sensitive fields**.

### Enable/disable rules
- Any UI control that reveals sensitive info (e.g., â€œShow cost breakdownâ€) must be disabled/hidden unless corresponding permission is present.
- No â€œtoggle to revealâ€ for mechanics unless permission scope exists.

### Visibility rules
Sensitive fields (initial list from inputs; may be expanded by backend reality):
- `unitPrice`
- `extendedPrice`
- `cost`
- `margin`

Rule mapping:
- Show pricing fields only if user has `workexec:workorder:view-pricing` (or equivalent capability).
- Show cost fields only if user has `workexec:workorder:view-cost`.
- Show margin fields only if user has `workexec:workorder:view-margin` (if exists) OR if margin is grouped with cost (needs clarification).

### Error messaging expectations
- Unauthorized: â€œInsufficient permissions to view this work order.â€
- Policy missing: â€œVisibility policy unavailable; showing limited information.â€ (must not reveal policy internals)

---

## 8. Data Requirements

### Entities involved (frontend-consumed)
- Work Order (WorkOrder)
- Work Order Item (WorkOrderService, WorkOrderPart or unified WorkorderItem DTO)
- User permissions/scopes (from auth context or backend payload)
- Visibility policy is **not** managed in frontend; only consumed indirectly.

### Fields (type, required, defaults)
**Work Order (read-only for this story)**
- `id` (string/number, required)
- `status` (enum string, required)
- `customerName` (string, optional)
- `vehicle` fields (optional)
- Non-sensitive operational fields as currently present.

**Line items**
- `description` (string, required)
- `quantity` (number, required for parts)
- `status` (enum string, required)
- Sensitive:
  - `unitPrice` (decimal, optional/hidden)
  - `extendedPrice` (decimal, optional/hidden)
  - `cost` (decimal, optional/hidden)
  - `margin` (decimal, optional/hidden)

**Capabilities / scopes**
- `permissionScopes: string[]` OR `capabilities: { canViewPricing: boolean, ... }`
- Default if missing: all `false`.

### Read-only vs editable by state/role
- This story is **visibility-only**: no edits required.
- Any existing editable pricing fields must be hidden when not permitted (even if backend would reject updates).

### Derived/calculated fields
- UI must not derive margin/cost totals if user cannot view them (avoid inference leaks).
- If totals are displayed, ensure totals are also hidden when they would reveal restricted info.

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not fully defined for Moqui frontend. The following is the minimum required for buildability; unknowns are listed in Open Questions.

### Load/view calls
- `GET /api/workorders/{id}` (or `/api/work-orders/{id}`)  
  Expected:
  - Returns work order details + line items
  - Either:
    - includes `permissionScopes`/capabilities, OR
    - sensitive fields are omitted when unauthorized

- Optional (preferred if available):
  - `GET /api/me/permissions?domain=workexec` or similar to fetch scopes once and cache in session.

### Create/update calls
- None in scope.

### Submit/transition calls
- None in scope.

### Error handling expectations
- `401` â†’ route to login/session expired screen
- `403` â†’ show access denied
- `404` â†’ show â€œWork order not foundâ€
- `409` â†’ show â€œWork order updated; refreshâ€ (only if backend returns on load conflicts)
- Policy lookup failure (if separate call) â†’ hide sensitive, show limited-info banner

---

## 10. State Model & Transitions

Work order statuses exist (DRAFT, APPROVED, ASSIGNED, WORK_IN_PROGRESS, etc.) but this story does not add transitions.

### Allowed states
- Execution UI may be used in start-eligible and in-progress states (per workexec state machine).
- Visibility rules apply in **all** states.

### Role-based transitions
- None in scope.

### UI behavior per state
- Independent of state: sensitive fields are shown/hidden based on permissions, not status.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing workOrderId in route â†’ show invalid route error and navigation option back to list.

### Concurrency conflicts
- If backend indicates data stale (409) on load: show refresh CTA; sensitive visibility rules still apply.

### Unauthorized access
- User lacks `workexec:workorder:view` â†’ show access denied; do not render cached sensitive data.

### Empty states
- Work order has no line items â†’ show empty items message; no pricing placeholders that imply cost/price.

### Role misconfiguration / policy not found
- If capabilities cannot be determined:
  - Hide sensitive fields
  - Log client-side warning (non-PII) with correlation/request ID if available
  - Display limited-info banner

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Mechanic cannot see pricing/cost/margin fields
**Given** a logged-in user without permission `workexec:workorder:view-pricing` and without `workexec:workorder:view-cost`  
**And** the user has permission `workexec:workorder:view`  
**When** the user opens the Work Order execution screen for an existing work order  
**Then** the UI shows operational work order and line item fields  
**And** the UI does not render `unitPrice`, `extendedPrice`, `cost`, or `margin` anywhere in the execution screen (including tables, detail panels, and totals).

### Scenario 2: Back office user sees full financial fields when permitted
**Given** a logged-in user with permission `workexec:workorder:view`  
**And** the user has permission `workexec:workorder:view-pricing` and `workexec:workorder:view-cost` (and `workexec:workorder:view-margin` if applicable)  
**When** the user opens the Work Order execution screen for an existing work order that contains those fields  
**Then** the UI renders `unitPrice` and `extendedPrice`  
**And** the UI renders `cost` and `margin` where available  
**And** values match the API response.

### Scenario 3: Missing policy/capabilities defaults to safe (hide)
**Given** a logged-in user with permission `workexec:workorder:view`  
**And** the backend response does not include permission scopes/capabilities  
**And** the backend response includes financial fields (or policy lookup fails client-side)  
**When** the user opens the Work Order execution screen  
**Then** the UI defaults to hiding sensitive financial fields  
**And** the UI displays a non-sensitive banner indicating limited visibility due to policy unavailability.

### Scenario 4: User lacks base permission
**Given** a logged-in user without permission `workexec:workorder:view`  
**When** the user navigates to a Work Order execution screen  
**Then** the UI shows an â€œInsufficient permissionsâ€ state  
**And** does not display any work order details or cached sensitive fields.

### Scenario 5: Sensitive fields are not inferred via totals
**Given** a logged-in user without pricing/cost permissions  
**When** the work order contains line items with prices and costs on the backend  
**Then** the UI does not show totals/subtotals or derived values that would reveal restricted information.

---

## 13. Audit & Observability

### User-visible audit data
- Not required to display audit history in UI for this story.

### Status history
- Not in scope.

### Traceability expectations
- Frontend should emit structured client logs for:
  - Policy/capabilities missing â†’ â€œVISIBILITY_POLICY_FALLBACK_APPLIEDâ€
  - Optional: when sensitive fields are displayed â†’ â€œSENSITIVE_FIELDS_DISPLAYEDâ€ (only if backend requires/accepts)

> Backend audit event requirements exist in backend reference; frontend must only integrate if an endpoint exists (see Open Questions).

---

## 14. Non-Functional UI Requirements
- **Performance:** Determining visibility must not add more than one extra network call on initial load (prefer piggybacking scopes in existing payload).
- **Accessibility:** Hidden fields must be removed from DOM (not just visually hidden) to avoid screen reader leakage.
- **Responsiveness:** Column hiding must work on mobile/tablet layouts.
- **i18n/timezone/currency:** Currency formatting applies only when pricing is visible; otherwise no currency placeholders.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty state messaging for â€œno line itemsâ€; safe because it does not affect domain policy; impacts UX Summary, Error Flows.
- SD-ERR-HTTP-MAP: Standard handling for 401/403/404 with user-friendly messages; safe because it is generic transport behavior; impacts Service Contracts, Error Flows.
- SD-A11Y-DOM-REMOVE: Remove restricted fields from DOM rather than CSS hiding; safe because it strengthens confidentiality without changing policy; impacts Business Rules, Non-Functional.

---

## 16. Open Questions
1. **Backend contract for permissions:** How does the Moqui frontend determine `permissionScopes`/capabilities?  
   - Are scopes included in the work order payload, in session/user context, or via a separate endpoint?
2. **Canonical endpoint paths:** What are the exact endpoints used in this frontend for work orders (e.g., `/api/workorders/{id}` vs `/api/work-orders/{id}`), and what DTO shape is currently returned?
3. **Sensitive fields list:** Is the sensitive set limited to `unitPrice`, `extendedPrice`, `cost`, `margin`, or are there additional fields (discounts, taxes, labor rate, internal cost codes) that must be hidden too?
4. **Scope names:** Confirm exact permission scope strings to use (e.g., `workexec:workorder:view-pricing`, `workexec:workorder:view-cost`, `workexec:workorder:view-margin`). Is there a single â€œfinancialsâ€ scope instead?
5. **Audit logging integration:** Is there an existing backend endpoint/event the frontend must call/emit when sensitive fields are shown, or is audit fully server-side only?
6. **Which screens are in scope:** What are the exact Moqui screen names/routes/components that constitute â€œExecution UIâ€ in this repo (to ensure consistent enforcement everywhere)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Execution: Apply Role-Based Visibility in Execution UI  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/219  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Execution: Apply Role-Based Visibility in Execution UI

**Domain**: user

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
A mechanic/technician views a workorder during execution.

## Main Flow
1. System identifies viewer role and applicable visibility policy.
2. System hides restricted pricing/cost fields from mechanic views.
3. System continues to store full financial data in the underlying records.
4. Back office views show full pricing/cost data.
5. System logs access to sensitive fields when shown (optional).

## Alternate / Error Flows
- Role misconfiguration â†’ default to safer (hide sensitive) behavior and alert admins.

## Business Rules
- Visibility policies must be consistently enforced across screens and APIs.
- Hiding fields must not remove financial truth from the data model.

## Data Requirements
- Entities: VisibilityPolicy, Workorder, WorkorderItem, UserRole
- Fields: roleId, canViewPrices, unitPrice, extendedPrice, cost, margin

## Acceptance Criteria
- [ ] Mechanic views do not display restricted financial fields.
- [ ] Back office views retain full visibility.
- [ ] Financial data remains present for invoicing and reporting.

## Notes for Agents
This is a UI/API policy layer; keep it separate from business calculations.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #220: [FRONTEND] [STORY] Execution: Request Additional Work and Flag for Approval  
File: ./scripts/story-work/frontend/220/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- none

**Rewrite Variant:** workexec-structured

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Execution: Request Additional Work and Flag for Approval

## Primary Persona
- Technician (primary creator)
- Service Advisor (primary reviewer/decider)

## Business Value
Prevents revenue leakage and compliance risk by enforcing an approval gate for out-of-scope work, preserving traceability from requested items â†’ approval artifact â†’ billable work order scope.

---

# 2. Story Intent

## As a / I want / So that
- **As a Technician**, I want to request additional parts/labor on an in-progress work order and flag emergency/safety exceptions so that out-of-scope work is reviewed and properly approved/declined with auditability.
- **As a Service Advisor**, I want to review and approve/decline change requests with a required decision note so that customer approval is captured and execution/billing controls are enforced.

## In-Scope
- Create a Change Request for a specific Work Order (must be `IN_PROGRESS`).
- Add requested items (services and/or parts) to the Change Request.
- Mark items as Emergency/Safety and enforce required documentation (photo evidence OR photo-not-possible + notes).
- View Change Request list and detail for a Work Order.
- Advisor decision actions: Approve / Decline with required approval note (approval artifact).
- Emergency declined acknowledgment action (record customer denial acknowledgment) and show â€œcan closeâ€ gating.
- Enforce â€œblocked from executionâ€ UX cues for items in `PENDING_APPROVAL` or `CANCELLED`.

## Out-of-Scope
- Upload/storage implementation for photos (only capture a URL/identifier if already available).
- Notification delivery mechanics to advisors (only reflect server state; no bespoke push).
- Pricing calculations, taxes, invoice generation, inventory consumption execution flows (must only respect statuses returned).
- Configuration of approval methods/location policy; use backend behavior.

---

# 3. Actors & Stakeholders
- **Technician**: creates Change Requests; flags emergency/safety details.
- **Service Advisor**: reviews Change Requests; records approval/decline note; acknowledges customer denial for declined emergency requests.
- **Customer**: external approver/decliner (captured indirectly via advisor note).
- **Auditor/Manager**: expects immutable, traceable records (notes, timestamps, state history).

---

# 4. Preconditions & Dependencies
## Preconditions
- User is authenticated.
- Work Order exists and is accessible to the user.
- Work Order status is `IN_PROGRESS` (per backend validation).
- Backend endpoints described in `CHANGE_REQUEST_WORKFLOW.md` are available.

## Dependencies
- Backend REST APIs:
  - `POST /api/work-orders/{workOrderId}/change-requests`
  - `GET /api/work-orders/{workOrderId}/change-requests`
  - `GET /api/change-requests/{id}`
  - `POST /api/change-requests/{id}/approve`
  - `POST /api/change-requests/{id}/decline`
  - `POST /api/change-requests/{id}/acknowledge-denial`
  - `GET /api/work-orders/{workOrderId}/can-close`
- Work Order screen/detail exists in Moqui frontend and provides `workOrderId` context.
- Role/permission enforcement is performed server-side; frontend must handle 401/403 cleanly.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From **Work Order Detail** (workexec context): action â€œRequest Additional Workâ€.
- From **Work Order Detail**: section/tab â€œChange Requestsâ€ listing existing requests.

## Screens to create/modify
1. **Modify**: Work Order Detail screen
   - Add navigation to Change Requests list
   - Add action to open Create Change Request flow
   - Add â€œCan Close Work Orderâ€ indicator (based on `GET /can-close`)
2. **Create**: `workorder/changeRequest/Create` (screen/form)
3. **Create**: `workorder/changeRequest/List` (screen)
4. **Create**: `workorder/changeRequest/Detail` (screen)
   - Includes decision actions for advisor (approve/decline)
   - Includes emergency denial acknowledgment (when applicable)

## Navigation context
- All screens are scoped to a single `workOrderId` except Change Request detail which is scoped to `changeRequestId` and shows linked `workOrderId`.

## User workflows
### Happy path (Technician)
1. Open Work Order Detail (`IN_PROGRESS`)
2. Click â€œRequest Additional Workâ€
3. Fill description, add at least one item (service and/or part)
4. Optionally flag emergency/safety on item(s) with required evidence/notes
5. Submit â†’ returns created Change Request in `AWAITING_ADVISOR_REVIEW` and items `PENDING_APPROVAL`
6. User is routed to Change Request detail

### Happy path (Advisor)
1. Open Work Order Detail â†’ Change Requests list â†’ select one `AWAITING_ADVISOR_REVIEW`
2. Review description + requested items
3. Enter decision note (required)
4. Click Approve (or Decline)
5. System updates Change Request status and item statuses accordingly; detail refresh shows updated timestamps and note

### Alternate (Emergency declined acknowledgment)
1. Advisor declines an emergency exception request
2. Work Order â€œCan Closeâ€ becomes false until acknowledgment is recorded
3. Advisor triggers â€œAcknowledge Customer Denialâ€ on the declined Change Request
4. Work Order â€œCan Closeâ€ becomes true (assuming no other blockers)

---

# 6. Functional Behavior

## Triggers
- Technician initiates change request creation from a Work Order.
- Advisor initiates approve/decline from Change Request detail.
- Advisor initiates acknowledgment from Change Request detail (only when emergency exception + declined).

## UI actions
### Create Change Request (Technician)
- Action: Add Service line (references `serviceEntityId`)
- Action: Add Part line (references `productEntityId` + `quantity`)
- Action: Mark line as emergency/safety (boolean)
  - Provide either:
    - `photoEvidenceUrl` OR
    - `photoNotPossible=true` AND `emergencyNotes` (required)
- Action: Submit

### Review/Decide (Advisor)
- Action: Approve with required `approvalNote`
- Action: Decline with required `approvalNote`
- Action: Acknowledge denial (no body per spec)

## State changes (as reflected in UI)
- On create:
  - ChangeRequest: `AWAITING_ADVISOR_REVIEW`
  - Items: `PENDING_APPROVAL`
- On approve:
  - ChangeRequest: `APPROVED`
  - Items: `READY_TO_EXECUTE`
- On decline:
  - ChangeRequest: `DECLINED`
  - Items: `CANCELLED`
- On acknowledge-denial:
  - For emergency/safety items: `customerDenialAcknowledged=true` (reflected on item rows)

## Service interactions (high level)
- Load Work Order context and change requests list.
- POST create request with nested items payload.
- POST approve/decline with approval note and advisor identity fields as required.
- POST acknowledge denial.
- Refresh detail/list after every mutation.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
### Create Change Request
- **Description is required** (non-empty).
- Must include **at least one** service or part item.
- If `isEmergencyException=true`:
  - At least one requested item must be `isEmergencySafety=true`.
- For each item where `isEmergencySafety=true`:
  - Require (`photoEvidenceUrl` present) OR (`photoNotPossible=true` AND `emergencyNotes` non-empty).

### Approve/Decline
- Only allowed when Change Request status is `AWAITING_ADVISOR_REVIEW`.
- `approvalNote` is required for both approve and decline.
- `approvedBy` is required for approve payload (per backend doc).

### Acknowledge denial
- Only allowed when:
  - Change Request `isEmergencyException=true`
  - Change Request status is `DECLINED`

## Enable/disable rules
- Disable Submit if create-form validations fail.
- Disable Approve/Decline buttons if status != `AWAITING_ADVISOR_REVIEW`.
- Disable Acknowledge button unless emergency+declined.
- Show read-only view for requests in terminal states (APPROVED/DECLINED/CANCELLED).

## Visibility rules
- Show â€œEmergency Exceptionâ€ section only if toggled or any item is flagged emergency/safety.
- Show customer denial acknowledgment status only when `isEmergencyException=true`.

## Error messaging expectations
- 400: show validation message(s) inline at form top and per-field where possible.
- 403: show â€œYou donâ€™t have permission to perform this action.â€
- 409: show â€œThis request was updated by someone else. Refresh and try again.â€
- 404: show â€œChange request/work order not found.â€

---

# 8. Data Requirements

## Entities involved (frontend view-model)
- `ChangeRequest`
- `WorkOrder`
- `WorkOrderService` (as change request item)
- `WorkOrderPart` (as change request item)

## Fields (type, required, defaults)

### ChangeRequest
- `id` (number, read-only)
- `workOrderId` (number, required, read-only from route)
- `requestedByUserId` (number, required; populated from session/user context if available, else required input **(see Open Questions: identity source)**)
- `requestedAt` (datetime UTC, read-only)
- `status` (enum: `AWAITING_ADVISOR_REVIEW|APPROVED|DECLINED|CANCELLED`, read-only except via transitions)
- `description` (string, required)
- `isEmergencyException` (boolean, optional default false)
- `exceptionReason` (string, required iff `isEmergencyException=true`)
- `approvalNote` (string, required for approve/decline, read-only otherwise)
- `approvedAt` (datetime, read-only)
- `approvedBy` (number, required for approve action)
- `declinedAt` (datetime, read-only)
- `supplementalEstimatePdfId` (number, read-only; used to link/view supplemental estimate if frontend has a PDF viewer route)

### Service item (WorkOrderService-like payload)
- `serviceEntityId` (number, required)
- `status` (enum: `PENDING_APPROVAL|READY_TO_EXECUTE|OPEN|IN_PROGRESS|COMPLETED|CANCELLED`; read-only in this story)
- `changeRequestId` (number, read-only after create)
- `isEmergencySafety` (boolean, optional default false)
- `photoEvidenceUrl` (string/url, required iff emergency and `photoNotPossible!=true`)
- `photoNotPossible` (boolean, optional default false)
- `emergencyNotes` (string, required iff emergency and (`photoNotPossible=true` OR `photoEvidenceUrl` present?); backend requires notes at least when photo not possible; UI requires notes whenever emergency for audit clarity **(see Applied Safe Defaults)**)
- `customerDenialAcknowledged` (boolean, read-only)

### Part item (WorkOrderPart-like payload)
- `productEntityId` (number, required)
- `quantity` (number, required, min 1)
- Same emergency fields as service items.

## Read-only vs editable by state/role
- Technician: can create only; after creation, all fields are read-only.
- Advisor: can add approval note and decide (approve/decline); cannot edit requested items in this story.
- Acknowledge denial: advisor-only (assumed enforced by backend).

## Derived/calculated fields
- â€œCan close work orderâ€ boolean derived from `GET /api/work-orders/{workOrderId}/can-close`.
- Item counts by status derived client-side for display (optional).

---

# 9. Service Contracts (Frontend Perspective)

## Load/view calls
1. List change requests for a work order  
   - `GET /api/work-orders/{workOrderId}/change-requests`  
   - Expect: array of ChangeRequest summaries or full objects
2. Get change request detail  
   - `GET /api/change-requests/{id}`  
   - Expect: ChangeRequest including associated items (services/parts). If backend returns items separately, frontend must call additional endpoints **(Open Question if not included)**.
3. Can-close gating  
   - `GET /api/work-orders/{workOrderId}/can-close` â†’ boolean

## Create/update calls
1. Create change request  
   - `POST /api/work-orders/{workOrderId}/change-requests`  
   - Request body (per backend doc; include only fields relevant):
     ```json
     {
       "requestedByUserId": 123,
       "description": "string",
       "isEmergencyException": true,
       "exceptionReason": "string",
       "services": [
         {
           "serviceEntityId": 456,
           "isEmergencySafety": true,
           "photoEvidenceUrl": "https://...",
           "photoNotPossible": false,
           "emergencyNotes": "string"
         }
       ],
       "parts": [
         {
           "productEntityId": 789,
           "quantity": 1,
           "isEmergencySafety": false
         }
       ]
     }
     ```
   - Response: created ChangeRequest (prefer) or `{id: ...}`; on success route to detail.

## Submit/transition calls
1. Approve  
   - `POST /api/change-requests/{id}/approve`
   - Body:
     ```json
     { "approvedBy": 789, "approvalNote": "string" }
     ```
2. Decline  
   - `POST /api/change-requests/{id}/decline`
   - Body:
     ```json
     { "approvalNote": "string" }
     ```
3. Acknowledge denial  
   - `POST /api/change-requests/{id}/acknowledge-denial`
   - No body

## Error handling expectations
- Map HTTP codes:
  - 400 â†’ show validation errors (if payload includes field errors, bind; else show message)
  - 401 â†’ redirect to login
  - 403 â†’ show permission dialog/toast; keep user on page
  - 404 â†’ show not found page
  - 409 â†’ show concurrency message + offer refresh
  - 5xx â†’ show generic error + correlation id if available in headers/body

---

# 10. State Model & Transitions

## ChangeRequest allowed states
- `AWAITING_ADVISOR_REVIEW` (initial)
- `APPROVED` (terminal)
- `DECLINED` (terminal; may require acknowledgment if emergency exception)
- `CANCELLED` (terminal; created but cancelled before decision via system actionâ€”UI read-only)

## Role-based transitions (UI gating; server is source of truth)
- Technician:
  - Can create (implicit transition to `AWAITING_ADVISOR_REVIEW`)
- Service Advisor:
  - `AWAITING_ADVISOR_REVIEW` â†’ `APPROVED` (Approve)
  - `AWAITING_ADVISOR_REVIEW` â†’ `DECLINED` (Decline)
  - `DECLINED` + emergency exception â†’ acknowledgment action (does not change ChangeRequest status; updates item fields)

## UI behavior per state
- `AWAITING_ADVISOR_REVIEW`: show decision actions (advisor), show â€œexecution blockedâ€ banner for items.
- `APPROVED`: show decision note + approved timestamp/by; items shown as `READY_TO_EXECUTE`.
- `DECLINED`: show decision note + declined timestamp; items shown as `CANCELLED`; if emergency exception, show acknowledgment status and action if not acknowledged.
- `CANCELLED`: show read-only; no actions.

---

# 11. Alternate / Error Flows

## Validation failures
- Missing description â†’ inline error; block submit.
- No items â†’ inline error; block submit.
- Emergency item missing evidence and photoNotPossible not checked â†’ inline error on item row.
- Emergency item photoNotPossible checked but missing notes â†’ inline error.

## Concurrency conflicts
- Advisor opens request; another advisor approves; first advisor attempts decline â†’ backend returns 409; UI shows â€œalready decidedâ€ and refreshes detail.

## Unauthorized access
- Technician tries to approve/decline â†’ 403; hide buttons proactively if role info available; otherwise handle response.

## Empty states
- Change Requests list empty â†’ show â€œNo change requests yetâ€ and a create action if user can create.

---

# 12. Acceptance Criteria (Gherkin)

## Scenario 1: Technician creates a change request (happy path)
Given a Technician is viewing a Work Order with status "IN_PROGRESS"  
When the Technician submits a Change Request with a non-empty description and at least one requested service or part  
Then the system creates the Change Request with status "AWAITING_ADVISOR_REVIEW"  
And all requested items are created with status "PENDING_APPROVAL"  
And the user is navigated to the Change Request detail view showing the created request and items.

## Scenario 2: Create change request blocked by missing description
Given a Technician is on the Create Change Request screen  
When the Technician leaves Description empty and attempts to submit  
Then the UI blocks submission  
And shows a required-field validation error for Description.

## Scenario 3: Create change request blocked by missing items
Given a Technician is on the Create Change Request screen  
When the Technician provides a Description but adds no services and no parts and attempts to submit  
Then the UI blocks submission  
And shows an error stating at least one item is required.

## Scenario 4: Emergency/safety item requires documentation
Given a Technician is creating a Change Request  
When the Technician marks an item as Emergency/Safety  
And does not provide photoEvidenceUrl  
And does not select "photo not possible" with notes  
Then the UI blocks submission  
And shows an error indicating emergency items require photo evidence or "photo not possible" with notes.

## Scenario 5: Advisor approves with required note
Given a Service Advisor is viewing a Change Request with status "AWAITING_ADVISOR_REVIEW"  
When the Advisor enters an approval note and clicks Approve  
Then the system updates the Change Request status to "APPROVED"  
And the UI refreshes to display approved timestamps/user  
And associated items display status "READY_TO_EXECUTE".

## Scenario 6: Advisor cannot approve without note
Given a Service Advisor is viewing a Change Request with status "AWAITING_ADVISOR_REVIEW"  
When the Advisor clicks Approve without entering an approval note  
Then the UI blocks the action  
And shows a required-field validation error for the approval note.

## Scenario 7: Advisor declines additional work
Given a Service Advisor is viewing a Change Request with status "AWAITING_ADVISOR_REVIEW"  
When the Advisor enters a decline note and clicks Decline  
Then the system updates the Change Request status to "DECLINED"  
And associated items display status "CANCELLED"  
And the UI indicates the items are not billable/executable.

## Scenario 8: Emergency declined requires customer denial acknowledgment before close
Given a Work Order has a declined Change Request flagged as emergency exception  
And at least one emergency/safety item has customerDenialAcknowledged = false  
When the user checks the work order close eligibility  
Then `GET /api/work-orders/{workOrderId}/can-close` returns false  
And the UI indicates the work order cannot be closed until customer denial is acknowledged.

## Scenario 9: Advisor records customer denial acknowledgment
Given a Change Request is flagged as emergency exception and has status "DECLINED"  
When the Advisor triggers "Acknowledge Customer Denial"  
Then the system records acknowledgment for all emergency/safety items for that change request  
And `GET /api/work-orders/{workOrderId}/can-close` eventually returns true (if no other blockers)  
And the UI reflects acknowledgment as completed.

---

# 13. Audit & Observability

## User-visible audit data
- On Change Request detail, display:
  - requestedBy, requestedAt
  - status + approvedAt/approvedBy or declinedAt (if provided)
  - approvalNote (decision artifact)
  - emergency exception reason (if any)

## Status history
- If backend exposes history, display it; otherwise at minimum show current status and timestamps present on entity.

## Traceability expectations
- Each item row must show it is linked to the Change Request (via `changeRequestId`) and show its current item status.
- Supplemental estimate PDF:
  - If `supplementalEstimatePdfId` exists, show a â€œView Supplemental Estimateâ€ link that navigates to existing PDF-view capability (or downloads) **(Open Question if no PDF viewer route exists)**.

---

# 14. Non-Functional UI Requirements

- **Performance**: List and detail loads should complete within 2s on typical LAN; avoid redundant refresh loops (debounce can-close checks).
- **Accessibility**: All actions reachable via keyboard; validation errors announced via ARIA; sufficient contrast.
- **Responsiveness**: Mobile-friendly forms; item rows usable on tablet.
- **i18n/timezone**: Display timestamps in userâ€™s locale but store/submit UTC as provided by backend; no currency handling required in this story.

---

# 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE-001**
  - Assumed: Provide standard empty-state messaging and a primary action (â€œRequest Additional Workâ€) when list is empty.
  - Why safe: Pure UI ergonomics; does not change domain policy or state.
  - Impacted sections: UX Summary, Alternate / Error Flows.

- **SD-ERR-HTTP-MAP-001**
  - Assumed: Standard mapping of 400/401/403/404/409/5xx to user-facing messages and refresh suggestions.
  - Why safe: Error mapping is presentation-layer behavior implied by REST semantics.
  - Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows.

- **SD-AUDIT-NOTES-EMERGENCY-001**
  - Assumed: Require `emergencyNotes` whenever an item is marked Emergency/Safety (even if photoEvidenceUrl is present).
  - Why safe: Adds documentation rigor without altering approvals/state machine; backend already requires notes in some emergency cases.
  - Impacted sections: Business Rules, Acceptance Criteria, Data Requirements.

---

# 16. Open Questions
- none

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Execution: Request Additional Work and Flag for Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/220  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Execution: Request Additional Work and Flag for Approval

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Technician / Service Advisor

## Trigger
Technician identifies additional work required beyond authorized scope.

## Main Flow
1. Technician creates a change request describing additional parts/labor needed.
2. System generates a supplemental estimate view for the additional work.
3. System routes request to advisor for customer approval using the approval capability.
4. System prevents execution of additional billable items until approved (policy).
5. Once approved, system adds authorized items to the workorder with traceability.

## Alternate / Error Flows
- Customer declines additional work â†’ request closed; workorder continues with original scope.
- Emergency/safety exception â†’ policy may allow proceed with documentation.

## Business Rules
- Additional work requires explicit customer approval unless exception policy applies.
- Change requests must be traceable and auditable.
- Added items must reference approval artifacts.

## Data Requirements
- Entities: ChangeRequest, Estimate, ApprovalRecord, WorkorderItem
- Fields: changeRequestId, description, requestedBy, requestedAt, approvalId, addedItemSeqIds, exceptionReason

## Acceptance Criteria
- [ ] Change requests can be created and tracked.
- [ ] Approval gate blocks unauthorized scope expansion.
- [ ] Approved additional work is added with traceability.

## Notes for Agents
This is where scope creep becomes revenue leakageâ€”enforce gates.

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #221: [FRONTEND] [STORY] Execution: Handle Part Substitutions and Returns  
File: ./scripts/story-work/frontend/221/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Execution: Handle Part Substitutions and Returns

## Primary Persona
Technician / Parts Counter Staff

## Business Value
Ensure parts usage on an in-progress Work Order remains inventory-accurate and auditable when a different part is used or unused parts are returned, while properly gating customer-visible price increases through approval when required.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Technician or Parts Counter Staff  
- **I want** to record a part substitution or return against an issued/consumed Work Order part line  
- **So that** inventory quantities reconcile correctly, billing remains accurate, and traceability/audit requirements are satisfied.

## In-scope
- UI entry from Work Order execution to:
  - Return unused quantity for an issued part usage line
  - Substitute an issued part usage line with a different catalog part
- UI validations that prevent invalid adjustments (over-return, invalid quantity, policy blocks)
- UI handling when substitution triggers an approval gate due to price increase (including â€œprice match avoids approvalâ€ path when supported by backend)
- Display of substitution/return audit history at least at the Work Order level (read-only)

## Out-of-scope
- Defining substitution policy rules (backend/policy)
- Implementing inventory availability search/reservation rules beyond what backend exposes
- Implementing Service Advisor approval/rejection UI for substitution price increase (only route/flag visibility; separate story if needed)
- Accounting/COGS ledger posting logic (event emitted by backend)

---

# 3. Actors & Stakeholders
- **Technician / Parts Counter (Primary):** initiates substitution or return.
- **Service Advisor:** may need to approve price increase or apply price match (approval UI may be separate).
- **Inventory Manager:** depends on correct reconciliation; reviews audit.
- **Customer:** impacted by substitution price changes (approval required in some cases).
- **Downstream Accounting/Inventory Systems:** consume `InventoryAdjusted` event.

---

# 4. Preconditions & Dependencies
## Preconditions
- User is authenticated.
- Work Order exists and is in execution-eligible status (backend story indicates `IN_PROGRESS` required).
- Work Order has at least one issued part usage record to adjust.

## Dependencies
- Backend endpoints for:
  - Loading Work Order and part usage lines (read model)
  - Submitting substitution
  - Submitting return
  - (If required) evaluating/returning approval-required flags and price-match handling
- Backend event emission: `InventoryAdjusted` with idempotency behavior (frontend must pass/track idempotency key or receive one).
- Catalog lookup for substitute parts (search/select) and availability checks (backend enforced).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From Work Order execution screen (e.g., `/workorders/{workOrderId}`) within â€œPartsâ€ or â€œMaterialsâ€ section:
  - Action on a part usage row: **Substitute**
  - Action on a part usage row: **Return**

## Screens to create/modify
1. **Modify** `WorkOrderDetail` (or equivalent execution screen)
   - Add row actions: `Substitute`, `Return`
   - Add a read-only â€œUsage & Adjustmentsâ€ panel (or expandable section) to show prior substitutions/returns if available
2. **Create** modal/dialog screen for **Return Unused Part**
   - Fields: returnQuantity (+ optional reasonCode if backend supports)
3. **Create** modal/dialog screen for **Substitute Part**
   - Fields: substituteProduct selection, substituteQuantity, optional reasonCode, optional â€œprice match to originalâ€ controls **only if backend supports**
4. **Create/Modify** lightweight â€œPending Approvalâ€ indicator on Work Order (if backend flags)
   - When substitution triggers approval requirement, show banner and disable further execution actions if backend returns `PENDING_APPROVAL` (behavior must match backend response)

## Navigation context
- Remain within Work Order execution context; dialogs close back to Work Order detail.
- After successful submission, refresh affected part usage rows and totals.

## User workflows
### Happy path: Return
1. User opens Work Order â†’ Parts list
2. User selects issued part usage â†’ clicks **Return**
3. Dialog prompts for `returnQuantity`
4. User submits â†’ UI shows updated consumed quantity and recorded return event

### Happy path: Substitute with no approval
1. User selects issued part usage â†’ **Substitute**
2. User searches/selects substitute part + quantity
3. User submits â†’ UI shows original consumed decremented, new substitute usage created, link shown in history; Work Order remains in-progress

### Alternate path: Substitute triggers approval
1. User submits substitution
2. Backend responds â€œapproval requiredâ€ and updates Work Order/line status to pending approval
3. UI shows â€œPending approvalâ€ state and blocks further execution interactions consistent with returned Work Order status

### Alternate path: Price match avoids approval
1. User (Service Advisor or authorized user) submits substitution with price-match instruction (if supported)
2. Backend processes without setting pending approval; UI reflects success

---

# 6. Functional Behavior

## Triggers
- User invokes `Return` or `Substitute` action on a specific Work Order part usage line.

## UI actions
### Return action
- Open dialog pre-populated with:
  - Part name/SKU
  - Issued quantity, consumed quantity (read-only)
- User enters `returnQuantity` (required, numeric > 0, <= consumed)
- Submit button calls backend; on success refresh Work Order data and show success toast/message.

### Substitute action
- Open dialog pre-populated with:
  - Original part identity and current quantities
- User selects substitute part (catalog search/select)
- User enters `substituteQuantity` (required, numeric > 0, <= original consumed quantity **unless backend allows other behavior; see Open Questions**)
- Submit calls backend; on success refresh Work Order data.

## State changes (frontend-visible)
- Return:
  - Decrease consumed quantity by `returnQuantity`
  - Increase returned quantity (if returnedQuantity is tracked separately)
- Substitution:
  - Decrease original consumed quantity by substituted amount
  - Create substitute usage record with consumed quantity (or issued/consumed as backend defines)
  - Create substitution link record for traceability
  - Potentially set Work Order (or line) status to `PENDING_APPROVAL` (or `AWAITING_APPROVAL` depending on backend model)

## Service interactions
- Load: fetch Work Order detail including part usage lines and relevant flags
- Submit return: call a â€œreturn part usageâ€ service/endpoint
- Submit substitution: call a â€œsubstitute partâ€ service/endpoint
- Refresh: re-fetch Work Order detail and history after successful mutation

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Return quantity:
  - Must be > 0
  - Must not exceed current `consumedQuantity`
  - Must not cause consumedQuantity to go negative (client-side guard + backend enforcement)
- Substitution:
  - Must select a valid substitute catalog part
  - Quantity must be > 0
  - Substitution not allowed by policy â†’ UI displays blocking error from backend
  - Substitute unavailable/insufficient inventory â†’ block with backend error
- Approval policy:
  - If substitution increases customer-visible totals and is not price-matched, backend flags approval required; UI must reflect this clearly and prevent further execution actions if the Work Order becomes approval-blocked.

## Enable/disable rules
- Disable `Return` and `Substitute` actions when:
  - Work Order is not `IN_PROGRESS` (or backend indicates not modifiable)
  - Part usage line is not issued/eligible (backend-derived flag preferred)
  - Work Order is in an approval-blocked state (e.g., pending approval) if backend enforces
- Disable submit buttons while request in-flight (prevent double-submit)

## Visibility rules
- Show â€œPending approvalâ€ banner when backend indicates approval-required status on Work Order or affected line
- Show substitution link traceability (original â†” substitute) in history view when available

## Error messaging expectations
- Show backend-provided validation message verbatim where safe (no stack traces)
- Map common cases:
  - 400: inline field error + top summary
  - 403: â€œYou do not have permission to adjust parts on this work order.â€
  - 404: â€œWork order or part usage not found.â€
  - 409: â€œThis work order/line changed since you opened it. Refresh and try again.â€

---

# 8. Data Requirements

## Entities involved (frontend view model)
> Backend is system-of-record; frontend displays/collects fields.

- **WorkOrder**
  - `id`
  - `status` (must include in-progress and approval-blocking statuses as backend returns)
- **WorkOrderItemPartUsage** (or equivalent)
  - `id` (usageId)
  - `workOrderItemId`
  - `productId`
  - `productName`/display fields
  - `issuedQuantity` (number)
  - `consumedQuantity` (number)
  - `returnedQuantity` (number, optional if backend provides)
  - eligibility flags (optional)
- **PartSubstitutionLink**
  - `sourceUsageId`
  - `substituteUsageId`
  - `substitutedQuantity`
  - `timestamp`
  - `reasonCode` (optional)
- **PartUsageEvent** (if backend exposes event history)
  - `eventType` (`PART_SUBSTITUTION`, `PART_RETURN`)
  - `actorUserId`
  - `timestamp`
  - product/usage references
- **ChangeRequest** (only if backend uses this mechanism for approval gating; display-only linkage)

## Fields (type, required, defaults)
### Return dialog input
- `usageId` (string/number, required; hidden)
- `returnQuantity` (decimal/number, required)
- `reasonCode` (string, optional; only if backend supports)

### Substitute dialog input
- `sourceUsageId` (required; hidden)
- `substituteProductId` (required)
- `substituteQuantity` (decimal/number, required)
- `reasonCode` (string, optional)
- `priceMatchToOriginal` (boolean, optional; only if backend supports)
- `priceMatchReason` (string, optional; only if backend requires)

## Read-only vs editable
- Read-only: issued/consumed/returned quantities, product identity, audit history
- Editable: returnQuantity, substitute selection, substituteQuantity, optional reason/price-match fields

## Derived/calculated fields (display)
- `remainingConsumed = consumedQuantity` (post-refresh)
- â€œNet adjustment previewâ€ in dialogs (client-side): show â€œ+X returned to inventoryâ€ and/or â€œ-Y consumed for substituteâ€ purely informational

---

# 9. Service Contracts (Frontend Perspective)
> Use these as Moqui service-call contracts even if actual REST paths differ; if Moqui calls REST, map these to endpoint calls.

## Load/view calls
1. **Get Work Order Detail**
   - Purpose: load part usage lines + status + approval flags
   - Expected: Work Order status, list of part usage lines, substitution/return history (if available)

2. **Search Catalog Parts** (for substitute selection)
   - Query: text, optional filters (category, availability)
   - Expected: productId, name, SKU, price (optional display), availability indicator (optional)

## Create/update calls
1. **Return Unused Part**
   - Input: `usageId`, `returnQuantity`, optional `reasonCode`
   - Output: updated usage line and/or updated Work Order snapshot
   - Errors:
     - 400 if returnQuantity invalid
     - 409 if concurrency conflict

2. **Substitute Part**
   - Input: `sourceUsageId`, `substituteProductId`, `substituteQuantity`, optional `reasonCode`, optional price-match fields
   - Output: created substitute usage id, substitution link id, updated Work Order status/flags
   - Errors:
     - 400 invalid qty/inputs
     - 403 no permission
     - 409 conflict
     - policy-block error (400/422)

## Submit/transition calls
- None directly beyond substitution/return mutations, but backend may transition Work Order/line into approval-blocking state; frontend must treat returned status as authoritative.

## Error handling expectations
- All mutation calls must be treated as non-idempotent from UI perspective; prevent double-click.
- If backend supports idempotency keys for `InventoryAdjusted`, frontend should pass a client-generated idempotency token **only if required by backend** (unclear; see Open Questions).

---

# 10. State Model & Transitions

## Allowed states (relevant subset)
Work Order states per workexec FSM (as provided):
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

## Role-based transitions (frontend behavior)
- This story does not initiate Work Order FSM transitions directly.
- However, substitution may place Work Order/line into an approval-gated condition:
  - UI must reflect any backend-provided status such as `AWAITING_APPROVAL` or a line-level `PENDING_APPROVAL` state (backend story references `PENDING_APPROVAL` on Work Order/lineâ€”naming mismatch vs FSM; see Open Questions).

## UI behavior per state
- If Work Order is not in an execution-eligible state (expected: `WORK_IN_PROGRESS` and possibly in-progress substates):
  - Hide/disable Substitute/Return actions; show tooltip â€œWork order not in progress.â€
- If Work Order indicates awaiting approval / pending approval:
  - Show banner with reason (if provided)
  - Disable further execution-affecting actions including Substitute/Return (unless backend explicitly allows)

---

# 11. Alternate / Error Flows

## Validation failures
- Return quantity > consumed â†’ show inline error; submission blocked; if backend rejects, show returned error message.
- Substitute quantity invalid or missing substitute part â†’ inline validation.

## Concurrency conflicts
- If backend returns 409 due to changed quantities/status:
  - Show modal â€œWork order has changed. Refresh to continue.â€
  - Provide â€œRefreshâ€ button that reloads Work Order detail.

## Unauthorized access
- 403 response:
  - Show â€œNot authorizedâ€ message
  - Keep dialogs open but disable submit until user closes; no partial UI updates.

## Empty states
- No issued parts:
  - Show â€œNo issued parts to adjust.â€
  - Hide Substitute/Return row actions.

---

# 12. Acceptance Criteria

## Scenario 1: Return unused part (success)
**Given** a Work Order is in `WORK_IN_PROGRESS` (or backend-defined in-progress state) and has a part usage line with `consumedQuantity = 5`  
**When** the user selects that line and submits a return with `returnQuantity = 2`  
**Then** the UI shows the updated part usage with `consumedQuantity = 3` (and `returnedQuantity` increased if provided) after refresh  
**And** an adjustment record/history entry is visible indicating a `PART_RETURN` was recorded.

## Scenario 2: Prevent over-return
**Given** a Work Order part usage line has `consumedQuantity = 3`  
**When** the user attempts to return `returnQuantity = 4`  
**Then** the UI blocks submission with a clear validation message  
**And** if submitted anyway (e.g., via direct request), the UI displays the backend rejection and no quantities change in the UI after refresh.

## Scenario 3: Substitute part (success, no approval required)
**Given** a Work Order is in `WORK_IN_PROGRESS` and has Part A consumed  
**When** the user substitutes Part A with Part B for quantity 1  
**Then** the UI shows:
- Part A consumed quantity reduced by 1  
- a new usage line for Part B reflecting the substituted quantity  
- a visible traceability link tying Part B usage to Part A usage  
**And** the Work Order remains executable (no approval banner is shown).

## Scenario 4: Substitute part triggers approval gate (price increase)
**Given** a Work Order is in `WORK_IN_PROGRESS` with Part A consumed  
**And** substituting to Part B increases customer-visible totals and is not price-matched per policy  
**When** the user submits the substitution  
**Then** the UI shows the substitution recorded  
**And** the Work Order (or affected line) is shown as awaiting/pending approval per backend response  
**And** execution-affecting actions (including additional Substitute/Return) are disabled until approval is resolved.

## Scenario 5: Substitution blocked by policy
**Given** a Work Order is in `WORK_IN_PROGRESS`  
**When** the user attempts a substitution that policy disallows  
**Then** the UI shows a blocking error message returned by the backend  
**And** no changes are reflected after refresh.

## Scenario 6: Duplicate submission protection (UI)
**Given** the user opens the Substitute dialog and clicks submit  
**When** the network is slow and the user clicks submit again  
**Then** the UI only issues one request (submit button disabled while in-flight)  
**And** the UI shows only one resulting substitution after refresh.

---

# 13. Audit & Observability

## User-visible audit data
- For each substitution/return, display (where backend provides):
  - event type (`PART_SUBSTITUTION` / `PART_RETURN`)
  - timestamp (UTC displayed in local time)
  - actor (user display name/id)
  - original part, substitute part (if applicable)
  - quantity adjusted
  - approval outcome/status if applicable

## Status history
- If Work Order status changes to an approval-blocked state as a result of substitution:
  - show latest status and (if available) a â€œView status historyâ€ link to transitions screen/section.

## Traceability expectations
- UI must preserve and display linkage between original usage and substitute usage (SubstitutionLink) so invoice explanations and audits can trace variance.
- If backend returns an idempotency key / event reference for `InventoryAdjusted`, display it in an expandable â€œDetailsâ€ section for support/debug (optional if available).

---

# 14. Non-Functional UI Requirements

- **Performance:** Work Order detail refresh after mutation should complete within 2s on typical connection; show loading indicators.
- **Accessibility:** Dialogs keyboard-navigable; focus trapped in modal; error messages announced to screen readers.
- **Responsiveness:** Must work on tablet-sized screens used in shop floor context.
- **i18n/timezone:** Render timestamps in user locale/timezone; do not change stored UTC values.
- **Currency:** If showing price deltas, use store currency formatting (only if backend provides amounts).

---

# 15. Applied Safe Defaults
- SD-UX-LOADING-001: Disable submit buttons and show spinner during in-flight mutations; qualifies as safe UI ergonomics; impacts UX Summary, Error Flows, Acceptance Criteria.
- SD-UX-EMPTY-001: Provide explicit empty state when no issued parts exist; safe UI ergonomics; impacts UX Summary, Alternate / Error Flows.
- SD-ERR-MAP-001: Standard HTTP error-to-message mapping (400/403/404/409) without exposing internals; safe because itâ€™s generic error handling; impacts Business Rules, Error Flows, Service Contracts.

---

# 16. Open Questions
1. **Backend contract alignment:** What are the exact backend endpoints (paths, methods) and payload schemas for:
   - return unused part
   - substitute part
   - loading part usage + substitution links + history  
   (Needed to implement Moqui service calls and screen actions precisely.)
2. **Approval state naming:** Does approval gating manifest as Work Order state `AWAITING_APPROVAL` (FSM) or a separate status like `PENDING_APPROVAL` (mentioned in backend story) and is it WorkOrder-level or line-level? (UI enable/disable rules depend on this.)
3. **Price match input:** Is â€œprice match to original priceâ€ performed during substitution submission (needs UI fields) or as a separate Service Advisor action after substitution? If during submission, what permissions/fields are required (e.g., reason code)?
4. **Substitution quantity constraints:** Must substituted quantity be `<= original consumedQuantity` always, or can it exceed (e.g., original was partially consumed)? Confirm allowed rules so UI validations match backend.
5. **Idempotency key handling:** Does the frontend need to supply an idempotency key/version (`workorderId + originalPartId + adjustedPartId + adjustmentVersion`) or is it generated server-side? If client-supplied, define exact composition and where `adjustmentVersion` comes from.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Execution: Handle Part Substitutions and Returns  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/221  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Execution: Handle Part Substitutions and Returns

**Domain**: user

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Parts Counter / Technician

## Trigger
A different part is used or unused parts are returned.

## Main Flow
1. User selects a part item and chooses 'Substitute' or 'Return'.
2. System records substitution linking original and substituted part references.
3. System records quantity returned and updates usage totals.
4. If substitution impacts price/tax, system flags for approval if required.
5. System records all events for audit and inventory reconciliation.

## Alternate / Error Flows
- Substitution not allowed by policy â†’ block.
- Return would create negative consumed quantity â†’ block.

## Business Rules
- Substitutions must preserve traceability to original authorized scope.
- Returns must be reconciled against issued/consumed quantities.
- Price/tax impacts may require customer approval.

## Data Requirements
- Entities: PartUsageEvent, WorkorderItem, SubstitutionLink, ChangeRequest
- Fields: originalProductId, substituteProductId, quantityReturned, eventType, requiresApprovalFlag

## Acceptance Criteria
- [ ] System records substitutions with traceability.
- [ ] Returns reconcile correctly without negative totals.
- [ ] Approval is triggered when substitution changes customer-visible totals (policy).
- [ ] Substituted or returned parts emit a single InventoryAdjusted event
- [ ] Adjustment references the original issued part record
- [ ] Inventory quantities reconcile correctly after adjustment
- [ ] COGS impact (if any) is reversible and auditable
- [ ] Duplicate adjustment events do not double-adjust inventory

## Integrations

### Accounting
- Emits Event: InventoryAdjusted
- Event Type: Non-posting (inventory / COGS correction)
- Source Domain: workexec
- Source Entity: WorkorderPartUsage
- Trigger: Part substitution or return after initial issue
- Idempotency Key: workorderId + originalPartId + adjustedPartId + adjustmentVersion

## Notes for Agents
Substitution is a classic variance driverâ€”capture it cleanly for invoice explanations.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #222: [FRONTEND] [STORY] Execution: Issue and Consume Parts  
File: ./scripts/story-work/frontend/222/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Execution: Issue and Consume Parts (Work Order Part Usage Events)

### Primary Persona
Technician / Parts Counter Staff

### Business Value
Ensure parts issued to (picked) and consumed on (installed) a work order are recorded with full traceability, enforce authorized quantity limits, and reflect parts availability issues in work order executionâ€”so inventory/accounting downstream processes can rely on accurate, idempotent events.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Technician or Parts Counter Staff  
- **I want** to record parts **issued** and **consumed** against a specific work order part line item  
- **So that** work progress is accurate, audit trails are immutable, and downstream inventory/accounting systems receive correct, idempotent issuance events.

### In Scope
- View work order part line items and their authorized vs issued/consumed quantities.
- Record part usage as **events** (issue and consume for a work order part item).
- Validate quantity integrity (cannot exceed authorized; cannot exceed available if inventory-integrated).
- Handle insufficient inventory by flagging and moving the work order to a parts-waiting execution status (see Open Questions re exact status mapping).
- Display usage event history (who/when/what) per work order item for auditability.
- Idempotent submission behavior from the frontend (prevent double-submit; handle retry responses safely).

### Out of Scope
- Creating/modifying estimate scope or approvals to increase authorized quantities (approval workflows are separate).
- Defining accounting policy (WIP vs COGS) or ledger postings (downstream/accounting-owned); frontend only surfaces returned policy if available.
- Implementing inventory allocation/picking list scanning workflows (separate â€œpickingâ€ domain features).
- Notification delivery mechanics (only show messages/alerts in UI).

---

## 3. Actors & Stakeholders

### Actors
- **Technician**: records consumed/installed parts during execution.
- **Parts Counter Staff**: records issued/picked parts to the job.

### Stakeholders
- **Service Advisor**: needs visibility when parts shortages block progress.
- **Inventory** (downstream system): relies on issued events to decrement on-hand / reservations.
- **Accounting** (downstream system): relies on events and policy metadata (WIP/COGS).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- A **Work Order** exists and is in a non-terminal status that permits recording parts usage (not `COMPLETED` / `CANCELLED`).
- Work order contains at least one **WorkOrderPart** (or equivalent) item with:
  - `productId`
  - authorized quantity
  - current issued/consumed totals
- Backend endpoints exist (or will exist) to:
  - Load work order + part items + usage history
  - Record a usage event (issue/consume)
  - Return validation errors deterministically

### Dependencies
- Work order execution status model (from `WORKORDER_STATE_MACHINE.md`) for any UI-driven status update behavior.
- Inventory availability lookup and â€œinsufficient inventoryâ€ validation behavior (backend integration contract).
- Idempotency behavior for usage event recording (backend must support deterministic dedupe or return created event).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order detail screen: action â€œPartsâ€ â†’ â€œIssue / Consumeâ€.
- From Work Order line item detail (part item row): action â€œRecord Usageâ€.

### Screens to create/modify
1. **Modify**: `WorkOrderDetail` screen to include a â€œPartsâ€ section/tab and link to part usage.
2. **Create**: `WorkOrderPartUsage` screen (work order scoped) to:
   - List part items
   - Show remaining authorized qty
   - Launch â€œRecord Usageâ€ form
3. **Create/Embed**: `RecordPartUsage` dialog/form (screen include or subscreen) for a selected part line item.
4. **Create** (optional but recommended): `WorkOrderPartUsageHistory` subscreen showing immutable event list.

### Navigation context
- URL pattern (proposed):  
  - `/workorders/<workOrderId>/parts` (list + history)
  - `/workorders/<workOrderId>/parts/<workOrderPartId>` (detail + record usage)
- Breadcrumb: Work Orders â†’ Work Order # â†’ Parts

### User workflows
**Happy path**
1. User opens Work Order â†’ Parts.
2. Selects a part line item.
3. Enters quantities: issued and/or consumed (see Open Questions on whether both are captured separately vs single combined).
4. Submits.
5. UI shows updated totals and appends an immutable event in history.

**Alternate paths**
- Insufficient inventory: UI shows error, offers â€œMark Waiting for Partsâ€ (if backend does not auto-transition) and shows shortage indicator.
- Exceeds authorized: UI blocks submission and provides link/CTA to â€œRequest approval to add partsâ€ (navigation only; approval workflow out of scope).
- Work order locked (terminal status): UI renders read-only with explanation.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œRecord Usageâ€ on a work order part item.

### UI actions
- Display current state:
  - authorized quantity
  - total issued quantity to date
  - total consumed quantity to date
  - remaining authorized quantity (derived)
- Allow user to enter a **new usage event**:
  - `quantityIssued` (>= 0)
  - `quantityConsumed` (>= 0)
  - (optional) note/reason (if backend supports; not defined in provided inputs)

### State changes
- On successful record:
  - A new immutable **PartUsageEvent** exists (backend-owned).
  - Work order part item totals update (backend-owned).
  - If completion indicators apply, UI reflects any `completed/partsComplete` flags returned by backend.

### Service interactions
- Load work order parts and current totals on screen entry.
- Submit usage event via a single service call.
- Refresh the part item + history after successful submission.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (client-side + server-side)
Client-side (safe, non-authoritative):
- Required: a part line item must be selected.
- `quantityIssued` and `quantityConsumed` must be numbers, `>= 0`.
- At least one of issued/consumed must be `> 0` (otherwise no-op).
- Prevent obvious overages based on displayed remaining authorized (still must be validated server-side).

Server-side (authoritative; UI must display errors):
- **No consumption/issuance** allowed when work order is `COMPLETED` or `CANCELLED`.
- **Cannot exceed authorized quantity** without separate approval.
- **Insufficient inventory** must be rejected or handled per backend policy (see Open Questions).

### Enable/disable rules
- Disable submit when:
  - Work order is terminal (`COMPLETED`, `CANCELLED`)
  - Form invalid
  - Submission in-flight (prevent double-submit)

### Visibility rules
- If backend indicates inventory integration is disabled/unavailable:
  - Hide â€œavailable on handâ€ indicators (if any)
  - Still allow recording usage events unless backend rejects.

### Error messaging expectations
- Quantity exceeds authorized: â€œExceeds authorized quantity. Request approval to increase scope.â€
- Insufficient inventory: â€œInsufficient inventory to issue/consume requested quantity.â€
- Conflict/idempotency duplicate: â€œThis usage event was already recorded. Totals have been refreshed.â€
- Locked state: â€œWork order is locked and cannot be modified.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `WorkOrder` (read)
- `WorkOrderPart` or `WorkorderItem` (read/update via service)
- `PartUsageEvent` (create/read history)
- `InventoryReservation` (read-only indicators, if exposed)

### Fields
**WorkOrder**
- `workOrderId` (string/number, required)
- `status` (enum: from `WORKORDER_STATE_MACHINE.md`)

**WorkOrderPart / WorkorderItem (part line)**
- `workOrderItemId` / `workOrderPartId` (required)
- `productId` (required)
- `authorizedQuantity` (decimal, required)
- `quantityIssuedTotal` (decimal, required)
- `quantityConsumedTotal` (decimal, required)
- `originEstimateItemId` (optional)
- Derived (UI): `remainingAuthorized = authorizedQuantity - quantityConsumedTotal` (or other definition; see Open Questions)

**PartUsageEvent**
- `partUsageEventId` (required)
- `eventType` (enum; must support issue/consume/return per inputs)
- `quantityIssued` (decimal)
- `quantityConsumed` (decimal)
- `eventAt` (timestamp, UTC)
- `performedBy` (user id)
- `idempotencyKey` (string; see Open Questions on format alignment)

### Read-only vs editable
- Read-only: all history/event records.
- Editable: only the new usage event form inputs; existing events cannot be edited.

### Derived/calculated fields
- Remaining authorized quantity
- Completion indicator for the part item (if backend provides; otherwise only reflect totals)

---

## 9. Service Contracts (Frontend Perspective)

> Backend contracts are not fully specified in provided inputs; below is the **frontend-required contract**. If actual endpoints differ, story remains blocked until confirmed.

### Load/view calls
1. `GET /api/workorders/{workOrderId}`
   - returns `status`, basic header fields
2. `GET /api/workorders/{workOrderId}/parts`
   - returns list of part line items with authorized/issued/consumed totals
3. `GET /api/workorders/{workOrderId}/parts/{workOrderPartId}/usage-events`
   - returns immutable event list ordered by `eventAt desc`

### Create/update calls
1. `POST /api/workorders/{workOrderId}/parts/{workOrderPartId}/usage-events`
Request (proposed):
```json
{
  "productId": "PART-123",
  "quantityIssued": 2,
  "quantityConsumed": 2,
  "eventType": "ISSUE_CONSUME",
  "performedBy": 123,
  "clientRequestId": "uuid-optional"
}
```
Response (proposed):
- `201 Created` with created `PartUsageEvent` and updated item totals, OR
- `200 OK` with same payload if deduped (idempotent retry)

### Submit/transition calls
- If backend requires explicit WO status change on insufficient inventory:
  - `POST /api/workorders/{workOrderId}/transition` (not defined; must be clarified)
- Otherwise: backend automatically sets `AWAITING_PARTS` and returns updated work order.

### Error handling expectations
- `400` validation: map field errors to form fields.
- `403` unauthorized: show â€œYou do not have permissionâ€.
- `404` missing WO/item: show â€œNot foundâ€.
- `409` conflict/idempotency: refresh data and show non-blocking message.

---

## 10. State Model & Transitions

### Allowed states (Work Order)
From `WORKORDER_STATE_MACHINE.md`:
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

### Role-based transitions
- This story does **not** define new transitions; it only:
  - Reads state
  - May trigger a change to â€œawaiting partsâ€ as a consequence of insufficient inventory (needs clarification whether frontend triggers transition or backend sets it)

### UI behavior per state
- `COMPLETED`, `CANCELLED`: read-only; cannot record usage.
- `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`: usage allowed unless backend rejects due to policy.
- `AWAITING_PARTS`: show prominent banner â€œWaiting for partsâ€; allow recording usage events if parts become available.

---

## 11. Alternate / Error Flows

### Validation failures
- Over authorized:
  - Block submit, show server error.
  - Provide CTA link to out-of-scope â€œRequest approval / change requestâ€.
- Zero quantities:
  - Client blocks with â€œEnter issued or consumed quantity.â€

### Concurrency conflicts
- If totals changed since load:
  - Backend returns `409` with latest totals; UI refreshes and prompts user to retry.

### Unauthorized access
- If user lacks permission:
  - UI disables â€œRecord Usageâ€ and shows â€œInsufficient permissionsâ€.

### Empty states
- Work order has no part items:
  - Show â€œNo parts on this work order.â€ with guidance (out-of-scope) to add parts via estimate/workorder editing.

---

## 12. Acceptance Criteria

### Scenario 1: Record part issue+consume successfully
**Given** a work order in `WORK_IN_PROGRESS` with a part line authorizing 2 units of `PART-123`  
**And** the user has permission to record part usage  
**When** the user records `quantityIssued=2` and `quantityConsumed=2` for that part line  
**Then** the system creates an immutable part usage event with `performedBy` and UTC timestamp  
**And** the part line totals reflect +2 issued and +2 consumed  
**And** the usage event appears in the history list without requiring a full page reload.

### Scenario 2: Prevent exceeding authorized quantity
**Given** a work order in `WORK_IN_PROGRESS` with a part line authorizing 2 units of `PART-123`  
**When** the user attempts to record `quantityConsumed=3`  
**Then** the submission is rejected  
**And** the UI displays an error â€œExceeds authorized quantityâ€  
**And** no new usage event appears in history.

### Scenario 3: Insufficient inventory handling
**Given** a work order in `WORK_IN_PROGRESS` with a part line authorizing 2 units of `PART-123`  
**And** the backend indicates insufficient inventory for the requested quantity  
**When** the user submits a usage event for 2 units  
**Then** the UI displays â€œInsufficient inventoryâ€  
**And** no usage event is recorded  
**And** the work order status is shown as `AWAITING_PARTS` **if and only if** the backend transitions it (or a separate transition call succeeds).

### Scenario 4: Work order locked (terminal)
**Given** a work order with status `COMPLETED`  
**When** the user navigates to the Parts Usage screen  
**Then** the UI renders usage history read-only  
**And** â€œRecord Usageâ€ actions are disabled  
**And** submitting is not possible.

### Scenario 5: Idempotent retry does not double-record
**Given** the user submits a usage event and the network times out after submit  
**When** the user retries the same submission  
**Then** the backend responds with the previously created event (or a dedupe indication)  
**And** the UI shows only one new event in history  
**And** totals reflect a single increment.

---

## 13. Audit & Observability

### User-visible audit data
- Per usage event show:
  - event type
  - quantities issued/consumed
  - performed by (user display name if available)
  - event timestamp (rendered in user locale but stored/displayed as UTC source)

### Status history
- If work order transitions to `AWAITING_PARTS`, display status change time and reason if backend provides.

### Traceability expectations
- UI must display identifiers when needed for support:
  - workOrderId
  - workOrderPartId/workOrderItemId
  - partUsageEventId
  - idempotency key (optional display in an â€œadvancedâ€ expander)

---

## 14. Non-Functional UI Requirements

- **Performance**: Parts list load < 2s for up to 200 part lines; history pagination supported.
- **Accessibility**: All form inputs labeled; errors announced; keyboard navigable.
- **Responsiveness**: Works on tablet (shop floor).
- **i18n/timezone/currency**: Timestamps displayed in local timezone; store UTC in payloads; quantities are decimal-safe.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit empty state messaging for â€œno partsâ€ and â€œno historyâ€; safe because it doesnâ€™t affect domain policy. (Impacted: UX Summary, Error Flows)
- SD-UX-PAGINATION: Paginate usage event history (default page size 25) to avoid long lists; safe UI ergonomics only. (Impacted: UX Summary, Performance)
- SD-ERR-MAP-HTTP: Standard mapping of 400/403/404/409 to user messages and field errors; safe because it follows implied backend HTTP semantics. (Impacted: Service Contracts, Error Flows)

---

## 16. Open Questions

1. **Backend endpoint contract (blocking):** What are the exact Moqui service names / REST endpoints for:
   - loading work order parts
   - listing part usage events
   - creating a usage event (issue/consume/return)
2. **Event model clarity (blocking):** Are â€œissueâ€ and â€œconsumeâ€ captured as:
   - a single combined event (`ISSUED_AND_CONSUMED`), or
   - separate event types (`ISSUED`, `CONSUMED`, `RETURNED`) with separate quantities?
3. **Authorized quantity rule (blocking):** Is authorization enforced against **consumed total**, **issued total**, or both? (The inputs say â€œconsumption exceeds authorizedâ€ but UI captures both.)
4. **Insufficient inventory behavior (blocking):** On insufficient inventory, does the backend:
   - reject without changing work order status, or
   - automatically transition work order to `AWAITING_PARTS`, or
   - require an explicit transition call from frontend?
5. **Idempotency key format conflict (blocking):** Provided inputs mention `workorderId + partId + usageSequence`, while backend reference uses `{workorderId}-{workorderItemId}-{partUsageEventId}`. Which is authoritative for the frontend to pass/display?
6. **Permissions (blocking):** What permissions/roles control:
   - viewing parts usage
   - recording issuance/consumption
   - performing â€œwaiting for partsâ€ transition (if frontend-triggered)?
7. **Inventory integration signal (blocking):** How does the frontend detect whether on-hand availability should be shown/validated (flag in response, separate endpoint, or always backend-enforced)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Execution: Issue and Consume Parts  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/222  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Execution: Issue and Consume Parts

**Domain**: user

### Story Description

[Durion_Accounting_Event_Contract_v1.pdf](https://github.com/user-attachments/files/24299981/Durion_Accounting_Event_Contract_v1.pdf)

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Technician / Parts Counter

## Trigger
Parts are picked/issued for installation on a workorder.

## Main Flow
1. User selects a workorder part item.
2. User records parts issued (picked) and parts consumed (installed).
3. System validates quantities and updates on-hand commitments (if integrated).
4. System records consumption event with timestamp and user.
5. System updates item completion indicators where applicable.

## Alternate / Error Flows
- Insufficient inventory â†’ flag and move workorder to waiting parts status.
- Consumption exceeds authorized quantity â†’ block or require approval per policy.

## Business Rules
- Parts usage must be recorded as events (issue/consume/return).
- Consumption should not silently change authorized scope without approval.
- Traceability must be preserved.

## Data Requirements
- Entities: WorkorderItem, PartUsageEvent, InventoryReservation
- Fields: productId, quantityIssued, quantityConsumed, eventType, eventAt, performedBy, originEstimateItemId

## Acceptance Criteria
- [ ] Parts issued/consumed can be recorded and audited.
- [ ] System enforces quantity integrity and policy limits.
- [ ] Workorder status reflects parts availability issues.
- [ ] Each issued part emits exactly one InventoryIssued event
- [ ] Inventory on-hand quantity is reduced correctly
- [ ] COGS or WIP impact follows configured accounting model
- [ ] Issued quantities are traceable to workorder and technician
- [ ] Replayed events do not double-reduce inventory

## Integrations

### Accounting
- Emits Event: InventoryIssued
- Event Type: Non-posting or Posting (configurable: WIP vs immediate COGS)
- Source Domain: workexec
- Source Entity: WorkorderPartUsage
- Trigger: Part is issued/consumed for a workorder item
- Idempotency Key: workorderId + partId + usageSequence


## Notes for Agents
Keep parts usage consistent with promotion snapshot; changes route through approvals.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #223: [FRONTEND] [STORY] Execution: Record Labor Performed  
File: ./scripts/story-work/frontend/223/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)
### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Execution: Record Labor Performed (Work Order Service Item)  
**Primary Persona:** Technician  
**Business Value:** Capture auditable technician labor (time-based or flat-rate) per work order service item to support accurate execution tracking, progress visibility, and downstream job-cost/WIP reporting without posting revenue/AR.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Technician  
- **I want** to record labor performed against a specific work order service line item (either hours or flat-rate completion) with optional notes  
- **So that** work progress is tracked accurately and the system can emit a `LaborRecorded` event for job costing/WIP, while maintaining an auditable, permissioned correction model.

### In Scope
- View work order service items eligible for labor entry.
- Create a new labor entry for a selected service item:
  - time-based hours entry **or**
  - flat-rate completion entry.
- Optional technician notes/results captured with the entry.
- Display existing labor entries for the service item (read-only list).
- Handle validation and backend errors explicitly in UI.
- Ensure UI reflects item/work order progress updates after save (via refresh).
- Support â€œcorrection by supersedingâ€ flow *only if backend exposes it* (see Open Questions).

### Out of Scope
- Defining or changing backend accounting rules/event schema contents beyond what backend returns.
- Payroll, technician pay rates, or billing calculations.
- Creating/modifying work order state machine (only reflect/trigger allowed transitions if provided).
- Parts consumption, picking, inventory allocation.
- Configuration of assignment policy, roles, or permissions.

---

## 3. Actors & Stakeholders
- **Technician (Primary):** records labor on assigned work orders/items.
- **Service Advisor (Secondary/Stakeholder):** may review or correct labor entries (permission-dependent; UI may be read-only for technician).
- **Accounting/Reporting Consumers (Downstream Stakeholder):** consumes `LaborRecorded` events; frontend must not display accounting postings as a result of labor entry.
- **System/Audit (Stakeholder):** requires immutable audit trail of entries and corrections.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- User has permission to record labor entries (exact permission string TBD; backend enforced).
- Work order exists and is in a status that allows labor recording (likely one of in-progress statuses).

### Dependencies
- Backend endpoints for:
  - loading a work order + service items + existing labor entries
  - creating a labor entry
  - (optional) superseding/correcting a labor entry
- Backend enforces:
  - assignment policy (assigned vs not assigned)
  - valid work order/item state rules
  - validation for hours and flat-rate completion constraints
  - audit logging and event emission (`LaborRecorded`)
- UI tech: Vue 3 + TypeScript + Quasar + Moqui screens integration (per repo conventions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Work Order detail** screen, within an **Execution / Services** section, technician selects a **service line item** and chooses **â€œRecord Laborâ€**.

### Screens to create/modify
1. **Modify existing Work Order detail screen** to add:
   - â€œLaborâ€ action per service item (enabled/disabled based on eligibility returned by backend or derived from status/assignment fields).
   - â€œLabor Entriesâ€ subpanel/list on the service item detail.
2. **New screen/dialog**: `WorkOrder/LaborEntryCreate` (modal or routed screen) to record labor.

> Moqui implementation note: prefer a screen with a form + transitions; can be opened as a dialog if project convention supports it.

### Navigation context
- Context parameters required:
  - `workOrderId`
  - `workOrderItemSeqId` (service item identifier; exact field name depends on backend)
- Return navigation:
  - on success â†’ back to Work Order detail, focused on the same service item.

### User workflows
**Happy path (time-based):**
1. Select service item â†’ Record Labor.
2. Choose â€œTime-basedâ€.
3. Enter `hours` (decimal) and optional `notes`.
4. Submit â†’ see success message.
5. Work order/service item refreshes; new labor entry appears in list.

**Happy path (flat-rate):**
1. Select service item â†’ Record Labor.
2. Choose â€œFlat-rate completionâ€.
3. Confirm completion and optional `notes`.
4. Submit â†’ success; refresh; entry appears.

**Alternate paths:**
- Not assigned â†’ blocked with explicit message.
- Invalid hours â†’ inline validation error; submit disabled until corrected.
- Work order not in eligible status â†’ show blocked state and explain.
- Backend returns conflict (optimistic lock/version) â†’ prompt to refresh and retry.

---

## 6. Functional Behavior

### Triggers
- User clicks **Record Labor** for a service item.

### UI actions
- Open labor entry form with:
  - Service item context header (read-only): service name/description, current item status, assigned technician (if available).
  - Input mode selector: `TIME_BASED` vs `FLAT_RATE`.
  - Inputs:
    - `hours` (only for TIME_BASED)
    - `notes` (optional, both)
  - Primary action: **Save Labor Entry**
  - Secondary action: **Cancel**

### State changes (frontend-visible)
- After successful save:
  - Labor entry list updates (via reload).
  - Work order/service item progress indicator updates (via reload).
  - If backend returns updated statuses, UI reflects them.

### Service interactions
- Load work order + items and existing labor entries on screen entry.
- Submit create labor entry on Save.
- If corrections are supported: submit â€œsupersedeâ€ action that creates a new version/entry and marks prior as superseded (exact behavior depends on backend; see Open Questions).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **BR-L1:** Labor entry must be attributable to a technician and time â†’ UI must send current user/technician identity if required by API OR rely on backend session identity (TBD).
- **BR-L2:** Support both flat-rate and time-based labor:
  - TIME_BASED requires `hours`.
  - FLAT_RATE requires `isComplete=true` (or equivalent).
- **BR-L3:** Negative or unrealistic hours:
  - Block `hours <= 0`.
  - â€œUnrealistic hoursâ€ threshold is undefined â†’ UI will only enforce `> 0` and rely on backend for upper-bound validation (blocking clarification if threshold is required).
- **BR-L4:** Auditable and reversible only with permissions:
  - UI must not allow deleting or editing existing entries unless explicit permissions and endpoints exist.
  - If â€œcorrectionâ€ exists, it must be presented as â€œCreate correction/superseding entryâ€ and require reason/note as needed by backend (TBD).

### Enable/disable rules
- Disable â€œRecord Laborâ€ if:
  - work order status is not eligible (backend-provided eligibility preferred), OR
  - item is declined/cancelled/not executable, OR
  - item is in `PENDING_APPROVAL` (change request workflow invariant), OR
  - user not assigned and policy blocks (backend should return 403/validation; UI can pre-check if assignment data is present).

### Visibility rules
- Labor entry list visible when a service item is selected.
- Correction actions visible only if backend indicates permission and provides endpoint / capability flag.

### Error messaging expectations
- 403: â€œYou donâ€™t have access to record labor on this work order/item.â€
- 409: â€œThis work order changed since you opened it. Refresh and try again.â€
- 400 validation: show field-level errors (hours, notes length, missing required fields).
- 404: â€œWork order or service item not found.â€

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `WorkOrder`
- `WorkOrderService` (or `WorkorderItem` representing a service line)
- `WorkorderLaborEntry` (source entity per integration notes)
- `WorkOrderStateTransition` / audit view (read-only, if shown)

### Fields
#### Context (read-only in form)
- `workOrderId` (ID, required)
- `workOrderItemSeqId` / `serviceItemId` (ID, required; naming TBD)
- `workOrderStatus` (enum; used to gate actions)
- `itemStatus` (enum; used to gate actions)
- `assignedTechnicianId` (ID; used for gating/display if available)

#### Labor entry create (editable)
- `laborType` (enum: `TIME_BASED` | `FLAT_RATE`, required)
- `laborHours` (decimal, required if TIME_BASED; must be > 0)
- `isComplete` (boolean, required if FLAT_RATE; must be true)
- `notes` (string/text, optional; max length TBD)

#### Labor entry display (read-only list)
- `laborEntryId` (ID)
- `technicianId`
- `laborType`
- `laborHours`
- `isComplete`
- `notes`
- `entryTimestamp` / `createdAt`
- `version` (if exposed; helpful for idempotency/corrections)
- `supersededByLaborEntryId` or `status` (if exposed; TBD)

### Derived/calculated fields
- Display-friendly duration formatting for hours (e.g., `1.5` â†’ â€œ1.5 hoursâ€).
- Progress indicator derived from backend fields (do not compute domain progress client-side).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not fully specified in provided inputs for frontend. The following is a *frontend-facing expectation* and may map to Moqui services that proxy the backend REST API.

### Load/view calls
- **Get Work Order details (incl. service items):**
  - `GET /api/workorders/{workOrderId}` *(path TBD; backend doc shows `/api/workorders/{id}/start` and `/api/work-orders/...` elsewhere; inconsistent)*
- **Get labor entries for a service item:**
  - Option A: included in work order detail response
  - Option B: `GET /api/workorders/{workOrderId}/items/{itemId}/labor-entries` (TBD)

### Create/update calls
- **Create labor entry**
  - `POST /api/workorders/{workOrderId}/items/{itemId}/labor-entries`
  - Request includes: `laborType`, `laborHours` (if TIME_BASED), `isComplete` (if FLAT_RATE), `notes`
  - Identity: inferred from auth context or explicit `technicianId` (TBD)
  - Response: created labor entry object (including `laborEntryId`, `version`)

### Submit/transition calls
- None required beyond create labor entry (unless backend also requires a work order transition on first labor; policy explicitly â€œdeferredâ€ in state machine doc; frontend should not auto-transition without explicit endpoint/capability).

### Error handling expectations
- 201/200 success: show confirmation and refresh work order/item + labor list.
- 400: map backend validation errors to form fields.
- 401: redirect to login/session expired flow per app convention.
- 403: show permission/assignment error.
- 409: prompt refresh.
- 5xx: show generic error + allow retry; log correlation id if provided.

---

## 10. State Model & Transitions

### Work order states (authoritative from `WORKORDER_STATE_MACHINE.md`)
- `DRAFT`
- `APPROVED`
- `ASSIGNED`
- `WORK_IN_PROGRESS`
- `AWAITING_PARTS`
- `AWAITING_APPROVAL`
- `READY_FOR_PICKUP`
- `COMPLETED`
- `CANCELLED`

### Allowed states for recording labor (UI gating)
- **Eligible (assumed from â€œactive work being performedâ€):**
  - `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`
- **Possibly eligible (needs clarification):**
  - `APPROVED`, `ASSIGNED` (start-eligible but not yet started)
- **Not eligible:**
  - `DRAFT`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

> Because eligibility is a domain policy decision, UI should prefer a backend-provided boolean like `canRecordLabor` at work order and/or item level. If absent, use the gating above but treat as provisional (see Open Questions).

### Role-based transitions
- This story does not introduce new work order transitions. It must not trigger `start` automatically unless explicitly required by backend policy.

### UI behavior per state
- If non-eligible: disable Record Labor and show tooltip/inline explanation using current status.
- If eligible but blocked by pending approvals/change requests (`PENDING_APPROVAL` items): disable and explain.

---

## 11. Alternate / Error Flows

### Validation failures
- TIME_BASED:
  - hours missing â†’ inline error â€œHours is required.â€
  - hours <= 0 â†’ inline error â€œHours must be greater than 0.â€
- FLAT_RATE:
  - completion not confirmed â†’ disable Save until confirmed (or enforce boolean true).

### Concurrency conflicts
- If backend responds 409 due to optimistic locking/version mismatch:
  - show message
  - provide â€œRefresh Work Orderâ€ action that reloads data and reopens the form.

### Unauthorized access
- 403:
  - if due to assignment policy â†’ message â€œYou are not assignedâ€¦â€
  - if due to permission â†’ â€œYou do not have permissionâ€¦â€

### Empty states
- No service items â†’ show â€œNo service items available for labor entry.â€
- No labor entries yet â†’ show â€œNo labor recorded yet.â€

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Record time-based labor successfully
Given I am logged in as a Technician  
And a work order exists in a labor-eligible status  
And the work order contains a service item eligible for labor recording  
When I open the service item and choose to record labor  
And I select "Time-based"  
And I enter "2.5" hours  
And I submit the labor entry  
Then a new labor entry is created for that service item with laborType "TIME_BASED" and laborHours "2.5"  
And the labor entry appears in the labor entries list after refresh  
And the work order/service item progress indicators refresh to reflect the updated labor state

### Scenario 2: Record flat-rate completion successfully
Given I am logged in as a Technician  
And a work order exists in a labor-eligible status  
And the work order contains a flat-rate service item eligible for labor recording  
When I open the service item and choose to record labor  
And I select "Flat-rate completion"  
And I confirm completion  
And I submit the labor entry  
Then a new labor entry is created for that service item with laborType "FLAT_RATE" and isComplete "true"  
And the labor entry appears in the labor entries list after refresh

### Scenario 3: Block negative or zero labor hours
Given I am logged in as a Technician  
And I am recording time-based labor for a service item  
When I enter "0" hours  
Then the Save action is disabled or the form shows a validation error for hours  
And no request is sent to create a labor entry  
When I enter "-1" hours  
Then the form shows a validation error for hours  
And I cannot submit the labor entry

### Scenario 4: Reject labor entry when technician is not assigned (policy-enforced)
Given I am logged in as a Technician  
And I am not assigned to the target work order or service item  
When I attempt to submit a labor entry  
Then the system rejects the request with an authorization/assignment error  
And I see the message "You are not assigned to this work order/item. Please see the Service Advisor."  
And no labor entry is added to the list

### Scenario 5: Work order in invalid state blocks labor recording
Given I am logged in as a Technician  
And a work order is in status "COMPLETED"  
When I view its service items  
Then the Record Labor action is disabled  
And the UI explains that labor cannot be recorded in status "COMPLETED"

### Scenario 6: Concurrency conflict requires refresh
Given I am logged in as a Technician  
And I have the labor entry form open for a service item  
When the backend responds with a 409 conflict while saving  
Then I see a message indicating the work order changed  
And I am offered an action to refresh and retry  
And no duplicate labor entry is shown

---

## 13. Audit & Observability

### User-visible audit data
- Show each labor entry with:
  - created timestamp
  - technician identifier (name if available; otherwise ID)
  - notes (if any)

### Status history
- If the backend exposes work order transition history, provide a link from work order detail to â€œStatus Historyâ€ (read-only). Not required to implement here unless already present.

### Traceability expectations
- Each labor entry displayed must include `laborEntryId` and (if available) `version` for support/debugging.
- On error responses, log (client-side) request id/correlation id header if provided by backend.

---

## 14. Non-Functional UI Requirements
- **Performance:** labor entry form opens within 300ms after data is loaded; submission shows loading state; refresh avoids full page reload if possible.
- **Accessibility:** all form fields have labels; validation errors are announced (aria) and associated with fields; keyboard navigable.
- **Responsiveness:** usable on tablet-sized devices (technician use case).
- **i18n/timezone:** display timestamps in local timezone with clear format; do not change stored UTC semantics.
- **Currency:** not applicable (no pricing display required).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messages for no service items / no labor entries; qualifies as safe UI ergonomics; impacts UX Summary, Error Flows.
- SD-ERR-STD-MAP: Standard HTTP error-to-message mapping (400/401/403/404/409/5xx) without assuming domain policy; qualifies as safe error-handling; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. **Backend API contract:** What are the exact REST endpoints and payload schemas for:
   - loading work order + service items
   - listing labor entries for a service item
   - creating a labor entry
   - correcting/superseding an entry (if supported)?
2. **Identifier naming:** Is the service item identifier `workorderItemSeqId`, `serviceItemId`, or something else in the frontend/backend contract?
3. **Assignment policy UX:** When unassigned, should the UI *block* (no form) or *allow entry and let backend reject*? Is there a backend field/capability like `isAssignedToCurrentUser`?
4. **Labor eligibility statuses:** Can labor be recorded when work order is `APPROVED` or `ASSIGNED` (before `WORK_IN_PROGRESS`), or only during in-progress sub-statuses?
5. **â€œUnrealistic hoursâ€ rule:** Is there a numeric upper bound or heuristic (per entry or per day) that the UI must enforce, or is backend-only validation sufficient?
6. **Correction flow:** Are labor entries immutable with corrections via a new â€œsupersedingâ€ entry endpoint? If yes, what permissions and required fields (reason code, note) are needed, and should technicians have access or only advisors?
7. **Technician identity:** Should `technicianId` be sent explicitly in the create request, or derived from the authenticated user session?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Execution: Record Labor Performed  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/223  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Execution: Record Labor Performed

**Domain**: user

### Story Description

[Durion_Accounting_Event_Contract_v1.pdf](https://github.com/user-attachments/files/24300002/Durion_Accounting_Event_Contract_v1.pdf)

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Technician

## Trigger
Technician performs labor associated with a workorder service item.

## Main Flow
1. Technician selects a labor/service line item.
2. Technician records time (start/stop or hours) or marks a flat-rate completion.
3. Technician adds notes/results (optional).
4. System validates permissions and records labor entry.
5. System updates workorder progress and completion indicators.

## Alternate / Error Flows
- Labor entry attempted without assignment â†’ block or warn per policy.
- Negative or unrealistic hours â†’ block and require correction.

## Business Rules
- Labor entries must be attributable to a technician and time.
- Support both flat-rate and time-based labor.
- Entries must be auditable and reversible only with permissions.

## Data Requirements
- Entities: Workorder, WorkorderItem, LaborEntry, AuditEvent
- Fields: workorderId, itemSeqId, technicianId, hours, flatRateFlag, notes, createdAt

## Acceptance Criteria
- [ ] Technicians can record labor entries on assigned workorders.
- [ ] Labor entries are auditable and tied to service items.
- [ ] Progress updates reflect labor completion.
- [ ] Labor entries emit LaborRecorded events when saved
- [ ] Labor events do not create AR or revenue
- [ ] Labor cost is available for job costing or WIP reporting
- [ ] Updates to labor entries supersede prior events
- [ ] Duplicate events do not create duplicate labor cost

## Integrations

### Accounting
- Emits Event: LaborRecorded
- Event Type: Non-posting (job cost / WIP tracking)
- Source Domain: workexec
- Source Entity: WorkorderLaborEntry
- Trigger: Labor entry recorded or completed
- Idempotency Key: workorderId + laborEntryId + version


## Notes for Agents
Even if prices are hidden, labor quantities must remain accurate for invoicing.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #224: [FRONTEND] [STORY] Execution: Start Workorder and Track Status  
File: ./scripts/story-work/frontend/224/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Execution: Start Work Order and Track Status (WIP Reasons + History)

### Primary Persona
Technician (primary), Shop Manager (secondary)

### Business Value
Provide explicit, auditable work order start and in-progress status reason tracking so the shop can see real-time execution state, prevent starting work when blocked by pending approvals, and retain immutable history for operational analytics.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Technician or Shop Manager  
- **I want** to explicitly start a work order and update its in-progress reason (waiting parts/approval/etc.)  
- **So that** the system accurately reflects execution progress, enforces start eligibility rules, and preserves an immutable status/reason history.

### In Scope
- Work order detail UI shows current status and in-progress reason (when applicable).
- â€œStart Workâ€ action that calls backend start endpoint and updates UI state.
- â€œUpdate In-Progress Reasonâ€ action available only while work order is in `WORK_IN_PROGRESS`.
- Read-only, append-only history view of status/reason changes (transition audit list).
- Frontend handling for blocked start (non-startable state, pending blocking change request).
- Explicit mapping of API/service calls, error handling, and Moqui screen transitions.

### Out of Scope
- Auto-start on first labor entry (explicitly out of scope; follow-on story).
- Creating/approving/declining change requests (only used as a blocking condition display).
- Any new workflow states beyond those enumerated in the authoritative work order FSM.
- Permission model design (frontend respects API 401/403; does not invent RBAC rules).

---

## 3. Actors & Stakeholders
- **Technician:** starts work, updates in-progress reason during execution.
- **Shop Manager:** may start work and update reason; monitors progress.
- **Service Advisor:** indirect stakeholder (change requests may block start).
- **Audit/Operations:** relies on immutable history for compliance and analytics.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS frontend.
- Work order exists and is viewable by the user.
- Backend endpoints for:
  - loading work order details,
  - starting a work order,
  - updating in-progress reason,
  - retrieving transition/history events,
  are available and accessible.

### Dependencies
- Backend workexec state machine implementation and contracts (status + reason rules, blocking change request rule).
- A backend endpoint (or embedded field in work order response) that indicates whether the work order has blocking change requests, or a deterministic way to query them.

> **Note:** Provided references conflict on start-eligible statuses (`SCHEDULED` appears in one backend story excerpt but the authoritative FSM doc says start-eligible is `APPROVED`, `ASSIGNED`). This story cannot be finalized without confirming the canonical contract for frontend gating and error copy.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From â€œMy Workâ€ / â€œAssigned Work Ordersâ€ list: open a work order detail.
- From search results / work order lookup: open work order detail.

### Screens to create/modify
1. **Modify** `WorkOrderDetail` screen (existing or new under a workexec menu tree):
   - Add action controls: `Start Work` button (conditional)
   - Add reason selector (conditional)
   - Add status/reason history section or link
2. **Create/Modify** `WorkOrderStatusHistory` embedded section or separate screen:
   - List of immutable status/reason change events (read-only)

*(Exact screen paths/components depend on repo conventions; implement within Moqui screen XML and Vue/Quasar components as used in durion-moqui-frontend.)*

### Navigation context
- Work order detail remains the canonical place for execution actions.
- After successful start or reason change, remain on same screen and refresh data.

### User workflows
#### Happy path: Start work
1. User opens work order detail.
2. UI shows `Start Work` enabled if startable and not blocked.
3. User clicks `Start Work`.
4. UI prompts for optional â€œreasonâ€ text (if backend accepts) or proceeds directly.
5. Backend returns updated state; UI refreshes:
   - status becomes `WORK_IN_PROGRESS`
   - reason defaults to `ACTIVE_WORK`
   - started-at timestamp displays (read-only)
6. Status history shows a new entry for the start transition.

#### Happy path: Update in-progress reason
1. While in `WORK_IN_PROGRESS`, UI shows reason selector.
2. User selects reason (e.g., `WAITING_PARTS`) and confirms.
3. Backend persists reason change; UI refreshes and history shows a reason-change entry.

#### Alternate path: Start blocked
- If backend rejects start due to:
  - non-startable status, or
  - blocking change request,
  UI shows the backend message and keeps state unchanged.

---

## 6. Functional Behavior

### Triggers
- User clicks `Start Work`.
- User changes `In-Progress Reason` while in `WORK_IN_PROGRESS`.

### UI actions
- **Start Work**
  - Visible when work order status is start-eligible (see State Model section).
  - Disabled with inline explanation if blocked by change request (if known from data).
  - On click: call start service, then reload work order + history.
- **Update In-Progress Reason**
  - Visible only when status is `WORK_IN_PROGRESS`.
  - Allowed values constrained to the backend enum list.
  - On submit: call reason update service, then reload work order + history.
- **View history**
  - Always available (read-only list).
  - Supports empty state (â€œNo status history yetâ€).

### State changes (frontend-observable)
- On successful start: status transitions to `WORK_IN_PROGRESS`, reason becomes `ACTIVE_WORK`, started-at populated.
- On reason update: status remains `WORK_IN_PROGRESS`, reason changes to selected value.
- History list grows append-only (frontend treats it as immutable).

### Service interactions
- Load work order details (GET).
- Start work order (POST).
- Update in-progress reason (POST/PUT; TBD exact endpoint).
- Load transitions/history (GET).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Start Work** action:
  - Must not be offered/enabled when status is not start-eligible (frontend gating), but backend remains the source of truth.
  - Must be blocked when a pending blocking change request exists (frontend displays block if backend provides signal; otherwise rely on backend rejection message).
- **Update Reason** action:
  - Only permitted when status is `WORK_IN_PROGRESS`.
  - Only allowed reason values:
    - `ACTIVE_WORK`
    - `WAITING_PARTS`
    - `WAITING_CUSTOMER_APPROVAL`
    - `WAITING_DIAGNOSIS`
    - `WAITING_EXTERNAL_SERVICE`
    - `PAUSED_BY_SHOP`
  - Invalid value should not be selectable; if backend rejects anyway, show validation error.

### Enable/disable rules
- Start button:
  - Enabled if `status âˆˆ StartEligibleStatuses` AND `hasBlockingChangeRequest != true`
  - Disabled otherwise, with inline reason:
    - â€œNot startable in current status: <status>â€
    - or â€œBlocked: pending approval requiredâ€
- Reason selector:
  - Enabled only when `status == WORK_IN_PROGRESS`.

### Visibility rules
- Show `inProgressReason` field only when `status == WORK_IN_PROGRESS` (or show read-only â€œâ€”â€ otherwise).
- Show `workStartedAt` when present.

### Error messaging expectations
- Prefer backend-provided message strings for business-rule rejections.
- Standard mappings:
  - 400: validation error â†’ show field-level or banner message
  - 401: not authenticated â†’ redirect/login flow (project standard)
  - 403: forbidden â†’ â€œYou do not have permission to perform this action.â€
  - 404: not found â†’ â€œWork order not found.â€
  - 409: conflict/concurrency â†’ â€œWork order was updated by another user. Refresh and try again.â€

---

## 8. Data Requirements

### Entities involved (frontend consumption)
- `WorkOrder`
- `WorkOrderStateTransition` and/or `WorkOrderStatusHistory` (naming differs between provided backend references; must match actual API)
- `ChangeRequest` (read-only signal for blocking condition; details optional)

### Fields
#### WorkOrder (read)
- `id` (string/uuid; required)
- `status` (string enum; required)
- `inProgressReason` (string enum; nullable; required when status is `WORK_IN_PROGRESS`)
- `workStartedAt` (ISO-8601 UTC timestamp; nullable)
- (optional but useful) `assignedTo`, `customer`, `vehicle` summary fields if already present on the screen

#### History record (read)
- `id` (string/uuid; required)
- `workOrderId` (string/uuid; required)
- `fromStatus` (string; nullable)
- `toStatus` (string; required)
- `changeType` (enum: `STATUS_CHANGE` | `REASON_CHANGE`; required)
- `reason` (string; optional free text)
- `changedByUserId` (string/uuid; required)
- `changedAt` (ISO-8601 UTC timestamp; required)
- (optional) `metadata` (JSON; optional)

#### Blocking change request signal (read)
One of:
- `hasBlockingChangeRequest` (boolean), OR
- list endpoint that returns change requests with statuses/types, OR
- backend start endpoint returns a specific error code when blocked.

### Read-only vs editable
- Editable:
  - Start action (no direct field edit)
  - `inProgressReason` (only while WIP)
- Read-only:
  - `status`
  - `workStartedAt`
  - All history records

### Derived/calculated fields (frontend)
- `isStartEnabled` = computed based on status + blocking flag (if available)
- Display-friendly labels for statuses and reason enums (i18n-ready keys)

---

## 9. Service Contracts (Frontend Perspective)

> **Important:** Endpoint paths differ between provided references:
> - FSM doc uses: `POST /api/workorders/{id}/start`, `GET /api/workorders/{id}/transitions`
> - backend story excerpt uses: `POST /workexec/v1/workorders/{id}:start`
>
> Frontend cannot be buildable until canonical routes are confirmed.

### Load/view calls
- `GET <TBD> /api/workorders/{id}`  
  **Response:** WorkOrder DTO including status/reason/startedAt (and optionally blocking flag)
- `GET <TBD> /api/workorders/{id}/transitions` (or `/history`)  
  **Response:** list of transition/history records sorted by `changedAt` ascending or descending (must be specified)

### Create/update calls
- **Start work order**
  - `POST <TBD> /api/workorders/{id}/start` or `POST /workexec/v1/workorders/{id}:start`
  - Request body (FSM doc): `{ "userId": <id>, "reason": <string?> }`
  - **Frontend requirement:** obtain `userId` from session context if backend allows; do not prompt user to type userId.
- **Update in-progress reason**
  - `POST/PUT <TBD>` (not specified in provided references)
  - Request body should minimally include: `{ "inProgressReason": "WAITING_PARTS", "reason": "<optional note>" }` (TBD)

### Submit/transition calls
- Start and reason change are both transitions from frontendâ€™s perspective.

### Error handling expectations
- Must display backend business-rule messages for:
  - non-startable state
  - blocked by pending change request
- Must treat 409 as refresh-needed concurrency.

---

## 10. State Model & Transitions

### Allowed states (authoritative FSM doc)
- `DRAFT`
- `APPROVED`
- `ASSIGNED`
- `WORK_IN_PROGRESS`
- `AWAITING_PARTS`
- `AWAITING_APPROVAL`
- `READY_FOR_PICKUP`
- `COMPLETED`
- `CANCELLED`

### Start transition
- Allowed â€œstart eligibleâ€ statuses per FSM doc: **`APPROVED`, `ASSIGNED`**
- Start transitions to: `WORK_IN_PROGRESS`

> **Conflict:** backend story excerpt also mentions `SCHEDULED` as startable, but FSM doc does not include `SCHEDULED`. Must clarify which is correct for frontend gating and tests.

### In-progress reason (sub-status)
- Only valid while `status == WORK_IN_PROGRESS`
- Allowed enum values listed in section 7.

### Role-based transitions
- Not specified in provided inputs. Frontend must rely on backend authorization (403) and avoid inventing role gating.

### UI behavior per state
- `APPROVED` / `ASSIGNED`: show Start button (enabled unless blocked).
- `WORK_IN_PROGRESS`: hide Start; show reason selector; show startedAt; show history.
- Other states: no Start; reason selector hidden/disabled; history still viewable.

---

## 11. Alternate / Error Flows

### Validation failures
- Setting reason when not in `WORK_IN_PROGRESS` â†’ backend rejects (400/409). UI shows message and refreshes work order.
- Invalid reason enum â†’ backend rejects (400). UI should not allow selection.

### Concurrency conflicts
- Two users attempt start or reason change:
  - If backend returns 409, UI shows conflict message and reloads work order + history.

### Unauthorized access
- 401 â†’ route to login / session renewal (per app convention).
- 403 â†’ show permission error; keep screen read-only.

### Empty states
- No history records returned:
  - Show â€œNo status history recorded yet.â€

---

## 12. Acceptance Criteria

### Scenario 1: Start work order from APPROVED
**Given** a work order exists with `status = APPROVED`  
**And** there is no blocking pending change request for the work order  
**And** I am an authenticated Technician  
**When** I open the work order detail screen  
**Then** I see a `Start Work` action enabled  

**When** I click `Start Work`  
**Then** the frontend calls the start endpoint for that work order  
**And** on success the UI refreshes and shows `status = WORK_IN_PROGRESS`  
**And** `inProgressReason = ACTIVE_WORK` is displayed  
**And** `workStartedAt` is displayed as a UTC timestamp  
**And** the history list includes a new `STATUS_CHANGE` entry from `APPROVED` to `WORK_IN_PROGRESS`.

### Scenario 2: Start work order from ASSIGNED
**Given** a work order exists with `status = ASSIGNED`  
**And** there is no blocking pending change request  
**When** I click `Start Work`  
**Then** the work order transitions to `WORK_IN_PROGRESS` and the UI reflects the same outcomes as Scenario 1.

### Scenario 3: Reject start from non-startable state
**Given** a work order exists with `status = COMPLETED`  
**When** I open the work order detail screen  
**Then** I do not see `Start Work`, or it is disabled with an explanation  

**When** I attempt to start via any available UI affordance  
**Then** the backend rejection is shown (message includes current status)  
**And** the UI remains showing `status = COMPLETED`  
**And** no new history entry appears after refresh.

### Scenario 4: Block start due to pending change request
**Given** a work order exists with `status` in a start-eligible state  
**And** a blocking change request exists (pending approval / awaiting advisor review per backend contract)  
**When** I click `Start Work`  
**Then** the backend rejects the request  
**And** the UI shows: â€œCannot start work. A pending change request requires approval before proceeding.â€ (or backend-provided equivalent)  
**And** the work order status remains unchanged after refresh.

### Scenario 5: Change in-progress reason
**Given** a work order exists with `status = WORK_IN_PROGRESS` and `inProgressReason = ACTIVE_WORK`  
**When** I set the in-progress reason to `WAITING_PARTS` and confirm  
**Then** the frontend calls the reason update endpoint  
**And** the UI refreshes and shows `inProgressReason = WAITING_PARTS`  
**And** the canonical `status` remains `WORK_IN_PROGRESS`  
**And** the history list includes a new `REASON_CHANGE` entry.

### Scenario 6: Prevent reason change when not in WORK_IN_PROGRESS
**Given** a work order exists with `status = APPROVED`  
**When** I view the work order detail screen  
**Then** I cannot edit the in-progress reason  

**When** a reason update is attempted (e.g., stale UI)  
**Then** the UI displays the backend validation error  
**And** after refresh the work order remains unchanged.

### Scenario 7: Concurrency conflict handling
**Given** I have the work order detail open  
**And** another user starts the work order or changes its reason before I submit my action  
**When** I click `Start Work` or update the reason  
**And** the backend returns `409 Conflict`  
**Then** the UI displays a conflict message prompting refresh  
**And** the UI reloads the latest work order state and history.

---

## 13. Audit & Observability

### User-visible audit data
- Show a history list including:
  - from/to status (when present)
  - change type (status vs reason change)
  - changed at (UTC displayed in user locale formatting but sourced from UTC)
  - changed by (display userId; optionally resolve to name if already supported)
  - optional note/reason text

### Status history
- Must be immutable (read-only UI; no edit/delete controls).
- Default sort: most recent first (unless repo conventions dictate otherwise).

### Traceability expectations
- Every start and reason change performed through UI must result in a corresponding history entry visible after refresh.

---

## 14. Non-Functional UI Requirements

- **Performance:** Work order detail load (including history) should render within 2 seconds on typical shop network; history can be paginated if large.
- **Accessibility:** Actions must be keyboard accessible; buttons have discernible labels; validation errors announced to screen readers (Quasar standard patterns).
- **Responsiveness:** Usable on tablet form factor (common in shop floor).
- **i18n/timezone:** Display timestamps in local time with explicit indication they originate from UTC; enum labels use i18n keys where available.

---

## 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE**: Provide explicit empty state text for history list when no records exist; safe because itâ€™s purely UI ergonomics. (Impacted: UX Summary, Error Flows, Acceptance Criteria)
- **SD-UX-PAGINATION**: Paginate history list when record count is large (page size TBD by existing conventions); safe as it doesnâ€™t change domain behavior. (Impacted: UX Summary, Non-Functional)
- **SD-ERR-HTTP-MAP**: Standard HTTP error mapping (401/403/404/409/5xx) to user messages; safe because it follows implied backend contract patterns without inventing business rules. (Impacted: Business Rules, Error Flows, Service Contracts)

---

## 16. Open Questions

1. **Canonical API routes:** What are the exact Moqui endpoints for:
   - start work order,
   - update in-progress reason,
   - load transitions/history?
   (Provided references conflict: `/api/workorders/{id}/start` vs `/workexec/v1/workorders/{id}:start`.)

2. **Start-eligible statuses:** Is `SCHEDULED` a valid startable status for work orders in this system?
   - FSM doc: start-eligible = `APPROVED`, `ASSIGNED`
   - backend story excerpt: includes `SCHEDULED`
   Frontend gating + test cases depend on the canonical list.

3. **Blocking change request status naming:** For â€œpending approval change request,â€ should frontend consider:
   - `AWAITING_ADVISOR_REVIEW` (from Change Request workflow doc), or
   - `PENDING_APPROVAL` (from backend story excerpt),
   or both? What does the backend actually return?

4. **Reason update contract:** What is the endpoint + request schema to change `inProgressReason`, and does it accept an optional user-entered note/reason that is stored in history?

5. **History entity naming/shape:** Should frontend call `/transitions` (FSM doc) or a `WorkOrderStatusHistory` endpoint (backend story excerpt)? What fields are guaranteed in response?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Execution: Start Workorder and Track Status  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/224  
Labels: frontend, story-implementation, user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Technician / Shop Manager

## Trigger
Technician begins work on an assigned workorder.

## Main Flow
1. Technician opens assigned workorder.
2. Technician selects 'Start Work' (or shop auto-starts on first labor entry).
3. System transitions workorder to InProgress with validation.
4. Technician updates status codes as needed (waiting parts, waiting approval).
5. System records status change events.

## Alternate / Error Flows
- Workorder not in executable state â†’ block start and show reason.
- Pending approval change request â†’ block progression into billable new work.

## Business Rules
- State transitions must be explicit and validated.
- Status history must be retained.

## Data Requirements
- Entities: Workorder, WorkorderStatusEvent, ChangeRequest
- Fields: status, statusReason, changedBy, changedAt, changeRequestId

## Acceptance Criteria
- [ ] Workorder can be started only when in proper state.
- [ ] Status changes are recorded and visible.
- [ ] Approval-gated statuses prevent unauthorized scope expansion.

## Notes for Agents
Use status events for throughput/cycle-time analytics later.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #225: [FRONTEND] [STORY] Execution: Assign Technician to Workorder  
File: ./scripts/story-work/frontend/225/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Execution: Assign Technician to Workorder

### Primary Persona
Shop Manager / Dispatcher

### Business Value
Ensures each execution-ready work order has clear technician accountability, proper technician visibility in the POS, and a complete reassignment history for operational reporting and auditability.

---

## 2. Story Intent

### As a / I want / So that
**As a** Shop Manager / Dispatcher,  
**I want** to assign (and reassign) a primary technician (or crew) to a work order that is ready to be worked,  
**so that** the right technician can see and execute the work order and the assignment is tracked with an auditable history.

### In-scope
- View current assignment for a Work Order.
- Assign a technician to an assignable Work Order.
- Reassign a Work Order to a different technician while retaining history.
- Display assignment history (who, when, reason, unassigned time).
- Enforce authorization failures in the UI (no silent failures).
- Ensure assigned technician visibility is reflected in UI behavior (e.g., technician can see the work order after assignment) **to the extent supported by backend**.

### Out-of-scope
- Defining/implementing technician availability and schedule policy (warn vs block) (needs clarification).
- Implementing notification delivery channels or templates (optional behavior, needs clarification).
- Creating/updating Work Order status lifecycle beyond â€œassignment may move status to ASSIGNEDâ€ as provided by backend state machine doc; any additional transition policy not specified is out of scope.
- Backend entity/schema design (frontend will consume exposed APIs).

---

## 3. Actors & Stakeholders

- **Primary Actor:** Shop Manager / Dispatcher (assigns/reassigns).
- **Secondary Actor:** Technician (recipient of assignment; gains default visibility).
- **Stakeholders:**
  - Service Advisor (needs to see who is assigned).
  - Operations Manager (needs assignment history for metrics/audits).
- **System Actors/Dependencies:**
  - Authorization/RBAC system (permission checks).
  - Work Order state machine/audit trail (domain:workexec).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- A Work Order exists and is in an assignable state (exact statuses need confirmation; at minimum, a â€œReady/Scheduledâ€ concept exists).
- A list of eligible technicians exists.

### Dependencies (blocking where undefined)
- **Backend API contract for assignment** (endpoints, payloads, and error codes are not provided for frontend story; must be confirmed).
- **Definition of â€œassignableâ€ Work Order statuses** for assignment action in UI (conflicts with workexec state machine list that does not include â€œSCHEDULED/READYâ€; needs clarification).
- **Crew assignment support**: story mentions â€œtechnician or crewâ€ but data requirements list only `technicianId`; needs clarification.
- **Technician visibility mechanism**: whether visibility is implied by backend filtering, explicit ACL grants, or both; needs clarification.
- **Notification behavior** (optional) and its API; needs clarification.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order List screen: action â€œAssign Technicianâ€¦â€ on each row or within Work Order detail.
- From Work Order Detail screen: â€œAssignmentâ€ section with current assignment and â€œAssign/Reassignâ€ action.

### Screens to create/modify (Moqui)
- **Modify** `WorkOrderDetail` screen: add â€œAssignmentâ€ section:
  - current assigned technician (if any)
  - assign/reassign action
  - assignment history sub-panel/table
- **Modify** `WorkOrderList` screen: expose quick action to open assignment dialog (optional, can be deferred if detail screen is primary).
- **Create** `WorkOrderAssignDialog` (embedded screen/dialog):
  - technician selection control
  - optional reason field (see Open Questionsâ€”field exists in requirements)
  - submit/cancel actions

### Navigation context
- Users remain in Work Order context; assignment dialog returns to the same Work Order detail/list with refreshed data.
- After successful assignment, UI reflects:
  - assigned technician name
  - assignment timestamp
  - updated status badge if backend transitions status to `ASSIGNED`

### User workflows
- **Happy path (assign):**
  1. Open Work Order detail.
  2. Click â€œAssign Technicianâ€.
  3. Select technician.
  4. (If required/available) enter reason.
  5. Submit â†’ success toast/banner â†’ refresh assignment + history.
- **Happy path (reassign):**
  1. Work Order already has active assignment.
  2. Click â€œReassignâ€.
  3. Select a different technician.
  4. Submit â†’ history shows prior assignment ended + new active assignment.
- **Alternate paths:**
  - Work Order not assignable â†’ action hidden/disabled with explanation.
  - Unauthorized â†’ action hidden; if attempted via direct URL/action, show forbidden.
  - Technician unavailable (policy-dependent) â†’ warn or block (clarification required).

---

## 6. Functional Behavior

### Triggers
- User clicks â€œAssign/Reassign Technicianâ€ for a selected Work Order.

### UI actions
- Load eligible technicians list.
- Present selection UI (searchable dropdown recommended).
- Validate required fields client-side (selection; reason if required).
- Submit assignment request.
- Refresh Work Order summary and assignment history on success.

### State changes (frontend-observed)
- Work Order may transition to `ASSIGNED` upon successful assignment (per backend reference).
- Active assignment swaps on reassignment:
  - previous assignment gets an `unassignedAt`
  - new assignment created with `assignedAt`
- UI must treat assignment history as append-only (no delete/edit controls).

### Service interactions (high-level)
- Fetch Work Order detail (includes status and assignment info OR requires separate calls).
- Fetch technicians (eligible list).
- Create assignment / reassign (single endpoint or same endpoint with overwrite semantics).
- Fetch assignment history (if not included in Work Order detail).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- A technician must be selected to submit.
- Work Order must be in an assignable status; otherwise submit is blocked.
- Only one active assignment is allowed; UI should not attempt to create a second active assignmentâ€”backend is source of truth.
- If â€œreasonâ€ is required by backend/policy, UI must require non-empty input (currently unclear â†’ Open Question).

### Enable/disable rules
- â€œAssignâ€ button disabled until technician selected (and reason filled if required).
- If current status is not assignable, hide/disable assignment controls and show read-only messaging: â€œThis work order cannot be assigned in its current status.â€

### Visibility rules
- Assignment section visible to roles that can view Work Orders.
- Assignment action visible only if user has assignment permission (permission key needs clarification; backend ref mentions `WORKORDER_ASSIGN`).
- Assignment history visible read-only to permitted viewers.

### Error messaging expectations
- 403 â†’ â€œYou donâ€™t have permission to assign technicians.â€
- 404 â†’ â€œWork order not found or you no longer have access.â€
- 409/400 invalid state â†’ â€œWork order is not in a valid status for assignment.â€
- Technician eligibility failure (400) â†’ â€œSelected user is not eligible to be assigned as a technician.â€
- Availability-policy failure (409) â†’ message depends on backend response; must surface backend message safely.

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `WorkOrder` (work order being assigned)
- `TechnicianAssignment` (assignment history records)
- `User` (technician and assigner)
- `Notification` (only if implemented; currently optional/unclear)

### Fields (type, required, defaults)
**WorkOrder (read)**
- `workOrderId` (string/UUID/long; required)
- `status` (enum/string; required)
- `assignedTechnician` (object; optional)  
  - `technicianId` (id; required if present)  
  - `displayName` (string; required if present)
- `shopId/locationId` (id; optional but likely needed to filter technicians; unclear)

**TechnicianAssignment (read-only history list)**
- `workOrderId` (id; required)
- `technicianId` (id; required)
- `technicianName` (string; required for display)
- `assignedBy` (id; required)
- `assignedByName` (string; required for display)
- `assignedAt` (timestamp UTC; required)
- `unassignedAt` (timestamp UTC; nullable)
- `reason` (string; nullable unless policy says required)

**Assignment request (write)**
- `workOrderId` (path param or body; required)
- `technicianId` (required)
- `reason` (optional/required? â†’ Open Question)

### Read-only vs editable by state/role
- Editable: only by users with assignment permission and only when Work Order status is assignable.
- Read-only: history is always read-only.

### Derived/calculated fields
- â€œCurrent Technicianâ€ is the record where `unassignedAt` is null (or `isActive=true` if backend uses that).
- â€œAssignment ageâ€ (optional UI) derived from `assignedAt` (safe ergonomic default if desired).

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: exact Moqui endpoints/services are not provided in inputs. Below defines required contracts the frontend needs. If the backend differs, adjust to actual services once confirmed.

### Load/view calls
1. **Get Work Order detail**
   - `GET /api/workorders/{workOrderId}`
   - Response must include at least: `workOrderId`, `status`, and current assignment summary (or enough to render current technician).
2. **Get assignment history**
   - Option A: included in Work Order detail as `assignments[]`
   - Option B: separate endpoint:
     - `GET /api/workorders/{workOrderId}/technician-assignments`

3. **List eligible technicians**
   - `GET /api/technicians?locationId={locationId}` (or equivalent)
   - Must return: `technicianId`, `displayName`, and optionally availability flags if policy exists.

### Create/update calls
- **Assign/Reassign technician**
  - Option A (preferred): `POST /api/workorders/{workOrderId}/assign-technician`
    - Body: `{ "technicianId": <id>, "reason": <string?> }`
  - Option B: `POST /api/technician-assignments`
    - Body: `{ "workOrderId": <id>, "technicianId": <id>, "reason": <string?> }`

### Submit/transition calls
- If assignment changes Work Order status to `ASSIGNED`, backend should do it atomically; frontend must not separately call a â€œtransition statusâ€ endpoint for assignment.

### Error handling expectations
- `201/200` success â†’ refresh Work Order + history.
- `400` validation â†’ show field-level errors when possible; otherwise show banner.
- `403` forbidden â†’ show permission error; keep UI read-only.
- `404` not found â†’ navigate back to list with message.
- `409` conflict (invalid state, concurrency, availability blocking) â†’ show conflict message and refresh Work Order.

---

## 10. State Model & Transitions

### Allowed states (as provided by authoritative workexec state machine doc)
WorkOrder statuses include:
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

### Role-based transitions (relevant to this story)
- Assignment action is expected to result in Work Order status `ASSIGNED` when successful (backend reference).
- Assignment should be allowed when work order is start-eligible or â€œready/scheduledâ€; however the canonical state machine lists start-eligible as `APPROVED` and `ASSIGNED`. â€œSCHEDULED/READY_FOR_WORKâ€ are mentioned in the backend story reference but not in the FSM doc â†’ **clarification required**.

### UI behavior per state (minimum deterministic behavior)
- `DRAFT`: assignment controls hidden/disabled (unless clarified otherwise).
- `APPROVED`: assignment controls enabled (assumed based on â€œstart-eligibleâ€ set including APPROVED; needs confirmation but is most consistent).
- `ASSIGNED`: reassign enabled; current technician visible.
- `WORK_IN_PROGRESS` and other in-progress states: reassign behavior unclear (often restricted) â†’ Open Question; UI should default to disabled until clarified.
- `COMPLETED`/`CANCELLED`: assignment controls disabled; history still visible.

---

## 11. Alternate / Error Flows

### Validation failures
- No technician selected â†’ inline validation; no request sent.
- Backend rejects due to invalid status â†’ show conflict message and refresh.

### Concurrency conflicts
- If another user assigns/reassigns while dialog open:
  - On submit, backend returns `409` (or returns updated assignment).
  - UI shows â€œAssignment has changed; please review latest assignment.â€ then refresh and re-open dialog if user chooses.

### Unauthorized access
- User lacks permission:
  - UI hides assignment action where feasible.
  - If user navigates directly (deep link), call fails with `403`; show read-only page state.

### Empty states
- No eligible technicians returned:
  - Show â€œNo technicians available to assign.â€ with guidance (e.g., â€œCheck technician setupâ€) without inventing ownership.

---

## 12. Acceptance Criteria

### Scenario 1: Assign technician to an APPROVED work order
**Given** I am logged in as a Shop Manager/Dispatcher with permission to assign technicians  
**And** a Work Order exists with status `APPROVED`  
**When** I open the Work Order detail and assign Technician A  
**Then** the system records the assignment with `assignedAt` and `assignedBy`  
**And** the Work Order displays Technician A as the current assigned technician  
**And** the Work Order status is `ASSIGNED` (if backend transitions on assignment)  
**And** the assignment history shows a new active assignment entry for Technician A

### Scenario 2: Reassign technician preserves history
**Given** I am logged in with permission to assign technicians  
**And** a Work Order exists with status `ASSIGNED`  
**And** Technician A is currently assigned  
**When** I reassign the Work Order to Technician B  
**Then** the previous assignment entry for Technician A shows an `unassignedAt` timestamp  
**And** a new assignment entry exists for Technician B with `assignedAt` and no `unassignedAt`  
**And** the Work Order displays Technician B as current assigned technician

### Scenario 3: Unauthorized user cannot assign
**Given** I am logged in without the technician-assignment permission  
**And** a Work Order exists with status `APPROVED`  
**When** I attempt to access the assign action (via UI or direct request)  
**Then** the UI prevents assignment (action hidden or disabled)  
**And** if a request is attempted, the system responds with `403 Forbidden`  
**And** no assignment history changes are visible after refresh

### Scenario 4: Work order in non-assignable status is blocked
**Given** I am logged in with permission to assign technicians  
**And** a Work Order exists with status `COMPLETED` (or `CANCELLED`)  
**When** I view the Work Order  
**Then** assignment controls are disabled or not shown  
**And** the UI explains that assignment is not allowed in the current status  
**And** assignment history remains viewable

### Scenario 5: Backend rejects selected technician as ineligible
**Given** I am logged in with permission to assign technicians  
**And** a Work Order exists with an assignable status  
**When** I submit an assignment selecting a user that backend deems not eligible as a technician  
**Then** the UI shows a validation error message returned by the backend (sanitized)  
**And** the Work Order assignment remains unchanged after refresh

### Scenario 6: Technician availability policy enforcement (placeholder until clarified)
**Given** I am logged in with permission to assign technicians  
**And** a Work Order exists with an assignable status  
**When** I attempt to assign a technician who is marked unavailable by the backend policy  
**Then** the UI either (a) blocks assignment with a clear reason or (b) shows a warning allowing override **according to the clarified policy**  
**And** the final behavior matches the backend response codes and payloads

---

## 13. Audit & Observability

### User-visible audit data
- Show assignment history table with:
  - technician, assignedBy, assignedAt, unassignedAt, reason (if present)
- Show last updated time if provided by backend (optional).

### Status history
- If Work Order status changes to `ASSIGNED`, the UI should show updated status and allow viewing status transitions if such screen exists; otherwise, this story only reflects current status.

### Traceability expectations
- Each assignment/reassignment should be traceable in logs/audit by workOrderId and technicianId (frontend: include correlation/request ID if available in client infrastructure).
- UI should not allow deleting or editing historical assignment records.

---

## 14. Non-Functional UI Requirements

- **Performance:** technician list load < 2s under normal conditions; show loading indicator and allow retry.
- **Accessibility:** keyboard navigable dialog, labeled form controls, focus management on open/close; error messages announced to screen readers.
- **Responsiveness:** usable on tablet and desktop layouts (Quasar responsive components).
- **i18n/timezone:** display timestamps in store/user timezone if the app has a standard; otherwise display ISO/localized consistently (needs project convention confirmation).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging when no technicians or no history entries are returned; qualifies as safe UI ergonomics; impacts UX Summary, Alternate/Empty states.
- SD-UX-LOADING-RETRY: Standard loading spinner and retry button on failed list/detail loads; safe error-handling ergonomics; impacts Service Contracts, Error Flows.
- SD-ERR-HTTP-MAP: Map HTTP 400/403/404/409/5xx to consistent banners/toasts without exposing internal details; safe because it doesnâ€™t assume business policy beyond status codes; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Assignable statuses:** Which exact Work Order statuses allow assignment and reassignment? Inputs mention â€œReady/Scheduledâ€, backend reference mentions `SCHEDULED/READY_FOR_WORK`, but the authoritative FSM doc enumerates `APPROVED` and `ASSIGNED` (no SCHEDULED).  
2. **Reassignment during execution:** Is reassignment allowed in `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`? If allowed, does it require additional reason/permission?  
3. **Crew assignment:** Does the system support assigning a â€œcrewâ€ (multiple technicians) or only a single primary technician? If crew is supported, what is the data model and UI behavior (one primary + secondary list, or many-to-many)?  
4. **Permission key / RBAC:** What is the exact permission/role required in the frontend to show/enable assignment controls (e.g., `WORKORDER_ASSIGN`)?  
5. **Backend API contract:** What are the exact endpoints, request/response schemas, and where does assignment history come from (embedded vs separate endpoint)?  
6. **Technician availability policy:** What is the system of record for availability and what is the required behavior: hard-block vs warn-and-override? What response shape indicates a warning vs an error?  
7. **Notification (optional):** Is notification required for this story? If yes, what channels (in-app/SMS/email), what triggers, and is it configurable per store/location/user? Is there a backend endpoint/event the frontend must call or is it automatic?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Execution: Assign Technician to Workorder  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/225  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Execution: Assign Technician to Workorder

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Shop Manager / Dispatcher

## Trigger
A workorder is Ready/Scheduled and needs assignment.

## Main Flow
1. User selects a workorder and opens assignment controls.
2. User assigns a primary technician or crew.
3. System records assignment timestamp and assigns visibility to the technician.
4. System optionally notifies technician.
5. System records assignment history on reassignment.

## Alternate / Error Flows
- Technician unavailable â†’ system prevents assignment or warns based on schedule policy.
- Unauthorized role tries assignment â†’ block.

## Business Rules
- Assignment history must be retained.
- Workorder visibility is role-based.

## Data Requirements
- Entities: Workorder, TechnicianAssignment, User, Notification
- Fields: workorderId, technicianId, assignedBy, assignedAt, unassignedAt, reason

## Acceptance Criteria
- [ ] Technician can be assigned and sees the workorder.
- [ ] Assignment changes are tracked with history.
- [ ] Unauthorized users cannot assign.

## Notes for Agents
Assignment data feeds execution metrics; keep it clean and auditable.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #226: [FRONTEND] [STORY] Promotion: Record Promotion Audit Trail  
File: ./scripts/story-work/frontend/226/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Promotion: View Promotion Audit Trail (Estimate â†’ Work Order)

### Primary Persona
Shop Manager / System Auditor (secondary: Service Advisor)

### Business Value
Provide a non-repudiable, easy-to-review UI record for each estimate promotion so disputes can be resolved quickly and compliance/audit needs are met (who promoted, when, what snapshot/approval, what totals were promoted).

---

## 2. Story Intent

### As a / I want / So that
- **As a** Shop Manager or System Auditor  
- **I want** to view the immutable promotion audit record created when an Estimate is promoted to a Work Order  
- **So that** I can verify exactly what was approved and promoted (snapshot + approval), who performed it, and the summary of promoted items.

### In-Scope
- Frontend screens/components to **display** promotion audit records linked to a Work Order and its source Estimate.
- Role-gated visibility of audit data.
- Empty/error states and safe navigation to related records (work order, estimate, snapshot, approval reference).

### Out-of-Scope
- Creating/writing the audit record (triggered by backend during promotion).
- Changing promotion policy (fail vs retry) or implementing the promotion action itself (unless already existing and simply needs a link).
- Editing/deleting audit events (must be immutable).

---

## 3. Actors & Stakeholders
- **Primary user:** Shop Manager / System Auditor
- **Secondary user:** Service Advisor (may review after promoting)
- **System actor:** Backend process that records `PromotionAuditEvent` atomically with promotion
- **Stakeholders:** Compliance/audit reviewers, customer dispute resolution

---

## 4. Preconditions & Dependencies
- Backend has implemented and persists an immutable `PromotionAuditEvent` (or equivalent) per successful promotion.
- There is an existing UI entry point to view a Work Order and/or Estimate.
- Authorization model exists to restrict audit visibility (roles/permissions).
- Backend endpoints exist to fetch audit records (see Open Questions if not).

Dependencies (frontend):
- Moqui screens framework present in `durion-moqui-frontend` with established routing/layout conventions (README).
- API client patterns for calling backend (REST) from Vue/Quasar already established.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Work Order detail**: â€œPromotion Auditâ€ panel/tab/section (read-only).
- Optional: From **Estimate detail**: â€œPromotion Auditâ€ panel if estimate has been promoted.

### Screens to create/modify
1. **Modify** `WorkOrder` detail screen (Moqui screen) to include a read-only â€œPromotion Auditâ€ section.
2. **Modify** `Estimate` detail screen (Moqui screen) to include a read-only â€œPromotion Auditâ€ section (only when applicable).
3. **Create** a dedicated view screen for a single promotion audit event (optional but recommended for deep-linking):
   - `component://.../screen/workexec/PromotionAudit/ViewPromotionAudit.xml` (name illustrative; match repo conventions)

### Navigation context
- Work Order â†’ Promotion Audit (inline summary + â€œView detailsâ€)
- Estimate â†’ Promotion Audit (inline summary + link to Work Order)
- Deep link: Promotion Audit Event â†’ links to Work Order / Estimate / Snapshot

### User workflows
**Happy path**
1. User opens Work Order detail.
2. User navigates to Promotion Audit section.
3. UI displays: promoter identity, timestamp, estimate ID, work order ID, snapshot reference, approval reference, summary totals.
4. User clicks to view full audit details (if separate screen) and/or to open referenced Estimate/Work Order.

**Alternate path: no audit**
- Work order exists but has no promotion audit (e.g., created directly, migrated data). UI shows â€œNo promotion audit recordedâ€ with explanatory text.

**Unauthorized path**
- User without permission sees section hidden OR sees â€œYou do not have access to promotion audit detailsâ€ (see security question).

---

## 6. Functional Behavior

### Triggers
- User loads Work Order detail screen or Estimate detail screen.

### UI actions
- Load audit record(s) for the Work Order (and/or Estimate).
- Render audit summary and references.
- Provide navigation actions:
  - â€œOpen Work Orderâ€
  - â€œOpen Estimateâ€
  - â€œView Snapshotâ€ (if a snapshot view exists)
  - â€œView Approvalâ€ (if approval view exists)
- If multiple audit events exist (rare, but possible in data): show most recent and allow expanding list.

### State changes
- No domain state transitions initiated by this story (read-only UI).
- UI state: loading â†’ loaded / empty / error.

### Service interactions
- Call backend to retrieve promotion audit event(s) by `workOrderId` and/or `estimateId`.
- Optional: call user/identity endpoint to display promoter name if only ID is returned (see Open Questions).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- None for user input (read-only), except:
  - Validate route params (IDs are present, numeric/UUID per system standard) before calling APIs; otherwise show 404-style â€œInvalid identifierâ€.

### Enable/disable rules
- â€œView Snapshotâ€ button enabled only if `estimateSnapshotId` present.
- â€œView Approvalâ€ button enabled only if `approvalId` present.
- If `promotionSummary` missing, show â€œSummary unavailableâ€ and still display core references.

### Visibility rules
- Promotion Audit section/details visible only to authorized roles (per backend/RBAC).
- If user is unauthorized and backend returns 403, UI must not leak partial data (show generic access denied).

### Error messaging expectations
- 404: â€œPromotion audit not found.â€
- 403: â€œYou do not have permission to view promotion audit details.â€
- 409/500: â€œUnable to load promotion audit at this time. Try again.â€

---

## 8. Data Requirements

### Entities involved (frontend view model)
- `PromotionAuditEvent` (or `AuditEvent` subtype) â€” immutable
- `WorkOrder`
- `Estimate`
- `ApprovalRecord` (reference only)
- `EstimateSnapshot` / `EstimateVersion` (reference only)
- `User` (reference for `promotingUserId` display)

### Fields (type, required, defaults)
Promotion audit fields to display:
- `auditEventId` (string/number, **required**)
- `eventType` (string, **required**, expect constant like `ESTIMATE_PROMOTED_TO_WORK_ORDER`)
- `eventTimestamp` (ISO-8601 UTC string, **required**)
- `promotingUserId` (string/number, **required**)
- `workOrderId` (string/number, **required**)
- `estimateId` (string/number, **required**)
- `estimateSnapshotId` (string/number, **required** per business rule)
- `approvalId` (string/number, **required** per business rule)
- `promotionSummary` (object/JSON, **required** for â€œquick reviewâ€; if absent, handle gracefully)

`promotionSummary` expected keys (if provided):
- `total_cost` / `totalCost` (number, currency-aware)
- `labor_items` / `laborItemCount` (int)
- `part_items` / `partItemCount` (int)
(Exact shape is an Open Question; UI must tolerate unknown keys.)

### Read-only vs editable
- All audit fields: **read-only** always.

### Derived/calculated fields (UI only)
- Display name for promoter: derived from `promotingUserId` via user lookup (if needed).
- Formatted timestamp in user locale; retain UTC in raw view.

---

## 9. Service Contracts (Frontend Perspective)

> Backend contracts are not fully specified in provided inputs for the frontend repo. The following are required contracts to implement the UI; if they do not exist, this story is blocked.

### Load/view calls
One of the following patterns must exist:

**Option A (preferred): Work order scoped**
- `GET /api/workorders/{workOrderId}/promotion-audit`  
  Response: either a single audit event or list.

**Option B: Generic audit lookup**
- `GET /api/audit-events?entityType=WORK_ORDER&entityId={workOrderId}&eventType=ESTIMATE_PROMOTED_TO_WORK_ORDER`

**Option C: By estimate**
- `GET /api/estimates/{estimateId}/promotion-audit`

Minimum response fields required: those listed in Data Requirements.

### Create/update calls
- None (read-only).

### Submit/transition calls
- None.

### Error handling expectations
- `200`: render audit info
- `204` or `200` empty list: render empty state (â€œNo promotion audit recordedâ€)
- `401`: redirect to login / show auth-required per app convention
- `403`: show access denied (no data)
- `404`: show not found
- `5xx`: show retry UI, log client error with correlation id if provided in headers/body

---

## 10. State Model & Transitions

### Allowed states
- N/A for domain (no transitions in UI).
- UI view-state:
  - `LOADING`
  - `LOADED`
  - `EMPTY`
  - `ERROR_FORBIDDEN`
  - `ERROR_NOT_FOUND`
  - `ERROR_TRANSIENT`

### Role-based transitions
- N/A (read-only), but access gating applies:
  - Authorized â†’ can view
  - Unauthorized â†’ cannot view

### UI behavior per state
- LOADING: skeleton/loader
- LOADED: show audit summary + references
- EMPTY: show â€œNo promotion audit recordedâ€
- ERROR_*: show appropriate message + â€œBackâ€ navigation

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid route param â†’ show invalid identifier message; do not call API.

### Concurrency conflicts
- If audit is being written concurrently (rare): if API returns not found then later exists, allow user retry. No optimistic locking required.

### Unauthorized access
- Backend 403: hide content; optionally hide entire section for non-authorized users if permission info is available client-side.

### Empty states
- Work order created without promotion: show empty state.
- Estimate not promoted: show empty state on Estimate detail.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Authorized user views promotion audit from Work Order
**Given** I am logged in as a user with permission to view promotion audit records  
**And** a Work Order exists with an associated Promotion Audit Event  
**When** I open the Work Order detail screen  
**Then** I see a â€œPromotion Auditâ€ section  
**And** it displays the promoting user, event timestamp, estimateId, workOrderId  
**And** it displays the estimateSnapshotId and approvalId references  
**And** it displays promotion summary totals and item counts when provided.

### Scenario 2: Work Order has no promotion audit
**Given** I am logged in as an authorized user  
**And** a Work Order exists with no promotion audit record  
**When** I open the Work Order detail screen  
**Then** I see â€œNo promotion audit recordedâ€ in the Promotion Audit section  
**And** the UI does not display stale or placeholder audit identifiers.

### Scenario 3: Unauthorized user cannot view promotion audit
**Given** I am logged in as a user without permission to view promotion audit records  
**When** I open a Work Order detail screen that has a promotion audit record  
**Then** the UI either hides the Promotion Audit section or shows an access denied message  
**And** the client must not render any audit fields  
**And** if the API returns 403, the UI shows â€œYou do not have permission to view promotion audit details.â€

### Scenario 4: Backend returns error while loading audit
**Given** I am logged in as an authorized user  
**When** the Promotion Audit API request fails with a 5xx error  
**Then** I see an error state indicating the audit could not be loaded  
**And** I can retry the load  
**And** the UI remains responsive and does not break the Work Order page.

### Scenario 5: Audit references are linkable when present
**Given** I am viewing a Promotion Audit record  
**When** the record includes an `estimateId` and `workOrderId`  
**Then** I can navigate to the Estimate detail and Work Order detail from the audit section  
**And** when `estimateSnapshotId` is present, a â€œView Snapshotâ€ action is enabled (destination depends on available screen/API).

---

## 13. Audit & Observability

### User-visible audit data
- Display immutable audit fields:
  - promoter (user id/name)
  - timestamp (UTC + localized display)
  - event type (human label)
  - linked entities and references
  - summary totals

### Status history
- Not created by this story; but promotion audit should be viewable as part of historical record.

### Traceability expectations
- UI should display `auditEventId` (in a details view) for support.
- If backend returns a correlation/request id header, include it in error details UI (optional) and client logs.

---

## 14. Non-Functional UI Requirements
- **Performance:** Audit section load should not block initial Work Order render; load asynchronously; target < 300ms additional perceived latency on warm path (client-side).
- **Accessibility:** All actions keyboard navigable; headings/labels for audit fields; ensure sufficient contrast; screen-reader friendly key-value layout.
- **Responsiveness:** Works on tablet and desktop (POS typical); audit section collapsible on small screens.
- **i18n/timezone/currency:** Timestamps displayed in user locale with UTC available; currency formatting for totals uses store currency configuration if available (otherwise display raw number + currency code if provided).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging when no audit record exists; safe because it does not change domain behavior and only affects presentation. Impacted sections: UX Summary, Alternate/Empty states, Acceptance Criteria.
- SD-UX-ASYNC-SECTION-LOAD: Load Promotion Audit independently from primary Work Order details to avoid blocking; safe as itâ€™s a UI ergonomics choice. Impacted sections: Functional Behavior, Non-Functional Requirements, Error Flows.
- SD-ERR-HTTP-MAP: Standard mapping of 401/403/404/5xx to user-friendly messages; safe because it doesnâ€™t alter domain logic and follows typical frontend handling. Impacted sections: Business Rules (error messaging), Service Contracts, Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. **Backend API contract for retrieving promotion audit:** What is the exact endpoint/path and response schema for PromotionAuditEvent retrieval (by `workOrderId` and/or `estimateId`)?  
2. **RBAC/permission name and UI gating approach:** Which roles/permissions are authorized (`SHOP_MANAGER`, `SYSTEM_AUDITOR`, etc.), and should the UI proactively hide the section or rely purely on 403?  
3. **Snapshot/approval deep-linking:** Are there existing screens/endpoints to view `estimateSnapshotId` and `approvalId` details? If not, should the UI show them as plain text only?  
4. **promotionSummary schema:** What are the canonical field names and currency handling (e.g., `total_cost` vs `totalCost`, includes tax or not)?  
5. **Multiplicity:** Can there be more than one promotion audit event per work order (e.g., re-promote after rollback/migration)? If yes, should UI show a list ordered by timestamp?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Promotion: Record Promotion Audit Trail  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/226  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Promotion: Record Promotion Audit Trail

**Domain**: user

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
A promotion event completes successfully.

## Main Flow
1. System records an audit event including who initiated promotion and when.
2. System records the estimate snapshot version and approval reference used.
3. System stores a summary of items promoted (counts, totals) for quick review.
4. System links audit record to the workorder and estimate.
5. System exposes audit record in UI for authorized roles.

## Alternate / Error Flows
- Audit write fails â†’ fail promotion or retry per strictness policy (recommended: fail).

## Business Rules
- Promotion must be auditable and traceable.
- Audit must reference the exact snapshot promoted.

## Data Requirements
- Entities: AuditEvent, Workorder, Estimate, ApprovalRecord
- Fields: eventType, actorUserId, timestamp, estimateId, snapshotVersion, approvalId, workorderId, summaryTotals

## Acceptance Criteria
- [ ] Promotion event is stored and retrievable.
- [ ] Audit record references estimate snapshot and approval.
- [ ] Audit record shows summary totals and item counts.

## Notes for Agents
Audit isnâ€™t optionalâ€”this protects you in customer disputes.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #227: [FRONTEND] [STORY] Promotion: Handle Partial Approval Promotion  
File: ./scripts/story-work/frontend/227/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Promotion: Promote Approved Scope from Partially Approved Estimate (create Work Order + defer remaining)

### Primary Persona
Service Advisor (Back Office / POS user)

### Business Value
Enable advisors to start work immediately on the customer-approved portion of an estimate while preserving non-approved items for future approval flows, ensuring technicians only execute authorized work and maintaining end-to-end traceability and auditability.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** to promote the approved scope of a partially approved Estimate into a new Work Order,  
**So that** work can begin on authorized items immediately while unapproved items remain deferred on the Estimate for potential future approval via proper gates.

### In-scope
- Frontend UI action available on an Estimate in `PartiallyApproved` state: â€œPromote Approved Scopeâ€.
- Confirmation UX and submission to backend to perform the promotion.
- Post-action navigation and clear indicators on both:
  - the created Work Order (contains only approved items)
  - the source Estimate (promoted vs deferred line statuses)
- Display of traceability links between:
  - WorkOrder â†” source Estimate
  - WorkOrderLine â†” source EstimateLine (read-only display)
- Error handling for invalid state / no approved items / concurrency / authorization.

### Out-of-scope
- Any workflow for â€œlater approval of deferred itemsâ€ that creates Change Requests or supplemental Work Order items (explicitly out of scope per backend reference).
- Defining or changing domain policies for conflict resolution when later approvals conflict with work already performed.
- Implementing backend services/entities/state machines (frontend integrates only).

---

## 3. Actors & Stakeholders
- **Primary Actor:** Service Advisor
- **Secondary Stakeholders:** Technician (expects Work Order contains only authorized scope), Shop Manager (traceability & revenue opportunity), Customer (clear scope communication)
- **System:** Moqui-based POS frontend + workexec backend services

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- User has permission to create Work Orders / promote estimates (permission name TBD by security model).
- An Estimate exists and is currently in state `PartiallyApproved`.
- Estimate has line items with per-line approval statuses (at least one is approved for a successful promotion).

### Dependencies
- Backend endpoint/service for â€œpromote approved scopeâ€ exists and is accessible from Moqui (contract TBD; see Open Questions).
- Backend provides:
  - created WorkOrderId
  - updated Estimate + lines statuses (Promoted/Deferred)
  - traceability identifiers (sourceEstimateId, sourceEstimateLineId, and/or promotedToWorkOrderLineId)
- Routing: existing Estimate detail screen and Work Order detail screen exist (or are created by separate stories).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Estimate Detail** screen when Estimate status is `PartiallyApproved`.

### Screens to create/modify
- **Modify:** `EstimateDetail` screen (Moqui Screen)
  - Add an action button/menu item: `Promote Approved Scope`
  - Add/ensure display of line item status badges including `Promoted` and `Deferred`
  - Add/ensure link-out from promoted estimate lines to the created Work Order / Work Order line (when identifiers available)
- **Modify:** `WorkOrderDetail` screen
  - Ensure the header shows `Source Estimate` link (sourceEstimateId)

> If these screens donâ€™t exist with these names, implement equivalent screens consistent with the repoâ€™s routing conventions (Open Question if naming must be exact).

### Navigation context
- User is viewing an Estimate (e.g., route contains `estimateId`).
- After successful promotion, user is redirected to Work Order detail (preferred) with a link back to the source Estimate.

### User workflows
#### Happy path
1. Advisor opens Estimate in `PartiallyApproved`.
2. Clicks `Promote Approved Scope`.
3. Confirmation modal summarizes:
   - number of approved items to be promoted
   - number of items that will be deferred
   - warning that deferred items will not be executable until later approval (informational)
4. Advisor confirms.
5. UI calls promote service.
6. UI navigates to newly created Work Order and shows success message.
7. Advisor can return to Estimate and see:
   - approved lines now `Promoted`
   - unapproved lines now `Deferred`

#### Alternate paths
- If no approved items: button disabled OR action shows error message (see Functional Behavior).
- If backend returns state conflict (Estimate not PartiallyApproved anymore): UI refreshes Estimate and explains action is no longer valid.
- If unauthorized: show â€œnot permittedâ€ error and do not change UI state.

---

## 6. Functional Behavior

### Triggers
- User clicks `Promote Approved Scope` on an Estimate in `PartiallyApproved`.

### UI actions
- **Render rule:** Show action only when:
  - Estimate.status == `PartiallyApproved`
  - AND UI has loaded line items (to compute approved count)
- **Enable rule:** Enable only when approved line count â‰¥ 1.
- **Click action:**
  1. Open confirmation dialog.
  2. On confirm: call backend promote operation.
  3. While pending: disable confirm button + show loading state.
  4. On success:
     - show toast/banner: â€œWork Order created from approved scope.â€
     - navigate to WorkOrder detail (`/workorders/{workOrderId}` or equivalent)
  5. On failure: show error banner with mapped message (see Error Flows).

### State changes (frontend-visible)
- Estimate overall status expected to become `PromotedWithDeferredItems` (per backend reference).
- Estimate line statuses expected:
  - Approved â†’ Promoted
  - Non-approved (PendingApproval/Declined/etc.) â†’ Deferred
- Work Order created with only the promoted lines.

### Service interactions
- Load Estimate detail (existing call).
- Submit promotion action (new call).
- Reload/refresh Estimate data after promotion (optional if response returns updated Estimate; otherwise required).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Promotion action must not be possible unless Estimate is in `PartiallyApproved`.
  - UI must hide/disable the action outside that status.
  - Backend remains source of truth; UI must handle backend rejection.
- Promotion requires at least one line item with status `Approved`.
  - UI must compute approved count from loaded line items.
  - If approved count is 0: disable button and show helper text: â€œAt least one approved item is required to promote.â€

### Enable/disable rules
- Disable `Promote Approved Scope` if:
  - Estimate not `PartiallyApproved`
  - OR line items not loaded
  - OR approvedCount == 0
  - OR user lacks permission (if permission signal available in session/context; otherwise handle 403 on submit)

### Visibility rules
- In Estimate line list:
  - Display status badge for each line: `Approved`, `Declined`, `PendingApproval`, plus new/expected `Promoted`, `Deferred`.
- For `Promoted` lines:
  - Show read-only traceability link(s) if IDs available:
    - â€œPromoted to Work Order #Xâ€ (link)
- For `Deferred` lines:
  - Show non-executable indicator text: â€œDeferred (not on Work Order)â€.

### Error messaging expectations
- No approved items: â€œPromotion failed: At least one item must be approved to create a Work Order.â€
- Invalid estimate state: â€œPromotion unavailable: estimate is no longer partially approved. Refresh to see latest status.â€
- Unauthorized: â€œYou donâ€™t have permission to promote estimates.â€
- Generic/server: â€œPromotion failed due to a system error. Try again or contact support.â€

---

## 8. Data Requirements

### Entities involved (frontend view)
- `Estimate`
- `EstimateLine`
- `WorkOrder`
- `WorkOrderLine`
- (Future/out-of-scope but referenced) `ChangeRequest`

### Fields (type, required, defaults)
#### Estimate (read)
- `estimateId` (string/number, required)
- `status` (enum string, required): includes at least `PartiallyApproved`, `PromotedWithDeferredItems`
- `customerId` (id, optional for this story)
- `shopId/locationId` (id, optional)

#### EstimateLine (read)
- `estimateLineId` (id, required)
- `status` (enum string, required): includes `Approved`, `Declined`, `PendingApproval`, plus expected `Promoted`, `Deferred`
- `description` (string, required for display)
- `quantity` (number, optional)
- `authorizedFlag` (boolean, **unclear**; do not assume)
- `deferredFlag` (boolean, **unclear**; do not assume)
- `promotedToWorkOrderLineId` (id, nullable; used for link if provided)

#### WorkOrder (read after create)
- `workOrderId` (id, required)
- `status` (enum string, required)
- `sourceEstimateId` (id, required)

#### WorkOrderLine (read)
- `workOrderLineId` (id, required)
- `sourceEstimateLineId` (id, required)

### Read-only vs editable by state/role
- All fields in this story are read-only in UI; the only mutation is invoking the â€œpromoteâ€ action.

### Derived/calculated fields (frontend)
- `approvedCount` = number of estimate lines where `status == Approved`
- `deferredCount` = number of estimate lines where `status != Approved` (or specifically non-approved statuses; depends on backend status set)
- `promotionEligible` boolean from `(estimate.status == PartiallyApproved && approvedCount > 0)`

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not fully specified for frontend/Moqui; below is the **required** behavior the frontend expects. If the API differs, adjust screen transitions accordingly.

### Load/view calls
- `GET /api/estimates/{id}`
  - returns Estimate + line items with statuses (or separate endpoint for lines)
- If lines are separate:
  - `GET /api/estimates/{id}/lines`

### Create/update calls (promotion)
- **Required operation:** â€œPromote approved scopeâ€
  - Proposed: `POST /api/estimates/{id}/promote-approved-scope`
  - Request body: `{ "promotedBy": <userId> }` (userId requirement unclear; Moqui session may suffice)
  - Response (minimum):
    - `createdWorkOrderId`
    - updated `estimateStatus`
    - optionally lists of `promotedLineItemIds`, `deferredLineItemIds`

### Submit/transition calls
- The promote action is a state transition on Estimate and a create on WorkOrder, performed atomically server-side.

### Error handling expectations
Frontend must map:
- `400` validation: show backend message (no approved lines, missing required fields)
- `401/403`: show unauthorized message; do not retry automatically
- `404`: show not found; offer navigation back
- `409` conflict (concurrency/state): prompt user to refresh Estimate; optionally auto-refresh and re-evaluate eligibility
- `5xx`: generic error; preserve current view

---

## 10. State Model & Transitions

### Allowed states (as referenced)
#### Estimate status (subset relevant)
- `PartiallyApproved` (eligible to promote)
- `PromotedWithDeferredItems` (result of successful promotion)

#### EstimateLine status (subset relevant)
- `Approved` â†’ `Promoted`
- `Declined`/`PendingApproval`/other non-approved â†’ `Deferred`

### Role-based transitions
- Service Advisor initiates promotion (role enforcement handled server-side; frontend hides action if permission info available).

### UI behavior per state
- Estimate `PartiallyApproved`:
  - Show Promote action if eligible
- Estimate `PromotedWithDeferredItems`:
  - Hide Promote action
  - Show promoted/deferred indicators and traceability links

---

## 11. Alternate / Error Flows

### Validation failures
- User attempts promote with zero approved items (edge case if UI stale):
  - Backend returns 400; UI shows error; refresh Estimate.
- Estimate not in `PartiallyApproved`:
  - Backend returns 409 or 400; UI shows state conflict message; refresh.

### Concurrency conflicts
- Another user promotes/changes status before this user confirms:
  - Backend returns 409; UI reloads estimate and disables action.

### Unauthorized access
- Backend returns 403:
  - UI shows permission error and hides/locks action on subsequent renders if possible.

### Empty states
- Estimate has no lines:
  - Promote disabled; show message â€œNo line items available.â€

---

## 12. Acceptance Criteria

### Scenario 1: Successful promotion creates work order with only approved scope
**Given** an Estimate exists with status `PartiallyApproved` and has 2 line items with status `Approved` and 1 line item with status `Declined`  
**And** the Service Advisor is viewing the Estimate detail screen  
**When** the user clicks `Promote Approved Scope` and confirms the action  
**Then** the system creates a new Work Order linked to the source Estimate  
**And** the UI navigates to the created Work Order detail screen showing the Work Order id  
**And** the Work Order contains exactly the 2 approved items (and not the declined item)  
**And** the source Estimate status becomes `PromotedWithDeferredItems`  
**And** the two previously approved Estimate lines show status `Promoted`  
**And** the previously declined Estimate line shows status `Deferred`.

### Scenario 2: Promote action is unavailable when estimate is not partially approved
**Given** an Estimate is in status `Draft` (or any status other than `PartiallyApproved`)  
**When** the user views the Estimate detail screen  
**Then** the `Promote Approved Scope` action is not shown or is disabled  
**And** the user cannot submit a promotion request from the UI.

### Scenario 3: Promotion blocked when no items are approved
**Given** an Estimate is in status `PartiallyApproved`  
**And** the Estimate has 0 line items with status `Approved`  
**When** the user views the Estimate detail screen  
**Then** the `Promote Approved Scope` action is disabled  
**And** the UI displays helper text indicating at least one approved item is required  
**When** the user attempts to trigger the action via a direct call (edge case)  
**Then** the UI displays: â€œPromotion failed: At least one item must be approved to create a Work Order.â€  
**And** no navigation to a Work Order occurs.

### Scenario 4: Concurrency/state conflict during promotion
**Given** an Estimate is initially loaded as `PartiallyApproved` with at least one approved line  
**When** another user changes the Estimate status such that it is no longer eligible  
**And** the Service Advisor confirms promotion  
**Then** the backend responds with a conflict (HTTP 409 or equivalent)  
**And** the UI displays a message indicating the estimate changed and refresh is required  
**And** after refresh, the promote action is hidden/disabled based on the latest status.

### Scenario 5: Audit/traceability is visible in UI after promotion
**Given** a Work Order was created from partial promotion  
**When** the user views the Work Order detail screen  
**Then** the Work Order displays a read-only `Source Estimate` link referencing the originating Estimate  
**And** each Work Order line displays a read-only reference to its originating Estimate line identifier (or an accessible link if supported).

---

## 13. Audit & Observability

### User-visible audit data
- On Estimate detail, show read-only metadata if available (do not invent fields):
  - â€œPromoted byâ€, â€œPromoted atâ€ (only if returned by backend)
- If not available, do not display.

### Status history
- If the UI already supports status history panels:
  - Ensure promotion creates a visible entry for Estimate status change and line status changes (requires backend support).

### Traceability expectations
- Must be possible to navigate:
  - WorkOrder â†’ source Estimate
  - Promoted EstimateLine â†’ corresponding WorkOrder/line (if backend provides IDs)

---

## 14. Non-Functional UI Requirements

- **Performance:** Promotion action should complete within 3 seconds under normal conditions; show loading indicator if longer.
- **Accessibility:** Confirmation dialog and status indicators must be keyboard navigable; status conveyed with text (not color-only).
- **Responsiveness:** Works on tablet width for advisor counter use.
- **i18n/timezone:** Display timestamps (if shown) in user locale/timezone; send/receive UTC timestamps as provided (do not convert business logic).
- **Security:** Do not expose internal-only fields; rely on backend authorization; avoid logging PII in browser console.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Show a deterministic empty-state message when an Estimate has no line items; qualifies as safe because it is UI-only and does not change business rules. (Impacted sections: UX Summary, Alternate / Error Flows)
- SD-ERR-MAP-HTTP: Standard HTTP status to user message mapping (400/401/403/404/409/5xx); qualifies as safe because it only affects presentation of errors implied by backend contracts. (Impacted sections: Service Contracts, Alternate / Error Flows)

---

## 16. Open Questions

1. **Backend promote endpoint contract:** What is the exact endpoint/path, request body/query params, and response payload for â€œPromote Approved Scopeâ€ (including the created workOrderId and updated statuses)?  
2. **Exact frontend route/screen IDs:** What are the canonical Moqui screen paths for Estimate detail and Work Order detail in this repo (so the story can specify precise transitions)?  
3. **Exact status enums in frontend payloads:** Are the Estimate/EstimateLine statuses exactly `PartiallyApproved`, `PromotedWithDeferredItems`, `Promoted`, `Deferred` as strings, or different constants?  
4. **Permission signal:** Is there a frontend-accessible permission flag/role check to hide the action preemptively, or should we rely exclusively on handling 403 responses?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Promotion: Handle Partial Approval Promotion  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/227  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Promotion: Handle Partial Approval Promotion

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor / Back Office

## Trigger
An estimate is PartiallyApproved and user promotes approved scope.

## Main Flow
1. System creates workorder using only approved scope items.
2. System marks unapproved items as deferred and keeps them on the estimate.
3. System allows later approval of deferred items to create a change request or supplemental workorder items per policy.
4. System maintains traceability between deferred items and later approvals.
5. System shows clear indicators of partial promotion.

## Alternate / Error Flows
- Later approvals conflict with work already performed â†’ require advisor resolution before adding.

## Business Rules
- Only approved scope is promotable.
- Deferred items remain visible but non-executable until approved.
- Later additions should flow through approval gates.

## Data Requirements
- Entities: ApprovedScope, Workorder, Estimate, ChangeRequest
- Fields: authorizedFlag, deferredFlag, scopeVersion, changeRequestId, status

## Acceptance Criteria
- [ ] Only approved items appear on the initial workorder.
- [ ] Deferred items remain on estimate and can be approved later.
- [ ] System maintains audit trace from deferred items to later changes.

## Notes for Agents
Partial approval adds â€œlaterâ€ workâ€”route that through change/approval, not silent edits.

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #228: [FRONTEND] [STORY] Promotion: Enforce Idempotent Promotion  
File: ./scripts/story-work/frontend/228/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Promotion: Enforce Idempotent Promotion (Estimate Snapshot â†’ Work Order)

### Primary Persona
Service Advisor (primary UI initiator); System (idempotency enforcer)

### Business Value
Prevents duplicate Work Orders when promotion is retried (double-clicks, refresh, network retries), preserving operational integrity, auditability, and a single canonical Work Order per estimate snapshot.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** promoting an approved estimate snapshot to a work order to be safe to retry and always return the same canonical work order,  
**so that** accidental double actions or transient failures do not create duplicate work orders or inconsistent execution data.

### In-scope
- Frontend â€œPromote Estimate to Work Orderâ€ action is **idempotent from the userâ€™s perspective**
- UI handles:
  - first-time promotion success (creates WO)
  - retry returning existing WO
  - partial promotion completion (backend completes missing pieces; UI reflects final canonical WO)
  - corrupted link case (promotion record exists but WO missing) with clear admin escalation message
- Explicit error handling, concurrency-safe UI (disable button, show progress, allow safe retry)
- Display canonical Work Order reference/link after promotion

### Out-of-scope
- Implementing backend idempotency logic, DB constraints, or actual PromotionRecord entity persistence
- Work order execution lifecycle transitions beyond â€œnavigate to created/retrieved work orderâ€
- Admin repair tools (only surface â€œrequires admin interventionâ€ guidance)

---

## 3. Actors & Stakeholders
- **Service Advisor**: initiates promotion, expects single WO outcome
- **System**: performs promotion and enforces idempotency key `(estimateId, snapshotVersion)`
- **Auditor/Manager**: expects traceability of promotion attempts (success/retry/failure)
- **Support/Admin**: handles corrupted data link scenarios

---

## 4. Preconditions & Dependencies
- Estimate exists and is in a promotable condition (typically **APPROVED**; exact rule enforced by backend)
- A specific immutable **snapshotVersion** is available for the estimate being promoted
- Frontend can call backend promotion endpoint(s) and receives a response that includes a Work Order identifier and/or URL
- User is authenticated and authorized to promote estimates to work orders (authorization errors handled)

**Dependencies (backend/API)**
- A promotion endpoint that behaves idempotently for `(estimateId, snapshotVersion)` and returns canonical WO reference.
- A way to load an estimate including snapshot/version info (or a UI-provided snapshotVersion).
- A work order view route exists in frontend to navigate to a Work Order by ID/number.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Estimate Detail** screen: action button â€œPromote to Work Orderâ€
- Optional: from **Estimate List** row action (if existing in app) (only if estimate is eligible)

### Screens to create/modify
- **Modify**: `EstimateDetail` screen
  - Add a â€œPromote to Work Orderâ€ action area
  - Add a promotion result panel / banner showing canonical Work Order link
- **Optional new**: `PromotionResultDialog` reusable component (Vue/Quasar) invoked by Estimate screens

### Navigation context
- After successful promotion (created or retrieved), user can click:
  - â€œOpen Work Orderâ€ â†’ navigate to WorkOrder detail screen/route
  - â€œCopy Work Order #/Linkâ€ (optional)

### User workflows
**Happy path (first attempt)**
1. Service Advisor opens Estimate Detail.
2. Clicks â€œPromote to Work Orderâ€.
3. UI shows blocking progress state.
4. Success response returns Work Order reference.
5. UI shows â€œWork Order createdâ€ and provides link.

**Retry path (double click / refresh / retry after transient error)**
1. Service Advisor repeats promotion.
2. UI receives â€œexisting work orderâ€ response.
3. UI shows â€œWork Order already existsâ€ and same canonical link.

**Corrupted link path**
1. Promotion attempt returns error indicating promotion record exists but linked work order missing/corrupt.
2. UI shows non-retryable error with escalation instructions and surfaces correlation id if provided.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œPromote to Work Orderâ€ on an estimate snapshot/version.
- System/network retries cause duplicate requests (double-click, page reload, timeout retry).

### UI actions
- On click:
  - Validate required identifiers exist in UI state: `estimateId`, `snapshotVersion`
  - Disable the promote button immediately (prevent local double-submit)
  - Show loading indicator and â€œPromotingâ€¦â€ message
- On success:
  - Persist the returned canonical Work Order reference in component state
  - Render a success banner/panel with Work Order number/id and link
  - Enable â€œOpen Work Orderâ€ navigation action
- On failure:
  - Re-enable promote button **only if** retry is allowed (see error mapping)
  - Show error banner with actionable message

### State changes (frontend)
- `promotionStatus`: `idle | inProgress | succeeded | failed | blockedCorrupted`
- `promotionResult`: `{ workOrderId, workOrderNumber?, workOrderUrl? }` (as provided)
- `lastAttempt`: timestamp and (if available) `correlationId`

### Service interactions (high-level)
- Call backend â€œpromoteâ€ service with `(estimateId, snapshotVersion)`
- On response, optionally call Work Order â€œgetâ€ endpoint to confirm existence if backend returns only ID (only if required by UI routing)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- UI must not allow promotion if:
  - `estimateId` missing â†’ show â€œEstimate not loaded; refresh and try again.â€
  - `snapshotVersion` missing â†’ show â€œEstimate snapshot version is required to promote.â€
- UI must treat the operation as idempotent:
  - Any successful response that contains a canonical Work Order reference is considered final, regardless of whether it was created or retrieved.

### Enable/disable rules
- â€œPromote to Work Orderâ€ button:
  - Enabled only when estimate is in an eligible status per loaded estimate data (if status available in UI); otherwise enabled and backend enforces (do not guess rules).
  - Disabled while `promotionStatus === inProgress`

### Visibility rules
- Show promotion result panel only when `promotionStatus === succeeded` and work order reference present.
- Show â€œAdmin intervention requiredâ€ panel when corrupted link error occurs.

### Error messaging expectations
- Must distinguish:
  - **Transient** (timeouts/5xx): â€œPromotion may have succeeded. You can retry safely; the system will return the same Work Order.â€
  - **Validation** (4xx like 400/422): show backend-provided field/summary errors.
  - **Unauthorized** (401/403): â€œYou donâ€™t have permission to promote estimates.â€
  - **Corrupted link** (409/500 with explicit code): â€œPromotion record exists but linked Work Order is missing. Do not retry. Contact admin/support.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `Estimate` (read)
- `PromotionRecord` (not necessarily directly read by frontend; implied by promotion API behavior)
- `WorkOrder` (read/navigate)
- `AuditEvent` (not directly read; expect backend to log)

### Fields
**Estimate (read)**
- `estimateId` (string/number, required)
- `snapshotVersion` (integer, required for promotion)
- `status` (enum/string, optional but used for button enablement if present)

**Promotion request (write)**
- `estimateId` (required)
- `snapshotVersion` (required)

**Promotion response (read)**
- `workOrderId` (required on success)
- `workOrderNumber` (optional)
- `workOrderUrl` (optional; if absent, frontend builds route from `workOrderId`)
- `outcome` (optional: `CREATED | RETRIEVED | COMPLETED_PARTIAL` if backend supports; otherwise infer messaging generically)
- `correlationId` (optional but strongly preferred for support)

### Read-only vs editable
- All fields are read-only in UI except the action trigger.

### Derived/calculated fields
- `promotionKey` should **not** be computed client-side as authoritative; client may log a derived string for UI debug only (non-authoritative).

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names are not provided in inputs; the contracts below define required behavior and payloads. If the repo already has established endpoints/services, implement using existing conventions.

### Load/view calls
- Load Estimate Detail (existing): must provide `estimateId`, `snapshotVersion`, `status` (or enough to display promote action)

### Create/update calls
- **Promote Estimate Snapshot**
  - **Method**: `POST`
  - **Path (proposed)**: `/api/estimates/{estimateId}/promote`
  - **Body**: `{ "snapshotVersion": <int> }`
  - **Success (200 or 201)**:
    ```json
    { "workOrderId": 456, "workOrderNumber": "WO-456", "outcome": "CREATED|RETRIEVED|COMPLETED_PARTIAL", "correlationId": "..." }
    ```
  - **Idempotency behavior**: Same `(estimateId, snapshotVersion)` always returns the same `workOrderId`.

### Submit/transition calls
- None beyond promotion.

### Error handling expectations
- `400/422`: input invalid (missing snapshotVersion, estimate not promotable)
- `401/403`: not authorized
- `404`: estimate not found (or snapshot not found)
- `409` (preferred) or `500` with explicit error code: corrupted promotion link (promotion record points to missing WO)
- `5xx/timeout`: treat as unknown outcome; allow safe retry and message accordingly

Frontend must:
- Display backend `correlationId` if present in error payload/headers.
- Avoid re-submitting automatically in a tight loop; user-initiated retry only.

---

## 10. State Model & Transitions

### Allowed states (frontend promotion UI state)
- `idle` â†’ `inProgress` â†’ (`succeeded` | `failed` | `blockedCorrupted`)

### Role-based transitions
- If backend returns 403, UI remains/returns to `idle` with permission error and does not attempt further transitions.

### UI behavior per state
- `idle`: show enabled Promote button (if eligible), no banners
- `inProgress`: disable Promote button, show spinner and warning â€œDo not navigate awayâ€
- `succeeded`: show canonical Work Order link and â€œOpen Work Orderâ€
- `failed`: show retryable error UI; keep Promote enabled
- `blockedCorrupted`: show non-retryable error UI; keep Promote disabled and show â€œContact admin/supportâ€

---

## 11. Alternate / Error Flows

### Validation failures
- Missing snapshotVersion in UI â†’ block call, show inline error
- Backend rejects estimate state (e.g., not approved) â†’ show error; do not change estimate locally

### Concurrency conflicts
- Two tabs promoting same estimate snapshot:
  - One creates, other retrieves; both must end with same canonical WO reference.

### Unauthorized access
- 401: redirect to login (if app pattern), then return to estimate
- 403: show â€œNot permittedâ€ and do not retry automatically

### Empty states
- Estimate loaded but no snapshotVersion available:
  - Show explanation and hide/disable promote action.

---

## 12. Acceptance Criteria

### Scenario 1: First-time promotion creates a new work order
**Given** a Service Advisor is viewing an Estimate Detail with `estimateId=E-123` and `snapshotVersion=1`  
**And** the Promote button is enabled  
**When** the user clicks â€œPromote to Work Orderâ€  
**Then** the UI disables the Promote button and shows an in-progress indicator  
**And** the frontend sends a promotion request containing `estimateId=E-123` and `snapshotVersion=1`  
**And** on a successful response containing `workOrderId`  
**Then** the UI shows a success state with a canonical â€œOpen Work Orderâ€ link for that `workOrderId`.

### Scenario 2: Retried promotion returns the same canonical work order (no duplicates)
**Given** an Estimate snapshot `estimateId=E-123` and `snapshotVersion=1` has already been promoted  
**When** the user triggers â€œPromote to Work Orderâ€ again (including after refresh)  
**Then** the UI receives a success response with the same `workOrderId` as previously shown  
**And** the UI displays that same canonical Work Order link  
**And** the UI does not display any indication that a second Work Order was created.

### Scenario 3: Timeout/5xx allows safe user retry and still resolves to single canonical work order
**Given** the user clicks â€œPromote to Work Orderâ€ for `estimateId=E-123` and `snapshotVersion=1`  
**When** the request times out or returns a 5xx error  
**Then** the UI shows an error message stating the operation may have succeeded and retry is safe  
**And** the Promote button becomes enabled again for user-initiated retry  
**When** the user retries  
**Then** the UI eventually shows exactly one canonical Work Order link for the snapshot.

### Scenario 4: Corrupted promotion record blocks and requires admin intervention
**Given** the backend determines a PromotionRecord exists for `(estimateId=E-123, snapshotVersion=1)`  
**And** the linked Work Order cannot be loaded (corrupted/missing)  
**When** the user clicks â€œPromote to Work Orderâ€  
**Then** the UI shows a non-retryable error state instructing the user to contact admin/support  
**And** the Promote button is disabled to prevent repeated attempts  
**And** the UI displays any provided `correlationId` for support diagnostics.

### Scenario 5: Missing required identifiers prevents promotion call
**Given** the Estimate Detail is missing `snapshotVersion` in the loaded data  
**When** the user attempts to promote  
**Then** the frontend does not call the backend  
**And** shows â€œEstimate snapshot version is required to promote.â€

---

## 13. Audit & Observability

### User-visible audit data
- After a successful promotion, UI should display:
  - Work Order reference
  - Timestamp of completion (client-side) (optional)
  - Correlation ID if returned

### Status history
- Not a separate UI requirement, but UI must not hide repeated attempts; it may show â€œretrieved existingâ€ if `outcome` provided.

### Traceability expectations
- Frontend should include a request correlation header if the project already uses one (e.g., `X-Correlation-Id`) and log it client-side in dev tools logs (non-PII).
- On errors, surface correlationId from response payload/headers when present.

---

## 14. Non-Functional UI Requirements
- **Performance**: promotion action should show feedback within 250ms (spinner/message), regardless of network latency.
- **Accessibility**: loading state announced to screen readers; disabled button has accessible reason text.
- **Responsiveness**: works on tablet resolutions typical for POS.
- **i18n**: all user-facing messages routed through translation mechanism if project uses one; otherwise centralized constants (do not hardcode scattered strings).

---

## 15. Applied Safe Defaults
- SD-UX-01: Disable submit/action button while request in-flight; qualifies as safe UX ergonomics to prevent accidental double submits; impacts UX Summary, Functional Behavior, Error Flows.
- SD-ERR-01: Treat network timeout/5xx as â€œunknown outcomeâ€ and allow user-initiated retry with messaging that idempotency makes retry safe; qualifies as safe error-handling mapping; impacts Business Rules, Alternate/Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. What is the **exact backend promotion endpoint** (path, method, request/response schema) used by the Moqui frontend for promoting an estimate snapshot to a work order?
2. Does the promotion response include an explicit `outcome` field (CREATED vs RETRIEVED vs COMPLETED_PARTIAL) and a `correlationId`, or must the frontend infer messaging purely from HTTP status?
3. What is the canonical frontend route for Work Order detail navigation (by `workOrderId` vs `workOrderNumber`)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Promotion: Enforce Idempotent Promotion  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/228  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Promotion: Enforce Idempotent Promotion

**Domain**: user

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
Promotion is executed multiple times due to retries or double actions.

## Main Flow
1. System checks for an existing promotion record for (estimateId, snapshotVersion).
2. If a workorder exists, system returns the existing workorder reference instead of creating a duplicate.
3. If promotion was partially completed, system completes missing pieces safely.
4. System records retry event for diagnostics/audit (optional).
5. User sees a single canonical workorder link.

## Alternate / Error Flows
- Promotion record exists but workorder deleted/corrupted â†’ require admin intervention and block.

## Business Rules
- Promotion must be idempotent under retries.
- Promotion record is the authoritative link between estimate snapshot and workorder.

## Data Requirements
- Entities: PromotionRecord, Workorder, Estimate, AuditEvent
- Fields: promotionKey, estimateId, snapshotVersion, workorderId, status, retryCount

## Acceptance Criteria
- [ ] Repeated promotion attempts do not create duplicate workorders.
- [ ] System returns the same workorder URL/number for the same snapshot.
- [ ] Partial promotion can be safely completed.

## Notes for Agents
Idempotency prevents data integrity nightmaresâ€”treat it as non-negotiable.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #229: [FRONTEND] [STORY] Promotion: Generate Workorder Items from Approved Scope â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/229  
File: ./scripts/story-work/frontend/229/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Promotion: Generate Workorder Items from Approved Scope

### Primary Persona
System (initiated by Service Advisor during Estimate â†’ Work Order promotion)

### Business Value
Ensure that when an approved Estimate is promoted to a Work Order, the resulting Work Order Items are created deterministically from the approved scope with immutable pricing/tax snapshots and traceability, enabling execution, downstream invoicing, and variance explanations.

---

## 2. Story Intent

### As a / I want / So that
- **As the System**, I want the POS frontend to initiate and correctly handle the promotion of an **Approved Estimate** into a **Work Order** such that **Workorder Items are generated from the approved scope** with immutable financial snapshots and traceability, **so that** technicians can execute authorized work and billing can invoice based on preserved, explainable numbers.

### In-scope
- Frontend UI flow to initiate â€œPromote Estimate to Work Orderâ€.
- Frontend handling of success response (navigate to created Work Order).
- Frontend display/behavior for promotion warnings (e.g., items requiring review).
- Frontend display/behavior for promotion failures (missing tax config, total mismatch, invalid state).
- Frontend read-only visibility of the created Workorder Itemsâ€™ key snapshot/traceability fields (as returned by backend).
- Moqui screen flow, transitions, and service calls to the backend APIs described in provided references.

### Out-of-scope
- Implementing backend promotion logic, tax calculation, or catalog validity checks (backend responsibility).
- Editing Workorder Items post-promotion (not specified here).
- Work Order execution state machine transitions (start/in-progress/etc.) beyond viewing created items.
- Notification delivery mechanisms for warnings/errors.
- Configuration of tax rules or locations.

---

## 3. Actors & Stakeholders
- **Service Advisor (initiator):** clicks to promote an approved estimate.
- **System (primary actor):** executes promotion and item generation via backend.
- **Technician (downstream):** consumes generated Workorder Items for execution.
- **Billing/Accounting (downstream):** relies on snapshotted amounts for invoicing/variance explanation.
- **Audit/Compliance (stakeholder):** expects traceability and immutable audit events (as surfaced/visible where applicable).

---

## 4. Preconditions & Dependencies

### Preconditions
- Estimate exists and is eligible for promotion (expected: `APPROVED` per backend story reference).
- User is authenticated and authorized to promote an estimate (permission model not specified in provided inputs).

### Dependencies
- Backend endpoint that performs promotion (not explicitly provided in frontend story input; must be confirmed).
- Backend endpoints to load Estimate details and Work Order details after promotion.
- Backend emits audit/events; frontend should surface correlation IDs when available.

### External/System dependencies
- Tax configuration must be valid for the transaction context; if missing, promotion must fail atomically (per provided rules).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an **Estimate Detail** screen when the estimate status is `APPROVED`, provide an action: **â€œPromote to Work Orderâ€**.

### Screens to create/modify
1. **Modify**: `EstimateDetail` screen
   - Add Promote action and status-gated availability.
2. **Create/Modify**: `WorkOrderDetail` screen (or existing equivalent)
   - Ensure it can display:
     - Work Order header linking to origin estimate
     - Workorder Items list including snapshot fields and `requiresReview`
3. **Optional (if no existing)**: `PromotionResultDialog` component (Quasar dialog) used within Moqui screen for confirmation/errors.

> Exact screen names/paths are not provided in inputs; implement using repo conventions (Moqui screen XML + Vue/Quasar components) and ensure routing is consistent with existing navigation.

### Navigation context
- Estimate Detail â†’ Promote â†’ on success navigate to Work Order Detail for the created Work Order.
- On failure remain on Estimate Detail and show blocking error.

### User workflows

#### Happy path
1. Service Advisor opens an approved estimate.
2. Clicks **Promote to Work Order**.
3. Confirms action (if confirmation pattern exists in project).
4. Frontend calls backend promotion service.
5. On success, frontend navigates to Work Order detail; shows created Workorder Items and any review flags.

#### Alternate paths
- Promotion succeeds but some items are flagged `requiresReview=true` â†’ show non-blocking warning banner on Work Order.
- Promotion fails due to missing tax configuration â†’ show blocking error, do not navigate.
- Promotion fails due to totals mismatch â†’ show blocking error, do not navigate.
- Promotion fails due to invalid estimate state (e.g., not approved) â†’ show blocking error and refresh estimate.

---

## 6. Functional Behavior

### Triggers
- User clicks **Promote to Work Order** from an eligible Estimate Detail page.

### UI actions
- Show loading state (disable Promote button while request in-flight).
- Show success notification (non-intrusive) on completion.
- Show error dialog/banner on failure with actionable message.

### State changes (frontend)
- No local state machine is created; frontend reflects backend state:
  - Estimate remains `APPROVED` or transitions per backend behavior (not specified).
  - Work Order is created and becomes the primary entity to display.

### Service interactions
- Call backend promotion endpoint (see **Service Contracts**).
- After success, load Work Order detail via backend and render.
- Optionally refresh Estimate to show any linkage (if backend updates estimate with workOrderId/origin link).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Before calling promotion**:
  - Ensure estimate status displayed as `APPROVED`. If not, disable Promote button and show tooltip/message â€œEstimate must be Approved to promote.â€
  - Require estimate ID present in route/context.
- **After calling promotion**:
  - If backend returns missing tax configuration error â†’ treat as blocking; user must correct configuration (message must not guess where; see Open Questions for where to direct).

### Enable/disable rules
- Promote action enabled only when:
  - Estimate status is `APPROVED`
  - User has permission (unknown; if backend returns 403, handle gracefully)
  - No in-flight promotion request is running

### Visibility rules
- On Work Order detail:
  - Display `requiresReview` indicator per item when true.
  - Display traceability field `originEstimateItemId` (read-only) in item details (or in an â€œAdvanced/Traceabilityâ€ section).

### Error messaging expectations
- Must map backend structured reasons into user-facing messages:
  - `MissingTaxConfiguration`: â€œPromotion blocked: tax configuration is missing or invalid for this estimate. Correct tax setup and retry.â€
  - `TotalMismatch`: â€œPromotion failed: calculated totals do not match the estimate totals. No work order was created.â€
  - `InvalidEstimateState`: â€œPromotion failed: estimate is not in an approvable/promotable state. Refresh and try again.â€
  - Unknown error: generic â€œPromotion failed due to a system error. Try again or contact support.â€ plus show correlation/request ID if available.

---

## 8. Data Requirements

### Entities involved (frontend perspective; via backend responses)
- Estimate
- EstimateItem (approved scope subset)
- WorkOrder
- WorkorderItem
- TaxSnapshot (or equivalent nested snapshot structure)

### Fields (type, required, defaults)
**Estimate (read)**
- `estimateId` (string/uuid, required)
- `status` (enum: at least `APPROVED`, required)
- Totals:
  - `subtotal`, `taxTotal`, `grandTotal` (money, required for display/validation messaging; backend compares totals)

**WorkOrder (read after promotion)**
- `workOrderId` (string/uuid, required)
- `originEstimateId` (string/uuid, required)
- Totals: `subtotal`, `taxTotal`, `grandTotal` (money, required)
- `customerId` (string/uuid, optional for UI; referenced in backend event payload)

**WorkorderItem (read)**
- `workorderItemId` (string/uuid, required)
- `workorderId` (string/uuid, required)
- `originEstimateItemId` (string/uuid, required)
- `itemSeqId` (number/int, required)
- `itemType` (enum: `PART`, `LABOR`, `FEE`, required)
- `description` (string, required)
- `productId` (string/uuid, nullable)
- `quantity` (decimal, required, >0)
- `unitPrice` (money, required)
- `totalPrice` (money, required)
- `taxSnapshot` (object/json, required; includes `taxCode`, `taxRate`, `taxAmount` at minimum)
- `status` (enum, required; initial expected `Authorized`)
- `requiresReview` (boolean, required, default false)

### Read-only vs editable by state/role
- All snapshot and traceability fields are **read-only** in this story.
- No inline editing of Workorder Items is included.

### Derived/calculated fields (UI-only)
- Display-only: `lineTotal = totalPrice` as provided; do not recalc tax.
- Badge/flag: â€œNeeds Reviewâ€ from `requiresReview`.

---

## 9. Service Contracts (Frontend Perspective)

> Backend endpoints for promotion are not explicitly provided in the frontend story input. The backend reference mentions a command `PromoteEstimateToWorkOrder` and events, but not a REST path. This story therefore specifies required frontend-facing contracts and flags missing details as Open Questions.

### Load/view calls
- `GET /api/estimates/{estimateId}`
  - Needed to display estimate status and totals, and to gate Promote action.
- `GET /api/workorders/{workOrderId}` (or `/api/work-orders/{id}` depending on backend convention)
  - Needed to render created work order after promotion.
- `GET /api/workorders/{workOrderId}/items` (optional if not included in workorder payload)
  - Needed to render items list.

### Create/update calls
- None (frontend does not create items directly).

### Submit/transition calls
- **Promotion call (required):** one of the following must exist:
  - Option A: `POST /api/estimates/{estimateId}/promote-to-workorder`
  - Option B: `POST /api/workorders` with `{ originEstimateId }`
  - Option C: other backend-defined endpoint
- Expected success:
  - HTTP `201 Created` (preferred) or `200 OK`
  - Response includes at least `workOrderId` and `originEstimateId`
  - Include `requiresReview` flags per item either in immediate response or via subsequent GET
- Expected failures:
  - `400 Bad Request` for validation (e.g., invalid state)
  - `409 Conflict` for concurrency/total mismatch
  - `403 Forbidden` for authorization
  - `404 Not Found` if estimate not found

### Error handling expectations
- Backend should return a structured reason code (e.g., `MissingTaxConfiguration`, `TotalMismatch`, `InvalidEstimateState`).
- Frontend must:
  - Render reason-specific message (see Business Rules)
  - Preserve atomicity assumption: on failure, do not attempt to navigate to Work Order
  - Offer â€œRetryâ€ for transient errors (network/5xx), not for policy errors (missing tax config)

---

## 10. State Model & Transitions

### Allowed states (relevant to this story)
- **Estimate**: must be `APPROVED` to promote (per backend reference).
- **WorkorderItem**: initial status must be `Authorized` (per backend reference).

### Role-based transitions
- Promotion is initiated by Service Advisor (role implied); actual enforcement is backend.
- Frontend must gracefully handle:
  - 403 Forbidden: show â€œYou do not have permission to promote estimates.â€

### UI behavior per state
- Estimate status `APPROVED`:
  - Show Promote action enabled.
- Any other estimate status:
  - Hide or disable Promote action (prefer disable with explanation).
- Work Order created:
  - Show items with status `Authorized` and flags.

---

## 11. Alternate / Error Flows

### Validation failures
- Estimate not `APPROVED` at time of click (stale UI):
  - Backend returns error; frontend refreshes estimate and shows error.

### Concurrency conflicts
- Another user promoted the estimate already:
  - If backend returns 409 with reason `AlreadyPromoted` (not specified), show message and navigate to existing work order if backend provides `workOrderId`. If not provided, show error and require manual lookup (Open Question).

### Unauthorized access
- Backend 403:
  - Show blocking message; do not change screens.

### Empty states
- Approved scope has zero items:
  - Not specified; if backend rejects, show error.
  - If backend allows, Work Order created with zero itemsâ€”Work Order detail shows empty list with â€œNo authorized items.â€ (This is a safe UX default only; backend behavior is unknown.)

### Catalog item no longer valid
- Promotion succeeds; specific Workorder Item has `requiresReview=true`:
  - Show warning banner â€œSome items require reviewâ€ and highlight those items in list.

### Missing tax configuration
- Promotion fails atomically:
  - Show blocking error; keep user on Estimate detail.

### Totals mismatch
- Promotion fails atomically:
  - Show blocking error; optionally provide â€œCopy detailsâ€ to include correlation ID and estimateId.

---

## 12. Acceptance Criteria

### Scenario 1: Promote approved estimate successfully and navigate to work order
**Given** I am a signed-in user viewing an Estimate with status `APPROVED`  
**And** the Estimate has at least one approved-scope line item with resolved pricing and tax  
**When** I click â€œPromote to Work Orderâ€  
**Then** the frontend sends a promotion request for that Estimate ID  
**And** on success the frontend navigates to the Work Order detail for the returned `workOrderId`  
**And** the Work Order detail shows a list of Workorder Items created from the approved scope  
**And** each displayed Workorder Item includes `quantity`, `unitPrice`, `taxSnapshot.taxAmount`, and `originEstimateItemId` as read-only values.

### Scenario 2: Workorder items show Authorized status and traceability
**Given** a Work Order was created via promotion from an approved Estimate  
**When** I view the Work Order detail  
**Then** each Workorder Item shows status `Authorized`  
**And** each Workorder Item displays a non-empty `originEstimateItemId` value.

### Scenario 3: Promotion succeeds with invalid catalog item and flags requiresReview
**Given** an approved Estimate contains an approved-scope item referencing a deactivated/non-existent product  
**When** I promote the estimate to a work order  
**Then** the promotion succeeds and I am navigated to the created Work Order  
**And** the corresponding Workorder Item is marked `requiresReview=true` in the UI  
**And** the UI shows a non-blocking warning indicating items require review.

### Scenario 4: Promotion fails due to missing tax configuration (blocking)
**Given** I am viewing an approved Estimate  
**And** tax configuration is missing/invalid for the estimate context  
**When** I attempt to promote the estimate  
**Then** the frontend shows a blocking error message indicating tax configuration must be corrected  
**And** the frontend does not navigate to a Work Order screen  
**And** the Promote action becomes available again after the error is dismissed.

### Scenario 5: Promotion fails due to mismatched totals (atomic failure)
**Given** I am viewing an approved Estimate  
**And** the backend detects a totals mismatch during promotion  
**When** I attempt to promote the estimate  
**Then** the frontend shows a blocking error message indicating totals mismatch and that no work order was created  
**And** the frontend remains on the Estimate detail screen.

### Scenario 6: Unauthorized promotion attempt
**Given** I am viewing an approved Estimate  
**When** I attempt to promote the estimate but my user lacks permission  
**Then** the backend responds with HTTP 403  
**And** the frontend shows a blocking â€œnot authorizedâ€ message  
**And** no Work Order is created or displayed.

---

## 13. Audit & Observability

### User-visible audit data
- On success, show:
  - `workOrderId`
  - `originEstimateId`
  - Promotion timestamp as returned by backend (if provided)
- If backend provides a correlation/request ID header or field, display it in error details (copyable).

### Status history
- Not implementing transition history UI here; ensure navigation does not obscure backend audit requirements.
- If Work Order detail includes existing audit tabs, link is acceptable.

### Traceability expectations
- UI must display `originEstimateItemId` per Workorder Item (read-only).
- UI must display `originEstimateId` on Work Order header (read-only).

---

## 14. Non-Functional UI Requirements

### Performance
- Promotion call should show an in-progress indicator within 250ms of click.
- After success, Work Order detail should render initial content quickly; lazy-load items list if payload large (implementation choice).

### Accessibility
- Promote button must be keyboard accessible and have clear disabled-state explanation.
- Error dialogs/banners must be screen-reader friendly (aria-live for alerts).

### Responsiveness
- Workorder Items list must be usable on tablet widths typical of shop floor.
- Item detail sections should stack vertically on narrow screens.

### i18n/timezone/currency
- Currency formatting must follow existing POS locale/currency configuration (do not hardcode).
- Timestamps shown (if any) should display in shop/user timezone; store UTC internally if displayed.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide standard empty-state messaging for Workorder Items list when no items returned; safe because it affects only UI ergonomics and not domain logic. Impacted sections: UX Summary, Alternate/Empty states.
- SD-ERR-MAP-HTTP: Map standard HTTP errors (400/403/404/409/5xx) to consistent UI notifications; safe because itâ€™s generic error handling without changing business policy. Impacted sections: Business Rules, Service Contracts, Error Flows.
- SD-UX-LOADING-DISABLE: Disable primary action during in-flight request to prevent duplicate submission; safe because itâ€™s a UI ergonomic/idempotency aid. Impacted sections: Functional Behavior, Error Flows.

---

## 16. Open Questions

1. What is the **exact backend REST endpoint** (method + path) to execute â€œPromote Estimate to Work Orderâ€, and what is the **success response schema** (does it return `workOrderId` only, or also items/warnings)?
2. What structured **error response contract** is used for promotion failures (reason codes: `MissingTaxConfiguration`, `TotalMismatch`, `InvalidEstimateState`, etc.) and which HTTP statuses map to which reasons?
3. If an estimate is **already promoted** (concurrency case), does the backend return the existing `workOrderId` so the frontend can navigate directly?
4. Where in the existing frontend navigation is the canonical **Estimate Detail** and **Work Order Detail** route/screen IDs (Moqui screen paths) for linking and transitions?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Promotion: Generate Workorder Items from Approved Scope â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/229  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Promotion: Generate Workorder Items from Approved Scope

**Domain**: user

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
A workorder header is created from an approved estimate.

## Main Flow
1. System iterates through approved scope line items.
2. System creates Workorder Items for parts and labor with stable identifiers.
3. System copies pricing/tax snapshot fields needed for downstream invoicing and variance explanations.
4. System marks items as 'Authorized' and sets execution flags (e.g., required vs optional).
5. System validates totals and quantity integrity.

## Alternate / Error Flows
- Approved scope contains an item no longer valid in catalog â†’ allow as snapshot item and flag for review.
- Tax configuration missing â†’ block promotion and require correction.

## Business Rules
- Only approved items are created on the workorder.
- Snapshot pricing/tax fields are preserved.
- Workorder items maintain traceability to estimate items.

## Data Requirements
- Entities: WorkorderItem, ApprovedScope, EstimateItem, TaxSnapshot
- Fields: itemSeqId, originEstimateItemId, authorizedFlag, quantity, unitPrice, taxCode, taxAmount, snapshotVersion

## Acceptance Criteria
- [ ] Workorder items match approved scope in quantity and pricing.
- [ ] Workorder items carry traceability back to estimate items.
- [ ] Promotion fails if required tax basis is missing (policy).

## Notes for Agents
Design for variance explanations later: preserve the numbers, not just totals.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #230: [FRONTEND] [STORY] Promotion: Create Workorder from Approved Estimate  
File: ./scripts/story-work/frontend/230/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Promotion: Create Workorder from Approved Estimate

### Primary Persona
Service Advisor (Back Office/POS user)

### Business Value
Convert an approved customer estimate into a trackable Work Order (with immutable links and audit trail) so execution can be scheduled/assigned and downstream workflows can proceed without duplicate creation or loss of approval traceability.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to promote an **Approved** Estimate into a Work Order from the POS UI  
- **So that** authorized work is captured as a Work Order with immutable references to the estimate snapshot/version and approval record, and the promotion is auditable and idempotent.

### In-scope
- Frontend UI action to â€œPromote to Workorderâ€ from an Estimate detail context.
- Calling backend to create the Work Order (atomic) and handling:
  - success response (navigate to Work Order),
  - idempotent â€œalready promotedâ€ response,
  - rejection for non-approved estimate,
  - configuration/validation/system failures.
- Displaying and preserving promotion linkage data surfaced by API (estimateId/version, approval/audit reference, createdBy/createdAt).
- Basic role-based *UI visibility handling if and only if the API already provides role/permission/visibility signals* (no new RBAC policy invented).

### Out-of-scope
- Defining/implementing RBAC policy rules (explicitly out of scope per backend story).
- Changing Work Order state machine beyond creation (start/transition execution).
- Generating supplemental PDFs or customer-facing artifacts.
- Any pricing/security policy not explicitly returned by API.

---

## 3. Actors & Stakeholders
- **Service Advisor (primary)**: initiates promotion, reviews result, navigates to created Work Order.
- **System**: performs atomic promotion creation and returns Work Order reference.
- **Mechanic/Technician (downstream)**: consumes the Work Order later (not part of this UI story).
- **Back Office/Manager (audit)**: needs traceability of who promoted and when.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- An Estimate exists and is viewable by user.
- Estimate is in **APPROVED** state (per backend acceptance criteria).

### Dependencies (must exist or be confirmed)
- Backend endpoint for promotion exists and is reachable from frontend (exact route TBD; see Open Questions).
- Estimate detail API exposes:
  - estimate `id`,
  - `status`,
  - (preferred) `approvedAt`, `approvedBy`, and an approval/audit reference needed for display.
- Work Order detail route/screen exists or will exist to navigate to after success (or implement minimal view route stub).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Estimate Detail screen for an estimate in APPROVED status.

### Screens to create/modify
1. **Modify** `EstimateDetail` screen:
   - Add action button: **Promote to Workorder**
   - Add confirmation dialog (to prevent accidental duplicate clicks).
2. **(Optional minimal)** `WorkOrderDetail` navigation target:
   - If already exists: use it.
   - If not exists: create minimal Work Order summary screen that can show `workOrderId`, `status`, and links back to estimate.

### Navigation context
- From estimate list â†’ estimate detail â†’ promote â†’ redirect to work order detail (or show banner with link).

### User workflows

#### Happy path
1. Service Advisor views an APPROVED estimate.
2. Clicks **Promote to Workorder**.
3. Confirms in modal (shows estimate id and warns idempotent behavior).
4. Frontend calls promotion service.
5. On success, show success toast and navigate to Work Order detail for returned `workOrderId`.

#### Alternate paths
- Estimate not approved: button hidden/disabled; if forced (deep link or stale UI) show error from backend.
- Promotion already done: show info â€œWorkorder already existsâ€ and navigate to existing Work Order.
- Backend config/validation failure: show error, remain on estimate.
- Network/system error: show retry affordance.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œPromote to Workorderâ€ on Estimate Detail.

### UI actions
- Confirm dialog:
  - Primary: â€œCreate Workorderâ€
  - Secondary: â€œCancelâ€
- While request in-flight:
  - Disable primary CTA and show loading state.
  - Prevent double-submit.

### State changes (frontend)
- None persisted client-side beyond request state.
- On success: route transition to Work Order detail.

### Service interactions
- Call backend â€œpromote estimate to workorderâ€ operation with:
  - `estimateId`
  - `promotingUserId` (if backend expects; else derived server-side from auth)
  - optional `idempotencyKey` header if supported (preferred; see Open Questions)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Client-side eligibility check (non-authoritative):**
  - Show button only when `estimate.status == APPROVED`.
- **Server-authoritative checks to handle:**
  - Reject if estimate status not APPROVED.
  - Enforce â€œone workorder per approved estimateâ€ (idempotency).

### Enable/disable rules
- Promote button:
  - Enabled only when estimate is APPROVED and user has required permission signal (if available).
  - Disabled while promotion request in progress.

### Visibility rules
- Do not implement â€œhide prices for mechanicsâ€ unless API already provides a boolean/permission field indicating price visibility; otherwise defer (out-of-scope).

### Error messaging expectations
- Display backend error message when safe; otherwise map to friendly messages:
  - 400/422: â€œCannot promote this estimate. Please review estimate status/details.â€
  - 403: â€œYou donâ€™t have permission to create workorders.â€
  - 404: â€œEstimate not found.â€
  - 409: â€œWorkorder already exists for this estimate.â€ (and navigate to it if ID provided)
  - 5xx/network: â€œUnable to create workorder right now. Try again.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `Estimate` (read)
- `WorkOrder` (created/returned)
- `WorkOrderSnapshot` (not created by frontend, but promotion should surface that it exists)
- Approval/Audit reference (returned by API for display/audit traceability)

### Fields (type, required, defaults)

#### Estimate (read)
- `id` (string|number, required)
- `status` (enum string, required; must include `APPROVED`)
- `shopId` (string|number, required for context if present)
- `approvedAt` (datetime, optional)
- `approvedBy` (string|number, optional)
- `estimateVersion` or `approvedEstimateVersionId` (string|number, **required for linkage display** if available)

#### Promotion response (required for navigation and confirmation)
- `workOrderId` (string|number, required)
- `status` (enum string, required; expected `APPROVED` per backend story)
- `sourceEstimateId` (string|number, required; should equal input estimateId)
- `sourceApprovalEventId` or `approvalId` (string|number, required for traceability)
- `createdByUserId` (string|number, optional but preferred)
- `createdTimestamp` (datetime, optional but preferred)

### Read-only vs editable
- All fields in this story are read-only in UI; creation is performed via promotion action.

### Derived/calculated fields
- None on frontend (no policy calculations allowed).

---

## 9. Service Contracts (Frontend Perspective)

> **Note:** Backend story describes behavior but not the exact endpoint for â€œpromotionâ€. This is blocking.

### Load/view calls
- `GET /api/estimates/{id}` (assumed existing from approval workflow doc)  
  Used to render estimate detail and eligibility.

### Create/update calls (promotion)
One of the following must exist:

- Preferred: `POST /api/estimates/{id}/promote-to-workorder`
  - Request body: `{ "promotedBy": <userId?> }` (only if required)
  - Response (200/201): `{ workOrderId, status, sourceEstimateId, sourceApprovalEventId, ... }`
  - Response (409 idempotent): `{ workOrderId, message }` or 200 with `alreadyExisted=true`

**OR**
- `POST /api/workorders` with `estimateId` in payload and backend handles promotion semantics.

### Submit/transition calls
- None beyond promotion.

### Error handling expectations
- Must support:
  - 400/422 validation failures (non-approved estimate, missing snapshot, etc.)
  - 403 permission denied
  - 404 estimate not found
  - 409 already promoted OR deterministic idempotent â€œreturn existing workorderâ€
  - 5xx on system/config failures (atomic rollback)

---

## 10. State Model & Transitions

### Allowed states (relevant to this story)
- **Estimate**: must be `APPROVED` to allow promotion (per backend).
- **WorkOrder**: initial status must be `APPROVED` (per backend story and workorder state machine doc).

### Role-based transitions
- Not implemented here; only creation action is performed by Service Advisor.

### UI behavior per state
- If Estimate status != APPROVED: hide/disable promote action; show explanatory tooltip/message â€œEstimate must be approved to create a workorder.â€
- If Estimate status == APPROVED: enable promote action.

---

## 11. Alternate / Error Flows

### Validation failures
- If backend rejects because estimate not approved:
  - Show error and refresh estimate state (re-fetch `GET /api/estimates/{id}`).
- If backend rejects because promotion prerequisites missing (e.g., missing approval snapshot):
  - Show error â€œEstimate approval data missing; cannot promote.â€ (exact text from API if provided).

### Concurrency conflicts
- Two advisors click promote simultaneously:
  - One creates; the other receives 409 or â€œalready existsâ€.
  - UI must handle by navigating to returned existing `workOrderId` if provided; else show â€œalready existsâ€ and offer a â€œGo to Workorderâ€ button once ID is retrieved by follow-up call (see Open Questions on lookup endpoint).

### Unauthorized access
- On 403:
  - Show â€œnot permittedâ€
  - Do not retry automatically.

### Empty states
- If estimate detail cannot load (404): show â€œEstimate not foundâ€ and provide link back to estimate list.

---

## 12. Acceptance Criteria

### Scenario 1: Promote approved estimate successfully
**Given** I am a Service Advisor viewing an Estimate with status `APPROVED`  
**When** I click â€œPromote to Workorderâ€ and confirm  
**Then** the frontend calls the promotion API with the estimate id  
**And** the UI shows a success message containing the new `workOrderId`  
**And** the UI navigates to the Work Order detail view for that `workOrderId`  
**And** the Work Order detail view displays `status = APPROVED` and `sourceEstimateId` matching the original estimate.

### Scenario 2: Prevent promotion UI for non-approved estimate
**Given** I am viewing an Estimate with status `DRAFT` (or any status not `APPROVED`)  
**Then** the â€œPromote to Workorderâ€ action is not available (hidden) or is disabled with a message  
**And** if I attempt promotion via a direct UI trigger (e.g., stale page)  
**When** the backend responds with a validation error  
**Then** the UI displays â€œEstimate must be approved before creating a workorderâ€ (or backend-provided equivalent)  
**And** no navigation occurs.

### Scenario 3: Idempotent promotion returns existing workorder
**Given** an approved Estimate has already been promoted and has an existing Work Order `WO-123`  
**When** I click â€œPromote to Workorderâ€ again  
**Then** the UI does not create a duplicate workorder  
**And** the UI informs me that a workorder already exists  
**And** the UI navigates to Work Order `WO-123` (using the id returned in the response).

### Scenario 4: Handle backend configuration/system error atomically
**Given** I am viewing an approved Estimate  
**When** I attempt to promote it  
**And** the backend responds with a 5xx error indicating a configuration or system failure  
**Then** the UI shows an error message and offers a retry action  
**And** the UI remains on the Estimate detail screen  
**And** a second attempt behaves safely (no duplicate creation; still idempotent).

### Scenario 5: Permission denied
**Given** I am logged in without permission to create workorders  
**When** I attempt to promote an approved Estimate  
**Then** the backend responds with 403  
**And** the UI shows â€œYou donâ€™t have permission to create workordersâ€  
**And** the UI does not retry automatically.

---

## 13. Audit & Observability

### User-visible audit data
- After promotion success, show in Work Order detail (or a promotion result panel):
  - `createdByUserId` (or name if API provides)
  - `createdTimestamp`
  - `sourceEstimateId`
  - `sourceApprovalEventId` (or approval/audit reference)
  - Snapshot indicator: â€œPromotion snapshot capturedâ€ if API returns snapshot type/id; otherwise omit.

### Status history
- Out of scope to display full transition history (but ensure navigation doesnâ€™t break if such screens exist).

### Traceability expectations
- Frontend must include correlation/request id if the project convention supports it (e.g., pass through header) and log client-side errors without leaking PII.

---

## 14. Non-Functional UI Requirements

- **Performance:** Promotion action should show loading within 100ms; avoid duplicate API calls; fetch estimate once on page load.
- **Accessibility:** Confirm dialog and toasts must be keyboard accessible; focus returns to the promote button on cancel/error.
- **Responsiveness:** Works on tablet sizes (Quasar layout).
- **i18n/timezone:** Display timestamps in userâ€™s local timezone (format per app conventions); do not assume currency formatting since pricing is out-of-scope here.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a clear empty/error state on estimate not found and a â€œBack to Estimatesâ€ action; qualifies as safe UX ergonomics; impacts UX Summary, Error Flows.
- SD-UX-LOADING-DISABLE-SUBMIT: Disable CTA during in-flight request to prevent double-submit; safe ergonomics; impacts Functional Behavior, Error Flows.
- SD-ERR-HTTP-MAPPING: Standard mapping of HTTP 400/403/404/409/5xx to user-friendly messages while preserving backend message when safe; qualifies as standard error-handling; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Promotion API endpoint contract (blocking):** What is the exact backend route and method for â€œpromote estimate to workorderâ€? (e.g., `POST /api/estimates/{id}/promote-to-workorder` vs `POST /api/workorders` with `estimateId`).
2. **Idempotency response shape (blocking):** On â€œalready promotedâ€, does backend return `409` with existing `workOrderId`, or `200` with a flag? Frontend needs deterministic behavior to navigate.
3. **Approval/audit linkage fields (blocking):** What exact field(s) will backend expose for `sourceApprovalEventId` / approval record reference so UI can display traceability?
4. **User identity requirement (blocking):** Does promotion require an explicit `userId` in request payload/query, or is it derived from auth context?
5. **Work Order detail route/screen:** What is the canonical Moqui/Vue route for Work Order detail (`/workorders/:id` or similar) in this frontend repo?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Promotion: Create Workorder from Approved Estimate  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/230  
Labels: frontend, story-implementation, order  

## Frontend Implementation for Story

**Original Story**: [STORY] Promotion: Create Workorder from Approved Estimate

**Domain**: order

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor / Back Office

## Trigger
Promotion preconditions are satisfied for an approved estimate.

## Main Flow
1. System creates a Workorder header using customer and vehicle context from the estimate snapshot.
2. System links workorder to estimate version and approval record.
3. System sets workorder initial state (e.g., Ready or Scheduled) per configuration.
4. System applies role-based visibility rules (e.g., hide prices for mechanics).
5. System records the promotion event for audit.

## Alternate / Error Flows
- Workorder creation fails due to validation/config error â†’ rollback and report error.
- Promotion retried after partial failure â†’ idempotent recovery.

## Business Rules
- Workorder must reference estimate snapshot and approval record.
- Initial state is policy-driven.
- Promotion must be auditable.

## Data Requirements
- Entities: Workorder, Estimate, ApprovalRecord, AuditEvent
- Fields: workorderId, status, estimateId, estimateVersion, approvalId, shopId, createdBy, createdDate

## Acceptance Criteria
- [ ] A workorder is created and linked to the approved estimate snapshot.
- [ ] Initial workorder state matches configuration.
- [ ] Audit trail shows who promoted and when.

## Notes for Agents
Keep promotion atomic: either you have a valid workorder, or you have nothing.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #231: [FRONTEND] [STORY] Promotion: Validate Promotion Preconditions  
File: ./scripts/story-work/frontend/231/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)
### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Promotion: Validate Promotion Preconditions (Estimate â†’ Work Order)

### Primary Persona
Service Advisor (Back Office)

### Business Value
Prevents creation of invalid or duplicate work orders by enforcing estimate approval + snapshot integrity checks at the moment of promotion, reducing rework, billing errors, and operational confusion.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** the POS to validate all required preconditions when I click â€œPromote to Work Orderâ€ on an estimate,  
**so that** only estimates with current valid approval and approved scope tied to the correct snapshot can be promoted, and retries do not create duplicate work orders.

### In-scope
- Frontend â€œPromote to Work Orderâ€ action initiation from an Estimate context.
- UI-side orchestration to call backend validation/promotion endpoint(s).
- Displaying actionable, specific precondition failure messages (expired/missing/invalid approval; missing/incorrect approved scope; duplicate promotion).
- Idempotent retry handling (duplicate promotion returns existing work order reference).
- Audit/observability hooks from frontend (correlation ID, client-side event logging as applicable).

### Out-of-scope
- Actual creation/editing of work order details beyond routing to the created/existing work order screen (work order creation behavior is â€œdefined in a subsequent storyâ€ per backend reference).
- Defining or changing estimate approval workflow itself.
- Defining permissions/roles (only enforce what backend returns).
- Generating PDFs / supplemental estimate documents.

---

## 3. Actors & Stakeholders
- **Primary actor:** Service Advisor / Back Office user
- **Secondary stakeholders:** Workshop Manager (expects integrity), Customer (expects only approved work), Audit/Compliance (expects traceability)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS UI.
- User is viewing an Estimate record with an `estimateId`.
- Estimate has a concept of `snapshotVersion` (the version that was approved / being promoted).

### Dependencies
- Backend endpoints for:
  - retrieving estimate details (including current status and snapshot/version context),
  - validating/promotion attempt that returns either success (allowed) or structured errors including duplicate reference.
- Backend must return structured error codes at minimum:
  - `APPROVAL_NOT_FOUND`
  - `APPROVAL_EXPIRED`
  - `APPROVAL_INVALID`
  - `PROMOTION_ALREADY_EXISTS` (with `workorderId`)
  - plus any â€œapproved scope missing/mismatchâ€ code (not explicitly named in provided inputs; see Open Questions).
- Moqui screens framework available for:
  - estimate view screen
  - work order view screen (existing or to be created if missing)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Estimate detail screen: action button **Promote to Work Order**.

### Screens to create/modify
- **Modify**: `EstimateDetail` screen (name TBD by repo conventions) to add:
  - action button
  - confirmation dialog (optional; see safe defaults)
  - promotion result handling (navigate or show error panel)
- **Existing/Target**: `WorkOrderDetail` screen route (must be linkable via `workorderId`)

### Navigation context
- From Estimate detail â†’ promote action â†’ either:
  - navigate to Work Order detail (new or existing)
  - stay on estimate and show blocking reasons + next steps

### User workflows
**Happy path**
1. Service Advisor opens an estimate.
2. Clicks â€œPromote to Work Orderâ€.
3. UI calls backend with `estimateId` and `snapshotVersion`.
4. Backend confirms preconditions satisfied and returns a `workorderId` (or an â€œallowedâ€ response that includes navigation target).
5. UI navigates to Work Order detail for returned `workorderId`.

**Alternate paths**
- Approval expired/missing/invalid â†’ UI blocks, shows explicit next steps (e.g., â€œObtain new approvalâ€).
- Approved scope missing or snapshot mismatch â†’ UI blocks, instructs to revise/resubmit approval.
- Duplicate promotion â†’ UI informs user and offers â€œOpen existing Work Orderâ€ action (default action navigates).

---

## 6. Functional Behavior

### Triggers
- User clicks `Promote to Work Order` on an estimate.

### UI actions
- Disable button and show progress while request is in flight.
- On response:
  - Success: show brief confirmation and route to work order screen.
  - Duplicate: show â€œAlready promotedâ€ banner and route to existing work order on user confirm (or immediate route; see safe defaults).
  - Validation error: show inline blocking error panel with actionable instructions.
  - Auth error: show â€œNot authorizedâ€ and keep user on estimate.

### State changes (frontend)
- No domain state mutation on frontend; all authoritative validation occurs server-side.
- Frontend stores transient UI state:
  - `promotionRequestStatus` = idle | loading | success | error
  - `promotionError` object with `errorCode`, `message`, `details` (if provided)

### Service interactions
- Call a single backend operation that:
  - performs idempotency check
  - validates approval validity + expiry + superseded
  - validates approved scope exists and matches snapshotVersion
  - either returns created/existing workorder reference, or returns structured failure

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (UI-facing)
- If backend indicates approval is not current/valid:
  - show blocking message and do not navigate.
- If backend indicates `PROMOTION_ALREADY_EXISTS`:
  - treat as non-fatal outcome; present existing `workorderId` and allow navigation.
- If backend indicates approved scope missing/mismatch:
  - block promotion and instruct user to ensure the approved scope matches the version being promoted.

### Enable/disable rules
- Promote button is disabled while request is in progress.
- Promote button visibility:
  - **Do not enforce estimate status rules purely client-side** (status ownership is domain/back-end); however, UI may hide/disable if estimate clearly not promotable *and* estimate status is available (see Open Questions on which statuses are promotable).

### Visibility rules
- Error panel visible only after a failed attempt.
- If duplicate promotion detected, show an â€œOpen Work Orderâ€ call-to-action.

### Error messaging expectations
Messages must:
- include a short reason
- include â€œwhat to do nextâ€
- avoid exposing internal stack traces or sensitive details

Example mappings (UI copy suggestions; final copy can be adjusted):
- `APPROVAL_NOT_FOUND`: â€œNo customer approval is recorded for this estimate. Capture approval before promoting.â€
- `APPROVAL_EXPIRED`: â€œThe approval has expired. Request a new approval to continue.â€
- `APPROVAL_INVALID`: â€œThe approval is no longer valid (revoked/superseded). Review approvals and capture a new one.â€
- `PROMOTION_ALREADY_EXISTS`: â€œThis estimate version was already promoted. Open the existing work order: {workorderId}.â€

---

## 8. Data Requirements

### Entities involved (frontend concerns)
- `Estimate`
- `ApprovalRecord` (read-only display context if surfaced)
- `ApprovedScope` (read-only validation context)
- `WorkOrder` (navigation target)
- `AuditEvent` (frontend emission/correlation only; not authoritative)

### Fields (type, required, defaults)
**From Estimate context (required to attempt promotion)**
- `estimateId` (string/number; required)
- `snapshotVersion` (string/number; required)

**From promotion response (required to route on success/duplicate)**
- `workorderId` (string/number; required when success or duplicate)

**From error response**
- `errorCode` (string enum; required)
- `message` (string; optional if UI maps by code)
- `details` (object; optional, e.g., `expiresAt`, `snapshotVersionExpected`, `snapshotVersionProvided`)

### Read-only vs editable
- All fields are read-only in this story; user does not edit data here.

### Derived/calculated fields
- `isPromoteEnabled` derived from UI state (not domain state).
- â€œApproved scope existsâ€ is derived from backend result, not computed in UI.

---

## 9. Service Contracts (Frontend Perspective)

> Note: Backend reference story describes behavior but does not provide an explicit â€œpromotion validationâ€ endpoint. This is blocking for exact implementation wiring.

### Load/view calls
- `GET /api/estimates/{id}` (or Moqui equivalent) to display estimate and obtain `snapshotVersion` context.

### Create/update calls (promotion attempt)
One of the following patterns must exist; confirm actual contract:

**Option A (single promote endpoint that validates + creates/returns work order)**
- `POST /api/estimates/{estimateId}/promote`
  - Body: `{ "snapshotVersion": "v3" }` (or query param)
  - Success: `201 Created` (new work order) or `200 OK` with `{ workorderId }`
  - Duplicate: `409 Conflict` with `{ errorCode: "PROMOTION_ALREADY_EXISTS", workorderId }`
  - Validation failures: `422` with `{ errorCode: "...", message, details }`

**Option B (validate-only endpoint used before separate create)**
- `POST /api/estimates/{estimateId}/promotion-preconditions:validate`
  - Response: `{ allowed: true }` or `{ allowed:false, errorCode... }`
- Followed by separate promote/create endpoint.

### Submit/transition calls
- N/A in Moqui â€œtransitionâ€ sense unless backend exposes a transition-style service; if so, implement as Moqui screen transition calling service.

### Error handling expectations
- Map HTTP codes:
  - `401/403`: show not-authorized message; do not navigate.
  - `404`: show not-found (estimate missing).
  - `409`: duplicate promotion; show existing work order reference; offer navigation.
  - `422`: show specific precondition failure per `errorCode`.
  - `5xx`: show generic failure with retry option.

- Must display actionable messages for all 4 known error codes listed in provided inputs/reference.

---

## 10. State Model & Transitions

### Allowed states (domain awareness)
This story concerns Estimate promotion eligibility, but exact promotable estimate statuses are not fully specified in provided inputs (backend reference suggests â€œApprovedâ€). From `CUSTOMER_APPROVAL_WORKFLOW.md`, Estimate statuses include:
- `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`

### Role-based transitions
- This story does not implement new state transitions in Moqui; it initiates backend validation/promotion action.
- Backend enforces permissions; frontend must gracefully handle 403.

### UI behavior per state (estimate)
- If estimate is `APPROVED`: show Promote CTA prominently.
- If estimate is not `APPROVED`: CTA may be disabled with explanation **only if** business confirms (see Open Questions). Otherwise rely on backend to block with actionable error.

---

## 11. Alternate / Error Flows

### Validation failures
- Approval missing (`APPROVAL_NOT_FOUND`) â†’ show message + link/button â€œGo to Approvalsâ€ (if estimate screen has an approvals section; otherwise just message).
- Approval expired (`APPROVAL_EXPIRED`) â†’ show expiry detail if provided; instruct â€œResubmit approvalâ€.
- Approval invalid (`APPROVAL_INVALID`) â†’ instruct review approvals; possibly indicate â€œsupersededâ€ vs â€œrevokedâ€ if backend provides subreason.
- Approved scope missing/mismatch â†’ show message and block (exact error code TBD).

### Concurrency conflicts
- Two users attempt promotion simultaneously:
  - One succeeds; the other receives `409 PROMOTION_ALREADY_EXISTS` with `workorderId`.
  - UI must treat as safe: offer navigation to the returned work order.

### Unauthorized access
- If backend returns 403, show â€œYou donâ€™t have permission to promote estimates to work orders.â€ Do not reveal additional detail.

### Empty states
- If estimate detail fails to load / missing `snapshotVersion`, disable Promote and show â€œCannot promote: estimate version information not available.â€ (This indicates a data contract issue; should be rare.)

---

## 12. Acceptance Criteria

### Scenario 1: Promote succeeds with valid approval and scope
**Given** I am authenticated as a Service Advisor  
**And** I am viewing an estimate with `estimateId=E-100` and `snapshotVersion=v3`  
**And** the backend determines there is a current valid, non-expired approval for `snapshotVersion=v3` with approved scope  
**When** I click â€œPromote to Work Orderâ€  
**Then** the UI sends a promotion request including `estimateId` and `snapshotVersion=v3`  
**And** the UI receives a success response containing `workorderId`  
**And** the UI navigates to the Work Order detail screen for that `workorderId`.

### Scenario 2: Block promotion when approval is expired
**Given** I am viewing an estimate `E-101`  
**And** the backend determines the approval is expired  
**When** I click â€œPromote to Work Orderâ€  
**Then** the UI must not navigate away from the estimate  
**And** the UI must show a blocking error mapped to `errorCode=APPROVAL_EXPIRED`  
**And** the UI must instruct me to obtain/resubmit a new approval.

### Scenario 3: Block promotion when approval is missing
**Given** I am viewing an estimate `E-102`  
**And** the backend determines no approval exists  
**When** I click â€œPromote to Work Orderâ€  
**Then** the UI shows a blocking error mapped to `errorCode=APPROVAL_NOT_FOUND`  
**And** the UI provides guidance to capture customer approval before retrying.

### Scenario 4: Block promotion when approval is invalid (revoked/superseded)
**Given** I am viewing an estimate `E-103`  
**And** the backend determines the most recent approval is invalid  
**When** I click â€œPromote to Work Orderâ€  
**Then** the UI shows a blocking error mapped to `errorCode=APPROVAL_INVALID`  
**And** the UI instructs me to review approvals and capture a new valid approval.

### Scenario 5: Idempotent retry returns existing work order
**Given** estimate `E-104` with `snapshotVersion=v2` has already been promoted  
**And** the backend will return `409` with `{ errorCode: "PROMOTION_ALREADY_EXISTS", workorderId: "WO-123" }`  
**When** I click â€œPromote to Work Orderâ€ again  
**Then** the UI must not display a generic failure  
**And** the UI must display â€œAlready promotedâ€ with the returned `workorderId`  
**And** the UI provides an action to open the existing work order  
**And** when I choose to open it, the UI navigates to `WO-123`.

### Scenario 6: Network/server error shows retryable message
**Given** I am viewing an approved estimate  
**When** I click â€œPromote to Work Orderâ€ and the backend returns a `5xx` or the request times out  
**Then** the UI shows a non-sensitive error message indicating the promotion could not be validated/completed  
**And** the UI offers a retry action  
**And** the Promote button becomes enabled again after the error is shown.

---

## 13. Audit & Observability

### User-visible audit data
- Display is optional; not required by provided inputs. (Do not invent audit UI.)

### Status history
- Not in scope.

### Traceability expectations
- Frontend must include a correlation ID on the promotion request (header) if project conventions support it.
- Frontend should log a client-side event (console/telemetry if available in repo conventions) on:
  - promotion attempt
  - promotion success
  - promotion blocked with `errorCode`
  - duplicate detected (with workorderId)

---

## 14. Non-Functional UI Requirements

- **Performance:** Promotion action should provide immediate feedback (loading state within 100ms of click). No repeated polling.
- **Accessibility:** Button and error panel must be keyboard reachable; error messages announced to screen readers (aria-live region).
- **Responsiveness:** Works on tablet and desktop widths used in POS.
- **i18n/timezone/currency:** Not applicable beyond displaying `expiresAt` if present; if displayed, render in store/user timezone per existing app convention (needs confirmation).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-01: Provide a standard inline error panel with â€œRetryâ€ action for transient failures; qualifies as safe because it does not change domain logic and only improves operator recovery. Impacted sections: UX Summary, Alternate/Error Flows, Acceptance Criteria.
- SD-UX-LOAD-01: Disable the Promote button while the request is in flight to prevent double-submission; qualifies as safe because it is purely client-side ergonomics and backend remains idempotent. Impacted sections: Functional Behavior, Business Rules, Acceptance Criteria.

---

## 16. Open Questions

1. **Backend endpoint contract (blocking):** What is the exact Moqui-accessible endpoint/service for â€œpromote estimate to work orderâ€ (URL, method, request payload, response payload, HTTP codes)? Does it both validate and create/return a workorderId, or validate-only?
2. **Approved scope error code (blocking):** What `errorCode` is returned when approved scope is missing or `snapshotVersion` does not match the approved scope/approval record? (The story requires this check but no explicit code/name is provided.)
3. **Estimate snapshotVersion source (blocking):** Where does the frontend get the `snapshotVersion` to promote (field name on Estimate DTO, estimate version entity, or approval record reference)?
4. **Navigation route (blocking):** What is the canonical frontend route/screen path to open a work order by `workorderId` in this Moqui frontend (screen name + parameters)?
5. **Client correlation header (non-blocking if convention exists):** What header/key should be used for correlation ID propagation in this frontend (if standardized in repo)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Promotion: Validate Promotion Preconditions  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/231  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Promotion: Validate Promotion Preconditions

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor / Back Office

## Trigger
User attempts to promote an estimate to a workorder.

## Main Flow
1. User selects 'Promote to Workorder' on an estimate.
2. System verifies the estimate has a current valid approval (not expired, not superseded).
3. System verifies approved scope exists (full or partial) and references the correct snapshot version.
4. System checks that promotion has not already occurred for this estimate/snapshot (idempotency).
5. System either allows promotion or returns actionable errors.

## Alternate / Error Flows
- Approval missing/expired â†’ block and instruct resubmission.
- Promotion already performed â†’ return existing workorder reference.

## Business Rules
- Only current valid approvals can be promoted.
- Promotion must be idempotent.
- Approved scope governs what becomes executable work.

## Data Requirements
- Entities: Estimate, ApprovalRecord, ApprovedScope, Workorder, AuditEvent
- Fields: estimateId, snapshotVersion, approvalStatus, expiresAt, promotionRef, workorderId

## Acceptance Criteria
- [ ] System blocks promotion if approval is invalid or expired.
- [ ] System detects and handles re-tries without duplicates.
- [ ] System reports specific failed preconditions.

## Notes for Agents
Make precondition failures actionableâ€”this saves operator time.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #232: [FRONTEND] [STORY] Approval: Invalidate Approval on Estimate Revision â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/232
File: ./scripts/story-work/frontend/232/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title:** [FRONTEND] Approval: Reflect Approval Invalidation After Estimate Financial Revision (Work Order â†’ Pending Re-Approval)

**Primary Persona:** Service Advisor (primary). Secondary: Technician (read-only awareness).

**Business Value:** Prevents scope/price drift by ensuring any financially-relevant estimate revision forces re-approval before execution/promotion, with a clear audit trail visible in the POS UI.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** the POS UI to clearly indicate when a previously customer-approved work order has been invalidated due to an estimate financial revision and is now awaiting re-approval  
- **So that** I can re-seek customer approval and the system prevents continuing under an outdated approval.

### In Scope
- Frontend screens/components to:
  - Display Work Order approval status including **Pending Re-Approval**.
  - Display the reason/context for invalidation (old vs new totals, estimate version change, timestamp, and event/audit linkage if provided).
  - Block/disable UI actions that require a currently valid approval (e.g., â€œpromote/continue workflowâ€ actions) when status is Pending Re-Approval.
  - Provide navigation to re-approval capture flow (existing approval capture story/screen assumed) when re-approval is required.
  - Show audit/transition history entries related to the invalidation.

### Out of Scope
- Implementing backend event publishing/subscription (`pricing.EstimateFinanciallyRevised.v1`) or backend state machine logic.
- Defining pricing rounding rules or recalculation logic.
- Creating a new approval capture method UX (signature/email/etc.) beyond linking to existing flows.
- Introducing new workflow states beyond those already defined by `workexec`.

---

## 3. Actors & Stakeholders
- **Service Advisor:** needs to see invalidation and re-approve.
- **Technician:** must see that approval is no longer valid (informational); execution restrictions are enforced by backend, but UI must not present misleading â€œapprovedâ€ indicators.
- **System:** backend transitions Work Order to `PendingReApproval` after pricing event.
- **Auditor/Manager:** needs traceability via transition history/audit entries.

---

## 4. Preconditions & Dependencies

### Preconditions
- A Work Order exists and references an Estimate (`workOrder.estimateId`).
- The Work Order had previously been in an approved state (â€œCustomerApprovedâ€ per backend reference) and then was invalidated by backend due to estimate financial revision.
- Backend exposes Work Order current status and transition/audit history via API.

### Dependencies (Blocking if absent/unknown)
- Backend must provide an API to load:
  - Work Order details including **current status** and **estimate reference/version/total fields** (at least enough to show â€œapproval no longer validâ€).
  - Transition/audit entries that include invalidation details (old/new totals in minor units, old/new estimate version, eventId, actorId) as referenced in backend story.
- Existing frontend routes/screens for:
  - Work Order detail view.
  - Approval capture / re-approval flow for an estimate/work order (link target must be confirmed).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Work Order list â†’ select Work Order.
- Deep link: `/workorders/<workOrderId>` (exact route TBD by repo conventions).

### Screens to create/modify
- **Modify:** Work Order Detail screen to:
  - Render status `PendingReApproval` distinctly from â€œApprovedâ€.
  - Render an â€œApproval invalidatedâ€ callout when status is Pending Re-Approval.
  - Provide CTA: â€œRequest/Re-capture Approvalâ€ (navigates to existing approval capture screen).
- **Modify/Add:** Work Order â€œHistoryâ€ or â€œAuditâ€ subview to show the transition entry to `PendingReApproval` including reason metadata.
- **Optional Modify:** Work Order list row badges/filters to include `PendingReApproval`.

### Navigation context
- Work Order Detail has tabs/sections: Summary, Items, Approvals (if exists), History.
- From invalidation callout, user can navigate to:
  - Estimate view (read-only) to see new totals.
  - Approval capture flow.

### User workflows

#### Happy path: Advisor sees invalidation and re-approves
1. Advisor opens Work Order.
2. UI shows status = `PendingReApproval` and a callout explaining approval invalidated due to estimate revision with relevant details.
3. Advisor clicks â€œRe-capture Approvalâ€.
4. Approval capture completes (outside scope), backend transitions work order back to customer-approved state (outside scope).
5. On return/refresh, UI no longer shows invalidation callout; status reflects approved.

#### Alternate path: Technician views work order
1. Technician opens Work Order assigned to them.
2. UI indicates work is blocked awaiting customer re-approval; no â€œstart/continueâ€ actions presented if they depend on approval.

---

## 6. Functional Behavior

### Triggers
- Backend changes Work Order status to `PendingReApproval` after a pricing financial revision event is processed.
- Frontend detects status on load or via refresh/polling.

### UI actions
- On Work Order Detail load:
  - Fetch Work Order details.
  - Fetch transition history (or include in details) to find the latest invalidation transition record.
- If status is `PendingReApproval`:
  - Show blocking banner/callout: â€œCustomer approval invalidated â€” re-approval required.â€
  - Provide actions:
    - â€œView revised estimateâ€ (link to estimate detail if exists)
    - â€œRe-capture approvalâ€ (link to approval capture flow)
- Disable/hide actions that would misrepresent approval validity (see Business Rules/UI mapping).

### State changes (frontend-local)
- No client-side state machine decisions; UI reflects backend status.
- Local UI state: loading, error, empty audit history, unauthorized.

### Service interactions
- Read: Work Order by id; transitions/audit by workOrderId.
- Navigation: route transitions only; no direct invalidation action from UI in this story.

---

## 7. Business Rules (Translated to UI Behavior)

> Authoritative rules come from backend reference + workexec guide. UI must not invent policy.

### Validation / gating (UI-level)
- When Work Order status is `PendingReApproval`, the UI MUST:
  - Indicate approval is not current.
  - Prevent initiating any frontend actions that assume a valid approval **if such actions exist on the Work Order UI** (e.g., â€œStart Work Orderâ€, â€œMove to Ready for Pickupâ€, â€œClose/Completeâ€, â€œGenerate invoiceâ€, etc.).  
  - If the UI currently shows these actions, they must be disabled with an inline reason: â€œBlocked: estimate was revised; customer re-approval required.â€

### Visibility rules
- Invalidation details panel is shown when:
  - `workOrder.status == PendingReApproval` OR
  - transition history contains a latest transition to PendingReApproval even if current status later changed (then show in History only, not banner).

### Error messaging expectations
- If invalidation details cannot be loaded (history endpoint fails), show a fallback message:
  - â€œApproval requires re-approval due to estimate revision. Details unavailable.â€  
  - Do not block navigation to re-approval due to missing audit detail.

---

## 8. Data Requirements

### Entities involved (frontend view models)
- **WorkOrder**
  - `id` (string/number)
  - `status` (enum/string; includes `PendingReApproval`)
  - `estimateId`
  - (If available) `approvedEstimateVersion`, `approvedEstimateTotalMinor`, current `estimateVersion`, current `estimateTotalMinor`
- **WorkOrderStateTransition** (from `GET /api/workorders/{id}/transitions` per workexec doc; backend story adds extra fields)
  - `id`
  - `workOrderId`
  - `fromStatus`
  - `toStatus`
  - `transitionedAt` (UTC)
  - `transitionedBy` (userId)
  - `reason` (text)
  - `metadata` (JSON) â€” expected to include keys such as:
    - `estimateId`
    - `oldVersion`, `newVersion`
    - `oldTotalMinor`, `newTotalMinor`
    - `eventId`
    - `actorId`

### Fields (type, required, defaults)
- `status`: required; if missing treat as error (cannot render gating).
- `transition history`: optional; empty list allowed.

### Read-only vs editable
- All fields in this story are read-only in UI.
- No editing of approval artifacts here.

### Derived/calculated fields
- â€œApproval invalidated atâ€: derived from latest transition where `toStatus == PendingReApproval` (timestamp).
- â€œChanged amountâ€: derived from `newTotalMinor - oldTotalMinor` if both available; display formatting handled by existing currency utility (must not invent currency).

---

## 9. Service Contracts (Frontend Perspective)

> Exact endpoints may differ in Moqui; below are required capabilities. If the project uses Moqui screens/services instead of REST, map accordingly during implementation.

### Load/view calls
1. **Load Work Order**
   - Capability: fetch work order detail by id
   - Expected response includes: `id`, `status`, `estimateId` (minimum)
2. **Load Work Order transitions/history**
   - `GET /api/workorders/{id}/transitions` (from WORKORDER_STATE_MACHINE.md)
   - Expected response: array of transition records
   - Must include the transition to `PendingReApproval` with `reason` and optionally `metadata`.

### Create/update calls
- None in scope.

### Submit/transition calls
- None in scope (backend performs invalidation automatically).

### Error handling expectations
- `401/403`: show unauthorized screen/state; do not show sensitive metadata.
- `404`: show â€œWork order not foundâ€.
- `409`: if seen when attempting actions (if any remain clickable), show â€œWork order status changed, refresh required.â€
- Generic errors: show toast/banner; keep read-only page usable if possible.

---

## 10. State Model & Transitions

### Allowed states (relevant subset)
From workexec FSM + backend reference:
- WorkOrder statuses include `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, etc. (see WORKORDER_STATE_MACHINE.md)
- Backend reference introduces/uses:
  - `CustomerApproved` (source state for invalidation check)
  - `PendingReApproval` (target state when invalidating)

### Role-based transitions (UI concerns)
- UI must not enable â€œstart work orderâ€ when in `PendingReApproval` (even if technician has other permissions).
- UI should direct only Service Advisor to re-approval capture CTA (if role info is available). If roles are not available client-side, show CTA but backend must enforce permissions.

### UI behavior per state
- **PendingReApproval**
  - Show invalidation banner + CTA(s)
  - Disable/hide downstream actions that require approval
  - Show latest invalidation details if present
- **Other states**
  - No banner; history still shows prior invalidation transition if it occurred.

---

## 11. Alternate / Error Flows

### Validation failures
- Not applicable (read-only story), except gating of actions.

### Concurrency conflicts
- If Work Order status updates between load and user action (re-approval capture navigation or other button clicks), UI must handle `409` or stale display by offering refresh.

### Unauthorized access
- If user lacks permission to view transitions/audit:
  - Still show `PendingReApproval` status and banner based on Work Order status
  - Hide detailed metadata; show generic message
  - Provide navigation to re-approval only if permitted (unknown; see Open Questions)

### Empty states
- Transition list empty:
  - History tab shows â€œNo transitions recorded.â€
  - If status is PendingReApproval but no transition record returned: show banner with â€œDetails unavailableâ€.

---

## 12. Acceptance Criteria

### Scenario 1: Work Order displays Pending Re-Approval status and banner
**Given** a Work Order has `status = PendingReApproval`  
**When** the user opens the Work Order detail screen  
**Then** the UI displays a clear indicator that customer approval is invalidated and re-approval is required  
**And** the UI does not display the Work Order as â€œApproved/Customer Approvedâ€.

### Scenario 2: Invalidation details shown from transition history
**Given** a Work Order has `status = PendingReApproval`  
**And** the transitions endpoint returns a latest transition with `toStatus = PendingReApproval` including `transitionedAt`, `reason`, and `metadata.oldTotalMinor`/`metadata.newTotalMinor`  
**When** the user views the Work Order detail (or History section)  
**Then** the UI shows the invalidation timestamp and reason  
**And** the UI shows old vs new totals when available  
**And** the UI shows estimate version change when available.

### Scenario 3: Missing transition metadata degrades gracefully
**Given** a Work Order has `status = PendingReApproval`  
**And** the transitions endpoint returns an empty list OR returns records without `metadata`  
**When** the user opens the Work Order detail screen  
**Then** the UI still shows the â€œre-approval requiredâ€ banner  
**And** the UI shows â€œDetails unavailableâ€ (or equivalent) without breaking the page.

### Scenario 4: Actions requiring valid approval are blocked in UI
**Given** a Work Order has `status = PendingReApproval`  
**When** the user views the Work Order detail screen  
**Then** any action buttons that would proceed as if approval is valid (e.g., start/advance/close/promote/invoice) are disabled or hidden  
**And** if disabled, they include an explanation: â€œBlocked: customer re-approval required due to estimate revision.â€

### Scenario 5: Unauthorized to view audit history
**Given** a Work Order has `status = PendingReApproval`  
**And** calling transitions returns `403 Forbidden`  
**When** the user opens the Work Order detail screen  
**Then** the UI shows the Pending Re-Approval banner based on Work Order status  
**And** the UI does not show restricted audit details  
**And** the UI remains usable.

### Scenario 6: Work Order no longer pending re-approval after refresh
**Given** a Work Order was `PendingReApproval`  
**And** after re-approval the backend status becomes `CustomerApproved` (or equivalent approved state)  
**When** the user refreshes the Work Order detail screen  
**Then** the re-approval-required banner is no longer shown  
**And** the History still contains the prior invalidation transition record.

---

## 13. Audit & Observability

### User-visible audit data
- Work Order History view must show transition entry to `PendingReApproval` including:
  - who (userId or display name if available)
  - when (UTC timestamp, rendered in local time)
  - why (`reason`)
  - what changed (old/new totals and versions if present in metadata)

### Status history
- Must render transitions in chronological order with newest first (unless existing convention differs).

### Traceability expectations
- If `metadata.eventId` exists, display as a non-editable reference (copyable) for support/debug.

---

## 14. Non-Functional UI Requirements

- **Performance:** Work Order detail should load with at most 2 network calls (work order + transitions). Transitions can be lazy-loaded when opening History tab if needed.
- **Accessibility:** Banner/callout must be perceivable with screen readers; disabled buttons must include accessible description of why disabled.
- **Responsiveness:** Works on tablet resolutions used in POS environment.
- **i18n/timezone/currency:**  
  - Times: store in UTC from backend, display in user locale.  
  - Currency: display using existing currency formatting utilities; do not assume currency code without backend-provided context.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATES: Provide explicit empty-state messaging for missing transition history; qualifies as safe UI ergonomics. Impacted sections: UX Summary, Alternate/Empty states, Acceptance Criteria.
- SD-ERR-MAPPING-STD: Standard handling for 401/403/404/409 with user-friendly messages; qualifies as safe because it does not alter domain policy. Impacted sections: Service Contracts, Alternate/Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **State naming alignment:** Backend reference uses `CustomerApproved` and `PendingReApproval`, while existing workexec FSM doc lists `APPROVED` and does not mention these approval-specific states. What are the exact Work Order status enum values exposed to frontend for â€œcustomer-approvedâ€ and â€œpending re-approvalâ€?  
2. **Frontend routing/link targets:** What is the canonical route/screen for â€œRe-capture Approvalâ€ (estimate approval capture) in the Moqui frontend? Provide route name and required params (estimateId vs workOrderId).  
3. **Action gating list:** Which specific Work Order UI actions must be blocked when status is `PendingReApproval` in the current frontend (e.g., start, complete, close, invoice, pick parts)? Please list existing buttons/commands so gating is deterministic.  
4. **Audit metadata availability:** Will `GET /api/workorders/{id}/transitions` include the invalidation details (`oldTotalMinor`, `newTotalMinor`, `oldVersion`, `newVersion`, `eventId`, `actorId`) in `metadata`, or will there be a separate endpoint for approval invalidations?  
5. **Role/permission signals:** Does the frontend have access to the userâ€™s roles/permissions to conditionally show the â€œRe-capture Approvalâ€ CTA only to Service Advisors, or should the CTA always show and rely on backend authorization?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Approval: Invalidate Approval on Estimate Revision â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/232

Labels: frontend, story-implementation, customer

## Frontend Implementation for Story

**Original Story**: [STORY] Approval: Invalidate Approval on Estimate Revision

**Domain**: customer

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
An approved (or pending approval) estimate is modified after submission/approval.

## Main Flow
1. System detects a change that affects scope, pricing, quantities, taxes, or terms.
2. System invalidates existing approval record(s) and marks them as superseded.
3. System transitions estimate back to Draft (or Revision) and requires resubmission.
4. System records invalidation reason and linkage between versions.
5. System prevents promotion until a new valid approval is captured.

## Alternate / Error Flows
- Minor change that does not affect customer-visible outcome â†’ policy may allow non-invalidation (rare; configurable).

## Business Rules
- Any customer-visible change invalidates approval.
- Invalidation must preserve original approval artifact but mark it not-current.
- Promotion validation checks for latest valid approval.

## Data Requirements
- Entities: Estimate, ApprovalRecord, ApprovalSnapshot, AuditEvent
- Fields: invalidationReason, supersededByApprovalId, status, changedFields, changedBy, changedDate

## Acceptance Criteria
- [ ] Approval is invalidated when customer-visible changes occur.
- [ ] System requires resubmission and blocks promotion until re-approved.
- [ ] Audit shows why and when approval was invalidated.

## Notes for Agents
This is the guardrail against scope/price driftâ€”keep it strict.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #233: [FRONTEND] [STORY] Approval: Submit Estimate for Customer Approval  
File: ./scripts/story-work/frontend/233/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Approval: Submit Estimate for Customer Approval

### Primary Persona
Service Advisor

### Business Value
Enables a Service Advisor to formally submit a completed draft estimate for customer consent, producing an immutable approval snapshot and auditable submission record to support downstream approval workflows and compliance.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to submit a draft estimate for customer approval  
- **So that** the estimate is validated, moved into a pending-approval state, and an immutable approval snapshot + approval request payload are created for customer consent processing.

### In Scope
- Frontend action to submit an estimate for customer approval.
- Frontend-driven validation display (field/section-level errors) based on backend response.
- Moqui screen flow for:
  - Loading an estimate
  - Confirming submission
  - Executing submit service
  - Showing resulting status + approval request reference
- Audit visibility requirements (who/when) as read-only UI fields (if returned by backend).

### Out of Scope
- Customer-facing approval experience (signature capture, external links, customer portal).
- Editing estimate line items/taxes/terms (assumed handled in other stories).
- Notification delivery (email/SMS) and token/link distribution.
- Defining estimate completeness policy (requires clarification; see Open Questions).

---

## 3. Actors & Stakeholders

- **Service Advisor (Primary Actor):** initiates submission.
- **Customer (Stakeholder):** recipient of approval request (not interacting in this story).
- **Audit/Compliance (Stakeholder):** requires immutable snapshot and audit trail.
- **Backend workexec services (System):** enforce completeness checks, state transition, snapshot creation, approval payload generation.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS UI.
- Estimate exists and is retrievable by `estimateId`.
- Estimate is currently in a submit-eligible state (intended: `DRAFT`; see State Model section).

### Dependencies
- Backend endpoint/service to submit estimate for approval (not explicitly provided in inputs; required).
- Backend must return:
  - Updated estimate status (e.g., `PENDING_APPROVAL`)
  - Snapshot reference (e.g., `snapshotId` and/or `snapshotVersion`)
  - Approval request reference (e.g., `approvalRequestId`, approval method, consent text if needed)
- Backend completeness validation rules and error schema (required for actionable UI errors).

---

## 5. UX Summary (Moqui-Oriented)

### Entry Points
- From an Estimate detail screen (viewing a single estimate), a primary action button: **â€œSubmit for Approvalâ€** visible only when estimate is submit-eligible.

### Screens to Create/Modify
- **Modify:** `EstimateDetail` screen (or equivalent existing estimate view screen)
  - Add â€œSubmit for Approvalâ€ action
  - Add read-only fields/section for approval metadata after submission (status, submittedBy/submittedDate if available, approvalRequestId, snapshotVersion)
- **Create (if not existing):** `EstimateSubmitConfirm` dialog/screen (can be a modal)
  - Shows irreversible action confirmation + key summary fields (estimate id, total, customer, method if known)
  - â€œConfirm Submitâ€ / â€œCancelâ€

### Navigation Context
- Route pattern (proposed; adjust to repo conventions):  
  - `#/estimates/:estimateId` â†’ Estimate Detail  
  - Submission stays on detail screen and refreshes state after successful submit.

### User Workflows
#### Happy Path
1. Service Advisor opens Estimate Detail (status `DRAFT`).
2. Clicks **Submit for Approval**.
3. Confirm modal opens; user confirms.
4. UI calls submit service; shows loading.
5. On success: status updates to `PENDING_APPROVAL`, submission metadata appears, submit button disabled/hidden.

#### Alternate Paths
- If estimate already pending approval: button hidden/disabled; if attempted via deep link/action, show non-blocking info message and refresh.
- If backend returns completeness errors: remain in `DRAFT`, show actionable errors (grouped).
- If backend returns conflict (e.g., already submitted by another user): refresh estimate and show latest status.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œSubmit for Approvalâ€ on an estimate in `DRAFT`.

### UI Actions
- Open confirmation UI requiring explicit user confirmation.
- Execute submit request.
- After response:
  - Refresh estimate data (either from submit response payload or via re-load call).
  - Update UI state (status banner, disable actions, display approval request references).
  - Show toast/inline confirmation message: â€œSubmitted for customer approval.â€

### State Changes (Frontend)
- Frontend state is derived from backend estimate status.
- Submit action becomes unavailable when status is not `DRAFT`.

### Service Interactions
- `loadEstimate(estimateId)` on screen entry.
- `submitEstimateForApproval(estimateId, submittedByUserId?)` on confirmation.
- Optional: `loadApprovalRequest(approvalRequestId)` if approval details are not embedded in estimate response.

---

## 7. Business Rules (Translated to UI Behavior)

> Note: Business rules for â€œcompletenessâ€ are explicitly *unclear* in provided inputs beyond examples; frontend must rely on backend to be source of truth and return a structured error list.

### Validation
- Frontend must not attempt to replicate completeness logic beyond basic â€œmust have estimateId loadedâ€ gating.
- On submit:
  - If backend rejects due to completeness, UI must display:
    - A summary message: â€œEstimate is not complete. Fix the items below before submitting.â€
    - A list of specific issues as returned (field/section + message).

### Enable/Disable Rules
- â€œSubmit for Approvalâ€ visible/enabled only when:
  - Estimate is loaded
  - Estimate status is `DRAFT`
  - User has permission to submit (permission name unknown â†’ Open Question)

### Visibility Rules
- Approval metadata section visible when estimate status is `PENDING_APPROVAL` (or equivalent).
- Snapshot reference visible once created.

### Error Messaging Expectations
- 400 validation: show actionable list; do not log sensitive info (e.g., customer contact) in UI errors.
- 409 conflict: â€œThis estimate was updated or submitted by another user. Reloading latest state.â€
- 403 forbidden: â€œYou do not have permission to submit estimates for approval.â€
- 404 not found: â€œEstimate not found.â€

---

## 8. Data Requirements

### Entities Involved (Frontend View)
- **Estimate**
- **ApprovalRequest**
- **ApprovalSnapshot** (or `EstimateSnapshot`)
- **AuditEvent** (read-only; if exposed)
  
> Exact entity names in Moqui may differ; map to backend payload fields.

### Fields (Type / Required / Defaults)
#### Estimate (minimum fields needed by UI)
- `estimateId` (string/number, required)
- `status` (enum string, required)
- `customerId` (string/number, required for submission eligibility but enforced by backend)
- `shopId/locationId` (string/number, optional for display)
- `totalAmount` (decimal, optional but recommended for confirmation display)
- `currencyUomId` (string, optional)
- `submittedBy` (string/number, optional; backend-provided)
- `submittedDate` (datetime, optional; backend-provided)
- `approvalMethod` (enum string, optional; backend-provided or derived from configuration)
- `approvalRequestId` (string/number, optional; populated post-submit)
- `snapshotVersion` (integer, optional; populated post-submit)
- `snapshotId` (string/number, optional; populated post-submit)

#### ApprovalRequest (if separately loaded)
- `approvalRequestId` (required)
- `status` (enum, optional)
- `consentText` (string, optional)
- `approvalToken` / `approvalLink` (sensitive; **must not** be displayed unless explicitly requiredâ€”Open Question)

### Read-only vs Editable
- All approval-related fields are read-only in frontend for this story.
- Estimate becomes non-editable in this flow once `PENDING_APPROVAL` (edit behavior may belong to a different story).

### Derived/Calculated
- None in frontend; totals displayed as returned.

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not fully defined in provided inputs for â€œsubmit for approvalâ€ for estimates (workexec guide lists approval capture endpoints but not â€œsubmitâ€). This story therefore requires clarification and/or alignment with backend issue #168.

### Load / View Calls
- `GET /api/estimates/{id}`  
  **Response:** Estimate with status and approval-related references if present.

### Submit / Transition Calls (Required)
- **Proposed:** `POST /api/estimates/{id}/submit-for-approval`  
  **Request:** `{ submittedBy: <userId>, reason?: <string> }` (reason optional; not specified)  
  **Response (200/201):** updated estimate + `approvalRequestId` + `snapshotId`/`snapshotVersion`

> If backend instead uses Moqui service name invocation, the frontend Moqui screen transition should call a Moqui service like `workexec.EstimateSubmitForApproval` and return the same fields.

### Error Handling Expectations
- `400 Bad Request`: completeness validation failures with structured list:
  - `errors: [{ code, field, message }]`
- `409 Conflict`: optimistic concurrency / already submitted
- `403 Forbidden`: permission denial
- `404 Not Found`: unknown estimateId
- `500`: show generic error â€œCould not submit estimate. Try again.â€

---

## 10. State Model & Transitions

### Allowed States (Estimate)
Provided authoritative states in `CUSTOMER_APPROVAL_WORKFLOW.md` are: `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`.

However, this frontend story requires a `PendingApproval` state, which conflicts with that document unless â€œPendingApprovalâ€ is an additional internal state not documented there.

### Required Transition (Story)
- `DRAFT` â†’ `PENDING_APPROVAL` (or equivalent) on submit.

### Role-based Transitions
- Service Advisor can initiate submit transition (permission details unknown â†’ Open Question).

### UI Behavior per State
- `DRAFT`: show Submit button.
- `PENDING_APPROVAL`: hide/disable submit, show submission metadata and approval request reference.
- Other states: submit unavailable; show read-only status.

**Conflict Note:** Since estimate states are inconsistent across provided references, implementation must be blocked until canonical state enum is confirmed.

---

## 11. Alternate / Error Flows

### Validation Failures (Completeness)
- Backend returns 400 with list of missing/invalid elements (taxes, items, terms, totals).
- UI displays list; keeps estimate in `DRAFT`; no snapshot created.

### Duplicate Submission
- If estimate already pending approval:
  - Backend returns 409 or 400; UI shows â€œAlready submittedâ€ and refreshes.
  - UI must not create duplicate submission attempts (disable button while request in-flight).

### Concurrency Conflicts
- Another user submits while current user has page open.
- On submit: backend returns 409; UI refreshes estimate and shows updated status.

### Unauthorized Access
- 403: show message and do not alter local state.

### Empty States
- If estimate loads but missing required display fields, UI still renders with placeholders and relies on backend for submission eligibility.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Successful submission from Draft
**Given** I am a Service Advisor viewing an estimate with status `DRAFT`  
**When** I click â€œSubmit for Approvalâ€ and confirm submission  
**Then** the system sends a submit request for that estimate  
**And** the estimate status is updated to `PENDING_APPROVAL` (or the configured pending-approval equivalent)  
**And** the UI displays a reference to the created approval snapshot (snapshot id and/or version)  
**And** the UI displays a reference to the created approval request (approvalRequestId)  
**And** the â€œSubmit for Approvalâ€ action is no longer available.

### Scenario 2: Submission blocked due to completeness validation
**Given** I am viewing an estimate with status `DRAFT`  
**And** the estimate is incomplete per backend completeness rules  
**When** I attempt to submit for approval  
**Then** the system rejects the submission with validation errors  
**And** the estimate remains in `DRAFT`  
**And** the UI displays an actionable list of validation errors returned by the backend.

### Scenario 3: Prevent re-submitting an already pending approval estimate
**Given** I am viewing an estimate with status `PENDING_APPROVAL` (or equivalent)  
**When** I attempt to submit for approval  
**Then** the UI prevents the action (button hidden/disabled)  
**And** if a request is still made (e.g., via direct call), the UI shows an â€œAlready submittedâ€ message  
**And** the estimate status remains unchanged.

### Scenario 4: Concurrency conflict on submit
**Given** I am viewing an estimate that was `DRAFT` when loaded  
**And** another user submits the estimate for approval before I do  
**When** I submit for approval  
**Then** the backend responds with a conflict (409)  
**And** the UI reloads the estimate  
**And** the UI displays the current estimate status and indicates it was updated elsewhere.

### Scenario 5: Unauthorized user cannot submit
**Given** I am logged in without permission to submit estimates for approval  
**When** I attempt to submit a `DRAFT` estimate for approval  
**Then** the backend responds with 403  
**And** the UI shows an authorization error  
**And** the estimate remains unchanged.

---

## 13. Audit & Observability

### User-visible audit data
- Display (if available from backend):
  - `submittedBy`
  - `submittedDate` (UTC displayed in userâ€™s locale)
  - `snapshotVersion` / `snapshotId`
  - `approvalRequestId`

### Status history
- If an endpoint exists to fetch estimate history, link to it; otherwise out of scope.

### Traceability expectations
- Frontend must include correlation/request ID support per project convention (if already present) and ensure submit action logs include `estimateId` (no PII).

---

## 14. Non-Functional UI Requirements

- **Performance:** Submit action should show immediate loading state; avoid duplicate submissions (disable confirm button while in-flight).
- **Accessibility:** Confirmation dialog must be keyboard-navigable; errors must be announced via ARIA-friendly mechanism provided by Quasar.
- **Responsiveness:** Works on tablet and desktop layouts used in POS.
- **i18n/timezone/currency:** Display money using `currencyUomId` if provided; timestamps rendered in local timezone; do not assume currency formatting rules beyond existing app utilities.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a generic empty/error placeholder when approval metadata is absent; safe because it affects only presentation and not business logic. (Impacted: UX Summary, Error Flows)
- SD-UX-INFLIGHT-GUARD: Disable submit/confirm controls while request is pending to prevent duplicate submissions; safe because it is UI-only idempotency support. (Impacted: Functional Behavior, Error Flows)
- SD-ERR-HTTP-MAP: Map common HTTP status codes (400/403/404/409/500) to user-friendly messages; safe because it does not change domain policy and relies on backend as SoR. (Impacted: Business Rules, Error Flows, Acceptance Criteria)

---

## 16. Open Questions

1. **Canonical Estimate State Model:** What are the official estimate statuses in this system for â€œpending customer approvalâ€? The provided `CUSTOMER_APPROVAL_WORKFLOW.md` lists only `DRAFT/APPROVED/DECLINED/EXPIRED`, but this story requires `PENDING_APPROVAL`. What is the correct enum value and transition?
2. **Backend Submit Endpoint / Moqui Service Contract:** What is the exact API endpoint (or Moqui service name) to â€œsubmit estimate for approvalâ€, and what request/response schema should the frontend use?
3. **Completeness Checklist:** What are the exact completeness requirements enforced at submission time (required fields/items/taxes/totals/terms)? Provide the backend error codes/fields so the frontend can render targeted messages.
4. **Permissions/RBAC:** What permission(s) gate the â€œSubmit for Approvalâ€ action (role name or permission ID)? Should the UI hide the button or show it disabled with an explanation?
5. **Approval Method & Consent Text Display:** Should the Service Advisor see the selected approval method and consent text at submission time? If yes, should consent text be previewed in the confirm dialog?
6. **Approval Token/Link Sensitivity:** Will the backend return an approval token/link in the submission response? If yes, is the Service Advisor allowed to view/copy it in POS, or must it remain hidden for security?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Approval: Submit Estimate for Customer Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/233  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Approval: Submit Estimate for Customer Approval

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor

## Trigger
A Draft estimate is complete and ready for customer consent.

## Main Flow
1. User selects 'Submit for Approval'.
2. System validates estimate completeness (required fields, items, taxes, totals, terms).
3. System transitions estimate to PendingApproval and freezes an approval snapshot.
4. System generates an approval request payload (method, link/token, consent text).
5. System logs the submission event for audit.

## Alternate / Error Flows
- Validation fails (missing taxes, missing items) â†’ block and show actionable errors.
- Estimate already pending approval â†’ prevent duplicate submissions and show status.

## Business Rules
- Only submit-ready estimates may enter PendingApproval.
- Submission creates an immutable approval snapshot version.
- Submission must be auditable (who/when).

## Data Requirements
- Entities: Estimate, ApprovalRequest, ApprovalSnapshot, AuditEvent
- Fields: status, approvalRequestId, snapshotVersion, consentText, submittedBy, submittedDate, approvalMethod

## Acceptance Criteria
- [ ] System blocks submission when required completeness checks fail.
- [ ] PendingApproval state is set and visible.
- [ ] An approval snapshot is created and referenced by the request.

## Notes for Agents
Approval snapshot must remain immutable; later revisions require resubmission.

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #234: [FRONTEND] [STORY] Estimate: Present Estimate Summary for Review  
File: ./scripts/story-work/frontend/234/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Estimate: Present Customer-Facing Estimate Summary for Review (Snapshot-Based)

## Primary Persona
Service Advisor

## Business Value
Enable Service Advisors to generate a deterministic, customer-facing estimate summary (view/print/share) that matches an immutable snapshot for review prior to seeking customer approval, while enforcing visibility policies and legal/compliance requirements.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor  
- **I want** to generate and view a customer-facing estimate summary for a Draft estimate  
- **So that** I can review scope, pricing, taxes/fees, terms, and expiration with the customer before submitting the estimate for approval.

## In-scope
- UI action to generate a customer-facing summary for an estimate in **DRAFT** status.
- Rendering a read-only summary from an **immutable snapshot** created at generation time.
- Enforcing role/policy-based visibility (hide internal-only fields like cost/margin).
- Displaying configured terms/disclaimers and expiration date when applicable.
- Optional next step CTA to proceed to â€œSubmit for Approvalâ€ (navigation only; actual approval capture is out of scope unless endpoint exists).

## Out-of-scope
- Editing estimate line items/pricing (only Draft editing elsewhere).
- Creating/changing legal terms configuration or policy configuration UI.
- Implementing approval capture flows (signature, electronic signature, etc.).
- PDF generation implementation details if backend doesnâ€™t provide it (frontend will consume provided format).

---

# 3. Actors & Stakeholders

- **Primary Actor:** Service Advisor
- **Secondary Actors:** Customer (recipient of summary), System (Moqui + backend services)
- **Stakeholders:** Compliance/Legal (terms/disclaimers), Finance (totals correctness), Audit/Security (visibility enforcement and immutable records)

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in POS frontend.
- Estimate exists and is accessible to the current user (authorization enforced server-side).
- Estimate is in status **DRAFT** (per workexec approval workflow).

## Dependencies
- Backend capability to:
  - Validate estimate status and permissions.
  - Generate and persist an **Estimate Summary Snapshot** (immutable), and return snapshot identifier and renderable content or data model.
  - Provide visibility policy outcomes (or already-filtered payload).
  - Provide legal terms/disclaimer text and missing-terms policy behavior (`FAIL` vs `USE_DEFAULTS`), captured in snapshot.
- Moqui screen route(s) to reach estimate detail and summary.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From **Estimate Detail** screen (Draft estimate): action button/link **â€œCustomer Summaryâ€**.

## Screens to create/modify
1. **Modify**: `EstimateDetail` screen (existing)  
   - Add action to generate/open summary.
2. **Create**: `EstimateSummaryReview` screen  
   - Displays snapshot-based summary (read-only).
   - Provides actions: Print, Download/Export (if supported), Back to Estimate, Proceed to Submit for Approval (if available route).

## Navigation context
- Route pattern (proposed):  
  - `/estimates/:estimateId` â†’ detail  
  - `/estimates/:estimateId/summary` â†’ summary generation + display  
  - Optionally `/estimate-summaries/:snapshotId` if snapshot is first-class.

## User workflows
### Happy path
1. SA opens Draft estimate.
2. Clicks **Customer Summary**.
3. System generates snapshot and loads summary view.
4. SA reviews totals, terms, expiration.
5. SA prints/downloads and discusses with customer.
6. SA optionally clicks **Proceed to Approval** â†’ navigates to approval flow entry.

### Alternate paths
- Estimate not Draft â†’ show error and stay on detail.
- Missing legal terms:
  - Policy FAIL â†’ block generation with clear message.
  - Policy USE_DEFAULTS â†’ generate summary and show banner â€œDefault terms usedâ€ (if backend indicates).
- Visibility policy hides internal fields â†’ summary excludes them (no placeholders).

---

# 6. Functional Behavior

## Triggers
- User action: click/tap **Customer Summary** on a Draft estimate.

## UI actions
- Disable the action while request is in-flight.
- On success, navigate to summary screen with `snapshotId` (preferred) or render returned document.

## State changes
- **No estimate state change** (remains DRAFT).
- A new immutable **EstimateSummarySnapshot** is created (backend responsibility), recorded for audit.

## Service interactions
- Call â€œGenerate Estimate Summary Snapshotâ€ service/endpoint (see Service Contracts).
- Then call â€œFetch Summary Snapshot/Rendered Summaryâ€ if generation endpoint returns only an ID.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Only allow summary generation when estimate status is **DRAFT**.
  - UI may optimistically hide/disable action if estimate status != DRAFT (but server is authoritative).
- Totals displayed (line totals, subtotal, taxTotal, fees, grandTotal) must match snapshot values exactly.

## Enable/disable rules
- â€œCustomer Summaryâ€ action:
  - Enabled when estimate status == DRAFT and user has view permission.
  - Disabled otherwise; if clicked via deep link, show appropriate error.

## Visibility rules
- Do not display internal-only fields (e.g., `itemCost`, `profitMargin`, margin %) for unauthorized roles.
- Prefer backend-filtered payload; if backend provides visibility flags, frontend must enforce hiding (defense in depth).

## Error messaging expectations
- Invalid status: â€œSummary can only be generated for Draft estimates.â€
- Missing legal terms with FAIL policy: â€œCannot generate estimate summary: Legal terms and conditions not configured.â€
- Forbidden: â€œYou donâ€™t have access to this estimate.â€
- Not found: â€œEstimate not found.â€
- Generic: â€œUnable to generate summary. Please try again or contact support.â€

---

# 8. Data Requirements

## Entities involved (conceptual, as used by UI)
- `Estimate`
- `EstimateItem` (services/parts/labor lines; exact types TBD)
- `EstimateSummarySnapshot` (immutable)
- `LegalTermsConfiguration` / `MissingLegalTermsPolicy` (as referenced through snapshot metadata)
- `VisibilityPolicy` / role-based field visibility (as applied to snapshot payload)

## Fields (type, required, defaults)
### Estimate (read-only in this story)
- `estimateId` (string/uuid or long; **required**)
- `status` (enum: `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`; **required**)
- `subtotal` (money; required)
- `taxTotal` (money; required)
- `feesTotal` (money; optional if supported; else 0)
- `grandTotal` (money; required)
- `expirationDate` (datetime/date; optional)

### EstimateItem (read-only)
- `description` (string; required)
- `quantity` (decimal; required)
- `unitPrice` (money; required)
- `lineTotal` (money; required)
- Internal-only (must be excluded unless authorized):
  - `itemCost` (money; optional)
  - `profitMargin` (money/percent; optional)

### EstimateSummarySnapshot (read-only)
- `snapshotId` (string/uuid; required)
- `estimateId` (required)
- `snapshotTimestamp` (datetime UTC; required)
- `snapshotData` (json; required â€” but UI should consume a typed subset)
- `legalTermsSource` (`CONFIGURED` | `DEFAULT` | null; required in snapshot, nullable by schema)
- `legalTermsVersion` (string; optional)
- `legalTermsText` (text; optional depending on policy)
- `policyMode` (`FAIL` | `USE_DEFAULTS`; required)
- `createdBy` (user id; required)
- `auditMetadata` (json; required)

## Read-only vs editable by state/role
- All fields in this story are **read-only**.
- No edits to estimate items, terms, or totals from the summary view.

## Derived/calculated fields
- Per-line display totals and overall totals are **not recalculated by frontend**; displayed values must come from snapshot payload.

---

# 9. Service Contracts (Frontend Perspective)

> Note: Backend endpoints are partially defined in provided references; exact endpoint(s) for summary snapshot are not specified for Moqui. This section defines required frontend-facing contracts; if backend differs, adapt but keep behaviors.

## Load/view calls
1. **Get Estimate (for header/status guard)**
   - `GET /api/estimates/{estimateId}`
   - Used to confirm status and basic info, or rely on existing estimate detail context.

2. **Fetch Summary Snapshot**
   - `GET /api/estimates/{estimateId}/summary-snapshots/{snapshotId}` **OR**
   - `GET /api/estimate-summary-snapshots/{snapshotId}`
   - Returns snapshot metadata + customer-facing display model (preferred) and optionally a rendered HTML/PDF URL.

## Create/update calls
1. **Generate Summary Snapshot**
   - `POST /api/estimates/{estimateId}/summary`
   - Request: `{}` or `{ requestedBy: <userId?> }` (prefer server derives user from auth)
   - Response (201):
     - `snapshotId`
     - `renderFormat` (`HTML` | `PDF` | `DATA`)
     - `summaryUrl` (optional)
     - `snapshot` (optional inline payload)

## Submit/transition calls
- None required for summary generation.
- Optional navigation to approval submission screen; no service call unless that screen requires it.

## Error handling expectations
- `400` validation errors (missing required inputs) â†’ show message.
- `403` forbidden â†’ show access error.
- `404` estimate/snapshot not found â†’ show not found.
- `409` invalid status or policy block (e.g., missing terms + FAIL) â†’ show specific message.
- `5xx` â†’ show generic failure with retry option.

---

# 10. State Model & Transitions

## Allowed states (Estimate)
- `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED` (per workexec approval workflow doc)

## Role-based transitions
- This story performs **no estimate status transition**.
- Generation of summary snapshot is allowed only when estimate is in `DRAFT` (per frontend requirement and backend reference; backend may also allow for `APPROVED` but that would contradict provided frontend triggerâ€”must clarify).

## UI behavior per state
- `DRAFT`: Customer Summary action visible/enabled.
- `APPROVED`/`DECLINED`/`EXPIRED`: action hidden or disabled; deep link shows 409 error message.

---

# 11. Alternate / Error Flows

## Validation failures
- Attempt generate summary when estimate not `DRAFT`:
  - UI shows blocking toast/dialog and does not navigate to summary.
- Missing legal terms:
  - If policy `FAIL`: generation returns error; UI shows compliance-block message.
  - If `USE_DEFAULTS`: generation succeeds; UI shows non-blocking banner â€œDefault terms appliedâ€ (only if backend indicates this condition via response metadata).

## Concurrency conflicts
- If estimate updated between detail view and summary generation:
  - Snapshot should capture at generation time; UI displays snapshot timestamp.
  - If backend returns `409` due to concurrent modification/version mismatch (if implemented): show â€œEstimate changed; please retry.â€

## Unauthorized access
- `403`: show access denied and provide navigation back to list.

## Empty states
- If estimate has zero items:
  - If backend blocks generation: show error from backend.
  - If backend allows: summary displays â€œNo line itemsâ€ and totals (likely zero). (Requires clarification; do not assume.)

---

# 12. Acceptance Criteria

## Scenario 1: Generate summary from Draft estimate (success)
Given I am authenticated as a Service Advisor  
And an Estimate exists with status `DRAFT` and at least one line item  
When I click â€œCustomer Summaryâ€ on the estimate  
Then the system creates an immutable estimate summary snapshot  
And I am shown a read-only customer-facing summary based on that snapshot  
And the displayed `grandTotal` equals the snapshotâ€™s `grandTotal`  
And the summary shows the snapshot timestamp.

## Scenario 2: Restricted internal fields are not shown
Given I am authenticated as a Service Advisor  
And an Estimate line item has internal cost/margin fields populated  
When I generate and view the customer-facing summary  
Then the summary does not display internal-only fields (e.g., itemCost, margin)  
And there is no UI control that reveals those fields.

## Scenario 3: Invalid estimate status blocks generation
Given I am authenticated  
And an Estimate exists with status `APPROVED`  
When I attempt to open â€œCustomer Summaryâ€ for that estimate  
Then the system responds with a `409` (or equivalent invalid-state error)  
And the UI displays â€œSummary can only be generated for Draft estimates.â€  
And no snapshot is created/persisted by the system.

## Scenario 4: Missing legal terms with FAIL policy blocks generation
Given I am authenticated as a Service Advisor  
And an Estimate exists with status `DRAFT`  
And the active missing-legal-terms policy is `FAIL`  
And legal terms are not configured for the applicable shop/location  
When I generate the customer-facing summary  
Then the system blocks generation and returns an error  
And the UI displays â€œCannot generate estimate summary: Legal terms and conditions not configuredâ€  
And the UI does not navigate to a summary view.

## Scenario 5: Missing legal terms with USE_DEFAULTS allows generation (with indication)
Given I am authenticated as a Service Advisor  
And an Estimate exists with status `DRAFT`  
And the active missing-legal-terms policy is `USE_DEFAULTS`  
And legal terms are not configured for the applicable shop/location  
When I generate the customer-facing summary  
Then the system generates the summary using default legal terms  
And the UI indicates that default terms were used (via banner or metadata)  
And the snapshot records `legalTermsSource = DEFAULT` (as visible in response metadata or audit view, if available).

---

# 13. Audit & Observability

## User-visible audit data
- Summary view shows:
  - `snapshotId`
  - `snapshotTimestamp`
  - (If provided) legal terms source/version and policy mode (read-only â€œSummary generated with configured/default termsâ€).

## Status history
- No estimate status history changes.
- Snapshot creation is an auditable event and should be viewable in an admin/audit context (not implemented here unless existing component).

## Traceability expectations
- Frontend passes/propagates correlation id if framework supports it (e.g., request header) and logs client-side errors with:
  - `estimateId`, `snapshotId` (if known), HTTP status, error code/message.

---

# 14. Non-Functional UI Requirements

- **Performance:** Summary generation should show loading state; if >2s, show spinner with â€œGenerating summaryâ€¦â€; allow retry on failure.
- **Accessibility:** All actions keyboard accessible; summary content readable with screen readers; print/download buttons have accessible labels.
- **Responsiveness:** Summary view usable on tablet (customer review) and desktop; printable layout should not clip totals/terms.
- **i18n/timezone/currency:** Display money using store currency formatting provided by backend or frontend locale settings; display expiration date and snapshot timestamp in shop-local timezone if provided, otherwise indicate timezone (requires clarification).

---

# 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a standard empty-state message on summary screen when no line items are present in returned payload; qualifies as safe because it does not change domain behavior, only presentation. Impacted sections: UX Summary, Alternate/Empty States.
- SD-UX-LOADING-STATE: Standard in-flight disabling and spinner for generate action; qualifies as safe because itâ€™s UI ergonomics only. Impacted sections: Functional Behavior, Non-Functional.
- SD-ERR-HTTP-MAP: Map 403/404/409/5xx to standard error UI patterns; qualifies as safe because itâ€™s generic error handling aligned to HTTP semantics. Impacted sections: Service Contracts, Error Flows.

---

# 16. Open Questions

1. **Backend endpoint contract:** What are the exact Moqui/backend endpoints for (a) generating the estimate summary snapshot and (b) retrieving the snapshot/rendered summary (HTML/PDF/data)?  
2. **Render format:** Should the frontend render from structured JSON (preferred for consistent UI), from server-rendered HTML, or via a PDF URL/download? Can multiple formats be supported?  
3. **Estimate status eligibility:** Is summary generation strictly limited to `DRAFT` only, or also allowed for `APPROVED` (backend reference includes invalid status for approved, but approval workflow allows approved estimates)? Confirm authoritative rule.  
4. **Missing legal terms policy source:** How does frontend determine applicable policy mode (`FAIL` vs `USE_DEFAULTS`)â€”is it embedded in the generation response only, or is there a readable configuration endpoint?  
5. **Visibility policy enforcement:** Will backend return already-filtered customer-facing payload, or must frontend apply a visibility policy definition? If frontend must apply it, what is the policy schema and source?  
6. **Taxes/fees breakdown:** Are fees a separate field (`feesTotal`) and are tax/fee line breakdowns required in the customer summary? The prompt says â€œtaxes, feesâ€ but the data list omits fee fields.  
7. **Expiration date semantics:** Is `expirationDate` stored on Estimate, derived from configuration, or both? What timezone should be used for display?  
8. **Zero-item estimates:** Should the system allow generating a summary when an estimate has zero line items, or should it block with validation?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Estimate: Present Estimate Summary for Review  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/234  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Estimate: Present Estimate Summary for Review

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor

## Trigger
A Draft estimate is ready to be reviewed with the customer before approval submission.

## Main Flow
1. User requests a customer-facing summary view/printout.
2. System generates a summary that includes scope, quantities, pricing, taxes, fees, and totals.
3. System excludes restricted internal fields (cost, margin) based on role/policy.
4. System includes configured terms, disclaimers, and expiration date.
5. User shares summary with customer and optionally proceeds to submit for approval.

## Alternate / Error Flows
- Terms/disclaimers not configured â†’ use defaults or block submission depending on compliance settings.

## Business Rules
- Customer summary must be consistent with the estimate snapshot.
- Visibility rules must be enforced for internal-only fields.
- Expiration must be clearly shown if configured.

## Data Requirements
- Entities: Estimate, EstimateItem, DocumentTemplate, VisibilityPolicy
- Fields: displayPrice, taxTotal, grandTotal, termsText, expirationDate, hiddenCostFields

## Acceptance Criteria
- [ ] Customer-facing summary is generated and matches estimate totals.
- [ ] Restricted fields are not displayed to unauthorized roles.
- [ ] Summary includes terms and expiration where configured.

## Notes for Agents
This output becomes the basis for consent text during approvalâ€”keep it deterministic.

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #235: [FRONTEND] [STORY] Estimate: Revise Estimate Prior to Approval  
File: ./scripts/story-work/frontend/235/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Estimate: Revise Estimate Prior to Approval (Versioned + Approval Invalidation)

### Primary Persona
Service Advisor

### Business Value
Ensure Service Advisors can correct or adjust a customer estimate before commitment while preserving immutable history, maintaining auditability, and preventing stale/invalid approvals from being used.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to â€œReviseâ€ an estimate by creating a new editable version linked to the prior version  
- **So that** I can adjust scope/pricing/notes before customer approval while the system preserves a full version history and invalidates any prior approvals tied to earlier versions.

### In-scope
- Revise action available on an estimate when in an allowed state (see **State Model**).
- Creating a new estimate version linked to the prior version (immutable prior version).
- Editing the new version (line items + terms/notes) and saving.
- Recalculation of totals on save (and optionally on edit, see safe defaults).
- Invalidation of prior approvals when revision occurs from an approval-pending context.
- Viewing revision/version history and comparing prior versions (read-only).

### Out-of-scope
- Creating or managing approval configurations (method selection) beyond displaying current method if present.
- Notifications (email/SMS) to customers about new revision.
- Converting estimate to work order.
- Change request workflow after conversion to work order (explicitly open question).
- Defining pricing/tax calculation logic (assumed backend-owned).

---

## 3. Actors & Stakeholders

- **Primary Actor:** Service Advisor (creates revisions, edits, submits)
- **Secondary Actors:**  
  - Shop Manager (read-only oversight of history)  
  - Auditor/Compliance (needs immutable trail)  
- **System Dependencies:** workexec backend services for estimates/versions/approvals; audit/event subsystem (backend).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated.
- User has permission to revise estimates (exact permission string is unknown; must be confirmed).
- Estimate exists and can be loaded by ID.
- Estimate is in a state that permits revision (must be confirmed against backend; see Open Questions).

### Dependencies
- Backend must support:
  - Creating a new estimate version/revision linked to a prior version.
  - Fetching current estimate and version history.
  - Persisting edits to the active version.
  - Invalidation of approvals tied to a previous version when revision is initiated from an approval-pending state.
- Moqui screens must be able to call these endpoints/services (exact Moqui service names/routes are not provided).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Estimate Detail screen: action button **Revise** (visible/enabled only in eligible states and with permission).
- From Estimate List: contextual action **Revise** (optional; if present, must follow same eligibility rules).

### Screens to create/modify
1. **`EstimateDetail.xml` (modify)**  
   - Add Revise action, version indicator (e.g., â€œv3â€), and link to â€œVersion Historyâ€.
2. **`EstimateRevise.xml` (new or modify existing edit screen)**  
   - Revision initiation confirmation + revision reason capture (if required by policy; see Open Questions).
   - Edit form for the new version (line items, notes/terms).
3. **`EstimateVersionHistory.xml` (new)**  
   - List versions with status, createdAt, createdBy, approval status.
   - View read-only prior version details.
   - Compare two versions (minimal: show side-by-side summary; details in functional behavior).

### Navigation context
- Route pattern (example; confirm actual project conventions):
  - `/estimates/:estimateId` â†’ Estimate detail
  - `/estimates/:estimateId/revise` â†’ Revision workflow (creates new version then opens editor)
  - `/estimates/:estimateId/history` â†’ Version history

### User workflows
- **Happy path**
  1. Advisor opens Estimate Detail (current version visible).
  2. Clicks **Revise**.
  3. Confirms and (optionally) enters revision reason.
  4. System creates new version, marks it active, and navigates to edit screen.
  5. Advisor edits items/notes and saves.
  6. Totals are recalculated; save succeeds; advisor returns to Estimate Detail showing new version.
- **Alternate paths**
  - User cancels before confirming revision: no new version created.
  - User confirms revision, then cancels edits: behavior depends on backend (discard draft version vs keep as draft). This is an Open Question and must be confirmed.
  - Attempt revise in non-eligible state: action disabled or blocked with error.

---

## 6. Functional Behavior

### Triggers
- User clicks **Revise** on Estimate Detail.

### UI actions
- **Revise click**
  - Client requests latest estimate state (to avoid stale UI).
  - If eligible, show confirmation modal:
    - Summary: current version number, status, and warning that revision preserves history and may invalidate approvals.
    - Input: revision reason (only if required).
    - Actions: Confirm / Cancel.
- **Confirm**
  - Call backend to create a new version/revision record.
  - On success: navigate to edit screen for the new active version.
- **Edit**
  - Allow modifying line items (add/remove/edit qty/price if allowed), notes/terms.
  - Save triggers backend update and totals recalculation.
- **Version history**
  - List all versions; allow opening prior version read-only.
  - Compare: user selects two versions â†’ show differences (at minimum totals + line items changed).

### State changes (frontend-visible)
- On successful revision initiation:
  - Active version becomes the newly created version with status per policy (likely `DRAFT`).
  - Prior version becomes immutable and may display as `ARCHIVED` or equivalent (backend-defined).
- If revision initiated from a â€œpending approvalâ€ context:
  - Prior approval(s) for the previous version become invalidated (backend-owned state).

### Service interactions
- Load estimate + current active version.
- Create revision (new version).
- Update version (save edits).
- Load version history + retrieve specific prior version.
- (Optional) Load compare diff if backend provides; otherwise compute diff client-side from two loaded versions.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Revise action allowed only when estimate is in eligible state(s). UI must:
  - Hide/disable Revise when not eligible.
  - Still handle backend denial gracefully (409/400) if state changed concurrently.
- Revision must preserve history:
  - UI must treat prior versions as read-only (no edit controls when viewing older versions).
- Any revision after approval invalidates approval:
  - If estimate is in an approval-pending state, show a warning in confirmation modal.
  - After revision creation, UI should display a banner on the new version: â€œPrior approval invalidated; new approval requiredâ€ (wording not domain-policy; can be generic).

### Enable/disable rules
- Disable â€œSaveâ€ if required fields missing (e.g., empty line item qty) based on backend validation responses (since exact field-level requirements arenâ€™t fully specified).
- Disable â€œConfirm Reviseâ€ while request is in-flight to prevent double-submit.

### Visibility rules
- Version history tab/link visible to users with view permission; if permission unknown, default to same permission as estimate view.
- Show version number and status prominently on detail and edit screens.

### Error messaging expectations
- Permission denied: â€œYou do not have permission to revise this estimate.â€
- Invalid state: â€œThis estimate cannot be revised in its current state.â€
- Concurrency: â€œThis estimate changed since you opened it. Reload and try again.â€
- Generic failure: â€œUnable to revise estimate. Please try again or contact support.â€

---

## 8. Data Requirements

> Note: Backend entity model in provided inputs conflicts/varies (Estimate vs EstimateVersion vs EstimateRevision). Frontend must rely on API responses. Fields below are â€œfrontend required fieldsâ€ for display and form binding; exact schema must be confirmed.

### Entities involved (conceptual)
- `Estimate`
- `EstimateVersion` (or `EstimateRevision`)
- `ApprovalRecord` (for invalidation/visibility)
- `AuditEvent` (read-only display of revision metadata, if exposed)

### Fields
#### Estimate (read)
- `estimateId` (string/number, required)
- `customerId` (string/number, required for display link)
- `vehicleId` (string/number, optional display)
- `shopId/locationId` (string/number, optional display)
- `activeVersionId` (string/number, required if versioned model)
- `status` (enum/string, required) **(state name must be confirmed)**
- `createdAt` (datetime, read-only)

#### Estimate Version / Revision (read/write on active version)
- `estimateVersionId` (id, read-only)
- `versionNumber` (int, read-only)
- `status` (enum/string, read-only in UI except via transitions)
- `priorVersionId` (id, read-only)
- `revisionReason` (string, required? Open Question)
- `revisedBy/createdBy` (user id/name, read-only)
- `revisedAt/createdAt` (datetime, read-only)
- `lineItems[]` (collection, editable)
  - `lineItemId` (id, read-only)
  - `type` (PART|LABOR|FEE?) (enum, required) **unknown**
  - `description` (string, required)
  - `productId/serviceId` (id, optional depending on type)
  - `quantity` (decimal, required, >0)
  - `unitPrice` (money/decimal, editable only if permitted)
  - `declined` (bool, optional per approval workflow; default false)
- `notes` / `terms` (string, editable)
- `totals` (object, read-only; calculated)
  - `subtotal`, `tax`, `fees`, `grandTotal` (money/decimal)

### Read-only vs editable by state/role
- Prior versions: all fields read-only.
- Active draft version: editable fields include lineItems and notes/terms; price override fields editable only if user has permission (permission string unknown â†’ Open Question).

### Derived/calculated fields
- Totals are calculated by backend; UI displays returned totals and does not compute tax/fees authoritatively.

---

## 9. Service Contracts (Frontend Perspective)

> Exact Moqui service names/endpoints for frontend are not provided in inputs. The backend reference provides REST endpoints for estimate approve/decline/reopen but not revise/versioning. This is blocking for a truly buildable story; contracts below define required capabilities and expected HTTP semantics.

### Load/view calls
- `GET /api/estimates/{estimateId}`  
  - Returns estimate with current active version summary (must include active version id/number and status).
- `GET /api/estimates/{estimateId}/versions` (or similar)  
  - Returns list of versions with metadata.
- `GET /api/estimates/{estimateId}/versions/{versionId}`  
  - Returns read-only version details.

### Create/update calls
- **Create revision/version**
  - `POST /api/estimates/{estimateId}/revise` (proposed)
  - Request:
    - `requestedBy` (userId) (if backend requires; otherwise derived from auth)
    - `revisionReason` (optional/required per policy)
  - Response: new active version details (`versionId`, `versionNumber`, status)
  - Status: `201 Created`
- **Update active version**
  - `PUT /api/estimates/{estimateId}/versions/{versionId}` (proposed) or `PUT /api/estimates/{estimateId}` if backend uses active version
  - Request: updated line items + notes/terms
  - Response: updated version + recalculated totals
  - Status: `200 OK`

### Submit/transition calls
- None beyond revision initiation in this story (approval submission is separate story).

### Error handling expectations
- `400 Bad Request`: validation errors (return field-level errors)
- `401 Unauthorized`: login required
- `403 Forbidden`: no permission (revise or price override)
- `404 Not Found`: estimate/version not found
- `409 Conflict`: invalid state due to concurrent changes, or attempting to revise non-revisable status
- UI must map these to user-friendly messages and preserve form state where possible.

---

## 10. State Model & Transitions

### Allowed states (must be confirmed)
Provided domain doc `CUSTOMER_APPROVAL_WORKFLOW.md` defines:
- `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`

But story inputs mention â€œPendingApprovalâ€, and backend reference story used â€œArchived/ConvertedToWorkOrderâ€ which conflicts with authoritative approval workflow doc.

**Therefore: state model for â€œrevision eligibilityâ€ is blocked until clarified.**

### Required transition behavior (frontend)
- If estimate is in eligible state (at least `DRAFT`; possibly also `APPROVED` depending on policy), Revise is available.
- If estimate is in any non-eligible or terminal state, Revise is disabled and backend denial handled.

### Role-based transitions
- Service Advisor can initiate revision if authorized.
- Others (e.g., technician) likely view-only; exact RBAC not specified (Open Question).

### UI behavior per state (minimum)
- `DRAFT`: Revise available (creates new version).
- Approval-pending state (name TBD): Revise available but warns that approval will be invalidated.
- `APPROVED`: policy unclear whether revise is allowed; must be confirmed.
- `DECLINED`/`EXPIRED`: unclear (reopen exists, but revise semantics unclear); must be confirmed.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required revision reason (if required): block confirm and show inline error.
- Invalid line item quantity/unit price: show inline error from backend response; do not lose user edits.

### Concurrency conflicts
- If estimate status/version changes between load and revise:
  - Backend returns `409 Conflict`.
  - UI shows â€œEstimate changed; reloadâ€ with a reload action.
- If user double-clicks Revise:
  - UI disables confirm during in-flight call and treats backend idempotently if supported; otherwise show single created version.

### Unauthorized access
- If user lacks revise permission:
  - Revise button hidden or disabled.
  - If direct navigation to `/revise`, show Access Denied and link back.

### Empty states
- Version history empty (should not happen if v1 exists): show â€œNo versions foundâ€ and provide reload.
- Compare without selecting two versions: disable compare action and explain requirement.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Revise a Draft estimate creates a new version and opens it for editing
**Given** an estimate exists with status `DRAFT` and current version number `1`  
**And** I am logged in as a Service Advisor with permission to revise estimates  
**When** I open the estimate detail screen and click **Revise** and confirm  
**Then** the system creates a new estimate version linked to version `1`  
**And** the UI navigates to the edit screen for the new version  
**And** the UI shows the new version number `2` and status `DRAFT` (or backend-provided editable status)

### Scenario 2: Saving edits recalculates totals and persists changes
**Given** I have created a new revised version of an estimate  
**When** I change a line item quantity and click **Save**  
**Then** the system persists the updated version  
**And** the UI displays recalculated totals returned by the backend  
**And** the updated version remains the active version on the estimate detail screen

### Scenario 3: Revising from an approval-pending context invalidates prior approval
**Given** an estimate exists in an approval-pending state (state name per backend) with an outstanding approval record  
**When** I click **Revise** and confirm  
**Then** the system creates a new version in an editable state  
**And** the system invalidates the outstanding approval tied to the previous version  
**And** the UI displays an indicator that prior approval is no longer valid for the new version

### Scenario 4: Attempting to revise in a non-eligible state is blocked
**Given** an estimate exists in a non-revisable state (e.g., converted to work order or terminal state per policy)  
**When** I attempt to revise the estimate  
**Then** the UI prevents the action (Revise disabled) **or** the backend returns an error  
**And** the UI shows a clear message explaining why revision is not allowed

### Scenario 5: Permission denied when revising
**Given** I am logged in as a user without permission to revise estimates  
**When** I navigate to an estimate and attempt to revise it  
**Then** the system returns `403 Forbidden`  
**And** the UI shows â€œAccess Deniedâ€ and does not create a new version

### Scenario 6: Concurrency conflict during revision initiation
**Given** I have an estimate detail screen open  
**And** another user changes the estimate status so it is no longer revisable  
**When** I click **Revise** and confirm  
**Then** the backend returns `409 Conflict`  
**And** the UI prompts me to reload the estimate and try again  
**And** no new version is shown as active in the UI

### Scenario 7: Version history shows prior versions as read-only
**Given** an estimate has versions `1`, `2`, and `3` and version `3` is active  
**When** I open Version History and select version `1`  
**Then** the UI displays version `1` in read-only mode  
**And** editing controls are not available for version `1`  
**And** I can return to the active version `3`

---

## 13. Audit & Observability

### User-visible audit data
- On Version History list, show:
  - versionNumber, createdAt, createdBy
  - status
  - â€œRevision reasonâ€ if captured/stored and exposed
  - approval invalidation indicator if applicable (e.g., â€œApproval invalidatedâ€ badge)

### Status history
- Version status is displayed per version.
- If backend exposes revision events/audit events, show a simple event log section (optional; do not block).

### Traceability expectations
- UI must include estimateId and versionId in log context (frontend console logs kept minimal).
- For API calls, include correlation/trace id header if project convention supports it (safe default only if already in repo conventions; otherwise Open Question).

---

## 14. Non-Functional UI Requirements

- **Performance:**  
  - Version history list should load within 2s under normal conditions; paginate if large (safe default).
- **Accessibility:**  
  - Revise confirmation modal must be keyboard navigable; buttons have accessible labels.
- **Responsiveness:**  
  - Works on tablet form factor (service counter usage).
- **i18n/timezone/currency:**  
  - Display dates in shop/user timezone if available; otherwise ISO/local browser (needs repo convention).  
  - Currency formatting uses backend-provided currency code if present; otherwise shop default (Open Question if not provided).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide clear empty-state messaging and reload action for Version History when no data is returned; qualifies as safe UI ergonomics; impacts UX Summary, Error Flows.
- SD-UX-PAGINATION-01: Paginate Version History list after 25 items with server-side parameters if supported; safe for ergonomics and performance; impacts UX Summary, Service Contracts.
- SD-ERR-MAP-01: Map HTTP 400/401/403/404/409/5xx to consistent toast/banner messages and preserve form state on 400; safe standard error handling; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Estimate states & revision eligibility:** What are the authoritative estimate statuses in this system for the frontend (is there a `PENDING_APPROVAL` state, or only `DRAFT/APPROVED/DECLINED/EXPIRED`)? In which exact states is â€œReviseâ€ permitted?
2. **Revision after APPROVED / Converted-to-WorkOrder policy:** If an estimate is already `APPROVED` and/or converted to a work order, is revision:
   - disallowed, or
   - allowed but creates a new version requiring re-approval, or
   - redirected into Change Request workflow?
3. **Revision reason requirement:** Is `revisionReason` required on revise initiation? If yes, is there a reason code list or free text only?
4. **Abandon revision semantics:** If a new version is created on â€œConfirm Reviseâ€ but the advisor cancels without saving edits, should the system:
   - discard/delete the new version, or
   - keep it as the active draft version?
5. **API contract for versioning:** What are the exact backend endpoints and payloads for:
   - creating a revision/version,
   - listing versions,
   - loading a specific version,
   - saving edits to the active version?
6. **Permissions/RBAC strings:** What permission(s) control:
   - ability to revise,
   - ability to edit line items,
   - ability to override prices (and whether a reason code is required)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Estimate: Revise Estimate Prior to Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/235  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Estimate: Revise Estimate Prior to Approval

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor

## Trigger
A Draft or PendingApproval estimate requires changes (scope, price, quantities, fees, or notes).

## Main Flow
1. User opens the estimate and selects 'Revise'.
2. System creates a new estimate version (or revision record) linked to the prior version.
3. User edits line items and/or terms.
4. System recalculates totals and updates revision metadata.
5. System invalidates any prior approvals and sets state back to Draft (or Revision state) per policy.

## Alternate / Error Flows
- Estimate is already promoted to workorder â†’ disallow revision or create a change request workflow (policy).
- User lacks permission to revise after approval submission â†’ block and log.

## Business Rules
- Revision must preserve history and allow comparing versions.
- Any revision after approval invalidates approval.
- Revision increments version and records who/when/why.

## Data Requirements
- Entities: Estimate, EstimateRevision, ApprovalRecord, AuditEvent
- Fields: estimateId, version, status, revisionReason, revisedBy, revisedDate, priorVersionRef

## Acceptance Criteria
- [ ] System preserves revision history and allows retrieving prior versions.
- [ ] Any existing approval is invalidated on revision and recorded.
- [ ] Revised estimate totals are recalculated and stored.

## Notes for Agents
Revision history is a core audit artifactâ€”do not overwrite approved snapshots.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #236: [FRONTEND] [STORY] Estimate: Calculate Taxes and Totals on Estimate  
File: ./scripts/story-work/frontend/236/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:story-authoring
- agent:workexec

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Estimate: Calculate Taxes and Totals on Estimate

### Primary Persona
Service Advisor (POS user) viewing and editing an Estimate

### Business Value
Ensure estimates always display accurate, up-to-date subtotal, taxes, fees, discounts, and grand total with an auditable calculation snapshot, preventing approval when required tax configuration is missing.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** estimate totals (subtotal, taxes, fees, discounts, grand total) to recalculate automatically whenever estimate line items change,  
**so that** I can confidently present correct pricing to customers and the system can retain a reproducible calculation snapshot for disputes and downstream processes.

### In-Scope
- Frontend behavior to trigger totals/tax recalculation when estimate line items are created/modified (parts/labor/fees/discounts).
- Display of calculated totals and per-line tax/taxability feedback as returned by backend.
- Display and navigation to view the latest **Calculation Snapshot** (read-only) associated to the estimate.
- Frontend blocking behavior to prevent proceeding to â€œApprovalâ€ (or equivalent) when backend indicates missing required tax configuration (per policy and error codes).
- Clear error states for missing tax code / missing jurisdiction configuration.

### Out-of-Scope
- Implementing the tax/fee/discount calculation logic itself (owned by backend pricing/tax services).
- Creating or editing TaxRule/FeeRule configuration.
- Defining rounding policy, default tax code policy, or tax-inclusive vs tax-exclusive behavior (must be provided by backend contract/policy).
- Invoice generation/accounting posting.

---

## 3. Actors & Stakeholders
- **Primary User Actor:** Service Advisor
- **System Actor:** Pricing/Tax calculation service (invoked via Moqui service calls from frontend screens)
- **Stakeholders:**
  - Store Manager (needs reliable totals before approval)
  - Accounting/Audit stakeholders (need snapshot traceability)
  - Workexec domain owners (estimate lifecycle and transitions)

---

## 4. Preconditions & Dependencies

### Preconditions
- An Estimate exists and is open in a mutable state (e.g., Draft).
- Estimate has a location/jurisdiction context (directly or indirectly via location on the estimate).
- Estimate has 0..N line items.

### Dependencies (Blocking if undefined)
- A backend endpoint/service to â€œcalculate totalsâ€ for an estimate and return:
  - Updated totals (subtotal, taxTotal, feeTotal, discountTotal, grandTotal, roundingAdjustment)
  - Per-line tax info (at minimum taxAmount and/or taxCode/taxability result)
  - A `calculationSnapshotId` (or equivalent) for audit
  - Deterministic error codes for missing configuration (e.g., `ERR_CONFIG_JURISDICTION_MISSING`, `ERR_MISSING_TAX_CODE`)
- A backend read endpoint/service to load calculation snapshot details for display.
- Estimate state transition endpoint/service for â€œProceed to Approvalâ€ (or equivalent) that will fail if tax configuration is missing.

---

## 5. UX Summary (Moqui-Oriented)

### Entry Points
- From Estimate detail screen where line items are added/edited (parts/labor/fees/discounts).
- From Estimate totals panel/summary section.

### Screens to Create/Modify
1. **Modify:** `EstimateDetail` screen (existing)
   - Add/extend totals summary panel to show:
     - Subtotal
     - Discount total
     - Fee total
     - Tax total
     - Rounding adjustment (if non-zero or always visible per design)
     - Grand total
     - â€œLast calculated atâ€ timestamp (if provided) and â€œSnapshot IDâ€ link
   - Hook line item create/update/delete actions to trigger recalculation.
2. **Create or Modify:** `EstimateCalculationSnapshotView` screen (new or existing)
   - Read-only view of the latest snapshot associated with the estimate (and optionally historical snapshots if backend supports).
   - Shows inputs and outputs sufficient for audit (â€œpersist enough context to explain totals laterâ€).

### Navigation Context
- `EstimateDetail` includes a link/button â€œView Calculation Detailsâ€ which routes to `EstimateCalculationSnapshotView?estimateId=...&snapshotId=...`.

### User Workflows
#### Happy Path
1. User adds/edits/removes a line item.
2. UI saves the line item change.
3. UI triggers totals recalculation.
4. UI refreshes totals and displays new values + snapshot link.

#### Alternate Paths
- User changes multiple line items quickly â†’ UI queues/debounces recalculation and shows â€œRecalculatingâ€¦â€ state.
- Backend returns a configuration error â†’ UI shows a blocking banner and disables â€œProceed to Approvalâ€.

---

## 6. Functional Behavior

### Triggers
- After successful create/update/delete of any Estimate line item (parts/labor/fees/discounts), trigger a totals recalculation for that estimate.
- On initial load of `EstimateDetail`, load and display current totals and the latest snapshot reference (if any).

### UI Actions
- Line item form submit (create/update) â†’ save â†’ recalc â†’ update totals panel.
- Line item delete â†’ confirm â†’ delete â†’ recalc â†’ update totals panel.
- â€œProceed to Approvalâ€ action:
  - Calls the estimate transition/submit service.
  - If backend indicates missing tax config, show actionable error and remain in current state.

### State Changes (Frontend-visible)
- Totals panel transitions:
  - `idle` â†’ `recalculating` â†’ `updated`
  - `recalculating` â†’ `error` (with error banner and resolution hints)
- Estimate â€œapproval readinessâ€ indicator:
  - `ready` when no blocking tax/config errors are present
  - `blocked` when backend returns missing config errors

### Service Interactions
- After line item change: call backend â€œcalculate totalsâ€ service with `estimateId`.
- After calculation: refresh estimate view model with returned totals and snapshot id.
- Snapshot view: call backend â€œget snapshot detailsâ€ service by `snapshotId` (and/or `estimateId`).

---

## 7. Business Rules (Translated to UI Behavior)

> Note: Monetary/tax logic is authoritative in backend; frontend must enforce **workflow and validation messaging** based on backend responses.

### Validation
- Line item edits must not be considered â€œcompleteâ€ until recalculation succeeds OR the UI clearly marks totals as â€œstaleâ€ (see Open Questions).
- If backend returns `ERR_CONFIG_JURISDICTION_MISSING`:
  - UI must display a blocking error (banner) stating tax configuration is missing for the estimateâ€™s jurisdiction/location.
  - UI must disable/hide â€œProceed to Approvalâ€ action (or allow click but show blocking modal) until resolved.
- If backend returns `ERR_MISSING_TAX_CODE` (or equivalent):
  - UI behavior depends on policy (default tax code vs fail). Must be clarified; until then treat as blocking error.

### Enable/Disable Rules
- Disable â€œProceed to Approvalâ€ when:
  - Latest calculation attempt failed due to missing tax configuration.
  - Calculation is currently in progress (prevent approving while totals are being recomputed).
- Disable â€œView Calculation Detailsâ€ when no `calculationSnapshotId` is available.

### Visibility Rules
- Show â€œRounding adjustmentâ€ row only if non-zero **unless** backend/UX requires always visible (Open Question).
- Show per-line tax amount only when backend provides it (do not derive).

### Error Messaging Expectations
- Errors must display:
  - A concise title
  - The backend-provided error code
  - User action guidance (e.g., â€œContact admin to configure tax jurisdiction for location Xâ€)
- Do not expose stack traces or sensitive details.

---

## 8. Data Requirements

### Entities Involved (Frontend-consumed)
- `Estimate`
- `EstimateItem` (parts/labor/fees/discounts)
- `CalculationSnapshot` (read-only view)
- (Referenced configuration entities like `TaxRule`, `FeeRule` are not edited here)

### Fields (Type, Required, Defaults)
#### Estimate (view model)
- `estimateId` (UUID, required)
- `locationId` (UUID, required for tax jurisdiction context; source may be implicit)
- `subtotal` (DECIMAL(19,4), required display)
- `taxTotal` (DECIMAL(19,4), required display)
- `feeTotal` (DECIMAL(19,4), required display)
- `discountTotal` (DECIMAL(19,4), required display)
- `roundingAdjustment` (DECIMAL(19,4), optional display)
- `grandTotal` (DECIMAL(19,4), required display)
- `calculationSnapshotId` (UUID, optional)
- `totalsCalculatedAt` (datetime, optional; only if backend provides)

#### EstimateItem (minimum for triggering calc and display)
- `estimateItemId` (UUID, required)
- `itemType` (enum: PART|LABOR|FEE|DISCOUNT, required)
- `quantity` (DECIMAL, required)
- `unitPrice` (DECIMAL(19,4), required)
- `taxCode` (string, optional/required depends on policy)
- `taxAmount` (DECIMAL(19,4), optionalâ€”backend-derived)
- `isTaxable` (boolean, optionalâ€”backend-derived)

#### CalculationSnapshot (read-only)
- `snapshotId` (UUID, required)
- `estimateId` (UUID, required)
- `calculationTimestamp` (datetime, required)
- `inputLineItems` (structured/JSON, required)
- `appliedRules` (structured/JSON, required)
- `outputSubtotal`, `outputTaxTotal`, `outputFeeTotal`, `outputDiscountTotal`, `outputGrandTotal`, `outputRoundingAdjustment` (DECIMAL(19,4), required)

### Read-only vs Editable by State/Role
- All totals fields are **read-only** in UI (backend-calculated).
- Calculation snapshot is **read-only**.
- Line items editable only in estimate mutable states (exact states depend on workexec lifecycle; see Open Questions).

### Derived/Calculated Fields
- All totals and tax amounts are derived from backend calculation results; frontend must not compute.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui naming is provisional; exact service names/paths must align to backend integration.

### Load/View Calls
- `Estimate.get` (or screen auto-load) by `estimateId` returns estimate header, line items, and latest totals + snapshot reference.
- `CalculationSnapshot.get` by `snapshotId` returns snapshot detail for display.

### Create/Update Calls
- `EstimateItem.create/update/delete` (existing workexec services)
  - On success, frontend triggers recalc.

### Submit/Transition Calls
- `Estimate.calculateTotals` (pricing integration)
  - Request: `{ estimateId }`
  - Response: totals + `calculationSnapshotId` + optional per-line tax breakdown + `totalsCalculatedAt`
  - Errors:
    - `ERR_CONFIG_JURISDICTION_MISSING` (blocking)
    - `ERR_MISSING_TAX_CODE` (policy-dependent)
    - generic validation errors (400)
- `Estimate.proceedToApproval` (workexec transition)
  - Must fail if totals invalid/missing config; frontend surfaces error.

### Error Handling Expectations
- Map backend error codes to:
  - blocking banner for config errors
  - inline form errors for line item validation errors (quantity, price, etc.)
- Preserve and display correlation/request id if returned in headers/body (for support).

---

## 10. State Model & Transitions

### Allowed States (Estimate)
- Must be confirmed from workexec domain; minimally:
  - `DRAFT` (editable, recalculation allowed)
  - `APPROVAL_PENDING` / `SUBMITTED` (transition target)
  - Other states (APPROVED, CANCELLED, etc.) are unknown here

### Role-based Transitions
- Service Advisor can trigger â€œProceed to Approvalâ€ from editable state(s) only.
- If user lacks permission, UI must hide/disable the action and show â€œnot authorizedâ€ on direct access.

### UI Behavior per State
- Editable states: line items editable; recalculation auto-triggers.
- Non-editable states: line items read-only; totals read-only; snapshot view remains accessible.

---

## 11. Alternate / Error Flows

### Validation Failures
- Invalid line item data (e.g., negative quantity/unitPrice) returned by backend:
  - Keep user on line item edit form
  - Show field-level errors if provided; otherwise show banner with message.

### Concurrency Conflicts
- If line items were updated elsewhere and recalc returns conflict (409):
  - Prompt user to reload estimate
  - Provide â€œReloadâ€ action that refreshes estimate + line items + totals.

### Unauthorized Access
- If calculation or snapshot endpoints return 401/403:
  - Redirect to login (401) or show not-authorized screen (403)
  - Do not leak details of tax configuration.

### Empty States
- Estimate with zero line items:
  - Totals display as zero amounts (as returned by backend) or show â€œNo items yetâ€ and hide snapshot link.
  - No recalculation triggered unless backend requires it on load.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Totals recalculate after adding a taxable part line
**Given** an Estimate in an editable state is open in the Estimate Detail screen  
**When** the user adds a new PART line item and saves successfully  
**Then** the UI triggers a totals calculation for that estimate  
**And** the totals panel updates to display the returned subtotal, tax total, fee total, discount total, and grand total  
**And** the UI displays a link to the returned calculation snapshot id

### Scenario 2: Totals recalculate after modifying an existing labor line
**Given** an Estimate with existing line items is open  
**When** the user edits a LABOR line item and saves successfully  
**Then** the UI triggers a totals calculation  
**And** the totals panel reflects the updated totals returned by the backend

### Scenario 3: Mixed taxable and non-taxable items display updated totals
**Given** an Estimate contains a taxable PART line and a non-taxable LABOR line (as determined by backend tax rules)  
**When** the user triggers recalculation by editing either line item  
**Then** the UI displays the tax total returned by the backend consistent with only the taxable line being taxed  
**And** the UI does not compute or override tax values locally

### Scenario 4: Missing jurisdiction configuration blocks approval
**Given** an Estimate is associated with a location/jurisdiction with no configured tax rules  
**When** the user adds or edits a line item causing recalculation  
**And** the backend responds with error code `ERR_CONFIG_JURISDICTION_MISSING`  
**Then** the UI shows a blocking banner indicating tax configuration is missing  
**And** the â€œProceed to Approvalâ€ action is disabled (or blocked) with a clear reason  
**And** the user can remain on the estimate and continue editing line items but cannot proceed to approval

### Scenario 5: Calculation snapshot is viewable and read-only
**Given** an Estimate has a `calculationSnapshotId` displayed  
**When** the user selects â€œView Calculation Detailsâ€  
**Then** the system navigates to the snapshot view screen  
**And** the snapshot screen loads and displays calculation timestamp, inputs, applied rules, and output totals as read-only data

### Scenario 6: Missing tax code handling is surfaced (policy-dependent)
**Given** a line item requires a tax code but none is present  
**When** recalculation is triggered  
**Then** if the backend rejects with `ERR_MISSING_TAX_CODE`, the UI shows a blocking error message including the error code  
**And** the UI indicates which line(s) require attention if backend provides per-line details

---

## 13. Audit & Observability

### User-visible audit data
- Display `calculationSnapshotId` and `totalsCalculatedAt` (if provided) on `EstimateDetail`.
- Snapshot view provides read-only breakdown sufficient for disputes (â€œexplain totals laterâ€).

### Status history
- If backend provides a list/history of snapshots, show them in chronological order; otherwise show latest only.

### Traceability expectations
- Every successful recalculation must result in a snapshot id stored/returned and displayed.
- Frontend logs (console/network) must not include sensitive details; rely on correlation id for support.

---

## 14. Non-Functional UI Requirements

- **Performance:** Recalculation request should not block UI interactions; show loading state in totals panel. Avoid multiple concurrent recalculation calls (debounce/serialize).
- **Accessibility:** Error banners and disabled actions must be screen-reader accessible (aria-live for calculation errors; clear button labels).
- **Responsiveness:** Totals panel and snapshot view must render on tablet and desktop layouts.
- **i18n/timezone/currency:** Display monetary values using currency formatting provided by app conventions; do not assume currency code if not supplied (Open Question). Dates/times displayed in user locale/timezone if available.

---

## 15. Applied Safe Defaults
- SD-UX-1 (Empty State): Show â€œNo items yetâ€ and zeroed totals when estimate has no line items; safe as itâ€™s purely presentational and does not change domain logic. Impacted sections: UX Summary, Alternate/Empty States.
- SD-UX-2 (Debounce/Serialize Requests): Debounce recalculation to avoid concurrent calls during rapid edits; safe as it only reduces duplicate requests and does not change calculation logic. Impacted sections: Functional Behavior, Non-Functional Performance.
- SD-ERR-1 (Standard Error Mapping): Map 401â†’login, 403â†’not authorized, 409â†’reload prompt, 5xxâ†’generic retry banner; safe as itâ€™s standard transport-level handling. Impacted sections: Error Flows, Service Contracts.

---

## 16. Open Questions

1. **Backend contract details (blocking):** What are the exact Moqui service names/REST endpoints and response schemas for:
   - calculate totals for estimate
   - load calculation snapshot details
   - estimate approval transition/submit  
   (Need error code list and how per-line tax details are returned.)

2. **Missing tax code policy (blocking):** For taxable items without a tax code, is the policy:
   - fail calculation (`ERR_MISSING_TAX_CODE`) or
   - apply a configured default tax code and proceed (and how is this flagged in UI/audit)?

3. **Tax-inclusive vs tax-exclusive (blocking):** Which modes must the frontend support now, and how does backend indicate the mode for an estimate/location?

4. **Line-level vs header-level taxes (blocking):** Will backend return line-level tax amounts, header-level only, or both? What should the UI display per line item?

5. **Estimate lifecycle states (blocking):** What are the exact editable vs non-editable estimate states and the exact transition name for â€œProceed to Approvalâ€ in Moqui/workexec?

6. **Currency & formatting (blocking if multi-currency):** Is currency always implied by location/company, or must totals include an explicit currency code to display?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Estimate: Calculate Taxes and Totals on Estimate  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/236  
Labels: frontend, story-implementation, general

## Frontend Implementation for Story

**Original Story**: [STORY] Estimate: Calculate Taxes and Totals on Estimate

**Domain**: general

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
System

## Trigger
Estimate line items are created or modified (parts/labor/fees/discounts).

## Main Flow
1. System identifies taxable basis per line item using tax codes and jurisdiction.
2. System calculates line-level and/or header-level taxes per configuration.
3. System applies discounts, fees (shop supplies, environmental), and rounding rules.
4. System updates estimate subtotal, tax total, and grand total.
5. System records calculation snapshot (inputs and outputs) for audit/reproducibility.

## Alternate / Error Flows
- Missing tax code on an item â†’ apply default tax code or block based on policy.
- Tax region not configured â†’ block submission for approval and surface configuration error.

## Business Rules
- Tax rules may vary by item type (parts vs labor vs fees).
- Support tax-inclusive and tax-exclusive modes.
- Persist enough calculation context to explain totals later (disputes).

## Data Requirements
- Entities: Estimate, EstimateItem, TaxRule, FeeRule, CalculationSnapshot
- Fields: taxCode, taxRate, taxAmount, subtotal, discountTotal, feeTotal, grandTotal, roundingAdjustment

## Acceptance Criteria
- [ ] Totals and taxes update correctly for mixed taxable/non-taxable items.
- [ ] System stores a calculation snapshot that can be reviewed.
- [ ] Estimate cannot proceed to approval if required tax configuration is missing (per policy).

## Notes for Agents
Ensure calculation snapshots can be reused during promotion/invoice variance explanations.

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #237: [FRONTEND] [STORY] Estimate: Add Labor to Estimate  
File: ./scripts/story-work/frontend/237/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Estimate: Add Labor to Draft Estimate (Catalog + Optional Custom)

**Primary Persona:** Service Advisor

**Business Value:** Enables accurate, auditable quoting of labor/services on a draft estimate with deterministic labor-rate defaulting and immediate total recalculation, reducing quoting time and pricing errors.

---

## 2. Story Intent

**As a** Service Advisor  
**I want** to add labor/service line items to a Draft estimate by selecting from the service catalog (and optionally adding a custom labor line when allowed)  
**So that** the estimate reflects accurate labor charges and totals before customer approval.

### In-scope
- Add **catalog labor/service** line item(s) to an **Estimate in DRAFT** status.
- Search and select a **Service Catalog** entry by code or description.
- Capture **labor units** for time-based services OR select a **flat-rate** service.
- Default **labor rate** deterministically via backend/pricing rules and display it on the line.
- Add optional **notes/instructions** at line-item level.
- Trigger and display **recalculated totals** after adding a labor line.
- Controlled **custom labor** entry path **only if enabled** by policy/config (backend-driven).

### Out-of-scope
- Creating/editing the underlying Service Catalog.
- Defining pricing rule hierarchy / labor-rate policy (must be provided by backend).
- Editing/removing existing labor lines (unless already supported elsewhere).
- Customer approval capture flows and estimate state transitions (approve/decline/reopen).
- Any billing/payroll implications of labor time (domain clarification required if introduced later).

---

## 3. Actors & Stakeholders
- **Primary actor:** Service Advisor
- **Secondary actors:** None
- **Stakeholders:**
  - Workexec domain owners (estimate workflow + line items)
  - Pricing domain owners (labor rate determination)
  - Audit/Compliance (traceability of estimate financial changes)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated and authorized to edit estimates.
- An **Estimate** exists and is in **status = DRAFT**.
- Service Catalog is accessible for searching.

### Dependencies (blocking if absent)
- Backend endpoints (or Moqui services) must exist for:
  - Loading estimate details including status and current items/totals
  - Searching Service Catalog
  - Adding a labor estimate item (catalog and optionally custom)
  - Returning recalculated totals and updated line list

### Non-blocking but important
- Backend provides/derives tax code behavior for labor items (if required for totals).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Estimate Detail** screen for an estimate in DRAFT status: action **â€œAdd Labor/Serviceâ€**.

### Screens to create/modify
- **Modify**: `EstimateDetail` screen (existing) to:
  - show an â€œAdd Labor/Serviceâ€ action when estimate status is DRAFT
  - show updated labor line items + totals after changes
- **Create/Modify**: `EstimateAddLabor` screen/dialog flow (implementation choice):
  - Catalog search panel + selection
  - Conditional custom entry form (only if allowed)
  - Submit action to create the labor line

### Navigation context
- Route pattern should keep user in estimate context:
  - `.../estimates/:estimateId` (detail)
  - `.../estimates/:estimateId/add-labor` (child screen) or modal launched from detail

### User workflows
**Happy path (catalog labor):**
1. Service Advisor opens Draft Estimate detail.
2. Clicks Add Labor/Service.
3. Searches catalog (code/description).
4. Selects a service.
5. If time-based: enters labor units > 0.
6. Submits.
7. Returns to estimate detail with new line + updated totals.

**Alternate path (custom labor, if enabled):**
1. Search yields no results (or user chooses â€œCustom Laborâ€).
2. Custom entry form appears.
3. Enters required description + labor units > 0 (+ any required fields).
4. Submits.
5. Returns to estimate detail with new custom labor line + updated totals.

**Invalid input path:**
- Units <= 0 blocks submit with clear inline validation.

---

## 6. Functional Behavior

### Triggers
- User selects **Add Labor/Service** from Draft estimate.
- User submits catalog selection + units (or flat-rate selection).
- User submits custom labor entry (if allowed).

### UI actions
- Catalog search:
  - Input: `query` string
  - Submit triggers search request; results list shows at least: `serviceCode`, `description`, and indication of `flatRate` vs time-based.
- Selection:
  - Selecting a result populates a â€œSelected Serviceâ€ context.
  - If selected service is time-based: show editable `laborUnits`.
  - If flat-rate: show read-only fields as allowed (see Open Questions).

### State changes (frontend-visible)
- Estimate lines list updated to include new labor item.
- Totals updated (subtotal/tax/grand total or equivalent).

### Service interactions
- `GET` estimate (load initial)
- `GET` service catalog search results
- `POST` add estimate labor item
- On success: refresh estimate detail (either by response payload or re-fetch)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Estimate must be DRAFT**:  
  - If not DRAFT, hide/disable Add Labor/Service and show message: â€œEstimate must be in Draft to add labor.â€
- **Labor units must be > 0** for time-based labor:
  - Inline validation error: â€œLabor units must be a positive number.â€
  - Disable submit until valid.
- **Custom labor description required** (if custom entry allowed):
  - Inline validation error: â€œDescription is required.â€

### Enable/disable rules
- Submit button disabled while:
  - Required fields invalid/missing
  - A request is in-flight
- Custom labor option visible only when backend indicates policy allows it (see Open Questions for how conveyed).

### Visibility rules
- Notes field visible for both catalog and custom labor items (optional) unless policy requires it (not specified; do not assume).

### Error messaging expectations
- Show backend validation messages when available; otherwise map to:
  - 400: â€œPlease correct the highlighted fields.â€
  - 403: â€œYou donâ€™t have permission to modify this estimate.â€
  - 404: â€œEstimate or service not found.â€
  - 409: â€œThis estimate was updated by someone else. Refresh and try again.â€
  - 5xx: â€œSomething went wrong. Try again.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `Estimate`
- `EstimateItem` (labor line type)
- `ServiceCatalog` (search and selection)
- (Optional/indirect) `LaborRateRule` (not directly manipulated by UI; rate comes from backend)
- `AuditEvent` (not directly created by UI; must be visible/traceable if exposed)

### Fields
**Estimate (read-only in this story)**
- `estimateId` (string/uuid; required)
- `status` (enum; required, must be `DRAFT` to enable feature)
- Totals fields (names TBD by API; required for display):
  - `subTotal` (money)
  - `totalTax` (money)
  - `grandTotal` (money)

**ServiceCatalog result item (read-only)**
- `serviceCode` (string; required)
- `description` (string; required)
- `isFlatRate` (boolean; required)
- (Optional) `defaultUnits` (decimal; if flat-rate uses fixed units; TBD)

**EstimateItem (labor)**
- `itemSeqId` (number/string; assigned by backend; read-only)
- `itemType` = `LABOR` (read-only, backend-set)
- `serviceCode` (string; required for catalog; optional/controlled for custom)
- `description` (string; required for custom; read-only for catalog unless clarified)
- `laborUnits` (decimal; required for time-based; behavior for flat-rate TBD)
- `laborRate` / `unitPrice` (money; defaulted by backend; editable only if explicitly allowedâ€”NOT assumed)
- `flatRateFlag` / `isFlatRate` (boolean; backend-set)
- `notes` (string/text; optional)
- `taxCode` (string; backend-derived unless UI must setâ€”unclear)

### Read-only vs editable by state/role
- Editable only when Estimate.status = `DRAFT`.
- Role: Service Advisor (assumed authorized); other roles not specified.

### Derived/calculated fields
- Line extended price and estimate totals are derived by backend and returned/displayed; frontend must not compute authoritative totals beyond display formatting.

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names/endpoints are not provided in inputs. Contracts below specify *required behaviors*; actual service names must align to backend/Moqui implementation.

### Load/view calls
1. **Load estimate detail**
   - Request: `GET /api/estimates/{estimateId}` (or Moqui screen/data call equivalent)
   - Response must include: `status`, existing items, totals.

2. **Search service catalog**
   - Request: `GET /api/service-catalog?query={q}` (or equivalent)
   - Response: list of services with `serviceCode`, `description`, `isFlatRate` (+ any fields needed for flat-rate display).

### Create/update calls
3. **Add labor line (catalog)**
   - Request: `POST /api/estimates/{estimateId}/items/labor` (placeholder)
   - Payload (minimum):
     - `serviceCode` (required)
     - `laborUnits` (required if time-based)
     - `notes` (optional)
   - Response:
     - created item (including `itemSeqId`, price fields)
     - updated estimate totals OR provide enough to refresh via GET

4. **Add labor line (custom, if allowed)**
   - Request: `POST /api/estimates/{estimateId}/items/labor-custom` (placeholder)
   - Payload (minimum):
     - `description` (required)
     - `laborUnits` (required)
     - `laborRate` (required?) **TBD** (inputs suggest manual rate entry; confirm)
     - `notes` (optional)
   - Response: same as above.

### Submit/transition calls
- None (estimate approval/decline out of scope).

### Error handling expectations
- Must support field-level validation errors (ideally structured). If not structured, frontend should still present a summary and mark relevant fields when possible.
- Concurrency: if estimate is modified concurrently, backend should return 409; frontend must offer refresh.

---

## 10. State Model & Transitions

### Allowed states (Estimate)
Per provided workexec approval workflow: `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`.

### Role-based transitions
- None in this story (no approve/decline/reopen actions here).

### UI behavior per state
- `DRAFT`: Add Labor/Service enabled.
- `APPROVED`, `DECLINED`, `EXPIRED`: Add Labor/Service disabled/hidden; show non-blocking info banner: â€œEstimate is not editable in this state.â€

---

## 11. Alternate / Error Flows

1. **No catalog results**
   - Show empty state: â€œNo services found.â€
   - If custom allowed: show â€œAdd Custom Laborâ€ action.
   - If not allowed: show guidance â€œTry a different search term.â€

2. **Invalid labor units (<= 0)**
   - Inline validation; prevent submit.

3. **Labor rate defaulting fails / no rule found**
   - Backend may return 4xx with message.
   - Frontend displays error and does not add line.
   - Whether manual override is allowed is **not assumed** (Open Question).

4. **Estimate not DRAFT**
   - If user deep-links to add-labor route: load estimate, detect non-DRAFT, block with message and navigate back to detail.

5. **Unauthorized (403)**
   - Show permission error; do not expose sensitive details.

6. **Conflict (409)**
   - Show â€œEstimate updated elsewhereâ€ with action to refresh and retry.

7. **Network/5xx**
   - Show retry affordance; keep user input if safe to do so (do not resubmit automatically).

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Add a standard time-based labor item to a Draft estimate
**Given** I am authenticated as a Service Advisor  
**And** an estimate with id "<estimateId>" exists in status "DRAFT"  
**When** I open the estimate detail screen  
**And** I choose "Add Labor/Service"  
**And** I search the service catalog for "SVC-OIL-CHG"  
**And** I select service code "SVC-OIL-CHG" that is time-based  
**And** I enter labor units "1.5"  
**And** I submit the add labor form  
**Then** a new labor line item is created and visible on the estimate  
**And** the line item displays service code "SVC-OIL-CHG" and labor units "1.5"  
**And** the labor rate shown is the backend-defaulted rate for the estimate context  
**And** the estimate totals shown reflect the new line item.

### Scenario 2: Prevent adding labor when estimate is not Draft
**Given** I am authenticated as a Service Advisor  
**And** an estimate with id "<estimateId>" exists in status "APPROVED"  
**When** I open the estimate detail screen  
**Then** the "Add Labor/Service" action is not available  
**And** I cannot submit any request to add a labor line from the UI.

### Scenario 3: Reject invalid labor units
**Given** I am authenticated as a Service Advisor  
**And** an estimate exists in status "DRAFT"  
**When** I select a time-based labor service from the catalog  
**And** I enter labor units "0"  
**Then** I see an inline validation message "Labor units must be a positive number."  
**And** the submit action is disabled  
**And** no labor line item is created.

### Scenario 4: Custom labor entry available only when policy allows
**Given** I am authenticated as a Service Advisor  
**And** an estimate exists in status "DRAFT"  
**When** I search the service catalog and receive no results  
**Then** I see an option "Add Custom Labor" only if the backend indicates custom labor is allowed  
**And** if custom labor is not allowed, I do not see the option.

### Scenario 5: Custom labor requires description
**Given** I am authenticated as a Service Advisor  
**And** custom labor entry is allowed  
**And** an estimate exists in status "DRAFT"  
**When** I choose "Add Custom Labor"  
**And** I leave description empty  
**Then** I see an inline validation message "Description is required."  
**And** the submit action is disabled.

### Scenario 6: Handle backend â€œno labor rate foundâ€ error deterministically
**Given** I am authenticated as a Service Advisor  
**And** an estimate exists in status "DRAFT"  
**When** I submit a catalog labor line  
**And** the backend responds with an error indicating no default labor rate is available  
**Then** I see a blocking error message returned by the backend (or a generic mapped message)  
**And** the labor line item is not added  
**And** the estimate totals remain unchanged in the UI.

---

## 13. Audit & Observability

### User-visible audit data
- Not required to display audit log in this story unless estimate detail already exposes it.
- If estimate detail shows â€œLast updatedâ€ / â€œUpdated byâ€: must update after successful add.

### Status history
- No estimate status changes in this story.

### Traceability expectations
- Each successful add-labor action must result in backend audit event creation (e.g., `EstimateLaborItemAdded`), including:
  - `estimateId`, created `estimateItemId`/`itemSeqId`, `serviceCode` or custom marker, `laborUnits`, defaulted `laborRate`, `userId`, timestamp (UTC).
- Frontend must include correlation/request id headers if project convention exists (not provided; do not assume exact header name).

---

## 14. Non-Functional UI Requirements

- **Performance:** Catalog search should respond fast enough for interactive use; UI should debounce search input (implementation detail) and show loading state.
- **Accessibility:** All form fields must have labels; validation messages must be accessible to screen readers; keyboard navigation supported.
- **Responsiveness:** Must work on tablet widths typical for POS usage.
- **i18n/timezone/currency:** Currency formatting must follow app-wide settings; do not hardcode `$`. Timestamps (if shown) must respect shop/user timezone settings (if already supported).

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a standard empty state for â€œno catalog resultsâ€ with guidance and optional custom entry action; qualifies as safe UX ergonomics; impacts UX Summary, Alternate/Error Flows.
- SD-UX-LOADING-STATE: Show loading and disable submit during in-flight requests to prevent duplicate submissions; qualifies as safe recoverability; impacts Functional Behavior, Alternate/Error Flows.
- SD-ERR-HTTP-MAP: Map common HTTP errors (400/403/404/409/5xx) to user-friendly messages without leaking internals; qualifies as safe error-handling; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Labor rate fallback behavior (blocking):** If no labor rate rule matches, should the UI (a) block and prevent adding the line, or (b) allow manual labor rate entry with permission and reason code? If (b), what permission and what reason-code capture is required?
2. **Flat-rate editability (blocking):** For flat-rate catalog services, are `laborUnits` and/or `laborRate` editable in the UI, or must they be locked to catalog/pricing output?
3. **Custom labor policy signal (blocking):** How does the frontend determine whether custom labor entry is allowed (e.g., field on estimate payload, dedicated config endpoint, or permission flag)?
4. **API/service contract specifics (blocking):** What are the exact Moqui screen/service endpoints and payload schemas for:
   - service catalog search
   - adding catalog labor line
   - adding custom labor line
   - returning updated totals (included in response vs requires re-fetch)
5. **Tax code handling (blocking):** Is `taxCode` chosen by user, derived from service, or derived from shop policy? If user-selectable, what are allowed values and defaults?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Estimate: Add Labor to Estimate  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/237  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Estimate: Add Labor to Estimate

**Domain**: user

### Story Description

/kiro  
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor

## Trigger
A Draft estimate exists and labor/services need to be quoted.

## Main Flow
1. User searches service catalog by service code or description.
2. User selects a service and specifies hours/units or selects a flat-rate option.
3. System defaults labor rate based on shop, role/class, and pricing rules.
4. System adds the labor line item and recalculates totals.
5. User adds notes/instructions if required for execution.

## Alternate / Error Flows
- Service not found â†’ allow controlled custom service entry (if enabled) with required description and labor units.
- Labor units invalid (<=0) â†’ block and prompt correction.

## Business Rules
- Each labor line item references a service code (or controlled custom code).
- Labor rate defaulting must be deterministic (policy-driven).
- Totals must be recalculated on labor line changes.

## Data Requirements
- Entities: Estimate, EstimateItem, ServiceCatalog, LaborRateRule, AuditEvent
- Fields: itemSeqId, serviceCode, laborUnits, laborRate, flatRateFlag, notes, taxCode

## Acceptance Criteria
- [ ] User can add labor/service line items to a Draft estimate.
- [ ] Labor pricing defaults correctly per configured rules.
- [ ] Totals update immediately after adding/editing labor items.

## Notes for Agents
Keep labor structure compatible with time-based and flat-rate models.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #238: [FRONTEND] [STORY] Estimate: Add Parts to Estimate  
File: ./scripts/story-work/frontend/238/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Estimate: Add Parts to Estimate (Catalog + Non-Catalog + Price Override)

### Primary Persona
Service Advisor

### Business Value
Enable Service Advisors to build accurate, auditable draft estimates by adding parts (from catalog or non-catalog where allowed), applying pricing defaults, enforcing override permissions/policies, and ensuring totals are recalculated consistently.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want to** search for parts and add them as line items to a Draft estimate (including optional price overrides and controlled non-catalog entry)  
- **So that** I can produce a complete quote for the customer with correct totals and an audit trail of changes.

### In-scope
- Catalog part search (by part number, description, category) and selection.
- Add a part line item to an **Estimate in `DRAFT`** state with quantity validation.
- Default unit price retrieval and display (pricing authority).
- Optional price override flow with permission gating and optional reason code requirement.
- Non-catalog part entry flow (policy-gated) with required description and manual unit price.
- Immediate refresh of estimate totals after add/edit.
- User-visible audit surfacing (who/when for line changes) if available in backend responses; otherwise show â€œlast updatedâ€ at estimate level.

### Out-of-scope
- Configuring price lists, discount/markup rules, tax policies, override reason code lists (configuration ownership outside this story).
- Creating/editing labor line items (parts only).
- Estimate approval / signature capture workflows.
- Work order creation/promotion from estimate.
- Inventory allocation, picking, or consumption.

---

## 3. Actors & Stakeholders

- **Primary Actor:** Service Advisor
- **Secondary Actors:** Service Manager (policy/permission owner), Parts Manager (catalog data quality)
- **System Actors / Dependencies:**
  - Inventory/Catalog service (product search & product details)
  - Pricing service (unit price + discounts/markups)
  - Workexec service (estimate + estimate items + totals + audit)
  - Security/Authorization (permission checks)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- An **Estimate** exists and is accessible to the user.
- Estimate status is **`DRAFT`** for add/edit operations.

### Dependencies (blocking if unavailable)
- Backend endpoints for:
  - Loading estimate + items + totals
  - Searching catalog products
  - Adding/updating estimate part items
  - Pricing calculation for selected catalog item (or included in add response)
  - Permission/policy evaluation (override permission; allow non-catalog; require reason)
- Reason codes source (if required) must be queryable or embedded in configuration payload.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Estimate detail screen: â€œAdd Partâ€ action within the Parts section.

### Screens to create/modify (Moqui)
1. **Modify** `EstimateDetail` screen (or equivalent) to include:
   - Parts line item table/list
   - â€œAdd Partâ€ button (enabled only when estimate is `DRAFT`)
2. **Create** `EstimateAddPart` dialog/screen (modal-style):
   - Tab/section: **Catalog Part**
   - Tab/section: **Non-Catalog Part** (visible only if policy allows)
3. **Create/Modify** `EstimatePartEdit` inline row editor or modal for:
   - Quantity edits
   - Price override (if permitted)

### Navigation context
- Remain within the estimate context (`/estimate/:estimateId` style route in SPA; Moqui screen parameters `estimateId`).
- After adding a part: return to Estimate detail with updated list and totals; highlight the newly added item.

### User workflows
#### Happy path: add catalog part
1. Service Advisor opens Draft estimate.
2. Clicks â€œAdd Partâ€.
3. Searches catalog; selects a part.
4. Enters quantity (>0).
5. Confirms â€œAddâ€.
6. UI shows new line item and refreshed totals.

#### Alternate: override price
1. After line added (or during add if supported), user attempts to edit unit price.
2. If permission granted: user enters override price, selects reason code if required, saves.
3. Totals refresh; audit displayed (if available).

#### Alternate: non-catalog part
1. Search returns no results (or user switches tab).
2. If policy enabled: user enters description, optional part number, quantity, unit price.
3. Saves; totals refresh.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œAdd Partâ€ on a Draft estimate.
- User changes quantity or requests price override on an existing part line item.

### UI actions
- Search input with debounce and explicit â€œSearchâ€ action (avoid excessive calls).
- Select product from results -> populate read-only part info (part number, description).
- Quantity input with validation.
- â€œAddâ€ submits create call; â€œCancelâ€ closes without changes.
- Row actions per part line item (when `DRAFT`):
  - Edit quantity
  - Override price (permission-gated)
  - (Delete not requested; do not implement unless already present)

### State changes (frontend-visible)
- Line item list updates (new item appears with stable identifier).
- Totals panel refreshes (subtotal/tax/grand total as provided by backend).
- If estimate is not `DRAFT`: disable add/edit controls and show explanatory banner.

### Service interactions (high-level)
- Load estimate details on screen entry.
- Product search calls while in Add Part workflow.
- Pricing retrieval:
  - Preferred: backend create-item response includes pricing fields and totals.
  - If not: call pricing endpoint prior to create to show computed unit price (requires contract).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation rules
- **Estimate status gate:** If estimate status != `DRAFT`, block add/edit actions and show:  
  â€œThis estimate canâ€™t be modified because it is <STATUS>.â€
- **Quantity:** must be numeric and **> 0**. Error: â€œQuantity must be a number greater than 0.â€
- **Catalog selection:** productId required for catalog add.
- **Non-catalog policy gate:** non-catalog form visible/enabled only if `ALLOW_NON_CATALOG_PARTS=true`.
- **Non-catalog required fields:** description required (non-empty), unitPrice required, quantity > 0.
- **Price override permission:** if user lacks permission, disable price editing and show tooltip/help text; if attempted via direct input, show:  
  â€œYou do not have permission to override prices.â€
- **Override reason code:** if policy `REQUIRE_REASON_FOR_OVERRIDE=true`, require selection before saving override; error: â€œA reason code is required for all price overrides.â€

### Enable/disable rules
- â€œAdd Partâ€ button enabled only when estimate status is `DRAFT`.
- â€œNon-Catalog Partâ€ tab enabled only when policy allows.
- Price override control enabled only when:
  - estimate status is `DRAFT`
  - user has override permission

### Visibility rules
- Show â€œOverride reasonâ€ field only when:
  - override is being applied AND policy requires reason code

### Error messaging expectations
- Validation errors should be field-level + a top-level summary.
- Backend errors mapped to user-friendly messages (see Error Flows).

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `Estimate`
- `EstimateItem` (parts line items)
- `Product` (catalog)
- `ApprovalConfiguration` / policy source (for method; here needed for non-catalog + override reason requirement) **(contract unclear)**
- Audit event/history entity if exposed (`AuditEvent` or line-item change log) **(contract unclear)**

### Fields

#### Estimate (read)
- `estimateId` (string/UUID) **required**
- `status` (enum: `DRAFT`, `APPROVED`, `DECLINED`, `EXPIRED`) **required**
- Totals (backend-calculated; types depend on API):
  - `subtotal` (money) required
  - `taxTotal` (money) required
  - `grandTotal` (money) required
- Optional:
  - `currencyUomId` (string) (if multi-currency)
  - `lastUpdatedStamp` (datetime)

#### EstimateItem (parts) (read/write)
- Identifiers:
  - `estimateItemId` (string/UUID) **required**
  - `estimateId` **required**
  - `itemSeqId` (number) read-only
- Classification:
  - `itemType` = `PART` (read-only)
  - `isNonCatalog` (boolean) read-only
- Catalog fields:
  - `productId` (string/UUID) required for catalog, null for non-catalog
  - `partNumber` (string) optional (required for catalog if provided by product)
- Common fields:
  - `description` (string) required
  - `quantity` (decimal) required, >0
  - `unitPrice` (money) read-only if pricing authority; editable only through override flow
  - `overrideUnitPrice` (money) optional
  - `overrideReasonCode` (string) optional/required-by-policy
  - `taxCodeSnapshot` (string) read-only (source unclear)

### Read-only vs editable (by state/role)
- When estimate status != `DRAFT`: all estimate items are read-only in UI.
- When `DRAFT`:
  - quantity editable
  - overrideUnitPrice editable only with permission
  - non-catalog fields editable only at create time unless backend supports edits (not specified)

### Derived/calculated fields
- Line extended price = quantity * effective unit price (unitPrice or overrideUnitPrice) (display-only; do not calculate as authorityâ€”prefer backend values if provided).
- Totals always treated as backend-authoritative.

---

## 9. Service Contracts (Frontend Perspective)

> Note: Backend API paths for estimates are defined in `CUSTOMER_APPROVAL_WORKFLOW.md` but â€œadd partsâ€ endpoints are **not explicitly defined** there. This story requires clarification on the actual endpoints in Moqui/REST.

### Load/view calls
- `GET /api/estimates/{id}`  
  **Returns:** estimate header, status, totals, line items (or separate call).
- If line items are separate:
  - `GET /api/estimates/{id}/items?itemType=PART`

### Product search calls
- `GET /api/products/search?query=&category=&partNumber=` (example)  
  **Returns:** list of products with `productId`, `partNumber`, `description`.

### Create/update calls
One of the following patterns must be confirmed:

**Option A (preferred):**
- `POST /api/estimates/{id}/items/parts`
  ```json
  {
    "productId": "â€¦",
    "quantity": 2
  }
  ```
  For non-catalog:
  ```json
  {
    "isNonCatalog": true,
    "description": "â€¦",
    "partNumber": "optional",
    "quantity": 1,
    "unitPrice": 49.99
  }
  ```
  **Response:** created `EstimateItem` + updated totals.

**Option B:**
- `PUT /api/estimates/{id}` with embedded items patch (less ideal for concurrency).

### Price override calls
- `POST /api/estimates/{estimateId}/items/{estimateItemId}/override-price`
  ```json
  { "overrideUnitPrice": 39.99, "overrideReasonCode": "PRICE_MATCH" }
  ```
  **Response:** updated item + updated totals.

### Error handling expectations
- `400` validation errors: show field-level errors.
- `403` forbidden: show permission/policy message.
- `404` not found: show â€œEstimate not foundâ€ / â€œPart not foundâ€.
- `409` conflict: show â€œThis estimate was updated by someone else. Refresh to continue.â€ and provide refresh action.

---

## 10. State Model & Transitions

### Estimate states (authoritative from workexec rules)
- `DRAFT`
- `APPROVED`
- `DECLINED`
- `EXPIRED`

### Allowed transitions (not implemented here, but gate UI)
- Only `DRAFT` is editable for adding/modifying parts.

### Role-based transitions (UI enforcement for this story)
- Service Advisor can add/edit parts only in `DRAFT`.
- Price override requires explicit permission (exact permission string TBD).

### UI behavior per state
- `DRAFT`: enable add part, quantity edit, and price override if permitted.
- `APPROVED`/`DECLINED`/`EXPIRED`: read-only; show banner indicating status and that edits are disabled.

---

## 11. Alternate / Error Flows

### Validation failures
- Quantity <= 0: block submit; show inline error.
- Non-catalog without description: block; error â€œDescription is required.â€
- Override without reason when required: block; error â€œA reason code is requiredâ€¦â€

### Concurrency conflicts
- If backend returns `409` on add/update due to stale version:
  - UI shows blocking dialog with â€œRefresh estimateâ€ action.
  - Refresh reloads estimate + items; user can retry.

### Unauthorized access
- If `403` on override action:
  - Keep original price displayed.
  - Show toast/banner: â€œYou do not have permission to override prices.â€

### Empty states
- No parts yet: show empty state â€œNo parts addedâ€ with â€œAdd Partâ€ CTA (only in `DRAFT`).
- Search returns no results:
  - Show â€œNo parts found.â€
  - If non-catalog policy enabled: show action â€œAdd non-catalog part.â€

---

## 12. Acceptance Criteria

### Scenario 1: Add a catalog part line item to a Draft estimate
**Given** I am authenticated as a Service Advisor  
**And** I am viewing an estimate with status `DRAFT`  
**When** I open â€œAdd Partâ€ and search by part number or description  
**And** I select a catalog part  
**And** I enter a quantity of `2`  
**And** I confirm adding the part  
**Then** a new part line item is added to the estimate  
**And** the line item shows the selected partâ€™s description/part number and quantity `2`  
**And** the unit price shown matches the backend/pricing authority response  
**And** the estimate totals are refreshed to the backend-calculated values.

### Scenario 2: Block adding a part when estimate is not Draft
**Given** I am viewing an estimate with status `APPROVED`  
**When** I attempt to add a part  
**Then** the UI prevents the action (button disabled or blocked)  
**And** I see a message indicating the estimate cannot be modified in `APPROVED` status  
**And** no create-item service call is executed.

### Scenario 3: Reject invalid quantity
**Given** I am viewing an estimate with status `DRAFT`  
**When** I attempt to add a catalog part with quantity `0`  
**Then** the system prevents submission  
**And** I see the validation message â€œQuantity must be a number greater than 0â€  
**And** no create-item service call is executed.

### Scenario 4: Add a non-catalog part when policy allows
**Given** I am viewing an estimate with status `DRAFT`  
**And** the policy `ALLOW_NON_CATALOG_PARTS` is enabled  
**When** I choose â€œAdd non-catalog partâ€  
**And** I enter description â€œBrake pad hardware kitâ€, quantity `1`, unit price `19.99`  
**Then** a new line item is added with `isNonCatalog=true`  
**And** the estimate totals are refreshed to the backend-calculated values.

### Scenario 5: Hide/disable non-catalog entry when policy disallows
**Given** I am viewing an estimate with status `DRAFT`  
**And** the policy `ALLOW_NON_CATALOG_PARTS` is disabled  
**When** my catalog search returns no results  
**Then** I do not see an option to add a non-catalog part  
**And** I only see the â€œNo parts foundâ€ empty search result.

### Scenario 6: Override price with permission and required reason
**Given** I am viewing an estimate with status `DRAFT`  
**And** I have permission to override prices  
**And** the policy `REQUIRE_REASON_FOR_OVERRIDE` is enabled  
**And** the estimate has a part line item  
**When** I set an override unit price  
**And** I select an override reason code  
**And** I save the override  
**Then** the line item reflects the overridden price  
**And** the reason code is stored/shown (where available)  
**And** the estimate totals refresh to backend-calculated values.

### Scenario 7: Block override price without permission
**Given** I am viewing an estimate with status `DRAFT`  
**And** I do not have permission to override prices  
**When** I attempt to edit the unit price on a part line item  
**Then** the UI blocks the edit  
**And** I see the message â€œYou do not have permission to override pricesâ€  
**And** no override service call is executed.

### Scenario 8: Audit visibility after add/edit (if provided)
**Given** I added a part line item to a Draft estimate  
**When** the add call succeeds  
**Then** the UI displays the updated â€œlast modifiedâ€ metadata for the estimate or line item (user + timestamp) if included in the response  
**And** the UI does not display internal-only audit fields not intended for customer view.

---

## 13. Audit & Observability

### User-visible audit data
- Display (if available from API):
  - Estimate â€œLast updated at/byâ€
  - For each part line item: â€œAdded by/atâ€ and â€œLast modified by/atâ€
- Do **not** display sensitive/internal audit payloads.

### Status history
- Not required to implement estimate state history view; only enforce edit gating by current status.

### Traceability expectations
- Every successful create/update should include or propagate a correlation/request id (e.g., `X-Request-Id`) to logs (frontend console logger) and to backend headers when supported.
- UI should store the `estimateItemId` and use it for subsequent edits to ensure stable identifiers.

---

## 14. Non-Functional UI Requirements

- **Performance:** product search should debounce (e.g., 300â€“500ms) and show loading state; results paginated if backend supports.
- **Accessibility:** all form inputs have labels, errors are announced (aria-live), keyboard navigation works in modal/dialog.
- **Responsiveness:** add-part dialog usable on tablet; results list scrollable.
- **i18n/timezone/currency:** display money using location/estimate currency formatting if provided; timestamps shown in userâ€™s locale but stored as UTC from backend.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide standard empty state messaging and CTA for â€œNo parts addedâ€ / â€œNo search resultsâ€; qualifies as safe because it does not change domain behavior. Impacted sections: UX Summary, Alternate/Empty states.
- SD-UX-DEBOUNCE-SEARCH: Debounce catalog search input to reduce request volume; safe because it only affects ergonomics and not business rules. Impacted sections: Functional Behavior, Non-Functional.
- SD-ERR-HTTP-MAP: Map standard HTTP codes (400/403/404/409/5xx) to user messages; safe because it follows implied backend contract without inventing policies. Impacted sections: Error Flows, Service Contracts.

---

## 16. Open Questions

1. **Backend API endpoints (blocking):** What are the exact Moqui/REST endpoints for:
   - Searching products (catalog)
   - Adding a catalog part line item to an estimate
   - Adding a non-catalog part line item
   - Updating quantity
   - Performing a price override (and persisting reason codes)
2. **Policy & permission contracts (blocking):**
   - What is the exact permission identifier for price overrides (e.g., `workexec.estimate.overridePrice`) and how should frontend check it (claims in session? endpoint?)?
   - How does frontend retrieve policy flags `ALLOW_NON_CATALOG_PARTS` and `REQUIRE_REASON_FOR_OVERRIDE` (estimate payload, shop config endpoint, or separate service)?
3. **Override reason codes source (blocking if required):** If reason codes are required, where does the UI fetch the valid list (endpoint and schema)? Is it location-specific?
4. **Tax fields (blocking for display correctness):** Is `taxCodeSnapshot` returned for items, and are line-level taxes returned? Should UI display tax per line or only totals?
5. **Edit vs add pricing flow (clarification):** Should unit price be shown before adding the catalog item (requires pricing lookup pre-create), or is it acceptable to add item first and then display returned price?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Estimate: Add Parts to Estimate  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/238  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Estimate: Add Parts to Estimate

**Domain**: user

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor

## Trigger
A Draft estimate exists and parts need to be quoted.

## Main Flow
1. User searches parts catalog by part number, description, or category.
2. User selects a part and specifies quantity.
3. System defaults unit price from configured price list and applies discounts/markups as configured.
4. User optionally overrides price if permitted and provides a reason code if required.
5. System adds the part line item and recalculates totals.

## Alternate / Error Flows
- Part not found â†’ allow controlled non-catalog part entry (if enabled) with mandatory description.
- Quantity invalid (<=0) â†’ block and prompt correction.
- Price override not permitted â†’ block and show policy message.

## Business Rules
- Each part line item references a part number (or controlled non-catalog identifier).
- Totals must be recalculated on line change.
- Price overrides require permission and may require reason codes.

## Data Requirements
- Entities: Estimate, EstimateItem, Product, PriceList, DiscountRule, AuditEvent
- Fields: itemSeqId, productId, partNumber, quantity, unitPrice, discountAmount, taxCode, isNonCatalog, overrideReason

## Acceptance Criteria
- [ ] User can add a catalog part line item to a Draft estimate.
- [ ] Totals update immediately after adding or editing part items.
- [ ] Audit records who changed quantity/price.

## Notes for Agents
Model part items so later promotion preserves stable identifiers and tax snapshots.

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #239: [FRONTEND] [STORY] Estimate: Create Draft Estimate  
File: ./scripts/story-work/frontend/239/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)
### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Estimate: Create Draft Estimate

### Primary Persona
Service Advisor / Front Desk

### Business Value
Enable fast creation of a Draft estimate tied to a specific customer + vehicle so the advisor can immediately begin quoting work (line items) with correct shop defaults and an auditable creation record.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor / Front Desk user  
- **I want** to create a new **Draft** estimate for a selected Customer and Vehicle  
- **So that** I can start building a quote and route to the estimate workspace with the newly created estimate identifier.

### In Scope
- UI flow to select/create Customer record (via navigation to existing customer/vehicle screens if needed).
- UI flow to select/create Vehicle record and capture context fields (VIN/plate, odometer, notes) when required.
- Create Draft Estimate action (frontend â†’ Moqui â†’ backend API) and routing to estimate workspace on success.
- Display created estimate identifier and status (Draft).
- Permission/authorization handling for estimate creation attempts.
- User-visible confirmation + error messaging.
- Audit visibility requirements (show audit/created metadata that backend returns; do not invent audit storage).

### Out of Scope
- Estimate approval workflow (methods, signatures, decline/reopen) beyond creating the initial Draft.
- Work order creation/conversion.
- Adding parts/labor line items (only navigate to workspace where that will occur).
- Configuring shop/location defaults, currency, tax region (configuration ownership is outside this story).
- Implementing backend persistence or audit generation (frontend consumes).

---

## 3. Actors & Stakeholders
- **Primary Actor:** Service Advisor / Front Desk
- **Stakeholders:** Customer, Shop Manager (oversight), Technician (downstream consumer), Accounting (downstream reporting), Security/Audit (traceability)

---

## 4. Preconditions & Dependencies
- User is authenticated in the POS UI.
- User has permission to create estimates (permission name is referenced as `ESTIMATE_CREATE` in backend story; frontend must be prepared for 403 if missing).
- Customer and Vehicle context is available:
  - Either already exists, or the UI provides navigation to create them before estimate creation.
- Backend endpoint exists to create estimate and returns the created estimate with ID/number/status and defaulted fields (exact endpoint path is not provided in frontend inputs; see Open Questions).
- Moqui frontend project has a routing convention for â€œestimate workspaceâ€ screen (unknown; see Open Questions).

---

## 5. UX Summary (Moqui-Oriented)

### Entry Points
At least one of:
- Customer detail screen â†’ â€œCreate Estimateâ€
- Vehicle detail screen â†’ â€œCreate Estimateâ€
- Global â€œNew Estimateâ€ action that first collects Customer + Vehicle

(Exact existing entry screens are not provided; implement in a way consistent with current navigation, or add a single new entry screen and link from existing customer/vehicle screens.)

### Screens to create/modify
- **Create/Select Estimate Context Screen** (new or existing):
  - Collect/confirm `customerId`, `vehicleId`
  - Capture required context: VIN/plate, odometer, notes (either inline if missing, or via navigation to vehicle edit)
  - Action: **Create Estimate**
- **Estimate Workspace Screen** (existing or stubbed if not present):
  - Receives `estimateId` route parameter
  - Shows header summary: estimateNumber, status=Draft, customer, vehicle

### Navigation context
- After successful creation: transition to `EstimateWorkspace` with `estimateId`.
- Back navigation returns to previous context (customer/vehicle).

### User workflows
- **Happy path**
  1. User selects/creates customer
  2. User selects/creates vehicle + fills required context if prompted
  3. Clicks â€œCreate Estimateâ€
  4. System creates Draft estimate, shows confirmation
  5. User is routed into estimate workspace/editor
- **Alternate paths**
  - Missing customer/vehicle: disable Create action and show required-field guidance
  - Backend validation errors (400): show field-specific errors
  - Unauthorized (403): show access blocked message
  - Not found (404): show record missing and offer to re-select
  - Network/server error: show retry option and do not navigate

---

## 6. Functional Behavior

### Triggers
- User presses **Create Estimate** from the estimate creation entry flow.

### UI actions
- Validate required context present before enabling submission:
  - `customerId` present
  - `vehicleId` present
- On submit:
  - Show loading state; prevent double-submit
  - Call Moqui transition that invokes backend create service
  - On success: route to estimate workspace with created `estimateId`
  - Display toast/banner confirmation including `estimateNumber` when available

### State changes (frontend)
- Local UI state: `submitting=true/false`, `errorState`, `createdEstimate` payload.
- No client-side persistence required beyond routing.

### Service interactions
- Create Draft Estimate request (frontend â†’ Moqui â†’ backend REST).
- Optional: load applicable defaults (location/currency/taxRegion) if backend does not return them; however backend story indicates defaults are set on creation and returnedâ€”frontend should rely on response.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **BR-UI-1:** Customer is required to create an estimate.
  - UI blocks submission until selected.
- **BR-UI-2:** Vehicle is required to create an estimate.
  - UI blocks submission until selected.
- **BR-UI-3:** If customer/vehicle is missing required fields needed for estimate creation (unspecified which), UI must prompt user to complete required context before allowing creation.
  - Implementation: if backend returns 400 with field errors, surface them and provide a CTA to edit missing data.

### Enable/disable rules
- Create button disabled when:
  - `customerId` is empty OR `vehicleId` is empty OR `submitting=true`.

### Visibility rules
- After creation, in estimate workspace header show:
  - `estimateNumber` (if provided)
  - `status` (must be Draft)
  - `customerId`/customer display name (if provided by API)
  - `vehicleId`/vehicle summary (if provided)

### Error messaging expectations
- 400: â€œCannot create estimate. Please fix the highlighted fields.â€ + show field messages from backend.
- 403: â€œYou donâ€™t have permission to create estimates. Contact a manager.â€
- 404: â€œCustomer or vehicle not found. Please re-select.â€
- 409 (if uniqueness collision or concurrency): â€œEstimate could not be created due to a conflict. Please retry.â€
- 5xx/network: â€œSomething went wrong creating the estimate. Try again.â€

(Do not expose internal stack traces or IDs beyond correlationId if available.)

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `Estimate`
- `Customer`
- `Vehicle`
- `UserPermission` (checked implicitly via backend authorization; frontend may also gate UI if permissions are available in session payload)
- `AuditEvent` (view-only metadata; do not create from frontend)

### Fields
**Estimate (returned by backend create)**
- `estimateId` (UUID/string) â€” required
- `estimateNumber` (string) â€” required for display if present in response; otherwise show estimateId as fallback
- `status` (enum/string) â€” required, must equal `DRAFT`/`Draft` depending on API
- `customerId` (UUID/string) â€” required
- `vehicleId` (UUID/string) â€” required
- `shopId` or `locationId` (UUID/string) â€” required (backend references `locationId`; frontend input references `shop/location`)
- `currencyUomId` (string) â€” required
- `taxRegionId` (UUID/string) â€” required
- `createdBy` / `createdByUserId` â€” required for audit display if provided
- `createdDate` / `createdAtTimestamp` â€” required for audit display if provided

**Customer context (input to create)**
- `customerId` â€” required

**Vehicle context (input to create)**
- `vehicleId` â€” required
- Optional context capture (may be required by other domain rules not specified):
  - VIN / plate, odometer, notes (capture/edit via vehicle screen; do not invent requiredness)

### Read-only vs editable by state/role
- In this story, estimate is created; editing estimate fields is out of scope.
- `customerId` and `vehicleId` selection is editable before creation; not editable after redirect (handled by estimate workspace story later).

### Derived/calculated fields
- Defaulting: `shop/location`, `currencyUomId`, `taxRegionId` are derived by backend from configuration/session.

---

## 9. Service Contracts (Frontend Perspective)

> Note: exact Moqui service names and backend paths are not provided in inputs; below is an implementation contract the Moqui layer must map to the actual backend.

### Load/view calls
- (Optional) Search/select customer and vehicle:
  - `GET /api/customers?...` and `GET /api/vehicles?...` or existing Moqui entity-find screens.
  - If the project already has customer/vehicle selectors, reuse them.

### Create/update calls
- **Create Draft Estimate**
  - Preferred REST (from backend references): `POST /api/estimates`
  - Request body (minimum):
    ```json
    {
      "customerId": "<uuid>",
      "vehicleId": "<uuid>"
    }
    ```
  - Response: `201 Created` with created Estimate payload including `estimateId`, `estimateNumber`, `status`, defaulted fields.

### Submit/transition calls (Moqui)
- Moqui screen transition `createEstimate`:
  - Validates required parameters present
  - Invokes REST client to backend
  - On success sets `estimateId` in context and transitions to workspace screen.

### Error handling expectations
- Map backend HTTP errors to UI errors:
  - `400`: field errors or message shown inline
  - `403`: access denied screen/toast and keep user on same page
  - `404`: show not found and clear selection or allow re-select
  - `409`: show conflict retry message
  - `5xx`/timeout: show retry option; log correlationId if returned

---

## 10. State Model & Transitions

### Allowed states (Estimate lifecycle relevant to this story)
- `DRAFT` is the only state created by this flow.

### Role-based transitions
- Service Advisor initiates creation (authorization enforced by backend).
- No estimate status transitions in scope.

### UI behavior per state
- After creation, workspace header must show state = Draft and allow proceeding to add line items (out of scope for implementation, but navigation must land correctly).

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing customerId: prevent submit; show â€œSelect a customerâ€
- Missing vehicleId: prevent submit; show â€œSelect a vehicleâ€

### Validation failures (server-side 400)
- Show backend-provided messages; keep inputs intact.

### Concurrency conflicts
- If backend returns 409 (e.g., estimateNumber uniqueness collision), show retry. User can click Create again.

### Unauthorized access (403)
- Block creation; show permission guidance; do not retry automatically.
- If UI can detect permissions pre-emptively (session includes permission list), hide/disable Create Estimate entrypoint.

### Empty states
- No customers/vehicles found in selector: show empty-state guidance and CTA to create new customer/vehicle.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create draft estimate successfully
**Given** the Service Advisor is authenticated  
**And** the user has permission to create estimates  
**And** a Customer is selected with `customerId`  
**And** a Vehicle is selected with `vehicleId`  
**When** the user clicks â€œCreate Estimateâ€  
**Then** the system sends a create-estimate request containing `customerId` and `vehicleId`  
**And** on success the UI routes to the Estimate Workspace for the returned `estimateId`  
**And** the Estimate Workspace displays the estimate `status` as `Draft`  
**And** the estimate identifier (`estimateNumber` or fallback `estimateId`) is visible.

### Scenario 2: Prevent creation when customer is missing
**Given** the Service Advisor is on the Create Estimate flow  
**And** no Customer is selected  
**When** the user attempts to create an estimate  
**Then** the UI must block submission  
**And** the UI must indicate that Customer is required  
**And** no create-estimate request is sent.

### Scenario 3: Prevent creation when vehicle is missing
**Given** the Service Advisor is on the Create Estimate flow  
**And** a Customer is selected  
**And** no Vehicle is selected  
**When** the user attempts to create an estimate  
**Then** the UI must block submission  
**And** the UI must indicate that Vehicle is required  
**And** no create-estimate request is sent.

### Scenario 4: Handle backend validation error (400)
**Given** the Service Advisor has selected a customer and vehicle  
**When** the create-estimate request is submitted  
**And** the backend responds with HTTP 400 and a message indicating missing/invalid required context  
**Then** the UI must remain on the creation screen  
**And** the UI must display the backend error message(s) in a user-readable way  
**And** the user must be able to correct the issue and retry.

### Scenario 5: Handle unauthorized attempt (403)
**Given** the user is authenticated  
**When** the user submits a create-estimate request  
**And** the backend responds with HTTP 403  
**Then** the UI must not navigate to the estimate workspace  
**And** the UI must display an access denied message  
**And** the attempt must be logged client-side with correlationId if available (without PII).

### Scenario 6: Handle not found (404)
**Given** the user selected a customerId or vehicleId that no longer exists  
**When** the create-estimate request is submitted  
**And** the backend responds with HTTP 404  
**Then** the UI must show a â€œnot foundâ€ message  
**And** prompt the user to re-select the missing record  
**And** not navigate away.

---

## 13. Audit & Observability

### User-visible audit data
- In the estimate workspace header or â€œDetailsâ€ panel, show (if returned by backend):
  - Created at (timestamp)
  - Created by (user id/name)
- If not returned, do not fabricate; show nothing or â€œâ€”â€.

### Status history
- Not in scope to display transitions; only show current status = Draft.

### Traceability expectations
- All create attempts should include/propagate correlationId if the Moqui HTTP client supports it.
- Client logs (console/dev logging per project conventions) must not include full customer PII; only IDs.

---

## 14. Non-Functional UI Requirements
- **Performance:** Create request should complete within 2s typical; show spinner if longer; allow retry on failure.
- **Accessibility:** All actions keyboard accessible; errors announced via ARIA live region; form fields have labels.
- **Responsiveness:** Works on tablet and desktop widths typical for POS.
- **i18n/timezone/currency:** Display timestamps in user locale/timezone if available; currency code shown as returned (no currency math in this story).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty state messaging and CTA when no customer/vehicle found; qualifies as safe UI ergonomics; impacts UX Summary, Alternate / Error Flows.
- SD-UX-DOUBLE-SUBMIT-GUARD: Disable submit and show loading during create call to prevent duplicate requests; safe and reversible UX behavior; impacts Functional Behavior, Error Flows.
- SD-ERR-HTTP-MAP: Standard mapping of HTTP 400/403/404/409/5xx to user-friendly messages; safe error-handling mapping; impacts Business Rules, Alternate / Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. What is the **actual backend endpoint** and payload for creating an estimate in this system (confirm `POST /api/estimates` with `{customerId, vehicleId}`), and what is the exact response shape (field names: `status` casing, `locationId` vs `shopId`, `createdAt` name)?
2. What is the **canonical Moqui route/screen** for the â€œDraft estimate workspaceâ€ (screen path and required parameters)? If it does not exist yet, should this story create a minimal placeholder workspace screen that only shows header info?
3. Which **vehicle/customer fields** are considered â€œrequired contextâ€ for estimate creation (beyond IDs), so the frontend can proactively prompt before submit rather than relying only on backend 400 responses?
4. Is there an existing **permission/feature flag signal** in the frontend session to hide/disable â€œCreate Estimateâ€ pre-emptively, or should the UI rely solely on backend 403 handling?

---

## Original Story (Unmodified â€“ For Traceability)
Title: [FRONTEND] [STORY] Estimate: Create Draft Estimate  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/239  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Estimate: Create Draft Estimate

**Domain**: user

### Story Description

/kiro
Produce implementation-ready acceptance criteria, validations, and edge cases. Keep Moqui state transitions and audit requirements explicit.

# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: workexec

## Actor
Service Advisor / Front Desk

## Trigger
A customer requests service or a quote for a vehicle (walk-in, phone, email, or fleet request).

## Main Flow
1. User selects or creates the Customer record.
2. User selects or creates the Vehicle record and captures context (VIN/plate, odometer, notes).
3. User clicks 'Create Estimate' and the system creates a Draft estimate with an identifier.
4. System sets default shop/location, currency, and tax region based on configuration.
5. User is taken to the Draft estimate workspace to add line items.

## Alternate / Error Flows
- Customer or Vehicle missing required fields â†’ prompt user to complete required context.
- Estimate creation attempted without permissions â†’ block and log access attempt.

## Business Rules
- Estimate starts in Draft state.
- Estimate identifier is unique per shop/location.
- Audit event is recorded on creation.

## Data Requirements
- Entities: Estimate, Customer, Vehicle, UserPermission, AuditEvent
- Fields: estimateId, status, customerId, vehicleId, shopId, currencyUomId, taxRegionId, createdBy, createdDate

## Acceptance Criteria
- [ ] A Draft estimate is created with required customer and vehicle context.
- [ ] Estimate status is Draft and visible.
- [ ] Creation is recorded in audit trail.

## Notes for Agents
Keep estimate creation decoupled from approval and workorder logic. Establish baseline validations and defaulting rules.


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #269: [FRONTEND] [STORY] Approval: Record Partial Approval  
File: ./scripts/story-work/frontend/269/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Approval: Record Partial Approval (Work Order)

### Primary Persona
Service Advisor

### Business Value
Enable a Service Advisor to record customer approval/decline decisions per line item so authorized work can proceed while declined work remains clearly tracked, auditable, and excluded from execution/billing.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to record partial approval for a Work Order by approving some line items and declining others (including capturing approval method/proof)  
- **So that** technicians only execute authorized work, totals reflect only approved items, and the system maintains a compliant audit trail.

### In-Scope
- A Work Order â€œRecord Approvalâ€ UI that:
  - Loads work order + line items requiring approval
  - Allows per-line approval decisions
  - Enforces approval-window rules for re-approving previously declined items (if supported by backend)
  - Captures approval method according to configuration precedence (customer > location > default)
  - Submits approval decisions in a single atomic confirmation action
  - Displays resulting Work Order status and approved total
- Read-only display of relevant audit/approval metadata after submission (method, timestamp, proof reference if any)

### Out-of-Scope
- Creating or editing estimates/prices/line items themselves
- Customer communication (SMS/email collection or sending links)
- Scheduling â€œamendment workflowâ€ UI (only trigger/hand off if backend provides it)
- Signature capture UX implementation details beyond basic integration hook (depends on backend contract)
- Any new workflow states not defined by authoritative workexec state machine documents

---

## 3. Actors & Stakeholders
- **Service Advisor (primary)**: Records customer decisions and approval artifact.
- **Customer**: Provides approval/decline decisions.
- **Technician/Mechanic**: Consumes outcomes to know what is authorized.
- **Manager/Auditor**: Reviews approval history and proof.
- **System (POS)**: Validates state, persists immutable approval records, emits audit events.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend.
- Work Order exists and is accessible to the user.
- Work Order is in a state that permits recording approvals (see Open Questions; backend reference uses `AwaitingApproval`).

### Dependencies (Blocking if missing)
- Backend endpoints to:
  - Load Work Order details including line items and current approval statuses
  - Load applicable approval configuration (or include it in Work Order payload)
  - Submit partial approval decisions atomically with method/proof
  - Enforce approval window and return a deterministic error when expired
- Backend-defined enums/status values for:
  - Work Order status allowing approval entry
  - Line item approval statuses
  - Approval method identifiers

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order detail screen: action button **â€œRecord Approvalâ€**
- Deep link route: `/workorders/{workOrderId}/approval/record` (screen path suggestion; exact route must match repo routing conventions)

### Screens to create/modify
1. **Modify** Work Order Detail screen to add conditional action:
   - Show â€œRecord Approvalâ€ only when work order status is eligible (e.g., `AWAITING_APPROVAL`).
2. **Create** Work Order Partial Approval screen:
   - Loads work order header + list of approval-eligible line items
   - Provides per-line selection: Approved / Declined
   - Shows computed â€œApproved Totalâ€ preview
   - Shows approval method UI section determined by config
   - â€œConfirm Approvalâ€ and â€œCancelâ€ actions

### Navigation context
- Breadcrumb/back returns to Work Order detail.
- After successful confirmation: redirect to Work Order detail (or a read-only approval summary subsection) with a success message.

### User workflows
#### Happy path: approve some, decline some
1. Advisor opens Record Approval screen.
2. System loads work order + line items.
3. Advisor selects Approved/Declined per line.
4. Advisor provides required method proof (if signature).
5. Advisor confirms.
6. System saves, returns updated work order status + totals.
7. UI shows success and navigates back to Work Order detail.

#### Alternate: all declined
- Same flow, but UI shows that approved total becomes 0 and resultant status is Declined (terminal).

#### Alternate: user cancels
- Cancel returns to Work Order detail without saving; discard local changes.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œRecord Approvalâ€ action from Work Order detail
- User visits direct URL for approval recording

### UI actions
- **Load**: fetch Work Order and line items; fetch approval configuration if not present.
- **Edit**: for each line item, choose `Approved` or `Declined`.
- **Preview**: compute `totalApprovedAmountPreview = sum(price for items marked Approved)` (display-only; backend remains source of truth).
- **Confirm**: submit all decisions in one request.
- **Cancel**: discard changes, navigate back.

### State changes (frontend-visible)
- Line itemsâ€™ approval statuses change from Pending to Approved/Declined after successful confirmation.
- Work Order status updates:
  - If â‰¥ 1 item approved â†’ moves to â€œapproved-for-workâ€ state (exact enum TBD)
  - If all declined â†’ moves to terminal â€œdeclinedâ€ state

### Service interactions (high level)
- GET Work Order detail (includes line items + current statuses)
- GET applicable approval configuration (customer > location precedence) OR use config embedded in Work Order
- POST partial approval submission (atomic)
- Handle errors: invalid state, approval window expired, auth/forbidden, conflicts

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Record Approval action is only enabled when Work Order is in the backend-defined â€œawaiting approvalâ€ status.
- Each approval-eligible line item must be set to either Approved or Declined before enabling Confirm.
- If approval method requires signature:
  - Signature/proof must be present before Confirm enabled.
- If approval window expired for re-approving a declined item:
  - UI must prevent submission if backend indicates expiration pre-check OR show backend error on submit.

### Enable/disable rules
- Disable Confirm until:
  - Data fully loaded
  - No validation errors
  - All line items have a selected decision
  - Required proof fields satisfied
- Disable per-line toggles if backend indicates line item not editable (read-only) due to state/time window.

### Visibility rules
- Approval method section renders based on resolved configuration:
  - `CLICK_CONFIRM` / â€œServiceAdvisorElectronicâ€ â†’ show confirmation checkbox + advisor identity stamp (read-only display) if required
  - `SIGNATURE` / `DIGITAL_SIGNATURE` â†’ show signature capture component placeholder + clear/reset action
  - `ELECTRONIC_SIGNATURE` / `VERBAL_CONFIRMATION` â†’ show appropriate fields **only if backend explicitly supports these for Work Orders** (otherwise hide and treat as unsupported)

### Error messaging expectations
- Invalid state: â€œApproval can only be recorded when the Work Order is awaiting approval.â€
- Window expired: â€œApproval Window has expired. A new estimate/work order is required.â€
- Permission denied: â€œYou donâ€™t have permission to record approvals for this Work Order.â€
- Conflict/concurrency: â€œThis Work Order was updated by someone else. Reload and try again.â€

---

## 8. Data Requirements

### Entities involved (frontend consumption)
- **WorkOrder**
  - `id`
  - `status` (enum/string)
  - `customerId`
  - `shopId/locationId` (for config resolution, if needed)
  - `totalApprovedAmount` (money/decimal)
  - `approvalWindowEnd` (datetime, optional)
  - `updatedAt` / `version` (for optimistic concurrency, if provided)
- **WorkOrderLineItem** (represents services/parts; exact entity types may differ)
  - `id`
  - `type` (SERVICE/PART)
  - `description`
  - `price` (money/decimal)
  - `approvalStatus` (PENDING/APPROVED/DECLINED)
  - `approvalTimestamp` (datetime, optional)
  - `declinedReason` (if supported; not defined in inputs)
  - `approvalMethodUsed` (enum, optional)
  - `approvalProofId` (optional)
- **ApprovalConfiguration** (resolved)
  - `approvalMethod` (enum)
  - `declineExpiryDays` or `approvalWindowDuration` (naming mismatch in backend references)
  - `requireSignature` (boolean)

### Fields: required/defaults
- For submission, required fields depend on backend contract:
  - WorkOrder id (required)
  - Line item decisions (required)
  - Approval method identifier (required)
  - Proof payload for signature (required only when method requires signature)

### Read-only vs editable by state/role
- Editable only when Work Order is in approval-recordable state.
- Line items editable only when:
  - `approvalStatus == PendingApproval` OR re-approval is allowed within window (backend driven)
- Everything is read-only after confirmation succeeds.

### Derived/calculated fields
- `totalApprovedAmountPreview` calculated client-side for immediate feedback; backend remains authoritative.
- `approvalWindowRemaining` can be derived if `approvalWindowEnd` is provided (display only).

---

## 9. Service Contracts (Frontend Perspective)

> NOTE: Backend reference documents show endpoints for **Estimates** approval configuration and approval actions; Work Order partial approval endpoints are not explicitly defined. This is a blocking clarification.

### Load/view calls
- `GET /api/workorders/{id}` (or `/api/work-orders/{id}`)  
  Expected response includes Work Order + line items with approval status.
- `GET /api/approval-configurations/applicable?locationId={id}&customerId={id}`  
  If Work Order payload does not already provide resolved approval configuration.

### Create/update calls (submit)
One of the following must exist (clarify which):
- `POST /api/work-orders/{workOrderId}/approvals/partial` (suggested)
- OR `POST /api/work-orders/{workOrderId}/approvals` with per-line statuses
- OR reuse estimate approval endpoints (unlikely; domain mismatch)

**Request (conceptual)**
```json
{
  "approvedBy": 123,
  "approvalMethod": "DIGITAL_SIGNATURE",
  "proof": { "signatureData": "..." },
  "lineItems": [
    { "lineItemId": "A", "approvalStatus": "APPROVED" },
    { "lineItemId": "B", "approvalStatus": "DECLINED" }
  ],
  "reasonNote": "optional"
}
```

**Response (conceptual)**
- 200/201 with updated Work Order summary:
  - `status`
  - `totalApprovedAmount`
  - updated line items approval fields

### Error handling expectations
- `400` validation (missing decisions, missing proof)
- `401` unauthenticated
- `403` unauthorized
- `404` not found
- `409` conflict (version mismatch / concurrent update / invalid transition)
- `422` (if used) for approval window expired; otherwise `400` with specific code

Frontend must map backend error codes/messages to user-friendly errors and keep raw details out of UI.

---

## 10. State Model & Transitions

### Allowed states (authoritative references)
WorkOrder state machine document defines:
- `DRAFT`, `APPROVED`, `ASSIGNED`, `WORK_IN_PROGRESS`, `AWAITING_PARTS`, `AWAITING_APPROVAL`, `READY_FOR_PICKUP`, `COMPLETED`, `CANCELLED`

### Approval-related expectations for this story
- Partial approval recording is allowed only when Work Order is in **`AWAITING_APPROVAL`** (per backend story reference wording â€œAwaitingApprovalâ€; reconcile enum naming).
- After confirmation:
  - If at least one item approved â†’ transition to a state that allows execution.  
    **Open question:** is this `APPROVED` or `WORK_IN_PROGRESS` or another state? The FSM doc does not mention `ApprovedForWork`.
  - If all declined â†’ transition to **`CANCELLED`** or another terminal declined state. FSM doc includes CANCELLED but not DECLINED, while backend story reference includes DECLINED.

### Role-based transitions
- Service Advisor can perform approval recording transition(s). Exact RBAC permissions are enforced server-side; UI will hide/disable based on capability flags if provided.

### UI behavior per state
- If not in eligible approval state: hide â€œRecord Approvalâ€ action; direct URL shows read-only error banner and back link.

---

## 11. Alternate / Error Flows

1. **Invalid state (user tries direct URL)**
   - Show error banner and disable form.
   - Provide â€œBack to Work Orderâ€ action.

2. **User cancels**
   - Prompt if dirty changes: â€œDiscard changes?â€ (safe UI default)
   - Navigate back without calling backend.

3. **Backend rejects due to approval window expired**
   - Keep user selections, show error, disable Confirm until reload OR allow user to adjust statuses to valid set (backend-driven).

4. **Concurrency conflict**
   - If backend returns 409: show â€œReload to continueâ€ with one-click reload that refetches Work Order and rehydrates UI.

5. **Unauthorized**
   - If 403: show not-authorized message and link back; do not expose action buttons.

6. **Empty states**
   - If Work Order has zero approval-eligible items: show message and disable Confirm; link back.

---

## 12. Acceptance Criteria

### Scenario 1: Successful partial approval (some approved, some declined)
**Given** a Service Advisor is authenticated  
**And** a Work Order is in `AWAITING_APPROVAL` state  
**And** the Work Order has 3 line items with `approvalStatus = PENDING_APPROVAL`  
**When** the advisor marks item 1 and 2 as `APPROVED` and item 3 as `DECLINED`  
**And** the advisor provides any required approval proof based on the resolved approval method  
**And** the advisor clicks â€œConfirm Approvalâ€  
**Then** the frontend sends a single atomic request containing all line item decisions and the approval method/proof  
**And** on success the UI displays updated line item approval statuses  
**And** the UI displays the backend-returned `totalApprovedAmount` equal to the sum of approved items  
**And** the UI navigates back (or refreshes) to show the Work Order in the post-approval status.

### Scenario 2: All items declined transitions to terminal decline/cancel state
**Given** a Work Order is in `AWAITING_APPROVAL`  
**And** it has 2 line items pending approval  
**When** the advisor marks both as `DECLINED` and confirms  
**Then** the UI shows the Work Order transitioned to the backend terminal â€œdeclined/cancelledâ€ state  
**And** `totalApprovedAmount` is shown as 0  
**And** the approval action is no longer available.

### Scenario 3: Record Approval is blocked for invalid Work Order state
**Given** a Work Order is in `WORK_IN_PROGRESS`  
**When** the advisor attempts to open the Record Approval screen  
**Then** the UI blocks editing and displays â€œApproval can only be recorded when the Work Order is awaiting approval.â€  
**And** no submit action is available.

### Scenario 4: Approval method configuration precedence (customer overrides location)
**Given** the applicable approval configuration for the Work Orderâ€™s customer specifies `DIGITAL_SIGNATURE`  
**And** the location default specifies `SERVICE_ADVISOR_ELECTRONIC`  
**When** the Record Approval screen loads  
**Then** the UI renders the digital signature proof capture requirement  
**And** submission is blocked until signature proof is provided  
**And** the submitted payload uses the customer-required method identifier.

### Scenario 5: Re-approval within approval window (if supported)
**Given** a line item is currently `DECLINED`  
**And** the backend indicates the Work Order is still within the approval window (e.g., `approvalWindowEnd` in the future)  
**When** the advisor changes that item to `APPROVED` and confirms  
**Then** the frontend submits the change successfully  
**And** the UI shows updated totals including the re-approved item  
**And** the UI displays any backend-provided indicator that a schedule amendment workflow was triggered (e.g., banner/message or returned flag).

### Scenario 6: Re-approval outside approval window is rejected
**Given** a line item is `DECLINED`  
**And** the backend indicates the approval window has expired  
**When** the advisor attempts to change the item to `APPROVED` and confirm  
**Then** the backend rejects the request  
**And** the UI displays â€œApproval Window has expired. A new estimate/work order is required.â€  
**And** no state change is shown locally as committed.

---

## 13. Audit & Observability

### User-visible audit data
- After successful confirmation, show (read-only):
  - approval recorded timestamp (from backend)
  - recorded by (user name/id if returned)
  - approval method used
  - proof reference presence (e.g., â€œSignature on fileâ€) without displaying sensitive payload

### Status history / traceability expectations
- Provide a link/button â€œView Approval/Transition Historyâ€ if the Work Order detail already supports transitions history; otherwise defer.
- Ensure frontend includes/propagates correlation ID headers if the repo uses them (per workspace convention; otherwise Open Question).

---

## 14. Non-Functional UI Requirements

- **Performance**: initial load under 2s on typical store network for â‰¤ 100 line items; show skeleton/loading state.
- **Accessibility**: WCAG 2.1 AA; keyboard navigable line item decisions; form errors announced.
- **Responsiveness**: usable on tablet width; line items list supports vertical scrolling.
- **i18n**: all user-visible strings via standard localization mechanism.
- **Timezone**: display timestamps in store/user timezone if available; otherwise user locale.
- **Currency**: display money using store currency formatting; no client-side currency conversion.

---

## 15. Applied Safe Defaults
- SD-UX-01 (Dirty form confirm): Prompt before discarding unsaved changes on Cancel/back; safe as itâ€™s UI ergonomics only. Impacted: UX Summary, Alternate Flows.
- SD-UX-02 (Loading/empty states): Use standard loading indicator and explicit empty-state message when no line items; safe as it does not alter business logic. Impacted: UX Summary, Error Flows.
- SD-ERR-01 (Generic error mapping): Map HTTP 401/403/404/409 to standard user-friendly banners while preserving backend error codes for logs; safe as itâ€™s presentation-layer handling. Impacted: Service Contracts, Error Flows.

---

## 16. Open Questions

1. **Work Order status enums and mapping:** Is the approval-recordable Work Order status exactly `AWAITING_APPROVAL` (FSM doc) or `AwaitingApproval` (backend story text), and what are the exact serialized values in the API?
2. **Post-approval Work Order state:** After partial approval with â‰¥1 approved item, what exact Work Order status should result? (FSM doc lacks `ApprovedForWork`; backend story references it.)
3. **Terminal decline state:** When all items are declined, does the Work Order become `DECLINED`, `CANCELLED`, or something else in the authoritative workexec FSM?
4. **API endpoint contract for partial approval on Work Orders:** What is the exact endpoint path, request schema, and response schema for submitting partial approval decisions on a Work Order?
5. **Line item model:** Are line items represented as separate entities for services and parts (e.g., `WorkOrderService` and `WorkOrderPart`) or a unified list in the Work Order API? What identifiers should the frontend send back?
6. **Approval method set:** For Work Orders, which approval methods are supported now (`CLICK_CONFIRM`, `SIGNATURE`, `ELECTRONIC_SIGNATURE`, `VERBAL_CONFIRMATION`), and which require proof payloads?
7. **Approval window source of truth:** Is `approvalWindowEnd` provided on Work Order, or must the frontend compute it from configuration? (Computing from config may violate safe-default restrictions if unclear.)
8. **Schedule amendment trigger:** When re-approving within window, what does â€œtrigger schedule amendment workflowâ€ mean for frontendâ€”does backend return a flag/message, or is there a separate UI flow to invoke?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Approval: Record Partial Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/269  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #22 - Approval: Record Partial Approval  
**URL**: https://github.com/louisburroughs/durion/issues/22  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---  
*Generated by Missing Issues Audit System - 2025-12-26T17:37:46.434850072*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #270: [FRONTEND] [STORY] Approval: Capture In-Person Customer Approval  
File: ./scripts/story-work/frontend/270/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Approval: Capture In-Person Customer Approval (Estimate)

### Primary Persona
Service Advisor

### Business Value
Provide a fast, auditable in-POS flow to record a customerâ€™s in-person approval on an estimate so authorized work can proceed, with a clear timestamped trail and correct enforcement of estimate state rules.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** to capture a customerâ€™s in-person approval on an estimate directly in the POS,  
**so that** the estimate is transitioned to an approved state with an immutable approval record and downstream work order creation can proceed.

### In-scope
- Viewing an estimate and its current approval configuration (method) as context for capture.
- Capturing **in-person** approval using the configured method (at minimum `CLICK_CONFIRM`).
- Optional entry of approval notes (if supported by backend; see Open Questions).
- Handling invalid state, authorization failures, and concurrency conflicts during approval.
- Showing updated estimate status and relevant audit metadata post-approval.

### Out-of-scope
- Electronic signature flows (email/SMS) and delivery of notifications.
- Signature capture UX (drawing pad) unless backend supports it explicitly.
- Full decline workflow and decline reason capture (separate story).
- Work order creation from estimate (separate story).
- Approval configuration management UI (separate story).

---

## 3. Actors & Stakeholders
- **Service Advisor (Primary)**: initiates capture and confirms approval.
- **Customer (External)**: provides consent in person (not a system user).
- **Technician/Mechanic (Stakeholder)**: relies on estimate being approved to begin work order execution.
- **Billing/Audit (Stakeholder)**: requires traceable approval record.

---

## 4. Preconditions & Dependencies
- User is authenticated in the POS frontend.
- User has permission to view the estimate and approve it (exact permission keys TBD; see Open Questions).
- Backend endpoints exist and are reachable:
  - `GET /api/estimates/{id}`
  - `POST /api/estimates/{id}/approve?approvedBy={userId}`
  - plus (optional/context) `GET /api/approval-configurations/applicable?locationId=&customerId=`
- Estimate exists and is in a start-eligible approval state:
  - Must be `DRAFT` per backend `approveEstimate()` contract in `CUSTOMER_APPROVAL_WORKFLOW.md`.
- Dependency: identity of logged-in user (userId) must be available to frontend.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Estimate detail screen: primary action button **â€œCapture In-Person Approvalâ€**.
- (Optional) From Estimate list row action menu: **â€œApprove (In Person)â€** that navigates to detail and opens confirmation dialog.

### Screens to create/modify
- **Modify**: `EstimateDetail` screen (or equivalent in repo) to include:
  - Current estimate status display.
  - Approval method display (derived from applicable configuration).
  - Action control to initiate approval.
  - A confirmation dialog/modal screenlet for approval confirmation and optional notes.
- **No new standalone screens required**; use dialog + transition.

### Navigation context
- Route: `/estimates/:estimateId` (exact path TBD to match project routing conventions; see Open Questions).
- After successful approval: remain on Estimate detail; refresh header/status panel.

### User workflows
**Happy path**
1. Service Advisor opens estimate detail.
2. Clicks â€œCapture In-Person Approvalâ€.
3. Sees confirmation dialog summarizing: estimate id, customer, total (if available on estimate), approval method.
4. Confirms.
5. UI shows success toast/banner; status updates to `APPROVED`; approval timestamp and approved-by fields appear.

**Alternate paths**
- If estimate not in `DRAFT`: approval action hidden/disabled with a reason message.
- If backend returns 409 conflict: show â€œEstimate was updated elsewhere; refreshâ€ with reload action.
- If unauthorized (401/403): show access error and prevent action.
- If backend unavailable: show retryable error.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œCapture In-Person Approvalâ€ on estimate detail.
- User confirms in modal/dialog.

### UI actions
- On click:
  - Validate locally that estimate status == `DRAFT` (based on loaded estimate).
  - Open confirmation dialog.
- On confirm:
  - Disable confirm button and show loading state.
  - Call backend approve endpoint with `approvedBy=<loggedInUserId>`.
  - On success: refresh estimate detail via GET and update UI.

### State changes (frontend-visible)
- Estimate status changes from `DRAFT` â†’ `APPROVED` in UI.
- Display of approval metadata becomes visible (approvedAt, approvedBy) if present in response.

### Service interactions
- Load estimate: `GET /api/estimates/{id}` on screen load and after successful approval.
- Optional config context:
  - If estimate response includes `approvalConfigurationId` and/or `approvalMethod`, display directly.
  - If not included, call applicable config endpoint using `shopId/locationId` and `customerId` from estimate (see Open Questions).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Approval may only be attempted when estimate status is `DRAFT`.
  - UI must disable/hide the approval action when status != `DRAFT`.
- Confirm step is required (at least click-to-confirm).

### Enable/disable rules
- â€œCapture In-Person Approvalâ€ button enabled only if:
  - Estimate loaded successfully
  - Status == `DRAFT`
  - User has approve permission (if frontend can infer; otherwise rely on backend 403 and show message)

### Visibility rules
- Show approval panel (approvedAt/approvedBy) only when status is `APPROVED` (or when fields exist).
- Show configuration/method label when available (e.g., `CLICK_CONFIRM`, `SIGNATURE`, etc.).

### Error messaging expectations
- Invalid state (400/409 depending on backend):  
  â€œThis estimate cannot be approved in its current state.â€
- Already approved:  
  â€œThis estimate is already approved.â€
- Concurrency conflict (409):  
  â€œThis estimate was updated by someone else. Refresh to continue.â€
- Forbidden (403):  
  â€œYou donâ€™t have permission to approve estimates.â€
- Not found (404):  
  â€œEstimate not found.â€

---

## 8. Data Requirements

### Entities involved (frontend view models)
- **Estimate**
  - `id: number` (required)
  - `status: enum(DRAFT, APPROVED, DECLINED, EXPIRED)` (required)
  - `shopId: number` (required for config lookup)
  - `customerId: number` (required for config lookup)
  - `approvalConfigurationId: number|null` (optional)
  - `approvedAt: datetime|null` (optional)
  - `approvedBy: number|null` (optional)
  - `declinedAt, expiresAt, declineReason` (out of scope but may appear)
- **ApprovalConfiguration** (read-only context)
  - `id: number`
  - `approvalMethod: enum(CLICK_CONFIRM, SIGNATURE, ELECTRONIC_SIGNATURE, VERBAL_CONFIRMATION)`
  - `declineExpiryDays: number`
  - `requireSignature: boolean`
  - `locationId: number|null`
  - `customerId: number|null`

### Fields: required/defaults
- No new persistent frontend fields.
- Confirmation dialog requires no mandatory input besides user confirmation.

### Read-only vs editable
- Estimate status and approval metadata: read-only.
- Any â€œapproval notesâ€ field: **blocked** until backend contract confirmed.

### Derived/calculated fields
- `canApprove = (estimate.status == DRAFT)`
- `effectiveApprovalMethod`:
  - Prefer estimate-provided method/config id if present
  - Else resolved via applicable config call (if implemented)

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls
1. `GET /api/estimates/{id}`
   - Expected: 200 + Estimate JSON; includes at least `id`, `status`, `shopId`, `customerId`.
   - Error: 404 if not found; 401/403 if unauthorized.

2. (Optional) `GET /api/approval-configurations/applicable?locationId={shopId or locationId}&customerId={customerId}`
   - Expected: 200 + config JSON.
   - Error: 404/200-null behavior unknown (see Open Questions).

### Submit/transition calls
1. `POST /api/estimates/{id}/approve?approvedBy={userId}`
   - Expected: 200 OK (or 201) returning updated Estimate, or minimal ack (if minimal, frontend must re-GET).
   - Validation error: 400 if status invalid.
   - Conflict: 409 if already approved or concurrent modification (backend-specific).
   - Forbidden: 403.

### Error handling expectations
- Map HTTP codes to user messages (see section 7).
- Always surface correlation/request id if response includes it (safe default: show in â€œdetailsâ€ expandable area only).

---

## 10. State Model & Transitions

### Allowed states (Estimate)
- `DRAFT`
- `APPROVED`
- `DECLINED`
- `EXPIRED`

### Transitions relevant to this story
- `DRAFT` â†’ `APPROVED` via approve action.
- All other transitions are not performed by this story.

### Role-based transitions
- Service Advisor can perform approval (subject to RBAC).
- Other roles: read-only unless authorized.

### UI behavior per state
- `DRAFT`: show approval action enabled.
- `APPROVED`: hide/disable approval action; show approval metadata.
- `DECLINED`/`EXPIRED`: hide/disable approval action; show status; no reopen in this story.

---

## 11. Alternate / Error Flows

### Validation failures
- User opens dialog but estimate has changed state since load:
  - On submit, backend returns 400/409 â†’ show error; refresh estimate; close dialog or keep open with disabled confirm.

### Concurrency conflicts
- If backend returns 409:
  - Show conflict message with â€œRefreshâ€ button; trigger reload GET.
  - Do not retry automatically.

### Unauthorized access
- If 401:
  - Redirect to login (per project pattern) and preserve return URL.
- If 403:
  - Show permission error; keep user on detail screen.

### Empty states
- Estimate detail load returns 404:
  - Show â€œEstimate not foundâ€ empty state with link back to estimate list.

---

## 12. Acceptance Criteria

### Scenario 1: Approve a Draft estimate in person (click confirm)
**Given** I am logged in as a Service Advisor  
**And** an Estimate exists with status `DRAFT`  
**When** I open the Estimate detail screen  
**And** I click â€œCapture In-Person Approvalâ€  
**And** I confirm the approval in the confirmation dialog  
**Then** the frontend calls `POST /api/estimates/{id}/approve?approvedBy={myUserId}`  
**And** the Estimate status displayed updates to `APPROVED` after success  
**And** the approval action is no longer available on the screen

### Scenario 2: Prevent approval when estimate is not Draft
**Given** I am viewing an Estimate with status `APPROVED`  
**When** the Estimate detail screen renders  
**Then** the â€œCapture In-Person Approvalâ€ action is disabled or hidden  
**And** if I attempt to call approval (e.g., via stale UI), the frontend displays â€œThis estimate is already approved.â€ (based on backend response)  
**And** the displayed status remains `APPROVED`

### Scenario 3: Backend rejects approval due to invalid state
**Given** I am viewing an Estimate with status `DECLINED`  
**When** I attempt to approve it  
**Then** the backend responds with an error (400/409)  
**And** the frontend displays â€œThis estimate cannot be approved in its current state.â€  
**And** no status change is shown

### Scenario 4: Concurrency conflict during approval
**Given** an Estimate is `DRAFT` when I load it  
**And** another user approves or modifies it before I confirm  
**When** I confirm in-person approval  
**Then** the backend responds `409 Conflict`  
**And** the frontend informs me the estimate was updated elsewhere  
**And** provides a â€œRefreshâ€ action that reloads the estimate detail

### Scenario 5: Unauthorized approval attempt
**Given** I am logged in without permission to approve estimates  
**And** I view a `DRAFT` estimate  
**When** I attempt to confirm approval  
**Then** the backend responds `403 Forbidden`  
**And** the frontend displays â€œYou donâ€™t have permission to approve estimates.â€  
**And** the estimate remains `DRAFT` in the UI after refresh

---

## 13. Audit & Observability

### User-visible audit data
- Show (if present in estimate payload):
  - `approvedAt` (UTC rendered in user locale)
  - `approvedBy` (user display name if resolvable; else show id)

### Status history
- Not required to implement full transition history UI in this story.
- If an existing â€œhistoryâ€ screenlet exists, ensure approval transition appears after refresh.

### Traceability expectations
- Frontend logs (console/dev) should include:
  - estimateId
  - action â€œapproveEstimateInPersonâ€
  - correlation id if returned by API headers/body (do not log PII)

---

## 14. Non-Functional UI Requirements

- **Performance**: initial estimate load < 2s on typical shop network; approval submit should show immediate loading feedback (<100ms).
- **Accessibility**: confirmation dialog must be keyboard-navigable; focus trapped within modal; buttons have accessible labels.
- **Responsiveness**: usable on tablet resolution used at service desk.
- **i18n/timezone**: display timestamps in user locale; store/submit timestamps are backend-owned UTC.
- **Currency**: if total shown, use existing formatting utilities; do not compute totals in frontend.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standardized empty/not-found state with link back to list; qualifies as safe UX ergonomics; impacts UX Summary, Error Flows.
- SD-ERR-HTTP-MAP: Standard mapping of HTTP 400/401/403/404/409/5xx to user-friendly messages without exposing internals; qualifies as safe error-handling; impacts Business Rules, Error Flows, Acceptance Criteria.
- SD-LOAD-SPINNER: Show loading indicator and disable submit during POST to prevent double-submit; qualifies as safe UX ergonomics; impacts Functional Behavior, Error Flows.

---

## 16. Open Questions

1. **Entity ambiguity (Estimate vs Work Order):** The backend reference for approval is **Estimate** (`POST /api/estimates/{id}/approve?approvedBy=`). The frontend issue title says â€œWork Orderâ€ in places. Should this frontend story implement **Estimate approval only**, or also Work Order approval? (Blocking: domain/contract)
2. **Approval configuration display:** Does `GET /api/estimates/{id}` include the effective `approvalMethod` (or `approvalConfigurationId`) needed to display method context? If not, should frontend call `GET /api/approval-configurations/applicable` and what is the exact parameter name: `locationId` vs `shopId`?
3. **Approval notes:** Is there a supported backend field for â€œapprovalNotesâ€ on estimate approval capture? If yes, what endpoint and payload/params support it? (Backend contract currently uses query param only.)
4. **RBAC/permissions:** What permission(s) or roles should gate visibility/enabled state of the approve action in the frontend (e.g., `ESTIMATE_APPROVE`)? Or must frontend rely solely on backend 403?
5. **Routing/screen names:** What are the canonical Moqui screen paths for estimate list/detail in this repo (e.g., `/apps/pos/estimate/Detail`)? Provide the expected route so the story can specify exact navigation metadata.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Approval: Capture In-Person Customer Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/270  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #21 - Approval: Capture In-Person Customer Approval  
**URL**: https://github.com/louisburroughs/durion/issues/21  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:37:49.112725374*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #271: [FRONTEND] [STORY] Approval: Capture Digital Customer Approval  
File: ./scripts/story-work/frontend/271/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Approval: Capture Digital Customer Approval (Estimate + Work Order)

### Primary Persona
Service Advisor (POS user)

### Business Value
Capture a non-repudiable, auditable digital approval (signature) for an Estimate or Work Order so the business can proceed with authorized work and retain legally defensible proof of consent.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** a POS UI flow to collect a customerâ€™s digital signature and submit it as a digital approval for an Estimate or Work Order,  
**so that** the entity transitions to Approved and we retain an immutable approval record for audit and dispute resolution.

### In-scope
- UI entry points from Estimate and Work Order views when an approval is required.
- Signature capture UX (strokes + rendered image) and submission to backend approval endpoints.
- Validation + error handling for invalid state, missing fields, authorization failures.
- Display of approval result (approvalId, timestamp, approver metadata if returned).
- Basic audit visibility: show â€œApprovedâ€ status and link/section for Approval record summary if API provides it.

### Out-of-scope
- Backend implementation (assumed provided by backend story).
- PDF signing / PDF rendering in frontend (only display reference if returned).
- Configuring approval methods (location/customer policy screens).
- Notifications (SMS/email) for electronic signature workflows.
- Editing estimate line items / versioning flows (covered elsewhere).

---

## 3. Actors & Stakeholders
- **Service Advisor (primary actor):** initiates approval capture in POS, guides customer.
- **Customer (external actor):** signs on device.
- **Audit/Compliance stakeholder:** requires immutable traceability and metadata.
- **Billing stakeholder (downstream):** relies on Approved state to proceed.

---

## 4. Preconditions & Dependencies
- User is authenticated in POS.
- A target **Estimate** or **Work Order** exists and is retrievable in the frontend.
- Target entity is in a backend-defined â€œapproval requiredâ€ state (backend story references `Pending Customer Approval`).
- Backend APIs available (see Service Contracts):
  - `POST /api/v1/estimates/{estimateId}/approvals`
  - `POST /api/v1/work-orders/{workOrderId}/approvals`
- Frontend has (or will add) a signature capture component capable of:
  - capturing stroke vectors (x/y/timestamp)
  - producing a PNG image encoded as Base64
- Routing exists to view Estimate and Work Order details.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Estimate Detail** screen: action â€œCapture Digital Approvalâ€ visible only when estimate status indicates approval is required.
- From **Work Order Detail** screen: action â€œCapture Digital Approvalâ€ visible only when work order status indicates approval is required.

### Screens to create/modify
1. **Modify** `EstimateDetail` screen
   - Add action to open approval capture screen/modal.
2. **Modify** `WorkOrderDetail` screen
   - Add action to open approval capture screen/modal.
3. **Create** a reusable approval capture screen:
   - `component://.../screen/workexec/approval/DigitalApprovalCapture.xml` (name illustrative)
   - Can be used for both entity types via parameters: `entityType`, `entityId`.
4. (Optional) **Create** a lightweight dialog wrapper screen for embedding in detail pages.

### Navigation context
- The approval capture screen must preserve context:
  - â€œBack to Estimateâ€ or â€œBack to Work Orderâ€
  - On success, return to originating detail screen and refresh entity data.

### User workflows
**Happy path (Estimate):**
1. Advisor opens Estimate detail in â€œPending Customer Approvalâ€.
2. Clicks â€œCapture Digital Approvalâ€.
3. Customer signs (draws) on device; advisor confirms signer details if required.
4. Advisor submits approval.
5. UI shows success + updates estimate status to Approved.

**Happy path (Work Order):**
Same flow via Work Order detail.

**Alternate paths:**
- Clear signature and re-sign.
- Cancel approval capture and return without changes.
- Submission rejected due to state change (409) â†’ show message and refresh entity.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œCapture Digital Approvalâ€ from Estimate/WorkOrder detail.

### UI actions
- Render signature canvas area and controls:
  - â€œClearâ€
  - â€œSubmit Approvalâ€
  - â€œCancelâ€
- On submit:
  - Validate signature is not empty.
  - Build request payload expected by backend:
    - `customerSignatureData.signatureImage` (Base64 PNG)
    - `customerSignatureData.signatureStrokes` (array) (if required/available)
    - `approvalPayload` (object)
    - (Optional) `intentId` if backend requires anti-replay token (unclear; see Open Questions)
  - Call correct endpoint based on entityType.

### State changes (frontend)
- While submitting: show loading state; disable inputs to prevent double submit.
- On success (201):
  - Show confirmation (toast + inline summary).
  - Navigate back to detail screen and refresh entity.
- On failure:
  - Map HTTP code to user-friendly message and keep user on capture screen (unless unrecoverable like 404).

### Service interactions
- GET (existing) to load entity detail (Estimate/WorkOrder).
- POST approval capture to backend endpoints listed above.
- Optional: GET approval detail endpoint if available (not defined in provided inputs; do not assume).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Signature required**: â€œSubmit Approvalâ€ is disabled until signature canvas contains strokes (or a non-empty image can be generated).
- **Entity must be approval-eligible**:
  - If detail screen indicates not in approval-required state, hide action.
  - If user deep-links to capture screen and entity is not eligible, show blocking error and provide navigation back.
- **Immutable approval**: after success, UI must treat approval as final (do not allow â€œedit approvalâ€).
- **One approval per entity version**: if backend rejects due to already approved/version mismatch, show conflict message (409) and refresh detail.

### Enable/disable rules
- Disable â€œSubmit Approvalâ€ while:
  - signature empty
  - submit in progress
- Disable â€œClearâ€ while submit in progress.

### Visibility rules
- Capture action visible only when entity status matches â€œPending Customer Approvalâ€ (exact status string/enums may differ; needs mappingâ€”see Open Questions).

### Error messaging expectations
- 400: â€œApproval could not be submitted. Please complete required fields and try again.â€
- 403: â€œYou donâ€™t have permission to record approvals.â€
- 404: â€œThis estimate/work order could not be found.â€
- 409: â€œThis estimate/work order is no longer awaiting approval (it may have been approved or changed). Refreshing status.â€

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- **Estimate** (read)
  - `id`
  - `status`
  - (If available) `currency`, `totalAmount`, `lineItemsSummary`, `version`/`documentDigest`
- **WorkOrder** (read)
  - `id`
  - `status`
  - (If available) `currency`, `totalAmount`, `lineItemsSummary`, `version`/`documentDigest`
- **Approval** (write via API; read optional if returned)
  - `approvalId` (UUID)
  - `entityType`
  - `entityId`
  - `approvalTimestamp`
  - `payloadHash`
  - `approverIpAddress` (likely server-derived; display not required)
  - `approverUserAgent` (server-derived; display not required)
  - `pdfSignatureReference` (optional)

### Fields captured in UI (with types)
- `entityType`: enum `{Estimate, WorkOrder}` (required; passed via route params)
- `entityId`: string/UUID (required; passed via route params)
- `customerSignatureData.signatureImage`: string Base64 PNG (required)
- `customerSignatureData.signatureStrokes`: array of `{x:number, y:number, t:number}` or similar (optional unless backend requires)
- `approvalPayload`: JSON object (required; exact schema unclearâ€”see Open Questions)
- `intentId`: string (optional; unclearâ€”see Open Questions)
- `signerUserId`: string/number (unclear whether customer vs advisor identity; see Open Questions)

### Read-only vs editable
- Entity identifiers and computed approval payload fields are read-only.
- Signature is editable until submitted.
- Post-submit, all fields are read-only and screen navigates away or locks.

### Derived/calculated fields
- Rendered PNG image derived from strokes/canvas.
- If UI constructs `approvalPayload` from entity details (amount, currency, digest), these are derived and should be displayed in a â€œYou are approving:â€ summary.

---

## 9. Service Contracts (Frontend Perspective)

> Note: Backend story uses `/api/v1/...` paths; frontend must align exactly. If current frontend uses a different base path/proxy, adapt via existing API client config.

### Load/view calls
- `GET /api/v1/estimates/{estimateId}` (assumed exists because listing/get is in customer approval workflow doc)
- `GET /api/v1/work-orders/{workOrderId}` (not explicitly listed in provided docs; dependency)

### Create/update calls (approval capture)
- `POST /api/v1/estimates/{estimateId}/approvals`
  - **Request body** (minimum):
    ```json
    {
      "customerSignatureData": {
        "signatureImage": "<base64-png>",
        "signatureStrokes": [ /* optional */ ]
      },
      "approvalPayload": { /* required */ }
    }
    ```
  - **Response**: `201 Created` with `approvalId` (exact response shape unspecified)

- `POST /api/v1/work-orders/{workOrderId}/approvals`
  - Same shape as above.

### Submit/transition calls
- The POST implicitly transitions entity status to `Approved` on success.

### Error handling expectations
- 400 Bad Request: missing required fields, integrity mismatch
- 403 Forbidden: authorization failure
- 404 Not Found: entity missing
- 409 Conflict: invalid state (already approved, in progress, etc.)
- 5xx: show generic error + allow retry

---

## 10. State Model & Transitions

### Relevant states (from provided backend story text)
For approval target entity (Estimate/WorkOrder), the UI must handle at least:
- `Pending Customer Approval` â†’ `Approved` (via digital approval)
- Rejection cases where entity is in:
  - `Approved`
  - `In Progress`
  - `Denied`
  - `On Hold`
  - `Transferred`

### Role-based transitions
- Service Advisor initiates approval capture.
- Backend enforces permissions; frontend should not attempt to replicate RBAC logic beyond hiding controls when possible.

### UI behavior per state
- **Pending Customer Approval**: show â€œCapture Digital Approvalâ€
- **Approved**: hide capture action; show approval summary if available
- **Other non-eligible states**: hide capture action; if user navigates directly, show â€œNot eligible for approvalâ€ message

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Empty signature â†’ inline error â€œSignature is required.â€
- Unable to generate PNG from canvas â†’ block submit, show â€œUnable to capture signature, please try again.â€

### Backend validation failures
- 400 missing fields â†’ show backend validation message if provided; otherwise generic.
- 400 integrity error (payload hash mismatch / tampering) â†’ show â€œApproval payload validation failed. Please reload and try again.â€

### Concurrency conflicts
- Another user approves while this user is signing â†’ POST returns 409; UI must:
  1) show conflict message
  2) provide â€œRefreshâ€ action that reloads entity and exits capture screen if no longer eligible

### Unauthorized access
- 403 â†’ show permission error; provide navigation back to detail.

### Empty states
- Entity detail load fails (404) â†’ show not found; disable approval capture and offer return to list.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Capture digital approval for Work Order (success)
Given a Work Order with id "WO-123" is in status "Pending Customer Approval"  
And the Service Advisor is on the Work Order detail screen  
When the user selects "Capture Digital Approval"  
And the customer provides a non-empty signature  
And the user submits the approval  
Then the system sends a POST request to `/api/v1/work-orders/WO-123/approvals` containing `customerSignatureData.signatureImage` and `approvalPayload`  
And the UI displays a success confirmation  
And the Work Order detail is refreshed and shows status "Approved"

### Scenario 2: Capture digital approval for Estimate (success)
Given an Estimate with id "EST-456" is in status "Pending Customer Approval"  
When the user captures a non-empty signature and submits approval  
Then the system POSTs to `/api/v1/estimates/EST-456/approvals`  
And the UI refreshes the Estimate detail to show status "Approved"

### Scenario 3: Prevent submit when signature is empty
Given the user is on the digital approval capture screen for a pending entity  
When the signature area is empty  
Then the "Submit Approval" action is disabled  
And attempting to submit shows "Signature is required."

### Scenario 4: Backend rejects due to invalid state (409)
Given a Work Order "WO-456" is already in status "Approved"  
When the user submits a digital approval to `/api/v1/work-orders/WO-456/approvals`  
Then the UI shows a conflict message indicating the work order is no longer awaiting approval  
And the UI offers to refresh and returns to the Work Order detail screen

### Scenario 5: Backend rejects due to incomplete payload (400)
Given a Work Order "WO-123" is in status "Pending Customer Approval"  
When the user submits approval without required `customerSignatureData` fields  
Then the UI displays a validation error  
And the Work Order status remains unchanged in the UI after refresh

### Scenario 6: Unauthorized approval attempt (403)
Given the current user lacks permission to record approvals  
When they submit a digital approval  
Then the UI shows a permission error  
And no local state is marked as approved

---

## 13. Audit & Observability

### User-visible audit data
- After successful approval, show at minimum:
  - â€œApprovedâ€ status
  - approval timestamp (if returned or from refreshed entity)
  - approvalId (if returned)
  - approval method = â€œDigital Signatureâ€ (label in UI)

### Status history
- If Work Order / Estimate detail includes a â€œhistoryâ€ section, it should reflect the status change after refresh.
- No new history UI is required unless existing pattern exists.

### Traceability expectations
- Frontend should include correlation/request id headers if the project standard supports it (do not invent header names; use existing API client conventions).

---

## 14. Non-Functional UI Requirements

- **Performance:** signature capture must remain responsive; avoid heavy re-renders while drawing.
- **Accessibility (WCAG 2.1):**
  - Provide keyboard-accessible controls for Clear/Submit/Cancel.
  - Provide text alternative explaining how to sign.
  - Ensure sufficient contrast and focus indicators.
- **Responsiveness:** works on tablet resolution and desktop; signature area scales appropriately.
- **i18n/timezone/currency:** display amounts/currency in entity summary using existing formatting utilities (no new currency rules invented).

---

## 15. Applied Safe Defaults
- none

---

## 16. Open Questions

1. **Status mapping:** What are the exact backend status values for â€œPending Customer Approvalâ€ and â€œApprovedâ€ for **Work Orders** and **Estimates** in the POS UI payloads? (Needed to correctly show/hide entry points and handle deep links.)
2. **ApprovalPayload schema:** What is the exact required shape of `approvalPayload` for the POST endpoints (required keys: `originType`, `originId`, `documentDigest`/`originVersion`, `amount`, `currency`, `lineItemsSummary`, `signerUserId`, `timestamp`)? Provide example request/response bodies.
3. **Intent/anti-replay:** Does the frontend need to request or include an `intentId` (single-use token) before submitting approval? If yes, what endpoint issues it and what is its TTL?
4. **Work Order endpoints:** The workexec docs list `/api/v1/work-orders/{workOrderId}/approvals` but other docs use `/api/workorders/{id}/start`. What is the canonical base path and naming for work order APIs in this environment?
5. **Signature strokes requirement:** Are stroke vectors required by backend or optional? If required, what coordinate system and timestamp format should be used?
6. **Signer identity:** Is `signerUserId` the **customer** identifier, the **advisor**, or omitted/derived? If customer, how is the customer identity represented/authenticated for in-store signing?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Approval: Capture Digital Customer Approval  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/271  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #20 - Approval: Capture Digital Customer Approval  
**URL**: https://github.com/louisburroughs/durion/issues/20  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:37:51.888477534*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #78: [FRONTEND] [STORY] Workexec: Display Work In Progress Status for Active Workorders â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/78
File: ./scripts/story-work/frontend/78/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Workexec: WIP Dashboard for Active Work Orders (Status, Assignment, Drilldown, Realtime Updates)

### Primary Persona
Counter Associate

### Business Value
Enable counter staff to provide accurate, timely work-in-progress (WIP) updates to customers by showing current work order execution status, assignment context (mechanic/bay/location), and recent status changes in near real time.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Counter Associate  
- **I want** a WIP dashboard that shows current execution status for active work orders and allows drilling into a work orderâ€™s details/history  
- **So that** I can quickly answer customer â€œwhatâ€™s the status?â€ questions and manage expectations.

### In-scope
- A WIP list view for active work orders with:
  - Canonical work order execution status (workexec state machine)
  - Assignment context (mechanic + bay/location) when available
  - â€œLast updatedâ€ / staleness indicator
  - Drilldown to a work order detail view/panel
- Data refresh via real-time updates **or** polling fallback (as available)
- Basic filtering (status/mechanic/location) and empty/loading/error states
- Moqui screen implementation (screens/forms/transitions) and Vue/Quasar frontend components integrated via Moqui

### Out-of-scope
- Changing work order state from this UI (no â€œforce start/completeâ€)
- Implementing backend SSE/event infrastructure if not already present
- Building/owning Shop Management assignment logic (SoR outside workexec)
- Detailed inventory parts breakdown beyond what backend provides for WIP (unless explicitly available)
- Automatic customer notifications (manual â€œsend updateâ€ not included unless clarified)

---

## 3. Actors & Stakeholders
- **Counter Associate (primary)**: consumes WIP list + detail to answer customers
- **Mechanic / Technician**: updates work order status in workexec (not via this UI)
- **Shop Manager / Dispatcher**: owns assignment decisions (mechanic/bay/location)
- **Workexec backend**: authoritative work order status + transition history
- **Shop management backend** (if separate): authoritative assignment context
- **Audit / Observability consumers**: rely on traceability of state changes and view refresh failures

---

## 4. Preconditions & Dependencies
- User is authenticated in the POS frontend.
- Work orders exist with statuses from the workexec state machine (see â€œState Model & Transitionsâ€).
- Backend endpoints exist (or will exist) to:
  - list WIP work orders for a location/user scope
  - fetch work order WIP detail including status history
  - (optional) stream status change events or provide event polling support
- Permission model exists to scope which locations the user can view.

**Hard dependency clarifications needed**
- Exact backend API paths, response schemas, and auth headers for:
  - WIP list
  - WIP detail
  - event stream (SSE) vs polling endpoint
- How â€œassignment contextâ€ is retrieved (same endpoint vs separate service call).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- POS navigation: â€œWork In Progressâ€ (WIP) item available to Counter Associate users.
- Deep link: `/wip` and `/wip/{workOrderId}` (or equivalent Moqui screen path) for drilldown.

### Screens to create/modify (Moqui)
1. **`WorkexecWip.xml` screen** (new)
   - Root screen for WIP dashboard list
2. **`WorkexecWipDetail.xml` screen** (new or embedded as subscreen/dialog)
   - Work order detail panel/screen: status history + key identifiers
3. **Reusable components**
   - `WipWorkOrderTable` Vue component (Quasar table)
   - `WipWorkOrderDetailPanel` Vue component
   - `WipStalenessBanner` component

### Navigation context
- From dashboard list, selecting a row opens:
  - either a right-side detail panel (preferred for fast workflow) **or**
  - a separate detail route/screen.
- Provide breadcrumb/back to WIP list.

### User workflows
**Happy path**
1. Counter Associate opens WIP dashboard
2. System loads active work orders within allowed scope
3. User optionally filters by status/mechanic/location
4. User clicks a work order row â†’ detail view opens
5. If status changes arrive (event/poll), UI updates list and detail (if open)

**Alternate paths**
- No active work orders â†’ show empty state
- Backend unavailable â†’ show stale/cached view indication + retry
- User lacks permission for selected location â†’ show authorization error and offer switching to allowed location (if available)

---

## 6. Functional Behavior

### Triggers
- Screen load of WIP dashboard
- User changes filter/sort
- Timer tick for polling refresh (fallback)
- Receipt of WIP status change event (if SSE enabled)
- User selects a work order row to open detail

### UI actions
- Load WIP list (initial + refresh)
- Subscribe/unsubscribe to event stream scoped by location (if configured)
- Open detail view and load detail payload
- Display staleness: last refresh timestamp + â€œupdates pausedâ€ banner when disconnected
- Manual â€œRetry connectionâ€ action to reattempt SSE/polling

### State changes (frontend)
- Local store state:
  - `wipList[]`
  - `selectedWorkOrderId`
  - `detail` payload
  - `connectionMode` = `SSE` | `POLLING` | `DISCONNECTED`
  - `lastUpdatedAt` timestamp
  - `isStale` boolean computed

### Service interactions (frontendâ†’backend)
- `GET WIP list` on load and refresh
- `GET WIP detail` on drilldown
- `SSE subscribe` (if supported) with fallback to polling

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Filters:
  - Status filter values must match supported workexec statuses (see State Model); invalid status filter should be rejected client-side and not sent.
- Drilldown:
  - WorkOrderId must be a valid identifier; if detail load returns 404, show â€œWork order not found or no longer visible.â€

### Enable/disable rules
- If user cannot view all locations:
  - Location selector disabled or limited to allowed locations.
- If connection lost:
  - Show retry action enabled
  - Auto-refresh pauses after repeated failures (see Error Flows)

### Visibility rules
- Show assignment context fields only if present; otherwise show â€œUnassignedâ€.
- Show â€œLast updatedâ€ always.
- Show staleness warning if `now - lastUpdatedAt > stalenessThresholdSeconds`.

### Error messaging expectations
- Backend timeout/unavailable: â€œReal-time updates unavailable; last updated {timestamp}. Retry.â€
- Unauthorized/forbidden: â€œYou do not have access to this locationâ€™s work orders.â€
- Generic: â€œUnable to load work-in-progress list. Try again.â€

---

## 8. Data Requirements

### Entities involved (frontend view models)
> Note: Entities below are â€œview modelsâ€ for UI; actual Moqui entities/services must map to backend payloads.

- `WorkOrderStatusView` (read model)
- `AssignmentView` (assignment context)
- `WorkOrderStateTransition` (history rows) â€” as a DTO/view model
- `EventSubscription` (SSE connection state) â€” frontend-only

### Fields (type, required, defaults)
**WIP List row (minimum required for buildability)**
- `workOrderId` (string/number, required)
- `status` (enum string, required)
- `statusLabel` (string, optional if backend provides display mapping)
- `updatedAt` (datetime UTC, required)
- `customerName` (string, optional â€” depends on privacy/policy)
- `vehicleSummary` (string, optional)
- `assignedMechanicName` (string, optional)
- `assignedLocationName` (string, optional)
- `assignedBay` (string, optional)

**WIP Detail (minimum)**
- `workOrderId` (required)
- `status` (required)
- `statusHistory[]` where each item:
  - `fromStatus` (enum, required)
  - `toStatus` (enum, required)
  - `transitionedAt` (datetime UTC, required)
  - `transitionedBy` (user id/name, optional depending on policy)
  - `reason` (string, optional)

### Read-only vs editable
- All WIP fields are read-only in this story.

### Derived/calculated fields
- `isStale` = `now - lastUpdatedAt > threshold`
- â€œLast updated X seconds agoâ€ derived display string

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is partially defined in backend story reference, but **not guaranteed** for this frontend repo; treat as needing confirmation.

### Load/view calls
1. **WIP list**
   - Proposed: `GET /wip?locationId={id}&status=...&includeAssignments=true`
   - Returns: paginated `WorkOrderStatusView[]`
2. **WIP detail**
   - Proposed: `GET /wip/{workOrderId}`
   - Returns: `WorkOrderStatusView` + `statusHistory[]` (+ assignmentContext)

### Submit/transition calls
- None (view-only story)

### Event stream (optional)
- Proposed SSE: `GET /events/wip?locationId={id}`
- Event: `WorkorderStatusChanged` containing `workOrderId`, `newStatus`, `updatedAt`, optional `reason`, optional `assignmentContext`

### Error handling expectations
- `401/403`: route to login or show â€œnot authorizedâ€ inline depending on app convention
- `404` detail: show not found message and return to list
- `409` (if returned for concurrency): refresh list and show â€œUpdated while you were viewingâ€
- Network/timeout: show banner, pause SSE, fall back to polling if configured

---

## 10. State Model & Transitions

### Allowed states (authoritative from workexec state machine doc)
- `DRAFT`
- `APPROVED`
- `ASSIGNED`
- `WORK_IN_PROGRESS`
- `AWAITING_PARTS`
- `AWAITING_APPROVAL`
- `READY_FOR_PICKUP`
- `COMPLETED`
- `CANCELLED`

### What counts as â€œActiveâ€ for WIP list (needs confirmation)
Backend reference mentions statuses like â€œSCHEDULED, WAITING, IN_PROGRESSâ€¦â€ which **do not match** the documented workexec enum above. This is a conflict that must be clarified.

**UI behavior per state (once clarified)**
- Map each canonical status to a display bucket:
  - â€œWaitingâ€ (likely `APPROVED`/`ASSIGNED`)
  - â€œIn Progressâ€ (`WORK_IN_PROGRESS`)
  - â€œParts Pendingâ€ (`AWAITING_PARTS`)
  - â€œApproval Pendingâ€ (`AWAITING_APPROVAL`)
  - â€œReadyâ€ (`READY_FOR_PICKUP`)
  - â€œCompletedâ€ (`COMPLETED`)
  - â€œCancelledâ€ (`CANCELLED`)
- Show terminal states only if user includes â€œShow completed/cancelledâ€ filter toggle.

### Role-based transitions
- Not applicable (view-only), but visibility may be role-scoped.

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid filter status values â†’ show inline error and reset to â€œAll statusesâ€.

### Concurrency conflicts
- If SSE/poll refresh updates a work order while detail is open:
  - highlight changed status field
  - append new history row without losing scroll position (best-effort)
  - show message â€œStatus updated while viewingâ€

### Unauthorized access
- If list call returns 403:
  - show full-page â€œNot authorized to view WIP for this locationâ€
  - if multiple locations supported, prompt to select another allowed location

### Empty states
- No active work orders:
  - show â€œNo work in progressâ€ plus last refresh timestamp
  - keep refresh mechanism active

### Dependency failures
- SSE fails to connect:
  - switch to polling (if enabled)
  - show â€œRealtime unavailable; using pollingâ€
- Polling fails repeatedly:
  - show â€œUpdates pausedâ€ and require user to click Retry

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Load WIP list (happy path)
**Given** the Counter Associate is authenticated and has access to a location  
**When** they open the WIP dashboard  
**Then** the system loads and displays a list of active work orders for that location  
**And** each row shows workOrderId and current status  
**And** each row shows assignment context when available or â€œUnassignedâ€ when not.

### Scenario 2: Drill into work order detail
**Given** the WIP list is displayed  
**When** the user selects a work order  
**Then** the UI loads and displays work order details including current status and status history (timestamps)  
**And** the user can return to the list without losing current filters.

### Scenario 3: Realtime update via event stream
**Given** the WIP dashboard is open and SSE connection is active  
**When** a status change event is received for a listed work order  
**Then** the status in the list updates within 5 seconds  
**And** the â€œlast updatedâ€ timestamp updates  
**And** if that work orderâ€™s detail view is open, the detail view updates to reflect the new status and history entry.

### Scenario 4: Polling fallback
**Given** the WIP dashboard is open and SSE is unavailable  
**When** the polling interval elapses  
**Then** the UI refreshes the WIP list automatically  
**And** reflects any status changes returned by the backend  
**And** displays the last updated timestamp.

### Scenario 5: Staleness indicator
**Given** the WIP dashboard has not successfully refreshed within the configured staleness threshold  
**When** the user views the dashboard  
**Then** the UI displays a staleness warning including the last successful updated time  
**And** provides a â€œRetryâ€ action.

### Scenario 6: Unauthorized location
**Given** the user attempts to load WIP for a location they are not permitted to view  
**When** the backend returns 403  
**Then** the UI shows an authorization error  
**And** does not display any work orders for that location.

---

## 13. Audit & Observability

### User-visible audit data
- In detail view, show status history entries (timestamp, fromâ†’to, optional reason)

### Status history
- Must be ordered newest-first (or explicitly specified) and stable across refreshes.

### Traceability expectations
- Frontend logs (console/app logger per project convention) should include:
  - correlation/request id if provided by backend headers
  - connection mode changes (SSEâ†’polling)
  - refresh failures with status codes (no PII)

---

## 14. Non-Functional UI Requirements

- **Performance**: initial list load should not block interaction; show loading skeleton/table spinner.
- **Accessibility**: table and detail panel keyboard-navigable; status changes announced via aria-live region (for screen readers) when feasible.
- **Responsiveness**: usable on tablet widths; detail panel may become full-screen on small screens.
- **i18n/timezone**: timestamps displayed in store/user timezone (needs confirmation of app standard); backend timestamps assumed UTC.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty/loading/error states for list and detail views; safe as it does not change domain policy. Impacted sections: UX Summary, Error Flows.
- SD-UX-POLLING-FALLBACK: If SSE is unavailable, enable a configurable polling refresh interval (default 30s) and staleness threshold (default 60s) as UI ergonomics; safe because it only affects refresh cadence/display, not business rules. Impacted: Functional Behavior, Error Flows, Acceptance Criteria.
- SD-OBS-CLIENT-LOGGING: Log connection mode transitions and request failures without PII; safe observability boilerplate. Impacted: Audit & Observability, Error Flows.

---

## 16. Open Questions

1. **Backend contract**: What are the exact Moqui-accessible endpoints for WIP list, WIP detail, and (if present) SSE events (paths, query params, schemas, pagination)?  
2. **Status taxonomy conflict**: The backend story mentions statuses like `SCHEDULED/WAITING/IN_PROGRESS`, but the authoritative workexec FSM defines `APPROVED/ASSIGNED/WORK_IN_PROGRESS/...`. What is the canonical set the frontend must use and what exactly is considered â€œactiveâ€ for the WIP dashboard?  
3. **Assignment source**: Is assignment context returned by the same WIP endpoints, or must the frontend call a separate shop management API? If separate, what is the contract and caching strategy?  
4. **Permissions**: What is the exact permission/role name(s) controlling multi-location visibility (e.g., `WIP_VIEW_ALL_LOCATIONS`) and how is it exposed to the frontend (claims, user context service, etc.)?  
5. **PII policy**: May the WIP list/detail display customer name/phone and vehicle VIN, or should it show anonymized identifiers only?  
6. **Realtime transport**: Is SSE supported in this frontend/Moqui setup, or should we implement polling only for now? If SSE, what authentication mechanism is used for the event stream?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Workexec: Display Work In Progress Status for Active Workorders â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/78

```
/kiro
# User Story

## Narrative
As a **Counter associate**, I want to see WIP status so that I can provide accurate updates.

## Details
- Show status by workorder: waiting, in progress, parts pending, ready, completed.
- Display assigned mechanic/location if available.

## Acceptance Criteria
- WIP view updates from events or polling.
- Status mapping consistent.
- Drilldown available.

## Integrations
- Workexec emits status events; shopmgr provides assignment context.

## Data / Entities
- WorkorderStatusView, AssignmentView, EventSubscription

## Classification (confirm labels)
- Type: Story
- Layer: Experience
- domain :  Point of Sale

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #79: [FRONTEND] [STORY] Workexec: Retrieve and Display Estimates for Customer/Vehicle  
File: ./scripts/story-work/frontend/79/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Workexec: Retrieve and Display Estimates for Customer/Vehicle

## Primary Persona
Service Advisor

## Business Value
Enable Service Advisors to quickly find and review estimates tied to a specific customer and/or vehicle, understand current status and totals, and navigate into an estimate detail view to support downstream actions (appointment creation, checkout) with correct context and permissions.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Service Advisor  
- **I want** to retrieve and view estimate lists for a given customer or vehicle, and drill into an estimate to see its details  
- **So that** I can confidently proceed from quote review to scheduling or checkout with accurate status, totals, and notes

## In-scope
- Customer- or vehicle-scoped estimate search entry points (from customer or vehicle context)
- Paginated list view of estimates with status, totals, and â€œlast updatedâ€
- Estimate detail view with line items and notes
- Permission-aware visibility (only show estimates user is allowed to view)
- Handling of â€œexpiredâ€ estimates (warning + disable â€œCreate Appointmentâ€ action) **if and only if** the backend provides expiry/validity fields needed to determine this
- â€œRetryâ€ behavior and user-friendly error messages for service failures

## Out-of-scope
- Editing estimate line items or changing estimate status (approval/decline/reopen)
- Estimate cloning/repricing (backend reference mentions it; not requested in provided frontend story)
- Appointment creation UI itself (only link/transition with preserved parameters)
- SSE/event subscription implementation unless already standardized in this frontend repo patterns (unknown from provided inputs)

---

# 3. Actors & Stakeholders
- **Primary user:** Service Advisor
- **Secondary:** Shop Manager (viewing across locations; permission scope not defined here)
- **System actors:** Workexec backend APIs (estimate read)
- **Stakeholders:** Operations (speed), Compliance/Audit (traceability), Customer experience (accuracy)

---

# 4. Preconditions & Dependencies
- User is authenticated in the POS frontend.
- Workexec backend provides estimate read APIs (list + detail). (Exact paths/params must be confirmed; see Open Questions.)
- Customer and Vehicle context pages exist (or an equivalent global search exists) to provide `customerId` and/or `vehicleId`.
- Permission model exists server-side; frontend must handle 401/403 gracefully and avoid leaking cross-location data.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- From **Customer** context: â€œEstimatesâ€ action/tab opens estimates list filtered by `customerId`.
- From **Vehicle** context: â€œEstimatesâ€ action/tab opens estimates list filtered by `vehicleId`.
- Optional: if a global search already exists, allow navigating into the same screen with query params.

## Screens to create/modify (Moqui)
Create/modify Moqui screens under the workexec area (exact location depends on repo conventions; to be aligned with existing menu/screen tree):
1. **Estimate List Screen**
   - Route accepts `customerId` and/or `vehicleId` (at least one required)
   - Displays list of `EstimateSummary`
2. **Estimate Detail Screen**
   - Route accepts `estimateId` (required)
   - Displays `EstimateDetail` including lines + notes
3. Update Customer/Vehicle screens to add navigation transition(s) into Estimate List Screen while preserving context.

## Navigation context
- Preserve query params on drilldown and â€œBack to listâ€:
  - `customerId`, `vehicleId`
  - Any applied filters/sort/page state (at minimum page + filters; mechanism depends on frontend conventions)

## User workflows
### Happy path
1. Service Advisor opens customer (or vehicle) record
2. Clicks â€œEstimatesâ€
3. Sees a list of estimates (open/draft/approved per rules)
4. Clicks an estimate row
5. Sees estimate detail with lines and notes
6. Navigates back to the list, preserving filter/sort/page

### Alternate paths
- No estimates found â†’ empty state explaining no results for that customer/vehicle
- Unauthorized estimate access â†’ show permission denial state; do not reveal estimate content
- Backend unavailable â†’ show retry + optional cached timestamp if supported by frontend caching layer

---

# 6. Functional Behavior

## Triggers
- Entering the estimate list screen with `customerId` and/or `vehicleId`
- Changing filters/sort/pagination on list
- Selecting an estimate row
- Entering the estimate detail screen with `estimateId`

## UI actions
### Estimate List
- Load list automatically on screen load
- Provide controls for:
  - Status filter (at minimum: Draft/Open/Approved if those exist)
  - Sort by last updated (default descending)
  - Pagination controls

### Estimate Detail
- Load detail automatically on screen load
- Show:
  - Header context (estimate identifier, status, last updated)
  - Line items
  - Notes (as provided)
- Provide:
  - â€œBackâ€ navigation to list with preserved context

## State changes (frontend view-state)
- List screen maintains view-state: `loading | loaded | error | empty`
- Detail screen maintains view-state: `loading | loaded | error | notFound | forbidden`

## Service interactions
- List: call â€œestimate listâ€ endpoint with either customerId or vehicleId
- Detail: call â€œestimate detailâ€ endpoint by estimateId
- Error mapping based on HTTP status:
  - 401 â†’ show â€œSession expiredâ€ pattern and route to login if that exists
  - 403 â†’ show â€œYou do not have access to this estimateâ€
  - 404 â†’ show â€œEstimate not foundâ€
  - 5xx / network â†’ show â€œUnable to load estimates; service temporarily unavailableâ€ with Retry

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- List screen requires at least one of:
  - `customerId` OR `vehicleId`
- If neither provided:
  - Show blocking inline error â€œSelect a customer or vehicle to view estimates.â€ and do not call backend.

## Enable/disable rules
- Drilldown row action is enabled only when row has a valid `estimateId`.
- If backend supplies `isExpired` or `expiresAt`:
  - Show an â€œExpiredâ€ warning banner on detail when expired.
  - Disable â€œCreate Appointmentâ€ action if present on this screen (only if this story includes that action; see Open Questions).

## Visibility rules
- Only show estimates returned by backend; do not attempt to â€œmergeâ€ across locations client-side.
- If backend provides line-level internal-only fields, frontend must not render them (requires contract clarity; see Open Questions).

## Error messaging expectations
- Use consistent POS error banner/toast conventions (per repo).
- Do not expose backend stack traces or internal identifiers beyond estimateId.

---

# 8. Data Requirements

## Entities involved (frontend read models)
- `EstimateSummary`
- `EstimateDetail`
- `WorkexecRef` (only if needed for cross-links; unclear)

## Fields
Because the provided frontend story does not define schemas, this story requires a confirmed contract. **Minimum required fields** to satisfy the user-visible requirements:

### EstimateSummary (list)
- `estimateId` (string/number; required)
- `status` (string/enum; required)
- `grandTotal` (number/decimal string; required)
- `currencyUomId` (string; required if totals displayed with currency)
- `lastUpdatedAt` (ISO-8601 datetime; required)

Optional (if backend provides):
- `customerId`, `vehicleId`
- `summaryText` / `serviceDescription`
- `expiresAt` or `isExpired`

### EstimateDetail (detail)
- `estimateId` (required)
- `status` (required)
- `lastUpdatedAt` (required)
- `notes` (string/array; optional)
- `lineItems[]` (required for â€œshows linesâ€)
  - each line: `type` (service/part), `description`, `quantity`, `unitPrice`, `lineTotal`, `declined?` (if supported)

Optional:
- Totals breakdown (subtotal/taxes/fees) if backend provides; not strictly required by this frontend issueâ€™s AC but referenced in backend story.

## Read-only vs editable
- All fields in this story are **read-only** (no editing).

## Derived/calculated fields
- Client may derive display-only values:
  - â€œLast updatedâ€ formatting in user timezone
  - Empty state counts
- Client must not recalculate totals; display backend totals as source of truth.

---

# 9. Service Contracts (Frontend Perspective)

> **Note:** Endpoint paths in backend reference are inconsistent with other docs in this prompt (e.g., `/api/estimates/...` vs `/estimates?...`). Contract must be confirmed.

## Load/view calls
- List by customer:
  - `GET <TBD>/estimates?customerId={customerId}&status=<optional>&pageIndex=<optional>&pageSize=<optional>&sort=<optional>`
- List by vehicle:
  - `GET <TBD>/estimates?vehicleId={vehicleId}&status=<optional>&pageIndex=<optional>&pageSize=<optional>&sort=<optional>`
- Detail:
  - `GET <TBD>/estimates/{estimateId}`

## Create/update calls
- None (read-only story)

## Submit/transition calls
- None (read-only story)

## Error handling expectations
- `200` list returns:
  - array + pagination metadata OR a paginated envelope (TBD)
- `200` detail returns EstimateDetail
- `400` for invalid query params (e.g., missing required identifiers)
- `401/403/404/409/5xx` handled as described in Functional Behavior

---

# 10. State Model & Transitions

This story is **display-only**; it does not initiate estimate state transitions.

## Allowed states (displayed)
- Must render whatever `status` values backend returns.
- Provide a stable mapping to user-readable labels (e.g., `DRAFT` â†’ â€œDraftâ€), but do not hardcode a full state machine unless backend publishes canonical enum list for frontend.

## Role-based transitions
- None initiated by this UI in this story.

## UI behavior per state
- Always show list rows regardless of status, subject to filters and permissions.
- If status implies â€œlockedâ€ (approved/etc.), still viewable unless backend denies.

---

# 11. Alternate / Error Flows

## Validation failures
- Missing both `customerId` and `vehicleId`:
  - Show blocking message; do not call backend.

## Concurrency conflicts
- If detail endpoint returns `409 Conflict` (e.g., estimate version mismatch) for read calls:
  - Treat as retryable error with message â€œEstimate changed; reload to view latest.â€ (Only if backend actually uses 409 for reads; otherwise ignore.)

## Unauthorized access
- 403 on list:
  - Show â€œYou do not have access to view estimates for this customer/vehicle.â€
- 403 on detail:
  - Show â€œYou do not have access to this estimate.â€ and do not show any estimate data.

## Empty states
- 200 with empty list:
  - Show â€œNo estimates found for this customer/vehicle.â€
  - Provide navigation back to customer/vehicle record.

---

# 12. Acceptance Criteria

### Scenario 1: View estimates for a customer
**Given** I am authenticated as a Service Advisor  
**And** I navigate to the Estimates list from a Customer record with `customerId`  
**When** the Estimates list screen loads  
**Then** the system requests estimates filtered by that `customerId`  
**And** I see a list of estimates including each estimateâ€™s ID, status, grand total, and last updated timestamp

### Scenario 2: View estimates for a vehicle
**Given** I am authenticated as a Service Advisor  
**And** I navigate to the Estimates list from a Vehicle record with `vehicleId`  
**When** the Estimates list screen loads  
**Then** the system requests estimates filtered by that `vehicleId`  
**And** I see a list of estimates including each estimateâ€™s ID, status, grand total, and last updated timestamp

### Scenario 3: Drill into estimate details
**Given** I am viewing an Estimates list with at least one estimate row  
**When** I select an estimate row  
**Then** I am navigated to the Estimate detail screen for that `estimateId`  
**And** the system loads the estimate detail  
**And** I can see line items and notes returned by the backend

### Scenario 4: Preserve navigation context
**Given** I opened the Estimates list with a `customerId` (and optional filters/sort/page)  
**When** I navigate into an Estimate detail and then go back to the list  
**Then** the list screen restores the same `customerId` context  
**And** my previously selected filters/sort/page are preserved

### Scenario 5: No estimates found
**Given** I am viewing the Estimates list for a valid `customerId` or `vehicleId`  
**When** the backend returns an empty result set  
**Then** I see an empty state indicating no estimates were found  
**And** the UI does not display an error

### Scenario 6: Unauthorized access to estimate detail
**Given** I attempt to open an estimate detail  
**When** the backend responds with HTTP 403  
**Then** I see a permission denied message  
**And** no estimate line items or notes are displayed

### Scenario 7: Backend service unavailable
**Given** I am on the Estimates list screen  
**When** the backend request fails with a network error or HTTP 5xx  
**Then** I see an error message â€œUnable to load estimates; service temporarily unavailableâ€  
**And** I can select â€œRetryâ€ to re-attempt loading

---

# 13. Audit & Observability

## User-visible audit data
- Display `lastUpdatedAt` on list and detail (as required by story)

## Status history
- Not required by this story (do not implement transitions/history UI)

## Traceability expectations
- Frontend logs should include:
  - screen name (estimateList / estimateDetail)
  - correlation/request id if available in existing HTTP client layer
  - identifiers used (customerId/vehicleId/estimateId) **only** as non-sensitive operational identifiers

---

# 14. Non-Functional UI Requirements

## Performance
- List and detail initial load should be non-blocking with loading indicators.
- Paginate results to avoid rendering very large lists.

## Accessibility
- All interactive elements keyboard-accessible.
- Status and error messages announced via accessible alerts per Quasar standards.

## Responsiveness
- Works on tablet and desktop POS layouts.

## i18n/timezone/currency
- Format datetimes in the userâ€™s configured timezone.
- Display currency using provided `currencyUomId` (if contract supports); otherwise show totals as raw numbers and flag as clarification.

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty-state copy and â€œBackâ€ navigation; qualifies as safe UX ergonomics; impacts UX Summary, Error Flows, Acceptance Criteria.
- SD-UX-PAGINATION: Use standard pagination controls with default page size (repo standard); qualifies as safe UX ergonomics; impacts UX Summary, Functional Behavior, Service Contracts.
- SD-ERR-HTTP-MAP: Map 401/403/404/5xx to standard user messages; qualifies as safe because it is generic error handling and does not change domain policy; impacts Functional Behavior, Error Flows.

---

# 16. Open Questions

1. **API contract (blocking):** What are the exact backend endpoints and response shapes for:
   - list estimates by customer/vehicle
   - get estimate detail  
   (The prompt contains multiple conflicting examples: `/api/estimates/...` vs `/estimates?...`.)

2. **Status set (blocking):** What are the canonical estimate statuses that the frontend should display/filter on?  
   (Backend reference lists an extended set including `OPEN`, `PENDING_CUSTOMER`, etc., while the workexec approval doc lists `DRAFT/APPROVED/DECLINED/EXPIRED`.)

3. **Totals/currency (blocking):** Does `EstimateSummary` include `currencyUomId` and is `grandTotal` a decimal string or number? How should rounding be handled/displayed?

4. **Notes/lines schema (blocking):** What is the structure of â€œlines and notesâ€ in `EstimateDetail` (fields, types, ordering)? Are any fields internal-only that must be excluded?

5. **Navigation/link targets (blocking):** What exact â€œlinks preservedâ€ requirement applies:
   - preserve only list query params on back navigation, or
   - include deep-links to appointment creation / checkout flows from estimate detail?

6. **Caching requirement:** Should the frontend implement any client-side caching for list/detail (and show â€œView cached estimates from [timestamp]â€), or is this out of scope for frontend and handled by backend/proxy?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Workexec: Retrieve and Display Estimates for Customer/Vehicle  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/79  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Workexec: Retrieve and Display Estimates for Customer/Vehicle

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **Service Advisor**, I want to view estimates for a customer/vehicle so that I can move from quote to appointment or checkout.

## Details
- List open/draft/approved estimates.
- Show totals, status, and last updated.

## Acceptance Criteria
- Estimates list shown with statuses.
- Drilldown shows lines and notes.
- Links preserved.

## Integrations
- Workexec provides estimate read APIs/events.

## Data / Entities
- EstimateSummary, EstimateDetail, WorkexecRef

## Classification (confirm labels)
- Type: Story
- Layer: Experience
- domain :  Point of Sale

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #85: [FRONTEND] [STORY] Order: Create Sales Order Cart and Add Items  
File: ./scripts/story-work/frontend/85/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:workexec
- status:draft

### Recommended
- agent:workexec-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** workexec-structured

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Order: Create Sales Order Cart and Add Items (Moqui Screens)

### Primary Persona
POS Clerk

### Business Value
Enable a clerk to start a sales transaction by creating a persistent cart (sales order) and adding products/services with deterministic totals, optional source linking (estimate/workorder), and auditable changesâ€”so checkout/quoting can proceed efficiently and traceably.

---

## 2. Story Intent

### As a / I want / So that
- **As a** POS Clerk  
- **I want** to create a new sales order cart and add/update/remove items (by SKU or service code), optionally merge items from an estimate/workorder  
- **So that** I can quote and sell at the counter with reliable totals and a clear audit trail.

### In-scope
- Create a new Sales Order (â€œcartâ€) in `DRAFT` state.
- Display and maintain cart header (orderId, customer/vehicle context if present, terminal/clerk context).
- Add line items by identifier (SKU/service code) with quantity.
- Resolve unit price via Pricing Service; handle pricing-service failure via cache TTL and manual-entry permission gate.
- Optional inventory availability check and insufficient-stock policy (WARN_AND_BACKORDER vs BLOCK) as described.
- Update quantity and remove line items.
- Optional linking to an existing estimate or workorder, using merge + idempotency rules described.
- Display deterministic subtotal (sum of qty * unitPrice).
- Frontend-visible audit cues (show that change is recorded; optionally show transition/audit feed if API exists).

### Out-of-scope
- Promotions, tax finalization, invoicing, order submission/checkout flows.
- Configuration management (inventory policy, price override policies, default locations, approval configs).
- Implementing backend services/entities/events (assumed available).
- Notification delivery (alerts).

---

## 3. Actors & Stakeholders
- **POS Clerk (Primary user)**
- **Service Advisor (Secondary user)**: may link estimates/workorders depending on permissions.
- **Pricing Service (External dependency)**: authoritative unit price.
- **Inventory Service (Optional external dependency)**: availability/backorder status.
- **CRM/Customer context provider (Dependency)**: customerId/vehicleId lookup and selection.
- **Audit/Reporting consumers (Stakeholders)**: require consistent event/audit generation.

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the POS UI.
- User session has access to a **clerk identity** and **terminal identity** (required to create an order per backend rules).
- User has permission to create orders and modify lines (exact permission names TBD; see Open Questions).

### Dependencies (must exist or be stubbed)
- Backend endpoints/services for:
  - Create SalesOrder (cart)
  - Add/update/remove SalesOrderLine
  - Link source (estimate/workorder) and merge idempotently
  - Price quote lookup and/or line add that performs pricing server-side
  - Optional inventory availability check
  - Permission check for manual price entry (`ENTER_MANUAL_PRICE`) and possibly reason codes
- Entities exposed (or mapped) to UI:
  - `SalesOrder`, `SalesOrderLine` (names may differ in Moqui entities; mapping required)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- POS main navigation: **Order / New Order** action.
- Optional: from Customer/Vehicle context screen: **Start Order**.
- Optional: from Estimate/Workorder view: **Create Order from Source** (links source during creation or immediately after).

### Screens to create/modify (Moqui)
1. **`apps/pos/order/OrderCreate.xml`** (new)
   - Action to create a new cart (SalesOrder) and redirect to Order Detail.
2. **`apps/pos/order/OrderDetail.xml`** (new)
   - Shows cart header + line items table + subtotal.
   - Contains add-item form and line edit/remove actions.
   - Contains â€œLink Sourceâ€ action (estimate/workorder) and results summary.
3. **`apps/pos/order/OrderLinkSourceDialog.xml`** (new or embedded screen/dialog)
   - Collect `sourceType` (ESTIMATE/WORKORDER) and `sourceId`.
4. (Optional) **`apps/pos/order/OrderAudit.xml`** (new) if audit feed is available.

> Note: exact file paths must follow repo conventions (README/agents). If different, adjust during implementation.

### Navigation context
- After creation: redirect to `OrderDetail?orderId=...`
- From OrderDetail, allow returning to POS home while preserving orderId in session/history (implementation detail).

### User workflows
**Happy path**
1. Clerk clicks â€œNew Orderâ€.
2. System creates SalesOrder (`DRAFT`) and loads Order Detail.
3. Clerk adds an item by SKU/service code + quantity.
4. UI shows added line, unit price source, and updated subtotal.
5. Clerk adjusts quantities/removes lines as needed.

**Alternate paths**
- Link an estimate/workorder: user provides ID; UI merges lines and shows merge summary.
- Pricing service down: UI uses cached price (within TTL) or prompts for manual price (if permitted) + reason code.
- Inventory insufficient: UI shows warning and line flagged BACKORDER; still included in subtotal.

---

## 6. Functional Behavior

### Triggers
- User clicks **Create New Order**
- User submits **Add Item**
- User edits **Quantity**
- User clicks **Remove Line**
- User initiates **Link Source** (estimate/workorder)

### UI actions (explicit)
- **Create New Order**
  - Calls create service
  - On success: navigate to OrderDetail with `orderId`
  - On failure: show blocking error banner with reason
- **Add Item**
  - Validate inputs client-side (non-empty identifier, quantity > 0 integer)
  - Call backend add-line operation (preferred: backend performs pricing/inventory checks and returns created line)
  - Render line with flags: `fulfillmentStatus`, `priceSource`, `STALE` indicator if `CACHE`
- **Update Quantity**
  - Inline edit quantity (integer > 0). If set to 0, treat as remove (confirm) OR block (see Open Questions).
  - Call update-line service, refresh order totals
- **Remove Line**
  - Confirm remove
  - Call remove-line service, refresh order totals
- **Link Source**
  - Collect `sourceType` and `sourceId`
  - Call link/merge service
  - Show merge results: items merged vs added as separate lines
  - Ensure idempotency: re-linking same source shows â€œAlready linked; no changesâ€ (based on backend response)

### State changes (frontend-visible)
- SalesOrder created in `DRAFT`
- SalesOrder subtotal changes on line add/update/remove/link merge
- Line-level fields set/returned by backend:
  - `fulfillmentStatus` changes based on inventory policy
  - `priceSource` and staleness indicator

### Service interactions
- Create order
- Get order detail (header + lines)
- Add line (with pricing resolution)
- Update line quantity
- Remove line
- Link source (estimate/workorder) -> merge

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Create order** requires terminalId + clerkId context; if missing in UI session:
  - Block action and show: â€œTerminal or clerk context missing. Please re-login or select a terminal.â€
- **Add item**:
  - Identifier required (SKU/service code)
  - Quantity required, integer, > 0
- **Manual price fallback** (only when pricing unavailable AND no valid cached price):
  - Only show manual price input if user has `ENTER_MANUAL_PRICE`
  - Require:
    - `unitPrice` decimal > 0
    - `reasonCode` non-empty
  - Mark line as `priceSource=MANUAL`
- **Inventory insufficient**:
  - If policy = `WARN_AND_BACKORDER`: allow add, set `fulfillmentStatus=BACKORDER`, show warning
  - If policy = `BLOCK`: prevent add and show error (exact message below)

### Enable/disable rules
- Disable â€œAdd Itemâ€ submit while request in-flight.
- Disable quantity edit/remove while update in-flight for that line.
- Hide/disable manual price controls unless pricing failure pathway is active and permission is present.
- Restrict customer-specific promotion UI (if present on screen) when `customerId` is null:
  - Must show message requiring customer assignment (even if promotions themselves are out-of-scope, do not accidentally enable them).

### Visibility rules
- Show â€œAnonymous cartâ€ indicator when `customerId` is null.
- Show â€œPrice from cache (STALE)â€ banner/label when `priceSource=CACHE`.
- Show â€œBackorderedâ€ badge when `fulfillmentStatus=BACKORDER`.

### Error messaging expectations (user-facing)
- Invalid SKU/service code: **â€œProduct not foundâ€**
- Pricing service unavailable, cache used: **â€œPricing service unavailable â€” using cached price (may be stale).â€**
- Pricing unavailable, no cache, no permission: **â€œPricing unavailable and manual price entry is not permitted. Try again later or contact a manager.â€**
- Inventory insufficient + BLOCK policy: **â€œInsufficient stock â€” item cannot be added.â€**
- Unauthorized (403): **â€œYou donâ€™t have permission to perform this action.â€**
- Conflict (409) e.g., concurrent edits: **â€œThis order was updated elsewhere. Reload to continue.â€**

---

## 8. Data Requirements

### Entities involved (frontend view)
- `SalesOrder` (SoR: backend/workexec domain)
- `SalesOrderLine` (SoR: backend/workexec domain)
- Optional reference entities:
  - Estimate, Workorder (as source references only)
- Optional: AuditLog/Event feed (read-only)

### Fields

**SalesOrder**
- `orderId` (string, required, read-only)
- `status` enum: `DRAFT`, `QUOTED`, `COMPLETED`, `VOIDED` (read-only in this story; always `DRAFT` after create)
- `customerId` (string, nullable; editable only if UI supports setting contextâ€”NOT implemented here unless already exists)
- `vehicleId` (string, nullable; same as above)
- `clerkId` (string, required, derived from session, read-only)
- `terminalId` (string, required, derived from session, read-only)
- `subtotal` (decimal, read-only; returned by backend)
- `createdAt`, `updatedAt` (timestamps, read-only)

**SalesOrderLine**
- `orderLineId` (string, required, read-only)
- `orderId` (string, required, read-only)
- `itemSku` (string, required)
- `itemDescription` (string, returned, read-only)
- `quantity` (int, required, editable)
- `unitPrice` (decimal, required; editable ONLY in manual-price flow at add-time; otherwise read-only)
- `fulfillmentStatus` enum `AVAILABLE|BACKORDER` (read-only)
- `priceSource` enum `PRICING_SERVICE|CACHE|MANUAL` (read-only)
- `reasonCode` (string; required when `priceSource=MANUAL`; read-only after add unless backend supports editsâ€”assume read-only)
- `sourceType` enum `ESTIMATE|WORKORDER|null` (read-only)
- `sourceId` (string|null, read-only)
- `sourceLineId` (string|null, read-only)

### Read-only vs editable by state/role
- While `SalesOrder.status != DRAFT`: all line modifications disabled (UI should enforce even if not expected in this story).
- Manual price entry: only if permission `ENTER_MANUAL_PRICE` and only during add flow when pricing unavailable.

### Derived/calculated fields (UI-only)
- `lineExtended = quantity * unitPrice` (display only; backend remains authoritative for subtotal)
- `isStalePrice = (priceSource == CACHE)` (display only)

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementation may call REST endpoints directly or via Moqui services; contracts below describe required behaviors, not transport specifics.

### Load/view calls
1. **Get order detail**
   - `GET /api/orders/{orderId}` (TBD exact path)
   - Returns SalesOrder + lines + subtotal

### Create/update calls
2. **Create new order**
   - `POST /api/orders`
   - Request includes (or derives): `customerId?`, `vehicleId?`, `clerkId`, `terminalId`
   - Response: created SalesOrder with `orderId`, `status=DRAFT`, `subtotal=0.00`

3. **Add line**
   - Preferred: `POST /api/orders/{orderId}/lines`
   - Request: `itemSkuOrServiceCode`, `quantity`
   - Optional request fields only in manual flow: `unitPrice`, `reasonCode`
   - Response: created line + updated order subtotal (or require refetch)

4. **Update line quantity**
   - `PUT /api/orders/{orderId}/lines/{orderLineId}`
   - Request: `quantity`
   - Response: updated line + updated subtotal (or require refetch)

5. **Remove line**
   - `DELETE /api/orders/{orderId}/lines/{orderLineId}`
   - Response: success + updated subtotal (or require refetch)

### Submit/transition calls
6. **Link source (merge)**
   - `POST /api/orders/{orderId}/link-source`
   - Request: `sourceType`, `sourceId`
   - Response:
     - Updated lines and subtotal
     - Merge summary: counts of merged vs added; idempotency indicator

### Error handling expectations
- `400` validation errors: show field-level error where possible, otherwise banner.
- `401` redirect to login.
- `403` show permission error.
- `404` show not found (order/line/source not found).
- `409` concurrency: prompt reload and provide reload action.
- `503/504` service unavailable: trigger pricing fallback logic when adding items (cache/manual pathways).

---

## 10. State Model & Transitions

### SalesOrder states (relevant to this story)
- `DRAFT` (modifiable)
- `QUOTED`, `COMPLETED`, `VOIDED` (non-modifiable here; UI must render read-only if encountered)

### Allowed transitions (UI impact)
- This story does **not** implement transitions between SalesOrder states.
- UI must:
  - Allow add/update/remove/link only when `status=DRAFT`
  - Disable modification controls when `status!=DRAFT`

### Role-based transitions
- N/A (no state transitions implemented), but role-based permission affects:
  - Manual price entry (`ENTER_MANUAL_PRICE`)

---

## 11. Alternate / Error Flows

1. **Invalid SKU/service code**
   - Backend returns 404/400 with code indicating unknown item
   - UI shows â€œProduct not foundâ€, keeps form inputs for correction

2. **Pricing service unavailable**
   - If backend returns line with `priceSource=CACHE`: show stale warning
   - If backend indicates no price and requires manual:
     - If user has permission: show manual price + reasonCode inputs and allow retry submit
     - Else: show blocking error and do not add line

3. **Inventory insufficient**
   - If WARN_AND_BACKORDER: line added with BACKORDER + warning badge/banner
   - If BLOCK: do not add line; show error

4. **Link source idempotency**
   - Re-link same source:
     - Backend returns no changes or explicit idempotent response
     - UI shows â€œSource already linked; no changes applied.â€

5. **Concurrency conflict**
   - When updating/removing line:
     - Backend returns 409
     - UI shows conflict message and offers reload; do not attempt auto-merge client-side

6. **Unauthorized**
   - Any action returns 403:
     - UI shows permission error
     - If action is manual price entry, ensure manual controls are hidden/disabled afterwards

7. **Empty states**
   - New order has no lines: show â€œNo items yetâ€ and focus add-item input.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create a new, empty sales cart
Given I am a logged-in POS Clerk with terminal context available  
When I initiate â€œCreate New Orderâ€  
Then a SalesOrder is created with a unique orderId  
And the SalesOrder status is DRAFT  
And the subtotal is 0.00  
And the Order Detail screen is shown for that orderId

### Scenario 2: Add a valid and available item to the cart
Given I have a DRAFT sales order  
When I add SKU â€œABC-123â€ with quantity 2  
Then the system adds a SalesOrderLine for â€œABC-123â€ with quantity 2 and a resolved unit price  
And the order subtotal equals the deterministic sum of (quantity * unitPrice) across all lines  
And the new line is displayed in the cart

### Scenario 3: Attempt to add an item with an invalid SKU
Given I have a DRAFT sales order  
When I attempt to add SKU â€œINVALID-SKUâ€ with quantity 1  
Then the item is not added to the cart  
And I see the error message â€œProduct not foundâ€  
And the order subtotal remains unchanged

### Scenario 4: Update the quantity of an existing item
Given my cart contains a line for SKU â€œABC-123â€ with quantity 2 and unit price 10.50  
When I update that line quantity to 3  
Then the line quantity becomes 3  
And the order subtotal is recalculated and displayed as 31.50

### Scenario 5: Remove an item from the cart
Given my cart contains a line for SKU â€œABC-123â€  
When I remove that line  
Then the line no longer appears in the cart  
And the order subtotal is recalculated and displayed

### Scenario 6: Add item with insufficient inventory (backorder policy WARN_AND_BACKORDER)
Given I have a DRAFT sales order  
And the inventory insufficient policy is WARN_AND_BACKORDER  
When I add an item that the Inventory Service reports as insufficient stock  
Then the line is added to the cart  
And the line is marked with fulfillmentStatus BACKORDER  
And I see a warning â€œInsufficient stock â€” item will be backorderedâ€  
And the line is included in the subtotal calculation

### Scenario 7: Pricing unavailable - use cached price within TTL
Given I have a DRAFT sales order  
And the Pricing Service is unavailable  
And a valid cached price exists within the TTL  
When I add SKU â€œABC-123â€  
Then the line is added with priceSource CACHE  
And I see â€œPricing service unavailable â€” using cached price (may be stale).â€

### Scenario 8: Pricing unavailable - manual entry allowed with permission
Given I have a DRAFT sales order  
And the Pricing Service is unavailable  
And no valid cached price exists  
And I have permission ENTER_MANUAL_PRICE  
When I enter a manual unit price and a reason code and submit add-item  
Then the line is added with priceSource MANUAL  
And the reason code is stored for audit  
And the order subtotal updates accordingly

### Scenario 9: Pricing unavailable - manual entry not permitted
Given I have a DRAFT sales order  
And the Pricing Service is unavailable  
And no valid cached price exists  
And I do not have permission ENTER_MANUAL_PRICE  
When I attempt to add the item  
Then the item is not added  
And I see â€œPricing unavailable and manual price entry is not permitted. Try again later or contact a manager.â€

### Scenario 10: Link estimate merges lines deterministically and is idempotent
Given I have a DRAFT sales order with SKU â€œTIRE-001â€ quantity 2 at price 100  
And an estimate exists with SKU â€œTIRE-001â€ quantity 3 at price 100 and SKU â€œOIL-001â€ quantity 1 at price 25  
When I link the estimate to the cart  
Then the cart line for â€œTIRE-001â€ quantity becomes 5  
And â€œOIL-001â€ is added as a new line  
And the lines include sourceType ESTIMATE and sourceId and sourceLineId values  
When I link the same estimate again  
Then no duplicate lines are created  
And the UI indicates no changes were applied

---

## 13. Audit & Observability

### User-visible audit data
- After each successful action (create/add/update/remove/link), show a non-intrusive confirmation and maintain a â€œlast updatedâ€ timestamp (from `updatedAt` or response).
- If an audit feed endpoint exists, show a read-only panel listing:
  - action type, user, timestamp, key identifiers (orderId, orderLineId)

### Status history
- Not applicable for SalesOrder state transitions in this story, but changes to lines must be traceable.

### Traceability expectations
- UI must pass correlation/request ID headers if project conventions exist (TBD).
- For manual price entry, ensure reasonCode is collected and submitted; do not log sensitive details client-side.

---

## 14. Non-Functional UI Requirements

- **Performance:** Order detail load and line mutations should feel immediate; show loading states. Target < 500ms UI feedback after response; if slower, show spinner.
- **Accessibility:** Keyboard operable add-item flow; proper labels for inputs; warnings/errors announced (ARIA live region).
- **Responsiveness:** Usable on tablet and desktop POS layouts.
- **i18n/timezone/currency:** Display currency formatting consistently with locale; timestamps displayed in local timezone but stored/handled in UTC (display-only here).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide an explicit empty-state message when a cart has no lines; safe because itâ€™s purely presentational and does not alter business logic. (Sections: UX Summary, Alternate / Error Flows)
- SD-UX-INFLIGHT-DISABLE: Disable action buttons during in-flight requests to prevent duplicate submissions; safe because it reduces accidental double posts without changing domain rules. (Sections: Functional Behavior, Error Flows)
- SD-ERR-HTTP-MAP: Map common HTTP codes (400/401/403/404/409/5xx) to standard user messages; safe because it does not change backend policy, only presentation. (Sections: Service Contracts, Business Rules, Error Flows)

---

## 16. Open Questions

1. **Moqui routing & screen conventions:** What are the exact POS app screen paths and naming conventions in `durion-moqui-frontend` (e.g., `apps/pos/order/*` vs another structure)?  
2. **Backend endpoint paths for frontend:** What are the exact REST endpoints for create order, add/update/remove line, get order, and link source in the Moqui frontend integration layer? (Backend story is Spring-based; Moqui may proxy differently.)  
3. **Permissions source & names:** Besides `ENTER_MANUAL_PRICE`, what permissions control create order, modify lines, and link estimate/workorder? How does the frontend check them (session claims vs endpoint-driven)?  
4. **Quantity-to-zero behavior:** Should setting quantity to `0` be treated as â€œremove lineâ€ (with confirmation) or rejected as invalid?  
5. **Service vs SKU identifier:** How does the UI distinguish â€œproduct SKUâ€ vs â€œservice codeâ€? Is there a unified identifier field, or should there be a selector?  
6. **Inventory check toggle:** Is inventory availability check always on, or configurable per site/terminal? If configurable, where does the frontend read that configuration?  
7. **Pricing cache behavior location:** Is the 60-second TTL cache implemented server-side (preferred) or must the frontend implement caching? If frontend, what is the cache key data available in UI (customerAccountId, priceListId, currency)?  
8. **Link source UX:** How does the clerk locate/select an estimate/workorder to link (search dialog vs entering an ID)? If search is required, which endpoints support lookup and what filters are allowed?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Order: Create Sales Order Cart and Add Items  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/85  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Order: Create Sales Order Cart and Add Items

**Domain**: user

### Story Description

/kiro  
# User Story

## Narrative
As a **POS Clerk**, I want to create a cart and add products/services so that I can quote and sell efficiently at the counter.

## Details
- Create cart for a customer/vehicle context.
- Add items by SKU/service code; set quantities.
- Support linking to an existing estimate/workorder as the source of items (optional).

## Acceptance Criteria
- Cart created with unique orderId.
- Items can be added/updated/removed.
- Totals recalc deterministically.
- Audit changes.

## Integrations
- Pull product pricing from product/pricing service; optionally check availability from inventory.

## Data / Entities
- PosOrder, PosOrderLine, PriceQuote, TaxQuote (hook), AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Experience
- domain :  Point of Sale

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x

