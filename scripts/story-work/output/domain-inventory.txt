â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DOMAIN: inventory
Total Stories: 31
Generated: dim. 18 janv. 2026 12:03:02 EST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #100: [FRONTEND] [STORY] Ledger: Compute On-hand and Available-to-Promise by Location/Storage â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/100
File: ./scripts/story-work/frontend/100/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Inventory Availability: View On-hand and ATP by Location / Storage Location

### Primary Persona
Service Advisor

### Business Value
Enable accurate quoting and scheduling by showing real-time on-hand and available-to-promise (ATP) quantities for a part at a selected location (optionally narrowed to a storage/bin location), with consistent UOM.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Service Advisor  
- **I want** to query and view on-hand and ATP for a part by location and optionally by storage location  
- **So that** I can quote and schedule customer work realistically based on current stock availability

### In-scope
- A frontend screen/workflow to request availability for a single product SKU at:
  - a parent **location** (aggregated across storage locations), and/or
  - a specific **storageLocation** (bin-level scope)
- Display returned quantities: `onHandQuantity`, `allocatedQuantity`, `availableToPromiseQuantity`, `unitOfMeasure`
- Handle â€œno inventory historyâ€ as a valid empty result (0s)
- Handle not-found and authorization errors in the UI
- Moqui screen(s), transitions, and service-call wiring to backend availability endpoint

### Out-of-scope
- Editing inventory, allocations, receipts, or ledger events
- Expected receipts in ATP calculation (ATP v1 excludes expected receipts)
- UOM conversions (request/response in product base UOM only)
- Batch/multi-SKU availability queries (single SKU per request only)

---

## 3. Actors & Stakeholders
- **Primary Actor:** Service Advisor
- **Stakeholders:** Inventory Manager (data correctness), Work Execution (scheduling), Pricing (may consume ATP), Front Desk/Estimator users
- **System Actors:** Moqui frontend, Inventory backend service (availability)

---

## 4. Preconditions & Dependencies
- Backend provides an availability API consistent with backend story #36:
  - Request: `productSku` (required), `locationId` (required), `storageLocationId` (optional)
  - Response: `AvailabilityView` with on-hand, allocated, ATP, UOM in base UOM
  - Error cases: `404 product not found`, `404 location not found`, success with 0s if no history
- Frontend has a way to select/enter:
  - `productSku`
  - `locationId`
  - optional `storageLocationId`
- Authentication is already in place; backend enforces authorization (403 on forbidden)

**Dependency Note:** The story does not define how SKU/location/storageLocation are looked up (search pickers). If they do not exist, this story will use minimal inputs and/or existing pickers, but see Open Questions.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Inventory module navigation: â€œAvailabilityâ€ (or similar) under Inventory
- Optional: contextual link/button from estimate/work order part selection UI (if exists). If not present, entry is via Inventory menu only.

### Screens to create/modify
- **New Screen:** `apps/pos/screen/inventory/Availability.xml` (name illustrative; follow repo conventions)
  - Purpose: query and display availability for one SKU at a location (optionally storage location)
- **Optional Reusable Section:** `inventory/AvailabilityQueryForm.xml` for embedding elsewhere (if repo uses sections)
- **No changes** to backend; frontend only calls backend.

### Navigation context
- From POS main menu â†’ Inventory â†’ Availability
- Screen supports direct navigation with query parameters for deep links:
  - `productSku`, `locationId`, `storageLocationId` (optional)

### User workflows
**Happy path (location-level):**
1. User enters/selects SKU
2. User selects location
3. User leaves storage location blank
4. User clicks â€œCheck Availabilityâ€
5. UI displays on-hand, allocated, ATP, and base UOM

**Happy path (storage-level):**
1. Same as above, but user selects a storage location
2. UI displays values scoped to that storage location

**Alternate paths:**
- Missing required inputs â†’ inline validation prevents submit
- SKU/location not found (404) â†’ user-friendly error and keep inputs
- No inventory history â†’ show quantities as 0 and explain â€œNo ledger history foundâ€
- Forbidden (403) â†’ show â€œYou do not have accessâ€ and do not display sensitive details

---

## 6. Functional Behavior

### Triggers
- User presses â€œCheck Availabilityâ€ (form submit)
- Screen loads with query params present (auto-run query once)

### UI actions
- Input fields:
  - Product SKU (text or picker)
  - Location (picker/selector)
  - Storage Location (optional picker/selector; enabled only when location selected)
- Action buttons:
  - Submit query
  - Clear/reset

### State changes (frontend)
- `idle` â†’ `loading` â†’ `success` or `error`
- Persist last successful result on screen until user changes inputs or clears
- When user changes SKU/location/storageLocation after a success, mark result â€œstaleâ€ until re-queried

### Service interactions
- On submit/auto-run: call backend availability endpoint with the three identifiers
- Map response to a view model shown on screen
- Map HTTP errors to UI messages (see Error Flows)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `productSku` is required and trimmed; reject empty/whitespace
- `locationId` is required
- `storageLocationId` is optional
- If `storageLocationId` is provided, it must belong to selected `locationId` (UI should prevent selection outside location if picker supports it; otherwise rely on backend validation and show error)

### Enable/disable rules
- Disable â€œCheck Availabilityâ€ until `productSku` and `locationId` are present
- Disable storage location selector until a location is selected

### Visibility rules
- Results panel hidden until a query succeeds or returns â€œno inventory historyâ€ (still success with 0s)
- Error banner shown only on failed query

### Error messaging expectations
- 404 product not found: â€œPart/SKU not found. Verify the SKU and try again.â€
- 404 location/storage not found: â€œLocation not found or no longer active.â€
- 400 validation: show backend message if safe and user-actionable; otherwise show â€œInvalid request.â€
- 403: â€œYou do not have permission to view availability.â€
- 5xx/network: â€œAvailability service is unavailable. Try again.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Read-only view model:** `AvailabilityView` (returned by backend)
- Frontend may also rely on existing entities/services for location and storage location selection if available (not defined in provided inputs).

### Fields (type, required, defaults)
**Request**
- `productSku`: string, required
- `locationId`: string/UUID, required
- `storageLocationId`: string/UUID, optional (default null/empty)

**Response: AvailabilityView**
- `productSku`: string, required (echo)
- `locationId`: UUID/string, required
- `storageLocationId`: UUID/string, nullable
- `onHandQuantity`: decimal, required (default display 0.0 if missing is not allowed; backend should always return)
- `allocatedQuantity`: decimal, required
- `availableToPromiseQuantity`: decimal, required
- `unitOfMeasure`: string, required (product base UOM)

### Read-only vs editable
- All response fields are read-only
- Only request inputs are editable

### Derived/calculated fields (frontend)
- None; ATP is computed server-side
- Optional formatting only (e.g., fixed decimals for display), without altering values

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls
- If query params are present on screen load (`productSku`, `locationId`, optional `storageLocationId`), perform availability call automatically once.

### Create/update calls
- None.

### Submit/transition calls
- **Availability query call**
  - Method/path: **TBD** (must align to backend implementation)
  - Input: `productSku`, `locationId`, optional `storageLocationId`
  - Output: `AvailabilityView`

**Moqui implementation guidance**
- Implement a Moqui service (client-facing) that performs the HTTP call to the backend (or uses existing integration service in the repo).
  - Example service name (illustrative): `inventory.Availability.get#Inventory`
- Screen transition `checkAvailability` calls the service and places result in context for rendering.

### Error handling expectations
- HTTP 404 mapped to specific not-found messages (see Business Rules)
- HTTP 403 mapped to permission message
- Other 4xx/5xx mapped to generic error with correlation/trace id if available in response headers/body (do not assume; see Open Questions)

---

## 10. State Model & Transitions

### Allowed states (UI)
- `idle` (no query yet)
- `loading`
- `success` (result displayed)
- `error` (error displayed, inputs preserved)

### Role-based transitions
- If backend denies access (403), user remains in `error` with no results shown.
- No frontend-only role logic is assumed; permission enforcement is backend-led.

### UI behavior per state
- `idle`: show form only
- `loading`: disable inputs and submit; show spinner/progress
- `success`: show results panel + form (form remains editable)
- `error`: show error banner + form for correction

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Missing SKU â†’ inline field error; no network call
- Missing location â†’ inline field error; no network call

### Backend validation (400)
- Show message returned if it references input fields (SKU/location/storage) and is safe; otherwise generic â€œInvalid request.â€

### Concurrency conflicts
- Not applicable (read-only query). If backend returns 409 for some reason, show generic error and allow retry.

### Unauthorized access
- 401: prompt re-authentication (existing app pattern)
- 403: show permission error; do not show cached/previous results for different SKU/location

### Empty states
- Backend â€œno inventory historyâ€ returns success with all quantities 0:
  - Show 0 values and a note: â€œNo inventory history for this item at the selected scope.â€

---

## 12. Acceptance Criteria

### Scenario 1: Location-level availability success
**Given** I am an authenticated Service Advisor  
**And** I am on the Inventory Availability screen  
**When** I enter `productSku = "SKU-123"` and select `locationId = "LOC-A"`  
**And** I submit â€œCheck Availabilityâ€  
**Then** the UI calls the availability service with `productSku="SKU-123"` and `locationId="LOC-A"` and no `storageLocationId`  
**And** the UI displays `onHandQuantity`, `allocatedQuantity`, `availableToPromiseQuantity`, and `unitOfMeasure` from the response.

### Scenario 2: Storage-location scoped availability success
**Given** I have selected `locationId = "LOC-WAREHOUSE"`  
**When** I also select `storageLocationId = "BIN-1"` and submit  
**Then** the UI calls the availability service including `storageLocationId="BIN-1"`  
**And** the UI displays quantities scoped to that storage location.

### Scenario 3: No inventory history returns zeros (success state)
**Given** the backend returns a success response with `onHandQuantity=0`, `allocatedQuantity=0`, `availableToPromiseQuantity=0`  
**When** I submit a valid query  
**Then** the UI shows a success results panel with all three quantities displayed as 0 in the returned base `unitOfMeasure`  
**And** the UI indicates â€œNo inventory historyâ€ (or equivalent) without treating it as an error.

### Scenario 4: Product not found (404)
**Given** I submit `productSku="SKU-DOES-NOT-EXIST"` with a valid `locationId`  
**And** the backend responds `404 Not Found` for the SKU  
**Then** the UI shows an error message indicating the SKU was not found  
**And** the previously entered inputs remain editable for correction  
**And** no results panel is shown.

### Scenario 5: Location not found (404)
**Given** I submit a query with `locationId` that does not exist  
**And** the backend responds `404 Not Found`  
**Then** the UI shows an error message indicating the location was not found  
**And** inputs remain for correction.

### Scenario 6: Forbidden (403)
**Given** I submit a valid query  
**And** the backend responds `403 Forbidden`  
**Then** the UI shows â€œYou do not have permission to view availability.â€  
**And** the UI does not display quantities.

### Scenario 7: Required field validation prevents submit
**Given** I am on the Inventory Availability screen  
**When** I leave `productSku` empty and click â€œCheck Availabilityâ€  
**Then** the UI shows an inline validation error on the SKU field  
**And** no backend call is made.

---

## 13. Audit & Observability

### User-visible audit data
- Not required (read-only query).

### Status history
- Not applicable.

### Traceability expectations
- Frontend should include correlation ID in error display/logs when available (e.g., from response header) without exposing sensitive data.
- Log (frontend console/logger) a structured event for:
  - query initiated (SKU, locationId, storageLocationId presence)
  - query success (timing, quantities omitted from logs if considered sensitive; if allowed, include)
  - query failure (HTTP status, error code/message)

(Exact logging mechanism should follow repo conventions.)

---

## 14. Non-Functional UI Requirements
- **Performance:** UI should render results immediately upon response; avoid blocking UI thread; show loading indicator during call.
- **Accessibility:** Form fields labeled; error messages announced (ARIA) via Quasar standard patterns.
- **Responsiveness:** Usable on tablet resolutions typical of POS.
- **i18n/timezone/currency:** Not applicable (quantities + UOM only). Do not assume currency formatting.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Show explicit empty/success-with-zeros messaging for â€œno inventory historyâ€; qualifies as UI ergonomics and does not change domain logic; impacts UX Summary, Error Flows, Acceptance Criteria.
- SD-UX-LOADING-STATE: Disable submit and show loading indicator during network call; qualifies as UI ergonomics; impacts UX Summary, State Model.
- SD-ERR-HTTP-MAP: Standard HTTPâ†’UI mapping (400/401/403/404/5xx) without inventing business policy; qualifies as standard error-handling mapping; impacts Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. What is the **exact backend endpoint path and auth mechanism** the Moqui frontend should call for availability (e.g., `/v1/inventory/availability` vs something else), and what is the expected request/response envelope (plain JSON vs wrapped `{data: ...}`)?
2. Does the frontend already have **existing pickers** for `locationId` and `storageLocationId` (and a known service to load them)? If not, should this story:
   - (a) use free-text UUID entry, or
   - (b) include building minimal location/storage lookup UI (which would expand scope)?
3. Should the Availability screen support **deep-linking via URL query params** officially (bookmarked by advisors), and if so what are the canonical parameter names and routing conventions in this repo?
4. Are availability quantities considered sensitive such that frontend logs must **avoid logging the returned numeric quantities** (only status/timing), or is it acceptable to log them for debugging?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Ledger: Compute On-hand and Available-to-Promise by Location/Storage â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/100

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Ledger: Compute On-hand and Available-to-Promise by Location/Storage  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/100  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Ledger: Compute On-hand and Available-to-Promise by Location/Storage

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Service Advisor**, I want on-hand/ATP so that we can quote and schedule realistically.

## Details
- On-hand computed from ledger; ATP = on-hand - allocations + expected receipts (optional).
- Provide per location and optionally per storage location.

## Acceptance Criteria
- Availability query returns on-hand and ATP.
- Consistent UOM handling.
- SLA suitable for estimate UI.

## Integrations
- Product/workexec query availability; product may surface ATP to pricing.

## Data / Entities
- AvailabilityView, AllocationSummary, ExpectedReceiptSummary

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

BACKEND STORY REFERENCES (FOR REFERENCE ONLY)

----------------------------------------------------------------------------------------------------

Backend matches (extracted from story-work):

[1] backend/36/backend.md

    Labels: type:story, domain:inventory, status:ready-for-dev, agent:story-authoring, agent:inventory

----------------------------------------------------------------------------------------------------

Backend Story Full Content:

### BACKEND STORY #1: backend/36/backend.md

------------------------------------------------------------

Title: [BACKEND] [STORY] Ledger: Compute On-hand and Available-to-Promise by Location/Storage  
URL: https://github.com/louisburroughs/durion-positivity-backend/issues/36  
Labels: type:story, domain:inventory, status:ready-for-dev, agent:story-authoring, agent:inventory

---
**Rewrite Variant:** inventory-flexible  
**Clarification Applied:** #233 (ATP formula, UOM scope, SLA, definitive ledger event types)
---

## Story Intent
**As a** Service Advisor,  
**I need to** know the real-time on-hand and available-to-promise (ATP) quantities for a specific part at a given location,  
**so that I can** provide accurate quotes and schedule customer work with confidence.

## Actors & Stakeholders
- **Primary Actor**: Service Advisor
- **System Actors**:
  - Inventory Service (computes and serves availability)
  - POS UI (consumes availability)
- **Stakeholders**:
  - Work Execution (confirms parts availability for scheduled jobs)
  - Pricing (may use ATP as an input)
  - Inventory Manager (operational planning and stock control)

## Preconditions
- An immutable inventory ledger exists and records stock movements with product, location, movement type, and quantity.
- A system for recording stock allocations (soft reservations for specific work orders/sales) exists and is accessible.
- Products (SKU + base UOM) are defined in Product domain.
- A location hierarchy exists (parent locations and optional storage/bin locations).

## Functional Behavior
The Inventory Service exposes an API endpoint providing on-hand and ATP for a specified product.

1. **Trigger**: Request for availability.
2. **Input**: `productSku`, `locationId`, optional `storageLocationId`.
3. **Processing**:
   - Compute `onHandQuantity` from the inventory ledger (net sum of physical stock movements; see Business Rules).
   - Query allocation system for `allocatedQuantity` for the same scope.
   - Compute `availableToPromiseQuantity` using the defined formula.
   - If only `locationId` is provided, aggregate across all child storage locations.
   - If `storageLocationId` is provided, scope is narrowed to that storage location.
4. **Output**: Return an `AvailabilityView` including `onHandQuantity`, `allocatedQuantity`, `availableToPromiseQuantity`, and `unitOfMeasure`.

## Alternate / Error Flows
- **Product Not Found**: If `productSku` is not found, return `404 Not Found`.
- **Location Not Found**: If `locationId` / `storageLocationId` is not found, return `404 Not Found`.
- **No Inventory History**: If product has no ledger entries for the scope, return success with quantities = 0.

## Business Rules

### On-Hand Calculation (Resolved)
On-hand is the net sum of **physical stock movements** (inbound/outbound) plus count variances. Allocations/reservations are **not** part of on-hand.

**Include in On-Hand (add/subtract by direction)**
- Inbound (positive):
  - `GOODS_RECEIPT`
  - `TRANSFER_IN`
  - `RETURN_TO_STOCK`
  - `ADJUSTMENT_IN`
  - `COUNT_VARIANCE_IN`
- Outbound (negative):
  - `GOODS_ISSUE`
  - `TRANSFER_OUT`
  - `SCRAP_OUT`
  - `ADJUSTMENT_OUT`
  - `COUNT_VARIANCE_OUT`

**Explicitly excluded from On-Hand**
- `RESERVATION_CREATED`, `RESERVATION_RELEASED`
- `ALLOCATION_CREATED`, `ALLOCATION_RELEASED`
- `BACKORDER_CREATED`, `BACKORDER_RESOLVED`
- `PICK_TASK_CREATED`, `PICK_TASK_COMPLETED` (unless these post one of the physical movement events above)

### ATP Calculation Formula (Resolved)
**ATP v1:** $\text{ATP} = \text{OnHand} - \text{Allocations}$  
**Expected receipts are out of scope** for this story.

Optional forward-compatibility: the API may return `expectedReceiptsQty` as nullable, but it MUST NOT be included in ATP.

### Allocation Definition
An allocation is a soft reservation for a specific purpose (e.g., scheduled work order) that has not yet been physically picked/issued.

### Unit of Measure (UOM) Consistency (Resolved)
All internal calculations and API responses are in the productâ€™s **base UOM**.

Out of scope: request/response UOM conversions (e.g., case vs each).

### Location Aggregation
Querying a parent location aggregates all stock within the location across child storage locations.

## Data Requirements

### API Request
- `productSku` (string, required)
- `locationId` (UUID, required)
- `storageLocationId` (UUID, optional)

### API Response (`AvailabilityView`)
- `productSku` (string)
- `locationId` (UUID)
- `storageLocationId` (UUID, nullable)
- `onHandQuantity` (decimal, base UOM)
- `allocatedQuantity` (decimal, base UOM)
- `availableToPromiseQuantity` (decimal, base UOM)
- `unitOfMeasure` (string; product base UOM)

## Acceptance Criteria

**Scenario 1: Simple On-Hand Calculation**
- **Given** product `SKU-123` has ledger history at `LOC-A`: `GOODS_RECEIPT +10` and `GOODS_ISSUE -2`
- **When** availability is requested for `SKU-123` at `LOC-A`
- **Then** `onHandQuantity = 8`.

**Scenario 2: ATP Calculation with Allocations**
- **Given** `onHandQuantity = 8` for `SKU-123` at `LOC-A`
- **And** `allocatedQuantity = 3` at `LOC-A`
- **When** availability is requested for `SKU-123` at `LOC-A`
- **Then** `availableToPromiseQuantity = 5`.

**Scenario 3: Aggregate Calculation by Parent Location**
- **Given** `LOC-WAREHOUSE` contains `BIN-1` and `BIN-2`
- **And** ledger shows 5 units of `SKU-ABC` in `BIN-1` and 3 units in `BIN-2`
- **When** availability is requested for `SKU-ABC` at `LOC-WAREHOUSE` (no `storageLocationId`)
- **Then** `onHandQuantity = 8`.

**Scenario 4: Request for a Non-Existent Product**
- **Given** product catalog does not contain `SKU-DOES-NOT-EXIST`
- **When** availability is requested
- **Then** return `404 Not Found`.

**Scenario 5: Request for a Valid Product with No Inventory**
- **Given** `SKU-456` exists but has no ledger entries at `LOC-A`
- **When** availability is requested
- **Then** return success with `onHandQuantity = 0`, `allocatedQuantity = 0`, `availableToPromiseQuantity = 0`.

## Audit & Observability
- **Logging**: Log each availability request (`productSku`, `locationId`, optional `storageLocationId`) and resulting quantities. Log lookup/summation errors.
- **Metrics**:
  - Timer for endpoint latency.
  - Counters for success and error responses (4xx/5xx).
- **Tracing**: Distributed tracing from API gateway through Inventory Service to data stores.

## Performance Requirements (Resolved)
- Core endpoint (single product, single location, warm cache):
  - **P95 < 200ms**
  - P50 < 80ms
  - P99 < 400ms
- Measurement is at the service boundary, excluding caller network latency.

## Open Questions
None.

------------------------------------------------------------

====================================================================================================

END BACKEND REFERENCES

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #101: [FRONTEND] [STORY] Ledger: Record Stock Movements in Inventory Ledger â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/101
File: ./scripts/story-work/frontend/101/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Inventory Ledger: View Stock Movements (Append-Only) and Support Adjustment Request/Posting UI Hooks

**Primary Persona:** Inventory Manager

**Business Value:** Provide an auditable, explainable history of on-hand changes by product/location, enabling operational troubleshooting, compliance/audit review, and downstream consumers (e.g., Work Execution) to trace movements tied to source transactions.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Inventory Manager  
- **I want** to view all stock movements in an append-only inventory ledger (filterable by product, location, movement type, date range, and source transaction)  
- **So that** on-hand can be audited/explained and I can trace what changed, when, by whom, and why (especially for adjustments).

### In-scope
- A Moqui screen flow to **list and view** `InventoryLedgerEntry` records with:
  - Filtering/search (product, location, movementType, date range, sourceTransactionId/workorder line reference)
  - Row-level details (from/to, qty change, UOM, actor, timestamp, reasonCode)
  - Clear empty/loading/error states
- UI-level enforcement of **immutability** (no edit/delete actions)
- UI hooks for **Adjustment** flows consistent with backend reference:
  - Create adjustment request (draft/pending) UI entry point
  - Approve/post adjustment UI entry point
  - Permission-gated actions and reason code requirement surfaced in UI
- Navigation entry points from Inventory area, and deep linkability to a ledger entry detail screen

### Out-of-scope
- Implementing backend ledger creation/atomicity/replay logic (backend responsibility)
- Defining inventory valuation, reservation/allocation logic, or costing behavior
- Creating movement events (Receive/PutAway/Pick/Consume/Return/Transfer) UI flows unless already existing; this story only **displays ledger** and provides **adjustment request/post UI** entry points
- Report exports (CSV/PDF) unless explicitly requested later

---

## 3. Actors & Stakeholders
- **Inventory Manager (primary user):** audits movements; creates/approves adjustments.
- **Parts Counter / Staff (secondary):** views movement history to answer â€œwhat happenedâ€.
- **Auditor (stakeholder):** needs immutable, traceable history.
- **Work Execution users/system (consumer):** links from work order line to movement history (view-only).
- **System actor:** some ledger entries are system-generated; UI must display actorId accordingly.

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend and has an active session.
- Product master records exist (referenced by `productId`).
- Storage locations exist (referenced by `fromLocationId` / `toLocationId`).
- Backend exposes read APIs/services for:
  - Listing ledger entries with filters and pagination
  - Fetching a single ledger entry by ID
  - Reason codes list for adjustments (or an enum endpoint)
  - Adjustment request creation and approval/posting (if UI is expected to initiate these)
- Permissions are available to frontend (either via a â€œcurrent user permissionsâ€ endpoint, token claims, or Moqui security context).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Inventory module navigation: **Inventory â†’ Ledger**
- Contextual entry points:
  - From Product detail: â€œView Ledgerâ€
  - From Location detail: â€œView Ledgerâ€
  - From Work Order Line (Work Execution area): â€œView Movement Historyâ€ (view-only link with pre-applied filters)

### Screens to create/modify (Moqui)
1. **Screen:** `apps/pos/screen/inventory/Ledger.xml` (or equivalent per repo conventions)
   - Main list screen with filter form + results grid
2. **Screen:** `apps/pos/screen/inventory/LedgerEntryDetail.xml`
   - Read-only detail view of a ledger entry
3. **(Optional, if adjustments are frontend-initiated here)**:
   - `apps/pos/screen/inventory/Adjustments.xml` (list of adjustment requests)
   - `apps/pos/screen/inventory/AdjustmentDetail.xml` (create/request + approve/post)
   - If adjustments are managed elsewhere, then only provide action buttons that route to existing screens.

### Navigation context
- Breadcrumbs:
  - Inventory â†’ Ledger
  - Inventory â†’ Ledger â†’ Entry `<ledgerEntryId>`
- Deep links:
  - `/inventory/ledger` with query params
  - `/inventory/ledger/entry/<ledgerEntryId>`

### User workflows
**Happy path (view ledger):**
1. User opens Ledger screen
2. Filters by product/location/date range
3. Reviews results and opens a row to see details

**Alternate path (work order movement history):**
1. User comes from work order line link
2. Ledger loads pre-filtered by `sourceTransactionId` (and/or workorderLineId if supported)
3. User inspects movements and navigates back

**Adjustment path (permission-gated):**
1. User with `INVENTORY_ADJUST_CREATE` clicks â€œNew Adjustmentâ€
2. Completes required fields (product, location, qty change, UOM, reasonCode)
3. Saves as pending/draft request
4. Approver with `INVENTORY_ADJUST_APPROVE` opens request and posts it
5. UI shows resulting posted status and ledger entry link (if returned)

---

## 6. Functional Behavior

### Triggers
- Screen load triggers ledger query with default filters (see Safe Defaults).
- Filter form submission triggers refreshed query.
- Row click triggers load of ledger entry details.
- Adjustment actions trigger create/approve/post service calls (if included).

### UI actions
- **Filter controls** (all optional unless specified):
  - `productId` (lookup/search)
  - `locationId` (single selection; applies to either from/to matching)
  - `movementType` (multi-select or single-select)
  - `dateFrom`, `dateTo` (UTC aware display; query in ISO)
  - `sourceTransactionId` (text)
- **Results grid**
  - Sort by `timestamp` descending by default
  - Columns: timestamp, movementType, productId (and name if available), qtyChange, UOM, from, to, actor, reasonCode, sourceTransactionId
- **Detail view**
  - Read-only display of all fields; highlight adjustment reason and actor

### State changes (frontend)
- No client-side mutation of ledger records
- Adjustment request UI: local form state changes; after submit, state updates from server response

### Service interactions
- `load` ledger entries list on screen enter and on filter changes
- `load` ledger entry by ID on detail screen
- `create` adjustment request (requires permission)
- `approve/post` adjustment request (requires permission)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Ledger list filters:
  - `dateFrom` must be <= `dateTo` when both set; otherwise show inline validation error and do not call backend.
- Adjustment request create:
  - `reasonCode` is **required**
  - `quantityChange` is **required** and must be non-zero (backend disallows zero-like ambiguity; UI should prevent submit if 0)
  - `productId` required
  - `locationId` required (maps to from/to per adjustment semantics; see Open Questions if unclear)
  - `unitOfMeasure` required
- Approval/post:
  - Must be in a pending state (UI disables action if not pending; still rely on backend enforcement)

### Enable/disable rules
- â€œNew Adjustmentâ€ button visible/enabled only when user has `INVENTORY_ADJUST_CREATE`
- â€œApprove/Postâ€ button visible/enabled only when user has `INVENTORY_ADJUST_APPROVE`
- Edit/delete controls for ledger entries: **never shown**
- If backend returns `PERMISSION_DENIED`/403, show an access error and keep user on page

### Visibility rules
- `reasonCode` field displayed prominently for `movementType = ADJUST`
- For non-adjust movements, `reasonCode` display as â€œâ€”â€ when null
- `fromLocationId` and `toLocationId` may be null; UI must render â€œâ€”â€ and not crash

### Error messaging expectations
- Map backend error codes/messages to user-readable text:
  - `PRODUCT_NOT_FOUND` â†’ â€œProduct not found.â€
  - `LOCATION_NOT_FOUND` â†’ â€œLocation not found.â€
  - `INSUFFICIENT_STOCK` â†’ â€œInsufficient stock for this movement.â€
  - `REASON_CODE_REQUIRED` â†’ â€œReason is required for adjustments.â€
  - `PERMISSION_DENIED`/403 â†’ â€œYou donâ€™t have permission to perform this action.â€
- Unknown errors: show generic failure with correlation/trace id if provided

---

## 8. Data Requirements

### Entities involved (frontend read/write)
- **InventoryLedgerEntry** (read-only)
- **ReasonCode** (read-only list for adjustments)
- **AdjustmentRequest** (if adjustment request workflow is in frontend scope; otherwise only link out)

### Fields (type, required, defaults)
**InventoryLedgerEntry (read-only)**
- `ledgerEntryId` (UUID/string, required)
- `productId` (UUID/string, required)
- `timestamp` (UTC timestamp, required)
- `movementType` (enum string, required): `RECEIVE | PUT_AWAY | PICK | ISSUE | RETURN | TRANSFER | ADJUST`
- `quantityChange` (decimal, required)
- `unitOfMeasure` (string, required)
- `fromLocationId` (string, nullable)
- `toLocationId` (string, nullable)
- `actorId` (string, required)
- `reasonCode` (enum string, nullable except for ADJUST)
- `sourceTransactionId` (string, nullable)

**AdjustmentRequest (write) â€“ minimal frontend needs**
- `productId` (required)
- `locationId` (required) *(exact mapping to from/to depends on backend contract; see Open Questions)*
- `quantityChange` (decimal, required, non-zero)
- `unitOfMeasure` (required)
- `reasonCode` (required)
- `notes` (optional, if supported)
- `requestedBy` (server-derived)
- `requestedAt` (server-derived)
- `status` (`PENDING`/`APPROVED`/`POSTED` etc.; server authoritative)

### Read-only vs editable by state/role
- Ledger entry fields: always read-only
- Adjustment request:
  - Editable only in draft/pending by creator (if backend supports); otherwise read-only after submit
  - Approval action only for users with approve permission

### Derived/calculated fields
- â€œDirectionâ€ derived in UI from `quantityChange` sign (Increase/Decrease)
- â€œLocationâ€ display:
  - For list filtering by location: include entries where either `fromLocationId == locationId` OR `toLocationId == locationId`

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names/endpoints are not provided in inputs; the frontend must integrate with the backend contract. If Moqui is acting as backend faÃ§ade, implement screens calling Moqui services that proxy to backend APIs.

### Load/view calls
1. **List ledger entries**
   - **Request params:** `productId?`, `locationId?`, `movementType?` (single or list), `dateFrom?`, `dateTo?`, `sourceTransactionId?`, `pageIndex`, `pageSize`, `sort=-timestamp`
   - **Response:** paginated list of `InventoryLedgerEntry` + total count
2. **Get ledger entry detail**
   - **Request:** `ledgerEntryId`
   - **Response:** `InventoryLedgerEntry`

3. **List reason codes**
   - **Response:** `[ { code, label, description? } ]` or enum list

### Create/update calls
4. **Create adjustment request**
   - **Request body:** productId, locationId, quantityChange, unitOfMeasure, reasonCode, notes?
   - **Response:** created adjustment request object, including its ID and status

### Submit/transition calls
5. **Approve/post adjustment**
   - **Request:** adjustmentRequestId (and optional concurrency token/version if supported)
   - **Response:** updated request status and (ideally) resulting `ledgerEntryId` link

### Error handling expectations
- Support standard HTTP:
  - 400 validation errors with field-level messages when possible
  - 403 for permission issues
  - 404 for missing resources
  - 409 for concurrency conflicts (if adjustment approvals are versioned)
- Frontend must show actionable message and preserve user input on validation failures

---

## 10. State Model & Transitions

### Ledger entries
- **State model:** immutable append-only records
- **Transitions:** none (no edit/delete)

### Adjustment requests (if in scope)
- **States (minimum):** `PENDING` â†’ `POSTED` (or `APPROVED` then `POSTED` depending on backend)
- **Allowed transitions:**
  - Create: (none) â†’ `PENDING` (requires `INVENTORY_ADJUST_CREATE`)
  - Post/Approve: `PENDING` â†’ `POSTED` (requires `INVENTORY_ADJUST_APPROVE`)
- **Role/permission-based transitions:**
  - UI must check permission before rendering actions; backend enforces truth

### UI behavior per state
- `PENDING`: show â€œApprove/Postâ€ if permitted; show read-only summary
- `POSTED`: show link to created ledger entry; actions disabled

---

## 11. Alternate / Error Flows

### Validation failures
- Invalid date range: block query; show inline message
- Adjustment missing reason: disable submit and/or show field error; backend error mapped if returned

### Concurrency conflicts
- If approve/post returns 409 (already posted/changed):
  - Reload request and show message: â€œThis adjustment was updated by another user. Current status: <status>.â€

### Unauthorized access
- If user opens adjustment screens without permission:
  - Show access denied state; do not attempt restricted service calls

### Empty states
- No ledger entries match filters:
  - Show â€œNo movements found for the selected criteria.â€
  - Provide â€œClear filtersâ€ action

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View ledger list with default sorting
**Given** I am an authenticated Inventory Manager  
**When** I navigate to Inventory â†’ Ledger  
**Then** I see a list of ledger entries sorted by timestamp descending  
**And** I can open an entry to view its read-only details  
**And** I do not see any Edit or Delete actions for ledger entries

### Scenario 2: Filter ledger by product and location
**Given** ledger entries exist for product `SKU-123` in locations `RCV-01` and `BIN-C4`  
**When** I filter by product `SKU-123` and location `BIN-C4`  
**Then** the results include entries where `fromLocationId = BIN-C4` or `toLocationId = BIN-C4`  
**And** entries for other products are not shown

### Scenario 3: Ledger detail renders nullable fields safely
**Given** a ledger entry exists with `fromLocationId = null` and `toLocationId = RCV-01`  
**When** I open the ledger entry detail screen  
**Then** the UI displays `fromLocationId` as â€œâ€”â€  
**And** the UI displays `toLocationId` as `RCV-01`  
**And** no client error occurs

### Scenario 4: Adjustment create requires permission and reason code
**Given** I am logged in **without** permission `INVENTORY_ADJUST_CREATE`  
**When** I view the Ledger screen  
**Then** I do not see an enabled â€œNew Adjustmentâ€ action  
**And** if I attempt to access the adjustment create route directly  
**Then** I see an access denied message

**Given** I am logged in **with** permission `INVENTORY_ADJUST_CREATE`  
**When** I start a new adjustment request  
**And** I leave `reasonCode` blank  
**Then** the UI prevents submission and shows â€œReason is required for adjustments.â€

### Scenario 5: Approve/post adjustment requires permission
**Given** an adjustment request exists in `PENDING` status  
**And** I am logged in without `INVENTORY_ADJUST_APPROVE`  
**When** I view that adjustment request  
**Then** I cannot approve/post it  
**And** if I attempt to post via UI action, the backend response is handled and an access denied message is shown

### Scenario 6: Backend validation error is surfaced clearly
**Given** I am creating an adjustment request  
**When** the backend responds with error code `INSUFFICIENT_STOCK`  
**Then** the UI shows â€œInsufficient stock for this movement.â€  
**And** my entered form values remain available for correction

---

## 13. Audit & Observability

### User-visible audit data
- Ledger list and detail must display:
  - `actorId`
  - `timestamp` (display in user locale, sourced from UTC)
  - `sourceTransactionId` (when present)
  - `reasonCode` (when present, especially for ADJUST)

### Status history
- For adjustment requests (if implemented): display status and timestamps returned by backend (`requestedAt`, `approvedAt/postedAt`), and `requestedBy/approvedBy` if provided.

### Traceability expectations
- UI should display `ledgerEntryId` on detail screen for referencing during investigations.
- If backend provides correlation ID in error responses/headers, surface it in an expandable â€œTechnical detailsâ€ area.

---

## 14. Non-Functional UI Requirements
- **Performance:** Ledger list must support pagination; do not load unbounded results.
- **Accessibility:** All form controls must have labels; table must be navigable via keyboard; error messages must be programmatically associated with fields.
- **Responsiveness:** Filters and results usable on tablet widths; table may switch to a stacked row layout if needed.
- **i18n/timezone:** Timestamps stored in UTC; display in userâ€™s timezone; movementType and reasonCode labels should be translatable if label resources exist. Currency not applicable.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a standard empty-results state with â€œClear filtersâ€ action; safe because it does not change domain behavior. (Impacted: UX Summary, Alternate / Error Flows)
- SD-UX-PAGINATION: Default page size of 25 with server-side pagination; safe because it only affects presentation/performance. (Impacted: UX Summary, Service Contracts, Non-Functional)
- SD-ERR-MAP-GENERIC: Map unknown backend errors to a generic failure message while preserving trace/correlation id when available; safe because it does not alter business rules. (Impacted: Business Rules, Error Flows, Observability)

---

## 16. Open Questions
1. **Backend contract for ledger queries:** What are the exact Moqui service names or REST endpoints, including query parameter names and pagination response shape (items/total, page tokens, etc.)?
2. **Adjustment UI scope:** Should the frontend implement full Adjustment Request screens in this repo, or only provide links to an existing adjustments area? If full, what is the adjustment request entity name/fields and state machine (`PENDING/APPROVED/POSTED`)?
3. **Location filtering semantics:** For the ledger list filter by location, should it match `fromLocationId OR toLocationId` (recommended for usability), or only a specific side depending on movement type?
4. **Workexec integration key:** For â€œWorkexec can query movement history for a workorder lineâ€, what identifier is available in ledger entriesâ€”`sourceTransactionId` only, or a dedicated `workorderId/workorderLineId` field?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Ledger: Record Stock Movements in Inventory Ledger â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/101


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Ledger: Record Stock Movements in Inventory Ledger
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/101
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Ledger: Record Stock Movements in Inventory Ledger

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As an **Inventory Manager**, I want all stock movements recorded in a ledger so that on-hand is auditable and explainable.

## Details
- Movement types: Receive, PutAway, Pick, Issue/Consume, Return, Transfer, Adjust.
- Capture productId, qty, UOM, from/to storage, actor, timestamp, reason.

## Acceptance Criteria
- Every movement creates a ledger entry.
- Ledger is append-only.
- Can reconstruct on-hand by replay.
- Adjustments require reason and permission.

## Integrations
- Workexec can query movement history for a workorder line.

## Data / Entities
- InventoryLedgerEntry, MovementType, ReasonCode, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #103: [FRONTEND] [STORY] Topology: Create Storage Locations (Floor/Shelf/Bin/Cage/Truck) and Hierarchy â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/103
File: ./scripts/story-work/frontend/103/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)
### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Topology: Create/Update/Deactivate Storage Locations (Floor/Shelf/Bin/Cage/Yard/MobileTruck/Quarantine) with Site Hierarchy

### Primary Persona
Inventory Manager

### Business Value
Enables precise stock tracking and operational picking/putaway by allowing the business to define an auditable, cycle-free storage location hierarchy within each site, with barcode uniqueness enforcement and controlled deactivation.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Inventory Manager  
- **I want** to create, edit, and deactivate storage locations within a site and organize them into a parent/child hierarchy  
- **So that** inventory can be tracked and referenced accurately by storageLocationId across operational workflows (e.g., picking)

### In-scope
- Moqui/Vue/Quasar frontend screens and flows to:
  - List storage locations by site
  - Create a storage location (optionally as a child of another location)
  - Update a storage location (including changing parent, with cycle prevention)
  - Deactivate a storage location
    - If non-empty: require selecting a destination location in the same site for transfer (per backend reference behavior)
- Frontend validation and error display aligned to backend rules:
  - Barcode unique per site
  - Prevent hierarchy cycles
  - Only enumerated storage types
- Display read-only audit metadata if available via API (created/updated/by, status)

### Out-of-scope
- Rendering a graphical topology map (tree visualization beyond basic hierarchical navigation is optional and not required)
- Managing inventory quantities themselves, transfers outside deactivation workflow, cycle counts
- Workexec/Shopmgr feature changes (only ensure this UI produces/maintains storageLocationId usable by them)
- Defining new storage types in the UI (types are consumed from backend enumeration/list)

---

## 3. Actors & Stakeholders
- **Inventory Manager (primary user):** creates and maintains locations/hierarchy.
- **Warehouse/Store Staff (secondary):** may search/scan barcodes to find a location (future use; this story supports by capturing barcode).
- **Work Execution (system stakeholder):** references `storageLocationId` for pick tasks.
- **Shop Manager (system stakeholder):** may display storage hints (explicitly optional per inputs).

---

## 4. Preconditions & Dependencies
- User is authenticated in the frontend and has permission to manage storage locations.
- At least one **Site** exists and is selectable/known in navigation context.
- Backend capabilities exist (or will exist) to:
  - Create/update storage locations with validation (barcode uniqueness, no cycles)
  - Deactivate location; if non-empty require `destinationLocationId` and perform atomic transfer + deactivate
  - Provide storage type values (`Floor`, `Shelf`, `Bin`, `Cage`, `Yard`, `MobileTruck`, `Quarantine`)
- Dependency: backend story reference indicates non-empty deactivation behavior; frontend must support destination selection workflow.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Inventory module navigation: **Inventory â†’ Topology â†’ Storage Locations**
- Deep links:
  - `/inventory/topology/locations` (site context required or selected on page)
  - `/inventory/topology/locations/<storageLocationId>` (details/edit)

### Screens to create/modify (Moqui)
Create/extend the following screens (names may align to repo conventions; implementer to place under the inventory app):
1. **StorageLocationList** screen
   - Site selector (or uses site context from session)
   - Table/list of locations (filterable)
   - Actions: View/Edit, Create New, Deactivate
2. **StorageLocationDetail** screen
   - Read-only summary + edit form
   - Hierarchy controls (parent selection)
   - Audit/status display
3. **StorageLocationCreate** screen (may be same as detail with create mode)
4. **StorageLocationDeactivate** dialog/screen (confirm + destination selection if required)

### Navigation context
- Site context must be visible and drive list/filter and creation.
- When creating a child location from within a parent detail screen, parent is pre-selected.

### User workflows
#### Happy path: create top-level location
1. Inventory Manager opens StorageLocationList
2. Selects Site
3. Clicks â€œCreate Locationâ€
4. Enters required fields and saves
5. Redirect to detail screen with success message

#### Happy path: create child location
1. From parent location detail, user clicks â€œAdd Child Locationâ€ (or Create with prefilled parent)
2. Saves
3. Child appears under same site and links back to parent

#### Happy path: update location including parent change
1. Open detail
2. Change fields (including parent)
3. Save; UI handles validation errors from backend (cycle, invalid parent, duplicate barcode)

#### Happy path: deactivate empty location
1. From detail or list, choose Deactivate
2. Confirm
3. Status becomes Inactive; location becomes non-selectable as parent/destination (except for historical display)

#### Alternate path: deactivate non-empty location (requires transfer destination)
1. User clicks Deactivate
2. Backend indicates destination required (either by pre-check endpoint or error response)
3. UI prompts to select destination location (Active, same site, not the same as source)
4. Submit; show progress and success/failure

---

## 6. Functional Behavior

### Triggers
- User visits list/detail routes
- User submits create/update form
- User triggers deactivate action

### UI actions
- **List**
  - Filter by: status (Active/Inactive/All), storageType, search (name or barcode)
  - Select site
  - Open create
- **Create/Update**
  - Form submit
  - Cancel returns to list/detail without changes
- **Deactivate**
  - Confirmation modal
  - If needed: destination selection control + submit

### State changes (frontend)
- After successful create: route to detail, show toast/banner
- After successful update: remain on detail, show success, refresh data
- After successful deactivation: update status to Inactive and disable editing actions that backend disallows

### Service interactions (Moqui)
- Screen load actions call service(s) to fetch:
  - Site list (or current site)
  - Storage types
  - Storage location list for site
  - Storage location detail including parent/site/status
- Form submit actions call create/update services
- Deactivate flow calls deactivate service (with optional destinationLocationId)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Required fields on create:
  - `siteId` (required)
  - `name` (required)
  - `barcode` (required)
  - `storageType` (required, must be one of allowed values)
- Optional fields:
  - `parentLocationId` (nullable)
  - `capacity` (optional structured input; see Data Requirements)
  - `temperature` (optional structured input; see Data Requirements)
- **Barcode uniqueness within site**
  - UI should do basic client-side check: non-empty and trim whitespace
  - Server is authoritative; display specific error returned for duplicates
- **Prevent hierarchy cycles**
  - UI should prevent selecting self as parent
  - UI should rely on backend for deep cycle detection and display returned error clearly

### Enable/disable rules
- If `status=Inactive`:
  - Disable â€œDeactivateâ€ action (already inactive)
  - Disable edits that backend disallows (at minimum: prevent saving changes unless backend supports editing inactive; if unknown, allow attempt but handle 4xx gracefully)
  - Exclude inactive locations from parent picker by default (configurable; see Open Questions)
- Parent picker:
  - Must only show locations within the same site
  - Must exclude the current location and (ideally) its descendants (if API supports); otherwise rely on backend rejection

### Visibility rules
- Show destination selector only when required for deactivation of non-empty location (see Service Contracts / Error Flows)
- Show audit metadata section when provided by backend

### Error messaging expectations
- Display backend validation message next to corresponding field when possible (barcode, parent)
- For deactivation:
  - If destination required, show inline error â€œDestination required to deactivate non-empty locationâ€
  - If invalid destination, show â€œDestination must be Active and in the same siteâ€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- `StorageLocation`
- `Site` (for selection/context)
- `AuditLog` / audit metadata (if exposed)
- `StorageType` (enumerated values or entity/list)

### StorageLocation fields
| Field | Type | Required | Default | Editable? | Notes |
|---|---|---:|---|---|---|
| storageLocationId | string/UUID | yes (system) | n/a | read-only | immutable identifier |
| siteId | string/UUID | yes | none | create-only (recommended) | changing site is not specified; treat as non-editable after create unless backend supports |
| parentLocationId | string/UUID/null | no | null | editable | must be same site; cannot form cycle |
| name | string | yes | none | editable | |
| barcode | string | yes | none | editable | unique per site |
| storageType | string enum | yes | none | create-only (recommended) | not specified if editable; if backend allows, allow edit; otherwise lock after create |
| status | enum (Active/Inactive) | yes | Active | read-only via deactivate | |
| capacity | object/json | no | null | editable | structure not fully specified |
| temperature | object/json | no | null | editable | structure not fully specified |
| createdAt/updatedAt | datetime | yes | system | read-only | display if available |
| createdBy/updatedBy | string/userId | ? | system | read-only | display if available |

### Derived/calculated fields (UI)
- `displayPath` (derived): e.g., `Floor > Shelf > Bin` for list/detail breadcrumbs if hierarchy info is available
- `isDeactivationTransferRequired` (derived from backend response or pre-check)

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names/endpoints are not provided in inputs. The frontend must integrate with Moqui backend services consistent with project conventions. Where contract is unknown, the UI must be built to map standard 4xx errors to field/form messages.

### Load/view calls
- **List sites**
  - Purpose: populate site selector
  - Expected: `[{siteId, name}]`
- **List storage types**
  - Expected: `["Floor","Shelf","Bin","Cage","Yard","MobileTruck","Quarantine"]` or `{enumId, description}`
- **List storage locations by site**
  - Inputs: `siteId`, optional filters (`status`, `storageType`, `search`, pagination)
  - Expected: list of locations with minimal fields for display
- **Get storage location detail**
  - Inputs: `storageLocationId`
  - Expected: full record + parent info + audit metadata (if available)

### Create/update calls
- **Create storage location**
  - Inputs: `siteId, name, barcode, storageType, parentLocationId?, capacity?, temperature?`
  - Success: returns created `storageLocationId`
  - Errors:
    - 400 validation (duplicate barcode, invalid parent, invalid type)
    - 403 unauthorized
- **Update storage location**
  - Inputs: `storageLocationId` + editable fields
  - Errors:
    - cycle detected
    - duplicate barcode (within same site)
    - invalid parent/site mismatch

### Submit/transition calls
- **Deactivate storage location**
  - Inputs: `storageLocationId`, optional `destinationLocationId`
  - Success: status becomes Inactive
  - Errors:
    - `DESTINATION_REQUIRED` when non-empty without destination
    - `INVALID_DESTINATION` when destination invalid/inactive/different site
    - transfer failure (generic 409/500 with message)

### Error handling expectations (frontend)
- Map:
  - `400` â†’ show validation messages; keep user inputs
  - `403` â†’ show â€œYou donâ€™t have permissionâ€¦â€ and disable actions if possible
  - `404` â†’ show â€œLocation not foundâ€ and route back to list
  - `409`/transfer failure â†’ show non-field error banner; allow retry

---

## 10. State Model & Transitions

### Allowed states (StorageLocation.status)
- `Active`
- `Inactive`

### Role-based transitions
- Inventory Manager:
  - `Active` â†’ `Inactive` via Deactivate action
- Reactivation is not specified (not in scope)

### UI behavior per state
- **Active**
  - Editable fields enabled
  - Deactivate action available
- **Inactive**
  - Display read-only
  - Deactivate hidden/disabled
  - Excluded from parent/destination pickers by default

---

## 11. Alternate / Error Flows

### Validation failures
- Duplicate barcode within site:
  - On create/update submit, backend returns field error; UI highlights barcode and shows message
- Cycle detected:
  - On parent change submit, backend rejects; UI shows message near parent selector
- Invalid parent:
  - UI shows error and does not change hierarchy display

### Concurrency conflicts
- If backend returns optimistic lock/conflict (not specified):
  - UI shows â€œThis location was updated by someone else. Refresh and try again.â€
  - Provide Refresh action

### Unauthorized access
- User without required permission:
  - List may be viewable or not (unclear); if forbidden, show access denied page
  - For create/update/deactivate, show disabled buttons if permission info is available; otherwise handle 403 on submit

### Empty states
- No locations in site:
  - Show empty state with CTA â€œCreate first locationâ€
- No sites:
  - Show blocking message â€œNo sites availableâ€ (cannot proceed)

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create a top-level storage location
**Given** I am logged in as an Inventory Manager  
**And** I have selected a Site `S1`  
**When** I create a storage location with name `Main Floor`, barcode `FL-01`, storageType `Floor`, and no parent  
**Then** the system saves the location with status `Active`  
**And** I am navigated to the location detail page  
**And** the detail page shows parent as empty/null and site as `S1`.

### Scenario 2: Create a child storage location under a parent
**Given** I am on the detail page for an existing location `FL-01` in site `S1`  
**When** I create a new location with name `Shelf A1`, barcode `SH-A1`, storageType `Shelf`, and parent `FL-01`  
**Then** the system saves the new location  
**And** the new location detail shows parent `FL-01`  
**And** navigating back to the list filtered by site `S1` shows both locations.

### Scenario 3: Reject duplicate barcode within the same site
**Given** a storage location exists in site `S1` with barcode `BIN-X99`  
**When** I attempt to create another storage location in site `S1` with barcode `BIN-X99`  
**Then** the UI displays a validation error on the barcode field indicating the barcode must be unique within the site  
**And** the record is not created.

### Scenario 4: Reject hierarchy changes that would create a cycle
**Given** a hierarchy exists in site `S1` where `Floor-1` is parent of `Shelf-A` and `Shelf-A` is parent of `Bin-A1`  
**When** I attempt to edit `Floor-1` and set its parent to `Bin-A1`  
**Then** the UI displays an error indicating a hierarchy cycle was detected  
**And** the parent value remains unchanged after refresh.

### Scenario 5: Deactivate an empty location
**Given** an Active storage location `Cage-03` exists and contains no stock  
**When** I deactivate `Cage-03` and confirm  
**Then** the UI shows the location status as `Inactive`  
**And** the deactivate action is no longer available.

### Scenario 6: Require destination when deactivating a non-empty location
**Given** an Active storage location `Bin-12` exists and contains stock  
**When** I deactivate `Bin-12` without selecting a destination location  
**Then** the UI shows an error that a destination is required  
**And** `Bin-12` remains `Active`.

### Scenario 7: Deactivate non-empty location with valid transfer destination
**Given** an Active storage location `Bin-12` exists and contains stock in site `S1`  
**And** an Active storage location `Bin-13` exists in the same site `S1`  
**When** I deactivate `Bin-12` and select `Bin-13` as the destination  
**Then** the UI reports success  
**And** `Bin-12` becomes `Inactive`.

---

## 13. Audit & Observability

### User-visible audit data
- On detail page, show (when provided):
  - createdAt, createdBy
  - updatedAt, updatedBy
  - status change timestamp (if available)
- For deactivation with transfer, show a confirmation success message that includes source and destination identifiers (names/barcodes) if returned.

### Status history
- If backend exposes status history/audit log entries, provide a read-only â€œActivityâ€ section listing create/update/deactivate events with timestamp and actor.
- If not available, do not fabricate; show only current metadata.

### Traceability expectations
- Frontend should include correlation/request ID in console logs if available via standard API response headers (implementation-dependent).
- Ensure errors are surfaced with enough context for support: locationId, siteId (not PII).

---

## 14. Non-Functional UI Requirements

- **Performance:** List screen should support pagination and server-side filtering when available; initial load should not fetch entire hierarchy for very large sites unless required.
- **Accessibility:** Forms must be keyboard-navigable; validation errors must be announced (aria) and associated with fields.
- **Responsiveness:** Usable on tablet; critical actions (save/deactivate) must remain reachable.
- **i18n/timezone:** Display timestamps in user locale/timezone if the app supports it; otherwise display in ISO with timezone indicator. (No currency requirements.)

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a standard empty state with CTA on the list screen; qualifies as safe because it does not affect business logic; impacts UX Summary, Alternate/Empty states.
- SD-UX-PAGINATION: Default to paginated listing with simple filters (status/type/search); qualifies as safe because it is presentation-only and does not change domain rules; impacts UX Summary, Service Contracts.
- SD-ERR-HTTP-MAP: Map common HTTP statuses (400/403/404/409/500) to inline and banner errors; qualifies as safe because it follows standard error handling without inventing policy; impacts Service Contracts, Error Flows.

---

## 16. Open Questions
1. What are the exact Moqui service names / REST endpoints and response schemas for:
   - list sites, list storage types, list locations by site, get location detail, create, update, deactivate?
2. Are `capacity` and `temperature` structured JSON inputs expected to follow a defined schema (keys/units), or should the frontend treat them as freeform JSON text?
3. Can an **Inactive** storage location be edited (e.g., name/barcode fixes), or must it be fully read-only?
4. Is changing `storageType` allowed after creation, or is it immutable?
5. Should parent selection exclude **Inactive** locations strictly, or allow choosing an inactive parent for historical organization (while still preventing operational use)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Topology: Create Storage Locations (Floor/Shelf/Bin/Cage/Truck) and Hierarchy â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/103

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Topology: Create Storage Locations (Floor/Shelf/Bin/Cage/Truck) and Hierarchy  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/103  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Topology: Create Storage Locations (Floor/Shelf/Bin/Cage/Truck) and Hierarchy

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As an **Inventory Manager**, I want to define storage locations and hierarchy so that stock can be tracked precisely.

## Details  
- Types: Floor, Shelf, Bin, Cage, Yard, MobileTruck, Quarantine.  
- Parent/child relationships within a site.  
- Attributes: barcode, capacity (optional), temperature (optional).

## Acceptance Criteria  
- Create/update/deactivate storage locations.  
- Prevent cycles in hierarchy.  
- Uniqueness of barcode within site.  
- Audited.

## Integrations  
- Workexec pick tasks reference storageLocationId.  
- Shopmgr can display storage hints (optional).

## Data / Entities  
- StorageLocation, StorageType, StorageHierarchy, AuditLog

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Inventory Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #104: [FRONTEND] [STORY] Topology: Sync Locations from durion-hr â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/104
File: ./scripts/story-work/frontend/104/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Topology: Sync Locations from durion-hr (Admin UI for LocationRef + SyncLog)  
**Primary Persona:** Inventory Admin / Ops Admin (with inventory topology permissions)  
**Business Value:** Ensures inventory operations are scoped to the authoritative roster of valid shops/mobile sites by providing visibility into synced LocationRefs and auditability of sync runs, and by preventing selection/use of deactivated locations in inventory flows.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Inventory Admin (and the System via scheduled/event-driven sync),
- **I want** a frontend interface to view synced locations (LocationRef) and sync audit logs (SyncLog),
- **So that** I can confirm topology is up-to-date, detect drift/failures, and ensure users cannot initiate new stock movements to inactive locations.

### In-scope
- Moqui/Quasar screens to:
  - List/search/view **LocationRef** records synced from `durion-hr`
  - View **SyncLog** entries for runs/events and outcomes
  - Provide â€œSync nowâ€ (manual trigger) **if** backend supports it
- UI enforcement in inventory-related location pickers (where locations are selected) to block **inactive** locations from being selectable for **new** stock movements, consistent with backend rules.
- Display of location status/timezone/tags in location selection contexts.

### Out-of-scope
- Implementing the actual sync ingestion/reconciliation logic (backend responsibility)
- Automatic transfers, reconciliation workflows for PendingTransfer stock, or inventory ledger operations
- Editing HR-owned fields (name/status/timezone/tags) from the frontend (must be read-only)
- Defining/implementing permissions/roles beyond using existing authz checks from backend

---

## 3. Actors & Stakeholders
- **Inventory Admin / Ops Admin:** monitors location roster, audits sync runs, investigates failures
- **Warehouse Staff / Service Advisors:** choose locations for stock movements; must be prevented from using inactive locations
- **SRE/Ops:** uses sync logs/metrics to monitor health and troubleshoot
- **durion-hr system:** authoritative topology source (upstream)

---

## 4. Preconditions & Dependencies
- Backend provides read APIs for:
  - `LocationRef` list/detail (including `hrLocationId`, `name`, `status/isActive`, `timezone`, `tags`, timestamps, version)
  - `SyncLog` list/detail (including `hrEventId`, payload summary, appliedAt, outcome, errorMessage)
- Backend enforces: â€œDeactivated locations cannot receive new stock movementsâ€ (rejects with 422); frontend should proactively prevent selection.
- Frontend has at least one inventory flow that selects a location for a stock movement (receipt/transfer/consume/adjust). If none exist yet, this story can only implement admin visibility screens and defer picker enforcement.

**Dependency:** Backend story `durion-positivity-backend#40` (Topology: Sync Locations from durion-hr) should be available or stubbed in Moqui services.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Inventory â†’ Topology â†’ Locations (Synced)**
- Main navigation: **Inventory â†’ Topology â†’ Sync Logs**

### Screens to create/modify
1. **New Screen:** `apps/pos/inventory/topology/LocationRefList.xml`
   - List + filters + row navigation to detail
2. **New Screen:** `apps/pos/inventory/topology/LocationRefDetail.xml`
   - Read-only detail of a location ref + recent sync log entries for that `hrLocationId`
3. **New Screen:** `apps/pos/inventory/topology/SyncLogList.xml`
   - List + filters (date range, outcome, hrLocationId, hrEventId)
4. **Optional New Screen/Section:** embedded â€œSync run detailsâ€ (if backend exposes run IDs)
5. **Modify existing inventory movement screens/components** (where a location is selected):
   - Enforce that only Active locations are selectable for new movements
   - Show clear messaging if an inactive location is pre-populated (historical record) but cannot be used for new actions

### Navigation context
- From LocationRef list â†’ LocationRef detail
- From SyncLog list â†’ (optional) SyncLog detail or modal viewer for payload/error
- Cross-links:
  - From LocationRef detail â†’ filtered SyncLog list for that location
  - From SyncLog row (if contains `hrLocationId`) â†’ LocationRef detail

### User workflows
- **Happy path (admin visibility):**
  1. Admin opens LocationRef list
  2. Filters to Active/Inactive, searches by name or HR location ID
  3. Opens a record to confirm timezone/tags/status and sees recent SyncLog outcomes
- **Alternate path (failure investigation):**
  1. Admin opens SyncLog list
  2. Filters to `FAILED` or `INVALID_PAYLOAD`
  3. Opens payload/error to diagnose and share with SRE/back-end team
- **Operational path (picker enforcement):**
  1. User opens a stock movement screen
  2. Location picker shows only Active locations
  3. If user tries to proceed with an inactive location (e.g., via stale state), UI blocks and shows message; backend would also reject with 422.

---

## 6. Functional Behavior

### Triggers
- User navigates to Topology screens
- User searches/filters lists
- User opens details
- (Optional) User clicks â€œSync nowâ€ to trigger reconciliation

### UI actions
- List paging, sorting, filtering
- View detail
- Copy-to-clipboard for IDs (hrLocationId, internal id, hrEventId)
- Open payload viewer (read-only) for SyncLog entries (truncate large payloads with expand)

### State changes
- None directly in `LocationRef` (read-only in UI)
- If â€œSync nowâ€ exists: creates a backend sync run and new SyncLog entries (backend-owned)

### Service interactions
- Load list/detail via Moqui services (see section 9)
- For location pickers: load Active-only locations; if backend returns inactive in a detail context, mark as disabled and show reason.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- No frontend editing of HR-owned fields (`hrLocationId`, `name`, `status`, `timezone`, `tags`)
- Filters:
  - Status filter supports `ACTIVE` and `INACTIVE` (and `PENDING` only if backend uses it)

### Enable/disable rules
- Location selection controls for **new stock movements** must:
  - Only allow selection of locations where `isActive=true` (or `status=ACTIVE`)
  - Disable/omit inactive locations from dropdown/search results
- If a screen displays a historical movement referencing an inactive location:
  - The location may be displayed read-only, but action buttons that create a *new* movement to that location must be disabled with explanatory text.

### Visibility rules
- SyncLog error message shown only when `outcome in (FAILED, INVALID, RETRY)` and `errorMessage` present
- Payload viewer only for authorized users if backend restricts (UI must handle 403)

### Error messaging expectations
- When backend returns **422** for movement attempts to inactive locations, show:
  - â€œLocation is inactive and cannot receive new stock movements. Select an active location.â€
- For 403: â€œYou do not have permission to view this resource.â€
- For 5xx/timeouts: generic retry guidance; do not expose stack traces.

---

## 8. Data Requirements

### Entities involved (frontend-viewed)
- **LocationRef** (inventory-owned reference table)
- **SyncLog** (immutable audit log)

### Fields
**LocationRef (read-only UI)**
- `id` (UUID, required, read-only)
- `tenantId` (string, required, read-only; may be implicit)
- `hrLocationId` (string, required, read-only)
- `name` (string, required, read-only)
- `status` (enum: `ACTIVE|INACTIVE|PENDING`, required)
- `isActive` (boolean, derived or stored; required if present)
- `timezone` (string IANA TZ, required if provided)
- `tags` (JSON, optional; display as key/value chips or JSON viewer)
- `effectiveFrom` / `effectiveTo` (datetime, optional)
- `createdAt/By`, `updatedAt/By` (datetime/string, optional)
- `deactivatedAt/By` (datetime/string, optional)
- `version` (number, optional, for optimistic locking; display only)

**SyncLog (read-only UI)**
- `syncId` (UUID, required)
- `hrEventId` (string, optional/required depending on backend)
- `hrPayload` (JSON, optional; may be truncated)
- `appliedAt` (datetime, required)
- `appliedBy` (string, optional)
- `outcome` (enum: `OK|INVALID|RETRY|FAILED`, required)
- `errorMessage` (string, optional)
- (Optional) `hrLocationId` (string, if backend includes to filter; otherwise link via payload)

### Read-only vs editable by state/role
- All fields read-only in this story.
- â€œSync nowâ€ action (if present) is a button, not entity editing.

### Derived/calculated fields
- UI-derived:
  - `displayStatus` = `status` plus `isActive` indicator if both exist
  - `tagCount` = number of keys in tags
  - `payloadPreview` = first N chars/keys of hrPayload for list display

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: backend contract details (service names/paths, request/response shapes) are not provided in inputs; below is Moqui-oriented expectation and must be mapped to actual services once confirmed.

### Load/view calls
- `inventory.locationRef.list`
  - Inputs: `status?`, `isActive?`, `hrLocationId?`, `name?`, `tag?`, `pageIndex`, `pageSize`, `orderBy`
  - Output: list of LocationRef summaries + `totalCount`
- `inventory.locationRef.get`
  - Inputs: `id` **or** `hrLocationId`
  - Output: full LocationRef record
- `inventory.syncLog.list`
  - Inputs: `outcome?`, `hrEventId?`, `hrLocationId?`, `fromDate?`, `toDate?`, pagination
  - Output: list + `totalCount`
- `inventory.syncLog.get` (optional)
  - Inputs: `syncId`
  - Output: full SyncLog incl. payload

### Create/update calls
- None for LocationRef/SyncLog (read-only)
- Optional manual sync trigger:
  - `inventory.topology.syncLocations.trigger`
    - Inputs: `mode` (`FULL|INCREMENTAL`) if supported
    - Output: `syncRunId` or confirmation

### Submit/transition calls
- None

### Error handling expectations
- 401 â†’ route to login/session refresh (existing app behavior)
- 403 â†’ show permission error component
- 404 â†’ show â€œNot foundâ€ with link back to list
- 422 on movement create/submit due to inactive location â†’ show rule-specific message (see section 7)
- Network/5xx â†’ standard retry UI with â€œTry againâ€ and support reference ID if available

---

## 10. State Model & Transitions

### Allowed states (LocationRef)
- `ACTIVE`: selectable for new stock movements
- `INACTIVE`: not selectable for new stock movements
- `PENDING`: display-only; selection behavior **needs clarification** (see Open Questions)

### Role-based transitions
- No frontend transitions. State changes come from `durion-hr` sync.

### UI behavior per state
- ACTIVE: normal display; selectable in pickers
- INACTIVE: badge â€œInactiveâ€; disabled in pickers; detail view shows deactivatedAt/By if available
- PENDING: badge â€œPendingâ€; behavior TBD (block selection until active unless clarified)

---

## 11. Alternate / Error Flows

### Validation failures
- Filter form:
  - If date range invalid (fromDate > toDate), prevent search and show inline error
- Manual sync trigger (if exists):
  - If backend returns 400, show returned validation message
  - Disable trigger button while request in-flight to prevent duplicates

### Concurrency conflicts
- Not applicable (read-only screens)

### Unauthorized access
- If user lacks permission to view topology:
  - Screen shows 403 state; navigation item hidden if permissions are discoverable client-side (otherwise rely on server response)

### Empty states
- LocationRef list empty:
  - Show â€œNo locations synced yet.â€ and (if manual sync exists) a â€œSync nowâ€ CTA; otherwise instructions to check HR integration.
- SyncLog list empty:
  - Show â€œNo sync activity recorded.â€

---

## 12. Acceptance Criteria

### Scenario 1: View synced locations list
**Given** the user has permission to view inventory topology  
**When** they open â€œInventory â†’ Topology â†’ Locations (Synced)â€  
**Then** the system displays a paginated list of LocationRefs including hrLocationId, name, status (and timezone if available)  
**And** the user can filter by status (ACTIVE/INACTIVE) and search by hrLocationId or name.

### Scenario 2: View a location ref detail and related sync logs
**Given** at least one LocationRef exists  
**When** the user opens a LocationRef detail page  
**Then** the system shows the LocationRef fields as read-only (including status, timezone, tags)  
**And** shows recent SyncLog entries linked to that location (if available) including appliedAt, outcome, and error message for failures.

### Scenario 3: View sync logs and inspect failures
**Given** SyncLog entries exist with outcomes FAILED or INVALID  
**When** the user opens â€œInventory â†’ Topology â†’ Sync Logsâ€ and filters to FAILED  
**Then** the list shows matching entries with hrEventId (if present), appliedAt, outcome, and error message summary  
**And** the user can open a log entry to view payload details (or a safe preview) when permitted.

### Scenario 4: Inactive location is not selectable for new stock movements
**Given** a LocationRef exists with status INACTIVE (or isActive=false)  
**When** a user attempts to select a destination/location on a â€œnew stock movementâ€ screen  
**Then** the inactive location is not selectable (hidden or disabled)  
**And** the UI communicates that inactive locations cannot receive new stock movements.

### Scenario 5: Backend rejects an attempt due to inactive location (defense in depth)
**Given** the user submits a stock movement referencing an inactive location (e.g., stale UI state)  
**When** the backend responds with HTTP 422 indicating the location is inactive  
**Then** the frontend displays â€œLocation is inactive and cannot receive new stock movements. Select an active location.â€  
**And** the user remains on the form with inputs preserved.

### Scenario 6: Permissions enforced
**Given** the user lacks permission to view topology data  
**When** they navigate directly to the LocationRef list URL  
**Then** the frontend shows an unauthorized/forbidden state  
**And** no LocationRef data is displayed.

---

## 13. Audit & Observability

### User-visible audit data
- SyncLog list/detail provides:
  - appliedAt, outcome, hrEventId, errorMessage, and payload preview/detail (as allowed)
- LocationRef detail shows:
  - created/updated timestamps and deactivatedAt/By when present

### Status history
- No new status history UI beyond what SyncLog provides unless backend exposes historical records.

### Traceability expectations
- UI should display/copy identifiers:
  - `LocationRef.id`, `LocationRef.hrLocationId`, `SyncLog.syncId`, `SyncLog.hrEventId`
- If backend returns correlation/request IDs in headers, surface them in error UI (optional; safe default only if existing app pattern).

---

## 14. Non-Functional UI Requirements
- **Performance:** LocationRef and SyncLog lists should load within 2s p95 on typical broadband for page size 25 (excluding backend latency issues); use pagination, avoid rendering full JSON payloads in list views.
- **Accessibility:** All interactive controls keyboard accessible; status indicated with text (not color-only); payload viewer supports copy/select.
- **Responsiveness:** Works on tablet widths used in shops; tables become stacked/condensed on small screens.
- **i18n/timezone:** Display `appliedAt` and timestamps in user locale, but preserve timezone context (show stored location timezone as text). Do not convert the stored `timezone` value; only timestamps formatting changes.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging for empty LocationRef/SyncLog lists; safe because it doesnâ€™t alter domain logic. Impacted sections: UX Summary, Alternate/Empty states.
- SD-UX-PAGINATION-25: Default page size 25 with server-side pagination; safe UI ergonomics default. Impacted sections: UX Summary, Service Contracts.
- SD-ERR-STD-MAPPING: Standard handling for 401/403/404/422/5xx with non-leaky messaging; safe because it follows conventional HTTP semantics without inventing policy. Impacted sections: Service Contracts, Error Flows, Acceptance Criteria.

---

## 16. Open Questions
1. **Backend service contracts:** What are the exact Moqui service names (or REST endpoints) and request/response schemas for `LocationRef` and `SyncLog` list/detail? (Needed to implement screens.)  
2. **Permissions:** What permission(s) gate access to Topology screens and SyncLog payload visibility? (Needed for nav visibility and 403 expectations.)  
3. **Manual sync trigger:** Does the backend support an on-demand â€œSync nowâ€ / reconcile action? If yes, what are the inputs/outputs, and should it be restricted to admins only?  
4. **Definition of â€œstock movementsâ€ in the current frontend:** Which specific screens/components in `durion-moqui-frontend` represent â€œnew inbound stock movementsâ€ (receipts/transfers/adjustments/consumption) that must block inactive locations? Provide routes/screen names to update.  
5. **PENDING status behavior:** If `LocationRef.status=PENDING` exists in v1, should PENDING locations be selectable for new movements, or treated as inactive until ACTIVE?  
6. **Tags display expectations:** Should tags be treated as opaque JSON, or are there known keys that need friendly rendering/filtering?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Topology: Sync Locations from durion-hr â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/104

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Topology: Sync Locations from durion-hr  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/104  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Topology: Sync Locations from durion-hr

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As a **System**, I want to sync location identifiers and metadata from durion-hr so that inventory is scoped to valid shops and mobile sites.

## Details  
- Import locationId, name, status, timezone, and tags.  
- Keep a local reference table for FK integrity.

## Acceptance Criteria  
- Location refs created/updated idempotently.  
- Deactivated locations cannot receive new stock movements.  
- Audit sync runs.

## Integrations  
- HR â†’ Inventory location roster API/events.

## Data / Entities  
- LocationRef, SyncLog

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Inventory Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

BACKEND STORY REFERENCES (FOR REFERENCE ONLY)

----------------------------------------------------------------------------------------------------

Backend matches (extracted from story-work):


[1] backend/40/backend.md

    Labels: type:story, domain:inventory, status:ready-for-dev, agent:story-authoring, agent:inventory, layer:domain

----------------------------------------------------------------------------------------------------

Backend Story Full Content:

### BACKEND STORY #1: backend/40/backend.md

------------------------------------------------------------

Title: [BACKEND] [STORY] Topology: Sync Locations from durion-hr  
URL: https://github.com/louisburroughs/durion-positivity-backend/issues/40  
Labels: type:story, domain:inventory, status:ready-for-dev, agent:story-authoring, agent:inventory, layer:domain

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:ready-for-dev

### Recommended
- agent:inventory
- agent:story-authoring

### Blocking / Risk
- none

**Rewrite Variant:** inventory-flexible

## Story Intent
Keep the system-of-record for physical locations (shops, mobile sites) synchronized from the authoritative HR topology source (`durion-hr`) so inventory is always scoped and validated against a current roster of active locations.

## Actors & Stakeholders
- `durion-hr` service (authoritative source of locations)
- Inventory service (primary consumer; owns local `LocationRef` and enforces location-level constraints)
- Service Advisors / Warehouse Staff (use locations in stock movements)
- Finance/Operations (rely on accurate location scoping for reporting)
- SRE/Operations (monitor sync health)

## Preconditions
- `durion-hr` exposes either a roster API and/or emits location lifecycle events (create/update/deactivate) that can be consumed.
- Inventory service has database and permissions to write `LocationRef` records.
- An established correlation/identity mapping exists between HR location identifiers and Inventory location references.

## Functional Behavior
1. Source-of-truth: `durion-hr` is authoritative for location identity, name, status, timezone, and tags.
2. Sync Modes (both supported):
   - Event-driven (preferred): `durion-hr` publishes location events (LocationCreated/LocationUpdated/LocationDeactivated) which Inventory consumes. Inventory processes events idempotently and updates local `LocationRef`.
   - Bulk/REST sync: Inventory calls HR roster API to reconcile full or incremental roster on schedule or on-demand.
3. Idempotent Upsert: For each incoming record/event, Inventory upserts a `LocationRef` by `hrLocationId` within tenant scope:
   - If not present -> INSERT with provided fields.
   - If present -> UPDATE changed fields and bump `version`.
   - Always write an immutable `SyncLog` entry recording payload, source event id, and outcome.
4. Deactivation semantics (resolved):
   - On HR deactivation, Inventory marks `LocationRef.is_active=false`, records `deactivated_at`, `deactivated_by`, and links `hr_event_id`.
   - Inventory prevents **new inbound** stock movements to that location.
   - Remaining on-hand quantities are marked as **`PendingTransfer`** (derived state) for manual reconciliation; no automatic transfers in v1.
   - Reconciliation actions (manual, authorized roles only): transfer-out, adjust/write-off, dispose/RTV.
   - Default reconciliation SLA: **5 business days** before escalation.
5. Identity mapping (resolved):
   - `hrLocationId` is unique within a tenant. Use composite key: `tenantId + ":" + hrLocationId` (or unique constraint on `(tenant_id, hr_location_id)`).
6. Reconciliation job and FK integrity: A periodic reconciliation job compares HR roster to local `LocationRef` and emits alerts for drift. Orders and transactions reference `LocationRef.id` (not raw HR id) to maintain FK integrity.
7. Backpressure & retries: Event consumption uses at-least-once delivery with idempotency on `hr_event_id`, exponential backoff with jitter, max retries 10 over ~30 minutes, and DLQ/escalation on repeated failures.

## Alternate / Error Flows
- Missing HR field: If an incoming record lacks required fields, record `SyncLog` with `INVALID_PAYLOAD` and flag for manual review; do not overwrite existing fields with nulls.
- Transient failures: Retry with exponential backoff; after retries exhausted, write `SyncFailure`, send to DLQ/quarantine, and alert.
- Unknown HR location referenced by inventory operations: Default v1 behavior is to **reject with 422**; optional config can allow `PENDING` location creation when explicitly enabled.

## Business Rules
- HR owns location lifecycle and authoritative attributes; Inventory enforces local constraints derived from that model.
- Inventory must not invent or permanently rename HR-provided identifiers; any local display names may include local suffixes but must store the canonical `hr_location_id` and tenant.
- Deactivated locations cannot receive NEW stock movements; existing stock is `PendingTransfer` and requires manual reconciliation per SLA.
- Sync must be auditable and idempotent; every applied change must create a `SyncLog` entry with source event id and `appliedAt`.
- Reconciliation job must run at configurable intervals and emit `location.sync.drift.count` when discrepancies are found.

## Data Requirements
- `LocationRef` table (inventory.schema.location_ref):
  - `id` (UUID PK)
  - `tenant_id` (string) -- tenant scope
  - `hr_location_id` (string, unique per tenant)
  - `name` (string)
  - `status` (ENUM: `ACTIVE`, `INACTIVE`, `PENDING`)
  - `timezone` (IANA tz)
  - `tags` (jsonb)
  - `is_active` (boolean)
  - `effective_from`, `effective_to` (timestamp)
  - `created_at`, `created_by`, `updated_at`, `updated_by`
  - `deactivated_at`, `deactivated_by`
  - `version` (optimistic lock)
  - Index: unique on `(tenant_id, hr_location_id)`, index on `is_active`

- `SyncLog` table:
  - `sync_id` (UUID PK)
  - `hr_event_id` (string)
  - `hr_payload` (jsonb)
  - `applied_at`, `applied_by`, `outcome` (OK/INVALID/RETRY/FAILED)
  - `error_message` (nullable)

- Reconciliation job state table for last-run timestamps and metrics.

## Acceptance Criteria
- Scenario: Event-driven creation
  - Given `durion-hr` emits `LocationCreated` with hrLocationId=L100 and required fields
  - When Inventory consumes the event
  - Then a `LocationRef` for L100 exists with `status=ACTIVE`, a `SyncLog` entry is recorded, and `location.sync.processed` metric increments

- Scenario: Idempotent update
  - Given the same `LocationUpdated` event is delivered twice
  - When processed
  - Then the second processing is a no-op (idempotent) and `SyncLog` shows duplicate delivery handled with same resulting `LocationRef`

- Scenario: Deactivation blocks receipts
  - Given HR marks L100 as deactivated
  - When an inbound stock movement to L100 is attempted
  - Then Inventory rejects the movement with a clear error (422) and records audit entry referencing `deactivated_at` and `hr_event_id`

- Scenario: Bulk reconcile finds drift
  - Given HR roster and local `LocationRef` differ
  - When reconciliation runs
  - Then discrepancies are logged, `location.sync.drift.count` metric increases, and a reconcile report is saved

## Audit & Observability
- `SyncLog` entries for every inbound HR payload and applied action.
- Metrics: `location.sync.processed`, `location.sync.failures`, `location.sync.drift.count`, `location.sync.lag_seconds`.
- Tracing: spans for event ingestion -> upsert -> reconciliation with `hrLocationId` tag.
- Alerts: high failure rates or large drift trigger Ops alerts per SLO.

## Resolved Decisions (from clarification #410)
- Deactivation policy (v1): **Option B** â€” mark existing stock as `PendingTransfer` and require manual reconciliation within **5 business days**.
- Identity mapping: use composite key `tenantId + ":" + hrLocationId` (unique per tenant); store `(tenant_id, hr_location_id)` with unique constraint.
- Sync SLA: **event-driven p95 â‰¤ 60s**; bulk reconcile freshness â‰¤ 15 minutes. Retry policy: at-least-once, exponential backoff, max 10 attempts over ~30 minutes, DLQ + alert on exhaustion.

## Open Questions
- Should Inventory create a configurable `HOLDING` virtual location for manual transfers, or rely solely on manual transfer-out to existing active locations? (Config keys provided in clarification; decide if `inventory.location.holding.enabled` should default to true.)

---

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #108: [FRONTEND] [STORY] Rules: Store Fitment Hints and Vehicle Applicability Tags (Basic) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/108
File: ./scripts/story-work/frontend/108/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] Rules: Store Fitment Hints and Vehicle Applicability Tags (Basic)

### Primary Persona
Product Administrator (Product Admin)

### Business Value
Enable Service Advisors (and downstream Work Execution) to quickly narrow candidate parts/tires to those likely compatible with a customer vehicle, reducing incorrect part selection while keeping the system â€œhint-basedâ€ (not a strict fitment engine).

---

## 2. Story Intent

### As a / I want / So that
**As a** Product Administrator,  
**I want** to create, edit, remove, and search products by vehicle applicability â€œfitment hintâ€ tags (make/model/year range/tire size/axle position),  
**so that** advisors and downstream flows can filter and suggest likely-compatible products for a vehicle.

### In-scope
- Admin UI to manage Vehicle Applicability Hints for a product (CRUD).
- Admin UI to search/filter products by vehicle attributes / tags.
- Display of existing hints/tags on product detail.
- User-visible audit history display for hint changes (read-only).
- Moqui screen/form/service wiring for these flows (transitions, validations, error handling).

### Out-of-scope
- A full fitment/compatibility rules engine or VIN decoding.
- Blocking sales/workorder flows based on fitment (this is advisory only).
- Defining/owning the Product master entity itself (assumed exists).
- Importing tags from external catalogs.
- Any inventory valuation/costing logic.

---

## 3. Actors & Stakeholders
- **Product Administrator:** creates/maintains applicability hints.
- **Service Advisor:** consumes filtered results elsewhere (not primary UI in this story, but stakeholder).
- **Work Execution system / module:** passes vehicle attributes to filter candidates (integration consumer).
- **Auditor / Manager:** reviews change history for compliance/traceability.
- **System Admin/Security:** ensures only authorized users can edit hints.

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend.
- Product/SKU records exist and are viewable in the admin UI.
- Backend APIs/services exist (or will exist) to:
  - CRUD VehicleApplicabilityHint + FitmentTag
  - Query products filtered by vehicle attributes/tags
  - Provide audit log entries for hint changes
- Authorization model exists for â€œproduct adminâ€ capabilities.

Dependencies (blocking unless already defined elsewhere):
- Exact Moqui service names/paths and request/response payloads for CRUD + search.
- Permission(s) required to manage hints and to view audit logs.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Product Admin area:
  - Product search/list screen â†’ open Product detail.
  - Product detail screen â†’ â€œVehicle Applicability (Hints)â€ section.

### Screens to create/modify
1. **Modify existing Product Detail screen** (or create if missing):
   - Add a related panel/section: â€œVehicle Applicability Hintsâ€.
   - Include list of existing hints for the product and their tags.
   - Provide actions: Add Hint, Edit Hint, Delete Hint, View Audit.
2. **Create/Edit Hint screen/dialog**:
   - Form to add/edit hint and manage its tags (add/remove rows).
3. **Product Search with Fitment Filter screen enhancements**:
   - Search input set for vehicle attributes (make/model/year/tire size/axle position).
   - Results list of matching products.
4. **Audit Log viewer screen/dialog** scoped to a product and hint:
   - Read-only list of audit events for hint CRUD.

### Navigation context
- All screens under an Admin route namespace (exact route TBD by project conventions).
- Breadcrumb: Admin â†’ Products â†’ {Product} â†’ Vehicle Applicability Hints.
- Transitions return to Product detail after create/update/delete.

### User workflows
**Happy path (create):**
1. Product Admin opens a Product.
2. In â€œVehicle Applicability Hintsâ€, clicks â€œAdd Hintâ€.
3. Adds tag rows (e.g., MAKE=Subaru, MODEL=Outback, YEAR_RANGE=2020-2023).
4. Saves.
5. Sees new hint in list and audit entry visible in Audit screen.

**Alternate paths:**
- Add multiple hints to same product (if allowed).
- Edit existing hint to change tags.
- Delete hint (confirmation required).
- Search products by vehicle attributes and get empty results state.

---

## 6. Functional Behavior

### Triggers
- User navigates to product detail â†’ frontend loads hints for product.
- User opens search screen and enters vehicle attributes â†’ frontend requests filtered product list.
- User submits create/update/delete hint â†’ frontend calls corresponding backend service and refreshes view.
- User opens audit viewer â†’ frontend loads audit entries.

### UI actions
- Add/remove tag row in a hint form.
- Save (create/update) hint.
- Delete hint with confirmation.
- Apply filters / clear filters in product search.

### State changes (frontend)
- Form state: dirty/pristine; disable submit until valid.
- Loading indicators while services run.
- Upon successful write: show confirmation and refresh hint list.
- On errors: show field-level validation messages and/or global error banner.

### Service interactions
- Load product hints by productId.
- Create hint for productId with tags.
- Update hint by hintId with tags.
- Delete hint by hintId.
- Search products by vehicle attribute filters (tag intersection semantics are owned by backend).
- Load audit log by productId and/or hintId.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Tag entries are key/value pairs (or tagType/tagValue).
- Prevent submitting a hint with:
  - zero tags (unless backend allows; clarify)
  - any blank tag type/key or blank tag value
  - invalid YEAR_RANGE formatting (clarify exact format/validation rules)
- UI must not allow editing system-managed fields (none specified here besides IDs).

### Enable/disable rules
- Save button disabled while:
  - form invalid
  - request in-flight
- Edit/Delete actions disabled if user lacks permission (based on backend response/permissions model).

### Visibility rules
- â€œVehicle Applicability Hintsâ€ section visible only to users with appropriate read permission (clarify).
- Audit viewer visible only to users with audit-view permission (clarify).

### Error messaging expectations
- 400 validation errors: show actionable messages, map to fields when possible (tag row index + field).
- 403: show â€œYou donâ€™t have permission to perform this action.â€
- 404 (product or hint missing): show not-found and navigate back to product list if appropriate.
- 409 concurrency (if used): prompt user to refresh and retry.

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- **VehicleApplicabilityHint**
  - `hintId` (string/UUID; read-only)
  - `productId` (string/UUID; read-only in edit)
  - `fitmentTags` (array of FitmentTag; editable)
  - (optional) `createdAt`, `createdBy`, `updatedAt`, `updatedBy` (read-only; if provided)
- **FitmentTag**
  - `tagType` (enum/string; required)
  - `tagValue` (string; required)
- **AuditLog / AuditEvent**
  - `eventType` (e.g., VEHICLE_HINT_CREATED/UPDATED/DELETED)
  - `timestamp`
  - `actorUserId` / actor display name (if available)
  - `entityRef` (productId, hintId)
  - `delta` (before/after snapshot or change summary)

### Fields (type, required, defaults)
- `tagType`: required; UI offers a controlled list for â€œbasic tagsâ€:
  - MAKE, MODEL, YEAR_RANGE, TIRE_SIZE, AXLE_POSITION
  - Allow free-form additional keys only if backend supports it (clarify; backend mentions extensibility without schema changeâ€”UI needs rule).
- `tagValue`: required string; trimming whitespace on submit.

### Read-only vs editable
- IDs always read-only.
- Tag list editable in create/edit.
- Audit fields read-only.

### Derived/calculated fields
- Display-only â€œHuman readable hint summaryâ€ assembled client-side (e.g., â€œSubaru Outback 2020-2023, 225/45R17, FRONTâ€)â€”optional and safe for UX, not persisted.

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking**: Exact service names/endpoints are not provided in the inputs. Below is the required contract shape the frontend needs; map to actual Moqui services once confirmed.

### Load/view calls
1. **Get hints by product**
   - Input: `productId`
   - Output: list of `VehicleApplicabilityHint` with `fitmentTags`
2. **Get audit log for hints**
   - Input: `productId` (and optional `hintId`)
   - Output: list of audit events sorted desc by timestamp

### Create/update calls
1. **Create hint**
   - Input: `productId`, `fitmentTags[]`
   - Output: created hint with `hintId`
2. **Update hint**
   - Input: `hintId`, `fitmentTags[]` (and productId if required)
   - Output: updated hint
3. **Delete hint**
   - Input: `hintId`
   - Output: success acknowledgement

### Search/filter calls
1. **Search products by vehicle attributes**
   - Input: `filters` object / list of tags (make/model/year/tire size/axle position)
   - Output: product list (minimum: productId, sku, name/description)

### Error handling expectations
- 400 returns structured validation errors with per-field keys where possible; otherwise a message.
- 403 forbidden for permission failures.
- 404 for missing entities.
- 409 for stale updates (if implemented).

---

## 10. State Model & Transitions

### Allowed states
- VehicleApplicabilityHint lifecycle in this story is CRUD-only (no explicit workflow states provided).

### Role-based transitions
- Product Admin:
  - can create/update/delete hints (permission-gated; exact permission keys TBD).
- Read-only users:
  - can view hints (if allowed) and may view audit (if allowed).

### UI behavior per state
- Create mode: blank form with at least one empty tag row.
- Edit mode: populated tag rows.
- Delete: confirmation modal; on confirm call delete; on success refresh list.

---

## 11. Alternate / Error Flows

### Validation failures
- User adds a tag row but leaves `tagValue` blank â†’ inline error; prevent submit.
- User enters malformed year range â†’ inline error; prevent submit (needs exact rule).

### Concurrency conflicts
- If backend returns 409 on update (hint modified elsewhere):
  - show message â€œThis hint changed since you opened it. Refresh to get the latest.â€
  - provide â€œRefreshâ€ action that reloads hint and resets form.

### Unauthorized access
- User without permission attempts to open create/edit/delete:
  - hide actions if permissions are available client-side
  - if attempted and backend returns 403, show error and remain on page.

### Empty states
- Product has no hints â†’ show â€œNo applicability hints yetâ€ with â€œAdd Hintâ€ action (if permitted).
- Product search by vehicle attributes returns none â†’ show empty results (not an error).

---

## 12. Acceptance Criteria

### Scenario 1: View existing applicability hints on a product
**Given** I am logged in as a Product Administrator  
**And** I am viewing an existing product detail page  
**When** the page loads the â€œVehicle Applicability Hintsâ€ section  
**Then** I see the list of existing hints for the product  
**And** each hint displays its tags (type and value)

### Scenario 2: Create a new applicability hint with basic tags
**Given** I am logged in as a Product Administrator with permission to manage hints  
**And** I am viewing an existing product  
**When** I add a new hint with tags MAKE=Subaru, MODEL=Outback, YEAR_RANGE=2020-2023  
**And** I click Save  
**Then** the hint is persisted via the backend create service  
**And** the product detail page refreshes to show the new hint  
**And** an audit entry is visible in the audit viewer indicating a create event

### Scenario 3: Update an existing hint
**Given** a product has an existing hint with YEAR_RANGE=2020-2023  
**And** I am editing that hint  
**When** I change YEAR_RANGE to 2020-2024 and save  
**Then** the backend update service is called with the updated tags  
**And** the updated tag is displayed after save  
**And** an audit entry is visible indicating an update event

### Scenario 4: Delete an existing hint
**Given** a product has an existing applicability hint  
**And** I have permission to delete hints  
**When** I choose Delete and confirm  
**Then** the backend delete service is called  
**And** the hint no longer appears in the productâ€™s hint list  
**And** an audit entry is visible indicating a delete event

### Scenario 5: Prevent invalid hint submission
**Given** I am creating a hint  
**When** I attempt to save with a tag missing a type or value  
**Then** the UI blocks submission  
**And** I see an inline validation message identifying the missing field(s)

### Scenario 6: Search products by vehicle attributes
**Given** Product A has tags MAKE=Ford and MODEL=F-150  
**And** Product B has tags MAKE=Toyota and MODEL=Camry  
**When** I search products with filters MAKE=Ford and MODEL=F-150  
**Then** the results include Product A  
**And** the results do not include Product B

### Scenario 7: Search returns empty list (not an error)
**Given** no products have MAKE=Tesla  
**When** I search products with filter MAKE=Tesla  
**Then** I see an empty results state  
**And** no error is shown

---

## 13. Audit & Observability

### User-visible audit data
- Provide an â€œAuditâ€ view showing:
  - event type (created/updated/deleted)
  - timestamp
  - actor (user)
  - change summary (before/after or tag delta if provided)
- Audit is read-only.

### Status history
- Not applicable (no explicit state machine), but change history must be viewable.

### Traceability expectations
- All CRUD operations should include correlation/trace ID in logs (if frontend has access to request IDs).
- UI should display backend validation messages without losing context (keep user on the same form).

---

## 14. Non-Functional UI Requirements

- **Performance:** Product detail should load hints with one request; avoid per-hint N+1 calls.
- **Accessibility:** All form inputs labeled; validation messages associated to inputs; keyboard navigable tag rows; confirmation dialogs accessible.
- **Responsiveness:** Works on tablet widths used in-store; tag editor usable without horizontal scrolling where possible.
- **i18n/timezone:** Audit timestamps displayed in user locale/timezone; no currency handling required.

---

## 15. Applied Safe Defaults
- Default ID: UI-EMPTY-STATE-001  
  - Assumed: Standard empty state messaging + â€œAdd Hintâ€ CTA when no hints exist.  
  - Why safe: Pure UX; does not affect domain rules or persisted data.  
  - Impacted sections: UX Summary, Alternate / Error Flows, Acceptance Criteria.
- Default ID: UI-LOADING-INDICATOR-001  
  - Assumed: Show loading spinners/disabled actions during service calls.  
  - Why safe: UX ergonomics only; no business policy inferred.  
  - Impacted sections: Functional Behavior, Alternate / Error Flows.
- Default ID: UI-ERROR-MAP-400-001  
  - Assumed: Map HTTP 400/403/404/409 to standard banners/field errors.  
  - Why safe: Standard error-handling; does not define backend policy.  
  - Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows.

---

## 16. Open Questions

1. **Backend contract mapping (blocking):** What are the exact Moqui service names (or REST endpoints) and payload schemas for:
   - list hints by productId, create/update/delete hint, search products by vehicle attributes, and load audit log?
2. **Permissions (blocking):** What permission IDs/roles govern:
   - viewing hints, creating/updating/deleting hints, and viewing audit logs?
3. **Tag model (blocking):** Are tags stored as free-form `key/value` pairs, or as `tagType` constrained to an enum? If enum, what is the authoritative list and display labels?
4. **Year range validation (blocking):** What formats are accepted (e.g., `2020-2023`, separate min/max year fields, inclusive/exclusive), and how should invalid input be reported?
5. **Cardinality (blocking):** Can a product have multiple hints, or exactly one hint with multiple tags? If multiple, is there any uniqueness constraint (e.g., no duplicate tagType within the same hint)?
6. **Audit payload/display (non-blocking if minimal display allowed):** Will the audit API return a delta/before-after snapshot, or only event metadata? What fields are safe to show in UI?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Rules: Store Fitment Hints and Vehicle Applicability Tags (Basic) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/108

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Rules: Store Fitment Hints and Vehicle Applicability Tags (Basic)  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/108  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Rules: Store Fitment Hints and Vehicle Applicability Tags (Basic)

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As a **Product Admin**, I want fitment hints so that advisors can pick correct parts/tires for a vehicle.

## Details  
- Basic tags: make/model/year ranges, tire size specs, axle position.  
- Hints only (not full fitment engine).

## Acceptance Criteria  
- Fitment tags stored and retrievable.  
- Search/filter by tag.  
- Audited.

## Integrations  
- Workexec can pass vehicle attributes from CRM to filter candidates.

## Data / Entities  
- FitmentTag, VehicleApplicabilityHint, AuditLog

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Product / Parts Management

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #110: [FRONTEND] [STORY] Availability: Normalize Manufacturer Inventory Feeds (Stub via Positivity) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/110
File: ./scripts/story-work/frontend/110/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] Availability: Manufacturer Feed Normalization â€” Monitor Ingestion + Review Unmapped Parts (via Positivity)

### Primary Persona
Integration Operator (Ops user responsible for monitoring integration health and resolving unmapped items)

### Business Value
Provide operational visibility into manufacturer availability feed ingestion so the business can (a) confirm freshness/health of availability data and (b) quickly resolve unmapped manufacturer part numbers that prevent downstream availability/lead-time estimates for special orders.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Integration Operator  
- **I want** a UI in the POS frontend to monitor manufacturer availability feed ingestion results and review unmapped manufacturer part numbers  
- **So that** availability/lead-time data can be trusted and unmapped parts can be routed for mapping maintenance without digging through logs.

### In-scope
- Frontend screens to:
  - View recent feed ingestion runs (per manufacturer, as-of time, outcome)
  - View normalized availability records (read-only) for troubleshooting/verification
  - View and triage **unmapped manufacturer parts backlog** (read-only + status update if supported)
  - View integration exceptions/failed ingestions routed to an exception queue (read-only)
- Moqui screen + service-call wiring to backend APIs (via Moqui services) with robust error handling and empty states.
- Permission-gated access to these operational views.

### Out-of-scope
- Implementing the ingestion pipeline itself (backend responsibility).
- Editing/creating Manufacturer Part Map entries (explicitly out-of-scope; handled by separate product-domain tool/story).
- Enforcing min-order rules in cart/ordering.
- Any inventory valuation/costing logic.

---

## 3. Actors & Stakeholders

### Actors
- **Integration Operator**: monitors ingestion, investigates errors, escalates unmapped parts.
- **Inventory Manager** (secondary): consumes availability freshness insights.
- **Support/Admin** (secondary): uses exception visibility for incident response.

### Systems
- **Moqui Frontend**: screens/forms/transitions to display and manage ops workflows.
- **Positivity backend** (integration service): source/transport for feeds (indirectly referenced).
- **pos-inventory backend service**: system of record for normalized availability + unmapped backlog.
- **pos-product backend service**: SoR for part mapping (not modified here; referenced only via backend behavior).

---

## 4. Preconditions & Dependencies

1. Backend story `[BACKEND] Availability: Normalize Manufacturer Inventory Feeds (Stub via Positivity)` (durion-positivity-backend #46) is implemented and exposes read APIs (and optional triage/update APIs) for:
   - ingestion run summaries (or equivalent)
   - normalized availability records
   - unmapped manufacturer parts backlog
   - exception queue entries
2. Authentication is functional in Moqui frontend; user identity available to enforce permissions.
3. Authorization model exists for â€œintegration/opsâ€ views (exact permission strings TBDâ€”see Open Questions).
4. Manufacturer entities/identifiers exist (manufacturerId is UUIDv7 per backend spec).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Inventory â†’ Availability Feeds (Ops)** (name can vary per app conventions)
- Optional deep links from alerts/notifications to:
  - a specific ingestion run (manufacturerId + asOf)
  - the unmapped parts list filtered by manufacturerId
  - exception queue filtered by correlationId/runId

### Screens to create/modify
Create new screen tree under a single route namespace, e.g.:
- `apps/pos/screen/inventory/availabilityFeeds.xml` (container/menu)
- `.../availabilityFeeds/ingestionRuns.xml`
- `.../availabilityFeeds/unmappedParts.xml`
- `.../availabilityFeeds/normalizedAvailability.xml`
- `.../availabilityFeeds/exceptions.xml`
- `.../availabilityFeeds/runDetail.xml` (optional but recommended)

(Exact file paths may differ; implement using repo conventions from `durion-moqui-frontend` README.)

### Navigation context
- Tabbed or side-nav within **Availability Feeds (Ops)**:
  1) Ingestion Runs  
  2) Unmapped Parts  
  3) Normalized Availability  
  4) Exceptions

### User workflows
#### Happy path: confirm feed health and spot issues
1. Operator opens **Ingestion Runs**
2. Filters by manufacturer and date range
3. Opens a run detail
4. Sees counts: items received, mapped, unmapped, stored; outcome success/partial/failure
5. If unmapped > 0, clicks through to **Unmapped Parts** pre-filtered.

#### Alternate path: investigate a specific part number
1. Operator opens **Unmapped Parts**
2. Searches by manufacturer part number
3. Views firstSeen/lastSeen/occurrenceCount
4. Copies identifiers and escalates to mapping tool (out of scope).

#### Error path: investigate failures
1. Operator opens **Exceptions**
2. Filters to â€œmanufacturer availability feedâ€
3. Opens exception detail to see error message and correlation identifiers.

---

## 6. Functional Behavior

### Triggers
- User navigates to any Availability Feeds (Ops) screen.
- User changes filters (manufacturer, asOf range, status).
- User opens a detail view row.
- Optional: user attempts to update unmapped part status (if backend supports).

### UI actions
- **List views** (Runs, Unmapped, Availability, Exceptions):
  - Filter controls (manufacturerId, date range, status)
  - Search (by part number, productId, correlationId as applicable)
  - Pagination and sorting
  - Row click â†’ detail screen or drawer
- **Detail views**:
  - Show structured JSON-like fields in readable format (no raw payload unless backend provides it)
  - Copy-to-clipboard for IDs (manufacturerId, asOf, mpn, productId)

### State changes (frontend)
- No domain state changes for availability records (read-only).
- Optional: Unmapped part triage state change (PENDING_REVIEW â†’ IGNORED/RESOLVED) **only if backend contract exists**.

### Service interactions
- All data fetched via Moqui services that call backend endpoints (REST) or via Moqui artifact/service wrappers as per project conventions.
- Must handle:
  - 200 with empty results
  - 400 validation errors for bad filters
  - 401/403 unauthorized
  - 5xx backend errors and timeouts

---

## 7. Business Rules (Translated to UI Behavior)

1. **Idempotency is backend-owned**: UI must not attempt to deduplicate; it only displays latest records and run summaries.
2. **Mapping authority is product service**: UI must not allow editing mappings here; at most provide navigation/links to mapping tool (if exists) or copy data for escalation.
3. **Unmapped parts policy**:
   - UI must surface unmapped items distinctly (status PENDING_REVIEW default).
   - If repeated occurrences exist, UI displays `occurrenceCount`, `firstSeen`, `lastSeen`.
4. **Data freshness**:
   - UI displays `asOf` from feed as the authoritative timestamp and `receivedAt` as system receipt time.
5. **Schema version mismatch**:
   - UI must clearly show â€œunsupported schemaVersionâ€ failures in Exceptions and/or run outcome.

Error messaging expectations:
- Validation errors: show inline (filters) or banner with backend-provided message.
- Unauthorized: show â€œYou do not have access to Availability Feed Opsâ€ with no data leakage.
- Backend unavailable: show retry option and preserve user filters.

---

## 8. Data Requirements

### Entities involved (frontend-consumed)
(Backend entities; Moqui frontend uses them as DTOs)
- `NormalizedAvailability` (or `normalized_availability`)
- `UnmappedManufacturerParts` (or `unmapped_manufacturer_parts`)
- `ExceptionQueue` (integration exception records)
- Optional: `FeedIngestionRun` / `FeedReceiptAudit` (name TBD; required for â€œIngestion Runsâ€ view)

### Fields (type, required, defaults)

#### Normalized Availability (read-only)
- `id` (UUIDv7, required)
- `productId` (UUIDv7, required)
- `manufacturerId` (UUIDv7, required)
- `manufacturerPartNumber` (string, required)
- `availableQty` (decimal, required)
- `uom` (string, required)
- `unitPrice.amount` (decimal, required)
- `unitPrice.currency` (string ISO4217, required)
- `leadTimeDaysMin` (int, required)
- `leadTimeDaysMax` (int, required)
- `minOrderQty` (int, nullable)
- `packSize` (int, required)
- `sourceLocationCode` (string, required)
- `asOf` (timestamp UTC, required)
- `receivedAt` (timestamp UTC, required)
- `schemaVersion` (string, required)

#### Unmapped Manufacturer Parts (read-only unless triage supported)
- `id` (UUIDv7, required)
- `manufacturerId` (UUIDv7, required)
- `manufacturerPartNumber` (string, required)
- `firstSeen` (timestamp UTC, required)
- `lastSeen` (timestamp UTC, required)
- `occurrenceCount` (int, required)
- `status` (enum: PENDING_REVIEW, RESOLVED, IGNORED; required)

#### Ingestion Run Summary (required for runs screen; exact shape TBD)
Minimum fields UI needs:
- `runId` (string/UUID, required)
- `manufacturerId` (UUIDv7, required)
- `asOf` (timestamp UTC, required)
- `receivedAt` (timestamp UTC, required)
- `schemaVersion` (string, required)
- `itemCount` (int, required)
- `mappedCount` (int, required)
- `unmappedCount` (int, required)
- `outcome` (enum: SUCCESS, PARTIAL_SUCCESS, FAILED; required)
- `errorSummary` (string, nullable)
- `correlationId` (string, nullable)

#### Exception Queue (read-only)
Minimum fields UI needs:
- `exceptionId` (string/UUID)
- `source` (string; e.g., â€œPositivityManufacturerFeedâ€)
- `manufacturerId` (UUIDv7, nullable)
- `asOf` (timestamp, nullable)
- `createdAt` (timestamp, required)
- `severity` (enum/string, required)
- `message` (string, required)
- `details` (object/string, nullable)
- `correlationId` (string, nullable)
- `status` (OPEN/ACKED/RESOLVED or similar; TBD)

### Read-only vs editable by state/role
- All availability records are **read-only**.
- Unmapped parts **status update** is **optional** and must be permission-gated if supported.
- Exceptions are **read-only** in this story (ack/resolve out-of-scope unless backend already has it and product requests it).

### Derived/calculated fields (UI-only)
- â€œFreshness ageâ€ = now - `asOf` (display only; no business policy thresholds assumed)
- â€œMapping rateâ€ = mappedCount / itemCount (display only)

---

## 9. Service Contracts (Frontend Perspective)

> Backend endpoints are not defined for frontend in the provided frontend issue; therefore exact Moqui service names and REST paths are **Open Questions**. Below are required contract shapes the frontend needs.

### Load/view calls (required)
1. **List ingestion runs**
   - Inputs: `manufacturerId?`, `asOfFrom?`, `asOfTo?`, `outcome?`, `pageIndex`, `pageSize`, `sort`
   - Output: list of run summaries + total count

2. **Get run detail**
   - Inputs: `runId` OR (`manufacturerId` + `asOf`)
   - Output: run summary + optional per-item error counts + linkable identifiers

3. **List normalized availability**
   - Inputs: `manufacturerId?`, `productId?`, `manufacturerPartNumber?`, `asOfFrom?`, `asOfTo?`, pagination/sort
   - Output: list + total

4. **List unmapped parts**
   - Inputs: `manufacturerId?`, `status?`, `manufacturerPartNumber?` (search), pagination/sort
   - Output: list + total

5. **List exceptions**
   - Inputs: `source?`, `manufacturerId?`, `createdFrom?`, `createdTo?`, `status?`, pagination/sort
   - Output: list + total
   - Detail view call optional if list doesnâ€™t include `details`

### Create/update calls (optional)
- **Update unmapped part status** (ONLY if backend supports)
  - Inputs: `id`, `status`, optional `note`
  - Output: updated record

### Submit/transition calls
- None required (unless unmapped status update is treated as transition).

### Error handling expectations
- `400`: show validation error message; do not clear filters.
- `401/403`: route to access denied screen or show forbidden banner; do not reveal data.
- `404` (detail views): show â€œNot found (may have been archived)â€ and link back to list.
- `409` (if any concurrency on status update): show conflict and refresh row.
- `5xx/timeout`: show retry CTA; log client-side error event (see Observability).

---

## 10. State Model & Transitions

### Allowed states

#### UnmappedManufacturerParts.status
- `PENDING_REVIEW`
- `RESOLVED`
- `IGNORED`

#### Ingestion run outcome
- `SUCCESS`
- `PARTIAL_SUCCESS`
- `FAILED`

#### Exception status (if present)
- TBD by backend (OPEN/ACKED/RESOLVED etc.)

### Role-based transitions
- Only users with ops/integration permission can access screens.
- Only users with a specific permission (TBD) can update unmapped part status (if implemented).

### UI behavior per state
- Ingestion Runs:
  - FAILED: highlight row; show errorSummary; link to Exceptions filtered by correlationId/runId.
  - PARTIAL_SUCCESS: show unmappedCount > 0 and link to Unmapped Parts filtered.
- Unmapped Parts:
  - PENDING_REVIEW: default filter; show occurrenceCount prominently.
  - RESOLVED/IGNORED: visible via filter; updates (if supported) require confirmation.

---

## 11. Alternate / Error Flows

1. **Empty state: no runs**
   - Show â€œNo ingestion runs found for selected filtersâ€ with suggestion to expand date range.

2. **Empty state: no unmapped parts**
   - Show â€œNo unmapped parts currently pending review.â€

3. **Backend unavailable**
   - Show non-blocking error banner + retry; keep last successful data cached in screen state until refresh (UI-only behavior).

4. **Unauthorized access**
   - User navigates directly to URL: show Access Denied; no partial render of sensitive data.

5. **Invalid filter values**
   - If user inputs malformed UUID/date: prevent submit and show inline validation.
   - If backend rejects: show banner + mark invalid field.

6. **Detail not found**
   - Run detail URL stale due to retention/archival: show not found + link back.

7. **Concurrency (only if status update exists)**
   - Another operator updates status: on save, backend returns 409 or updated object differs; UI refreshes row and shows message.

---

## 12. Acceptance Criteria

### Scenario 1: View ingestion runs list
**Given** I am an authenticated Integration Operator with permission to view availability feed ops  
**When** I open the â€œAvailability Feeds (Ops) â†’ Ingestion Runsâ€ screen  
**Then** I see a paginated list of ingestion runs including manufacturerId, asOf, receivedAt, itemCount, mappedCount, unmappedCount, and outcome  
**And** I can filter by manufacturerId and asOf date range

### Scenario 2: Navigate from partial success run to unmapped parts
**Given** an ingestion run exists with outcome `PARTIAL_SUCCESS` and `unmappedCount > 0`  
**When** I select that run and click â€œView unmapped partsâ€  
**Then** I am taken to the Unmapped Parts screen with filters pre-applied for that manufacturerId  
**And** I see unmapped items with manufacturerPartNumber, firstSeen, lastSeen, occurrenceCount, and status

### Scenario 3: Search for a specific unmapped part number
**Given** I am on the Unmapped Parts screen  
**When** I search for manufacturerPartNumber â€œABC-123â€  
**Then** the list updates to show matching unmapped records (or an explicit empty state if none)

### Scenario 4: View normalized availability records
**Given** normalized availability records exist for a manufacturerId within a date range  
**When** I open â€œNormalized Availabilityâ€ and filter by manufacturerId and asOf range  
**Then** I see records including productId, manufacturerPartNumber, availableQty, uom, unitPrice, leadTime min/max, minOrderQty (blank if null), packSize, sourceLocationCode, and asOf

### Scenario 5: Access denied
**Given** I am authenticated but do not have permission to view availability feed ops  
**When** I navigate to any Availability Feeds (Ops) URL directly  
**Then** I see an access denied message  
**And** no operational data is displayed  
**And** the UI does not attempt to fetch list data after receiving a 403

### Scenario 6: Backend error handling
**Given** the backend service returns a 5xx or times out when loading ingestion runs  
**When** I open the Ingestion Runs screen  
**Then** I see an error banner with a retry action  
**And** my selected filters remain intact

### Scenario 7 (optional, only if supported): Update unmapped part status
**Given** I have permission to triage unmapped parts  
**And** an unmapped part is in `PENDING_REVIEW`  
**When** I set its status to `IGNORED` and confirm  
**Then** the UI calls the update endpoint  
**And** the row updates to show status `IGNORED`  
**And** the change is reflected on refresh

---

## 13. Audit & Observability

### User-visible audit data
- Display timestamps on records (`receivedAt`, `asOf`, `firstSeen`, `lastSeen`, `createdAt`).
- For any status update (if implemented), show â€œLast updated at/byâ€ **only if backend provides**.

### Status history
- Not required unless backend exposes it; if exposed, render read-only history on detail view.

### Traceability expectations
- Provide copyable identifiers:
  - manufacturerId, asOf, runId/correlationId
  - exceptionId/correlationId
  - unmapped part id + manufacturerPartNumber
- Frontend logs (client-side) should include correlationId/runId when available in responses.

---

## 14. Non-Functional UI Requirements

- **Performance**: List screens must support pagination; do not fetch unbounded lists.
- **Accessibility**: All controls keyboard accessible; table rows have accessible labels; error banners announced.
- **Responsiveness**: Works on tablet widths (Ops may use tablet on floor).
- **i18n/timezone**: Display timestamps in user locale but preserve UTC in data; show timezone indicator (e.g., â€œasOf (UTC)â€ or convert with clear label).
- **Currency**: Display unitPrice currency code; do not assume USD-only in UI.

---

## 15. Applied Safe Defaults

- SD-UI-EMPTY-STATE: Provide explicit empty state messaging for lists; safe because it doesnâ€™t affect domain logic and improves usability. (Impacted: UX Summary, Error Flows, Acceptance Criteria)
- SD-UI-PAGINATION: Default pagination (pageSize e.g., 25) with server-side paging; safe because itâ€™s UI ergonomics and avoids performance issues. (Impacted: UX Summary, Service Contracts, Non-Functional)
- SD-ERR-STANDARD: Standard mapping of HTTP errors (400/401/403/404/409/5xx) to banner/inline messages; safe because it is generic error handling without domain policy. (Impacted: Service Contracts, Error Flows, Acceptance Criteria)
- SD-OBS-CLIENT-LOG: Log client-side fetch failures with screen name and correlationId if present; safe because itâ€™s observability boilerplate without secrets. (Impacted: Audit & Observability, Error Flows)

---

## 16. Open Questions

1. **Backend API contracts (blocking):** What are the exact endpoints (paths), request params, and response schemas for:
   - ingestion run list + detail
   - normalized availability list
   - unmapped parts list (+ optional status update)
   - exception queue list + detail  
   (Need this to implement Moqui service calls and data bindings.)

2. **Authorization (blocking):** What permission(s)/role(s) gate access to these screens? Are they the same as existing â€œinventory opsâ€ permissions or new integration-specific ones?

3. **ExceptionQueue scope (blocking):** Is there an existing exception queue API in this frontend/backends, or must this screen be limited to inventory-domain exceptions only? What fields are guaranteed (severity, status, details)?

4. **Unmapped status update (scope decision):** Should the frontend allow changing `UnmappedManufacturerParts.status` (PENDING_REVIEW/IGNORED/RESOLVED), or is it strictly read-only in v1?

5. **Retention/TTL UX:** Backend mentions TTL/archival policy is an implementation decision. Will runs/availability be retained, and should UI support selecting archived ranges?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Availability: Normalize Manufacturer Inventory Feeds (Stub via Positivity) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/110


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Availability: Normalize Manufacturer Inventory Feeds (Stub via Positivity)
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/110
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Availability: Normalize Manufacturer Inventory Feeds (Stub via Positivity)

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As an **Integration Operator**, I want manufacturer availability/lead-time feeds so that we can estimate fulfillment for special orders.

## Details
- Map manufacturer part numbers to internal productId.
- Capture lead time, backorder status, min-order rules (optional).

## Acceptance Criteria
- Ingestion idempotent.
- Lead time/status exposed.
- Errors routed to exception queue.

## Integrations
- Positivity connectors fetch feeds; product normalizes; workexec can display lead-time messaging.

## Data / Entities
- ExternalAvailability, ManufacturerPartMap, ExceptionQueue

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Product / Parts Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

END FRONTEND STORY (FULL CONTEXT)

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #111: [FRONTEND] [STORY] Availability: Normalize Distributor Inventory Feeds (Stub via Positivity) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/111
File: ./scripts/story-work/frontend/111/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] Availability: Normalize Distributor Inventory Feeds (Stub via Positivity) â€” Admin UI for Ingest, Exceptions, and Query

### Primary Persona
Integration Operator

### Business Value
Provide an operator-facing UI to (1) trigger and monitor distributor availability feed ingestion (stub v1), (2) review and resolve mapping/normalization exceptions, and (3) query normalized availability for downstream consumption/testingâ€”enabling a unified, auditable availability view.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Integration Operator  
- **I want** a Moqui/Quasar UI to ingest (stub) distributor availability feeds, review exceptions, and query normalized availability  
- **So that** distributor feeds can be operationalized and validated without direct database access or ad-hoc scripts.

### In-scope
- Moqui screens (Vue/Quasar) to:
  1) Manually trigger ingestion of a stub feed payload/path via Positivity-backed service endpoint(s)  
  2) View last ingest runs and high-level outcomes (counts, timestamps, distributor)  
  3) View/search exception queue entries, inspect payload/reason, and mark as acknowledged/resolved (UI-driven status change only)  
  4) Query normalized availability records by product/distributor/region and view normalized vs raw fields
- Frontend validation and error handling aligned to backend contracts
- Routing, navigation, and basic RBAC gating (permission-based UI enable/disable)

### Out-of-scope
- Designing/implementing the actual ingestion pipeline logic (backend responsibility)
- Creating or editing SKU mapping logic beyond invoking existing mapping-management endpoints (if any)
- Defining distributor onboarding, pricing policies, valuation, or allocation/reservation logic
- Building live Positivity connector UI (v1 stub only)

---

## 3. Actors & Stakeholders

### Actors
- **Integration Operator**: triggers ingestion, monitors runs, triages exceptions
- **Inventory Data Steward** (secondary): may resolve mapping gaps (often outside this UI unless mapping screens exist)

### Stakeholders
- **Work Execution users** (indirect): depend on normalized availability accuracy
- **Inventory Manager** (indirect): uses availability/lead times for planning
- **Engineering / On-call**: uses UI for troubleshooting

---

## 4. Preconditions & Dependencies

- Backend provides endpoints/services (or Moqui service facades) to:
  - Trigger stub ingestion (e.g., â€œprocess feed from file/static endpointâ€)
  - List/query normalized availability records
  - List/query exception queue entries and update exception status/acknowledgement
  - (Optional) list ingest job runs / last run status (if not available, UI must only show â€œtrigger acceptedâ€)
- User is authenticated and authorized; permissions are enforced server-side.
- Entities exist conceptually (names from reference): `ExternalAvailability`, `DistributorSkuMap`, `ExceptionQueue`. UI must not assume direct entity CRUD unless backend explicitly exposes it.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Inventory â†’ Availability Feeds** (new menu entry)
- Deep links:
  - `/inventory/availability/feeds`
  - `/inventory/availability/exceptions`
  - `/inventory/availability/search`

### Screens to create/modify
Create new screen tree (example; final paths should follow repo conventions):
- `component://durion/screen/inventory/availability/AvailabilityFeeds.xml` (landing + trigger)
- `.../AvailabilityExceptions.xml` (exception queue list + detail)
- `.../AvailabilitySearch.xml` (query normalized availability)

Add menu/nav link in existing inventory menu screen.

### Navigation context
- Tabs or subnav within Availability section:
  - **Ingest**
  - **Exceptions**
  - **Search**

### User workflows

#### Happy path: Trigger ingest and verify data
1. Operator opens **Availability Feeds â†’ Ingest**
2. Selects `distributorId` and provides stub source (path or selects a configured stub)
3. Clicks **Run Ingestion**
4. UI shows submission success, displays run correlation info (if returned), and links to:
   - exceptions filtered by distributor and time
   - normalized availability search filtered by distributor

#### Alternate path: Review exceptions
1. Operator opens **Exceptions**
2. Filters by distributor and reasonCode (e.g., `SKU_UNMAPPED`)
3. Opens exception detail to view raw payload + error message
4. Marks as **Acknowledged** (or **Resolved** if backend supports) with optional note
5. Returns to list; item reflects new status

#### Alternate path: Query normalized availability
1. Operator opens **Search**
2. Filters by productId and/or distributorId and/or shipFromRegionCode
3. Views normalized fields and raw fields for traceability

---

## 6. Functional Behavior

### Triggers
- User action: click **Run Ingestion**
- User action: change filters/search
- User action: open exception detail
- User action: acknowledge/resolve exception

### UI actions
- **Run Ingestion**
  - Validate required inputs
  - Call backend â€œtrigger ingestâ€ service
  - Render result summary (accepted/started + counts if returned)
- **Exceptions list**
  - Query backend with pagination/sort
  - Render reasonCode, distributorId, firstSeenAt, lastSeenAt, occurrenceCount, status
- **Exception detail**
  - Load exception by id
  - Render payload (read-only), reasonCode, errorMessage, timestamps
  - Allow status update action (acknowledge/resolve)
- **Availability search**
  - Query backend with filters
  - Render normalized and raw fields:
    - quantityAvailable, leadTimeDaysMin/Max, shipFromRegionCode
    - normalizationPolicyVersion, rawLeadTimeRaw, rawShipFromRegionRaw, lastUpdatedAt

### State changes
- Exception status transitions (only if backend supports):
  - `OPEN` â†’ `ACKNOWLEDGED`
  - `ACKNOWLEDGED` â†’ `RESOLVED`
  - (Optional) `RESOLVED` â†’ `OPEN` (reopen) if supported  
If statuses are not defined by backend, UI must treat exceptions as read-only and only support â€œAdd operator noteâ€ if available.

### Service interactions
- Trigger ingestion: `availability.feed.ingestStub` (placeholder name; must align with actual backend/Moqui service)
- Query normalized availability: `availability.externalAvailability.search`
- Exception queue:
  - list/search: `availability.exception.search`
  - view: `availability.exception.get`
  - update status: `availability.exception.updateStatus`

(If the Moqui frontend uses REST calls via a gateway rather than Moqui services, map these to REST endpoints instead; see Open Questions.)

---

## 7. Business Rules (Translated to UI Behavior)

- **BR1 Idempotency is mandatory (backend rule):**
  - UI must allow re-running ingestion without warning that implies duplication risk.
  - UI copy should state: â€œRe-running the same feed will refresh lastUpdatedAt without creating duplicates.â€
- **BR2 Mapping authority is DistributorSkuMap (backend rule):**
  - UI must not attempt to â€œguessâ€ mappings.
  - Exceptions with `SKU_UNMAPPED` must be clearly labeled as requiring mapping creation elsewhere.
- **BR3 Record-level atomicity:**
  - After an ingest run, UI must show counts including succeeded/failed/exception if provided; otherwise show â€œRun submitted; see Exceptions.â€
- **BR4 Explainable normalization:**
  - Availability Search results must display `normalizationPolicyVersion` and raw fields alongside normalized fields.

### Validation
- Ingest form:
  - `distributorId` required
  - Stub source required (either `stubPath` or `stubPayload`, depending on backend contract)
- Exception status update:
  - status must be one of allowed values from backend (UI must not hardcode unknown enums; if backend returns allowed transitions, use them)

### Enable/disable rules
- Disable **Run Ingestion** while request is in-flight
- Disable exception status actions if user lacks permission or backend returns 403
- Hide/disable entire Availability section if user lacks base permission (see Open Questions)

### Error messaging expectations
- 400: show validation message inline (e.g., â€œdistributorId is requiredâ€)
- 403: show â€œYou do not have permission to perform this action.â€
- 409: show concurrency/updated-by-other message on exception status updates
- 5xx/network: show retryable toast + preserve form inputs

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- **ExternalAvailability** (normalized availability record; read-only in UI)
- **ExceptionQueue** (exception records; status may be updatable)
- **DistributorSkuMap** (referenced; not edited in this story unless an endpoint existsâ€”out-of-scope)

### Fields

#### Ingest request (UI model)
- `distributorId` (string/UUID; required)
- `asOf` (datetime UTC; optional; if provided, sent to backend)
- One of:
  - `stubPath` (string; required if backend uses file path)
  - OR `payload` (JSON object; required if backend accepts posted payload)

#### ExternalAvailability (read-only list/detail fields)
- `productId` (UUID; required)
- `distributorId` (string; required)
- `quantityAvailable` (int >= 0; required)
- `leadTimeDaysMin` (int|null)
- `leadTimeDaysMax` (int|null)
- `shipFromRegionCode` (string; required)
- `normalizationPolicyVersion` (string; required)
- `rawLeadTimeRaw` (string; nullable)
- `rawShipFromRegionRaw` (string; nullable)
- `lastUpdatedAt` (datetime UTC; required)

#### ExceptionQueue (list/detail fields)
- `exceptionId` (string/UUID; required)
- `distributorId` (string; required)
- `reasonCode` (enum; required)
- `errorMessage` (string; required)
- `payload` (JSON/text; required)
- `firstSeenAt` (datetime UTC; required)
- `lastSeenAt` (datetime UTC; required)
- `occurrenceCount` (int; required)
- `status` (enum; required if backend supports)
- `operatorNote` (string; optional if supported)

### Read-only vs editable by state/role
- ExternalAvailability: read-only for all roles in this story
- ExceptionQueue:
  - payload and system fields read-only
  - status/operatorNote editable only for authorized users and only for allowed transitions

### Derived/calculated fields (UI-only)
- Display â€œLead timeâ€ as:
  - `min-max days` if both present
  - `min days` if only min present
  - `â€”` if null
- Display â€œAgeâ€ for exception as `now - firstSeenAt` (presentation only)

---

## 9. Service Contracts (Frontend Perspective)

> Note: exact service names/routes must align with the backend implementation. The frontend must be written to the definitive contract once confirmed.

### Load/view calls
1. **Search External Availability**
   - Request params:
     - `productId?`, `distributorId?`, `shipFromRegionCode?`
     - `pageIndex`, `pageSize`, `sort`
   - Response:
     - `items[]: ExternalAvailability`
     - `pageIndex`, `pageSize`, `totalCount`

2. **Search Exceptions**
   - Request params:
     - `distributorId?`, `reasonCode?`, `status?`, `from?`, `to?`
     - pagination/sort
   - Response:
     - `items[]: ExceptionQueueSummary`
     - pagination envelope

3. **Get Exception Detail**
   - Request: `exceptionId`
   - Response: `ExceptionQueue` record including payload

### Create/update calls
4. **Update Exception Status / Note**
   - Request:
     - `exceptionId`
     - `newStatus`
     - `operatorNote?`
     - `expectedVersion?` (if backend uses optimistic locking)
   - Response:
     - updated exception record

### Submit/transition calls
5. **Trigger Stub Ingestion**
   - Request:
     - `distributorId`
     - `asOf?`
     - `stubPath` OR `payload`
   - Response (preferred):
     - `runId` / `correlationId`
     - `receivedCount`, `normalizedCount`, `exceptionCount` (optional if async)
     - `startedAt`, `finishedAt` (if sync)

### Error handling expectations
- Standard envelope mapping:
  - `fieldErrors[]` for 400 â†’ map to form fields
  - `message` for non-field errors â†’ toast/banner
- 403 â†’ show permission error and keep user on screen
- 404 on exception detail â†’ show â€œException not foundâ€ with back link
- 409 on update â†’ prompt to reload record

---

## 10. State Model & Transitions

### Allowed states (ExceptionQueue)
If backend supports exception workflow states, UI must support at least:
- `OPEN`
- `ACKNOWLEDGED`
- `RESOLVED`

### Role-based transitions
- Integration Operator:
  - may transition `OPEN â†’ ACKNOWLEDGED`
  - may transition `ACKNOWLEDGED â†’ RESOLVED`
- Read-only roles:
  - no transitions; view only

(Exact permissions are unknown; see Open Questions.)

### UI behavior per state
- `OPEN`: show primary action â€œAcknowledgeâ€
- `ACKNOWLEDGED`: show action â€œResolveâ€
- `RESOLVED`: show read-only; optionally â€œReopenâ€ only if backend supports

---

## 11. Alternate / Error Flows

### Validation failures
- Missing `distributorId` on ingest: inline error; do not submit
- Missing stub source (if required): inline error

### Concurrency conflicts
- Exception updated elsewhere:
  - backend returns 409 or version mismatch
  - UI shows conflict message and reload button; preserves operator note in local state so it can be re-applied

### Unauthorized access
- User navigates to Availability section without permission:
  - Screen shows â€œNot authorizedâ€ (or redirects to home) based on app convention
- User attempts action:
  - Disable buttons if permission info is known; otherwise handle 403 gracefully

### Empty states
- No exceptions: show â€œNo exceptions found for current filtersâ€
- No availability results: show â€œNo normalized availability foundâ€ + suggestion to run ingest

---

## 12. Acceptance Criteria

### Scenario 1: Trigger stub ingestion successfully
**Given** I am an authenticated Integration Operator with permission to run availability ingestion  
**And** I am on the Availability Feeds â€œIngestâ€ screen  
**When** I select a distributorId and provide the required stub source input  
**And** I click â€œRun Ingestionâ€  
**Then** the UI submits the trigger request to the backend  
**And** I see a confirmation that the run was accepted (including a runId/correlationId if provided)  
**And** the Run button is disabled while the request is in-flight and re-enabled afterward.

### Scenario 2: Ingest validation blocks submission
**Given** I am on the â€œIngestâ€ screen  
**When** I click â€œRun Ingestionâ€ without selecting a distributorId  
**Then** I see an inline validation error for distributorId  
**And** no backend request is made.

### Scenario 3: View exceptions list with filters
**Given** exceptions exist for distributor D1  
**When** I open the â€œExceptionsâ€ screen and filter by distributorId=D1  
**Then** I see a paginated list of exception records  
**And** each row includes reasonCode, occurrenceCount, lastSeenAt, and status (if supported).

### Scenario 4: View exception detail
**Given** an exception with id E1 exists  
**When** I open exception E1 from the list  
**Then** I see the raw payload, reasonCode, and errorMessage  
**And** I can navigate back to the filtered list.

### Scenario 5: Acknowledge an open exception (if backend supports status updates)
**Given** exception E1 is in status OPEN  
**And** I have permission to update exception status  
**When** I click â€œAcknowledgeâ€ and confirm  
**Then** the UI sends an update request for E1  
**And** E1 status becomes ACKNOWLEDGED in the UI  
**And** if the backend returns 403, the UI shows a permission error and E1 remains unchanged.

### Scenario 6: Query normalized availability
**Given** normalized availability exists for product P1 and distributor D1  
**When** I open the â€œSearchâ€ screen and filter by productId=P1 and distributorId=D1  
**Then** I see availability results including quantityAvailable, shipFromRegionCode, leadTimeDaysMin/Max  
**And** I can see normalizationPolicyVersion and the raw lead time/region fields for traceability.

### Scenario 7: Backend error handling on ingestion trigger
**Given** the backend ingestion trigger returns a 5xx error  
**When** I click â€œRun Ingestionâ€  
**Then** the UI shows a retryable error message  
**And** my entered form values remain intact.

---

## 13. Audit & Observability

### User-visible audit data
- Exception detail shows timestamps: `firstSeenAt`, `lastSeenAt`
- If exception status updates are supported, show:
  - last updated timestamp
  - last updated by (if backend returns actor)

### Status history
- If backend provides status history, display in exception detail as a read-only list (timestamp, from/to, actor).  
- If not available, do not invent; show only current status.

### Traceability expectations
- After triggering ingestion, display returned `runId/correlationId` and include it in UI logs (console/network) for support correlation.

---

## 14. Non-Functional UI Requirements

- **Performance**: exception and availability lists must support server-side pagination; initial load under 2s for typical datasets (first page).
- **Accessibility**: all actions keyboard reachable; dialogs have focus trap; tables have accessible labels; color not sole indicator for status.
- **Responsiveness**: screens usable on tablet widths; tables may switch to stacked rows/cards on small screens if consistent with app patterns.
- **i18n/timezone**: display timestamps in user locale/timezone but keep underlying values UTC; show timezone indicator in UI.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE  
  - **Assumed**: Standard empty-state messages for no results/no exceptions.  
  - **Why safe**: Pure UI ergonomics; does not change domain logic.  
  - **Impacted sections**: UX Summary, Alternate / Error Flows, Acceptance Criteria.

- SD-UX-PAGINATION  
  - **Assumed**: Server-side pagination with page size default (e.g., 25) and sort by `lastSeenAt desc` for exceptions.  
  - **Why safe**: UI ergonomics; does not define business policy.  
  - **Impacted sections**: UX Summary, Service Contracts, Non-Functional UI Requirements.

- SD-ERR-HTTP-MAPPING  
  - **Assumed**: Standard handling for 400/403/404/409/5xx with inline field errors and toast/banner messages.  
  - **Why safe**: Generic error UX mapping; does not invent domain rules.  
  - **Impacted sections**: Business Rules, Service Contracts, Alternate / Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. What are the **actual Moqui endpoints/services** to call for:
   - triggering stub ingestion,
   - querying ExternalAvailability,
   - querying/updating ExceptionQueue?
   (Provide route/service names and request/response schemas.)

2. What **permissions/roles** gate:
   - viewing Availability section,
   - triggering ingestion,
   - updating exception status/adding operator notes?

3. Does ExceptionQueue support **status lifecycle** (`OPEN/ACKNOWLEDGED/RESOLVED`) and **optimistic locking/versioning**? If yes, what are the exact field names (`status`, `version`, etc.) and allowed transitions?

4. Is the stub ingest input **file-path-based** (e.g., `AVAIL_FEED_STUB_PATH`) or **payload-posted** from UI, or both? If both, which is preferred for v1?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Availability: Normalize Distributor Inventory Feeds (Stub via Positivity) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/111


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Availability: Normalize Distributor Inventory Feeds (Stub via Positivity)
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/111
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Availability: Normalize Distributor Inventory Feeds (Stub via Positivity)

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As an **Integration Operator**, I want to ingest distributor availability feeds so that a unified availability view can be presented.

## Details
- Map distributor SKUs to internal productId.
- Normalize qty, lead time, ship-from region.
- Stub connector acceptable in v1.

## Acceptance Criteria
- Ingestion idempotent.
- Mapping errors routed to exception queue.
- Normalized availability queryable.

## Integrations
- Positivity connectors fetch feeds; product normalizes for inventory/workexec.

## Data / Entities
- ExternalAvailability, DistributorSkuMap, ExceptionQueue

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Product / Parts Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #112: [FRONTEND] [STORY] Availability: Expose On-hand and Available-to-Promise by Location (from Inventory) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/112
File: ./scripts/story-work/frontend/112/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Availability: View On-hand and Available-to-Promise (ATP) by Location for a Product

### Primary Persona
Service Advisor (POS user creating quotes/estimates)

### Business Value
Enables accurate quoting and fulfillment expectation-setting by showing location-level on-hand and ATP for a selected product.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** to view on-hand and available-to-promise quantities by fulfillment location for a selected product,  
**So that** I can quote realistically and avoid committing inventory that is already reserved.

### In-scope
- A POS UI panel/page that, given a `productId`, loads and displays availability by location (on-hand and ATP).
- Handling of empty results, missing/invalid product, and unauthorized access per backend responses.
- Moqui screen + transitions + service-call integration to the Inventory availability endpoint.

### Out-of-scope
- Editing inventory, making reservations, allocations, transfers, or replenishment actions.
- Including expected replenishments in ATP (explicitly excluded in v1).
- Any changes to Product domain master data.
- Cross-product search UX beyond a minimal â€œenter/select productIdâ€ entry point (see Open Questions).

---

## 3. Actors & Stakeholders
- **Primary actor:** Service Advisor (end user)
- **System actor:** Moqui POS Frontend (screens calling backend)
- **Stakeholders:** Inventory Manager (trusts accuracy), Product/Catalog system (productId mapping), POS Leadership (quote accuracy/SLA)

---

## 4. Preconditions & Dependencies
- User is authenticated in the POS frontend.
- A valid `productId` is available in the current context (e.g., quote line item, product detail) or can be entered.
- Backend endpoint exists and is reachable:
  - `GET /api/v1/inventory/availability?productId=<id>`
- Backend response contract matches the backend story reference (#48) including:
  - `productId`
  - `locations[]` with `locationId`, `locationName`, `onHandQuantity`, `availableToPromiseQuantity`
- Authorization is enforced server-side; unauthorized yields `403`.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
At least one must be implemented (final selection depends on clarification):
1. **From Product context**: A â€œAvailabilityâ€ action in a product detail screen (productId already known).
2. **From Quote/Estimate line item**: â€œCheck availabilityâ€ for the selected productId.
3. **Standalone utility screen**: Enter `productId` and view availability.

### Screens to create/modify (proposed Moqui screen artifacts)
- **New screen**: `apps/pos/screen/inventory/Availability.xml` (name indicative; align to repo conventions)
  - Parameters: `productId` (required for query execution)
- **Optional embed/subscreen**: `.../inventory/AvailabilityPanel.xml` to include in product/quote screens.
- **Modify existing screens** (TBD by repo structure):
  - Product detail screen: add navigation to Availability screen with `productId` param.
  - Quote line item screen: add link/button passing `productId`.

### Navigation context
- Breadcrumb/back behavior returns user to the originating context (product/quote) preserving state.
- The screen supports direct navigation with `productId` in URL parameters.

### User workflows
**Happy path**
1. User opens availability view from a product context (or enters productId).
2. Frontend calls availability API.
3. UI renders list of locations with on-hand and ATP.

**Alternate paths**
- Valid product but no inventory anywhere â†’ show empty-state with â€œNo inventory records found for this product.â€
- Invalid/missing productId â†’ show validation error and do not call API.
- Product not found (404) â†’ show â€œProduct not foundâ€ message.
- Unauthorized (403) â†’ show â€œYou donâ€™t have access to view availabilityâ€ and provide guidance to contact admin.
- Network/server error â†’ show retry affordance and keep last successful results (if any) clearly marked as stale.

---

## 6. Functional Behavior

### Triggers
- Screen loads with a non-empty `productId` parameter, OR user submits a â€œLookupâ€ form with `productId`.

### UI actions
- Action: `Lookup` (if productId not already provided)
- Action: `Refresh` (re-fetch availability for current productId)
- Action: `Change product` (clears current results and allows new productId)

### State changes (frontend UI state)
- `idle` â†’ `loading` when request starts
- `loading` â†’ `loaded` on 200 response (including empty locations)
- `loading` â†’ `error` on 4xx/5xx or network error

### Service interactions (Moqui-side integration)
- Moqui screen transition invokes a Moqui service (or REST call via Moqui tools) to fetch availability:
  - Input: `productId`
  - Output: `AvailabilityView` object stored in screen context for rendering

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `productId` is required to execute lookup.
- `productId` is treated as an opaque string identifier; UI does not enforce formatting beyond non-empty (unless clarified).

### Enable/disable rules
- Disable `Refresh` while `loading`.
- Disable `Lookup` while `loading`.
- If no `productId`, disable `Refresh` and show prompt.

### Visibility rules
- Results table/list visible only in `loaded` state.
- Empty-state visible in `loaded` state when `locations.length == 0`.
- Error banner visible in `error` state.

### Error messaging expectations (mapped from backend)
- 400: â€œProduct ID is required.â€ (or backend-provided message)
- 404: â€œProduct not found.â€
- 403: â€œNot authorized to view inventory availability.â€
- 5xx/network: â€œUnable to load availability right now. Try again.â€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **No new persistent entities required** for v1 UI (read-only view).
- Screen context data structures:
  - `AvailabilityView`
  - `locations[]`

### Fields
**Input**
- `productId` (string, required, no default)

**Response**
- `productId` (string, required, read-only)
- `locations` (array, required; may be empty)
  - `locationId` (string, required, read-only)
  - `locationName` (string, required, read-only)
  - `onHandQuantity` (integer, required, read-only; expected non-negative)
  - `availableToPromiseQuantity` (integer, required, read-only; may be negative)

### Read-only vs editable
- All returned quantities and location details are read-only.

### Derived/calculated fields (UI-only)
- None required.
- Optional UI-only indicator: â€œATP negativeâ€ if `availableToPromiseQuantity < 0` (presentation only; no policy implied).

---

## 9. Service Contracts (Frontend Perspective)

### Load/view calls
- **HTTP**: `GET /api/v1/inventory/availability?productId={productId}`
- **Success (200)**: JSON matching backend story structure:
  - `{ productId: string, locations: LocationAvailability[] }`
- **Empty locations**: 200 with `locations: []`

### Create/update calls
- None.

### Submit/transition calls (Moqui)
- Transition: `lookupAvailability`
  - Validates `productId` present
  - Calls REST endpoint
  - Places result in context and renders the same screen with results

### Error handling expectations
- 400/404/403 handled with user-facing messages and no crash.
- 5xx/network shows retry; logs client-side error details without leaking sensitive data.

---

## 10. State Model & Transitions

### Allowed states (UI state machine)
- `idle`: no request yet
- `loading`: request in-flight
- `loaded`: last request succeeded (may be empty)
- `error`: last request failed

### Role-based transitions
- Viewing availability depends on backend authorization; UI does not hardcode roles.
- If backend returns 403, UI must not retry automatically; show access error.

### UI behavior per state
- `idle`: show productId entry or prompt; no results
- `loading`: show loading indicator; disable actions
- `loaded`: show results or empty-state
- `error`: show error banner + retry

---

## 11. Alternate / Error Flows

### Validation failures
- Missing `productId` on submit:
  - Do not call API
  - Show inline validation message

### Concurrency conflicts
- Not applicable (read-only).
- If multiple refreshes triggered quickly, latest response wins; earlier responses discarded (implementation detail; see Open Questions if repo has a standard pattern).

### Unauthorized access
- API returns 403:
  - Display not-authorized message
  - Do not display stale/previous product results if they belong to a different productId than current (prevent confusion)

### Empty states
- 200 with `locations: []`:
  - Show â€œNo inventory records found for this product.â€
  - Still show queried `productId` as context.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View availability for product with inventory in multiple locations
**Given** I am an authenticated Service Advisor  
**And** I navigate to the Availability view with `productId="SKU-123"`  
**When** the system loads availability successfully  
**Then** I see a list of locations for `SKU-123`  
**And** each location row shows `locationName`, `onHandQuantity`, and `availableToPromiseQuantity`  
**And** the values match the API response for each location.

### Scenario 2: Product has no inventory records anywhere
**Given** I am an authenticated Service Advisor  
**And** I lookup availability for `productId="SKU-456"`  
**When** the API responds `200` with an empty `locations` array  
**Then** I see an empty-state message indicating no inventory records were found  
**And** no location rows are displayed.

### Scenario 3: Missing productId is blocked client-side
**Given** I am on the Availability view without a `productId`  
**When** I attempt to run the lookup  
**Then** the UI shows a validation message that `productId` is required  
**And** no API request is sent.

### Scenario 4: Product not found
**Given** I am an authenticated Service Advisor  
**When** I lookup availability for `productId="SKU-999"`  
**And** the API responds with `404 Not Found`  
**Then** the UI shows a â€œProduct not foundâ€ error message  
**And** no results are displayed.

### Scenario 5: Unauthorized user
**Given** I am authenticated but not authorized to view inventory availability  
**When** I lookup availability for a valid `productId`  
**And** the API responds with `403 Forbidden`  
**Then** the UI shows a not-authorized message  
**And** the UI does not display availability results.

### Scenario 6: Server/network failure with retry
**Given** I am on the Availability view with `productId="SKU-123"`  
**When** the API request fails due to a network error or `5xx` response  
**Then** the UI shows an error state with a Retry action  
**When** I click Retry and the API succeeds  
**Then** the UI displays the loaded availability results.

---

## 13. Audit & Observability

### User-visible audit data
- Not required (read-only query).

### Status history
- Not applicable.

### Traceability expectations
- Frontend should log (client-side) a structured event for:
  - availability lookup initiated (include productId)
  - lookup success (include latency, count of locations)
  - lookup failure (include HTTP status if present, latency)
- Correlation ID behavior depends on existing frontend conventions (see Open Questions).

---

## 14. Non-Functional UI Requirements

- **Performance/SLA:** The availability view should render results promptly after API response; no client-side heavy computation.
- **Accessibility:** All interactive controls keyboard accessible; loading/error states announced appropriately (ARIA where Quasar supports it).
- **Responsiveness:** Results must be usable on common POS tablet widths; allow horizontal scrolling or stacked layout as needed.
- **i18n/timezone/currency:** Not applicable (quantities are numeric counts). Use locale-safe number formatting if project standard supports it.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a standard empty-state message when `locations` is empty; safe because it does not change domain logic and is reversible. (Impacted: UX Summary, Alternate/à°°à± Error Flows, Acceptance Criteria)
- SD-UX-LOADING-DISABLE: Disable lookup/refresh actions during in-flight request; safe UI ergonomics preventing duplicate calls. (Impacted: Functional Behavior, State Model)
- SD-ERR-MAP-HTTP: Map 400/403/404/5xx to standard user-facing banners; safe because it follows explicit backend status codes. (Impacted: Business Rules, Error Flows, Acceptance Criteria)

---

## 16. Open Questions
1. **Entry point selection (blocking):** Where should this Availability UI live in the POS?
   - Product detail screen, quote/estimate line item, standalone utility screen, or multiple?
2. **Moqui integration pattern (blocking):** Should the frontend call the backend Inventory API directly from the Vue client, or via Moqui screen transitions/services acting as a proxy (preferred in many Moqui setups)?
3. **Auth/correlation (blocking):** Is there an existing convention in this repo for propagating correlation IDs (e.g., `X-Correlation-Id`) and for handling 401 vs 403 in the UI?
4. **ProductId acquisition (blocking):** Do we have an existing product search/select component, or is the expected input strictly an existing `productId` passed from upstream screens?
5. **SLA requirement detail (blocking):** The original story mentions â€œSLA for estimate UIâ€ but does not specify a target (e.g., p95 latency). What target should frontend enforce/monitor (if any)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Availability: Expose On-hand and Available-to-Promise by Location (from Inventory) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/112


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Availability: Expose On-hand and Available-to-Promise by Location (from Inventory)
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/112
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Availability: Expose On-hand and Available-to-Promise by Location (from Inventory)

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Service Advisor**, I want on-hand/ATP by location so that I can quote with realistic fulfillment expectations.

## Details
- Query inventory for on-hand and ATP.
- Optional reservations and expected replenishment.

## Acceptance Criteria
- Availability API returns quantities by location.
- Consistent productId mapping.
- SLA for estimate UI.

## Integrations
- Product â†’ Inventory availability query; Inventory â†’ Product responses/events.

## Data / Entities
- AvailabilityView, LocationQty, ReservationSummary

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Product / Parts Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #119: [FRONTEND] [STORY] Master: Set Product Lifecycle State (Active/Discontinued) with Effective Dates â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/119
File: ./scripts/story-work/frontend/119/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Master: Manage Product Lifecycle State (Active/Inactive/Discontinued) with Effective Dates + Replacement Suggestions

## Primary Persona
Product Admin (or Inventory Admin)

## Business Value
Ensure discontinued/unsellable products are clearly flagged and enforced in downstream selling workflows (quotes/work orders) while maintaining an auditable history of lifecycle changes and providing replacement suggestions to prevent quoting unsourceable items.

---

# 2. Story Intent

## As a / I want / So that
**As a** Product Admin,  
**I want** to set a productâ€™s lifecycle state (Active/Inactive/Discontinued) with an effective date (date-only or timestamp) and optionally manage replacement products,  
**So that** selling/quoting workflows can avoid unsourceable items, and lifecycle changes are auditable and enforceable.

## In-Scope
- A â€œLifecycleâ€ section on a Product Master / Product Detail screen:
  - View current lifecycle state and its effective timestamp.
  - Change lifecycle state with an effective date/time input.
  - If setting to `DISCONTINUED`, require override permission and require/collect an override reason when applicable (per backend rules).
  - Display lifecycle change metadata (last changed by/at, effective at).
- Manage replacement suggestions for discontinued products:
  - Add one or more replacement products with priority order, optional notes, and effectiveAt.
  - List existing replacements sorted by priority.
- Frontend enforcement behaviors (UI-level gating) consistent with backend:
  - Disable/guard invalid transitions (e.g., reactivating discontinued).
  - Surface backend validation/permission errors clearly.
- Audit visibility:
  - Show lifecycle-related audit history entries (at minimum: state changes; ideally also replacement add/edit/remove if supported by backend).

## Out-of-Scope
- Defining/assigning security roles/permissions (security domain).
- Implementing downstream quote/work order enforcement screens (separate stories), except for displaying lifecycle state where already shown by shared product search components.
- Product master creation/edit outside lifecycle fields.
- Any inventory valuation/costing behavior.

---

# 3. Actors & Stakeholders
- **Primary Actor:** Product Admin / Inventory Admin (edits lifecycle state, sets replacements)
- **Secondary Actor:** Service Advisor (consumes lifecycle info during quoting/WO; may be blocked elsewhere)
- **System Stakeholders:**
  - Authorization/Permission subsystem (enforces `product:lifecycle:update` and `product:lifecycle:override_discontinued`)
  - Work Execution / Pricing & Availability consumers (must receive lifecycle status via existing responses)
- **Compliance Stakeholder:** Audit/Reporting consumer (needs traceability)

---

# 4. Preconditions & Dependencies
- Product exists and is viewable in Product Master UI.
- Backend story #55 is implemented and deployed (or equivalent services exist) providing:
  - Read product lifecycle fields (`lifecycleState`, `lifecycleStateEffectiveAt`, `lastStateChangedBy`, `lastStateChangedAt`, `lifecycleOverrideReason` where applicable).
  - Update lifecycle state with permission enforcement and validation (irreversibility, effective date validation).
  - CRUD for `ProductReplacement` records (at least create/list; update/delete if supported).
  - Audit/event publication for lifecycle change (frontend displays audit log if an endpoint exists).
- Authentication is in place; frontend can detect permission-based errors (403) and validation errors (400).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Product Master list â†’ Product Detail â†’ **Lifecycle** tab/section.
- Direct route to Product Detail (deep link) including Lifecycle section anchor.

## Screens to create/modify (Moqui)
- **Modify**: `apps/durion/screen/product/ProductDetail.xml` (name illustrative; must align to repo conventions)
  - Add a `subscreens` entry or a `section` for `Lifecycle`.
- **Create** (if not existing): `apps/durion/screen/product/ProductLifecycle.xml` as a subscreen:
  - Display current state panel (read-only fields + effective timestamp).
  - State change form.
  - Replacement list + add form (and optional edit/delete if supported).
  - Audit log view section (if supported).

## Navigation context
- Breadcrumb: Product Master â†’ Product {productId or displayName} â†’ Lifecycle
- Preserve current product context (`productId` parameter in URL).

## User workflows

### Happy path A â€” Set product to INACTIVE with effective date
1. User opens Lifecycle section.
2. User selects `INACTIVE`.
3. User enters effective date/time (date-only allowed).
4. User submits.
5. UI shows success and updated lifecycle metadata.

### Happy path B â€” Set product to DISCONTINUED (requires override permission)
1. User selects `DISCONTINUED`.
2. UI prompts for override reason if required by backend rule.
3. User submits.
4. UI refreshes state; replacements section becomes available/encouraged.

### Happy path C â€” Add replacement product(s)
1. For a discontinued product, user clicks â€œAdd Replacementâ€.
2. User searches/selects replacement product (product picker).
3. User sets priorityOrder (integer) and optional notes/effectiveAt.
4. UI saves and refreshes list.

### Alternate path â€” Attempt to reactivate DISCONTINUED
- UI should prevent selection/submit for invalid transition, and if attempted via stale UI, backend error is shown verbatim with mapped friendly message.

---

# 6. Functional Behavior

## Triggers
- Screen load with `productId`
- User submits lifecycle change form
- User submits add replacement form
- (Optional) User edits/deletes replacement (only if backend supports)

## UI actions
- **On load**: fetch product lifecycle details + replacement list (+ audit entries if available).
- **On state selection**:
  - If state == `DISCONTINUED`, show override permission hint and show â€œOverride Reasonâ€ input (visibility may depend on current state and permission).
  - If current state is `DISCONTINUED`, disable selecting `ACTIVE` or `INACTIVE` (hard disable) and show explanatory text.
- **On submit**:
  - Validate required inputs locally (presence, type) before calling backend.
  - Call backend update service; on success, refresh the product lifecycle details and audit section.

## State changes (domain state)
- `ACTIVE` â‡„ `INACTIVE` allowed (per backend).
- Transition to `DISCONTINUED` allowed only with override permission.
- `DISCONTINUED` â†’ `ACTIVE/INACTIVE` is not allowed (irreversible).

## Service interactions (Moqui)
- Use Moqui transitions for form submits.
- Use Moqui services (or REST via `service-call` if project pattern uses REST) to:
  - Load product lifecycle data
  - Update lifecycle state
  - List/create replacement records
  - Load audit log entries (if endpoint exists)

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Effective date/time:
  - Must be present (unless backend defaults â€œimmediatelyâ€; see Open Questions).
  - Must not be in the past (backend rule); UI should pre-check using client time **but treat backend as source of truth**.
- When setting to `DISCONTINUED`:
  - User must have permission `product:lifecycle:override_discontinued` or the submit will fail with 403.
  - Override reason:
    - If backend requires reason for discontinued and/or for overrides, UI must require non-empty text and show inline validation.
- Replacement records:
  - `replacementProductId` required.
  - `priorityOrder` required; must be integer >= 1 (backend constraints unknown; enforce minimally as integer).
  - `effectiveAt` optional unless backend requires.

## Enable/disable rules
- If current state is `DISCONTINUED`:
  - Disable state selection for `ACTIVE` and `INACTIVE`.
  - Lifecycle change submit disabled unless backend allows adding only replacements without changing state.
- DISCONTINUED selection enabled only if user has override permission **or** allow selection but expect 403; prefer disabling with a â€œpermission requiredâ€ message if permission info is available.

## Visibility rules
- Replacement management section visible when product is `DISCONTINUED` (or always visible but disabled with guidance; prefer conditional visibility).
- Override reason input visible when selecting `DISCONTINUED` (and/or when an override is being performed per backend response).

## Error messaging expectations
- If backend returns the known message:
  - `"Discontinued products cannot be reactivated. Specify a replacement product instead."`
  UI must surface it prominently near the lifecycle form.
- For 403: show â€œYou do not have permission to perform this action: <permissionName if provided>â€.
- For 400: show field-level errors when possible; otherwise show top-of-form error summary.

---

# 8. Data Requirements

## Entities involved (frontend perspective)
- `Product` (or product master view)
- `ProductReplacement` (originalProductId â†’ replacementProductId)
- `AuditLog` / lifecycle event stream (if exposed)

## Fields

### Product lifecycle fields (read-only except via form submit)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| productId | UUID/string | yes | n/a | route param |
| lifecycleState | enum(`ACTIVE`,`INACTIVE`,`DISCONTINUED`) | yes | n/a | displayed + edited via form |
| lifecycleStateEffectiveAt | Timestamp (UTC) | yes* | backend | *may be null for legacy products; UI must handle |
| lastStateChangedBy | UserRef | no | null | display if present |
| lastStateChangedAt | Timestamp (UTC) | no | null | display if present |
| lifecycleOverrideReason | string | no/conditional | null | display last override reason if present |

### Replacement fields (create/list)
| Field | Type | Required | Default | Notes |
|---|---|---:|---|---|
| replacementId | UUID/string | no (create) | n/a | assigned by backend |
| originalProductId | UUID/string | yes | from context | discontinued product |
| replacementProductId | UUID/string | yes | n/a | selected via picker |
| priorityOrder | integer | yes | 1 | UI may suggest next available |
| notes | string | no | null | textarea |
| effectiveAt | Timestamp (UTC) or date | no | null | UI supports date-only if backend supports |

## Read-only vs editable by state/role
- Users without `product:lifecycle:update`: all lifecycle and replacement forms read-only (view-only).
- Users with `product:lifecycle:update` but without `product:lifecycle:override_discontinued`:
  - Can set ACTIVE/INACTIVE (if allowed) but cannot set DISCONTINUED.
  - Can add replacements? (unclearâ€”Open Question; backend story suggests `product:lifecycle:update` sufficient for replacements.)

## Derived/calculated fields
- Display â€œSellable: Yes/Noâ€ derived from lifecycleState:
  - `ACTIVE` => Yes
  - `INACTIVE`/`DISCONTINUED` => No

---

# 9. Service Contracts (Frontend Perspective)

> Note: Exact service names/paths are not provided in inputs; this story defines required contracts and flags as blocking where unknown.

## Load/view calls
- **Get Product Detail (including lifecycle fields)**
  - Input: `productId`
  - Output: product fields including lifecycle state + effectiveAt + last changed metadata
- **List replacements**
  - Input: `originalProductId`
  - Output: array of `ProductReplacement` sorted by `priorityOrder` ascending

## Create/update calls
- **Update lifecycle state**
  - Input:
    - `productId`
    - `lifecycleState`
    - `effectiveAt` (timestamp or date-only)
    - `overrideReason` (conditional)
  - Output: updated product lifecycle fields
- **Create ProductReplacement**
  - Input:
    - `originalProductId`
    - `replacementProductId`
    - `priorityOrder`
    - `notes?`
    - `effectiveAt?`
  - Output: created replacement

## Submit/transition calls (Moqui screens)
- Lifecycle form submit transition:
  - On success: redirect back to same screen with success message and refreshed data.
  - On error: stay on page, show errors.

## Error handling expectations
- 400: validation errors; map to inline fields when possible
- 403: permission denied; show action blocked message; do not retry automatically
- 409 (if used): concurrency conflict; prompt to reload (see Error Flows)

---

# 10. State Model & Transitions

## Allowed states
- `ACTIVE`
- `INACTIVE`
- `DISCONTINUED`

## Role-/permission-based transitions
- `ACTIVE` â†’ `INACTIVE`: requires `product:lifecycle:update`
- `INACTIVE` â†’ `ACTIVE`: requires `product:lifecycle:update`
- `ACTIVE|INACTIVE` â†’ `DISCONTINUED`: requires `product:lifecycle:override_discontinued` (and possibly `product:lifecycle:update` as baseline; backend to confirm)

## UI behavior per state
- **ACTIVE**: lifecycle form allows selecting INACTIVE or DISCONTINUED (if permitted)
- **INACTIVE**: allow selecting ACTIVE or DISCONTINUED (if permitted)
- **DISCONTINUED**:
  - lifecycle state selector locked (read-only)
  - replacement management enabled (if permitted)
  - show banner: â€œDiscontinued products cannot be reactivated.â€

---

# 11. Alternate / Error Flows

## Validation failures
- Missing effective date/time (if required) â†’ inline error
- Effective date in past â†’ inline error (and backend error shown if backend rejects)
- Missing override reason when required â†’ inline error

## Concurrency conflicts
- If backend indicates product lifecycle changed since load (e.g., optimistic lock):
  - Show message: â€œThis productâ€™s lifecycle was updated by another user. Reload to continue.â€
  - Provide reload action.

## Unauthorized access
- User lacking permission attempts submit:
  - Show 403 error and keep form values (do not clear).
  - If permission names provided by backend, display them.

## Empty states
- No replacements exist:
  - Show â€œNo replacement products configured.â€
  - If discontinued, prompt to add one.

---

# 12. Acceptance Criteria

## Scenario 1: View lifecycle state on Product Detail
**Given** I am an authenticated user with access to view products  
**And** a product exists with lifecycleState `ACTIVE`  
**When** I open the Product Lifecycle section for that product  
**Then** I see the current lifecycle state and the effective timestamp (or â€œNot setâ€ if null)  
**And** I see last changed by/at if provided by the backend  

## Scenario 2: Set a product to INACTIVE with a future effective date
**Given** a product is currently `ACTIVE`  
**And** I have permission `product:lifecycle:update`  
**When** I select lifecycle state `INACTIVE`  
**And** I enter an effective date of `2023-11-01` (date-only)  
**And** I submit the lifecycle change  
**Then** the frontend sends an update request including the entered effective date  
**And** the screen refreshes showing lifecycleState `INACTIVE` and a stored UTC effective timestamp returned by backend  
**And** a success confirmation is shown  

## Scenario 3: Discontinue a product requires override permission
**Given** a product is currently `ACTIVE`  
**And** I do not have permission `product:lifecycle:override_discontinued`  
**When** I attempt to set lifecycle state to `DISCONTINUED` and submit  
**Then** the frontend prevents submission OR the backend responds `403`  
**And** the UI shows an error indicating the action requires `product:lifecycle:override_discontinued`  

## Scenario 4: Discontinue a product with override reason
**Given** a product is currently `ACTIVE`  
**And** I have permission `product:lifecycle:override_discontinued`  
**When** I select lifecycle state `DISCONTINUED`  
**And** I enter override reason `End of Life`  
**And** I submit  
**Then** the product shows lifecycleState `DISCONTINUED` after refresh  
**And** the UI shows a discontinued banner indicating it cannot be reactivated  
**And** the override reason is displayed if returned by backend  

## Scenario 5: Prevent reactivation of discontinued product
**Given** a product is `DISCONTINUED`  
**When** I attempt to change it to `ACTIVE` or `INACTIVE`  
**Then** the UI prevents the action  
**And** if a backend error is returned, the UI displays: â€œDiscontinued products cannot be reactivated. Specify a replacement product instead.â€  

## Scenario 6: Add a replacement product suggestion
**Given** a product is `DISCONTINUED`  
**And** I have permission to manage lifecycle (`product:lifecycle:update`)  
**When** I add replacement product `PROD-E` with priority `1` and optional notes  
**Then** the frontend creates a replacement record via backend  
**And** the replacement appears in the replacement list sorted by priority  

---

# 13. Audit & Observability

## User-visible audit data
- Display an â€œLifecycle Historyâ€ list showing at minimum:
  - timestamp
  - actor (user)
  - oldState â†’ newState
  - effectiveAt
  - reason (if present)
- If audit endpoint not available, show â€œAudit history unavailableâ€ and log a console warning only in dev mode.

## Status history
- Show current lifecycle + effectiveAt and last changed metadata (from product fields).
- Prefer to derive history from audit log rather than guessing.

## Traceability expectations
- All lifecycle update submissions include:
  - productId
  - proposed new state
  - effectiveAt input value (as entered)
- Frontend should include correlation/request id if project has standard header injection (per repo conventions).

---

# 14. Non-Functional UI Requirements
- **Performance:** Product lifecycle section should load within 1s on typical broadband once product detail is loaded; replacement list paginates if large (client-side minimal).
- **Accessibility:** All form controls labeled; errors announced via ARIA live region; keyboard navigable.
- **Responsiveness:** Works on tablet widths used on shop floor.
- **i18n/timezone/currency:**
  - Date/time inputs must clarify timezone handling; effectiveAt stored in UTC.
  - Display effectiveAt in userâ€™s local timezone with UTC tooltip (or dual display) if conventions support.

---

# 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE**
  - Assumed: Standard empty-state messaging for no replacement products.
  - Why safe: Pure UI ergonomics; does not change domain logic.
  - Impacted sections: UX Summary, Alternate/Empty states.
- **SD-UX-ERROR-MAP-HTTP**
  - Assumed: Map 400/403/409 to inline+banner errors using common patterns.
  - Why safe: Error mapping is presentation-only and reversible.
  - Impacted sections: Service Contracts, Alternate/Error Flows.

---

# 16. Open Questions

1. **Domain label conflict (Product vs Inventory):** Frontend story synopsis says â€œProduct / Parts Managementâ€ but backend labels `domain:inventory`. Confirm that Product Lifecycle State is owned by **Inventory domain** in this workspace and that this issue should be labeled `domain:inventory` (current proposal), not `domain:product` (which is not a provided canonical domain label set here).
2. **Backend service contract details:** What are the exact Moqui service names or REST endpoints for:
   - load product lifecycle fields
   - update lifecycle state
   - list/create/update/delete `ProductReplacement`
   - load audit history
3. **Effective date defaulting:** If user does not enter an effective date/time, does backend default to â€œimmediatelyâ€? If yes, what timestamp is applied (request time in UTC)?
4. **Past effective date rule:** Backend states â€œeffective date cannot be in the past.â€ Is â€œpastâ€ evaluated relative to server time at submit? Are near-past tolerances allowed?
5. **Replacement permissions:** Is `product:lifecycle:update` sufficient to add replacements for a discontinued product, or is a separate permission required?
6. **Replacement editing/deleting:** Are update/delete operations supported for `ProductReplacement`? If yes, what validations apply (e.g., uniqueness of priorityOrder, effectiveAt constraints)?
7. **Timezone governing rule:** Backend mentions â€œproductâ€™s governing timezone if specified.â€ Where does the frontend retrieve this governing timezone (product field? organization/site setting?), and what is the fallback?
8. **UI integration point for â€œblocked from new quotesâ€:** Which existing frontend flows must enforce â€œcannot add discontinued item unless override permissionâ€? (This story currently limits to Product Master UI; enforcement in quoting may require additional stories.)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Master: Set Product Lifecycle State (Active/Discontinued) with Effective Dates â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/119

Labels: frontend, story-implementation, user

### Story Description

/kiro
# User Story
## Narrative
As a **Product Admin**, I want lifecycle states with effective dates so that quoting avoids unsourceable items.

## Details
- States: Active, Inactive, Discontinued, Replaced.
- Optional replacement product link.

## Acceptance Criteria
- Discontinued items blocked from new quotes unless override permission.
- Replacement suggested.
- Audited.

## Integrations
- Workexec receives lifecycle status in pricing/availability responses.

## Data / Entities
- ProductLifecycle, ReplacementLink, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Product / Parts Management

### Frontend Requirements
- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack
- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #120: [FRONTEND] [STORY] Master: Manage UOM and Pack/Case Conversions â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/120
File: ./scripts/story-work/frontend/120/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Master: Manage UOM and Pack/Case Conversions

**Primary Persona:** Product Administrator (a.k.a. Product Admin)

**Business Value:** Ensures pack/case vs each quantities transact consistently across POS, Inventory stock moves, and Work Execution lines by maintaining a single authoritative set of UOM conversions with validation and auditability.

---

## 2. Story Intent

### As a / I want / So that
**As a** Product Administrator,  
**I want** to create, view, update, and deactivate Unit of Measure (UOM) conversion rules (e.g., Case â†’ Each),  
**So that** the system can correctly convert quantities between packaging units (each/pack/case) for inventory movements and operational transactions, with enforced validation and audit trails.

### In-scope
- A Master Data UI to:
  - List/query UOM conversions
  - Create a new conversion (fromUom â†’ toUom with factor)
  - Update an existing conversionâ€™s factor (with constraints)
  - Deactivate a conversion (no hard delete)
  - View audit metadata for conversions (created/updated by/at); link or panel for audit entries if available
- Frontend validation mirroring backend rules:
  - Factor must be > 0
  - Prevent duplicates for same from/to pair
  - Prevent invalid self-conversion (unless factor = 1)
- Moqui screen(s), forms, transitions, and service calls wiring for the above

### Out-of-scope
- Creating/editing UnitOfMeasure master records themselves (unless backend explicitly supports it)
- Applying conversions in sales pricing/tax calculations
- Designing inventory reservation/allocation logic (downstream consumers)
- Bulk import/export of conversions
- Defining conversion â€œper productâ€ vs â€œglobalâ€ beyond what backend supports (see Open Questions)

---

## 3. Actors & Stakeholders
- **Primary Actor:** Product Administrator
- **Stakeholders / Consumers:**
  - Inventory operations (stock moves use UOM conversions)
  - Work Execution (work order/parts lines use UOM conversions)
  - Audit/Compliance reviewer (needs change traceability)
- **System Components:**
  - Moqui backend services/entities for `UnitOfMeasure`, `UomConversion`, `AuditLog` (or equivalent)

---

## 4. Preconditions & Dependencies
- User is authenticated.
- User has permission to manage UOM conversions (permission name not provided; see Open Questions).
- Base UOMs exist (e.g., EA/PK/CS) and are queryable for selection in the UI.
- Backend endpoints/services exist to:
  - Query UnitOfMeasure list
  - Query UomConversion list
  - Create/update/deactivate UomConversion
  - Provide audit fields and/or audit log entries (contract TBD)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Master / Admin navigation entry: **Master Data â†’ Units of Measure â†’ Conversions** (exact menu path may vary; implement consistent with existing Master screens).

### Screens to create/modify
1. **Screen:** `master/UomConversionList` (new)
   - Purpose: search/list conversions; access create/edit/deactivate.
2. **Screen:** `master/UomConversionDetail` (new or embedded in list as dialog)
   - Purpose: create or edit a conversion; show audit metadata; deactivate action.
3. (Optional if conventions exist) **Component/section:** `master/AuditLogPanel` (reuse if present) to display audit entries for the selected conversion.

### Navigation context
- From Master landing â†’ conversions list
- From list row â†’ detail screen (or side panel/dialog)
- â€œCreate Conversionâ€ opens create mode

### User workflows
**Happy path (create)**
1. User opens conversions list
2. Clicks â€œCreate Conversionâ€
3. Selects From UOM, To UOM, enters conversion factor
4. Submits; sees success; new conversion appears active in list

**Happy path (update factor)**
1. User opens an existing conversion
2. Changes conversion factor
3. Submits; sees updated factor; audit metadata updated

**Happy path (deactivate)**
1. User opens an existing conversion
2. Clicks â€œDeactivateâ€
3. Confirms; conversion becomes inactive; list reflects status

**Alternate paths**
- Duplicate pair attempt rejected with inline error + toast/banner
- Invalid factor rejected (<=0, non-numeric)
- Self conversion rejected unless factor is exactly 1
- Unauthorized user sees forbidden and cannot access actions

---

## 6. Functional Behavior

### Triggers
- Entering conversions list screen triggers loading:
  - UOM options (for filters and create form)
  - UomConversion list (paged)
- Selecting a row triggers loading detail if not already present
- Submitting forms triggers create/update service call
- Clicking deactivate triggers transition/service call

### UI actions
- List controls:
  - Filter by From UOM, To UOM, Active status (Active/Inactive/All)
  - Text filter (optional) by UOM code/name (safe default)
- Row actions:
  - View/Edit
  - Deactivate (only if active)
- Create/Edit form:
  - From UOM (required select)
  - To UOM (required select)
  - Conversion factor (required decimal input)
  - Active (read-only on create default true; editable only via deactivate/activate if supportedâ€”see Open Questions)

### State changes
- Create: new `UomConversion` record created `isActive=true`
- Update: existing record updated (at minimum factor)
- Deactivate: record `isActive=false` (no deletion)

### Service interactions
- `GET` list of UnitOfMeasure for selects
- `GET` list/query of UomConversion with filters/paging
- `POST` create UomConversion
- `POST/PUT` update UomConversion (factor only)
- `POST` deactivate UomConversion (or update isActive=false)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **R-UOM-01:** `conversionFactor` must be a positive, non-zero decimal
  - UI: numeric input with min > 0; reject 0/negative; show message â€œConversion factor must be a positive number.â€
- **R-UOM-02:** unique (fromUomId, toUomId) pair
  - UI: on submit, if backend returns duplicate violation, show message â€œA conversion for this From/To pair already exists.â€
  - (Optional pre-check is not required; avoid race conditions)
- **R-UOM-03:** implicitly reversible
  - UI: No separate reverse record required; show informational hint: â€œReverse conversion is computed implicitly.â€ (informational only)
- **R-UOM-04:** no hard delete
  - UI: no â€œDeleteâ€ action; only â€œDeactivateâ€

### Enable/disable rules
- Deactivate button enabled only when conversion `isActive=true`
- Update form:
  - If backend disallows changing From/To, UI must render them read-only in edit mode (or disable selects) and only allow factor edit
- Self conversion:
  - If From == To then factor must equal 1; otherwise block submit with inline error

### Visibility rules
- Inactive conversions are either hidden by default (filter Active only) or shown with status badge (safe default: show Active only with toggle â€œShow inactiveâ€).

### Error messaging expectations
- Validation errors shown inline at field level when possible; otherwise show page-level banner with backend message.
- Forbidden shows â€œYou do not have permission to manage UOM conversions.â€

---

## 8. Data Requirements

### Entities involved
- `UnitOfMeasure` (reference data)
- `UomConversion` (managed by this UI)
- `AuditLog` (or `ItemCostAudit`-like equivalent; actual name TBD)

### Fields
**UnitOfMeasure**
- `uomId` (UUID/string): required
- `uomCode` (string): required (display)
- `uomName` (string): optional (display)

**UomConversion**
- `id` (UUID): required
- `fromUomId` (UUID): required
- `toUomId` (UUID): required
- `conversionFactor` (decimal): required; > 0
- `isActive` (boolean): required; default true
- Audit fields (if present on entity):
  - `createdAt`, `createdBy`, `updatedAt`, `updatedBy`

**AuditLog** (if exposed)
- `auditId`
- `entityName`
- `entityId`
- `action` (CREATE/UPDATE/DEACTIVATE)
- `changedBy`, `changedAt`
- `beforeJson`, `afterJson` (or field diffs)

### Read-only vs editable
- Create mode: editable `fromUomId`, `toUomId`, `conversionFactor`
- Edit mode: `conversionFactor` editable; `fromUomId/toUomId` read-only (per backend reference)
- `isActive` toggled only by deactivate action (unless backend supports re-activate; see Open Questions)

### Derived/calculated fields
- Optional derived display: â€œInverse factorâ€ = `1 / conversionFactor` for informational display only (do not persist).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not provided for Moqui services/REST paths. The frontend must integrate with whichever mechanism exists (Moqui REST, screen services, or JSON RPC). The following describes required operations and payload shapes.

### Load/view calls
1. **List UOMs**
   - Request: `GET UnitOfMeasure` (filter active if applicable)
   - Response: array of `{uomId, uomCode, uomName}`
2. **Query conversions**
   - Request params:
     - `fromUomId?`, `toUomId?`, `isActive?`, `pageIndex`, `pageSize`, `sortBy`
   - Response:
     - `data[]` conversions
     - `totalCount`

### Create/update calls
3. **Create conversion**
   - Request body: `{fromUomId, toUomId, conversionFactor}`
   - Response: created conversion including `id` and audit fields
4. **Update conversion factor**
   - Request body: `{id, conversionFactor}`
   - Response: updated conversion

### Submit/transition calls
5. **Deactivate conversion**
   - Request body: `{id}` (or `{id, isActive:false}`)
   - Response: updated conversion with `isActive=false`

### Error handling expectations
- `400` validation errors: map to field errors when keys match (e.g., `conversionFactor`)
- Duplicate constraint: surfaced as `400`/`409` (TBD); show friendly duplicate message
- `403`: show forbidden; disable actions
- Network/server error: show generic â€œUnable to save conversion. Try again.â€ with request correlation if available

---

## 10. State Model & Transitions

### Allowed states (for UomConversion)
- `Active` (`isActive=true`)
- `Inactive` (`isActive=false`)

### Role-based transitions
- Product Administrator can:
  - Create Active conversions
  - Update factor (Active and possibly Inactiveâ€”TBD; default: Active only)
  - Deactivate Active conversions
- Non-authorized users:
  - Read-only access (TBD) or no access

### UI behavior per state
- Active: editable (factor), deactivate available
- Inactive: read-only; deactivate hidden/disabled; optionally show â€œInactiveâ€ badge

---

## 11. Alternate / Error Flows

### Validation failures
- Factor <= 0 â†’ block submit; show inline error
- From/To missing â†’ required errors
- From == To and factor != 1 â†’ block submit; show message â€œWhen converting a UOM to itself, factor must be 1.â€

### Concurrency conflicts
- If backend returns optimistic lock/conflict (409):
  - UI shows â€œThis conversion was updated by another user. Reload to continue.â€
  - Provide â€œReloadâ€ action to refetch detail/list

### Unauthorized access
- If list endpoint returns 403:
  - Show forbidden state page; no data displayed
- If action endpoints return 403:
  - Show forbidden toast and keep form unchanged

### Empty states
- No conversions match filters:
  - Show â€œNo conversions foundâ€ and CTA â€œCreate Conversionâ€
- No UOMs available:
  - Block create with message â€œNo Units of Measure available. Create UOMs first.â€ (link if screen exists; otherwise informational)

---

## 12. Acceptance Criteria

### Scenario 1: List and filter UOM conversions
**Given** I am authenticated as a Product Administrator  
**When** I open the UOM Conversions list screen  
**Then** I can view a paged list of existing conversions including From UOM, To UOM, conversion factor, and Active/Inactive status  
**And** I can filter the list by From UOM, To UOM, and Active status

### Scenario 2: Create a valid conversion
**Given** I am authenticated as a Product Administrator  
**And** UnitOfMeasure â€œCSâ€ (Case) and â€œEAâ€ (Each) exist  
**When** I create a conversion from â€œCSâ€ to â€œEAâ€ with factor â€œ24â€  
**Then** the system saves the conversion successfully  
**And** the conversion appears in the list as Active  
**And** viewing the conversion shows createdBy/createdAt populated (if provided by backend)

### Scenario 3: Reject zero or negative conversion factor
**Given** I am authenticated as a Product Administrator  
**And** UnitOfMeasure â€œPKâ€ (Pack) and â€œEAâ€ (Each) exist  
**When** I attempt to create a conversion from â€œPKâ€ to â€œEAâ€ with factor â€œ0â€  
**Then** the UI prevents submission or the backend rejects the request  
**And** I see an error stating the conversion factor must be a positive number  
**And** no conversion is created

### Scenario 4: Reject duplicate From/To conversion
**Given** I am authenticated as a Product Administrator  
**And** a conversion from â€œCSâ€ to â€œEAâ€ already exists  
**When** I attempt to create another conversion from â€œCSâ€ to â€œEAâ€  
**Then** the system rejects the request  
**And** I see an error indicating that this conversion already exists

### Scenario 5: Update conversion factor
**Given** I am authenticated as a Product Administrator  
**And** a conversion from â€œCSâ€ to â€œEAâ€ exists with factor â€œ12â€  
**When** I edit the conversion and change the factor to â€œ24â€ and save  
**Then** the system saves the updated factor  
**And** the list and detail view show factor â€œ24â€  
**And** updatedBy/updatedAt are updated (if provided)

### Scenario 6: Deactivate a conversion (no delete)
**Given** I am authenticated as a Product Administrator  
**And** a conversion exists and is Active  
**When** I deactivate the conversion and confirm  
**Then** the conversion is marked Inactive  
**And** it is not removed from the system (still queryable when filtering to include inactive)  
**And** the UI does not offer a hard-delete action anywhere

### Scenario 7: Unauthorized user cannot manage conversions
**Given** I am authenticated as a user without permission to manage UOM conversions  
**When** I attempt to access the create or edit actions  
**Then** the UI blocks the action or the backend returns 403  
**And** I see a â€œnot authorizedâ€ message  
**And** no changes are persisted

---

## 13. Audit & Observability

### User-visible audit data
- Show on detail view:
  - createdAt/createdBy, updatedAt/updatedBy (if available)
- If an audit log endpoint exists:
  - Provide an â€œAudit Historyâ€ panel listing create/update/deactivate entries with timestamp + actor and before/after (or diff summary)

### Status history
- Deactivation should produce an audit event/log entry so the change is traceable.

### Traceability expectations
- All create/update/deactivate calls should include a correlation/request ID if the frontend framework supports it; display it in an error details drawer (optional).

---

## 14. Non-Functional UI Requirements
- **Performance:** list loads within 2s for up to 1,000 conversions with paging; avoid N+1 by loading UOM options once per session/page.
- **Accessibility:** all form controls labeled; validation errors announced; keyboard navigable; sufficient contrast for status badges.
- **Responsiveness:** usable on tablet widths; list may collapse columns but must keep core actions accessible.
- **i18n/timezone:** display timestamps in user locale/timezone; do not assume currency.

---

## 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE**
  - Assumed: Provide standard empty state with CTA to create conversion.
  - Why safe: UI-only ergonomics; does not affect domain logic.
  - Impacted sections: UX Summary, Alternate / Error Flows.
- **SD-UX-PAGINATION**
  - Assumed: Server-backed paging with default page size (e.g., 25) and sorting.
  - Why safe: Presentation concern; does not change business rules.
  - Impacted sections: UX Summary, Service Contracts, Non-Functional.
- **SD-ERR-MAP-VALIDATION**
  - Assumed: Map backend 400 validation responses to inline field errors when possible, else banner.
  - Why safe: Standard error-handling; does not alter policy.
  - Impacted sections: Business Rules, Service Contracts, Alternate / Error Flows.

---

## 16. Open Questions
1. **Domain ownership/labeling conflict:** The frontend story input says Domain â€œuserâ€ and â€œProduct / Parts Managementâ€, while backend story is labeled `domain:inventory`. Confirm the correct primary domain label for the frontend issue (Inventory vs Product). If Product is the owner, story must be relabeled and rewrite variant changed.
2. **Backend contract for Moqui:** What are the actual Moqui service names or REST endpoints for:
   - listing UnitOfMeasure
   - querying UomConversion
   - create/update/deactivate UomConversion
   - retrieving AuditLog entries for a conversion?
3. **Permissions:** What permission(s)/roles gate create/update/deactivate of UOM conversions? (Exact permission IDs needed for UI access control.)
4. **Scope of conversions:** Are UOM conversions **global** (UOMâ†”UOM) or **product-specific** (Product + From/To)? The provided entities suggest global, but POS usage often needs per-product pack size.
5. **Edit constraints:** Is editing `fromUomId` / `toUomId` prohibited (as backend reference implies), or allowed with additional validation?
6. **Re-activation:** Should inactive conversions be re-activated via UI, or is deactivation final?
7. **Audit UI:** Is there an existing audit log viewer component/screen convention in this frontend repo that should be reused, or should we only show created/updated metadata?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Master: Manage UOM and Pack/Case Conversions â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/120

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Master: Manage UOM and Pack/Case Conversions  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/120  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Master: Manage UOM and Pack/Case Conversions

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As a **Product Admin**, I want to define UOM conversions so that packs/cases vs each transact correctly.

## Details
- Base UOM plus alternate UOM conversions.
- Validate non-zero and reversible conversions.

## Acceptance Criteria
- UOM conversions created and queryable.
- Conversion rules enforced.
- Audited changes.

## Integrations
- Inventory uses UOM on stock moves; Workexec uses UOM on lines.

## Data / Entities
- UnitOfMeasure, UomConversion, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Product / Parts Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #121: [FRONTEND] [STORY] Master: Create Product Record (Part/Tire) with Identifiers and Attributes â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/121
File: ./scripts/story-work/frontend/121/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)
### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Master: Create & Manage Product Record (Part/Tire) with Identifiers, Attributes, Status, and Search (Moqui Screens)

## Primary Persona
Product Admin (a catalog/product master administrator working in POS backoffice)

## Business Value
Enable consistent product master creation and maintenance (SKU/MPN/UPC, manufacturer, category, UOM, description/attributes, active/inactive) so Inventory and Work Execution can reliably reference `productId`, and auditing supports traceability/compliance.

---

# 2. Story Intent

## As a / I want / So that
- **As a** Product Admin  
- **I want** to create, view, update, deactivate/reactivate, and search product master records including identifiers and attributes  
- **So that** all modules reference a consistent `productId` and product data changes are auditable.

## In-scope
- Moqui UI screens for:
  - Product list/search (SKU/MPN exact + keyword search)
  - Product create
  - Product detail view
  - Product edit (with SKU immutable post-create)
  - Product status change (ACTIVE/INACTIVE)
  - Audit/history viewing (at minimum: display audit events surfaced by backend)
- Frontend validations aligned to backend rules (required fields, immutability hints) without inventing new domain policy.
- Error handling for validation errors, conflicts, unauthorized, and not-found.

## Out-of-scope
- Implementing backend product APIs/entities/business logic (assumed provided by backend).
- Inventory costing, stock movements, reservations, valuation, or consumption workflows.
- Creating/managing manufacturers or categories (only selecting existing references).
- Work order flagging / purchase order notifications implementation details (UI may display backend-provided warnings only).
- Barcode printing, label generation, or bulk import/export.

---

# 3. Actors & Stakeholders
- **Product Admin (Primary):** Creates and maintains product records.
- **Inventory Staff (Stakeholder):** Relies on accurate product master for stock tracking.
- **Work Execution Staff (Stakeholder):** Relies on product master for job planning and parts usage.
- **Auditor/Manager (Stakeholder):** Reviews change history for traceability.
- **System (Moqui + Backend APIs):** Enforces uniqueness, immutability, permissions, and writes audit trail.

---

# 4. Preconditions & Dependencies
- User is authenticated in the frontend and can call Moqui/backend services.
- User has a permission equivalent to backend `product:manage` (exact permission string in Moqui is **unknown**; see Open Questions).
- Reference data exists and is queryable:
  - Manufacturers (`manufacturerId`, `name`)
  - Categories (`categoryId`, `name`)
  - Unit of Measure values (or free-text UOMâ€”unclear; see Open Questions)
- Backend provides endpoints/services for:
  - Product CRUD + status changes
  - Search by SKU/MPN/keyword
  - Identifier uniqueness enforcement and conflict responses
  - Audit event retrieval (or embedded audit data in product detail)

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Backoffice navigation: **Master Data â†’ Products**
- Deep links:
  - `/master/products` (list/search)
  - `/master/products/new` (create)
  - `/master/products/:productId` (view)
  - `/master/products/:productId/edit` (edit)

## Screens to create/modify (Moqui)
Create a screen tree under (example) `apps/Durion/screens/master/products/`:
- `master/products.xml` (root menu + default transition to list)
- `master/products/ProductList.xml`
- `master/products/ProductCreate.xml`
- `master/products/ProductDetail.xml`
- `master/products/ProductEdit.xml`
- Optional embedded subscreens/sections:
  - `components/ProductForm.xml`
  - `components/ProductIdentifiers.xml`
  - `components/ProductMetricsAudit.xml` (audit/history)

> Exact screen location/naming must follow repo conventions (README/agent guide). If conventions differ, adjust paths accordingly.

## Navigation context
- From Product List, selecting a row navigates to Product Detail.
- From Product Detail:
  - â€œEditâ€ navigates to Product Edit
  - â€œDeactivate/Reactivateâ€ triggers a confirm dialog then calls status change transition
  - â€œBack to listâ€ returns with prior search preserved (query params)

## User workflows
### Happy path: Create product
1. Product Admin opens Product Create screen.
2. Enters required fields + identifiers and optional attributes.
3. Submits.
4. On success: navigate to Product Detail for the new `productId` with a success banner.

### Happy path: Edit product
1. Admin opens Product Detail, chooses Edit.
2. Updates editable fields (manufacturer, mpn, description, etc.), but **SKU is read-only**.
3. Saves.
4. On success: returns to detail and shows updated values + success banner.

### Happy path: Deactivate/reactivate
1. Admin clicks â€œDeactivateâ€ (or â€œReactivateâ€).
2. Confirm modal explains impact: may affect open work orders/POs (exact messaging depends on backend response).
3. Submit status change.
4. On success: status pill updates and an audit entry appears (if audit is fetched).

### Alternate path: Search
1. Admin searches by:
   - exact SKU
   - exact MPN (+ manufacturer filter if required by backend)
   - keyword query
2. Results list shows key fields and status.
3. Click through to detail.

---

# 6. Functional Behavior

## Triggers
- Screen load of list/detail/edit/create.
- User submits create/update/status-change forms.
- User executes search.

## UI actions
### Product list/search
- Search form fields:
  - `sku` (text, optional)
  - `mpn` (text, optional)
  - `manufacturerId` (select, optional; may be required for MPN exact search if backend needs itâ€”unclear)
  - `q` keyword (text, optional)
  - `status` filter (ACTIVE/INACTIVE/ALL; default ALL or ACTIVEâ€”see Open Questions if not in backend)
- Results table columns (minimum):
  - Name
  - SKU
  - Manufacturer
  - MPN
  - Category
  - UOM
  - Status
  - UpdatedAt (if available)

### Create/edit form
Fields (see Data Requirements) with inline validation and clear required markers.
- SKU editable on create; read-only on edit.
- Status shown on detail; not directly editable in create/edit except via status action (preferred to match backend rules).

### Status change
- Confirm modal with action-specific text.
- On backend response, show any dependency flags/warnings returned (if provided) in a dismissible banner.

## State changes
- Product status transitions between `ACTIVE` and `INACTIVE` only.

## Service interactions
- List/search uses a read service.
- Detail uses a read service by `productId`.
- Create uses a create service, receives new `productId`.
- Update uses an update service.
- Status change uses a dedicated service/transition.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Required fields enforced client-side (and re-validated server-side):
  - `name`, `description`, `unitOfMeasure`, `manufacturerId`, `categoryId`, `sku`, `mpn`
- SKU:
  - Must be present on create.
  - Shown as immutable/read-only on edit with helper text: â€œSKU cannot be changed after creation.â€
- Manufacturer + MPN uniqueness:
  - UI should not attempt to pre-check uniqueness (avoid race conditions).
  - If backend returns conflict, show field-specific error message (see Error messaging expectations).

## Enable/disable rules
- â€œSaveâ€ disabled until required fields valid (basic client-side checks).
- â€œDeactivateâ€ button visible only when current status is ACTIVE.
- â€œReactivateâ€ button visible only when current status is INACTIVE.

## Visibility rules
- Audit/history panel visible if backend provides audit access and user has permission; otherwise hide panel and show â€œNot authorizedâ€ or omit.

## Error messaging expectations
- Validation (400): show inline field errors when provided; otherwise show a banner â€œPlease correct the highlighted fields.â€
- Conflict (409): show message:
  - For SKU duplicate: â€œSKU already exists.â€
  - For Manufacturer+MPN duplicate: â€œA product with this Manufacturer and MPN already exists.â€
- Unauthorized (401/403): show a blocking page/banner â€œYou do not have access to manage products.â€
- Not found (404) on detail/edit: show â€œProduct not foundâ€ with link back to list.

---

# 8. Data Requirements

## Entities involved (frontend perspective)
- `Product`
- `ProductIdentifier` (SKU, MPN, UPC)
- `ProductAttribute` (key/value attributes)
- `Manufacturer` reference
- `Category` reference
- `AuditLog` / `ItemCostAudit` is **not** applicable here; product audit is required but entity name is backend-defined (clarify).

## Fields (type, required, defaults)
### Product
- `productId` (UUID, read-only, system-generated)
- `status` (enum: `ACTIVE` | `INACTIVE`, read-only on form; default `ACTIVE` on create)
- `name` (string, required)
- `description` (string, required; may include tire size/spec text)
- `unitOfMeasure` (string, required; source list vs free text unclear)
- `manufacturerId` (UUID, required)
- `categoryId` (UUID, required)
- `createdAt` (timestamp, read-only)
- `updatedAt` (timestamp, read-only)

### ProductIdentifier
- `sku` (string, required, unique, immutable after create)
- `mpn` (string, required; uniqueness in combination with manufacturerId)
- `upc` (string, optional)

### ProductAttribute
- `attributes` (collection of key/value pairs or JSON; optional)
  - Because storage is backend-defined (JSONB/text), UI should treat as:
    - repeatable rows: `key` (string), `value` (string)
    - enforce non-empty key when row exists; values may be empty only if backend allows (unclear)

## Read-only vs editable by state/role
- By role: Product Admin can create/edit/status-change; others read-only (exact roles/permissions unclear).
- By product state:
  - ACTIVE and INACTIVE products are both viewable.
  - Editing allowed regardless of status? Backend allows status toggling; edit rules are not explicitly restricted by status (assume editable unless backend restricts; if backend blocks, surface error).

## Derived/calculated fields
- Display-only:
  - manufacturer name, category name (resolved via reference data or embedded in product response)

---

# 9. Service Contracts (Frontend Perspective)

> Backend contract is referenced from backend story but not expressed as concrete Moqui services/routes. The frontend must integrate via Moqui screens/transitions that call services; exact service names/paths are **Open Questions**.

## Load/view calls
- `ProductSearch` (GET-like)
  - Inputs: `sku?`, `mpn?`, `manufacturerId?`, `q?`, `status?`, pagination params
  - Output: list of products with summary fields
- `ProductGet` by `productId`
  - Output: product detail including identifiers and attributes

- Reference data:
  - `ManufacturerList` (id, name)
  - `CategoryList` (id, name)
  - `UomList` (if UOM is enumerated)

- Audit:
  - `ProductAuditList(productId)` returning events (created/updated/status-changed) with actor and timestamps

## Create/update calls
- `ProductCreate`
  - Inputs: product fields + identifiers + attributes
  - Output: `productId`
  - Errors: 400 validation; 409 duplicate SKU or duplicate (manufacturerId+mpn)
- `ProductUpdate`
  - Inputs: `productId` + editable fields (SKU excluded)
  - Errors: 400, 409 (if MPN uniqueness violated)

## Submit/transition calls
- `ProductStatusChange`
  - Inputs: `productId`, `status` target (`ACTIVE`/`INACTIVE`)
  - Output: updated status; optional warnings/impacted dependencies info

## Error handling expectations
- Map HTTP status or Moqui service errors to:
  - Field-level errors where possible
  - Otherwise global notification banner
- For 409, preserve entered values and highlight relevant fields.

---

# 10. State Model & Transitions

## Allowed states
- `ACTIVE`
- `INACTIVE`

## Role-based transitions
- With `product:manage` (or Moqui equivalent):
  - ACTIVE â†’ INACTIVE
  - INACTIVE â†’ ACTIVE
- Without permission:
  - No create/edit/status transitions; list/detail may still be accessible depending on permission model (unclear)

## UI behavior per state
- ACTIVE:
  - Show â€œDeactivateâ€ action
- INACTIVE:
  - Show â€œReactivateâ€ action
  - Detail header should visibly indicate inactive status (badge/pill)

---

# 11. Alternate / Error Flows

## Validation failures
- Missing required fields: prevent submit client-side; also handle backend 400 with messages.
- Invalid manufacturer/category: if backend returns 400, show error near the select field and keep selections.

## Concurrency conflicts
- If backend supports optimistic locking (e.g., version/updatedAt mismatch) and returns 409/412:
  - Show â€œThis product was updated by someone else. Reload to continue.â€
  - Provide â€œReloadâ€ action which re-fetches detail and re-opens edit with latest data (behavior depends on available version fieldâ€”Open Question).

## Unauthorized access
- On create/edit/status change attempt returning 403:
  - Show â€œNot authorizedâ€ page/banner.
  - Disable/hidden action buttons after receiving 403 (donâ€™t keep retrying).

## Empty states
- Search with no results:
  - Show â€œNo products foundâ€ and a CTA to â€œCreate productâ€ if user has permission.

---

# 12. Acceptance Criteria

## Scenario 1: Create product (success)
**Given** I am authenticated as a Product Admin with product manage permission  
**And** manufacturers and categories are available to select  
**When** I create a product with unique SKU, valid manufacturer, MPN, name, description, category, unit of measure, and optional UPC/attributes  
**Then** the system creates the product with status ACTIVE  
**And** I am navigated to the Product Detail screen for the new productId  
**And** I see a success message confirming creation.

## Scenario 2: Create product rejected due to duplicate SKU
**Given** a product already exists with SKU `ABC-1001`  
**When** I attempt to create a new product with SKU `ABC-1001`  
**Then** the create request fails with a conflict error  
**And** the UI displays â€œSKU already existsâ€ associated to the SKU field  
**And** my entered form values remain intact for correction.

## Scenario 3: Create product rejected due to duplicate Manufacturer+MPN
**Given** a product already exists with manufacturer `mfg-123` and MPN `XYZ-2002`  
**When** I attempt to create a new product with manufacturer `mfg-123` and MPN `XYZ-2002`  
**Then** the create request fails with a conflict error  
**And** the UI displays â€œA product with this Manufacturer and MPN already existsâ€ associated to the MPN/manufacturer inputs.

## Scenario 4: Edit product (SKU immutable)
**Given** I am viewing an existing product as a Product Admin  
**When** I open the edit screen  
**Then** SKU is displayed as read-only  
**And** I can edit manufacturer, MPN, description, category, UOM, name, UPC, and attributes (subject to backend rules)  
**When** I save valid edits  
**Then** I return to the detail screen and see the updated values.

## Scenario 5: Deactivate product (success)
**Given** a product is ACTIVE  
**And** I have permission to manage products  
**When** I confirm deactivation  
**Then** the product status becomes INACTIVE in the UI  
**And** I see confirmation of the status change  
**And** if the backend returns impacted dependency warnings, they are displayed to the user.

## Scenario 6: Reactivate product (success)
**Given** a product is INACTIVE  
**When** I reactivate it  
**Then** the product status becomes ACTIVE  
**And** the UI updates available actions accordingly.

## Scenario 7: Search products by SKU/MPN/keyword
**Given** multiple products exist with varying SKUs, MPNs, names, categories, attributes, and descriptions  
**When** I search by exact SKU or exact MPN  
**Then** matching products are returned  
**When** I search by keyword  
**Then** products matching in name, description, category name, or attributes are returned  
**And** results indicate each productâ€™s ACTIVE/INACTIVE status.

## Scenario 8: Unauthorized management attempt
**Given** I am authenticated without product manage permission  
**When** I attempt to access Product Create or submit an update/status change  
**Then** the system denies the action  
**And** the UI shows a not-authorized message and prevents further submission.

---

# 13. Audit & Observability

## User-visible audit data
- On Product Detail, show an â€œAudit/Historyâ€ section (if available) listing:
  - event type: PRODUCT_CREATED / PRODUCT_UPDATED / PRODUCT_STATUS_CHANGED
  - timestamp
  - actor (user id/name if provided)
  - for updates: before/after field changes (when backend provides)

## Status history
- At minimum, show status change events in audit list.

## Traceability expectations
- Frontend should include correlation/request IDs if supported by Moqui/client (log context) when calling services.
- Do not log sensitive data; log productId and error codes/messages for troubleshooting (client-side logging policy depends on repo conventions).

---

# 14. Non-Functional UI Requirements

- **Performance:** Product list/search should render first page quickly; support pagination to avoid loading unbounded results.
- **Accessibility:** Forms must have labels, required indicators, keyboard navigation, and accessible error messages.
- **Responsiveness:** Screens usable on tablet-sized widths; tables allow horizontal scroll or responsive column behavior.
- **i18n/timezone/currency:** Display timestamps in user locale/timezone if the app supports it; no currency behavior required.

---

# 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a â€œNo resultsâ€ empty state with guidance and optional â€œCreate productâ€ CTA; qualifies as safe because it does not change domain behavior, only UX. Impacted sections: UX Summary, Alternate / Error Flows.
- SD-UX-PAGINATION: Paginate search results with conservative default page size; qualifies as safe because it is a UI ergonomics pattern and does not affect business rules. Impacted sections: UX Summary, Service Contracts, Non-Functional UI Requirements.
- SD-ERR-STANDARD-MAPPING: Map 400/401/403/404/409 to inline errors + banners; qualifies as safe because it is standard error handling implied by backend contract. Impacted sections: Business Rules, Alternate / Error Flows, Acceptance Criteria.

---

# 16. Open Questions

1. **Domain label mismatch:** The frontend issue describes Product/Parts Management, but available canonical domains in this prompt do not include `domain:product`. Should this story truly be labeled `domain:inventory`, or is there a missing `domain:product` label family that must be used?
2. **Moqui service naming/paths:** What are the exact Moqui service names (or REST endpoints proxied through Moqui) for product search/get/create/update/status-change and audit retrieval?
3. **Permission model in Moqui:** What is the exact permission string/role required in the frontend to show create/edit/status actions (backend mentions `product:manage`)? Is read-only access allowed for non-admins?
4. **UOM source:** Is `unitOfMeasure` free text, a controlled vocabulary (entity list), or a reference to a UOM entity? If controlled, what are valid values and how are they fetched?
5. **Attributes format:** Are product attributes stored as JSON, as discrete rows (key/value entity), or both? What constraints exist (allowed keys, max lengths, duplicates)?
6. **Search contract:** For â€œexact MPNâ€ search, does backend require manufacturerId to disambiguate, or does it search MPN globally? What are supported query params and precedence rules if multiple are provided?
7. **Optimistic locking:** Does the backend provide a version field (or ETag/updatedAt check) to detect concurrent edits? If yes, what is the expected request field and error code?
8. **Deactivation dependency feedback:** When deactivating with open work orders/POs, does backend return a structured list of impacted items, or only performs side effects (flag/notify) without returning details? What should the UI display?

---

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Master: Create Product Record (Part/Tire) with Identifiers and Attributes â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/121

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Master: Create Product Record (Part/Tire) with Identifiers and Attributes  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/121  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Master: Create Product Record (Part/Tire) with Identifiers and Attributes

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As a **Product Admin**, I want to create a product with SKU/MPN, manufacturer, type, and attributes so that all modules reference a consistent product master.

## Details  
- Identifiers: internal SKU, manufacturer part number, optional UPC.  
- Attributes: description, category, tire size/spec, UOM, active/inactive.

## Acceptance Criteria  
- Create/update/deactivate product.  
- Search by SKU/MPN/keywords.  
- Changes audited.

## Integrations  
- Inventory and Workexec reference productId consistently.

## Data / Entities  
- Product, ProductIdentifier, ProductAttribute, ManufacturerRef, AuditLog

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Product / Parts Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #241: [FRONTEND] [STORY] Counts: Plan Cycle Counts by Location/Zone â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/241
File: ./scripts/story-work/frontend/241/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Counts: Plan Cycle Counts by Location/Zone

### Primary Persona
Inventory Manager

### Business Value
Enable Inventory Managers to schedule targeted cycle count plans by storage location and zone to improve inventory accuracy and operational planning.

---

## 2. Story Intent

### As a / I want / So that
**As an** Inventory Manager,  
**I want** to create a Cycle Count Plan by selecting a Location and one or more Zones and a future scheduled date,  
**so that** warehouse staff can execute planned counts and the organization can maintain accurate stock records.

### In-scope
- UI flow to create a new Cycle Count Plan:
  - Select **Location**
  - Select **one or more Zones** belonging to the selected Location
  - Choose **scheduled date** (must not be in the past)
  - Optional **plan name/description**
- Frontend validation + backend validation error display
- Successful creation confirmation and navigation to view/list
- Read-only visibility of plan â€œcreatedâ€ metadata after submit (as returned by API)

### Out-of-scope
- Executing the count (starting plan, entering count results, adjustments)
- Editing plan scope after creation (location/zones) unless explicitly supported by backend
- Recurring plans
- Defining how SKUs are selected for inclusion (scope logic) beyond displaying what backend returns
- Location/Zone administration (creating zones/locations)

---

## 3. Actors & Stakeholders
- **Inventory Manager (primary):** creates scheduled cycle count plans.
- **Warehouse Staff (downstream):** will execute counts generated from plans (not in scope).
- **Auditor / Ops Manager (stakeholder):** expects traceable history of created plans (display only, if available).
- **System (Moqui app):** enforces permissions, validation, and persists plan via services/APIs.

---

## 4. Preconditions & Dependencies
- User is authenticated.
- User has permission to create cycle count plans (permission string is currently unclear; backend reference uses `INVENTORY_PLAN_CREATE`).
- At least one Location exists.
- Selected Location has one or more Zones (or UI must handle empty zones).
- Backend endpoints/services exist for:
  - Listing Locations
  - Listing Zones for a Location
  - Creating a Cycle Count Plan
- Backend returns structured validation errors for:
  - Past scheduled date
  - Missing location
  - Missing zones
  - Unauthorized

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Left-nav or menu entry: **Inventory â†’ Counts â†’ Cycle Counts**
- Primary CTA on list screen: **â€œNew Cycle Count Planâ€**

### Screens to create/modify (Moqui)
1. **Screen:** `apps/pos/inventory/counts/PlanList.xml` (or equivalent module path)
   - Shows list of existing plans (at minimum: plan name, location, scheduled date, status)
   - CTA navigates to create screen
2. **Screen:** `apps/pos/inventory/counts/PlanCreate.xml`
   - Form to create plan
   - Loads locations on entry
   - Loads zones dynamically after location selection
3. **Screen (optional but recommended):** `apps/pos/inventory/counts/PlanDetail.xml`
   - After create, navigate to detail view for created planId (if backend supports fetch-by-id)

> Exact file paths depend on repo conventions (must align with `durion-moqui-frontend` screen structure).

### Navigation context
- Breadcrumb example: Inventory > Counts > Cycle Count Plans > New Plan
- Back action returns to Plan List preserving filters (safe default)

### User workflows
**Happy path**
1. User opens Cycle Count Plans list
2. Clicks â€œNew Cycle Count Planâ€
3. Selects Location
4. Selects one or more Zones
5. Sets scheduled date to today or future (see Open Questions re: â€œtodayâ€)
6. Optionally enters plan name/description
7. Submits
8. Sees success message and is redirected to Plan Detail (or Plan List with new plan highlighted)

**Alternate paths**
- Location selected but has no zones â†’ show empty state + disable submit
- Scheduled date in past â†’ inline validation; on submit show backend error mapping if returned
- Backend 403 â†’ show â€œNot authorizedâ€ and disable form submission thereafter

---

## 6. Functional Behavior

### Triggers
- User visits Plan Create screen
- User selects a Location
- User submits create form

### UI actions
- **On screen load**: fetch Locations
- **On location change**:
  - Clear any previously selected zones
  - Fetch Zones for chosen location
- **On submit**:
  - Validate required fields client-side
  - Call create service
  - On success: show toast/notification and navigate
  - On failure: show field-level errors (if provided) else show page-level error

### State changes (frontend)
- Form state: `idle â†’ loadingLocations â†’ ready â†’ loadingZones â†’ ready â†’ submitting â†’ success|error`
- Disable submit while `submitting`
- Disable zone multi-select until zones loaded

### Service interactions (Moqui)
- Use Moqui `transition` invoking a `service-call` (or `rest-call` if backend is external) for:
  - `listLocations`
  - `listZonesByLocation`
  - `createCycleCountPlan`
- Ensure transitions capture and render errors in the screen messages area consistent with Moqui patterns.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- **Location is required**
  - If missing: block submit; show message â€œLocation is required.â€
- **At least one Zone is required**
  - If none selected: block submit; show message â€œSelect at least one zone.â€
- **Scheduled date cannot be in the past**
  - Client-side: if date < today (timezone rules are an Open Question), show inline error and block submit
  - Server-side: display returned error message verbatim if present (e.g., â€œScheduled date must be in the future.â€)
- **Plan name/description optional**
  - If present, enforce max length (Open Question: backend limit). Until clarified, do not enforce a max beyond UI component reasonable limit; rely on backend and show returned validation error.

### Enable/disable rules
- Zone selector disabled until a Location is selected and zones are loaded.
- Submit disabled until all required fields valid and zones loaded.

### Visibility rules
- If user lacks create permission (403 on load or submit):
  - Show non-editable â€œYou do not have permission to create cycle count plans.â€
  - Hide/disable submit button.

### Error messaging expectations
- Field-level errors displayed adjacent to corresponding field when backend identifies a field (needs backend error schema; otherwise show general error at top).
- 404 for invalid location/zone (stale selection) shown as: â€œThe specified location or zone could not be found.â€

---

## 8. Data Requirements

### Entities involved (conceptual; frontend-facing)
- `CycleCountPlan`
- `Location`
- `Zone` (scoped to Location)

### Fields (type, required, defaults)
**CycleCountPlan (create payload)**
- `locationId` (string/UUID, required)
- `zoneIds` (array of string/UUID, required, min 1)
- `scheduledDate` (date string, required; format per APIâ€”Open Question)
- `planName` (string, optional) OR `description` (string, optional) â€” naming mismatch must be clarified

**CycleCountPlan (response/display)**
- `planId` (string/UUID)
- `status` (string enum; at least `PLANNED`)
- `createdBy` (string/userId; display if returned)
- `createdAt` (timestamp; display if returned)
- `updatedAt` (timestamp; display if returned)

**Location**
- `locationId` (string/UUID)
- `locationName` (string)

**Zone**
- `zoneId` (string/UUID)
- `zoneName` (string)

### Read-only vs editable by state/role
- On Create screen: all inputs editable
- After creation:
  - If Plan is `PLANNED`: details are read-only in this story (no edit requirements provided)
  - Once `IN_PROGRESS`: scope immutable (informational only unless edit exists)

### Derived/calculated fields
- None calculated in frontend.
- If backend returns â€œitem count included in planâ€, display as read-only metadata (only if available; otherwise omit).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not provided in the frontend issue; below is a **frontend-perspective contract** that must be aligned with backend before implementation.

### Load/view calls
1. **List Locations**
   - Method: GET
   - Path (proposed): `/v1/inventory/locations`
   - Response: `[{ locationId, locationName }]`
   - Errors: 401/403
2. **List Zones by Location**
   - Method: GET
   - Path (proposed): `/v1/inventory/locations/{locationId}/zones`
   - Response: `[{ zoneId, zoneName }]`
   - Errors: 404 (location), 401/403

### Create/update calls
3. **Create Cycle Count Plan**
   - Method: POST
   - Path (proposed): `/v1/inventory/cycle-count-plans`
   - Request:
     ```json
     {
       "locationId": "uuid",
       "zoneIds": ["uuid"],
       "scheduledDate": "YYYY-MM-DD",
       "planName": "string (optional)"
     }
     ```
   - Success: 201 with body including `planId`, `status`, and echo fields
   - Errors:
     - 400 validation (missing zoneIds, past date, etc.)
     - 404 invalid location/zone
     - 403 unauthorized

### Submit/transition calls (Moqui)
- `transition name="createPlan"` calls the create service and on success transitions to detail/list.

### Error handling expectations
- Validation errors map to form fields when possible.
- Unknown errors show a generic message: â€œCould not create cycle count plan. Try again or contact support.â€ plus correlation/trace id if available from response headers (Open Question: do we have one?).

---

## 10. State Model & Transitions

### Allowed states (minimum known)
- `PLANNED`
- `IN_PROGRESS`
- `COMPLETED`
- `CANCELLED`

### Role-based transitions
- Create action allowed only for users with create permission (string TBD).
- No other transitions are implemented in this story.

### UI behavior per state
- Create screen always creates a plan in `PLANNED` (as per backend reference).
- List/Detail screens show status as read-only label.
- If backend returns a special status for â€œno itemsâ€ (e.g., `PLANNED_NO_ITEMS`), UI must display it without special logic (status rendering is tolerant of unknown enums).

---

## 11. Alternate / Error Flows

### Validation failures
- Missing required fields: prevent submit client-side.
- Past scheduled date:
  - If caught client-side: show inline error
  - If server rejects: display server message and keep user inputs intact

### Concurrency conflicts
- If zones list changes after selection and submit returns 404:
  - Show error and prompt user to re-select location/zones; keep scheduled date and plan name

### Unauthorized access
- If any call returns 403:
  - Show â€œNot authorizedâ€
  - Disable create CTA and/or form submit
  - Provide navigation back to list

### Empty states
- No locations: show empty state â€œNo locations available. Contact an administrator.â€ and disable form.
- Location has zero zones: show â€œNo zones configured for this location.â€ and disable submit.
- Plan created but includes no items (if backend indicates): show non-blocking warning on success page/list (requires backend signalâ€”Open Question).

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create plan successfully
**Given** I am logged in as an Inventory Manager with permission to create cycle count plans  
**And** at least one Location exists with at least one Zone  
**When** I navigate to Inventory > Counts > Cycle Count Plans and choose â€œNew Cycle Count Planâ€  
**And** I select a Location  
**And** I select one or more Zones for that Location  
**And** I set a scheduled date that is not in the past  
**And** I submit the form  
**Then** the system creates the Cycle Count Plan successfully  
**And** I see a success confirmation  
**And** I am navigated to the created planâ€™s detail view or the plans list where the new plan is visible.

### Scenario 2: Prevent submit when no zones selected
**Given** I am on the New Cycle Count Plan screen  
**When** I select a Location  
**And** I do not select any Zones  
**Then** the Submit action is disabled or blocked  
**And** I see a validation message indicating at least one zone is required.

### Scenario 3: Reject scheduled date in the past (client-side)
**Given** I am on the New Cycle Count Plan screen  
**When** I enter a scheduled date that is in the past  
**Then** I see an inline validation error  
**And** I cannot submit the plan until the date is corrected.

### Scenario 4: Handle backend validation error for past date
**Given** I am on the New Cycle Count Plan screen  
**And** I submit the form with a scheduled date the backend deems invalid  
**When** the backend responds with HTTP 400 and message â€œScheduled date must be in the future.â€  
**Then** the UI displays the backend error message  
**And** the form remains populated for correction.

### Scenario 5: Handle stale location/zone selection
**Given** I selected a Location and Zone that later becomes invalid  
**When** I submit the plan and the backend responds with HTTP 404  
**Then** I see an error message â€œThe specified location or zone could not be found.â€  
**And** I can reselect Location/Zones and resubmit.

### Scenario 6: Unauthorized user cannot create plan
**Given** I am logged in without permission to create cycle count plans  
**When** I navigate to the New Cycle Count Plan screen or attempt to submit  
**Then** I receive a â€œNot authorizedâ€ message  
**And** the create/submit controls are disabled or hidden.

---

## 13. Audit & Observability

### User-visible audit data
- After creation, display (when returned by API): `createdBy`, `createdAt`, `status`.
- If not available, omit without placeholder fields.

### Status history
- Not required to implement unless an endpoint exists; no requirements provided.

### Traceability expectations
- Frontend should log (client-side) a structured event on submit attempt and result:
  - `cycleCountPlanCreate.attempt`, `cycleCountPlanCreate.success`, `cycleCountPlanCreate.failure`
  - Include `locationId`, count of `zoneIds`, and returned `planId` on success
  - Do not log sensitive user info.

---

## 14. Non-Functional UI Requirements
- **Performance:** Locations and zones lists should load within 2 seconds on typical network; show loading indicators.
- **Accessibility:** WCAG 2.1 AA; all form controls labeled; validation errors announced to screen readers.
- **Responsiveness:** Usable on tablet form factor typical for warehouse/POS operations.
- **i18n/timezone:** Date handling must respect user/site timezone (exact rule is an Open Question); display dates in local format, send in API-required format.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty states for â€œno locationsâ€ and â€œno zonesâ€; qualifies as safe because it does not change domain behavior, only improves UX clarity. (Impacted: UX Summary, Alternate/Errors)
- SD-UX-LOADING-STATES: Show loading indicators and disable dependent controls while fetching; safe as it only affects ergonomics. (Impacted: Functional Behavior, Alternate/Errors)
- SD-ERR-GENERIC: For unexpected 5xx/network errors, show a generic retry message while preserving form inputs; safe because it doesnâ€™t alter business logic. (Impacted: Error Flows, Service Contracts)

---

## 16. Open Questions
1. **API contracts:** What are the exact backend endpoints (paths), request/response schemas, and error format for:
   - list locations
   - list zones by location
   - create cycle count plan?
2. **Permission name(s):** What permission(s) gate plan creation in this app? Backend reference mentions `INVENTORY_PLAN_CREATE`; inventory domain guide uses permission-style strings like `inventory.*`. Which is authoritative for frontend checks/messages?
3. **Field naming:** Is the optional free-text field `planName`, `description`, or both? What are max lengths and allowed characters?
4. **Scheduled date rule:** Is â€œtodayâ€ allowed, or must it be strictly future? Backend text says â€œcannot be in the pastâ€ but error message says â€œmust be in the future.â€ Confirm exact validation.
5. **Timezone definition:** Is â€œpastâ€ evaluated in user timezone, site/location timezone, or UTC?
6. **Empty zones/items behavior:** If selected zones contain no inventory items:
   - Should creation be allowed?
   - Should UI show a warning on success?
   - Is there a distinct status like `PLANNED_NO_ITEMS`?
7. **Post-create navigation:** Should we navigate to a Plan Detail screen (requires GET by `planId`) or back to list only?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Counts: Plan Cycle Counts by Location/Zone â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/241


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Counts: Plan Cycle Counts by Location/Zone
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/241
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #238 - Counts: Plan Cycle Counts by Location/Zone
**URL**: https://github.com/louisburroughs/durion/issues/238
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns


### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:36:25.984782271*

---

*End of preserved original content.*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #242: [FRONTEND] [STORY] Fulfillment: Return Unused Items to Stock with Reason â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/242
File: ./scripts/story-work/frontend/242/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

**Title:** [FRONTEND] [STORY] Fulfillment: Return Unused Items to Stock with Reason

**Primary Persona:** Warehouse Manager (primary); Service Advisor (secondary)

**Business Value:** Enables returning unused, saleable items from completed/closed work orders back into inventory with a mandatory reason per item, improving inventory accuracy and traceability for operations and downstream accounting.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Warehouse Manager or Service Advisor,  
- **I want to** return unused items from a completed/closed work order back into stock while providing a reason for each returned item,  
- **So that** inventory on-hand is accurate, returned items are available for future work, and returns are auditable with standardized reason codes.

### In-scope
- A Moqui/Vue/Quasar UI flow to:
  - Select a completed/closed work order eligible for returns
  - Display items consumed by that work order and the max-returnable quantities
  - Enter return quantities (<= consumed and > 0) for one or more items
  - Select a **mandatory** return reason per returned line
  - Submit a single atomic â€œreturn to stockâ€ transaction
  - Display a success confirmation including a return transaction identifier
- Frontend validation and server error handling consistent with backend rules
- Read-only visibility of key audit fields for the created return record (as returned by API)

### Out-of-scope
- Financial reconciliation / accounting adjustments beyond emitting/consuming the return result (Accounting consumes emitted event; frontend does not implement accounting)
- Defining or managing reason codes (assumed preconfigured)
- Changing work order state or consumed quantities from this screen
- Any costing/valuation calculations (Inventory domain remains authoritative; frontend only displays returned values)

---

## 3. Actors & Stakeholders
- **Warehouse Manager (Actor):** Processes return-to-stock transactions.
- **Service Advisor (Actor):** May process returns for their work orders.
- **Inventory System (System):** Validates eligibility, enforces rules, posts ledger entries, updates on-hand.
- **Accounting (Stakeholder):** Depends on accurate inventory and emitted events (not directly interacted with by UI).

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in the frontend.
- User has permission to create returns (backend permission example given: `inventory:return:create`; final permission string must match backend).
- Target work order exists and is in **Completed** or **Closed** state.
- Work order has at least one **consumed** item line eligible for return (may be zero; UI must handle empty state).
- Backend provides a non-empty list of valid return reason codes.

### Dependencies (Blocking where unclear)
- Backend API contract for:
  - Loading work order consumed items and max-returnable quantities
  - Listing return reason codes
  - Submitting return transaction and receiving `inventoryReturnId` (or equivalent)
- Routing/location context to determine **which stock location** receives returned items (see Open Questions)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a Work Order detail view (Completed/Closed): action button/link **â€œReturn Items to Stockâ€**
- Optional: from an Inventory/Fulfillment menu: â€œReturnsâ€ â†’ â€œReturn from Work Orderâ€ (only if consistent with existing navigation; otherwise keep to Work Order detail entry point)

### Screens to create/modify (Moqui)
1. **Modify Work Order Detail screen** to include the entry action when eligible:
   - Show action only when work order state âˆˆ {Completed, Closed} and user has permission.
2. **New screen:** `apps/pos/screen/workorder/ReturnItems.xml` (name indicative; final path must match repo conventions)
   - Parameters: `workOrderId` required
   - Loads:
     - work order header (id, state)
     - consumed items list with consumed qty and returnable qty
     - reason codes list
   - Form/table to select return quantities + reasons per line
   - Submit transition to a service call (REST or Moqui service faÃ§ade)

### Navigation context
- Breadcrumb/back navigation returns to Work Order detail.
- On successful submission, navigate to:
  - Either a â€œReturn Confirmationâ€ subview, **or**
  - Back to Work Order detail with a visible confirmation banner including return transaction id.
  (Final decision depends on repo pattern; see Open Questions if unclear.)

### User workflows
**Happy path**
1. User opens a completed/closed work order.
2. Clicks â€œReturn Items to Stockâ€.
3. Sees a list of consumed items with maximum returnable quantity.
4. Enters return quantity for one or more items and selects a reason per selected item.
5. Confirms submission.
6. Sees success message with return transaction id.

**Alternate paths**
- Work order has no consumed items â†’ empty state; no submit allowed.
- User tries to return > allowed â†’ inline validation errors.
- User omits a reason for a returned line â†’ inline validation errors.
- Backend rejects due to state change or permissions â†’ show message and disable submit.

---

## 6. Functional Behavior

### Triggers
- User clicks â€œReturn Items to Stockâ€ action from a work order.
- Screen load triggers data fetch for work order eligibility, consumed items, and reason codes.
- Submit triggers a single backend â€œreturn to stockâ€ request.

### UI actions
- Per line item:
  - Quantity input (integer, min 0; only >0 lines are considered â€œselectedâ€ unless UI includes explicit checkbox)
  - Reason dropdown (required when quantity > 0)
- Submit button:
  - Disabled until at least one line has quantity > 0 and all such lines have reasons selected
- Cancel button:
  - Returns to prior screen without changes

### State changes (frontend)
- Local form state:
  - `returnLines[]` derived from consumed items
  - `dirty` tracking for unsaved changes prompt (optional safe default; see Applied Safe Defaults)
- Post-submit:
  - Clear form state and show confirmation
  - Refresh work order view data if returning to detail (to reflect updated availability/return history if shown)

### Service interactions (frontend perspective)
- `GET` load: work order + consumed items (+ optionally existing returns summary)
- `GET` load: reason codes
- `POST` submit: create return transaction with lines
- Handle backend validation errors and map to line-level messages where possible

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Work order state must be **Completed** or **Closed**:
  - If not, UI must not allow starting the flow (hide entry action).
  - If state changes between entry and submit, backend will reject; UI shows error and guides user back.
- Return quantity rules per line:
  - Must be an integer
  - Must be **> 0** to be included in submission
  - Must be **<= maxReturnableQty** (typically consumed minus previously returned; depends on backend)
- Return reason rules:
  - **Mandatory** for every line with quantity > 0
  - Selected from a predefined list of reason codes (no free-text unless backend supports; not assumed)

### Enable/disable rules
- Submit disabled until:
  - At least one line has quantity > 0
  - All selected lines have a reason
  - No validation errors present
  - Not currently submitting
- Quantity input disabled for lines with `maxReturnableQty = 0`
- Entire form read-only if user lacks permission (or block access with 403 handling)

### Visibility rules
- Show â€œmax returnableâ€ and â€œconsumed qtyâ€ read-only per item.
- Show a banner if there are no eligible items.
- Show an error banner for authorization failure and hide form.

### Error messaging expectations
- Inline per-line errors for:
  - quantity exceeds max returnable
  - missing reason
- Page-level errors for:
  - work order not eligible
  - network/server failure
  - unauthorized (403)
- Messages should be actionable, e.g.:
  - â€œReturn quantity cannot exceed the returnable quantity (X).â€
  - â€œSelect a return reason.â€
  - â€œReturns can only be processed for completed or closed work orders.â€

---

## 8. Data Requirements

### Entities involved (conceptual; frontend consumes via API)
- WorkOrder (external/domain-owned; referenced)
- Consumed work order items (work order fulfillment/parts consumption records)
- InventoryReturn (created by backend)
- InventoryLedger entries (backend side-effect; UI does not create directly)
- ReturnReasonCode (lookup list)

### Fields (type, required, defaults)

**Screen input model (frontend)**
- `workOrderId` (string/uuid, required; route param)
- `locationId` (string/uuid, required?) â€” **unclear** how chosen; see Open Questions
- `returnLines[]`:
  - `sku` (string, required, read-only)
  - `productId` (string/uuid, optional read-only if provided)
  - `description` (string, optional read-only)
  - `consumedQty` (integer, read-only)
  - `maxReturnableQty` (integer, read-only)
  - `quantityReturned` (integer, editable; default 0)
  - `returnReasonCode` (string/enum, editable; required when quantityReturned > 0)

**Response fields to display on success**
- `inventoryReturnId` (string/uuid, required)
- `processedAt` (timestamp UTC, required)
- `processedByUserId` (string/uuid, optional display if provided)
- returned line summary (sku, qty, reason)

### Read-only vs editable by state/role
- Editable only if:
  - work order eligible
  - user has permission
- Always read-only:
  - consumedQty, maxReturnableQty, sku/description
- Post-submission: form becomes read-only or navigates away

### Derived/calculated fields (frontend)
- `selectedLines = returnLines.filter(l => l.quantityReturned > 0)`
- client-side validation flags based on `maxReturnableQty`
- Submit payload derived from `selectedLines`

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is referenced from backend story #177 but exact endpoints are TBD. Frontend must be implemented to align with actual backend routes once confirmed.

### Load/view calls
1. **Load work order & returnable lines**
   - Proposed: `GET /v1/workorders/{workOrderId}/returnable-items`
   - Response shape (minimum needed):
     - workOrder: `{ workOrderId, status }`
     - location context (optional): `{ defaultReturnLocationId, locationName }`
     - items: `[ { sku, description, consumedQty, maxReturnableQty } ]`

2. **Load return reason codes**
   - Proposed: `GET /v1/inventory/return-reasons`
   - Response: `[ { code, label, active } ]` (active filtered server-side preferred)

### Create/update calls
- None (no draft saving assumed)

### Submit/transition calls
1. **Submit return transaction**
   - Proposed: `POST /v1/inventory/returns`
   - Request:
     ```json
     {
       "workOrderId": "uuid",
       "locationId": "uuid",
       "items": [
         { "sku": "SKU-123", "quantityReturned": 2, "returnReasonCode": "NOT_NEEDED" }
       ]
     }
     ```
   - Response (success 201/200):
     ```json
     {
       "inventoryReturnId": "uuid",
       "workOrderId": "uuid",
       "locationId": "uuid",
       "processedAt": "timestamp_utc",
       "processedByUserId": "uuid",
       "items": [
         { "sku": "SKU-123", "quantityReturned": 2, "returnReasonCode": "NOT_NEEDED" }
       ]
     }
     ```

### Error handling expectations
- `400` Validation errors:
  - Map field errors to line items if error payload identifies `sku` or line index.
- `403` Forbidden:
  - Show â€œYou do not have permission to return items to stock.â€
- `404` Not found:
  - Work order not found â†’ show not found state and link back.
- `409` Conflict:
  - Work order state changed or concurrency issue â†’ show conflict message and offer reload.
- `5xx`:
  - Show generic failure and allow retry; ensure idempotency guidance from backend (unknown; see Open Questions).

---

## 10. State Model & Transitions

### Allowed states (work order eligibility)
- Eligible: `Completed`, `Closed`
- Ineligible: any other state (e.g., Open/In Progress/Cancelled/etc.)

### Role-based transitions
- Not changing work order state.
- Return submission allowed only for roles with permission `inventory:return:create` (exact permission string TBD).

### UI behavior per state
- Work order state eligible:
  - Show entry point action
  - Allow form interaction
- Work order state ineligible:
  - Hide action; if user navigates directly to URL, show blocked message and no submit
- After successful return:
  - Show success confirmation; prevent duplicate submit via disabled button and request in-flight lock

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Quantity > maxReturnableQty:
  - Inline error on quantity field; submit disabled
- Missing reason when qty > 0:
  - Inline error on reason field; submit disabled
- No items selected (all qty 0):
  - Submit disabled; helper text â€œEnter a quantity to return.â€

### Concurrency conflicts
- Work order transitions out of Completed/Closed after screen load:
  - Backend returns 409/400; UI shows banner â€œWork order is no longer eligible for returns. Reload to view current status.â€
- Returnable quantities changed (another return processed elsewhere):
  - Backend rejects with validation; UI shows errors and offers â€œReload returnable quantitiesâ€.

### Unauthorized access
- 403 on load or submit:
  - Show access denied state; hide form; provide navigation back

### Empty states
- No consumed/returnable items:
  - Show message â€œNo consumed items are eligible to return to stock.â€
  - Hide/disable submit

---

## 12. Acceptance Criteria

### Scenario 1: Successful return of unused items with reason
**Given** a work order in `Completed` state with a consumed line for `SKU-123` with `maxReturnableQty = 5`  
**And** the user has permission to create inventory returns  
**And** the return reason codes list includes `NOT_NEEDED`  
**When** the user opens â€œReturn Items to Stockâ€ for that work order  
**And** enters `quantityReturned = 2` for `SKU-123`  
**And** selects return reason `NOT_NEEDED` for `SKU-123`  
**And** submits the return  
**Then** the frontend sends a single return submission request containing `workOrderId`, `locationId`, and the selected line with quantity and reason  
**And** the UI displays a success confirmation containing `inventoryReturnId`  
**And** the submit control is disabled while the request is in flight to prevent duplicate submission.

### Scenario 2: Attempt to return more than allowed (client-side)
**Given** a work order returnable line for `SKU-123` with `maxReturnableQty = 5`  
**When** the user enters `quantityReturned = 6`  
**Then** the UI shows an inline validation error indicating the quantity exceeds the returnable amount  
**And** the submit action is disabled.

### Scenario 3: Attempt to submit without a reason
**Given** a work order returnable line for `SKU-123` with `maxReturnableQty = 5`  
**When** the user enters `quantityReturned = 1` for `SKU-123`  
**And** does not select a return reason  
**Then** the UI shows an inline validation error for missing reason  
**And** the submit action is disabled  
**Or** if submit is attempted, the UI blocks submission and focuses the missing reason field.

### Scenario 4: Work order not eligible (state changed)
**Given** the user opens the return screen for a work order that is `Completed`  
**When** the work order becomes not `Completed` or `Closed` before submission  
**And** the user submits a return  
**Then** the backend responds with an error indicating the work order is not eligible  
**And** the UI displays a non-field error â€œReturns can only be processed for completed or closed work orders.â€  
**And** the UI offers a reload/back action.

### Scenario 5: Unauthorized user
**Given** the user lacks permission to create inventory returns  
**When** the user navigates to the return screen URL  
**Then** the UI shows an access denied state  
**And** does not display an editable return form.

---

## 13. Audit & Observability

### User-visible audit data
- On success, show:
  - `inventoryReturnId`
  - `processedAt` (displayed in user locale, sourced from UTC)
  - Summary of returned items (sku, qty, reason)
- Optional (if backend provides): processed by user display name

### Status history / traceability expectations
- The return transaction must be traceable by `inventoryReturnId` for support.
- Frontend should include correlation/request id in logs if provided by API responses/headers (do not invent if not available).

---

## 14. Non-Functional UI Requirements
- **Performance:** Initial load should avoid N+1 calls; at most 2 calls (returnable items + reason codes). Cache reason codes in-session if consistent with app patterns.
- **Accessibility:** WCAG 2.1 AA; form fields have labels; errors are announced (aria-live) and associated with inputs.
- **Responsiveness:** Works on tablet widths typical for warehouse/parts counter.
- **i18n/timezone:** Display `processedAt` using user timezone; reason labels display from backend-provided label. Currency not applicable.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty state when no returnable items are available; qualifies as safe UI ergonomics. Impacted sections: UX Summary, Error Flows.
- SD-UX-INFLIGHT-GUARD: Disable submit button and show loading indicator during submit to prevent accidental double submission; safe because it does not change domain rules. Impacted sections: Functional Behavior, Acceptance Criteria.
- SD-ERR-STD-MAP: Map HTTP 400/403/404/409/5xx to standard inline/page error presentation; safe because it follows backend semantics without inventing policy. Impacted sections: Service Contracts, Alternate/Error Flows.

---

## 16. Open Questions

1. **Return location selection:** How is `locationId` determined for the return-to-stock transaction?
   - Always the work orderâ€™s site default stock location?
   - User-selectable location (dropdown) limited by site/permissions?
2. **API contract finalization:** What are the exact backend endpoints, request/response shapes, and error payload formats for:
   - fetching returnable/consumed items
   - fetching reason codes
   - submitting a return
3. **Max returnable calculation source:** Does the backend return `maxReturnableQty` already accounting for prior returns, or must the frontend compute it?
4. **Reason code model:** Are reason codes global, site-specific, or role-specific? Do they have `active` flags and display labels provided by backend?
5. **Idempotency/double-submit:** Does the backend provide an idempotency key mechanism for `POST /inventory/returns`? If yes, what header/field should frontend send?
6. **Navigation pattern:** After success, should the UI:
   - navigate back to work order detail with banner, or
   - show a dedicated confirmation/details page for the created `InventoryReturn`?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Fulfillment: Return Unused Items to Stock with Reason â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/242

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Fulfillment: Return Unused Items to Stock with Reason  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/242  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #237 - Fulfillment: Return Unused Items to Stock with Reason  
**URL**: https://github.com/louisburroughs/durion/issues/237  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:36:28.875577242*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #243: [FRONTEND] [STORY] Fulfillment: Issue/Consume Picked Items to Workorder â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/243
File: ./scripts/story-work/frontend/243/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

**Title:** Fulfillment: Issue/Consume Picked Items to Workorder (Frontend, Moqui)

**Primary Persona:** Parts Manager / Technician (POS user issuing parts to a workorder)

**Business Value:** Ensure picked parts are formally consumed against a workorder so on-hand inventory is decremented, inventory ledger is updated, and downstream job costing/accounting is accurate and auditable.

---

## 2. Story Intent

**As a** Parts Manager or Technician  
**I want** to review picked items for a workorder and submit a â€œConsume/Issueâ€ action for specified quantities  
**So that** inventory is decremented and the workorder is accurately charged with consumed parts.

### In-scope
- Moqui UI flow to:
  - load a workorderâ€™s picked items
  - enter/confirm consumption quantities (up to picked quantity)
  - submit consumption to backend
  - show success/failure outcomes and updated state
- Frontend validation aligned to backend rules (no over-consumption, only picked items, etc.)
- Basic audit visibility in UI (who/when consumed; at minimum confirmation + timestamp returned)

### Out-of-scope
- Picking/staging parts for a workorder (assumed already done elsewhere)
- Returning consumed items to stock (handled by separate â€œReturn to Stockâ€ flow/story)
- Editing inventory costs (standard/last/average) and cost policy decisions
- Implementing backend inventory ledger/event emission (frontend only calls services)

---

## 3. Actors & Stakeholders
- **Primary users:** Parts Manager, Technician
- **Secondary users:** Service Advisor (visibility), Inventory Manager (accuracy), Accounting (downstream consumption/cost attribution)
- **Systems:** Inventory service (authoritative consumption), Workorder service (workorder state/identity)

---

## 4. Preconditions & Dependencies

### Preconditions
- Workorder exists and is in a backend-allowed state for consumption (exact states TBD; backend example suggests â€œIn Progressâ€ allowed, â€œCompleted/On Hold/Cancelledâ€ not allowed).
- One or more items have been â€œPickedâ€ for the workorder (backend concept: picked items associated to workorder).
- User is authenticated and has permission to consume inventory for a workorder (exact permission string TBD).

### Dependencies
- Backend endpoint to load â€œpicked items for workorderâ€ (contract TBD).
- Backend endpoint to consume picked items: backend reference proposes `POST /v1/inventory/consume`.
- Consistent identifiers:
  - `workorderId`
  - `pickedItemId` (or equivalent line id)
  - `sku` (if required)
- Error response format (field-level vs general errors) to map into Moqui forms.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Workorder detail screen: action button/link â€œConsume Picked Itemsâ€
- Optional: from Fulfillment/Picking module menu, search/select workorder then â€œConsumeâ€

### Screens to create/modify
1. **Modify**: `WorkorderDetail` screen  
   - Add action: `Consume Picked Items` visible when workorder state allows consumption AND picked items exist (visibility depends on load API; if unknown, show and handle backend denial gracefully).
2. **Create**: `WorkorderConsumePickedItems` screen (new)
   - Shows list of picked items with:
     - SKU / description (if available)
     - picked quantity
     - already consumed quantity (if available)
     - remaining consumable quantity (derived if available)
     - input: quantity to consume now (default behavior defined below)
   - Submit action â€œConsumeâ€
   - Cancel/back to workorder

### Navigation context
- Route pattern (proposed): `/workorders/:workorderId/fulfillment/consume-picked`
- Breadcrumb: Workorders â†’ Workorder #{id} â†’ Fulfillment â†’ Consume Picked Items

### User workflows
**Happy path**
1. User opens workorder â†’ Consume Picked Items
2. Screen loads picked items
3. User confirms quantities (often â€œconsume all remainingâ€)
4. User submits
5. UI shows success confirmation + returns to workorder detail (or stays and reloads list showing updated quantities/states)

**Alternate paths**
- Consume partial quantities for some lines, leave others as 0
- Backend rejects due to invalid workorder state or stale picked quantities â†’ UI shows error and reload option

---

## 6. Functional Behavior

### Triggers
- Entering `WorkorderConsumePickedItems` screen triggers load of workorder header (optional) + picked items list.
- Clicking `Consume` triggers consumption submit.

### UI actions
- Per picked line:
  - numeric input `qtyToConsume`
  - convenience action â€œMaxâ€ sets to remaining picked qty (if remaining known; else sets to picked qty)
- Global:
  - â€œConsumeâ€ submits only lines with `qtyToConsume > 0`
  - â€œConsume Allâ€ (optional) sets all lines to max and submits (if included, must be explicitly implemented)

### State changes (frontend-visible)
- After successful submit:
  - show confirmation summary: number of lines consumed, total quantity
  - refresh picked list to reflect new statuses/remaining quantities
  - optionally navigate back to workorder detail

### Service interactions
- Load picked items for workorder (read)
- Submit consumption (write)
- On submit success: reload picked items (read) to ensure UI consistency

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `qtyToConsume` must be:
  - numeric
  - > 0 to be included in request
  - integer vs decimal **(Open Question; inventory quantities might be fractional depending on UOM)**
- Must not exceed picked quantity (or remaining consumable quantity if provided)
- Must not allow consuming lines not in â€œPickedâ€ status (if status exposed in UI)

### Enable/disable rules
- Disable â€œConsumeâ€ button when:
  - no lines with `qtyToConsume > 0`
  - any line has validation error
  - submit in progress (prevent double-submit)
- Disable quantity input for lines not eligible (e.g., already consumed/cancelled) if status provided.

### Visibility rules
- Show the screen only when user can access workorder; otherwise show unauthorized.
- If backend indicates workorder state disallows consumption, show read-only message and hide submit.

### Error messaging expectations
- Map backend errors:
  - `400` validation errors: highlight offending line(s) when possible; otherwise show banner with message
  - `403` forbidden: show â€œYou donâ€™t have permission to consume inventory.â€
  - `404` not found: â€œWorkorder not foundâ€ or â€œPicked item not foundâ€
  - `409` conflict: show â€œWorkorder is not in a state that allows consumptionâ€ OR â€œPicked quantities changed; please reloadâ€

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- Workorder (read-only identity/state)
- PickedItem (picked line associated to workorder)
- Consumption submission payload (not necessarily persisted in frontend)
- Optional: consumption result / ledger summary (read-only response)

### Fields (type, required, defaults)
**Workorder (read)**
- `workorderId` (string, required)
- `status` (string, required for gating if provided)

**PickedItem (read)**
- `pickedItemId` (string, required)
- `sku` (string, required if backend needs it for submit; otherwise display-only)
- `productName/description` (string, optional)
- `qtyPicked` (number, required)
- `qtyConsumed` (number, optional)
- `status` (enum/string, optional but useful: Picked/Consumed/etc.)
- `uom` (string, optional; impacts validation)

**UI Input (editable)**
- `qtyToConsume` (number, default: 0; see Applied Safe Defaults)

**Derived/calculated fields (frontend)**
- `qtyRemaining = qtyPicked - qtyConsumed` (only if `qtyConsumed` available; else not derived)
- `lineEligible = (status == Picked)` if status available

### Read-only vs editable by state/role
- Workorder fields read-only
- Picked item identity fields read-only
- Quantity input editable only when:
  - user has permission (if permission surfaced; otherwise backend enforces)
  - workorder is in allowed state (if known)
  - line eligible (if status known)

---

## 9. Service Contracts (Frontend Perspective)

> Backend contracts are not fully authoritative in provided inputs; below are **proposed** contracts derived from backend reference and must be confirmed.

### Load/view calls
1. **Get picked items for workorder**
   - Proposed: `GET /v1/workorders/{workorderId}/picked-items`
   - Response: array of PickedItem with fields listed above
   - Errors: 403/404

2. **(Optional) Get workorder header**
   - Proposed: `GET /v1/workorders/{workorderId}`
   - Used to display status and guard actions

### Create/update calls
- none (frontend only submits consumption)

### Submit/transition calls
1. **Consume picked items**
   - Proposed: `POST /v1/inventory/consume`
   - Request body (from backend reference):
     ```json
     {
       "workorderId": "wo-12345",
       "items": [
         { "pickedItemId": "pick-abc-789", "sku": "SKU-OILFILTER-A", "quantity": 1 }
       ]
     }
     ```
   - Frontend rules:
     - include only items with `quantity > 0`
     - send `pickedItemId` always; include `sku` only if required by backend (Open Question)
   - Success:
     - `200 OK` with summary payload (Open Question: response schema)
   - Errors:
     - `400` validation details
     - `403` forbidden
     - `409` conflict (invalid state / concurrency)

### Error handling expectations
- Moqui screen actions should:
  - capture HTTP status + message
  - bind field errors to form/list rows when backend provides item-level error identifiers (Open Question)
  - show a retry/reload option on 409 conflict

---

## 10. State Model & Transitions

### Allowed states (relevant to this screen)
**Workorder states**
- Allowed: at least `In Progress` (from backend reference)
- Disallowed: `Completed`, `On Hold`, `Cancelled` (from backend reference)
- **Exact enumeration and mapping is unknown (Open Question).**

**Picked item states**
- `Picked` â†’ `Consumed` on successful consume
- Consumption is immutable; reversal requires separate â€œReturnâ€ transaction (out-of-scope)

### Role-based transitions
- Users with appropriate inventory fulfillment permission can submit consumption.
- Others can view but cannot submit (or receive 403 on submit).
- **Exact permission name(s) for frontend gating unknown (Open Question).**

### UI behavior per state
- If workorder disallowed: show message + disable submit.
- If line not Picked: disable its input and do not submit it.
- If all lines ineligible: show empty/none-eligible state.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- Quantity entered > picked/remaining:
  - show inline error on that line
  - disable submit until corrected
- Quantity <= 0:
  - treated as â€œnot selectedâ€; no error unless user typed negative (then show error)

### Concurrency conflicts
- Picked quantities changed since load:
  - backend returns 409 or 400 with detail
  - UI shows conflict message and offers â€œReload picked itemsâ€
  - after reload, preserve user-entered quantities where still valid; otherwise reset to 0 (needs confirmation; Open Question)

### Unauthorized access
- User opens screen:
  - if load endpoints return 403: show â€œNot authorizedâ€ and link back
- User submits and gets 403:
  - show error; keep inputs but disable further submit until reload/login

### Empty states
- No picked items:
  - show â€œNo picked items available to consume for this workorder.â€
  - provide navigation back to workorder

---

## 12. Acceptance Criteria

### Scenario 1: Load consume screen with picked items
**Given** I am an authenticated user with access to workorder `WO-123`  
**And** `WO-123` has 2 picked items associated to it  
**When** I navigate to `/workorders/WO-123/fulfillment/consume-picked`  
**Then** the system displays the picked items list including picked quantity for each line  
**And** each line has an input to enter a consume quantity  
**And** the Consume action is disabled until at least one line has a quantity > 0

### Scenario 2: Successfully consume all picked quantities
**Given** workorder `WO-123` is in an allowed state for consumption  
**And** item line `PICK-1` has `qtyPicked = 2` and is eligible to consume  
**When** I enter `qtyToConsume = 2` for `PICK-1` and click â€œConsumeâ€  
**Then** the frontend submits a consumption request containing `workorderId = WO-123` and `pickedItemId = PICK-1` with quantity 2  
**And** I see a success confirmation  
**And** the picked items list is reloaded after success

### Scenario 3: Prevent consuming more than picked (client-side)
**Given** item line `PICK-1` shows `qtyPicked = 1`  
**When** I enter `qtyToConsume = 2`  
**Then** the line shows a validation error indicating the quantity exceeds picked quantity  
**And** the Consume action remains disabled

### Scenario 4: Backend rejects because workorder is not consumable (409)
**Given** workorder `WO-999` is `Completed` (or another disallowed state)  
**When** I attempt to consume any picked item quantities and click â€œConsumeâ€  
**Then** the backend responds with HTTP `409`  
**And** the frontend displays an error message that the workorder is not in a valid state for consumption  
**And** no success confirmation is shown  
**And** the user can click â€œReloadâ€ to refresh workorder/items

### Scenario 5: Backend rejects due to item not associated/picked (400)
**Given** I am on the consume screen for `WO-123`  
**When** the backend responds `400 Bad Request` indicating a submitted line is not picked for `WO-123`  
**Then** the frontend displays the error message returned by the backend  
**And** the user remains on the consume screen with inputs preserved

### Scenario 6: Unauthorized submit (403)
**Given** I can view the workorder but do not have permission to consume inventory  
**When** I click â€œConsumeâ€  
**Then** the backend responds with `403 Forbidden`  
**And** the frontend shows a permission error message  
**And** no inventory consumption success state is shown

---

## 13. Audit & Observability

### User-visible audit data
- On success, show:
  - confirmation timestamp (client time) and optionally server timestamp if returned
  - number of lines/total quantity consumed
- If backend returns consumption transaction id(s), display them (Open Question).

### Status history
- Not required to render full ledger, but screen should reflect post-consumption status via reload.

### Traceability expectations
- Frontend must include correlation/request id headers if project convention exists (Open Question; otherwise rely on standard HTTP tracing).
- Log (frontend console/logging facility) submit attempts and outcomes without leaking sensitive data.

---

## 14. Non-Functional UI Requirements
- **Performance:** initial load < 2s for up to 50 picked lines (pagination if larger; see safe defaults)
- **Accessibility:** WCAG 2.1 AA; keyboard-navigable table/list and inputs; error messages announced to screen readers
- **Responsiveness:** usable on tablet resolutions common in shop floors
- **i18n/timezone/currency:** quantities only; timestamps shown in user locale/timezone if displayed

---

## 15. Applied Safe Defaults
- **SD-UX-EMPTY-STATE**
  - **Assumed:** Explicit empty state messaging when no picked items exist.
  - **Why safe:** Pure UI ergonomics; does not change business rules.
  - **Impacted sections:** UX Summary, Alternate/Empty states.
- **SD-UX-PAGINATION-DEFAULT**
  - **Assumed:** Paginate picked items list at 50 rows/page if backend returns more.
  - **Why safe:** UI scalability only; does not affect domain logic.
  - **Impacted sections:** Non-Functional UI Requirements, UX Summary.
- **SD-ERR-HTTP-MAP**
  - **Assumed:** Map HTTP 400/403/404/409 to user-facing banner + inline field errors when identifiable.
  - **Why safe:** Standard error handling; aligns with backend status semantics without inventing policy.
  - **Impacted sections:** Business Rules (errors), Service Contracts, Alternate/Error flows.

---

## 16. Open Questions

1. What is the **authoritative frontend route/screen naming convention** in `durion-moqui-frontend` for workorder subflows (exact URL path, screen location, menu integration)?
2. What backend endpoint should the frontend use to **load picked items for a workorder** (path + response schema)? Is it owned by inventory service or workorder service?
3. For the consume submit call, is `sku` required in addition to `pickedItemId`, or is `pickedItemId` sufficient?
4. Are consumption quantities **integer-only** or can they be fractional (UOM-driven)? If fractional, what precision and step rules apply?
5. What are the exact **workorder statuses** that allow consumption, and what are their canonical string values?
6. What permission/role governs consumption (e.g., `inventory.consume`, `inventory.fulfillment.consume`)? Should the frontend gate the action based on permissions endpoint/claims, or rely solely on backend enforcement?
7. What is the expected **success response payload** from `POST /v1/inventory/consume` (transaction ids, updated lines, messages)? Should the UI show a receipt-like summary?
8. Concurrency handling: if reloading after a conflict, should the UI attempt to **preserve user-entered quantities** that remain valid, or reset all to 0?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Fulfillment: Issue/Consume Picked Items to Workorder â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/243

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Fulfillment: Issue/Consume Picked Items to Workorder  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/243  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #236 - Fulfillment: Issue/Consume Picked Items to Workorder  
**URL**: https://github.com/louisburroughs/durion/issues/236  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:36:31.497882803*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #244: [FRONTEND] [STORY] Fulfillment: Mechanic Executes Picking (Scan + Confirm)  
File: ./scripts/story-work/frontend/244/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Fulfillment: Mechanic Executes Picking (Scan + Confirm)

### Primary Persona
Mechanic / Technician (shop-floor user fulfilling parts for a work order)

### Business Value
Reduce picking errors and improve fulfillment traceability by enabling mechanics to scan items/locations, confirm picked quantities, and record an auditable pick confirmation tied to a work order.

---

## 2. Story Intent

### Narrative (As a / I want / So that)
- **As a** Mechanic
- **I want** to pick required parts for a work order by scanning and confirming items
- **So that** the system records an accurate, auditable â€œpickedâ€ confirmation and downstream steps (consumption/installation) can proceed with correct inventory state.

### In-Scope
- Moqui UI flow to:
  - Load a work orderâ€™s pick list (or equivalent fulfillment task)
  - Guide picking via scan inputs
  - Confirm quantities per line
  - Submit â€œpick confirmationâ€ to backend
- Client-side validation and error handling for common scan/quantity issues
- Display of pick status per line and overall task status as returned by backend

### Out-of-Scope
- Reservation/allocation logic, substitution rules, backorders (must be defined elsewhere)
- Inventory consumption (decrement) and costing
- Creating/maintaining work orders, parts lists, or storage locations
- Permissions model definition (only enforcement based on backend responses)

---

## 3. Actors & Stakeholders

### Actors
- **Mechanic (Primary):** performs scan + confirm.
- **Inventory Manager (Secondary):** cares about accuracy/audit but not primary UI user here.
- **System:** validates scans, updates pick state, emits any events.

### Stakeholders
- **Work Execution domain** (work order lifecycle; dependency for task/line states)
- **Inventory domain** (item identity, quantities, location associations if applicable)
- **Audit/Security domains** (audit trails; authorization)

---

## 4. Preconditions & Dependencies

### Preconditions
- User is authenticated in POS frontend.
- A work order exists with parts to pick (a â€œpick listâ€ or â€œfulfillment taskâ€ exists).
- Backend supports:
  - Fetching pick task / pick lines for a work order
  - Validating scan inputs (barcode/SKU/bin) and returning matched line(s)
  - Submitting pick confirmation with idempotency/optimistic locking

### Dependencies
- **Backend API contract is not provided in the inputs.** This story cannot be fully buildable without confirming:
  - endpoints, payloads, identifiers, and state model (see Open Questions)
- Scanner input method (keyboard wedge vs device integration) must align with existing frontend patterns in the repo.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Work Order detail screen: action/button **â€œPick Partsâ€** opens picking execution screen for that work order.
- Optional: from a Fulfillment/Picking queue list (if exists) -> open specific task.

### Screens to create/modify (Moqui)
1. **Modify** existing Work Order detail screen to add navigation to picking:
   - `screen: WorkOrderDetail` (name TBD by repo conventions)
   - Add transition to `PickExecute` with parameter `workOrderId` (or `pickTaskId`)
2. **Create** new picking execution screen:
   - `screen: Fulfillment/PickExecute.xml` (path/name TBD)
   - Contains:
     - Header: work order reference + status
     - Scan input form
     - Pick lines grid/list with per-line confirm controls
     - Submit/Complete action

### Navigation context
- Breadcrumb: Work Orders â†’ Work Order {id} â†’ Pick Parts
- Back action returns to Work Order detail, preserving state if possible.

### User workflows
#### Happy path
1. Mechanic opens â€œPick Partsâ€
2. UI loads pick lines (required part, qty required, qty already picked, pick location if provided)
3. Mechanic scans an item barcode (and optionally location/bin barcode)
4. UI matches scan to a pick line (single match) and focuses that line
5. Mechanic confirms quantity picked (default 1 or remaining qty; see Open Questions)
6. UI submits confirmation (per-line or batch) and refreshes line status
7. Mechanic completes picking task when all required quantities are picked

#### Alternate paths
- Scan matches multiple lines â†’ UI prompts user to select the intended line
- Scan doesnâ€™t match any line â†’ show error and allow retry/manual search
- Partial pick allowed â†’ user can save progress without completing (must confirm)
- Over-pick attempt â†’ block with validation error
- Network/API error â†’ show retry, keep unsent changes locally in-memory

---

## 6. Functional Behavior

### Triggers
- Enter picking screen with `workOrderId` (or `pickTaskId`) in URL parameters.
- Scan submitted (Enter key or â€œProcess Scanâ€ action).
- Quantity confirmation action (per line).
- Complete/submit action (batch).

### UI actions
- **On load:**
  - Call load service to retrieve pick task and lines
  - Render list with statuses
- **On scan:**
  - Capture scan string
  - Call backend â€œresolve scanâ€ (or attempt client-side match if backend provides normalized codes list; prefer backend)
  - If match: select line; prefill qty to pick; optionally auto-confirm if configured (not assumed)
- **On confirm qty:**
  - Validate qty is > 0 and <= remaining required (unless partial rules differ)
  - Submit pick confirmation for the line
  - Update UI with returned line state (picked qty, status, version)
- **On complete:**
  - Validate all required lines satisfied (unless partial completion allowed)
  - Submit â€œcomplete pickingâ€ transition
  - Navigate back to Work Order detail with success message

### State changes (frontend-observable)
- Pick line: `remainingQty` decreases; `pickedQty` increases; status changes (e.g., OPEN â†’ PICKED/PARTIAL)
- Pick task: status changes (e.g., IN_PROGRESS â†’ COMPLETED)

### Service interactions (Moqui)
- Use `transition` actions wired to backend REST via Moqui services (or direct HTTP if thatâ€™s the repo pattern).
- Each mutating action must pass correlation/request id (observability) if supported.

---

## 7. Business Rules (Translated to UI Behavior)

> Many fulfillment rules are domain-policy and not provided. Only enforce what is explicit; otherwise defer to backend and surface errors.

### Validation
- Scan input is required and trimmed.
- Quantity input:
  - Must be numeric
  - Must be > 0
  - Must not exceed remaining required quantity **unless backend explicitly supports over-pick/backorder/substitution** (unknown â†’ block over-pick by default? **Not allowed as safe default**; see Open Questions)

### Enable/disable rules
- Confirm actions disabled when:
  - Line is already fully picked (backend indicates)
  - Task is completed/cancelled (backend indicates)
- Complete action disabled when:
  - Task not in completable state
  - Outstanding required qty remains (unless partial completion allowed)

### Visibility rules
- If backend provides â€œexpected pick locationâ€ show it as read-only reference.
- Show â€œalready pickedâ€ qty if any.

### Error messaging expectations
- Display backend validation error messages verbatim when safe (no sensitive data).
- Use consistent error banner/toast pattern used in repo.
- For scan mismatch: â€œScan not recognized for this pick listâ€ (exact text TBD).

---

## 8. Data Requirements

> Entities are described conceptually; exact Moqui entities depend on backend contract.

### Entities involved (conceptual)
- `WorkOrder` (reference only)
- `PickTask` / `FulfillmentTask`
- `PickLine`
- `Product` / `InventoryItem` reference
- `StorageLocation` reference (optional)

### Fields (type, required, defaults)
#### Screen parameters
- `workOrderId` (string/UUID, required) **OR** `pickTaskId` (string/UUID, required) â€” must choose one.

#### PickTask (read-only)
- `pickTaskId` (id, required)
- `workOrderId` (id, required)
- `status` (enum/string, required)
- `version` (number/string, required for optimistic locking if used)

#### PickLine (read-only + editable qty input)
- `pickLineId` (id, required)
- `productId` (id, required)
- `productDisplayName` (string, required)
- `requiredQty` (decimal, required)
- `pickedQty` (decimal, required; default 0)
- `uom` (string, required)
- `suggestedLocationId` (id, optional)
- `suggestedLocationLabel` (string, optional)
- `lineStatus` (enum/string, required)
- `version` (required if optimistic locking)

#### User inputs
- `scanValue` (string, required)
- `confirmQty` (decimal, required at confirm time)

### Read-only vs editable by state/role
- Mechanic can edit/enter `confirmQty` only when task/line is open/in-progress.
- All identifiers/status fields are read-only.

### Derived/calculated fields (frontend)
- `remainingQty = requiredQty - pickedQty` (display only; source-of-truth backend)
- `isComplete = remainingQty <= 0` (display only)

---

## 9. Service Contracts (Frontend Perspective)

> **Blocking**: no backend endpoints are defined in provided inputs. Below are *placeholders* that must be aligned with actual backend.

### Load/view calls
- `GET /api/v1/workorders/{workOrderId}/pick-task` â†’ returns pick task + lines
  - or `GET /api/v1/pick-tasks/{pickTaskId}`

### Create/update calls
- None (no creation in UI; task exists already)

### Submit/transition calls
1. Resolve scan:
   - `POST /api/v1/pick-tasks/{pickTaskId}:resolve-scan`
   - Request: `{ scanValue: string }`
   - Response: either matched `pickLineId` or list of candidates + normalized info
2. Confirm pick line:
   - `POST /api/v1/pick-tasks/{pickTaskId}/lines/{pickLineId}:confirm-pick`
   - Request: `{ qty: decimal, scanValue?: string, version?: ... }`
   - Response: updated line + task summary
3. Complete pick task:
   - `POST /api/v1/pick-tasks/{pickTaskId}:complete`
   - Request: `{ version?: ... }`
   - Response: updated task status

### Error handling expectations
- `400/422` validation errors: show field-level error where possible + banner summary.
- `401`: redirect to login per app standard.
- `403`: show â€œNot authorized to pickâ€ and disable actions.
- `404`: show not found empty state with back link.
- `409` conflict (optimistic locking): prompt user to refresh; discard local staged values after user confirms refresh.

---

## 10. State Model & Transitions

> **Blocking**: actual states are not specified. Define UI to be driven by backend statuses.

### Allowed states (expected)
- Pick task: `OPEN`, `IN_PROGRESS`, `COMPLETED`, `CANCELLED` (names TBD)
- Pick line: `OPEN`, `PARTIAL`, `PICKED` (names TBD)

### Role-based transitions
- Mechanic can:
  - move task to `IN_PROGRESS` implicitly on first confirm (if backend does)
  - confirm picks on lines
  - complete task
- If backend restricts completion to certain roles, UI must honor `403`.

### UI behavior per state
- `COMPLETED/CANCELLED`: all inputs disabled; show summary only.
- `OPEN/IN_PROGRESS`: scan input enabled; lines actionable depending on remaining qty.

---

## 11. Alternate / Error Flows

### Validation failures
- Qty invalid â†’ inline error on qty field; no API call.
- Scan empty â†’ inline error on scan input.

### Concurrency conflicts
- Backend returns 409/version mismatch after confirm:
  - UI shows dialog: â€œThis pick list changed. Refresh to continue.â€
  - On refresh: reload task/lines; clear current scan value; retain no unsubmitted qty edits.

### Unauthorized access
- 403 on load: show access denied state; no line data rendered.

### Empty states
- No pick lines: show â€œNo parts to pick for this work orderâ€ with back link.
- All lines complete but task not completed: show prompt to â€œComplete Pickingâ€ if allowed.

---

## 12. Acceptance Criteria

### Scenario 1: Load pick list for a work order
Given I am an authenticated Mechanic  
And a work order with an associated pick task exists  
When I navigate to â€œPick Partsâ€ for that work order  
Then the system loads and displays the pick task header (work order reference and status)  
And the system displays all pick lines with required quantity and picked quantity  
And actions are enabled/disabled based on the task status returned by the backend

### Scenario 2: Scan matches a single pick line and confirm quantity
Given I am on the picking screen for a pick task in an actionable state  
And a pick line exists for product â€œP1â€ with remaining quantity > 0  
When I scan a barcode that the backend resolves to that pick line  
And I confirm a quantity less than or equal to the remaining quantity  
Then the UI submits the confirm request for that line  
And the UI updates the lineâ€™s picked quantity and remaining quantity based on the response  
And the UI shows a success confirmation state for that line

### Scenario 3: Scan does not match any pick line
Given I am on the picking screen  
When I scan a value that does not resolve to any pick line in the task  
Then the UI displays an error message indicating the scan is not recognized for this pick list  
And no quantities are changed  
And I can retry scanning

### Scenario 4: Attempt to confirm invalid quantity
Given I am on the picking screen with a selected pick line  
When I enter a non-numeric quantity or a quantity <= 0  
Then the UI shows a field-level validation error  
And the confirm action does not call the backend

### Scenario 5: Backend rejects confirm due to business rule (e.g., over-pick)
Given I am on the picking screen  
When I attempt to confirm a quantity that the backend rejects  
Then the UI displays the backend validation error message  
And the line quantities remain unchanged in the UI after refresh/reload

### Scenario 6: Complete picking successfully
Given I am on the picking screen  
And the backend indicates the pick task is completable  
When I click â€œComplete Pickingâ€  
Then the UI calls the complete endpoint  
And the UI reflects the task status as completed  
And the UI disables further scan/confirm actions

### Scenario 7: Concurrency conflict on confirm
Given I am on the picking screen  
And the pick line has been modified by another user/session  
When I submit a confirm request and the backend returns a 409 conflict  
Then the UI prompts me to refresh  
And after refresh the UI shows the latest task/line quantities from the backend

---

## 13. Audit & Observability

### User-visible audit data
- Display (read-only) â€œLast updatedâ€ timestamp for the pick task if provided.
- Optionally show â€œConfirmed byâ€ per line if backend returns it (not assumed).

### Status history
- If backend provides status history, show a collapsible â€œHistoryâ€ section (read-only). Otherwise out of scope.

### Traceability expectations
- All confirm/complete calls include:
  - `pickTaskId`, `pickLineId` (as applicable)
  - correlationId/requestId header if standard in repo
- UI logs (frontend console) must not include sensitive tokens; only IDs and error codes.

---

## 14. Non-Functional UI Requirements

- **Performance:** initial load renders first meaningful content within 2s on typical shop network; avoid N+1 calls (single load call for lines).
- **Accessibility:** WCAG 2.1 AA; scan input and confirm controls keyboard-navigable; error messages announced to screen readers.
- **Responsiveness:** usable on tablet and narrow handheld widths; list view supports scrolling.
- **i18n:** all user-facing strings in i18n keys (per repo conventions).
- **Timezone:** display timestamps in site/user locale per existing app behavior (no new rules invented).

---

## 15. Applied Safe Defaults
- none

---

## 16. Open Questions

1. **Backend contract:** What are the exact backend endpoints and payloads for:
   - loading pick task/lines
   - resolving a scan
   - confirming a pick line
   - completing the pick task  
   (Provide URL paths, request/response JSON, error schema, and idempotency/locking mechanism.)

2. **Identifier to route by:** Should the frontend route use `workOrderId` or `pickTaskId` as the primary parameter?

3. **Scan semantics:** What can be scanned?
   - product barcode only, or also storage location/bin barcode, or both?
   - if both are allowed, what is the expected sequence and matching behavior?

4. **Multi-match handling:** If a scan matches multiple pick lines (same SKU appears multiple times), what is the correct disambiguation key (location, lot, work step)?

5. **Quantity rules:** Are partial picks allowed? Is completion allowed with remaining quantities? Are over-picks ever allowed (with approval), or must UI hard-block before calling backend?

6. **Serial/lot control:** Are items serialized or lot-controlled in this workflow? If yes, what additional capture is required at pick time?

7. **Permissions:** What permission(s) gate picking actions (view pick list, confirm picks, complete task), and how are they surfaced (roles/claims)? If unknown, should UI rely solely on 403?

8. **Task/line state model:** What are the canonical statuses for pick tasks and pick lines, and what transitions are allowed?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Fulfillment: Mechanic Executes Picking (Scan + Confirm)  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/244  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #235 - Fulfillment: Mechanic Executes Picking (Scan + Confirm)  
**URL**: https://github.com/louisburroughs/durion/issues/235  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---  
*Generated by Missing Issues Audit System - 2025-12-26T17:36:39.200600573*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #260: [FRONTEND] [STORY] Cost: Store Supplier/Vendor Cost Tiers (Optional) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/260
File: ./scripts/story-work/frontend/260/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Cost: Store Supplier/Vendor Cost Tiers (Optional)

### Primary Persona
Inventory Manager (or Purchasing Admin responsible for supplier purchasing costs)

### Business Value
Enables the organization to store supplier-specific volume price breaks for inventory items so purchasing and downstream cost calculations can select an accurate unit cost based on ordered quantity, improving procurement decisions and cost accuracy.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Inventory Manager  
- **I want to** create, view, update, and delete optional supplier/vendor cost tiers for a specific inventory item  
- **So that** purchasing workflows can use quantity-based unit costs (price breaks) when building purchase orders and reporting.

### In-scope
- Frontend screens and forms to manage a supplier-item cost record and its tier rows (min/max quantity + unit cost).
- Client-side validation that matches backend rules where determinable (contiguous non-overlapping tiers, min qty rules, positive cost).
- Integration wiring to backend endpoints (GET/POST/PUT/DELETE or Moqui service calls) and error mapping.
- Audit visibility: show basic â€œwho/whenâ€ metadata if available from API.

### Out-of-scope
- Purchase Order creation and selecting tier cost during PO line pricing (consumer behavior).
- Defining suppliers/vendors or inventory items (assumed existing).
- Cost valuation methods (WAC, etc.) beyond storing tiered purchase costs.
- Import/bulk upload of tiers.

---

## 3. Actors & Stakeholders
- **Inventory Manager (Primary)**: maintains supplier/item purchasing costs and tiers.
- **Purchasing Users/System (Consumer)**: uses the stored tier data when creating POs (future/other story).
- **Accounting/Reporting (Downstream)**: benefits from more accurate purchase cost inputs.
- **System Admin/Security**: ensures only authorized users can edit purchasing cost data.

---

## 4. Preconditions & Dependencies
- User is authenticated.
- User has permission to manage supplier-item costs (permission name **TBD**; backend story mentions â€œpermissions to manage supplier and inventory cost dataâ€ but does not specify exact permission).
- Supplier/Vendor exists.
- Inventory Item (SKU) exists.
- Backend provides APIs/services for:
  - retrieving supplier-item cost + tiers
  - creating/updating/deleting supplier-item cost + tiers
- Supplier has an assigned currency (tiers must share currency determined by supplier config).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an **Inventory Item detail** screen: action â€œSupplier Costsâ€ (or â€œVendor Costsâ€).
- From a **Supplier detail** screen: action â€œItem Costsâ€ (optional secondary entry point).

### Screens to create/modify
1. **Modify** (or create) Inventory Item detail screen to include navigation to supplier costs.
2. **New Screen**: `InventoryItemSupplierCostList` (list supplier cost records for an item).
3. **New Screen**: `SupplierItemCostDetail` (view/edit a single supplier-item cost and tier rows).

> Moqui pattern: list screen â†’ detail/edit screen with transitions for create/update/delete.

### Navigation context
- Breadcrumb includes Inventory > Items > {itemId} > Supplier Costs > {supplierId}
- Deep-linkable by IDs: item + supplier.

### User workflows
**Happy path: create tiers**
1. User opens item, navigates to Supplier Costs.
2. User selects supplier (or clicks â€œAdd Supplier Costâ€ and chooses supplier).
3. User enters optional base cost (if supported) and adds one or more tier rows.
4. User saves; UI shows success and returns to detail view.

**Alternate paths**
- Edit existing tiers: load existing tiers, modify rows, save.
- Delete tier structure: remove all tiers / delete supplier-item cost record.
- Read-only view if user lacks edit permissions.

---

## 6. Functional Behavior

### Triggers
- User opens supplier cost management for an item (load existing supplier-item costs).
- User selects a supplier-item cost to view/edit (load tiers).
- User clicks Save (create/update).
- User clicks Delete (delete supplier-item cost / tier structure).

### UI actions
- Add tier row
- Remove tier row
- Reorder tiers (optional; if allowed, UI should still sort/validate by min qty before save)
- Save
- Cancel/back

### State changes (UI)
- `idle` â†’ `loading` when fetching
- `editing` when user modifies form
- `saving` during submit
- `error` if backend rejects

### Service interactions
- Load supplier-item cost and tiers for item+supplier.
- Persist full tier set atomically (preferred) to avoid partial updates.
- Delete supplier-item cost record (and associated tiers).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (client-side, mirrored from backend rules)
- Tier rows must have:
  - `minQuantity` integer, **>= 1**
  - `maxQuantity` integer **>= minQuantity**, or **null** (final/open-ended tier)
  - `unitCost` decimal **> 0**
- Tier set must:
  - Start at `minQuantity = 1`
  - Be **contiguous** (no gaps)
  - Be **non-overlapping**
  - Preferably sorted by `minQuantity` (UI should enforce order or auto-sort before save)
- A supplier-item pair can have **at most one active tier structure**:
  - UI prevents creating a second record for same supplier-item; instead routes to edit existing.

### Enable/disable rules
- Save disabled until:
  - required fields present (supplier, item)
  - tiers validate (or base cost only if tiers are optionalâ€”**TBD**)
- If user lacks edit permission:
  - all inputs disabled; hide Save/Delete; show â€œRead onlyâ€.

### Visibility rules
- Display `currencyCode` read-only, derived from supplier configuration (not editable).
- Show base cost field only if backend supports it (exists in backend story data model but not guaranteed exposed via API).

### Error messaging expectations
- Map backend validation error codes to field-level messages when possible:
  - `INVALID_TIER_STRUCTURE` â†’ show summary banner + highlight tier table with specific hints:
    - overlap
    - not contiguous
    - start not at 1
- `403` â†’ â€œYou do not have permission to manage supplier costs.â€
- `404` â†’ â€œSupplier or item not found (may have been removed).â€
- `409` (if used) â†’ â€œThis cost tier set was modified by another user; reload to continue.â€ (status code usage **TBD**)

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `Supplier` (read-only reference): `supplierId`, `name`, `currencyCode`
- `InventoryItem` (read-only reference): `itemId` (or `inventoryItemId`), `sku`, `description`
- `SupplierItemCost`:
  - `id` (uuid)
  - `supplierId` (uuid, required)
  - `itemId` (uuid, required)
  - `currencyCode` (ISO-4217, required, read-only)
  - `baseCost` (decimal, optional) **TBD if used**
  - `createdAt`, `updatedAt` (timestamps, read-only)
- `CostTier`:
  - `id` (uuid)
  - `supplierItemCostId` (uuid, read-only on UI)
  - `minQuantity` (int, required)
  - `maxQuantity` (int|null, optional)
  - `unitCost` (decimal, required)

### Field types & constraints
- `unitCost`: decimal; must support at least 4 decimal places if backend expects same precision as other costs (**recommended**, but backend story did not explicitly say 4dp here; inventory domain guide says costs min 4dp generally).
- `minQuantity/maxQuantity`: integers.

### Read-only vs editable
- Editable: tier rows, baseCost (if supported).
- Read-only: supplier, item identifiers once record exists; currencyCode; audit timestamps.

### Derived/calculated fields (UI only)
- Display-only â€œRangeâ€ label per tier: e.g., `1â€“10`, `11â€“50`, `51+`.
- Validation-derived issues list (overlap/gap).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not explicitly defined in the provided frontend issue; below aligns to backend reference story but requires confirmation.

### Load/view calls
- **GET** supplier-item cost by `supplierId` + `itemId`  
  - Returns: supplierItemCost header + ordered tiers
- **GET** list supplier costs for an item (optional)  
  - Returns: suppliers that have cost configured + summary (baseCost? tier count?)

### Create/update calls
- **POST** create supplier-item cost with tiers (atomic)
- **PUT/PATCH** update supplier-item cost with tiers (atomic replace of tiers recommended)
- Request payload should include:
  - `supplierId`, `itemId`
  - optional `baseCost`
  - `tiers[]`: `{ minQuantity, maxQuantity, unitCost }`

### Delete calls
- **DELETE** supplier-item cost by id (or by supplierId+itemId), removing tiers as well.

### Error handling expectations
- `400` with structured validation errors; must include `code` (e.g., `INVALID_TIER_STRUCTURE`) and message.
- `403` forbidden.
- `404` not found.
- `409` conflict (optional) for optimistic locking if supported (needs confirmation whether `updatedAt`/ETag is used).

---

## 10. State Model & Transitions

### Allowed states
This UI is CRUD-oriented; no explicit lifecycle states provided. Treat record as:
- `NotCreated` (no supplier-item cost exists)
- `Exists` (supplier-item cost exists)
- `Deleted` (after delete)

### Role-based transitions
- Users with manage permission:
  - `NotCreated` â†’ Create
  - `Exists` â†’ Update
  - `Exists` â†’ Delete
- Users without manage permission:
  - View only; no transitions.

### UI behavior per state
- `NotCreated`: show create form (select supplier + add tiers).
- `Exists`: show detail with edit enabled; show Delete.
- `Deleted`: return to list with success toast.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- User enters tier 2 min that causes gap: block save; show â€œTier ranges must be contiguous starting at 1.â€
- User sets max < min: block save; field error.
- User sets negative/zero unitCost: block save; field error.

### Backend validation failures
- Backend returns `INVALID_TIER_STRUCTURE`: keep user inputs intact; show banner; highlight tier grid.

### Concurrency conflicts
- If backend supports optimistic locking and returns conflict:
  - show modal: â€œChanges detected. Reload / Cancel.â€
  - reload action refetches and discards local edits.

### Unauthorized access
- If load returns 403: show access denied screen state.

### Empty states
- No supplier costs for item: show empty state with â€œAdd Supplier Costâ€.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Create a valid cost tier structure
**Given** I am an authenticated user with permission to manage supplier-item costs  
**And** an Inventory Item and Supplier exist  
**When** I create a supplier-item cost with tiers starting at min quantity 1, contiguous, non-overlapping, and unit costs greater than 0  
**Then** the system saves successfully  
**And** when I reload the detail view I see the same tiers in ascending min quantity order.

### Scenario 2: Prevent overlapping tiers before save
**Given** I am editing supplier-item cost tiers  
**When** I enter tiers that overlap (e.g., 1â€“10 and 5â€“15)  
**Then** the Save action is disabled (or save is blocked)  
**And** I see an error explaining that quantity ranges must not overlap.

### Scenario 3: Prevent gaps in tiers before save
**Given** I am editing supplier-item cost tiers  
**When** I enter tiers with a gap (e.g., 1â€“10 and 12â€“20)  
**Then** the Save action is disabled (or save is blocked)  
**And** I see an error explaining that tiers must be contiguous.

### Scenario 4: Backend rejects invalid tier structure
**Given** I attempt to save tier data  
**And** the backend responds `400` with error code `INVALID_TIER_STRUCTURE`  
**When** the response is received  
**Then** the UI shows a non-destructive error message  
**And** my entered tiers remain on screen for correction.

### Scenario 5: View existing tiers read-only without permission
**Given** I am authenticated but do not have permission to manage supplier-item costs  
**When** I open an existing supplier-item cost record  
**Then** I can view tiers and currency  
**And** I cannot edit fields or save/delete changes  
**And** if I attempt a save via direct action, I receive a forbidden message.

### Scenario 6: Delete a supplier-item cost tier structure
**Given** a supplier-item cost exists for a supplier and item  
**And** I have permission to manage supplier-item costs  
**When** I delete the supplier-item cost  
**Then** it is removed  
**And** the list view no longer shows tiers for that supplier-item combination.

---

## 13. Audit & Observability

### User-visible audit data
- Show `createdAt`, `updatedAt` (and `updatedBy` if provided) on detail screen.
- If backend provides an audit log endpoint, show a link â€œView audit historyâ€ (implementation **TBD**).

### Status history
- Not applicable (no explicit lifecycle), but changes should be traceable via backend audit logs.

### Traceability expectations
- Frontend should include correlation/request ID if available in response headers in error logs (console/log framework).
- Log UI events: load/success/failure for supplier-item cost detail (non-PII).

---

## 14. Non-Functional UI Requirements
- **Performance**: Detail load should render initial skeleton/loading state; avoid blocking UI while validating tiers (validate locally).
- **Accessibility**: Tier table inputs must be keyboard navigable; error messages associated to fields (WCAG 2.1).
- **Responsiveness**: Tier editor usable on tablet widths; table may stack fields per row on small screens.
- **i18n/timezone/currency**:
  - Display costs formatted with supplier currency code.
  - Store and submit costs as raw decimals (no localized separators in payload).
  - Timestamps displayed in user timezone if app standard supports it.

---

## 15. Applied Safe Defaults
- SF-UI-EMPTY-STATE: Added an explicit empty state on list screen (â€œNo supplier costs configured yetâ€) because it is UI ergonomics and does not change domain logic. Impacted sections: UX Summary, Error Flows.
- SF-UI-LOADING-STATE: Defined loading/saving states with disabled actions to prevent duplicate submits; safe for UX and recoverable. Impacted sections: Functional Behavior, Non-Functional UI Requirements.

---

## 16. Open Questions
1. What are the **exact backend API endpoints and schemas** for supplier-item cost + tiers (paths, request/response bodies, and whether updates are PUT replace vs PATCH)? (blocking)
2. What is the **exact permission/role/authority string** the frontend should use to enable editing (e.g., `inventory.cost.supplier.update`)? (blocking)
3. Is `base_cost` part of the supported UX (fallback cost when no tiers), or should the UI be **tiers-only**? If supported, can a record exist with **no tiers but baseCost set**? (blocking)
4. What is the **currency source of truth**: supplier currency only, or can supplier-item cost override currency? Backend story says determined by supplier; confirm field should be read-only. (blocking)
5. Does backend enforce/expect **cost precision** (e.g., 4 decimal places) for `unit_cost` and `base_cost`? (blocking for validation + formatting)
6. Is there **optimistic locking** (ETag/version/updatedAt) and expected handling for concurrent edits? If yes, what status code/body is returned? (blocking for conflict handling)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Cost: Store Supplier/Vendor Cost Tiers (Optional) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/260

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Cost: Store Supplier/Vendor Cost Tiers (Optional)
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/260
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #197 - Cost: Store Supplier/Vendor Cost Tiers (Optional)
**URL**: https://github.com/louisburroughs/durion/issues/197
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns


### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:37:22.118751069*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #261: [FRONTEND] [STORY] Cost: Maintain Standard/Last/Average Cost with Audit  
File: ./scripts/story-work/frontend/261/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

**Title:** Cost: Maintain Standard/Last/Average Cost with Audit (Frontend â€“ Moqui)

**Primary Persona:** Inventory Manager (and Finance Manager for oversight)

**Business Value:**  
Provide accurate, permissioned visibility and maintenance of inventory item costs (standard/last/average) with full audit traceability so operations and finance can rely on authoritative valuation inputs and compliance-grade change history.

---

## 2. Story Intent

### As a / I want / So that
**As an** Inventory Manager (or Finance Manager),  
**I want** to view current costs (Standard, Last, Average) for an inventory item, manually update Standard Cost with a required reason code (when authorized), and view cost change audit history,  
**so that** costs are maintained correctly (system-managed vs user-managed) and all changes are traceable for analysis and audits.

### In-scope
- View current `standardCost`, `lastCost`, `averageCost` for an Inventory Item.
- Edit **Standard Cost only** (if user has `inventory.cost.standard.update`) with required `reasonCode`.
- Prevent editing of `lastCost` and `averageCost` (system-managed).
- Display cost audit history (`ItemCostAudit`) filtered to the item.
- Frontend handling of validation, authorization errors, and concurrency conflicts returned by services.

### Out-of-scope
- Implementing backend cost calculation/event processing (purchase order receipt updates).
- Creating/modifying inventory items or purchase order receipt workflows.
- Any FIFO/LIFO costing options.
- Any accounting postings/COGS calculations.

---

## 3. Actors & Stakeholders
- **Inventory Manager (Primary User):** Views costs, updates standard cost when permitted, reviews audit.
- **Finance Manager:** Same as above; oversight.
- **Accountant / Finance Team (Stakeholder):** Relies on average cost and audit trail.
- **Auditor (Stakeholder):** Requires immutable audit history and traceability.
- **System (Backend processes):** Updates last/average costs from receipt events; generates audit entries.

---

## 4. Preconditions & Dependencies
- Inventory item exists and is identifiable by `itemId` (or `inventoryItemId`) in routing.
- Backend exposes:
  - Read endpoint to load an itemâ€™s current costs and basic identity fields.
  - Mutation endpoint/service to update `standardCost` with `reasonCode` and permission enforcement.
  - Read endpoint to query `ItemCostAudit` by `itemId` with paging/sorting.
- AuthN/AuthZ available to frontend such that permission `inventory.cost.standard.update` is either:
  - discoverable via a â€œcurrent user permissionsâ€ endpoint, **or**
  - enforced server-side with `403` and handled gracefully client-side.
- Moqui frontend project conventions for screen routing, forms, and transitions are available in repo README (not included in prompt).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From Inventory Item detail screen (or item search results), user selects **Costs** tab/section.
- Direct navigation via URL to item cost screen: e.g. `/inventory/item/<itemId>/cost` (exact route TBD per repo conventions).

### Screens to create/modify
1. **Modify existing Inventory Item Detail screen** to add:
   - A **Costs** section showing current costs and â€œEdit Standard Costâ€ action (if permitted).
2. **New screen (or subscreen): Inventory Item Cost Maintenance**
   - Read-only display of Last Cost, Average Cost.
   - Editable Standard Cost (permission gated).
   - â€œSave Standard Costâ€ action with reason code input.
3. **New screen (or subscreen): Item Cost Audit History**
   - Table/grid of audit entries with filters (cost type, date range) and paging.

### Navigation context
- Breadcrumb: Inventory â†’ Items â†’ Item Detail â†’ Costs
- Provide return navigation back to item detail.

### User workflows
**Happy path (authorized update):**
1. User opens item Costs.
2. User clicks â€œEdit Standard Costâ€.
3. User enters new standard cost and reason code.
4. User saves.
5. UI confirms success and refreshes current costs + audit list.

**Alternate paths:**
- User without permission sees Standard Cost as read-only and no edit affordance (or edit attempt results in clear authorization error).
- Standard cost update fails validation (missing reason code, invalid decimal) â†’ inline error + no data change.
- Backend rejects due to concurrency/version mismatch â†’ prompt to refresh and retry.

---

## 6. Functional Behavior

### Triggers
- Screen load with `itemId`.
- User initiates edit/save of Standard Cost.
- User requests audit pagination/filter changes.

### UI actions
- Load current item costs on entry.
- Render cost values with 4-decimal formatting (display) while preserving exact backend values.
- Provide input controls:
  - `standardCost` numeric input (nullable allowed? see Open Questions).
  - `reasonCode` required text/select (backend expects string; UI may offer free-text unless reason codes list exists).
- Disable editing for `lastCost` and `averageCost` always.
- On save:
  - Call update service.
  - Show toast/notification on success.
  - Re-fetch item costs and audit list.

### State changes (frontend)
- Local form state: `view` â†’ `editing` â†’ `saving` â†’ `view` (or `error`).
- Store `lastLoadedAt` timestamp for user awareness (optional).
- Track optimistic concurrency token if provided (e.g., `lastUpdatedStamp`).

### Service interactions
- `loadItemCosts(itemId)` on screen enter.
- `updateStandardCost(itemId, newStandardCost, reasonCode, concurrencyToken?)` on save.
- `loadCostAudit(itemId, filters, page)` on audit tab open and on filter/page change.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Standard cost input:
  - Must be a decimal with at least 4 decimal places supported (UI allows up to >=4; do not force rounding beyond backend rules).
  - **Zero is disallowed** (per inventory rules: â€œzero is disallowed to avoid ambiguityâ€). UI should block `0` and `0.0000`.
  - Negative values disallowed.
  - Null allowed only if explicitly supported for manual clearing (unclear; see Open Questions).
- Reason code:
  - Required for manual Standard Cost updates.
  - Non-empty trimmed string.
- Last/Average costs:
  - Never editable; if user attempts via devtools, backend must rejectâ€”UI should still treat as read-only.

### Enable/disable rules
- â€œEdit/Save Standard Costâ€ visible/enabled only when:
  - user has permission `inventory.cost.standard.update`, OR
  - user attempts and backend returns `403` â†’ then UI hides/disables edit for remainder of session (optional enhancement; safe default not applied).
- Save button disabled until:
  - standardCost changed and valid
  - reasonCode present

### Visibility rules
- If a cost is `null`, display as â€œNot setâ€ (not `0.00`).
- Audit section available to all users who can view item detail (permission model unclear; default to same visibility as item view).

### Error messaging expectations
- Validation errors: inline near field, plus summary banner if multiple.
- Authorization (`403`): â€œYou donâ€™t have permission to update Standard Cost.â€
- Backend validation (`400`): show server message; map field errors to inputs if present.
- Not found (`404`): â€œItem not foundâ€ with link back to search.
- Server error (`5xx`): â€œCould not update cost. Try again.â€ with correlation/trace id if provided.

---

## 8. Data Requirements

### Entities involved
- `InventoryItem` (read current costs)
- `ItemCostAudit` (read audit history)

### Fields (type, required, defaults)
**InventoryItem (read-only except standard cost update action)**
- `itemId` (string/uuid, required)
- `standardCost` (decimal(?, scale>=4), nullable, default null)
- `lastCost` (decimal scale>=4, nullable, default null)
- `averageCost` (decimal scale>=4, nullable, default null)
- `lastUpdatedStamp` or equivalent (timestamp/version, optional but strongly recommended for concurrency)

**Standard Cost Update Payload**
- `itemId` (required)
- `standardCost` (decimal scale>=4, required if update sets value; nullable only if â€œclearâ€ supported)
- `reasonCode` (string, required)

**ItemCostAudit (read-only table)**
- `auditId` (uuid/string)
- `timestamp` (datetime)
- `costTypeChanged` (enum: STANDARD/LAST/AVERAGE)
- `oldValue` (decimal nullable)
- `newValue` (decimal nullable)
- `changeSourceType` (MANUAL/PURCHASE_ORDER)
- `changeSourceId` (string)
- `actor` (string)
- `reasonCode` (string nullable except required when MANUAL+STANDARD)

### Read-only vs editable by state/role
- `standardCost`: editable only for users with `inventory.cost.standard.update`.
- `lastCost`, `averageCost`: always read-only.
- Audit records: always read-only.

### Derived/calculated fields
- None calculated client-side. Average cost calculation is backend-owned/event-driven.

---

## 9. Service Contracts (Frontend Perspective)

> NOTE: Exact endpoint names are unknown from prompt; Moqui implementations may use services invoked via screen transitions. The frontend must align with backend API contracts once confirmed.

### Load/view calls
1. **Get item costs**
   - Input: `itemId`
   - Output: `InventoryItem` fields above
   - Errors: 404 if not found; 403 if not authorized to view item (if applicable)

2. **Get cost audit history**
   - Input: `itemId`, optional filters:
     - `costTypeChanged` (multi or single)
     - `changeSourceType`
     - date range (`fromTs`, `toTs`)
     - paging (`pageIndex`, `pageSize`)
     - sort (default `timestamp desc`)
   - Output: paged list + total count if available

### Create/update calls
1. **Update standard cost**
   - Input: `itemId`, `standardCost`, `reasonCode`, optional concurrency token
   - Output: updated `standardCost` and updated stamp/token
   - Errors:
     - 400 validation (missing reasonCode, invalid cost <=0, invalid scale)
     - 403 missing permission `inventory.cost.standard.update`
     - 409 concurrency conflict (if supported)

### Submit/transition calls
- None beyond update action.

### Error handling expectations
- Backend returns structured error payload with:
  - message
  - fieldErrors (optional: `{field, message}`)
  - correlationId/traceId (optional)
- Frontend maps:
  - fieldErrors â†’ input validation messages
  - otherwise â†’ banner/toast

---

## 10. State Model & Transitions

### Allowed states
Frontend UI state machine (not domain lifecycle):
- `loading`
- `viewing`
- `editingStandardCost`
- `saving`
- `error`

### Role-based transitions
- To enter `editingStandardCost`: requires permission `inventory.cost.standard.update`.
- If permission absent:
  - stay in `viewing` with read-only display.

### UI behavior per state
- `loading`: show spinner/skeleton; disable actions.
- `viewing`: show costs, audit table; show â€œEdit Standard Costâ€ only if permitted.
- `editingStandardCost`: show inputs for standardCost and reasonCode; disable save until valid.
- `saving`: disable inputs; show progress indicator.
- `error`: show error panel with retry to reload.

---

## 11. Alternate / Error Flows

### Validation failures (client-side)
- User enters `0` or negative â†’ block save; message â€œStandard Cost must be greater than 0.â€
- User leaves reason blank â†’ block save; message â€œReason code is required.â€

### Validation failures (server-side)
- Server returns 400 with reasonCode missing/invalid â†’ display and keep user in editing.
- Server rejects attempt to update last/average (shouldnâ€™t happen from UI) â†’ show generic validation error.

### Concurrency conflicts
- If update returns 409:
  - Show message: â€œThis item was updated by someone else. Reload to continue.â€
  - Provide â€œReloadâ€ button that re-fetches item costs and resets form.

### Unauthorized access
- If load calls return 403: show access denied state.
- If update returns 403: show toast/banner and revert to viewing with edit disabled.

### Empty states
- Costs all null: display â€œNot setâ€ for each.
- Audit list empty: show â€œNo cost changes recorded yet.â€

---

## 12. Acceptance Criteria

### Scenario 1: View costs with null handling
**Given** an inventory item exists with `standardCost = null`, `lastCost = null`, `averageCost = null`  
**When** the user opens the item Costs screen  
**Then** the UI displays each cost as â€œNot setâ€ (not `0.00`)  
**And** the Last Cost and Average Cost fields are read-only.

### Scenario 2: Authorized user updates Standard Cost with reason code
**Given** the user has permission `inventory.cost.standard.update`  
**And** the item has `standardCost = 10.0000`  
**When** the user edits Standard Cost to `12.5000` and enters reason code `SUPPLIER_PRICE_INCREASE`  
**And** the user clicks Save  
**Then** the frontend calls the Standard Cost update service with `itemId`, `standardCost=12.5000`, and the reason code  
**And** on success the UI shows the updated Standard Cost value  
**And** the audit history list includes a new entry for costType `STANDARD` with old `10.0000` and new `12.5000` and reason code.

### Scenario 3: Standard Cost update blocked when reason code missing
**Given** the user has permission `inventory.cost.standard.update`  
**When** the user enters a valid Standard Cost value but leaves reason code blank  
**Then** the Save action is disabled (or save shows inline validation error)  
**And** no update service call is made.

### Scenario 4: Unauthorized user cannot edit Standard Cost
**Given** the user does not have permission `inventory.cost.standard.update`  
**When** the user opens the Costs screen  
**Then** Standard Cost is displayed as read-only  
**And** no â€œEdit/Save Standard Costâ€ action is available  
**Or** if the user attempts to invoke save (e.g., via direct request) and receives 403  
**Then** the UI displays an authorization error and no values change.

### Scenario 5: Prevent editing of system-managed costs
**Given** any user opens the Costs screen  
**Then** Last Cost and Average Cost are never presented as editable fields  
**And** the UI provides no action to update them.

### Scenario 6: Server rejects invalid Standard Cost (zero or negative)
**Given** the user has permission `inventory.cost.standard.update`  
**When** the user attempts to save Standard Cost as `0.0000`  
**Then** the UI blocks the save with a validation message  
**And** if the request is still sent and the server responds 400  
**Then** the UI shows the server validation error and keeps the user in editing state.

### Scenario 7: Audit history paging and filtering
**Given** an item has more than one page of `ItemCostAudit` records  
**When** the user changes page size or navigates to the next page  
**Then** the UI requests the next page from the audit service  
**And** shows results sorted by timestamp descending by default.

### Scenario 8: Concurrency conflict on update
**Given** the user starts editing Standard Cost  
**And** the item is updated by another actor before save  
**When** the user saves and the server responds with a 409 conflict  
**Then** the UI informs the user and offers a reload action  
**And** reloading refreshes the displayed costs and clears the edit form.

---

## 13. Audit & Observability

### User-visible audit data
- Audit table shows: timestamp, cost type, old value, new value, source type, source id, actor, reason code (when present).

### Status history
- Not applicable beyond audit entries; no additional UI lifecycle tracking required.

### Traceability expectations
- For update requests, capture and display server-provided `traceId`/`correlationId` in an expandable error details area (if provided).
- UI should include `itemId` in client logs for debugging (no PII).

---

## 14. Non-Functional UI Requirements
- **Performance:** Costs and audit should load within 2s on typical network for <=50 audit rows; audit uses paging to avoid large payloads.
- **Accessibility:** WCAG 2.1 AA; labels for inputs, error messages associated to fields, keyboard navigable table.
- **Responsiveness:** Works on tablet widths used in POS back office.
- **i18n/timezone/currency:**  
  - Costs displayed using system currency formatting rules (currency code source unclear; see Open Questions).  
  - Timestamps displayed in user locale/timezone; store/render UTC appropriately.

---

## 15. Applied Safe Defaults
- none

---

## 16. Open Questions
1. **API/Service contracts:** What are the exact backend endpoints or Moqui services for:
   - loading item costs,
   - updating standard cost,
   - querying cost audit history (including paging params and response shape)?
2. **Routing location:** What is the canonical route/screen hierarchy in `durion-moqui-frontend` for Inventory Item detail, so the Costs screen is placed consistently?
3. **Permissions discovery:** Does the frontend have a standard way to check permissions (e.g., current-user permissions payload), or should it rely purely on backend 403 handling?
4. **Reason codes source:** Is `reasonCode` free-text, or must it be selected from a controlled list? If controlled, what are the allowed values and how are they loaded?
5. **Currency context:** Are item costs always in a single system currency, or do we need to display a currency code per site/item?
6. **Standard cost clearing:** Is setting `standardCost` back to `null` allowed via UI (i.e., â€œClear Standard Costâ€), or are manual changes required to be >0 always?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Cost: Maintain Standard/Last/Average Cost with Audit  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/261  
Labels: frontend, story-implementation, type:story, layer:functional, kiro

## ğŸ¤– Implementation Issue - Created by Durion Workspace Agent

### Original Story
**Story**: #196 - Cost: Maintain Standard/Last/Average Cost with Audit  
**URL**: https://github.com/louisburroughs/durion/issues/196  
**Domain**: general

### Implementation Requirements
This issue was automatically created by the Missing Issues Audit System to address a gap in the automated story processing workflow.

The original story processing may have failed due to:
- Rate limiting during automated processing
- Network connectivity issues
- Temporary GitHub API unavailability
- Processing system interruption

### Implementation Notes
- Review the original story requirements at the URL above
- Ensure implementation aligns with the story acceptance criteria
- Follow established patterns for frontend development
- Coordinate with corresponding backend implementation if needed

### Technical Requirements
**Frontend Implementation Requirements:**
- Use Vue.js 3 with Composition API
- Follow TypeScript best practices
- Implement using Quasar UI framework components
- Ensure responsive design and accessibility (WCAG 2.1)
- Handle loading states and error conditions gracefully
- Implement proper form validation where applicable
- Follow established routing and state management patterns

### Notes for Agents
- This issue was created automatically by the Missing Issues Audit System
- Original story processing may have failed due to rate limits or network issues
- Ensure this implementation aligns with the original story requirements
- Frontend agents: Focus on Vue.js 3 components, TypeScript, Quasar UI framework. Coordinate with backend implementation for API contracts.

### Labels Applied
- `type:story` - Indicates this is a story implementation
- `layer:functional` - Functional layer implementation
- `kiro` - Created by Kiro automation
- `domain:general` - Business domain classification
- `story-implementation` - Implementation of a story issue
- `frontend` - Implementation type

---
*Generated by Missing Issues Audit System - 2025-12-26T17:37:24.884908378*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #81: [FRONTEND] [STORY] Catalog: Search Catalog by Keyword/SKU and Filter  
File: ./scripts/story-work/frontend/81/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

# 1. Story Header

**Title:** Catalog: Search Catalog by Keyword/SKU and Filter (POS)  
**Primary Persona:** POS Clerk  
**Business Value:** Reduce time-to-find items during checkout by enabling fast, accurate catalog search with filters and pagination.

---

# 2. Story Intent

## As a / I want / So that
**As a** POS Clerk,  
**I want** to search the catalog by keyword, SKU/MPN, and category and refine results using common filters,  
**So that** I can quickly find and add the correct items during checkout.

## In-scope
- A Moqui screen for catalog search with:
  - Search input supporting keyword, SKU, and MPN entry
  - Category selection
  - Filters: tire size/spec, manufacturer, price range
  - Results list rendering `ProductSummary` including `availabilityHint`
  - Cursor-based pagination using `nextCursor`
- Frontend validation for obviously invalid inputs (e.g., negative prices; malformed tire spec fields if specified)
- Handling of empty results, validation errors, unauthorized responses, and service unavailability

## Out-of-scope
- Adding items to cart/work order/ticket (handled by another story)
- Editing product master data or inventory quantities/costs
- Advanced search syntax (quotes, boolean operators) unless explicitly supported by backend
- Multi-site inventory availability breakdowns (only `availabilityHint` as provided)

---

# 3. Actors & Stakeholders

- **Primary Actor:** POS Clerk
- **System Actors:**
  - Moqui Frontend (Screens in `durion-moqui-frontend`)
  - Inventory Service (catalog search endpoint; source of `SearchResult`)
- **Stakeholders:**
  - Product domain (SoR for product definitions/categories; consumed by search)
  - Work Execution domain (downstream user of selected product to add to work order)

---

# 4. Preconditions & Dependencies

- User is authenticated in the POS frontend.
- User has permission to access catalog search (permission name not provided; see Open Questions).
- Backend search API exists and matches (or is compatible with) backend story #17:
  - Request shape: `SearchQuery`
  - Response shape: `SearchResult` with cursor pagination (`nextCursor`)
- Backend provides `availabilityHint` in `ProductSummary` (may be degraded if inventory enrichment unavailable per backend note).

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Primary: POS navigation menu item â€œCatalog Searchâ€ (or equivalent POS landing action).
- Secondary: From checkout/search bar entry point (if exists) deep-linking into same screen with prefilled `queryTerm`.

## Screens to create/modify
- **Create** `apps/pos/screen/CatalogSearch.xml` (name/path illustrative; align to repo conventions)
  - Screen includes a search form and results section.
- **Create/Reuse** a reusable results component (Vue/Quasar) used within the screen (if project uses SPA widgets embedded in Moqui screens).
- **Modify** navigation/menu screen to add route/link to Catalog Search screen.

## Navigation context
- Screen should preserve search state in URL parameters (query term, category, filters) to support refresh/back navigation **without losing context**.
- Cursor (`nextCursor`) should be stored in view state, not necessarily in URL (cursor is opaque and can be long).

## User workflows
### Happy path
1. Clerk opens Catalog Search.
2. Clerk enters query term (keyword or SKU/MPN) and optionally selects category + filters.
3. Clerk submits search.
4. Results render with key fields and availability hint.
5. Clerk navigates to next page using â€œLoad moreâ€ / â€œNextâ€ (cursor-based) and continues scanning.

### Alternate paths
- Clerk applies filters after initial search; results refresh from first page (cursor reset).
- Clerk clears filters; results refresh accordingly.
- Clerk searches and gets no results; sees empty state and can adjust query/filters.

---

# 6. Functional Behavior

## Triggers
- User presses Enter in search input or clicks â€œSearchâ€.
- User changes category or any filter and triggers â€œApply filtersâ€ (explicit apply) or auto-apply (see Open Questions; default to explicit apply only if unclear).

## UI actions
- Input fields:
  - `queryTerm` (free text)
  - `categoryId` (single select)
  - `manufacturer` (select or text)
  - `priceMin`, `priceMax`
  - `tireSpecs` fields (width, aspectRatio, diameter, and any additional fields supported)
- Buttons:
  - Search
  - Clear
  - Apply filters (if separate)
  - Load next page (uses `nextCursor`)
- Results list actions:
  - View details (optional; if there is a product details screenâ€”otherwise omit)
  - (No â€œAddâ€ action in this story)

## State changes (frontend)
- Local view state:
  - `searchRequest` (current query/filters)
  - `results.items`
  - `results.metadata.totalItems/pageSize/nextCursor`
  - `loading`, `errorBanner`, `validationErrors`
- When any search criteria changes and a new search is submitted:
  - Reset results and cursor (fresh search)
- When â€œLoad next pageâ€:
  - Append items; update `nextCursor`

## Service interactions
- Call backend search service with:
  - Normalized request parameters (frontend should not implement ranking/normalization logic; backend owns search semantics)
  - Cursor pagination params

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Price range:
  - `minPrice` and `maxPrice` must be numeric decimals when provided
  - `minPrice >= 0`, `maxPrice >= 0`
  - If both provided, `minPrice <= maxPrice`
- Pagination:
  - Page size defaults to 25
  - If UI exposes page size selector, enforce max 100 client-side; otherwise do not expose
- Tire specs:
  - If tire spec fields are present, they must be integers and positive
  - Do not guess additional spec fields beyond width/aspect/diameter without backend contract (see Open Questions)

## Enable/disable rules
- Disable â€œSearchâ€ while request in-flight.
- Disable â€œLoad next pageâ€ when `nextCursor` is null/empty or while loading.

## Visibility rules
- Show â€œNo results foundâ€ only after a successful search with `totalItems = 0` (or empty items and no error).
- Show error banner on non-2xx responses; keep last successful results visible unless the search request was a fresh search (see Error Flows).

## Error messaging expectations
- 400 validation errors: show inline messages near relevant inputs when possible; otherwise show banner with backend message.
- 401/403: show â€œYou donâ€™t have access to catalog search. Please sign in or contact a manager.â€
- 5xx/timeouts: show â€œCatalog search is temporarily unavailable. Try again.â€

---

# 8. Data Requirements

## Entities involved (frontend view models)
- `SearchQuery` (request DTO)
- `SearchResult` (response DTO)
- `ProductSummary` (response item)

## Fields (type, required, defaults)

### SearchQuery (frontend â†’ backend)
- `queryTerm` (string, optional)
- `categoryId` (string, optional)
- `filters` (object, optional)
  - `manufacturer` (string, optional)
  - `priceRange.min` (decimal, optional)
  - `priceRange.max` (decimal, optional)
  - `tireSpecs` (object, optional)
    - `width` (int, optional)
    - `aspectRatio` (int, optional)
    - `diameter` (int, optional)
    - `...` (unknown; do not send extra keys unless backend contract defined)
- `pagination` (object, optional)
  - `cursor` (string, optional)
  - `pageSize` (int, optional; default 25; cap 100)

### SearchResult (backend â†’ frontend)
- `metadata.totalItems` (int, required)
- `metadata.pageSize` (int, required)
- `metadata.nextCursor` (string|null, required)
- `items[]` (array<ProductSummary>, required)

### ProductSummary
- `productId` (string/UUID, required)
- `sku` (string, required)
- `mpn` (string, optional)
- `name` (string, required)
- `descriptionShort` (string, required)
- `listPrice` (decimal, required)
- `manufacturer` (string, required)
- `availabilityHint` (enum string, optional but expected)

## Read-only vs editable
- All `ProductSummary` fields are read-only.
- Search input fields are editable prior to submit; after submit they remain editable for new searches.

## Derived/calculated fields (frontend)
- Display-only:
  - Availability badge derived from `availabilityHint` value mapping
  - â€œShowing N resultsâ€ derived from `items.length` and `totalItems` (if provided)

---

# 9. Service Contracts (Frontend Perspective)

> Backend endpoint path is not provided in the inputs; contract below defines required behavior but not exact URL. Implementation must bind to the existing Moqui service naming conventions in this repo.

## Load/view calls
- (Optional) Load categories list for category filter:
  - `GET categories` or Moqui service call to retrieve category options
  - If not available, category filter must be hidden/disabled until contract exists (see Open Questions)

## Create/update calls
- None.

## Submit/transition calls
- **Catalog search call**
  - Method: `POST` (preferred) or `GET` with query params (if backend does)
  - Request body/params: `SearchQuery`
  - Response: `SearchResult`

## Error handling expectations
- `400 Bad Request`: backend returns validation details/message; frontend surfaces message and highlights fields when possible
- `401 Unauthorized`: redirect to login or show session-expired flow consistent with app conventions
- `403 Forbidden`: show access denied message
- `429 Too Many Requests` (if present): show â€œPlease wait and try againâ€ and throttle repeated submissions (see Applied Safe Defaults)
- `5xx`: show transient error; allow retry

---

# 10. State Model & Transitions

## Allowed states (screen-level)
- `Idle` (no search yet)
- `Loading` (request in-flight)
- `Loaded` (results available, may include 0 results)
- `Error` (last request failed)

## Role-based transitions
- Authenticated user with catalog search permission: may transition `Idle â†’ Loading â†’ Loaded/Error`, `Loaded â†’ Loading` (new search), `Loaded â†’ Loading` (load more)
- Unauthorized/forbidden: transitions to `Error` with access message; no backend retry until auth state changes

## UI behavior per state
- Idle: show inputs, no results
- Loading: show spinner; disable inputs/buttons that submit
- Loaded: show results + pagination controls
- Error: show banner; keep inputs enabled for correction/retry

---

# 11. Alternate / Error Flows

## Validation failures (client-side)
- If `minPrice > maxPrice`:
  - Prevent request; show inline error
- If negative price:
  - Prevent request; show inline error
- If tire spec fields non-integer:
  - Prevent request; show inline error (field-specific)

## Validation failures (server-side 400)
- Show banner with backend message
- If backend returns field-level errors, map to form fields (needs contract; otherwise banner only)

## Concurrency conflicts
- Not applicable (read-only search).

## Unauthorized access
- 401: user session expired â†’ follow appâ€™s standard re-auth flow
- 403: show access denied; do not keep retrying automatically

## Empty states
- No results: show â€œNo results foundâ€ and suggest clearing filters
- No categories available: hide category filter or show disabled select with message (depends on category API availability)

---

# 12. Acceptance Criteria

## Scenario: Keyword search returns matching products
**Given** the POS Clerk is on the Catalog Search screen  
**When** the Clerk enters a keyword that exists in a productâ€™s name or short description and submits the search  
**Then** the results list includes that productâ€™s `ProductSummary`

## Scenario: Exact SKU search prioritizes exact match
**Given** the POS Clerk is on the Catalog Search screen  
**When** the Clerk enters an exact SKU for an existing product and submits the search  
**Then** the first result item has that SKU and matches the corresponding product

## Scenario: Manufacturer filter restricts results
**Given** a search returns products from multiple manufacturers  
**When** the Clerk applies a manufacturer filter for one manufacturer and runs the search  
**Then** every returned result has `manufacturer` equal to the selected manufacturer

## Scenario: Price range validation prevents invalid submission
**Given** the POS Clerk has entered `minPrice` greater than `maxPrice`  
**When** the Clerk attempts to submit the search  
**Then** the UI blocks the request and displays a validation error indicating the range is invalid

## Scenario: Cursor-based pagination loads next page
**Given** a search response includes a non-null `nextCursor`  
**When** the Clerk selects â€œLoad next pageâ€  
**Then** the UI requests the next page using that cursor and appends the additional items to the results list

## Scenario: Default page size used when none selected
**Given** the POS Clerk submits a search without selecting a page size  
**When** the UI calls the search service  
**Then** the request omits `pageSize` or sends `pageSize=25` (per backend contract), and the UI renders up to 25 results for the first page

## Scenario: No results displays empty state
**Given** the POS Clerk submits a valid search that matches no products  
**When** the response returns `totalItems = 0` and an empty `items` list  
**Then** the UI displays a â€œNo results foundâ€ empty state and does not show a next-page control

## Scenario: Backend 400 shows actionable error
**Given** the POS Clerk submits a search request that the backend deems invalid  
**When** the backend responds with HTTP 400 and an error message  
**Then** the UI displays the error message and keeps the search inputs available for correction

## Scenario: Service unavailable shows retryable error
**Given** the POS Clerk submits a search  
**When** the backend times out or returns HTTP 5xx  
**Then** the UI displays â€œCatalog search is temporarily unavailableâ€ and provides a retry action

---

# 13. Audit & Observability

## User-visible audit data
- Not required (read-only search).

## Status history
- Not required.

## Traceability expectations
- Frontend logs (console/app logger per repo conventions) should include:
  - correlation/request id if provided by backend
  - search submission event with non-PII parameters (query term may be logged; confirm policyâ€”see Open Questions)
- Emit frontend performance timings for:
  - time from submit â†’ results rendered
  - error counts by status code class

---

# 14. Non-Functional UI Requirements

- **Performance:** UI must remain responsive during search; show loading indicator within 100ms of submission.
- **Accessibility:** All inputs labeled; keyboard submit supported; results list navigable via keyboard; ARIA for loading state.
- **Responsiveness:** Usable on standard POS resolutions; filters collapse appropriately on narrow widths.
- **i18n/timezone/currency:** Display `listPrice` using configured locale/currency formatting (do not assume currency code; use app defaults).

---

# 15. Applied Safe Defaults

- **SD-UX-EMPTY-STATE-01**: Provide a standard â€œNo results foundâ€ empty state after a successful search with 0 results; qualifies as safe UI ergonomics. Impacted sections: UX Summary, Error Flows, Acceptance Criteria.  
- **SD-UX-PAGINATION-01**: Use cursor-based â€œLoad next pageâ€ behavior instead of offset pagination to match backend contract; safe because backend story explicitly defines cursor-first pagination. Impacted sections: Functional Behavior, Service Contracts, Acceptance Criteria.  
- **SD-ERR-MAP-01**: Map HTTP 400/401/403/5xx to standard banner messaging and retry affordance; safe because itâ€™s generic error handling without changing domain policy. Impacted sections: Business Rules, Error Flows, Acceptance Criteria.  
- **SD-UX-THROTTLE-01**: Disable submit while in-flight to prevent accidental duplicate requests; safe UX ergonomics. Impacted sections: Functional Behavior, State Model.

---

# 16. Open Questions

1. **STOP (Blocking): What is the exact Moqui service name and route/URL for the catalog search API in this frontend repo?** (Needed to implement `transition`/service-call wiring.)  
2. **STOP (Blocking): Is there an existing category list API/service for the category filter? If yes, what are the identifiers and display fields (e.g., `categoryId`, `categoryName`) and does it support hierarchy?**  
3. **STOP (Blocking): What is the authorization/permission requirement to access catalog search in the frontend (permission string/role mapping)?**  
4. **STOP (Blocking): Tire specs filter contract: which fields are supported beyond `width/aspectRatio/diameter` (e.g., load index, speed rating, season, run-flat), and what are valid ranges/enums?**  
5. **Should filters auto-apply on change or require an explicit â€œApplyâ€ action?** (Impacts UX and request frequency; choose based on POS expectations/performance.)  
6. **Should the query term be persisted/logged in frontend telemetry, or treated as sensitive?** (Defines safe logging behavior.)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Catalog: Search Catalog by Keyword/SKU and Filter  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/81  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Catalog: Search Catalog by Keyword/SKU and Filter

**Domain**: user

### Story Description

/kiro
# User Story

## Narrative
As a **POS Clerk**, I want to search the catalog quickly so that I can find the right items during checkout.

## Details
- Search by keyword, SKU/MPN, category.
- Filters: tire size/spec, manufacturer, price range (basic).

## Acceptance Criteria
- Search returns results within target latency.
- Filters apply correctly.
- Pagination supported.

## Integrations
- Product domain provides definitions; inventory provides availability hints.

## Data / Entities
- SearchQuery, SearchResult, ProductSummary

## Classification (confirm labels)
- Type: Story
- Layer: Experience
- domain :  Point of Sale

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #87: [FRONTEND] [STORY] Security: Define Inventory Roles and Permission Matrix â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/87
File: ./scripts/story-work/frontend/87/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Inventory Security: Inventory Roles, Permission Matrix UI Gating, and Role Assignment Audit Visibility

### Primary Persona
System Administrator (Admin)

### Business Value
Ensure only authorized staff can perform sensitive inventory operations (stock adjustments, count approvals, receiving reversals) by reflecting RBAC permissions in the frontend, preventing unauthorized UI actions, and exposing auditable role assignment history for compliance and incident review.

---

## 2. Story Intent

### As a / I want / So that
As a System Administrator, I want the frontend to (1) display inventory roles and their permissions, (2) allow assigning/unassigning inventory roles to users where authorized, and (3) gate inventory UI actions based on permissions, so that inventory operations follow least-privilege and are auditable.

### In-scope
- Inventory security administration UI surfaces:
  - View inventory roles and the permission matrix (role â†’ permission mapping)
  - Assign/unassign roles to users (if supported by backend contract)
  - View audit history of role assignment changes (who changed what, when)
- Frontend permission-aware UI behavior for Inventory screens:
  - Hide/disable protected actions based on effective permissions
  - Handle `403 Forbidden` consistently with user feedback
- Moqui screen(s), forms, transitions, and service calls required for the above.

### Out-of-scope
- Defining or changing backend RBAC framework behavior (server-side enforcement remains backend responsibility).
- Implementing identity provider (OIDC/HR) integration UI beyond selecting existing users.
- Designing new inventory operational flows (cycle count, receiving, adjust stock) beyond gating their existing entry points/actions.
- Creating/maintaining product master data.

---

## 3. Actors & Stakeholders
- **System Administrator (primary):** Manages role assignments and reviews audit.
- **Inventory Manager / Controller:** Stakeholder for separation-of-duties expectations.
- **Auditor / Compliance:** Needs audit visibility and traceability.
- **Inventory Users (Receiver, Stock Clerk, Mechanic Picker):** Impacted by UI gating (view vs action).
- **Security/RBAC backend service (system actor):** Source of truth for roles/permissions and audit events.

---

## 4. Preconditions & Dependencies
- Authenticated session exists and frontend can call Moqui backend services with user context.
- Backend provides:
  - A canonical inventory permission set (e.g., `inventory:stock:adjust`, `inventory:count:approve`, etc.).
  - APIs/services to fetch:
    - Current userâ€™s effective permissions
    - Roles and their permissions
    - User role assignments
    - Audit log entries for role assignment changes
  - APIs/services to assign/unassign roles (if required for this story).
- Dependency reference (backend): `durion-positivity-backend` issue #23 (roles/permission matrix) and RBAC framework issue #42.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Inventory â†’ Security** (admin-only visibility via permission gating).
- Secondary deep link route: `/inventory/security` (exact route finalization depends on existing screen tree).

### Screens to create/modify
1. **New Screen:** `InventorySecurity.xml` (or equivalent under `apps/durion/screen/inventory/`)
   - Subscreens:
     - `RoleMatrix` (roles list + permissions list read-only)
     - `UserRoleAssignments` (search user, view assigned roles, assign/unassign)
     - `RoleAudit` (audit log list + filters)
2. **Modify existing Inventory screens** (as needed):
   - Add permission gating to action buttons/menus:
     - Stock adjustment entry points
     - Cycle count initiate/submit/approve actions
     - Receiving receive/reverse actions
     - Location CRUD actions
     - Item CRUD actions
     - Reporting export actions

### Navigation context
- Inventory Security is an administrative area; should not appear to users lacking the required admin permission(s).
- From Role Matrix, Admin can navigate to User Role Assignments and Audit.

### User workflows
**Happy path: View role-permission matrix**
1. Admin opens Inventory â†’ Security â†’ Role Matrix
2. Sees list of roles and their granted permissions (read-only)
3. Can inspect a role to see permission keys and human-readable descriptions (if provided)

**Happy path: Assign a role to a user**
1. Admin opens User Role Assignments
2. Searches for a user (by name/email/username depending on backend)
3. Views current roles
4. Selects role(s) to add and submits
5. UI confirms success; audit entry becomes visible in Role Audit

**Alternate path: Unauthorized access**
- User without permission visits `/inventory/security` directly â†’ shown â€œAccess deniedâ€ with no data leakage.

**Alternate path: Backend denies action**
- Admin UI attempts assign/unassign but backend returns 403 (misconfigured permissions) â†’ UI shows error and refreshes assignments from server.

---

## 6. Functional Behavior

### Triggers
- Route entry to `/inventory/security/*`
- Click actions on:
  - â€œAssign Roleâ€, â€œRemove Roleâ€
  - Filtering/sorting audit log
  - Navigating to protected inventory functions elsewhere in the app

### UI actions
- Load current userâ€™s effective permissions on app startup or on entering Inventory module (see Open Questions for source).
- Conditional rendering:
  - Show/enable actions only if user has required permission.
- Forms:
  - User search form
  - Assign role form (select role(s), confirm)
  - Remove role action (with confirm)
  - Audit filter form (date range, actor, target user, role, outcome)

### State changes
- Client-side state: cached permissions and role list; refreshed on successful assignment changes.
- No inventory operational state machine changes are introduced by this story.

### Service interactions
- Fetch permissions for current user
- Fetch role-permission matrix
- Fetch user role assignments
- Submit role assignment changes
- Fetch audit logs

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Role assignment:
  - Must select a target user (required)
  - Must select at least one role to add (required)
  - For removal, must select an existing assigned role
- Inputs validated client-side for emptiness; authoritative validation comes from backend.

### Enable/disable rules
- Inventory Security nav entry visible only if user has the security-admin permission(s) defined for this module (Open Question: exact key).
- In inventory operational screens:
  - Disable/hide actions requiring permission keys per the canonical list:
    - `inventory:stock:adjust` gates â€œAdjust Stockâ€
    - `inventory:count:approve` gates â€œApprove Countâ€
    - `inventory:receiving:reverse` gates â€œReverse Receiptâ€
    - etc. (see Data Requirements permission catalog below)

### Visibility rules
- Do not show role/permission details to unauthorized users (no partial rendering).
- Audit screen visible only to authorized users (Open Question: which permission).

### Error messaging expectations
- 403: â€œYou donâ€™t have permission to perform this action.â€
- 400 validation: show backend message inline, mapped to fields when possible.
- 5xx/network: show generic failure and allow retry.

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- **Role**
- **Permission**
- **RolePermission** (role â†’ permission mapping)
- **UserRole** (user â†’ role mapping)
- **AuditLog** (role assignment audit events)

> Note: Exact entity names in Moqui may differ; frontend must bind to services/view-entities provided by backend/Moqui components.

### Fields
**Permission**
- `permissionId` / `permissionKey` (string, required) e.g., `inventory:stock:adjust`
- `description` (string, optional)

**Role**
- `roleId` (string, required)
- `roleName` (string, required)
- `description` (string, optional)

**RolePermission**
- `roleId` (string, required)
- `permissionKey` (string, required)

**UserRole**
- `userId` (string, required)
- `roleId` (string, required)
- `fromDate` (datetime, optional)
- `thruDate` (datetime, optional)

**AuditLog** (role assignment change)
- `auditId` (string, required)
- `eventType` (string, required) e.g., `security.userRole.assigned`, `security.userRole.removed`
- `actorUserId` / `actorPrincipal` (string, required)
- `targetUserId` (string, required)
- `roleId` (string, required)
- `timestamp` (datetime, required)
- `outcome` (enum/string, required: `ALLOW`/`DENY`/`SUCCESS`/`FAILURE` â€” depends on backend)
- `reason` / `message` (string, optional)
- `correlationId` (string, optional)

### Read-only vs editable
- Role-permission matrix: read-only (this story does not change role definitions).
- User role assignments: editable only if user has role-admin permission (Open Question: exact key).
- Audit log: read-only.

### Derived/calculated fields
- Effective permissions display: derived from assigned roles (server-calculated; frontend just displays).
- â€œHas permissionâ€ booleans for gating: derived from loaded effective permissions list.

---

## 9. Service Contracts (Frontend Perspective)

> Blocking: backend/Moqui service names and payloads are not provided. Below are required contracts to implement the frontend; map to actual Moqui services once confirmed.

### Load/view calls
1. **Get current user permissions**
   - Service: `security.getUserPermissions` (placeholder)
   - Request: none (uses auth context)
   - Response: `{ permissions: string[] }`

2. **Get inventory roles + permissions**
   - Service: `security.getRolesWithPermissions` (placeholder)
   - Request: `{ domain: "inventory" }` or filter prefix `inventory:`
   - Response: `{ roles: Role[], permissions: Permission[], rolePermissions: RolePermission[] }`

3. **Search users**
   - Service: `security.searchUsers` (placeholder)
   - Request: `{ query: string, limit, offset }`
   - Response: `{ users: { userId, displayName, email? }[] }`

4. **Get roles for user**
   - Service: `security.getUserRoles` (placeholder)
   - Request: `{ userId }`
   - Response: `{ roles: Role[] }`

5. **Get audit logs**
   - Service: `security.getAuditLogs` (placeholder)
   - Request: filters `{ fromTs?, toTs?, targetUserId?, actorUserId?, roleId?, eventType?, limit, offset }`
   - Response: `{ audits: AuditLog[], total }`

### Create/update calls
1. **Assign roles to user**
   - Service: `security.assignUserRoles` (placeholder)
   - Request: `{ userId, roleIds: string[] }`
   - Response: success acknowledgement + updated assignments (preferred) or 200 OK.

2. **Remove role from user**
   - Service: `security.removeUserRole` (placeholder)
   - Request: `{ userId, roleId }`
   - Response: success acknowledgement.

### Submit/transition calls
- None (no inventory workflow transitions in this story).

### Error handling expectations
- `403 Forbidden`: treat as authorization failure; do not retry automatically; show denial message.
- `400 Bad Request`: show validation errors (field-level if backend provides structured errors).
- `409 Conflict`: if backend detects concurrent role changes, show â€œRoles changed since you loaded; refreshâ€ and reload assignments.
- Network/5xx: show retry.

---

## 10. State Model & Transitions

### Allowed states
- Not applicable for inventory entities; this is RBAC/UI gating.

### Role-based transitions
- Not applicable.

### UI behavior per state
- **Loading:** show skeleton/loader for matrix and audit lists.
- **Empty:** show â€œNo roles foundâ€ / â€œNo audit entries match filtersâ€.
- **Error:** show inline error with retry.

---

## 11. Alternate / Error Flows

1. **Unauthorized route access**
   - If user lacks required permission, screen returns Access Denied state; no service calls that would leak data.

2. **Backend denies assign/unassign (403)**
   - Show denial toast/banner.
   - Refresh user roles from server to reflect actual state.

3. **User search returns empty**
   - Show empty state and tips to refine search.

4. **Concurrency conflict (409)**
   - Inform user, reload current roles, require re-apply changes.

5. **Audit service unavailable**
   - Show non-blocking error on Audit tab only; other tabs still usable if their calls succeed.

---

## 12. Acceptance Criteria

```gherkin
Scenario: Inventory Security menu is hidden when user lacks admin permission
  Given a logged-in user without the required Inventory Security admin permission
  When the user views the Inventory module navigation
  Then the "Security" entry is not shown
  And direct navigation to "/inventory/security" shows "Access denied"

Scenario: Role-permission matrix loads for authorized admin
  Given a logged-in Admin with permission to view roles and permissions
  When the Admin opens "/inventory/security/role-matrix"
  Then the UI displays Inventory roles
  And for each role the UI displays its granted permission keys
  And the UI does not allow editing role-permission mappings

Scenario: Assign role to user succeeds and is reflected in UI
  Given a logged-in Admin authorized to assign roles
  And a target user exists
  When the Admin assigns the role "Inventory Controller" to the target user
  Then the UI shows the role as assigned after the save completes
  And the UI shows a success confirmation

Scenario: Assign role to user is denied without permission
  Given a logged-in user who can view role matrix but cannot assign roles
  When the user attempts to assign a role to a target user
  Then the backend returns 403
  And the UI displays an authorization error
  And the UI does not show the role as assigned

Scenario: Protected inventory action is disabled/hidden without required permission
  Given a logged-in user without permission "inventory:stock:adjust"
  When the user opens an Inventory screen that offers "Adjust Stock"
  Then the "Adjust Stock" action is not available (hidden or disabled)
  And if the user attempts the action via direct URL/action invocation
  Then the UI handles a 403 response by showing an authorization error

Scenario: Role assignment changes are visible in audit log
  Given an Admin authorized to view audit logs
  And a role assignment change occurred for a target user
  When the Admin opens "/inventory/security/role-audit" and filters by the target user
  Then the UI lists an audit entry including actor, target, role, timestamp, and outcome
```

---

## 13. Audit & Observability

### User-visible audit data
- Audit tab shows role assignment events with:
  - Actor identity
  - Target user
  - Role
  - Timestamp (displayed in user locale; stored UTC)
  - Outcome/status
  - CorrelationId if provided (for support escalation)

### Status history
- For a selected user, optionally show â€œRole assignment historyâ€ (if backend supports query by user).

### Traceability expectations
- All assign/unassign actions from UI must include enough request context for backend auditing (actor from auth; optionally include client correlation ID header if used by project conventionsâ€”Open Question).

---

## 14. Non-Functional UI Requirements
- **Performance:** Role matrix and permissions load within 2s for up to 200 roles and 500 permissions (paginate if larger).
- **Accessibility:** Keyboard navigable tables/forms; proper labels for inputs; focus management on dialogs.
- **Responsiveness:** Usable on tablet widths; tables support horizontal scroll.
- **i18n/timezone:** Audit timestamps rendered in local timezone; backend timestamps assumed UTC. No currency concerns.

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Provide standard empty-state messaging for no search results/audit rows; safe because it doesnâ€™t alter domain logic. (Impacted: UX Summary, Alternate Flows)
- SD-UI-PAGINATION: Paginate user search and audit log lists with limit/offset; safe because itâ€™s UI ergonomics and non-domain. (Impacted: UX Summary, Service Contracts)
- SD-ERR-403-MAP: Map HTTP 403 to a consistent â€œnot authorizedâ€ UX pattern; safe because it reflects backend enforcement, not policy. (Impacted: Business Rules, Error Flows, Acceptance Criteria)

---

## 16. Open Questions

1. What are the exact permission keys that authorize:
   - Viewing Inventory Security screens (role matrix, assignments, audit)?
   - Assigning/unassigning roles?
   - Viewing audit logs?
   (Backend story defines inventory operation permissions, but not â€œRBAC adminâ€ permissions.)

2. What are the actual Moqui service names, request/response shapes, and error payload formats for:
   - current user effective permissions
   - role-permission matrix
   - user search
   - user role assignments
   - role assignment audit logs
   - assign/unassign role actions

3. Are inventory roles the canonical set from backend story (â€œInventory Viewer/Clerk/Manager/Controller/Adminâ€), or must the UI support the roles named in the original frontend issue description (InventoryManager, Receiver, StockClerk, MechanicPicker, Auditor)? If both exist, which are displayed/assignable?

4. Is role assignment managed within this system (Moqui) or via external IdP groups? If external, does the frontend need to be read-only with a link-out?

5. Which existing Inventory screens/actions must be gated in this story (exact screen IDs/routes), or should gating be limited strictly to Inventory Security pages only?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Security: Define Inventory Roles and Permission Matrix â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/87

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Security: Define Inventory Roles and Permission Matrix
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/87
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Security: Define Inventory Roles and Permission Matrix

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As an **Admin**, I want roles/permissions so that only authorized users can adjust stock or approve counts.

## Details
- Roles: InventoryManager, Receiver, StockClerk, MechanicPicker, Auditor.
- Least privilege defaults.

## Acceptance Criteria
- Permissions enforced.
- Role changes audited.

## Integrations
- Integrates with HR/security identity and role assignment.

## Data / Entities
- Role, Permission, RolePermission, UserRole, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

BACKEND STORY REFERENCES (FOR REFERENCE ONLY)

----------------------------------------------------------------------------------------------------

Backend matches (extracted from story-work):


[1] backend/23/backend.md

    Labels: type:story, domain:inventory, status:ready-for-dev, agent:story-authoring, agent:inventory, agent:security

----------------------------------------------------------------------------------------------------

Backend Story Full Content:

### BACKEND STORY #1: backend/23/backend.md

------------------------------------------------------------

Title: [BACKEND] [STORY] Security: Define Inventory Roles and Permission Matrix
URL: https://github.com/louisburroughs/durion-positivity-backend/issues/23
Labels: type:story, domain:inventory, status:ready-for-dev, agent:story-authoring, agent:inventory, agent:security

(remaining backend reference omitted here for brevity in traceability section)

------------------------------------------------------------

====================================================================================================

END BACKEND REFERENCES

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #88: [FRONTEND] [STORY] Allocations: Reallocate Reserved Stock When Schedule Changes â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/88
File: ./scripts/story-work/frontend/88/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Allocations: Reallocate Reserved Stock When Schedule/Priority Changes (Deterministic + Audited)

### Primary Persona
Dispatcher

### Business Value
Keep inventory reservations aligned to the latest work schedule and priority so urgent jobs get stock first (without starving others), while making changes explainable (auditable) and keeping ATP accurate.

---

## 2. Story Intent

### As a / I want / So that
**As a** Dispatcher,  
**I want** the POS UI to trigger and display deterministic reallocation of reserved stock when a work orderâ€™s schedule, priority, or inventory-waiting status changes,  
**so that** I can trust reservations/ATP reflect operational reality and understand why allocations changed.

### In-scope
- A UI workflow to **initiate** reallocation for a specific stock item or work order context (manual trigger).
- A UI view to **review results** of the most recent reallocation:
  - which work orders gained/lost allocations
  - before/after reserved quantities
  - reason code and trigger metadata
  - ATP before/after (for impacted stock item(s))
- A UI view to **inspect allocation ordering inputs** (read-only): basePriority, effectivePriority, dueDateTime, waitingSince, scheduleStartTime, createdAt tie-breaker values (as available from backend).
- Frontend error handling for validation/permission/concurrency failures.

### Out-of-scope
- Implementing the allocation algorithm in the frontend (Inventory backend is SoR).
- Editing WorkExec priority or ShopMgr schedule fields (handled in their domains).
- Defining/altering policy values (agingGracePeriod/interval/step/maxEffectivePriority) unless backend exposes them read-only.
- Automatic reallocation triggers driven purely by frontend polling (backend event-driven triggers remain backend responsibility).

---

## 3. Actors & Stakeholders
- **Dispatcher (primary user):** wants allocations to reflect priorities/schedule; needs explanations.
- **Inventory Manager (secondary):** may review audit/reasons for stock movement decisions.
- **Technician / Shop floor user (indirect):** impacted by stock availability but not configuring policy here.
- **System (Inventory domain backend):** computes allocations, ATP, audit records (authoritative).
- **System (Work Execution / Shop Management):** sources schedule/priority changes (context only).

---

## 4. Preconditions & Dependencies
- User is authenticated in the Moqui frontend.
- Backend provides endpoints/services to:
  - view allocations for a stock item and/or work order
  - request a reallocation (manual trigger) with a reason code
  - view reallocation audit entries / allocation change history
  - view ATP/onHand/allocated summary for the stock item
- Permissions exist and are enforced by backend for â€œreallocate allocationsâ€ and for â€œview allocation auditâ€.
- Data exists: at least one `stockItemId`, competing `workOrderId`s, and existing `Allocation` records.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From an Inventory item detail screen: â€œAllocationsâ€ tab/panel â†’ â€œReallocate nowâ€
- From a Work Order context (if present in frontend nav): â€œInventory Allocationsâ€ panel â†’ â€œReallocate impacted itemsâ€
- From a global Inventory â†’ Allocations search/list screen â†’ select `stockItemId` â†’ â€œReallocate nowâ€

### Screens to create/modify
1. **New/Modify Screen:** `Inventory/Allocation/AllocationList.xml` (or equivalent inventory allocations screen)
   - List allocations by `stockItemId` and show ATP summary.
2. **New Modal/Dialog Screen or Subscreen:** `Inventory/Allocation/ReallocateDialog.xml`
   - Confirm action and submit reason/notes (if supported).
3. **New/Modify Screen:** `Inventory/Allocation/AllocationAudit.xml`
   - Timeline/table of allocation change audits for a `stockItemId` (and optionally workOrderId filter).
4. **Optional Subscreen:** `Inventory/Allocation/ReallocationRunResult.xml`
   - Show â€œrunâ€ summary if backend returns a runId/result payload.

> Moqui pattern: use a screen with transitions invoking services; results displayed via context from service call or via redirect with parameters (e.g., runId).

### Navigation context
- Inventory top-level menu: `Inventory â†’ Allocations`
- Within Stock Item detail: `Stock Item â†’ Allocations`

### User workflows
**Happy path (manual reallocation):**
1. Dispatcher opens Allocations for a stock item.
2. Reviews current allocations and ATP.
3. Clicks â€œReallocate nowâ€.
4. Confirms reason (e.g., SYSTEM_REBALANCE or SCHEDULE_CHANGE if user is initiating due to known change).
5. UI submits reallocation request.
6. UI shows success banner and refreshes allocations + ATP + latest audit entries.

**Alternate path (view why allocations changed):**
1. Dispatcher opens Allocation Audit for a stock item.
2. Filters by reason code (e.g., PRIORITY_CHANGE).
3. Opens an audit row to see before/after allocation state and trigger metadata.

---

## 6. Functional Behavior

### Triggers (frontend)
- **Manual trigger** initiated by user action (â€œReallocate nowâ€).
- **Refresh trigger** after reallocation completes: reload allocations, ATP, and audit list.

> Non-manual triggers (priority/schedule events) are backend-driven; frontend must support reviewing their audit trails and seeing updated allocations.

### UI actions
- Search/select `stockItemId` (required to scope the reallocation).
- â€œReallocate nowâ€ opens confirmation dialog:
  - shows impacted stock item identifier/name
  - shows warning: â€œThis may change which work orders hold reservationsâ€
  - collects required inputs for backend request (see Open Questions)
- After submit:
  - show spinner/progress until response
  - on success: show summary + refresh data panes
  - on failure: show error mapping (validation vs permission vs conflict)

### State changes (UI-local)
- Dialog open/close state
- Loading states for allocations/audit/ATP blocks
- Last run timestamp (derived from response or latest audit time)

### Service interactions
- Call backend service/API to initiate reallocation for `stockItemId` (and optionally `workOrderId`).
- Fetch updated:
  - allocations list
  - ATP summary
  - audit entries for the change (by stockItemId, optionally by runId or occurredAt since submit)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `stockItemId` must be present to run reallocation.
- Reason code must be provided **if backend requires it** (backend story says audit reason is required; manual trigger should supply `MANUAL_OVERRIDE` or `SYSTEM_REBALANCE`â€”see Open Questions).
- Quantity fields are read-only in this UI (no partial allocations or manual quantity edits in scope).

### Enable/disable rules
- â€œReallocate nowâ€ button is disabled when:
  - user lacks permission (backend indicates 403; UI should hide/disable if permission info is available)
  - required `stockItemId` not selected
  - a reallocation request is in-flight (prevent double-submit)
- Audit view is disabled/hidden if user lacks audit permission.

### Visibility rules
- Show ATP summary for selected stock item:
  - onHand, totalAllocated, ATP (backend-provided preferred)
- Show a â€œNo allocationsâ€ empty state if none exist.
- Show â€œNo audit entriesâ€ if none exist.

### Error messaging expectations
- 400 validation error: show field-level message in dialog (e.g., missing reasonCode)
- 403 forbidden: â€œYou donâ€™t have permission to reallocate allocations.â€
- 404 not found: â€œStock item not found or no longer available.â€
- 409 conflict: â€œAllocations changed while you were viewing. Refresh and try again.â€
- 5xx: â€œReallocation failed due to a server error. Try again later.â€ Include correlation/trace id if provided.

---

## 8. Data Requirements

### Entities involved (frontend view model)
- `Allocation`
- `AuditLog` / `ItemAllocationAudit` (name TBD)
- `StockItem` summary (for name/sku display)
- (Read-only) work order sorting inputs:
  - basePriority
  - effectivePriority
  - dueDateTime
  - waitingSince
  - scheduleStartTime
  - workOrderCreatedAt

### Fields (type, required, defaults)

**Allocation (display)**
- `allocationId` (UUID, required, read-only)
- `workOrderId` (UUID, required, read-only)
- `stockItemId` (UUID, required, read-only)
- `quantityReserved` (Decimal/Integer, required, read-only)
- `updatedAt` (Timestamp, read-only)

**ATP Summary (display)**
- `onHand` (Decimal, read-only)
- `totalAllocated` (Decimal, read-only)
- `availableToPromise` (Decimal, read-only)

**Audit (display)**
- `reasonCode` (enum string, required)
- `previousAllocationState` (JSON/string, required)
- `newAllocationState` (JSON/string, required)
- `triggeredBy` (`USER|SYSTEM`, required)
- `triggerReferenceId` (string, optional)
- `occurredAt` (timestamp, required)

**Reallocation request (input)**
- `stockItemId` (UUID, required)
- `reasonCode` (enum string, required if backend requires)
- `note` (string, optional) (only if backend supports)

### Read-only vs editable by state/role
- Dispatcher can **initiate** reallocation (permission-gated).
- Dispatcher can **view** allocations; audit view permission may be more restricted (TBD).
- No editing of allocation quantities or priorities in this story.

### Derived/calculated fields (UI)
- â€œChange directionâ€ per work order: compare before/after allocations if response includes both; otherwise derive by comparing refreshed list vs previous client snapshot (marked as best-effort only).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contracts are not fully specified in provided inputs; below is the **required frontend-facing contract shape**. If backend differs, update this story or add adapter logic.

### Load/view calls
1. `GET /inventory/allocations?stockItemId=...`
   - Returns allocations list + (optional) sorting inputs per work order.
2. `GET /inventory/stockItem/atp?stockItemId=...`
   - Returns onHand/totalAllocated/ATP (preferred as a single object).
3. `GET /inventory/allocations/audit?stockItemId=...&from=...&to=...&reasonCode=...`
   - Returns audit entries sorted by occurredAt desc.

### Create/update calls
- none

### Submit/transition calls
1. `POST /inventory/allocations/reallocate`
   - Request: `{ stockItemId, reasonCode, note?, triggerReferenceId? }`
   - Response (minimum): `{ status: "SUCCESS", occurredAt, correlationId? }`
   - Response (preferred): `{ runId, impactedWorkOrders[], atpBefore, atpAfter, correlationId }`

### Error handling expectations
- 400: structured field errors `{ errors: [{field, message, code}] }`
- 403: forbidden
- 409: conflict (concurrency or stale inputs)
- 5xx: server error with `correlationId` echoed to UI if present

---

## 10. State Model & Transitions

### Allowed states
- No new domain state machine introduced in frontend.
- UI state:
  - `idle`
  - `loading`
  - `submittingReallocation`
  - `success`
  - `error`

### Role-based transitions
- Only users with backend permission may transition UI into â€œsubmittingReallocationâ€ (button enabled).

### UI behavior per state
- `loading`: show skeleton/loading indicators for allocations/audit/ATP blocks
- `submittingReallocation`: disable inputs and show spinner on confirm button
- `success`: toast + refresh lists; optionally deep-link to audit entry/run
- `error`: show inline error in dialog or page-level alert depending on failure phase

---

## 11. Alternate / Error Flows

1. **Empty state: no allocations exist**
   - Show empty state with guidance: â€œNo reservations for this stock item.â€
   - Reallocate action still allowed only if backend supports reallocating including unallocated demand; otherwise disable and explain (Open Question).

2. **Validation failure (missing reasonCode)**
   - Keep dialog open, highlight reasonCode field, show backend message.

3. **Concurrency conflict (409)**
   - Show message and offer â€œRefresh allocationsâ€ action.

4. **Unauthorized (403)**
   - Hide/disable reallocate controls; show â€œInsufficient permissionsâ€ banner if user navigates directly.

5. **Backend returns success but audit not immediately visible**
   - After submit, refresh audit with retry/backoff (bounded: e.g., 3 attempts over ~2s) only if backend is eventually consistent; otherwise single refresh. (See Applied Safe Defaults.)

---

## 12. Acceptance Criteria

### Scenario 1: Dispatcher manually triggers reallocation for a stock item
**Given** I am logged in as a Dispatcher with permission to reallocate allocations  
**And** I am viewing the Allocations page for a selected stock item  
**When** I click â€œReallocate nowâ€  
**And** I confirm the action with a valid reason code  
**Then** the system submits a reallocation request for that stock item  
**And** I see a success confirmation  
**And** the allocations list refreshes and reflects the latest backend state  
**And** the ATP summary refreshes.

### Scenario 2: Deterministic outcome is visible via stable refreshed results
**Given** a stock item has competing work orders and limited on-hand quantity  
**When** I trigger reallocation twice without any intervening data changes  
**Then** the allocations shown after each run are identical  
**And** the audit shows two entries (or one idempotent entry if backend dedupes) with the supplied reason code.

### Scenario 3: Audit trail is viewable with reason and before/after state
**Given** allocations changed due to a schedule or priority change (system-triggered)  
**When** I open the Allocation Audit view for the stock item  
**Then** I can see an audit entry with a reason code (e.g., `SCHEDULE_CHANGE` or `PRIORITY_CHANGE`)  
**And** the entry displays before/after allocation state and occurredAt timestamp.

### Scenario 4: Full allocation only is reflected in UI
**Given** remaining available quantity is insufficient to fully satisfy a work orderâ€™s required quantity  
**When** I view allocations after a reallocation  
**Then** that work order shows no allocation for the stock item (quantityReserved absent/0 per backend contract)  
**And** the UI does not show any partial quantity reserved for that work order.

### Scenario 5: Permission enforcement on reallocation
**Given** I am logged in without permission to reallocate allocations  
**When** I navigate to the Allocations page  
**Then** I do not see (or cannot interact with) the â€œReallocate nowâ€ action  
**And** if I attempt to call reallocation (direct URL/action), I receive a forbidden error and see an appropriate message.

### Scenario 6: Concurrency conflict handling
**Given** I am viewing allocations for a stock item  
**And** allocations change on the backend before I submit reallocation  
**When** I submit the reallocation request  
**And** the backend responds with HTTP 409 conflict  
**Then** the UI shows a conflict message  
**And** provides a one-click refresh to reload allocations/audit/ATP.

---

## 13. Audit & Observability

### User-visible audit data
- Allocation Audit screen shows:
  - reasonCode
  - triggeredBy
  - triggerReferenceId (if present)
  - occurredAt
  - before/after allocation state (render JSON in readable format)

### Status history
- Show audit list as immutable history (no edit/delete in UI).

### Traceability expectations
- Display backend-provided `correlationId` (or request id) on error states and optionally on success details for support troubleshooting.
- Frontend logs (console/dev logging per project convention) must not include sensitive data; include correlationId where available.

---

## 14. Non-Functional UI Requirements
- **Performance:** allocations/audit pages should load within 2 seconds for up to 200 allocation rows (pagination supported).
- **Accessibility:** all actions keyboard accessible; dialogs have focus trap; error messages announced via ARIA.
- **Responsiveness:** usable on tablet widths used on shop floor; tables collapse to stacked rows when narrow.
- **i18n/timezone:** display timestamps in user locale/timezone; preserve backend UTC timestamps in payloads.

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Provide standard empty states for allocations/audit lists; safe because it does not alter domain logic. (Impacted: UX Summary, Alternate Flows)
- SD-UI-PAGINATION: Paginate allocation/audit tables (default page size 25) to prevent slow rendering; safe UI ergonomics only. (Impacted: UX Summary, Non-Functional)
- SD-ERR-MAP-HTTP: Map common HTTP errors (400/403/404/409/5xx) to consistent banners/toasts; safe because it follows standard transport semantics. (Impacted: Business Rules, Error Flows, Service Contracts)
- SD-UI-DOUBLE-SUBMIT-GUARD: Disable submit while request in-flight; safe to prevent duplicate user actions. (Impacted: Functional Behavior)
- SD-AUDIT-REFRESH-RETRY: If audit is eventually consistent, retry audit fetch up to 3 times with short backoff after successful reallocation; safe because it only affects UI freshness and is bounded. (Impacted: Alternate Flows, UX)

---

## 16. Open Questions

1. **Backend API contracts:** What are the exact Moqui screen/service endpoints (service names, parameters, response shapes) for:
   - listing allocations by stockItemId
   - getting ATP summary
   - initiating reallocation
   - listing allocation audit entries (and filtering by runId/reasonCode)?
2. **Manual trigger reasonCode:** For a user-initiated reallocation, should the frontend always send `MANUAL_OVERRIDE`, or allow selecting from the enum (e.g., `SYSTEM_REBALANCE`, `SCHEDULE_CHANGE`)? Which are valid for USER-triggered actions?
3. **Scope of reallocation request:** Should the manual reallocation run be scoped by:
   - `stockItemId` only (recommended),
   - `workOrderId` only,
   - or both (reallocate impacted items for a work order)?
4. **Permissions:** What permission string(s) gate:
   - viewing allocations
   - viewing allocation audit
   - initiating reallocation?
5. **Audit consistency model:** After a successful reallocation call, is the audit entry guaranteed to be immediately queryable, or is it eventually consistent?
6. **Display of â€œrequired quantityâ€:** Does backend expose each work orderâ€™s required quantity for the stock item (needed to clearly show â€œfull allocation onlyâ€ outcomes), or do we display only reserved quantities?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Allocations: Reallocate Reserved Stock When Schedule Changes â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/88


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Allocations: Reallocate Reserved Stock When Schedule Changes
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/88
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Allocations: Reallocate Reserved Stock When Schedule Changes

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Dispatcher**, I want reallocations so that reservations reflect updated schedule and priorities.

## Details
- Reallocation by priority and due time.
- Rules prevent starvation (optional).

## Acceptance Criteria
- Allocations updated deterministically.
- Audit includes reason.
- ATP updated.

## Integrations
- Workexec triggers priority changes; shopmgr schedule updates due times.

## Data / Entities
- Allocation, PriorityPolicy, AuditLog

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #89: [FRONTEND] [STORY] Allocations: Handle Shortages with Backorder or Substitution Suggestion â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/89
File: ./scripts/story-work/frontend/89/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] Allocations: Handle Shortages with Backorder or Substitution Suggestion

### Primary Persona
Service Advisor

### Business Value
Prevent work stoppage and reduce customer wait time by presenting actionable shortage resolutions (substitute, external availability, backorder) when allocation quantity exceeds available-to-promise (ATP), while capturing an auditable decision that downstream domains can act on.

---

## 2. Story Intent

### As a / I want / So that
**As a** Service Advisor,  
**I want** shortage handling during part allocation that suggests substitutes, external availability, or backorder options,  
**so that** I can choose how to proceed and keep work moving with a recorded, auditable decision.

### In-scope
- Detecting/displaying an allocation shortage in the POS UI when ATP is insufficient.
- Calling a Moqui backend endpoint to retrieve shortage resolution options in deterministic order.
- Rendering substitute / external availability / backorder options with ranking/sorting as provided (or per explicit rules below).
- Capturing the userâ€™s decision (including cancel) and submitting it to backend for audit/event emission.
- UI degradation behavior when dependent option categories fail (banner + remaining options).
- Persisting and showing â€œshortage pendingâ€ state on the affected allocation line until resolved (UI representation; backend is SoR).

### Out-of-scope
- Defining substitution rules (owned by Product domain).
- Computing external availability (owned by Positivity domain).
- Updating work order/estimate contents (owned by Work Execution domain) beyond submitting the resolution decision.
- Inventory valuation/costing decisions beyond displaying provided cost impact fields.
- Backorder lead-time sourcing logic beyond displaying provided fields (SoR backend).

---

## 3. Actors & Stakeholders
- **Service Advisor (primary user):** resolves shortages during allocation.
- **Inventory service (backend / Moqui services):** detects shortage, aggregates options, records decision.
- **Product domain (dependency):** provides approved substitutes + pricing deltas.
- **Positivity domain (dependency):** provides external availability sources.
- **Work Execution domain (consumer):** receives decision outcome to update estimate/WO.
- **Audit/Reporting:** requires immutable record of decision and context.

---

## 4. Preconditions & Dependencies
- User is authenticated in POS frontend and has access to a Work Order allocation workflow.
- The user attempts to allocate a part/product to a work order with a requested quantity.
- Backend can compute ATP for the requested item at the relevant location.
- Backend exposes:
  1) a â€œcheck shortage / get resolution optionsâ€ operation for an allocation attempt, and  
  2) a â€œsubmit shortage resolution decisionâ€ operation that records an audit event and returns updated allocation state.
- Dependency degradation rules exist (product timeout 800ms, positivity timeout 1200ms) and backend returns an indicator that some options could not be retrieved (for UI banner).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From the Work Order screen where parts are allocated (e.g., â€œAdd Partâ€ / â€œAllocateâ€ action on a parts line).
- From an existing parts line marked as â€œShortage/Pending Resolutionâ€ (re-open resolution modal).

### Screens to create/modify
- **Modify** Work Order Allocation screen (existing) to:
  - intercept allocation submit if backend returns shortage response
  - display shortage indicator on the line item
- **Create** a shortage resolution dialog/screen fragment:
  - `AllocationShortageResolve` (modal/popup or sub-screen)
- **Optional Create** read-only audit history panel for the allocation line (if not already present in WO UI)

### Navigation context
- User remains in the Work Order context (`workOrderId` in screen path or parameters).
- Shortage resolution occurs without losing unsaved work on the WO screen.

### User workflows
**Happy path**
1. Service Advisor requests allocation of part (qty > ATP).
2. UI receives shortage response with ordered options.
3. UI opens Shortage Resolution dialog showing:
   - shortage summary (requested, ATP, shortfall)
   - options grouped by type (Substitute, External, Backorder) in required order
4. User selects an option and confirms.
5. UI submits decision; on success:
   - dialog closes
   - affected parts line updates to resolved state (or updated SKU if substitute selected)
   - shortage flag cleared.

**Alternate paths**
- If product/positivity lookups fail or timeout: dialog shows banner â€œSome availability options could not be retrieved at this time.â€ and still shows remaining options.
- User cancels dialog: allocation line remains in â€œShortage/Pendingâ€ state; no decision recorded.
- No substitutes or external options: dialog shows only backorder option (if provided).

---

## 6. Functional Behavior

### Triggers
- User clicks â€œAllocateâ€ / â€œConfirm allocationâ€ for a part line with requested quantity.
- User opens shortage resolution dialog from a flagged line.

### UI actions
- On allocation submit:
  - Call backend allocation attempt endpoint.
  - If success without shortage: proceed as normal.
  - If shortage response: render shortage dialog with options.
- In shortage dialog:
  - Select option (single selection).
  - Confirm decision â†’ submit resolution.
  - Cancel â†’ close dialog, do not submit.

### State changes (frontend view-state)
- Parts line gets a `shortageFlag=true` and `shortageStatus=PENDING` when shortage detected (until resolved).
- After successful resolution submit:
  - update line to reflect backend result (resolved / backordered / substituted / external purchase requested)
  - clear pending shortage UI markers as appropriate.

### Service interactions
- `AllocationAttempt` (or equivalent) returns either:
  - normal allocation success, or
  - shortage payload including ordered `resolutionOptions` and shortage details.
- `SubmitShortageResolution` records decision (audit) and returns updated allocation/workorder line representation.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- User must select exactly one resolution option before enabling â€œConfirmâ€.
- If selected option is `SUBSTITUTE`, UI must display substitute metadata (quality tier, fitment confidence, priceDifference) and require explicit confirmation (same confirm button; no extra policy assumed).
- If selected option is `EXTERNAL_PURCHASE`, UI must display source, lead time, additional cost, confidence.
- If selected option is `BACKORDER`, UI must display lead time, source, confidence; **if missing lead time fields**, option must not be displayed (backend should omit; UI also guards and hides malformed option).

### Enable/disable rules
- Confirm button disabled until option selected.
- If backend indicates no valid options: show blocking error state and offer â€œCloseâ€ (cannot proceed).

### Visibility rules
- Show option categories only when present.
- Always show backorder only if present in response (do not fabricate).
- Show informational banner when backend indicates partial option retrieval failure.

### Error messaging expectations
- Validation errors: inline (â€œPlease select an option to continue.â€).
- Backend 4xx: show returned message; keep dialog open.
- Backend 5xx/network: show â€œUnable to resolve shortage right now. Try again.â€ with Retry button.

---

## 8. Data Requirements

### Entities involved (frontend concepts; backend SoR)
- WorkOrder (reference by `workOrderId`)
- Allocation Request/Line (reference by `allocationLineId` or equivalent)
- ShortageFlag (backend concept; UI representation)
- SubstituteSuggestion (backend option data)
- ExternalAvailabilityRef (backend option data)
- Audit event for decision (read-only display if surfaced)

### Fields (type, required, defaults)
**Shortage context (from backend)**
- `workOrderId` (string/UUID, required)
- `productId` or `partSku` (string, required) â€” see Open Questions about canonical identifier
- `requestedQuantity` (number/decimal, required)
- `atpQuantity` (number/decimal, required) (needed for UI display; not shown in backend example but implied)
- `shortfallQuantity` (number/decimal, required)

**ResolutionOption (list, required when shortage)**
- `type` (enum: `SUBSTITUTE` | `EXTERNAL_PURCHASE` | `BACKORDER`, required)
- `partSku` (string, required)
- For `SUBSTITUTE`:
  - `substituteProductId` (string/UUID, required)
  - `qualityTier` (enum, required)
  - `brand` (string, optional)
  - `fitmentConfidence` (enum, required)
  - `priceDifference.amount` (decimal, optional)
  - `priceDifference.currency` (string, optional)
  - `notes` (string, optional)
  - `availableQuantity` (number/decimal, optional/required?) (backend example includes it)
- For `EXTERNAL_PURCHASE`:
  - `sourceId` (string, required)
  - `sourceType` (enum, required)
  - `availableQuantity` (number/decimal, required)
  - `estimatedLeadTimeDays` (int, required)
  - `additionalCost.amount` (decimal, optional)
  - `additionalCost.currency` (string, optional)
  - `confidence` (enum, required)
- For `BACKORDER`:
  - `estimatedLeadTimeDays` (int, required)
  - `source` (string/enum, required)
  - `confidence` (enum, required)

**Decision submission (to backend)**
- `workOrderId` (required)
- `allocationLineId` (required) â€” if applicable
- `originalPartSku` and/or `originalProductId` (required)
- `decisionType` (required)
- `resultingPartSku` / `resultingProductId` (required for substitute; same as original for other types)
- `quantity` (required)
- `selectedExternalSourceId` (required for external purchase)
- `clientRequestId` (string, required for idempotency; frontend-generated UUID)

### Read-only vs editable by state/role
- All option data is read-only.
- Only editable input is option selection (and potentially quantity if backend allowsâ€”**not assumed**; see Open Questions).
- Only Service Advisor role (or any role with allocation permission) can submit decision; otherwise UI must show read-only and block submission.

### Derived/calculated fields
- UI may derive display-only:
  - `shortfallQuantity = requested - atp` if backend does not send (but backend story does; prefer backend).
  - â€œCost impactâ€ display from `priceDifference` / `additionalCost`.

---

## 9. Service Contracts (Frontend Perspective)

> Moqui implementation may wrap/route to backend services; frontend needs stable screen transitions + service names. Exact service names/endpoints are **not provided** in inputs, so these are placeholders that must map to actual Moqui services.

### Load/view calls
1. **Get current allocation line status** (if reopening dialog):
   - Input: `workOrderId`, `allocationLineId`
   - Output: current line data + shortage status + last shortage payload if available

### Create/update calls
2. **Attempt allocation** (may return shortage):
   - Input: `workOrderId`, `productId/partSku`, `quantity`, `locationId`, `clientRequestId`
   - Output (success): updated allocation line
   - Output (shortage): shortage details + ordered `resolutionOptions` + `partialOptionsWarning=true|false`

### Submit/transition calls
3. **Submit shortage resolution decision**
   - Input: decision payload fields above
   - Output: updated allocation line + resolved state; may include audit reference id

### Error handling expectations
- 400: validation errors displayed inline in dialog.
- 403: show â€œYou donâ€™t have permission to resolve shortages.â€ and disable confirm.
- Timeout/503 from dependent domains should not block; backend should return partial options + warning flag. UI shows banner and continues.
- Network failure calling backend: show retry affordance; do not lose selected option.

---

## 10. State Model & Transitions

### Allowed states (frontend-visible)
For an allocation line:
- `ALLOCATED` (normal)
- `SHORTAGE_PENDING` (shortage detected; decision not recorded)
- `SHORTAGE_RESOLVED_SUBSTITUTE`
- `SHORTAGE_RESOLVED_EXTERNAL`
- `SHORTAGE_RESOLVED_BACKORDER`

> Backend is SoR for actual statuses; UI should map from backend fields.

### Role-based transitions
- Service Advisor (authorized) may transition:
  - `SHORTAGE_PENDING` â†’ one of resolved states via submit decision
- Unauthorized user:
  - cannot submit; can view options if backend allows read

### UI behavior per state
- `SHORTAGE_PENDING`: show badge/flag on line + â€œResolveâ€ action opens dialog.
- Resolved states: show resolution summary (type and key details like resulting SKU/source/lead time).

---

## 11. Alternate / Error Flows

### Validation failures
- No option selected â†’ prevent submit and show inline message.
- Malformed option (missing required fields) â†’ hide that option and log client-side warning (no PII); if all hidden, show blocking error.

### Concurrency conflicts
- If allocation line changed since shortage was presented (backend returns 409 conflict):
  - UI shows â€œThis allocation changed. Refresh options.â€ with Refresh button that re-calls attempt/refresh endpoint.

### Unauthorized access
- Backend 403 on submit:
  - dialog remains open in read-only mode; show permission message.

### Empty states
- No options returned:
  - show â€œNo resolution options availableâ€ and guidance to contact manager; provide Close.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Shortage flagged and options shown in deterministic order
**Given** a Service Advisor is allocating a part to a work order  
**And** the requested quantity exceeds ATP for that part at the work location  
**When** the user submits the allocation  
**Then** the UI must display a shortage resolution dialog  
**And** the shortage must be visibly flagged on the allocation line as pending  
**And** resolution options must be presented in this category order: Substitute, External availability, Backorder (when present).

### Scenario 2: Only backorder available
**Given** a shortage occurs  
**And** backend returns only a BACKORDER option  
**When** the shortage dialog is shown  
**Then** only the backorder option is displayed  
**And** selecting it enables Confirm  
**And** confirming submits the decision and updates the line to a backorder-resolved state.

### Scenario 3: Dependent option category fails but flow continues
**Given** a shortage occurs  
**And** backend indicates partial option retrieval failure (e.g., substitutes omitted due to timeout)  
**When** the shortage dialog is shown  
**Then** the UI must show the banner message â€œSome availability options could not be retrieved at this time.â€  
**And** the UI must still allow selecting and confirming among remaining options.

### Scenario 4: User cancels without decision
**Given** a shortage dialog is displayed  
**When** the user clicks Cancel/Close  
**Then** no decision submission call is made  
**And** the allocation line remains in a shortage pending state.

### Scenario 5: Submit decision is auditable (frontend evidence)
**Given** a shortage dialog is displayed with options  
**When** the user selects an option and confirms  
**Then** the UI must call the submit-decision service with workOrderId, original item identifier, quantity, decisionType, and clientRequestId  
**And** on success the UI must show a resolution summary on the line (type + key details) suitable for later auditing.

### Scenario 6: Unauthorized submit is blocked
**Given** the user lacks permission to resolve shortages  
**When** the user attempts to confirm a selected option  
**Then** the UI must display a permission error  
**And** must not mark the shortage as resolved in the UI.

---

## 13. Audit & Observability

### User-visible audit data
- On resolved allocation line, display:
  - decision type (Substitute/External/Backorder)
  - resulting SKU/product (if substitute)
  - external source + lead time (if external)
  - backorder lead time + source (if backorder)
  - timestamp and actor if backend supplies it (preferred)

### Status history
- If backend exposes decision history for the line, UI provides a â€œView historyâ€ expandable section listing immutable events.

### Traceability expectations
- Frontend includes `clientRequestId` on attempt and submit calls.
- UI logs (client-side) include correlation/clientRequestId for troubleshooting (no sensitive data).

---

## 14. Non-Functional UI Requirements
- **Performance:** shortage dialog should render within 200ms after response received; avoid N+1 calls (single aggregated shortage response).
- **Accessibility:** dialog is keyboard navigable; radio group has accessible labels; banner is announced to screen readers.
- **Responsiveness:** usable on tablet width typical for POS.
- **i18n/timezone/currency:** display currency codes provided by backend; timestamps shown in user locale/timezone if present.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging when no options are returned; qualifies as UI ergonomics. Impacted sections: UX Summary, Alternate/Error Flows.
- SD-UX-RETRY: Provide Retry action on transient backend/network failures; qualifies as standard error-handling mapping. Impacted sections: Service Contracts, Alternate/Error Flows.
- SD-OBS-CORRELATION-ID: Generate and pass `clientRequestId` UUID for idempotency/traceability; qualifies as observability boilerplate. Impacted sections: Data Requirements, Audit & Observability, Service Contracts.

---

## 16. Open Questions
1. **Canonical identifier:** Should the frontend use `productId` (UUID) or `partSku` as the primary identifier for allocation + shortage resolution payloads (or both)? Backend reference shows SKU in some places and productId in integration calls.
2. **Allocation line identity:** What is the backendâ€™s identifier for the specific allocation being resolved (`allocationLineId`, `estimateLineId`, etc.) and is it required on submit?
3. **Backorder option omission:** Backend rule says â€œomit backorder option if no lead time source exists.â€ Should the frontend ever show a generic backorder without lead time, or must it strictly hide it if missing required fields?
4. **Decision persistence on cancel:** When user cancels, should the backend record a â€œcancelled/abortedâ€ audit event, or must it record nothing (backend story says no decision recorded)?
5. **Sorting responsibility:** Are options already sorted/ranked by backend (preferred), or must frontend implement intra-category sorting rules (lead time asc, cost impact asc, quality tier desc)? If frontend must sort, confirm exact fields for lead time/cost across option types.
6. **Permissions:** What specific permission(s) gate resolving shortages in the Moqui layer (e.g., `inventory.allocation.resolveShortage`), and should users without it be prevented from even seeing options?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Allocations: Handle Shortages with Backorder or Substitution Suggestion â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/89


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Allocations: Handle Shortages with Backorder or Substitution Suggestion
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/89
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Allocations: Handle Shortages with Backorder or Substitution Suggestion

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Service Advisor**, I want shortage handling so that work proceeds with backorders or approved substitutes.

## Details
- If ATP insufficient: propose external availability or substitute options.
- Link to product substitution rules.

## Acceptance Criteria
- Shortage flagged.
- Suggested actions returned.
- Decision captured and auditable.

## Integrations
- Product provides substitution/pricing; Positivity provides external availability; workexec updates estimate/WO.

## Data / Entities
- ShortageFlag, SubstituteSuggestion, ExternalAvailabilityRef

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #90: [FRONTEND] [STORY] Counts: Approve and Post Adjustments from Cycle Count â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/90
File: ./scripts/story-work/frontend/90/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Counts: Approve and Post Adjustments from Cycle Count

### Primary Persona
Inventory Manager (and Tier-2 Approver: Inventory Controller/Director)

### Business Value
Ensure cycle-count variances are posted to inventory on-hand only with appropriate policy-driven approvals, producing immutable ledger entries and a complete audit trail.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Inventory Manager (and authorized approver),
- **I want** to review, approve, or reject cycle-count-generated inventory adjustments before they are posted when they exceed policy thresholds,
- **So that** shrink/corrections are controlled, auditable, and posted accurately to on-hand inventory.

### In-scope
- Frontend screens to:
  - List adjustments requiring approval (approval queue)
  - View adjustment details (including computed variances and required tier)
  - Approve (post) or reject (with reason) adjustments when authorized
  - View posted outcome (ledger reference) and audit/status history
- Permission-aware UI gating (hide/disable actions when unauthorized)
- Error handling and user feedback for validation/authorization/concurrency failures
- In-app pending approvals indicator entry point (minimal v1)

### Out-of-scope
- Creating cycle counts, computing variances, and generating adjustments (handled by prior flow/backend)
- Defining/configuring threshold policies (admin/config screens)
- Email digests/escalations (optional per backend reference; not implemented unless contract exists)
- Accounting/reporting downstream processing beyond showing status (no financial policy decisions in UI)

---

## 3. Actors & Stakeholders
- **Inventory Manager (Tier 1 Approver)**: Reviews and approves/rejects adjustments requiring Tier 1.
- **Inventory Controller/Director (Tier 2 Approver)**: Approves higher-risk adjustments requiring Tier 2.
- **Inventory Clerk (Read-only)**: May view adjustments but cannot approve/reject (exact permissions TBD).
- **System (Inventory Domain/Moqui services)**: Enforces thresholds, required tier, state transitions, ledger posting, audit.
- **Accounting (Downstream)**: May consume outbox events; frontend only surfaces that posting occurred (no accounting logic).

---

## 4. Preconditions & Dependencies
- A cycle count has completed and produced one or more **InventoryAdjustment** records.
- Backend provides:
  - Adjustment list and detail read endpoints/services
  - Approve (post) action endpoint/service
  - Reject action endpoint/service (requires rejection reason)
  - Status/history/audit fields in responses
- User is authenticated and authorization/permissions are enforceable by backend; frontend can query effective permissions or infer via 403.
- Reason codes for rejection (or free-text rejection reason) availability is defined by backend contract (currently unclear).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Inventory â†’ Counts â†’ Adjustment Approvals**
- Optional secondary entry: notification badge/link â€œPending approvals (N)â€ (if notification data is available)

### Screens to create/modify (Moqui)
1. **`Inventory/Count/AdjustmentApprovalQueue.xml`** (new)
   - List/table of adjustments with status `PENDING_APPROVAL`
   - Filters (safe defaults): location/site, SKU/stockItem, required tier, aging, variance magnitude
2. **`Inventory/Count/AdjustmentApprovalDetail.xml`** (new)
   - Read-only adjustment details + computed variance fields
   - Action panel: Approve/Post, Reject (with rejectionReason), Back
   - Status/audit history panel (read-only)
3. Optional: add link/badge in an existing Inventory dashboard screen (if one exists in repo conventions)

### Navigation context
- From queue screen, selecting a row navigates to detail screen for that `adjustmentId`.
- After action:
  - Approve/Post: remain on detail, refresh and show new status `POSTED` and ledger entry reference (if returned), and disable further actions.
  - Reject: remain on detail, refresh and show status `REJECTED`, display rejection reason, disable further actions.
  - If auto-approved by policy, queue should not show it; detail view should show `AUTO_APPROVED`/`POSTED` state if navigated directly.

### User workflows
- **Happy path (Tier 1)**: Open queue â†’ open adjustment â†’ review variances â†’ Approve â†’ see posted confirmation and ledger reference.
- **Happy path (Tier 2)**: Same, but only Tier 2 can approve when required tier is Tier 2.
- **Alternate**: Reject with reason â†’ see rejected status.
- **Alternate**: Attempt action without permission â†’ UI blocked and/or backend returns 403 with message.
- **Alternate**: Posting fails backend-side (stock inactive/not found) â†’ show FAILED with error details if provided.

---

## 6. Functional Behavior

### Triggers
- User navigates to approval queue.
- User selects an adjustment to view.
- User clicks Approve/Post or Reject.

### UI actions
**Queue**
- Load pending adjustments list.
- Allow filtering/sorting.
- Row click â†’ navigate to detail.

**Detail**
- Load adjustment by ID.
- Show:
  - Stock item identifiers (SKU/name as available)
  - Location/site as available
  - varianceQty, onHandQtyAtProposal, unitCost
  - derived: unitVariance, valueVariance, percentVariance
  - requiredApprovalTier
  - policyVersion
  - status and timestamps; createdBy; approvedBy if any
- Actions:
  - **Approve/Post** button
  - **Reject** button + required input (rejectionReason)
  - Buttons enabled/disabled based on status and authorization

### State changes (UI perspective)
- `PENDING_APPROVAL` â†’ (Approve) â†’ `POSTED` (or `FAILED` on error)
- `PENDING_APPROVAL` â†’ (Reject) â†’ `REJECTED`
- `AUTO_APPROVED` and `POSTED` and `REJECTED` are treated as immutable read-only states.

### Service interactions
- Read queue and detail via Moqui service calls (or REST via Moqui screens if thatâ€™s repo convention).
- Call approve/reject services; on success, refresh detail and update queue (remove item if no longer pending).

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Reject requires **rejectionReason** (non-empty). Enforce client-side required validation and backend validation.
- Approve requires:
  - adjustment status is `PENDING_APPROVAL`
  - current user has permission for required tier (frontend should pre-check if possible; backend is source of truth)

### Enable/disable rules
- Approve/Post button enabled only when:
  - status = `PENDING_APPROVAL`
  - user authorized for requiredApprovalTier
- Reject button enabled only when:
  - status = `PENDING_APPROVAL`
  - user authorized for requiredApprovalTier (or separate reject permission if backend differentiatesâ€”unclear)
- If status in (`POSTED`, `REJECTED`, `FAILED`, `AUTO_APPROVED`), all mutation actions disabled.

### Visibility rules
- Queue screen:
  - Only show adjustments in `PENDING_APPROVAL` (default), with optional filter for other statuses (safe default: allow toggling to â€œAll statusesâ€ if endpoint supports it; otherwise pending only).
- Detail screen:
  - Always show read-only fields; show action panel only if user has any approval capability and status is `PENDING_APPROVAL`.

### Error messaging expectations
- 403: â€œYou do not have permission to approve/reject this adjustment.â€
- 400 validation: show specific field errors (e.g., â€œRejection reason is required.â€)
- 409 concurrency: â€œThis adjustment was updated by another user. Refreshingâ€¦â€ and auto-refresh detail.
- 500/unknown: generic error + correlation/trace id if available.

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `InventoryAdjustment` (primary)
- `InventoryLedgerEntry` (read-only reference after posting)
- `ReasonCode` (only if rejection uses a coded list rather than free text; unclear)
- `ApprovalRecord` / audit history (if backend exposes explicit approval records vs embedded audit fields; unclear)

### Fields (type, required, defaults)
**InventoryAdjustment (display)**
- `adjustmentId` (UUID, required, read-only)
- `stockItemId` (UUID, required, read-only)
- `reasonCodeId` (UUID, required?, read-only) â€” cycle count shrink/gain; display label if available
- `varianceQty` (decimal, required, read-only)
- `unitCost` (decimal money, required? read-only, 4+ decimals)
- `onHandQtyAtProposal` (decimal, required, read-only)
- Derived (read-only):
  - `unitVariance` (decimal)
  - `valueVariance` (decimal money)
  - `percentVariance` (decimal)
- Workflow:
  - `status` enum (required)
  - `requiredApprovalTier` enum (nullable when not pending)
  - `policyVersion` (string)
- Audit:
  - `createdByUserId`, `approvedByUserId` (UUID)
  - `createdAt`, `updatedAt` (timestamp)
  - `rejectionReason` (string, required only when rejected)
  - `failureMessage` or `errorDetails` (string, if status FAILED; backend contract unclear)

**InventoryLedgerEntry (display)**
- `ledgerEntryId` (UUID)
- `type` = `ADJUST_CYCLE_COUNT`
- `changeInQuantity`, `quantityAfter`, `postedAt`

### Read-only vs editable
- All adjustment fields read-only except:
  - `rejectionReason` input (editable) when rejecting a `PENDING_APPROVAL` item.

### Derived/calculated fields
- UI should treat derived fields as read-only and sourced from backend (do not recompute thresholds/tiers client-side).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not provided in this issue; below are required capabilities, not exact endpoints.

### Load/view calls
- **List pending approvals**
  - Input: optional filters (site/location, SKU, tier, date range)
  - Output: list of `InventoryAdjustment` summary fields including `adjustmentId`, identifiers, variances, tier, status, timestamps
- **Get adjustment detail**
  - Input: `adjustmentId`
  - Output: full `InventoryAdjustment` + (optional) related ledger entry + audit/status history

### Create/update calls
- None (frontend does not create adjustments in this story)

### Submit/transition calls
- **Approve/Post adjustment**
  - Input: `adjustmentId`
  - Output: updated `InventoryAdjustment` (status POSTED or FAILED) and ledger reference if posted
  - Errors:
    - 403 unauthorized tier/permission
    - 409 concurrency
    - 422/400 invalid state (not pending)
- **Reject adjustment**
  - Input: `adjustmentId`, `rejectionReason` (string) OR `rejectionReasonCodeId` (if coded)
  - Output: updated `InventoryAdjustment` status REJECTED
  - Errors: 400 missing reason, 403, 409, 422/400 invalid state

### Error handling expectations
- Moqui screen should surface service error messages in a standard error banner and field-level errors for rejectionReason.
- On 409, prompt refresh and reload.

---

## 10. State Model & Transitions

### Allowed states (as displayed)
- `PENDING_APPROVAL`
- `AUTO_APPROVED`
- `POSTED`
- `REJECTED`
- `FAILED`

### Role-based transitions (UI)
- From `PENDING_APPROVAL`:
  - Approve/Post: allowed only for users authorized for `requiredApprovalTier`
  - Reject: allowed only for users authorized for `requiredApprovalTier` (unless backend distinguishes; TBD)
- No transitions allowed from `AUTO_APPROVED`, `POSTED`, `REJECTED`, `FAILED` in UI.

### UI behavior per state
- `PENDING_APPROVAL`: show action panel (permission gated)
- `AUTO_APPROVED`: show as informational; no actions
- `POSTED`: show ledger entry reference; no actions
- `REJECTED`: show rejectionReason; no actions
- `FAILED`: show failure message and guidance (â€œContact support or retry if allowedâ€)â€”retry behavior is **not** assumed; only show if backend exposes retry capability.

---

## 11. Alternate / Error Flows

### Validation failures
- Reject without rejectionReason:
  - Client blocks submit; if server returns 400, display field error.

### Concurrency conflicts
- If another user posts/rejects while viewing:
  - Approve/Reject returns 409 or â€œinvalid stateâ€
  - UI reloads detail and informs user the item is no longer pending.

### Unauthorized access
- User can view queue/detail but cannot act:
  - Action buttons hidden/disabled; if direct submit attempted, show 403 message.

### Empty states
- Queue has zero items:
  - Display â€œNo adjustments pending approvalâ€ and show last refreshed time.

### Backend posting failure
- Approve returns status `FAILED`:
  - Display backend-provided error details if present; keep item out of queue if it is no longer pending.

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View pending approval queue
**Given** I am an authenticated user with access to Inventory Counts  
**When** I navigate to â€œAdjustment Approvalsâ€  
**Then** I see a list of adjustments in status `PENDING_APPROVAL`  
**And** each row shows stock identifier, variance quantities/values, required approval tier, and created time  
**And** if there are none, I see an empty-state message.

### Scenario 2: Tier 1 approver can approve Tier 1 adjustment
**Given** an adjustment exists with status `PENDING_APPROVAL` and `requiredApprovalTier = TIER_1_MANAGER`  
**And** I have Tier 1 approval permission  
**When** I open the adjustment detail and click â€œApprove/Postâ€  
**Then** the system posts the adjustment and the UI refreshes to status `POSTED`  
**And** the UI displays a ledger entry reference (if provided by backend)  
**And** approve/reject actions are disabled.

### Scenario 3: Tier 1 approver cannot approve Tier 2 adjustment
**Given** an adjustment exists with status `PENDING_APPROVAL` and `requiredApprovalTier = TIER_2_DIRECTOR`  
**And** I do not have Tier 2 approval permission  
**When** I open the adjustment detail  
**Then** the â€œApprove/Postâ€ and â€œRejectâ€ actions are not available (hidden or disabled)  
**And** if I attempt to approve via direct request, I receive a 403 and the UI shows an authorization error.

### Scenario 4: Reject requires a reason
**Given** an adjustment exists with status `PENDING_APPROVAL`  
**And** I am authorized to reject it  
**When** I click â€œRejectâ€ without entering a rejection reason  
**Then** the UI prevents submission and shows â€œRejection reason is requiredâ€  
**And** no state change occurs.

### Scenario 5: Authorized reject transitions to REJECTED
**Given** an adjustment exists with status `PENDING_APPROVAL`  
**And** I am authorized to reject it  
**When** I enter a rejection reason and submit reject  
**Then** the UI refreshes to status `REJECTED`  
**And** the rejection reason is displayed read-only  
**And** the adjustment no longer appears in the pending approval queue.

### Scenario 6: Concurrency conflict on approve
**Given** I am viewing a `PENDING_APPROVAL` adjustment  
**And** another approver posts it before I do  
**When** I click â€œApprove/Postâ€  
**Then** the backend responds with a concurrency/invalid-state error  
**And** the UI informs me it was updated by someone else  
**And** the UI reloads detail showing the current status (e.g., `POSTED`).

---

## 13. Audit & Observability

### User-visible audit data
- Detail screen shows:
  - createdBy, createdAt
  - approvedBy, postedAt (or updatedAt) when posted
  - rejection reason + who rejected (if available)
  - policyVersion applied
  - status history list (if backend exposes events/history); otherwise show timestamps and status only.

### Status history
- If backend provides an audit/history endpoint, show chronological transitions (Created â†’ Pending/Auto-approved â†’ Posted/Rejected/Failed) with actor and timestamp.

### Traceability expectations
- Display correlation/request id on error banner if returned by backend (safe observability default).
- Ledger entry reference shown when posted to tie UI action to immutable ledger.

---

## 14. Non-Functional UI Requirements
- **Performance:** Queue loads within 2 seconds for up to 200 pending items (pagination if more).
- **Accessibility:** Keyboard navigable table, proper labels for inputs, focus management after errors.
- **Responsiveness:** Works on tablet viewport used in warehouse/stockroom.
- **i18n/timezone:** Display timestamps in user locale/timezone; store/submit in UTC as provided by backend.
- **Currency:** Display monetary values using system currency formatting; do not assume currency code unless backend provides.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide explicit empty-state messaging for zero pending approvals; safe because it doesnâ€™t affect domain logic; impacts UX Summary, Error Flows.
- SD-UX-PAGINATION: Paginate approval queue (default page size 25) if list supports it; safe ergonomics only; impacts UX Summary, Performance.
- SD-ERR-MAP-STD: Map 400/403/409/500 to standard Moqui/Quasar notifications + field errors; safe because itâ€™s presentation-layer handling; impacts Service Contracts, Error Flows.
- SD-OBS-CORRELATION-ID: Display correlation/request id when present in error response headers/body; safe observability boilerplate; impacts Audit & Observability, Error Flows.

---

## 16. Open Questions
1. **Backend service contract:** What are the exact Moqui service names (or REST endpoints) for:
   - listing pending approval adjustments
   - fetching adjustment detail (including ledger entry reference)
   - approve/post action
   - reject action?
2. **Rejection input:** Is rejection reason **free-text** (`rejectionReason`) or a **ReasonCode** selection (or both)? If codes: what is the entity/service to load valid reason codes for cycle-count rejection?
3. **Authorization model:** What permissions/roles govern:
   - viewing the queue
   - approving Tier 1 vs Tier 2
   - rejecting (same as approve or separate permission)?
4. **Queue scope filters:** Is approval queue scoped by **site/location** (multi-site user)? If yes, how is the userâ€™s active site determined in frontend (session context vs explicit filter)?
5. **Audit/history availability:** Does backend expose explicit approval/audit records (e.g., `ApprovalRecord` list) or only current fields (`approvedByUserId`, timestamps)? What fields should be displayed for â€œfull audit trailâ€?
6. **FAILED handling:** When posting fails and status becomes `FAILED`, does backend allow retry (transition back to pending) or is correction always via a new adjustment? UI must not assume a retry path.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Counts: Approve and Post Adjustments from Cycle Count â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/90


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Counts: Approve and Post Adjustments from Cycle Count
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/90
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Counts: Approve and Post Adjustments from Cycle Count

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As an **Inventory Manager**, I want approvals before posting adjustments so that shrink and corrections are controlled.

## Details
- Approval required above thresholds.
- Posting creates Adjust ledger entries and updates on-hand.

## Acceptance Criteria
- Adjustments require permission.
- Ledger entries posted.
- Thresholds enforced.
- Full audit trail.

## Integrations
- Optional accounting events for shrink/adjustment.

## Data / Entities
- InventoryLedgerEntry(Adjust), ApprovalRecord, ReasonCode, EventOutbox

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #91: [FRONTEND] [STORY] Counts: Execute Cycle Count and Record Variances â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/91
File: ./scripts/story-work/frontend/91/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

STOP: Clarification required before finalization

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Counts: Execute Cycle Count and Record Variances

### Primary Persona
Auditor

### Business Value
Enable auditors to record blind cycle counts per bin, producing immutable count entries and system-calculated variances so inventory discrepancies can be reviewed, recounted within policy, and escalated when unresolved.

---

## 2. Story Intent

### As a / I want / So that
- **As an** Auditor  
- **I want** to select a cycle count task for a bin and submit an actual counted quantity (with a bounded ability to recount)  
- **So that** the system computes variance against expected quantity, retains an immutable audit trail, and supports escalation to investigation when counts donâ€™t reconcile.

### In-scope
- View a list of assigned/available cycle count tasks relevant to the auditor.
- Execute a **blind count** for a selected `CycleCountTask` (expected qty not shown during entry).
- Submit initial count and (if allowed) trigger/submit recounts, each creating a new immutable `CountEntry`.
- Display variance results **after submission** (and/or in a review state) in a manner consistent with blind-count policy.
- Display count entry history for a task (read-only).
- Handle validation, authorization, and cap enforcement errors from backend.
- Show state/status of the task and guide user actions accordingly.

### Out-of-scope
- Manager review/approval UI beyond triggering recount if manager persona uses same screens (see Open Questions).
- Performing inventory adjustments, posting to accounting, or emitting accounting events (future).
- Creating cycle count plans/tasks (assumed pre-existing).
- Advanced variance report aggregation across tasks (only task-level variance visibility unless backend provides report endpoints).
- Scanner/barcode-driven bin navigation (unless already standard in repo; not specified here).

---

## 3. Actors & Stakeholders
- **Auditor (primary):** Executes counts, submits quantities, may trigger one immediate recount (policy-based).
- **Inventory Manager (stakeholder):** May trigger additional recounts (policy-based) and handles investigation escalation (may be via separate story).
- **System (Inventory domain):** Computes expected quantity and variance; enforces recount caps; stores immutable entries and status history.
- **Accounting (future downstream):** May consume variance/adjustment signals later; not in current UI scope.

---

## 4. Preconditions & Dependencies
- User is authenticated in the frontend and has inventory count permissions required by backend.
- Backend provides APIs to:
  - List/view `CycleCountTask` records accessible to the user.
  - Submit initial count and recounts, creating immutable `CountEntry` records.
  - Return task status, latest entry pointer, total count entries, and whether recount is allowed.
- A `CycleCountTask` exists with:
  - product reference and location/bin reference,
  - an internal `expectedQuantity` (not shown during entry),
  - a state machine including at least `COUNTED_PENDING_REVIEW` and `REQUIRES_INVESTIGATION` (or equivalent).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Inventory â†’ Cycle Counts â†’ My Tasks** (exact menu location is an implementation detail; route must exist).
- Deep link: `/counts/tasks/<cycleCountTaskId>` to open a specific task.

### Screens to create/modify (Moqui screens)
1. **`Counts/TaskList`** (new or extend existing inventory counts list screen)
   - Shows tasks assigned/available to the current user.
2. **`Counts/TaskDetail`** (new)
   - Displays task context (bin/location, SKU/product description) and count entry form.
3. **`Counts/TaskHistory`** (embedded section on TaskDetail or separate screen)
   - Read-only list of `CountEntry` rows for the task (including recount sequence and timestamps).
4. **Optional**: **`Counts/VarianceView`** (if policy requires showing variance only in a separate post-submit view)

### Navigation context
- Breadcrumbs: Inventory â†’ Cycle Counts â†’ Task List â†’ Task Detail.
- From Task List, selecting a row transitions to Task Detail with taskId parameter.
- From Task Detail, â€œBack to listâ€ returns to Task List preserving filters (safe default).

### User workflows
#### Happy path: initial blind count
1. Auditor opens Task List and selects an `ACTIVE` (or equivalent) task.
2. Task Detail loads task context **without expectedQuantity**.
3. Auditor enters `actualQuantity`.
4. Auditor submits count.
5. UI shows submission success, updated task status, and the recorded entry in history.
6. UI shows variance information only after submission (subject to Open Question #1).

#### Alternate path: immediate recount (auditor)
1. After initial submission, if â€œRecount availableâ€ and auditor has not used their self-recount allowance:
2. Auditor triggers recount mode and submits a new `actualQuantity`.
3. UI shows new entry appended with incremented sequence and proper linkage.

#### Alternate path: cap reached
1. Task already has 3 entries.
2. Any attempt to trigger recount results in backend error and/or status changes to `REQUIRES_INVESTIGATION`.
3. UI shows status and blocks recount UI.

---

## 6. Functional Behavior

### Triggers
- Route entry to Task List or Task Detail.
- User submits count form.
- User clicks â€œTrigger recountâ€ (if allowed) then submits recount form.

### UI actions
- **Task List**
  - Filter by status (safe default).
  - Select task row â†’ navigate to Task Detail.
- **Task Detail**
  - Display: task identifiers, location/bin barcode (if available), product/SKU, UOM (if available).
  - Input: `actualQuantity` with numeric validation per UOM rules (see Open Question #2).
  - Actions:
    - `Submit Count` (initial) when task state allows.
    - `Trigger Recount` when allowed by backend/policy and cap not exceeded.
    - `Submit Recount` when recount mode active.
  - History: list immutable `CountEntry` entries.
  - Read-only status indicator for task status.

### State changes (frontend-visible)
- After successful submit:
  - Task status updates to `COUNTED_PENDING_REVIEW` (or backend equivalent).
  - `latestCountEntryId` updates.
  - `totalCountEntries` increments.
- When recount cap exceeded:
  - Backend sets task status to `REQUIRES_INVESTIGATION`; UI reflects this and disables count inputs.

### Service interactions (Moqui)
- Use Moqui `service-call` from screens/forms to backend services (REST via Moqui service facade or standard service definitions in this project).
- Forms submit to transitions that invoke services and then redirect back to the Task Detail with refreshed data.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `actualQuantity`:
  - Must be numeric.
  - Must be **>= 0**.
  - Decimal precision must comply with the itemâ€™s UOM rules (Open Question #2 if not provided).
- Do not allow empty submission; show inline error: â€œQuantity is required.â€
- If backend rejects (400) with field errors, map to the form field and show a summary message.

### Enable/disable rules
- Disable `Submit Count` if:
  - task not in a state that accepts a count (e.g., already `REQUIRES_INVESTIGATION`, already finalized/closed),
  - user lacks permission,
  - cap reached.
- Show `Trigger Recount` only if backend indicates recount is allowed for this user and state (prefer backend-driven boolean flags to avoid duplicating policy).

### Visibility rules (blind count)
- `expectedQuantity` must **never be displayed** during count entry.
- Variance display timing:
  - Variance may be displayed only after submission or in history view (Open Question #1 to confirm).

### Error messaging expectations
- Unauthorized (403): â€œYou do not have permission to perform this action.â€
- Recount not allowed: â€œRecount is not allowed for this task.â€
- Cap reached / investigation: â€œRecount limit reached. Task requires investigation.â€
- Concurrency (409): â€œThis task was updated by another user. Refresh and try again.â€

---

## 8. Data Requirements

### Entities involved (frontend view)
- `CycleCountTask`
- `CountEntry`
- (Optional/future) `VarianceReport`
- `AuditLog` (exposed via backend as audit metadata or history list)

### Fields (type, required, defaults)

#### `CycleCountTask` (read + state indicators)
- `cycleCountTaskId` (ID, required)
- `status` (enum/string, required)
- `productId` (ID, required)
- `productSku`/`internalName` (string, optional but desirable for UX)
- `storageLocationId` / `binId` (ID, required)
- `binLabel` / `barcode` (string, optional)
- `uomId` / `uomLabel` (string, optional; required to validate decimals if used)
- `latestCountEntryId` (ID, optional)
- `totalCountEntries` (integer, required if cap enforcement shown in UI)
- **Derived (frontend-only):**
  - `canSubmitCount` (boolean; preferably provided by backend)
  - `canTriggerRecount` (boolean; preferably provided by backend)
  - `maxCountsAllowed` (int; if provided)

#### `CountEntry` (read-only list + post-submit display)
- `countEntryId` (ID)
- `cycleCountTaskId` (ID)
- `auditorId` (ID)
- `actualQuantity` (decimal/integer)
- `expectedQuantity` (decimal/integer) â€” **must not display during entry; may display in history based on policy (Open Question #1)**
- `variance` (decimal/integer)
- `countedAt` (timestamp)
- `recountSequenceNumber` (int)
- `recountOfCountEntryId` (ID, nullable)

### Read-only vs editable
- Editable: only `actualQuantity` input in the submission form.
- Read-only: all other fields including variance, expected qty, and audit fields.

### Derived/calculated fields
- Variance is computed by backend: `variance = actualQuantity - expectedQuantity`.
- UI should not calculate variance except for display of backend-provided value (avoid drift).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is referenced from the backend story but concrete endpoint names are not provided here. Moqui implementation must map to actual services once confirmed.

### Load/view calls
- `Counts.TaskList.get`  
  - Inputs: filters (status), pagination
  - Output: list of `CycleCountTask` summary records
- `Counts.TaskDetail.get`
  - Inputs: `cycleCountTaskId`
  - Output: `CycleCountTask` detail + `CountEntry` history (or separate call)

### Create/update calls
- None (no editing tasks here)

### Submit/transition calls
- `Counts.CountEntry.create` (initial count)
  - Inputs: `cycleCountTaskId`, `actualQuantity`
  - Output: created `CountEntry` + updated `CycleCountTask` status/pointers
- `Counts.Recount.trigger` (optional if backend models a trigger step)  
  - Inputs: `cycleCountTaskId`
  - Output: updated task / recount allowed state
- `Counts.Recount.submit` (if separate from create)  
  - Inputs: `cycleCountTaskId`, `actualQuantity`, maybe `recountOfCountEntryId`
  - Output: created `CountEntry` + updated task

### Error handling expectations
- `400` validation errors: return field-level details; UI maps to form.
- `403` forbidden: show permission message; keep task view in read-only mode.
- `404` task not found or not accessible: show â€œTask not found or access deniedâ€ and link back to list.
- `409` concurrency/state change: prompt refresh; optionally auto-refresh the task detail.

---

## 10. State Model & Transitions

### Allowed states (minimum required for UI)
- `ACTIVE` (or equivalent â€œready to countâ€)
- `COUNTED_PENDING_REVIEW`
- `REQUIRES_INVESTIGATION`
- (Optional) `FINALIZED` / `CLOSED` if backend uses it (Open Question #3)

### Role-based transitions (as surfaced to UI)
- Auditor:
  - `ACTIVE` â†’ submit initial count â†’ `COUNTED_PENDING_REVIEW`
  - May trigger **one** immediate recount prior to manager finalization (backend-enforced)
- Inventory Manager:
  - May trigger recounts beyond auditor allowance until cap (backend-enforced)
- Any role:
  - Attempt beyond cap â†’ transition to `REQUIRES_INVESTIGATION` (backend enforced), UI becomes non-editable

### UI behavior per state
- `ACTIVE`: show count entry form, hide expected qty.
- `COUNTED_PENDING_REVIEW`: show history; allow recount only if backend says yes.
- `REQUIRES_INVESTIGATION`: disable all count inputs; show status and guidance to contact manager.
- `FINALIZED/CLOSED` (if exists): read-only.

---

## 11. Alternate / Error Flows

### Validation failures
- Negative quantity submitted â†’ inline error; prevent submit.
- Non-numeric input â†’ inline error.
- Excess decimal precision â†’ inline error if UOM rules known; otherwise rely on backend error mapping.

### Concurrency conflicts
- Task status changed since load (e.g., another auditor counted) â†’ backend returns 409; UI shows refresh prompt and reloads task.

### Unauthorized access
- User without permission tries to submit â†’ 403; disable form and show message.

### Empty states
- Task list empty â†’ show â€œNo cycle count tasks availableâ€ with suggestion to adjust filters.
- Task history empty:
  - If task is `ACTIVE`: expected; show â€œNo counts submitted yet.â€
  - Otherwise: show error banner â€œCounts missing; refresh or contact supportâ€ (possible data issue).

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: Auditor submits initial blind count and system records variance
**Given** an Auditor has access to a cycle count task in a countable state  
**And** the task has an internal expected quantity (not shown during entry)  
**When** the Auditor enters an actual quantity of `102` and submits  
**Then** the UI sends a count submission for that task to the backend  
**And** the backend returns a newly created immutable CountEntry (sequence 1)  
**And** the UI refreshes and shows the task status as `COUNTED_PENDING_REVIEW`  
**And** the UI shows the recorded count entry in history  
**And** the UI does not display expected quantity prior to submission.

### Scenario 2: Auditor attempts to submit a negative quantity
**Given** an Auditor is on a cycle count task detail screen  
**When** they enter `-1` and attempt to submit  
**Then** the UI blocks submission  
**And** displays â€œQuantity must be zero or a positive number.â€

### Scenario 3: Auditor triggers one immediate recount and submits a second entry
**Given** a task has an initial CountEntry  
**And** the backend indicates the Auditor can trigger a self recount for the task  
**When** the Auditor triggers recount and submits a new actual quantity  
**Then** the backend creates a new immutable CountEntry with incremented recount sequence  
**And** the UI shows both entries in history in sequence order.

### Scenario 4: Auditor attempts a second self recount and is rejected
**Given** a task already has an initial count and one auditor recount  
**When** the Auditor attempts to trigger another recount  
**Then** the backend returns `403` or a domain error indicating recount not allowed  
**And** the UI displays an access/policy message  
**And** the UI does not allow submission of another recount.

### Scenario 5: Recount cap reached escalates to investigation
**Given** a task has 3 total CountEntry records  
**When** the user attempts to trigger or submit another recount  
**Then** the backend blocks the request and sets status to `REQUIRES_INVESTIGATION` (or returns that status)  
**And** the UI refreshes to show `REQUIRES_INVESTIGATION`  
**And** all count submission controls are disabled.

### Scenario 6: Unauthorized user cannot submit counts
**Given** a user without cycle count execution permission opens a task  
**When** they attempt to submit a count  
**Then** the backend returns `403 Forbidden`  
**And** the UI shows â€œYou do not have permission to perform this actionâ€  
**And** the UI keeps the task in read-only mode.

---

## 13. Audit & Observability

### User-visible audit data
- Task history shows:
  - `countedAt` timestamp
  - `recountSequenceNumber`
  - `actualQuantity`
  - `variance` (if allowed to display; see Open Question #1)
  - performer (auditor name/ID if available)

### Status history
- If backend exposes status transitions, show a simple status history section (timestamp + from/to + actor). If not exposed, omit.

### Traceability expectations
- Every submission should surface a confirmation containing `countEntryId` (or reference) for support/debugging (e.g., â€œRecorded as Entry #<id>â€ in a non-sensitive way).

---

## 14. Non-Functional UI Requirements
- **Performance:** Task detail load should complete with a single round trip where possible; avoid N+1 calls when rendering history.
- **Accessibility:** All form controls labeled; validation errors announced; keyboard navigable submit actions.
- **Responsiveness:** Task list and detail usable on tablet-sized screens typical for warehouse/auditor usage.
- **i18n/timezone:** Display timestamps in user locale/timezone while storing/using UTC from backend.
- **Numeric input:** Respect locale decimal separator if project supports it (otherwise enforce dot and document).

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide clear empty states for task list/history; safe because it does not change domain logic. Impacted sections: UX Summary, Alternate/Empty states.
- SD-UX-PAGINATION: Paginate task list with standard page size; safe because it only affects presentation and load behavior. Impacted sections: UX Summary, Service Contracts.
- SD-ERR-MAP-STD: Map backend 400/403/404/409 to standard UI messages and field errors; safe because it follows HTTP semantics and does not invent policy. Impacted sections: Business Rules, Error Flows, Service Contracts.

---

## 16. Open Questions
1. **Blind count reveal policy:** After submission, may the Auditor see `expectedQuantity` and `variance` immediately, or only Inventory Manager/review screens? (Backend story implies variance is computed; UI display rules must be confirmed.)
2. **UOM / decimal precision rules:** Are counted quantities always integers, or can they be decimals by item/UOM? If decimals allowed, what precision per UOM and rounding rules should the UI enforce vs defer to backend?
3. **Full task state machine:** Besides `COUNTED_PENDING_REVIEW` and `REQUIRES_INVESTIGATION`, what other statuses exist (e.g., `ACTIVE`, `FINALIZED`, `CLOSED`), and which are countable/recountable?
4. **Service/API contracts:** What are the exact Moqui service names or REST endpoints and response schemas for:
   - task list,
   - task detail + history,
   - submit initial count,
   - trigger/submit recount?
5. **Authorization mapping:** What permissions/roles are enforced by backend and should be reflected in UI gating (e.g., `TRIGGER_RECOUNT_SELF`, `TRIGGER_RECOUNT_ANY`), and how does the frontend discover them (claims vs endpoint flags)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Counts: Execute Cycle Count and Record Variances â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/91

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Counts: Execute Cycle Count and Record Variances  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/91  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Counts: Execute Cycle Count and Record Variances

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As an **Auditor**, I want to record counted quantities so that variances can be reviewed and corrected.

## Details  
- Count tasks per bin.  
- Record counts; optional recount.  
- Variance report generated.

## Acceptance Criteria  
- Counts recorded.  
- Variance computed.  
- Recount supported (basic).  
- Audited.

## Integrations  
- May later emit accounting adjustment events.

## Data / Entities  
- CycleCountTask, CountEntry, VarianceReport, AuditLog

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Inventory Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #92: [FRONTEND] [STORY] Fulfillment: Create Pick List / Pick Tasks for Workorder â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/92
File: ./scripts/story-work/frontend/92/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Fulfillment: View & Print Pick List / Pick Tasks for Workorder (Generated on Reservation Confirmation)

### Primary Persona
Dispatcher (primary); Mechanic (secondary consumer on mobile)

### Business Value
Provide a deterministic, actionable pick list for a work order so shop staff can pull correct parts quickly, reduce picking errors, and improve on-time job starts.

---

## 2. Story Intent

### As a / I want / So that
**As a** Dispatcher,  
**I want** to view a generated pick list (pick tasks) for a work order, ordered by storage layout, with a printable and mobile-friendly view,  
**so that** Mechanics know what to pull and when, without manual coordination.

### In-scope
- Frontend screens to:
  - Locate and open the pick list associated with a work order
  - Display pick tasks (product, qty, suggested storage location, priority, due time, status)
  - Show list status (Draft/ReadyToPick/â€¦)
  - Print-friendly rendering and mobile-friendly rendering
- Frontend calls to backend services to load pick list + tasks (and optionally trigger generation if allowed by backend contract)
- Empty/needs-review handling for tasks without actionable locations

### Out-of-scope
- Generating pick lists purely in the frontend (must be backend/inventory domain)
- Route optimization beyond deterministic sort keys
- Picking execution flows (mark picked, partial picks, substitutions), unless explicitly provided by backend contract
- Inventory allocation/reservation logic

---

## 3. Actors & Stakeholders
- **Dispatcher:** initiates/monitors fulfillment readiness; prints pick list.
- **Mechanic:** consumes pick tasks on a mobile device; may print if needed.
- **Inventory Domain (backend):** system of record for pick list/task generation, ordering, and suggested locations.
- **Work Execution Domain (backend):** system of record for work order context (priority, scheduled start, due time).
- **Shop Manager (optional stakeholder):** operational oversight.

---

## 4. Preconditions & Dependencies
1. A **Work Order** exists (workOrderId known).
2. Parts reservation has been **confirmed** (trigger for backend generation).
3. Backend provides an API to retrieve the pick list and tasks for a work order (contract TBD; see Open Questions).
4. Storage locations have deterministic layout sort fields available to the backend; frontend relies on backend-provided `sortOrder` or equivalent.
5. AuthN is working; AuthZ rules for viewing pick lists are defined (permission(s) TBD).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a Work Order screen: â€œPick Listâ€ action/tab (preferred).
- Direct route by work order: `/fulfillment/workorders/:workOrderId/pick-list`
- Direct route by pick list id (optional if backend supports): `/fulfillment/pick-lists/:pickListId`

### Screens to create/modify (Moqui)
Create/modify Moqui screens (names indicative; align to repo conventions):
1. **WorkOrderDetail** (existing, in WorkExec area): add navigation link/button â€œPick Listâ€
2. **PickListView** (new): view pick list header + tasks table/list
3. **PickListPrint** (new): print-optimized screen/view (minimal chrome)
4. **PickListMobile** (optional new): mobile-optimized layout (could be same screen with responsive behavior)

### Navigation context
- Breadcrumb: Work Orders â†’ Work Order {id or reference} â†’ Pick List
- Keep workOrder context visible (work order reference, priority, scheduledStart/dueAt if provided)

### User workflows
**Happy path**
1. Dispatcher opens Work Order.
2. Clicks â€œPick Listâ€.
3. System loads pick list for workOrderId.
4. If pick list exists and status is `ReadyToPick`, show tasks ordered as provided.
5. Dispatcher clicks â€œPrintâ€ to open print view and prints.

**Alternate path: pick list not yet created**
- If backend indicates â€œnot found / not generated yetâ€, UI shows â€œPick list not available yetâ€ and a refresh action.
- If backend supports manual â€œGenerate/Rebuildâ€ (unknown), show a button gated by permission and confirmation (TBD).

**Alternate path: Draft / NeedsReview**
- If pick list status is `Draft` and tasks include `NeedsReview`, show callout listing issues and highlight those tasks.

---

## 6. Functional Behavior

### Triggers (frontend)
- Route navigation to PickListView with `workOrderId` (required).
- User-initiated refresh.
- User selects Print/Mobile view.

### UI actions
- **Load pick list** on screen entry.
- **Refresh**: re-fetch pick list and tasks.
- **Print**: open print route/view (new tab optional) using the already-loaded data or re-fetch for latest.
- **Filter/Find** within tasks (safe UI ergonomics only; does not change backend sort).

### State changes (frontend-local)
- Loading states: `idle â†’ loading â†’ loaded | error`
- No domain state changes unless backend supports transitions (not defined here).

### Service interactions
- Call backend to:
  - fetch pick list by `workOrderId` (primary)
  - fetch tasks for pick list (may be included in same response)
  - optionally fetch work order summary (if needed for header, and not included)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `workOrderId` must be present in route params; otherwise show 400-style page message â€œMissing work order idâ€ and do not call backend.
- If a task quantity is non-positive (should not happen), display â€œInvalid quantityâ€ and flag row as error (display-only; do not correct).

### Enable/disable rules
- â€œPrintâ€ enabled only when pick list is loaded successfully.
- If pick list status is `Draft`, printing is allowed **only if business permits** (unclear). Default UI behavior: allow printing but show warning banner â€œDraft pick listâ€”may be incomplete.â€ (requires confirmation; see Open Questions if printing Draft is disallowed).

### Visibility rules
- If any task `status = NeedsReview`, show a top-level warning summary and visually mark those tasks.
- If no tasks: show empty state â€œNo pick tasks available yet.â€

### Error messaging expectations
- 401: redirect to login (project standard)
- 403: show â€œYou donâ€™t have access to view pick lists for this work order.â€
- 404 (no pick list): show empty state â€œPick list not generated yet.â€
- 409: show â€œPick list changed; refresh to see latest.â€
- 5xx/network: show retryable error with â€œRetryâ€ action.

---

## 8. Data Requirements

### Entities involved (frontend perspective; SoR is backend)
- `PickList`
- `PickTask`
- `StorageLocation` (as embedded info on task, or referenced)
- `WorkOrder` summary (optional display context)

### Fields (types, required, defaults)
**PickList (required to render header)**
- `pickListId` (UUID, required)
- `workOrderId` (UUID, required)
- `status` (enum string; required)
- `createdAt` (timestamp; required for display)
- Optional but useful:
  - `workOrderPriority` (int)
  - `scheduledStartAt` (timestamp)
  - `dueAt` (timestamp)

**PickTask (required per row/item)**
- `pickTaskId` (UUID, required)
- `pickListId` (UUID, required)
- `productId` (UUID, required)
- `productDisplayName` (string, strongly preferred for UI; otherwise frontend needs product lookup â†’ clarification)
- `quantityRequired` (number/decimal; required)
- `uom` (string; optional but important if fractional quantities exist â†’ clarification)
- `suggestedLocationId` (UUID; nullable if NeedsReview)
- `suggestedLocationCode` (string; nullable)
- `priority` (int; required)
- `dueAt` (timestamp; required)
- `sortOrder` (int; required if backend pre-sorts; otherwise frontend sorts by provided layout fields â†’ clarification)
- `status` (enum string; required)

**Storage location layout fields**
- Prefer backend-provided `sortOrder` and already-sorted tasks.
- If not, frontend requires:
  - `zoneOrder` (int)
  - `aisleOrder` (string/int)
  - `rackOrder` (int)
  - `binOrder` (int)
  - `locationCode` (string)

### Read-only vs editable
- All fields are **read-only** in this story (view/print only).

### Derived/calculated fields (frontend)
- â€œOverdueâ€ indicator if `now > dueAt` and task not complete (only if task completion states exist; otherwise skip).
- Group headers by Zone/Aisle (optional UI; safe ergonomics).

---

## 9. Service Contracts (Frontend Perspective)

> Backend endpoints are not provided in the inputs; contracts below are **required** for buildability and must align to backend implementation. Until confirmed, story remains blocked.

### Load/view calls
1. **Get pick list by work order**
   - `GET /api/pick-lists/by-workorder/{workOrderId}`
   - Response: `PickList` including `tasks[]` OR a link to tasks endpoint
   - Errors:
     - 404 if not generated yet
     - 403 if unauthorized

2. **(If tasks not embedded) Get pick tasks**
   - `GET /api/pick-lists/{pickListId}/tasks`
   - Response: `PickTask[]` already sorted by `sortOrder`

3. **(Optional) Work order summary**
   - `GET /api/workorders/{workOrderId}/summary`

### Create/update calls
- None (unless backend supports manual generation; see Submit/transition)

### Submit/transition calls (only if backend supports)
- Optional manual trigger:
  - `POST /api/pick-lists/generate`
  - Body: `{ workOrderId }`
  - Response: `{ pickListId }`
  - Permission required (TBD)

### Error handling expectations (Moqui UI)
- Map HTTP errors to user messages per section 7.
- Preserve backend validation messages for 400 in a details panel.

---

## 10. State Model & Transitions

### Allowed states (displayed)
PickList `status` (from backend story reference; confirm frontend enums):
- `Draft`
- `ReadyToPick`
- `InProgress` (may exist)
- Other statuses unknown (must display generically if new)

PickTask `status`:
- `Pending`
- `NeedsReview`
- `Picked` (may exist)
- Other statuses unknown

### Role-based transitions
- None implemented in frontend in this story (view/print only).
- UI must not expose â€œmark pickedâ€ or â€œstart pickingâ€ actions unless a separate story defines the transitions and permissions.

### UI behavior per state
- `Draft`: show banner â€œDraft: some tasks may require reviewâ€; highlight NeedsReview tasks.
- `ReadyToPick`: normal display; emphasize due times/priority.
- Unknown status: display as text badge without special behavior.

---

## 11. Alternate / Error Flows

1. **Pick list not found (not generated yet)**
   - Show empty state with:
     - Explanation: â€œPick list is created when reservation is confirmed.â€
     - Actions: Refresh; Back to Work Order
     - If manual generate exists: show â€œGenerate pick listâ€ button (permission-gated)

2. **Tasks include NeedsReview**
   - Show warning summary
   - For each NeedsReview task: show missing fields (e.g., â€œNo actionable locationâ€)

3. **Concurrency / stale data**
   - If backend returns 409 or indicates version mismatch:
     - Show â€œPick list updated; refreshâ€
     - Provide refresh action

4. **Unauthorized**
   - 403: show access denied, do not reveal task details
   - Ensure print route also enforces same checks (no cached rendering if unauthorized)

5. **Network/server errors**
   - Show retry, preserve correlation/request id if returned in headers/body

---

## 12. Acceptance Criteria (Gherkin)

### Scenario 1: View ReadyToPick pick list for a work order
**Given** I am authenticated as a Dispatcher with permission to view pick lists  
**And** a work order `{workOrderId}` has an associated pick list in status `ReadyToPick`  
**When** I navigate to `/fulfillment/workorders/{workOrderId}/pick-list`  
**Then** the system displays the pick list header (pickListId, status, createdAt)  
**And** displays all pick tasks including product, quantity, suggested location, priority, dueAt, and task status  
**And** tasks are presented in the backend-provided deterministic order (by `sortOrder`)

### Scenario 2: Pick list not generated yet
**Given** I am authenticated as a Dispatcher  
**And** `{workOrderId}` has no pick list generated yet  
**When** I open the Pick List screen for `{workOrderId}`  
**Then** I see an empty state indicating the pick list is not available yet  
**And** I can click â€œRefreshâ€ to retry loading

### Scenario 3: NeedsReview tasks are highlighted
**Given** I am authenticated as a Dispatcher  
**And** the pick list for `{workOrderId}` is in status `Draft`  
**And** at least one pick task has status `NeedsReview`  
**When** I view the pick list  
**Then** I see a warning banner indicating some tasks need review  
**And** the `NeedsReview` tasks are visually distinguished  
**And** each such task shows missing actionable information (e.g., no suggested location)

### Scenario 4: Print view renders pick list content
**Given** I have successfully loaded a pick list for `{workOrderId}`  
**When** I click â€œPrintâ€  
**Then** the system opens a print-optimized view containing the same pick list header and tasks  
**And** the print view does not include application navigation chrome  
**And** the tasks appear in the same deterministic order

### Scenario 5: Unauthorized access is blocked
**Given** I am authenticated without permission to view pick lists for `{workOrderId}`  
**When** I navigate to the pick list route for `{workOrderId}`  
**Then** the system displays an access denied message  
**And** no pick list/task data is rendered

### Scenario 6: Backend error shows retryable message
**Given** I am authenticated as a Dispatcher  
**And** the backend returns a 5xx error when loading the pick list  
**When** I open the pick list screen  
**Then** I see an error state with a â€œRetryâ€ action  
**When** I click â€œRetryâ€ and the backend succeeds  
**Then** the pick list is displayed

---

## 13. Audit & Observability

### User-visible audit data
- Display `createdAt` and current `status` for the pick list.
- If backend provides status history, show a â€œHistoryâ€ section (otherwise omit; do not invent).

### Status history
- Not required unless backend supplies an endpoint/fields (Open Question).

### Traceability expectations
- Frontend should include correlation/request id in error details when available (header `X-Correlation-Id` or response body field; confirm convention).
- Log client-side navigation + load failures via existing frontend logging hooks (project standard).

---

## 14. Non-Functional UI Requirements
- **Performance:** initial load should render skeleton/loading state immediately; target < 2s perceived load on typical task list sizes (exact SLA not defined).
- **Accessibility:** keyboard navigable; sufficient contrast; print view readable.
- **Responsiveness:** usable on mobile screens; tasks list should adapt (stacked rows or condensed columns).
- **i18n/timezone:** display timestamps (`dueAt`, `createdAt`) in user/site timezone (confirm app standard); do not change backend times.
- **Printing:** CSS `@media print` styling to avoid cut-off columns and ensure page breaks behave sensibly.

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Provide standard empty-state with explanation + refresh/back actions; safe because it does not alter domain behavior. Impacted sections: UX Summary, Alternate/Error Flows.
- SD-UI-LOADING-SKELETON: Use skeleton/loading indicator during async fetch; safe UI ergonomics. Impacted sections: Functional Behavior, Non-Functional.
- SD-ERR-MAP-HTTP: Standard mapping of 401/403/404/409/5xx to UI states; safe because it is generic transport handling. Impacted sections: Business Rules, Error Flows, Service Contracts.
- SD-UI-RESPONSIVE: Responsive layout adaptations for mobile/print without changing data; safe. Impacted sections: UX Summary, Non-Functional.

---

## 16. Open Questions
1. **Backend API contract:** What are the exact Moqui service endpoints (path, parameters) to:
   - fetch pick list by `workOrderId`
   - fetch pick tasks (embedded vs separate)
   - and do responses include `productDisplayName`, `uom`, and `sortOrder`?
2. **Manual generation:** If a pick list does not exist yet, should the frontend provide a â€œGenerate pick listâ€ action, or is generation strictly event-driven only?
3. **Authorization model:** What permission(s)/roles control:
   - viewing pick lists
   - printing pick lists
   - (if applicable) generating/regenerating pick lists
4. **Printing Draft lists:** Is printing allowed when `PickList.status = Draft` (e.g., due to `NeedsReview` tasks), or must printing be blocked?
5. **Task ordering source of truth:** Will backend always return tasks already ordered deterministically (recommended), or must frontend implement sorting using location fields?
6. **Work order context fields:** Should the pick list view display `scheduledStartAt`, `dueAt`, and `workOrderPriority`â€”and which service supplies them (inventory response vs workexec summary)?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Fulfillment: Create Pick List / Pick Tasks for Workorder â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/92


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Fulfillment: Create Pick List / Pick Tasks for Workorder
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/92
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Fulfillment: Create Pick List / Pick Tasks for Workorder

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Dispatcher**, I want a pick list so that mechanics know what to pull for a workorder.

## Details
- Pick tasks include product, qty, suggested storage locations, priority, and due time.

## Acceptance Criteria
- Pick tasks generated when reservation confirmed.
- Sorted by route/location.
- Printable or mobile view.

## Integrations
- Workexec provides workorder context; shopmgr may surface to mechanics.

## Data / Entities
- PickTask, PickList, RouteHint

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #93: [FRONTEND] [STORY] Fulfillment: Reserve/Allocate Stock to Workorder Lines â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/93
File: ./scripts/story-work/frontend/93/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] Fulfillment: Reserve/Allocate Stock to Workorder Lines (SOFT/HARD) + View/Promote/Cancel

### Primary Persona
- **Parts Manager / Service Advisor** (human user) interacting in POS UI
- **Work Execution System** (system actor) as the source of workorder line context

### Business Value
- Ensure required parts for a job are predictably available by creating and managing inventory reservations per workorder line, with clear visibility into allocated vs backordered quantities and explicit promotion to HARD when operational commitment occurs.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Parts Manager (or authorized user),
- **I want** to view reservation status for each workorder line and take explicit actions to reserve (SOFT), promote to HARD, or cancel reservations,
- **So that** parts are held for the job at the right time, ATP impact is controlled, and shortages/backorders are visible and auditable.

### In-scope
- Moqui screens/forms to:
  - Display reservation + allocation details for a selected workorder line.
  - Trigger **upsert reservation** (create/update SOFT allocations) for a workorder line.
  - Trigger **promote SOFT â†’ HARD** (with permission) and reflect resulting ATP impact.
  - Trigger **cancel reservation** for a workorder line.
- UI presentation of outcomes:
  - Reservation status (`PENDING`, `FULFILLED`, `PARTIALLY_FULFILLED`, `BACKORDERED`, `CANCELLED`)
  - Required vs allocated vs backordered quantities
  - Allocation rows including state (`SOFT`/`HARD`) and location
- Frontend error handling + audit visibility (read-only) for reservation/allocation history.

### Out-of-scope
- Creating pick tasks and operational picking workflows (only show returned pick-task references if backend provides them).
- Any inventory valuation/costing logic.
- Defining or changing Work Order lifecycle/state machine (owned by Work Execution).
- Automated/time-based promotions (explicitly disallowed).
- Substitution/backorder fulfillment policy (only reflect statuses returned by backend).

---

## 3. Actors & Stakeholders
- **Parts Manager (primary UI user):** initiates reserve/promote/cancel and reviews shortages.
- **Service Advisor:** views status to communicate ETA/availability to customer.
- **Technician (optional):** may view reservation status while preparing job (no privileged actions unless granted).
- **Inventory System (SoR):** authoritative source for reservations, allocations, ATP calculation.
- **Work Execution System (external SoR for workorders):** provides workorder line identifiers and required quantities; triggers may originate from workorder workflow.

---

## 4. Preconditions & Dependencies
- A workorder and one or more workorder lines exist in Work Execution with a stable identifier (**WorkOrderLineID**).
- Each workorder line references a SKU/product that exists in the Product catalog and is recognized by Inventory.
- Frontend can obtain:
  - `workOrderId` and `workOrderLineId`
  - `sku` (or productId mapped to sku) and `requiredQty`
  - current workorder line state (at minimum whether cancelled)
- Backend endpoints/services exist (or will exist) to:
  - Get reservation by workorder line reference
  - Upsert reservation (idempotent)
  - Promote allocations to HARD (permission-guarded)
  - Cancel reservation
  - Return audit/history information (or at least updated timestamps/actor)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From **Work Order detail** screen (Work Execution area) â†’ action â€œInventory Reservationâ€ on each workorder line.
- Optional: From **Inventory** module search â†’ â€œReservation Lookupâ€ by WorkOrderLineID (only if product requires it; otherwise out-of-scope).

### Screens to create/modify
1. **Modify Work Order Line screen** (existing, Workexec-owned)  
   - Add navigation/action to Reservation screen with parameters: `workOrderId`, `workOrderLineId`, `sku`, `requiredQty`.
2. **New/updated Inventory Reservation screen** (Inventory-owned)
   - Screen ID suggestion: `Inventory/Reservation/WorkOrderLineReservation.xml` (final path must match repo conventions).

### Navigation context
- Breadcrumb: Work Order â†’ Line â†’ Reservation
- Return link to Work Order detail with preserved scroll/line focus (if supported by existing patterns).

### User workflows
**Happy path (create/update SOFT reservation)**
1. User opens reservation screen for a workorder line.
2. UI loads existing reservation (if any) and availability summary.
3. User clicks â€œReserve (SOFT)â€ or â€œUpdate Reservationâ€ (if required qty changed).
4. UI shows updated reservation status + allocation list.

**Happy path (promote to HARD)**
1. User with permission clicks â€œPromote to HARDâ€.
2. UI confirms action (explicit, irreversible in effect on ATP).
3. UI shows allocations now `HARD`, status updated, and displays any audit fields returned.

**Happy path (cancel)**
1. User clicks â€œCancel Reservationâ€.
2. UI confirms.
3. UI shows reservation status `CANCELLED` and allocations removed/marked released per backend response.

**Alternate paths**
- Partial allocation/backorder: show allocated qty < required qty and computed backorder qty; show status `PARTIALLY_FULFILLED` or `BACKORDERED`.
- Promotion failure due to insufficient ATP: show error and keep state unchanged in UI.
- Reservation doesnâ€™t exist yet: show empty state with â€œReserve (SOFT)â€ CTA.

---

## 6. Functional Behavior

### Triggers
- Screen load with `workOrderLineId` â†’ fetch reservation view data.
- User actions:
  - Upsert reservation (SOFT allocations)
  - Promote to HARD
  - Cancel reservation
  - Refresh

### UI actions
- **Reserve (SOFT)/Update** button:
  - Sends idempotent upsert keyed by `workOrderLineId`.
  - Uses required quantity provided by workexec context unless user-edit is allowed (see Open Questions).
- **Promote to HARD** button:
  - Enabled only when reservation exists and at least one allocation is `SOFT` and user has permission.
- **Cancel Reservation** button:
  - Enabled when reservation exists and not already `CANCELLED`.

### State changes (frontend)
- Local UI state reflects backend authoritative values returned after each action.
- No client-side recomputation of ATP; display only what backend returns.

### Service interactions (Moqui)
- Use Moqui `transition` actions calling services (remote REST or local services depending on project conventions) for:
  - `loadReservationView`
  - `upsertReservation`
  - `promoteReservationHard`
  - `cancelReservation`

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- Required identifiers must be present before enabling actions:
  - `workOrderLineId` required for all operations.
  - `sku` and `requiredQty` required for upsert.
- Quantity rules:
  - If `requiredQty <= 0`: treat as cancellation **only if** backend supports that behavior; otherwise block action and show validation error (see Open Questions).
- Promotion requires permission: `inventory.reserve.hard`.
- Manual edits to allocation rows (quantities/locations) are **not allowed** in UI unless backend explicitly supports it (not provided).

### Enable/disable rules
- â€œReserve (SOFT)â€ enabled when:
  - `workOrderLineId` + `sku` present
  - `requiredQty > 0`
  - workorder line not cancelled (if known)
- â€œPromote to HARDâ€ enabled when:
  - reservation status not `CANCELLED`
  - at least one allocation state = `SOFT`
  - user has permission `inventory.reserve.hard`
- â€œCancelâ€ enabled when:
  - reservation exists
  - status not `CANCELLED`

### Visibility rules
- Show â€œBackordered Qtyâ€ when `requiredQty > allocatedQty`.
- Show allocation table only when allocations exist.
- Show audit/history panel only when backend returns audit data.

### Error messaging expectations
- Display backend error `code` and human-readable `message` when present.
- Map common errors to actionable UI messages:
  - `SKU_NOT_FOUND` â†’ â€œPart not found in inventory catalog.â€
  - `INSUFFICIENT_ATP` â†’ â€œNot enough available-to-promise to hard-reserve these parts.â€
  - `INVALID_QUANTITY` â†’ â€œQuantity must be greater than zero.â€
  - `403` â†’ â€œYou donâ€™t have permission to perform this action.â€

---

## 8. Data Requirements

### Entities involved (frontend view)
- Reservation
- Allocation
- WorkorderLineRef (reference only; owned by workexec)
- Optional: Reservation/Allocation audit/history (if exposed)

### Fields (type, required, defaults)

**Workorder line context (input to screen)**
- `workOrderId` (string/UUID, optional but recommended for navigation)
- `workOrderLineId` (string/UUID, **required**)
- `sku` (string, **required** for upsert)
- `requiredQty` (integer, **required** for upsert)

**Reservation (read model)**
- `reservationId` (UUID, required if exists)
- `workOrderLineId` (string, required)
- `sku` (string, required)
- `requiredQuantity` (int, required)
- `allocatedQuantity` (int, required; backend-derived)
- `status` (enum, required)
- `createdAt`/`updatedAt` (timestamp, optional display)

**Allocation (read model rows)**
- `allocationId` (UUID, required)
- `reservationId` (UUID, required)
- `locationId` (string, optional display label if provided)
- `allocatedQuantity` (int, required)
- `allocationState` (`SOFT`|`HARD`, required)
- `status` (`ALLOCATED`|`PICKED`|`RELEASED`, optional if backend provides)
- `hardenedAt` (timestamp, optional)
- `hardenedBy` (string, optional)
- `hardenedReason` (string enum, optional)

**Derived/calculated (frontend-only display)**
- `backorderedQuantity = max(requiredQuantity - allocatedQuantity, 0)` (display only; does not drive logic)

### Read-only vs editable
- Editable:
  - None by default, except possibly `requiredQty` if product decides UI can override workexecâ€™s required quantity (Open Question).
- Read-only:
  - All reservation/allocation fields; actions are via service calls.

---

## 9. Service Contracts (Frontend Perspective)

> Backend contract is not fully defined in provided inputs; the following is the **minimum** the frontend needs. If backend differs, adjust to match actual Moqui services/endpoints.

### Load/view calls
- `GET Reservation by workOrderLineId`
  - Request: `{ workOrderLineId }`
  - Response: `{ reservation, allocations[], atpSummary? , auditHistory? }`

### Create/update calls
- `POST UpsertReservation`
  - Request: `{ workOrderLineId, sku, requiredQuantity, idempotencyKey? }`
  - Response: `{ reservation, allocations[] }`
  - Idempotency: backend must treat `workOrderLineId` as idempotency identifier.

### Submit/transition calls
- `POST PromoteReservationHard`
  - Request: `{ reservationId | workOrderLineId, reason: 'USER_ACTION' }`
  - Response: `{ reservation, allocations[] }`
  - Errors: `INSUFFICIENT_ATP`, `403` for missing permission.

- `POST CancelReservation`
  - Request: `{ reservationId | workOrderLineId }`
  - Response: `{ reservation(status=CANCELLED) }` and allocations removed or marked.

### Error handling expectations
- 400 validation errors return a structured payload with `errors[]` and optional `code`.
- 403 for permission failures.
- 404 when reservation not found on load (UI should treat as â€œno reservation existsâ€ rather than hard error).

---

## 10. State Model & Transitions

### Allowed states (Reservation)
- `PENDING`
- `FULFILLED`
- `PARTIALLY_FULFILLED`
- `BACKORDERED`
- `CANCELLED`

### Allowed states (AllocationState)
- `SOFT`
- `HARD`

### Role-based transitions (UI-triggered)
- Any authorized inventory user:
  - None â†’ (Upsert) â†’ `PENDING/FULFILLED/PARTIALLY_FULFILLED/BACKORDERED` (backend decides)
  - Active â†’ (Cancel) â†’ `CANCELLED`
- User with `inventory.reserve.hard`:
  - AllocationState `SOFT` â†’ (Promote) â†’ `HARD`

### UI behavior per state
- `CANCELLED`: disable Promote/Reserve actions; show â€œCancelledâ€ banner.
- `BACKORDERED` / `PARTIALLY_FULFILLED`: show backordered quantity prominently; keep Reserve enabled (to retry/update) unless workorder cancelled.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing `workOrderLineId` â†’ block screen actions and show â€œMissing work order line reference.â€
- Missing `sku` or `requiredQty` on upsert â†’ disable Reserve and show inline explanation.

### Concurrency conflicts
- If backend returns a conflict (409) due to concurrent update:
  - UI shows â€œReservation was updated by another user/system. Refreshingâ€¦â€ and reloads view.

### Unauthorized access
- On 403:
  - Show error and keep UI state unchanged.
  - For Promote: hide button entirely if permission is known in session; otherwise show disabled with tooltip after first 403 (project convention-dependent).

### Empty states
- No reservation found:
  - Show â€œNo reservation yetâ€ and enable â€œReserve (SOFT)â€.

---

## 12. Acceptance Criteria

### Scenario 1: View existing reservation and allocations
**Given** a user opens the Reservation screen with a valid `workOrderLineId`  
**When** the screen loads  
**Then** the UI requests reservation details for that `workOrderLineId`  
**And** displays reservation `status`, `requiredQuantity`, `allocatedQuantity`, and allocation rows with `allocationState` and `allocatedQuantity`.

### Scenario 2: Create SOFT reservation (upsert) for a workorder line
**Given** no reservation exists for `workOrderLineId=WOL-1` and `sku=FLTR-01` with `requiredQty=5`  
**When** the user clicks â€œReserve (SOFT)â€  
**Then** the UI calls `UpsertReservation` with `{workOrderLineId: WOL-1, sku: FLTR-01, requiredQuantity: 5}`  
**And** on success displays a reservation with `allocatedQuantity=5` and allocations with `allocationState=SOFT`  
**And** the UI does not show any ATP reduction as a client-side calculation.

### Scenario 3: Update reservation quantity idempotently
**Given** an existing reservation for `workOrderLineId=WOL-1` exists  
**When** the user triggers Reserve again with the same inputs  
**Then** the UI receives the same reservation identity (`reservationId`) and does not show duplicate allocation rows (as returned by backend).

### Scenario 4: Promote SOFT to HARD (authorized)
**Given** a reservation exists with at least one allocation in `SOFT`  
**And** the user has permission `inventory.reserve.hard`  
**When** the user clicks â€œPromote to HARDâ€ and confirms  
**Then** the UI calls `PromoteReservationHard`  
**And** on success displays allocations updated to `allocationState=HARD`  
**And** displays `hardenedAt`/`hardenedBy`/`hardenedReason` if provided.

### Scenario 5: Promote fails due to insufficient ATP
**Given** a reservation exists with `SOFT` allocations  
**When** the user clicks â€œPromote to HARDâ€  
**And** the backend responds with error `INSUFFICIENT_ATP`  
**Then** the UI shows an error message indicating insufficient ATP  
**And** allocations remain displayed as `SOFT` (no optimistic change persists).

### Scenario 6: Cancel reservation
**Given** a reservation exists for `workOrderLineId=WOL-1`  
**When** the user clicks â€œCancel Reservationâ€ and confirms  
**Then** the UI calls `CancelReservation`  
**And** on success displays reservation status `CANCELLED`  
**And** disables Promote/Reserve actions for that reservation.

### Scenario 7: Unauthorized promote attempt
**Given** a user without `inventory.reserve.hard` permission views a reservation with `SOFT` allocations  
**When** the user attempts to promote (if button is visible)  
**Then** the backend returns 403  
**And** the UI shows a permission error  
**And** the UI prevents further promote attempts in the session (disable/hide per convention).

---

## 13. Audit & Observability

### User-visible audit data
- Display (if provided):
  - reservation `createdAt`, `updatedAt`
  - last action actor (user/system) and reason for hardening (for promotion)
  - optional â€œHistoryâ€ list of changes (state transitions, qty changes)

### Status history
- If backend provides events (e.g., `AllocationHardened`), show them in a read-only panel with timestamp and actor.

### Traceability expectations
- Frontend includes correlation ID header if project convention exists; otherwise ensure Moqui logs include screen transition + parameters (excluding sensitive data).

---

## 14. Non-Functional UI Requirements

- **Performance:** Reservation screen should render within 2s on typical network after data load; avoid N+1 calls (single view call preferred).
- **Accessibility:** Buttons and tables keyboard-navigable; confirmation dialogs accessible; status text not color-only.
- **Responsiveness:** Usable on tablet width; allocation table supports horizontal scroll if needed.
- **i18n/timezone:** Display timestamps in user locale/timezone per Moqui/Quasar defaults (no custom conversions unless project requires).
- **Security:** Do not expose hidden identifiers unnecessarily; rely on backend authorization; avoid logging SKUs/IDs in client console in production mode.

---

## 15. Applied Safe Defaults

- SD-UX-EMPTY-STATE: Provide a â€œNo reservation exists yetâ€ empty state with a primary CTA to â€œReserve (SOFT)â€. Qualifies as safe UX ergonomics. Impacted sections: UX Summary, Alternate/Empty states.
- SD-UX-CONFIRM-DESTRUCTIVE: Require confirmation dialog for â€œPromote to HARDâ€ and â€œCancel Reservationâ€ actions. Qualifies as safe UX ergonomics to prevent accidental irreversible/impactful actions. Impacted sections: UX Summary, Functional Behavior, Acceptance Criteria.
- SD-ERR-STD-MAPPING: Standard mapping of HTTP 400/403/404/409 to inline/toast messages without inventing domain policy. Qualifies because itâ€™s generic error handling. Impacted sections: Business Rules, Error Flows, Acceptance Criteria.

---

## 16. Open Questions

1. **Backend contract:** What are the exact Moqui service names or REST endpoints (paths, request/response schemas) for:
   - load reservation by `workOrderLineId`
   - upsert reservation
   - promote to HARD
   - cancel reservation  
   (Blocking: frontend cannot wire transitions reliably without these.)
2. **Workexec context source:** On the reservation screen, does the frontend receive `sku` and `requiredQty` from Work Execution UI state, or must it load workorder line details from a workexec service?
3. **Editability of required quantity:** Is `requiredQuantity` editable in the reservation UI, or is it strictly derived from the workorder line and only updated by workexec?
4. **Zero/negative quantity behavior:** Should frontend treat `requiredQty <= 0` as â€œcancel reservationâ€ (as backend story suggests) or block as invalid input?
5. **Audit/history availability:** Will backend provide an audit/history feed for reservation/allocation changes? If yes, what schema and paging strategy?
6. **Permissions for reserve/cancel:** Besides `inventory.reserve.hard`, what permissions govern:
   - creating/updating SOFT reservations
   - cancelling reservations
   (Need exact permission strings to enforce UI affordances consistently.)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Fulfillment: Reserve/Allocate Stock to Workorder Lines â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/93

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Fulfillment: Reserve/Allocate Stock to Workorder Lines  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/93  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Fulfillment: Reserve/Allocate Stock to Workorder Lines

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As a **System**, I want to reserve stock for workorder lines so that parts are held for the job.

## Details  
- Soft allocation vs hard reservation.  
- Handle partial reservations and backorders.

## Acceptance Criteria  
- Reservation created/updated.  
- ATP reflects allocations.  
- Idempotent updates.  
- Audited.

## Integrations  
- Workexec requests reservation; inventory responds with allocations and pick tasks.

## Data / Entities  
- Reservation, Allocation, WorkorderLineRef

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Inventory Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #94: [FRONTEND] [STORY] Putaway: Replenish Pick Faces from Backstock (Optional) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/94
File: ./scripts/story-work/frontend/94/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STOP: Clarification required before finalization

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Putaway: Replenish Pick Faces from Backstock (Optional) â€” Replenishment Task List + Execute Move

### Primary Persona
Warehouse Associate (secondary: Inventory Manager)

### Business Value
Keeps pick faces stocked by surfacing system-generated replenishment tasks and enabling associates to complete inventory moves with auditability, reducing mechanic stockouts and pick delays.

---

## 2. Story Intent

### As a / I want / So that
**As a** Warehouse Associate,  
**I want** to view replenishment tasks and execute the backstock â†’ pick face move,  
**so that** pick locations stay stocked and the system records an auditable inventory transfer.

### In-scope
- View a list of open replenishment tasks (PENDING / IN_PROGRESS).
- View task details (item, qty, source, destination, trigger metadata).
- Start work on a task (mark IN_PROGRESS).
- Complete a task by confirming quantities moved and submitting a transfer.
- See success confirmation and updated task status.
- View audit/status history for a task (read-only).

### Out-of-scope
- Defining/editing `ReplenishmentPolicy` (min/max) UI.
- Automatically generating tasks (event/batch logic) â€” backend responsibility.
- Complex picking UX (batch picking routes, cart optimization).
- Inventory valuation/costing display or edits.
- Substitution, backorders, or multi-SKU fulfillment (not defined).

---

## 3. Actors & Stakeholders
- **Warehouse Associate (Primary user):** executes replenishment tasks.
- **Inventory Manager:** monitors replenishment workload/compliance.
- **Mechanic/Technician (Indirect beneficiary):** faster picks; fewer stockouts.
- **System/Inventory Services (Backend):** provides tasks, enforces idempotency, records ledger transfers and audits.

---

## 4. Preconditions & Dependencies
1. Backend exposes APIs to:
   - Query replenishment tasks and task details.
   - Transition task statuses (PENDING â†’ IN_PROGRESS â†’ COMPLETED; optional CANCELLED).
   - Execute/record inventory transfer for a task (creates InventoryLedgerEntry of type Transfer).
2. Backend enforces business rules from inventory domain (duplicate prevention, task idempotency, sourcing decisions).
3. User authentication exists; authorization checks are enforceable per endpoint.
4. Storage locations have identifiable labels/barcodes in the system (at least displayable).
5. Inventory quantities are stored in a consistent unit of measure for the SKU (frontend treats quantity as integer unless contract says otherwise).

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: **Inventory â†’ Putaway/Replenishment â†’ Replenishment Tasks**
- Optional deep link: `/inventory/replenishment/tasks` and `/inventory/replenishment/tasks/<taskId>`

### Screens to create/modify
1. **Screen:** `apps/pos/screen/inventory/ReplenishmentTaskList.xml`
2. **Screen:** `apps/pos/screen/inventory/ReplenishmentTaskDetail.xml`
3. (Optional) Reusable widget/screenlet for task status chip + trigger metadata.

### Navigation context
- From Inventory module.
- Task list â†’ task detail.
- Task detail â†’ complete flow â†’ returns to task detail (now COMPLETED) or back to list.

### User workflows
**Happy path**
1. Associate opens Task List; filters to their site/location (if supported) and status=PENDING.
2. Selects a task to open details.
3. Clicks **Start Task** (sets IN_PROGRESS).
4. Confirms **quantity moved** (default to task quantity) and submits **Complete Task**.
5. System records transfer and marks task COMPLETED; UI shows confirmation and ledger reference (if provided).

**Alternate paths**
- Task already claimed/in-progress by someone else â†’ show read-only with message.
- Partial move allowed? (unclear) If allowed, complete with less quantity and leave task open or split tasks (unclear).
- Insufficient stock at source at execution time â†’ backend rejects; UI shows error and keeps task IN_PROGRESS or reverts (backend-defined).

---

## 6. Functional Behavior

### Triggers
- User navigates to list/detail screens.
- User actions: Start, Complete (and possibly Cancel).

### UI actions
**Task List**
- Load tasks with filters:
  - Status (default: PENDING, IN_PROGRESS)
  - Search by SKU / taskId
  - Filter by source/destination location (if supported)
  - Sort by createdAt (default: oldest first)
- Row click opens detail.
- If backend supports, quick action: â€œStartâ€ from list.

**Task Detail**
- Shows task header: status, SKU, qty, source, destination, triggerType, decisionReason, sourcingReason, createdAt, assignedTo.
- Actions by state:
  - PENDING: Start Task
  - IN_PROGRESS: Complete Task (and possibly Cancel)
  - COMPLETED/CANCELLED: no write actions
- Complete Task form:
  - quantityMoved (prefill = task.quantity; editable per rules below)
  - optional notes (if supported by backend)
  - submit

### State changes
- `PENDING` â†’ `IN_PROGRESS` via explicit user action.
- `IN_PROGRESS` â†’ `COMPLETED` on successful transfer submission.
- Optional: `PENDING/IN_PROGRESS` â†’ `CANCELLED` (unclear if allowed).

### Service interactions
- Read: list + detail + history/audit (if endpoint exists).
- Write: start transition; complete (transfer + status update) ideally as one backend transaction.

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- `quantityMoved`:
  - Must be a positive integer.
  - Must be â‰¤ task.quantity **unless backend supports partial replenishment completion semantics** (OPEN QUESTION).
- Locations and SKU are read-only on the UI (sourcing is deterministic and backend-owned).
- Prevent editing of system-managed metadata: triggerType, decisionReason, sourcingReason.

### Enable/disable rules
- **Start Task** enabled only when:
  - task.status == PENDING
  - user has permission to work replenishment tasks (permission name is unclear â†’ OPEN QUESTION)
- **Complete Task** enabled only when:
  - task.status == IN_PROGRESS
  - (if assignedTo exists) assignedTo == currentUser (else show explanation) â€” assignment model unclear (OPEN QUESTION)

### Visibility rules
- Assigned-to block shown only if field exists.
- Audit/history section shown if backend provides history; otherwise omit.

### Error messaging expectations
- 400 validation: show field-level error (quantityMoved) or banner (general).
- 403: show â€œYou donâ€™t have permission to perform this action.â€
- 409 concurrency: show â€œTask was updated by another user; refresh to continue.â€ Provide Refresh button.
- 404: â€œTask not found.â€

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `ReplenishmentTask`
- `ReplenishmentPolicy` (reference only; not edited here)
- `InventoryLedgerEntry` (reference link/ID after completion, if provided)

### Fields (type, required, defaults)
**ReplenishmentTask**
- `taskId` (UUID, required, read-only)
- `itemSKU` (string, required, read-only)
- `quantity` (integer, required, read-only)
- `sourceLocationId` (UUID/string, required, read-only)
- `destinationLocationId` (UUID/string, required, read-only)
- `status` (enum: PENDING/IN_PROGRESS/COMPLETED/CANCELLED, required, read-only except via transitions)
- `triggerType` (enum EVENT/BATCH, read-only)
- `decisionReason` (enum BELOW_MIN/SAFETY_SCAN, read-only)
- `sourcingReason` (string/enum, read-only)
- `createdAt` (timestamp, read-only)
- `assignedTo` (UUID, optional, read-only)

**Complete form (UI model)**
- `quantityMoved` (integer, required; default = `ReplenishmentTask.quantity`)
- `completionNote` (string, optional) **only if backend supports**

### Read-only vs editable by state/role
- All task fields read-only always.
- Only transition actions are available depending on state and permissions.

### Derived/calculated fields
- Display labels for locations (e.g., barcode/human name) derived from `sourceLocationId` and `destinationLocationId` by calling a location lookup service (if exists; otherwise show IDs) (OPEN QUESTION).

---

## 9. Service Contracts (Frontend Perspective)

> Backend contracts are not provided in this frontend issue; endpoints below are **placeholders** that must be mapped to actual Moqui services once confirmed.

### Load/view calls
- `GET /replenishmentTasks?status=...&filters...`  
  Returns list with pagination metadata.
- `GET /replenishmentTasks/{taskId}`  
  Returns full task detail.
- Optional: `GET /replenishmentTasks/{taskId}/history` for status/audit entries.

### Create/update calls
- None (task creation is backend/system-generated).

### Submit/transition calls
- Start task:
  - `POST /replenishmentTasks/{taskId}/start`
  - Expected response: updated task (status=IN_PROGRESS; assignedTo set or unchanged)
- Complete task (preferred atomic):
  - `POST /replenishmentTasks/{taskId}/complete` with body `{ quantityMoved, note? }`
  - Expected response: updated task (COMPLETED) + ledger transfer reference `{ ledgerEntryId? }`
- If backend splits transfer vs task completion (not preferred):
  - `POST /inventory/transfer` then `POST /replenishmentTasks/{taskId}/complete` (would require extra error handling and compensation) (OPEN QUESTION)

### Error handling expectations
- 400: validation details in response; map to inline form errors and banner.
- 403: show permission error; disable further write actions.
- 409: indicate stale state; offer refresh and retry.
- 500/timeout: show transient error; keep user input; allow retry.

---

## 10. State Model & Transitions

### Allowed states (as per backend reference)
- `PENDING`
- `IN_PROGRESS`
- `COMPLETED`
- `CANCELLED`

### Role-based transitions (UI enforcement; backend authoritative)
- Warehouse Associate:
  - PENDING â†’ IN_PROGRESS (Start)
  - IN_PROGRESS â†’ COMPLETED (Complete)
  - (Optional) PENDING/IN_PROGRESS â†’ CANCELLED (Cancel) **unclear**
- Inventory Manager:
  - May view all tasks; may override/cancel **unclear**

### UI behavior per state
- PENDING: show Start button; hide completion form.
- IN_PROGRESS: show completion form + Complete button.
- COMPLETED/CANCELLED: show summary + audit info; no edit actions.

---

## 11. Alternate / Error Flows

1. **Empty list**
   - No open tasks: show empty state â€œNo replenishment tasks foundâ€ and suggest adjusting filters.
2. **Concurrency conflict**
   - Task transitions return 409: UI refreshes task detail; if now COMPLETED/CANCELLED, show updated state and disable actions.
3. **Unauthorized**
   - Any write returns 403: show error and disable action buttons.
4. **Execution-time inventory constraint**
   - Completing task fails due to insufficient source stock or invalid location status: show backend message; keep task in IN_PROGRESS and allow retry or back out (backend-defined).
5. **Network failure**
   - Show retry; do not clear form input.

---

## 12. Acceptance Criteria

```gherkin
Scenario: View open replenishment tasks
  Given I am an authenticated Warehouse Associate
  When I navigate to Inventory > Putaway/Replenishment > Replenishment Tasks
  Then I see a list of replenishment tasks filtered to status PENDING and IN_PROGRESS by default
  And each row displays taskId, itemSKU, quantity, source location, destination location, status, and createdAt

Scenario: View replenishment task details
  Given a replenishment task exists with status PENDING
  When I open the task detail page
  Then I see the taskâ€™s itemSKU, quantity, source location, destination location, triggerType, decisionReason, sourcingReason, and status

Scenario: Start a replenishment task
  Given a replenishment task exists with status PENDING
  And I have permission to work replenishment tasks
  When I click "Start Task"
  Then the task status becomes IN_PROGRESS
  And the UI shows the completion form with quantityMoved defaulted to the task quantity

Scenario: Complete a replenishment task successfully
  Given a replenishment task exists with status IN_PROGRESS
  When I enter quantityMoved equal to the task quantity
  And I click "Complete Task"
  Then the system records an inventory transfer from the source location to the destination location
  And the task status becomes COMPLETED
  And I see a success message

Scenario: Prevent completion with invalid quantity
  Given a replenishment task exists with status IN_PROGRESS
  When I enter quantityMoved as 0 or a negative number
  And I click "Complete Task"
  Then I see a validation error on quantityMoved
  And no request to complete the task is submitted

Scenario: Handle permission error on start/complete
  Given a replenishment task exists with status PENDING or IN_PROGRESS
  When I attempt to Start or Complete the task without sufficient permission
  Then I receive a 403 response
  And the UI displays an authorization error message
  And write actions are disabled for that task

Scenario: Handle concurrency conflict during completion
  Given a replenishment task exists with status IN_PROGRESS
  And another user completes the task before I submit
  When I click "Complete Task"
  Then I receive a 409 conflict response
  And the UI prompts me to refresh
  And after refresh the task status is shown as COMPLETED and actions are disabled
```

---

## 13. Audit & Observability

### User-visible audit data
- On task detail, show (if provided):
  - createdAt, createdBy/system
  - status history entries (fromStatus, toStatus, changedAt, changedBy)
  - triggerType, decisionReason, sourcingReason (read-only metadata)

### Status history
- Display a chronological list of transitions.
- If unavailable from backend, show at least current status + createdAt.

### Traceability expectations
- Completion success view should display any returned reference IDs:
  - `ledgerEntryId` (or equivalent transfer reference)
  - `taskId`

---

## 14. Non-Functional UI Requirements
- **Performance:** task list loads first page within 2s on typical connection; show loading skeleton/spinner.
- **Accessibility:** keyboard navigable actions; form fields have labels; status conveyed with text (not color-only).
- **Responsiveness:** usable on tablet widths; list supports horizontal truncation with details in row expansion if needed.
- **i18n/timezone:** timestamps rendered in userâ€™s locale/timezone; IDs/SKUs not localized.

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide deterministic empty-state messaging for no tasks; safe UI ergonomics; impacts UX Summary, Error Flows.
- SD-UX-PAGINATION: Default server-driven pagination for task list; safe because it does not change domain logic; impacts UX Summary, Service Contracts.
- SD-ERR-HTTP-MAP: Standard mapping of 400/403/404/409/5xx to inline/banner messages; safe because itâ€™s presentation-layer only; impacts Business Rules, Error Flows.

---

## 16. Open Questions
1. **Backend API contract:** What are the actual Moqui service names / REST paths for listing tasks, viewing detail, starting, and completing a task? Is completion atomic (transfer + status) in one call?
2. **Permissions:** What permission strings/roles gate: view tasks, start task, complete task, cancel task?
3. **Assignment semantics:** When a task is started, is `assignedTo` set/required, and must only the assignee complete it?
4. **Partial completion policy:** Can `quantityMoved` be less than task.quantity? If yes, what happens to the remaining quantity (task remains open, new task created, or task adjusted)?
5. **Cancel behavior:** Is CANCELLED a supported UI action? Who can cancel and under what conditions?
6. **Location display:** Is there a service to resolve `locationId` to a human label/barcode per site? If not, should we display raw IDs only?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Putaway: Replenish Pick Faces from Backstock (Optional) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/94

Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Putaway: Replenish Pick Faces from Backstock (Optional)

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As an **Inventory Manager**, I want replenishment moves so that pick locations stay stocked.

## Details
- Define min/max for pick bins.
- Create replenishment tasks when below min.

## Acceptance Criteria
- Replenishment tasks created.
- Moves recorded.
- Audited.

## Integrations
- Improves mechanic pick speed; reduces stockouts.

## Data / Entities
- ReplenishmentPolicy, ReplenishmentTask, InventoryLedgerEntry(Transfer)

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #95: [FRONTEND] [STORY] Putaway: Execute Put-away Move (Staging â†’ Storage) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/95
File: ./scripts/story-work/frontend/95/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Putaway: Execute Put-away Move (Staging â†’ Storage)

### Primary Persona
Stock Clerk (warehouse/mobile user)

### Business Value
Accurately moves received inventory from staging to storage so it becomes available for picking, with an auditable ledger trail and completed putaway tasks.

---

## 2. Story Intent

### As a / I want / So that
- **As a** Stock Clerk  
- **I want** to execute a confirmed put-away move by scanning source and destination locations (and the item/pallet)  
- **So that** the system updates on-hand by location, records an immutable PUTAWAY ledger entry, and marks the putaway task complete for downstream picking accuracy.

### In-scope
- Moqui/Vue/Quasar frontend flow to **execute** a putaway move for an existing `PutawayTask`
- Scan/enter **source location**, **item/pallet identifier**, **destination location**
- Show a confirmation summary and submit the move
- Display success/failure outcomes and reflect task completion
- Permission-aware handling of validation/authorization errors returned by backend

### Out-of-scope
- Creating putaway tasks, assigning tasks, or planning/suggesting destination locations (unless backend already provides suggestions)
- Performing reconciliation/cycle count/inventory adjustment flows (only link/navigate if such screens exist; otherwise show actionable error)
- Defining/altering cost valuation logic (inventory backend owns cost)
- Implementing backend services/entities (frontend integrates only)

---

## 3. Actors & Stakeholders
- **Stock Clerk (Primary user):** performs scanning and confirmation
- **Inventory Service (System):** validates locations/SKU, posts ledger, updates on-hand and task status
- **Work Execution (Stakeholder):** depends on accurate pick locations and availability
- **Inventory Manager (Stakeholder):** cares about auditability and exception handling (overrides, capacity)

---

## 4. Preconditions & Dependencies
- User is authenticated in the frontend and has access to inventory putaway screens
- A `PutawayTask` exists and is in an executable state (backend reference: `IN_PROGRESS` or `PENDING_EXECUTION`)
- Backend endpoints exist to:
  - load a putaway task and its required scan targets
  - validate/execute the putaway move atomically
- Barcode/location scanning capability exists in frontend (camera scanner or hardware wedge) or manual entry fallback
- Permissions are enforced by backend (frontend must handle `403` gracefully)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- From a Putaway Task list screen (existing or to be added): â€œExecuteâ€ action on a selected task
- Direct route with task id parameter (deep link): `/inventory/putaway/task/{putawayTaskId}/execute` (route is a proposal; confirm with project routing conventions)

### Screens to create/modify (Moqui screens)
1. **Screen: `PutawayTaskList`** (modify if exists; otherwise create minimal list)
   - Shows tasks with status filter and an â€œExecuteâ€ action
2. **Screen: `PutawayTaskExecute`** (create)
   - Guided scan workflow (source â†’ item/pallet â†’ destination â†’ confirm)
3. **Screen: `PutawayTaskDetail`** (optional modify)
   - Shows task status, ledger reference/transactionId after completion, audit metadata if available

### Navigation context
- Inventory â†’ Putaway â†’ Task List â†’ Execute Task
- After success: return to Task Detail or Task List with the task marked `COMPLETED`

### User workflows
**Happy path**
1. Open Execute for a task
2. Scan/enter **source (staging) location**
3. Scan/enter **item/pallet identifier**
4. Scan/enter **destination (storage) location**
5. Review summary and **Confirm Putaway**
6. See success, task marked complete, and updated on-hand context (if displayed)

**Alternate paths**
- Destination invalid for SKU â†’ show blocking error; allow rescan destination
- Destination full/capacity error â†’ show blocking error; allow rescan destination or split (only if backend supports split)
- Source shows zero on-hand â†’ show blocking error; provide next-step guidance (reconciliation required) without attempting to â€œfixâ€ in UI
- Unauthorized (403) for execute/override â†’ show permission error; disable confirm action

---

## 6. Functional Behavior

### Triggers
- User clicks â€œExecuteâ€ on a `PutawayTask`
- Scan events (barcode input) populate fields and trigger backend validation where supported
- User clicks â€œConfirm Putawayâ€ to submit

### UI actions
- Stepper-style progression (or equivalent): Source â†’ Item/Pallet â†’ Destination â†’ Confirm
- Each scan field supports:
  - scan input (keyboard wedge) and manual typing
  - â€œClearâ€ action
- Confirmation step shows:
  - task identifier
  - SKU/product reference
  - quantity to move (task quantity)
  - fromLocation (source)
  - toLocation (destination)

### State changes (frontend view state)
- Local view state: `currentStep`, `scannedSourceId/code`, `scannedItemId/code`, `scannedDestinationId/code`, `isSubmitting`, `lastError`
- Server state changes on submit (backend-owned):
  - on-hand decrement at source + increment at destination
  - `InventoryLedgerEntry` created with `transactionType=PUTAWAY`
  - `PutawayTask.status` â†’ `COMPLETED`
  - audit log written

### Service interactions (frontend â†’ Moqui backend)
- Load task details on screen entry
- Optionally validate scanned codes as user proceeds (if backend provides validate endpoints)
- Execute putaway on confirm (single atomic call)

---

## 7. Business Rules (Translated to UI Behavior)

### Validation (UI-level, before calling backend)
- Require all scan inputs before enabling â€œConfirm Putawayâ€:
  - source location
  - item/pallet identifier
  - destination location
- Prevent submission while `isSubmitting=true`
- Display backend validation errors verbatim where safe (mapped to user-friendly messages)

### Enable/disable rules
- â€œConfirm Putawayâ€ disabled unless:
  - all required fields present
  - task status is executable (not `COMPLETED`, not canceled)
  - user has permission (if permission info is available from backend; otherwise rely on handling 403)

### Visibility rules
- Show task immutable info (SKU, qty) as read-only
- If task already `COMPLETED`, show read-only completion summary and hide confirm controls

### Error messaging expectations (must map backend codes)
Backend reference enumerates these codes; UI must handle at minimum:
- `LOCATION_NOT_VALID_FOR_SKU` â†’ â€œDestination location is not valid for this item. Scan a different storage location.â€
- `NO_ON_HAND_AT_SOURCE_LOCATION` â†’ â€œNo on-hand quantity at the source location. Reconciliation is required before putaway.â€
- Capacity full error code **TBD** (see Open Questions) â†’ message instructing user to select another location (and split if supported)
- Generic validation errors â†’ show inline near relevant field when possible, otherwise as banner/toast
- 403 â†’ â€œYou donâ€™t have permission to perform this action.â€

---

## 8. Data Requirements

### Entities involved (frontend-facing)
- `PutawayTask` (read/update via service)
- `InventoryLedgerEntry` (created by backend; frontend may display reference)
- `StorageLocation` (resolved by barcode/code)
- `AuditLog` or audit metadata (read-only display if available)

### Fields (type, required, defaults)
**PutawayTask (read)**
- `putawayTaskId` (string/ID, required)
- `status` (enum, required)
- `productId` or `sku` (string/ID, required)
- `quantity` (decimal, required; precision rules owned by backend)
- `sourceLocationId` and/or `sourceLocationCode` (required by task)
- (optional) `itemOrPalletId` expected by task (if task binds to a pallet/container)

**Execute Putaway request (submit)**
- `putawayTaskId` (required)
- `fromLocationCode` or `fromLocationId` (required)
- `toLocationCode` or `toLocationId` (required)
- `itemOrPalletCode` (required if backend requires; otherwise optional) **TBD**
- `quantity` (optional if implied by task; **must not assume**â€”see Open Questions)

**Response (read)**
- `transactionId` (string, required for success display)
- `putawayTaskStatus` (enum, required)
- (optional) updated on-hand snapshots for from/to locations (nice to show, not required) **TBD**

### Read-only vs editable by state/role
- Read-only always: task SKU/product, planned quantity, task status
- Editable: scan inputs until submission; after success become read-only
- Override inputs (reason/justification/approver) only if backend supports overrides and user has permissions **TBD** (see Open Questions)

### Derived/calculated fields
- Display-only: â€œMove summaryâ€ assembled from task + scanned values
- Do not calculate availability/ATP in frontend; show backend-provided values only

---

## 9. Service Contracts (Frontend Perspective)

> Note: Exact Moqui service names/paths must align with backend implementation. Below are frontend-required contracts; if different in backend, adapt mapping but keep behaviors.

### Load/view calls
1. **Get Putaway Task**
   - Request: `GET /inventory/putaway/task/{putawayTaskId}`
   - Response includes: status, SKU/product, qty, expected source location, any constraints
   - Errors: 404 (not found), 403 (no access)

2. **(Optional) Resolve/validate scanned codes**
   - `GET /inventory/location/resolve?code=...`
   - `GET /inventory/putaway/task/{id}/validateDestination?locationCode=...`
   - If not available, validation occurs during execute call only.

### Create/update calls
- None directly; execute call performs atomic updates

### Submit/transition calls
1. **Execute Putaway**
   - `POST /inventory/putaway/execute`
   - Body: identifiers described in Data Requirements
   - Success: returns `transactionId`, updated task status (COMPLETED), timestamps
   - Validation failures: `400` with machine-readable code(s) and field-level details
   - Unauthorized: `403`
   - Concurrency: `409` if task already completed/changed or inventory changed such that move canâ€™t proceed

### Error handling expectations
- Map HTTP status to UI:
  - 400: show validation error; keep user on same step and highlight field if possible
  - 403: show permission error; disable confirm
  - 404: show â€œTask not foundâ€ with link back to list
  - 409: show â€œTask was updated elsewhere. Reload required.â€ with Reload action
  - 500: show generic error and allow retry (idempotency considerations rely on backend; see Open Questions)

---

## 10. State Model & Transitions

### Allowed states (PutawayTask)
- `PENDING_EXECUTION` (executable)
- `IN_PROGRESS` (executable)
- `COMPLETED` (non-executable; read-only)

(Other states like `CANCELLED` may exist but are not defined here.)

### Role-based transitions
- Stock Clerk can transition executable â†’ `COMPLETED` only by successful execute API
- Overrides (capacity/compatibility) require specific permissions if supported:
  - `OVERRIDE_LOCATION_COMPATIBILITY`
  - `OVERRIDE_LOCATION_CAPACITY`
  (Permissions must be enforced by backend; UI only reacts)

### UI behavior per state
- Executable: show scan workflow and confirm
- Completed: show completion summary, ledger transactionId, disable scans/confirm
- Unknown/unsupported state: show read-only task info and a message â€œThis task cannot be executed in its current status.â€

---

## 11. Alternate / Error Flows

### Validation failures
- Missing scan inputs â†’ client-side block; show inline required markers
- Backend `LOCATION_NOT_VALID_FOR_SKU` â†’ remain on Destination step; clear destination field; prompt to rescan
- Backend `NO_ON_HAND_AT_SOURCE_LOCATION` â†’ remain on Confirm step (or Source step), disable confirm; show guidance text and link back

### Concurrency conflicts
- If backend returns 409 (task completed elsewhere or inventory changed):
  - show banner â€œTask changed. Reload to continue.â€
  - provide Reload action calling Get Putaway Task again
  - if status is now COMPLETED, switch to completed view

### Unauthorized access
- 403 on load: show access denied and link back
- 403 on execute: show access denied; keep scans but disable confirm to prevent repeated attempts

### Empty states
- Task list empty: show â€œNo putaway tasks availableâ€ and allow refresh
- Scanner not available: allow manual entry for codes

---

## 12. Acceptance Criteria

### Scenario 1: Successful Put-away move completes task
**Given** a PutawayTask is in status `IN_PROGRESS` for quantity `10` of SKU `ABC-123` from source location `STAGING-01`  
**And** the user opens the Execute Putaway screen for that task  
**When** the user scans/enters source `STAGING-01`  
**And** scans/enters the required item/pallet identifier  
**And** scans/enters destination `A-01-B-03`  
**And** clicks â€œConfirm Putawayâ€  
**Then** the frontend calls the Execute Putaway service once  
**And** on success shows a confirmation including a `transactionId`  
**And** the task is shown as `COMPLETED` in the UI.

### Scenario 2: Destination invalid for SKU blocks move
**Given** an executable PutawayTask is loaded  
**When** the user submits a destination that the backend rejects as incompatible  
**Then** the frontend displays error code/message for `LOCATION_NOT_VALID_FOR_SKU`  
**And** no success state is shown  
**And** the user can rescan/enter a different destination and retry.

### Scenario 3: Source has zero on-hand blocks move
**Given** an executable PutawayTask is loaded  
**When** the user submits and the backend returns `NO_ON_HAND_AT_SOURCE_LOCATION`  
**Then** the frontend displays a blocking error explaining reconciliation is required  
**And** the Confirm action remains disabled until the user changes inputs or reloads  
**And** the UI does not attempt to create inventory or proceed.

### Scenario 4: Task already completed (concurrency)
**Given** the user has the Execute screen open for a PutawayTask  
**When** the backend responds `409 Conflict` indicating the task is already completed  
**Then** the frontend prompts the user to reload  
**And** after reload the task is displayed as `COMPLETED` and the execute controls are hidden/disabled.

### Scenario 5: Unauthorized user cannot execute
**Given** a user without required permission attempts to confirm putaway  
**When** the backend responds `403 Forbidden`  
**Then** the frontend shows an access denied message  
**And** does not show success  
**And** prevents repeated submissions by disabling Confirm until reload/navigation.

---

## 13. Audit & Observability

### User-visible audit data
- After success, show:
  - `transactionId`
  - completion timestamp (if returned)
  - actor (current user display name if available, otherwise omit)
- If backend provides audit history, show a â€œView audit detailsâ€ link (optional; do not invent if absent)

### Status history
- Display task status and last updated timestamp (if provided)

### Traceability expectations
- All execute requests include a correlation id header (if project standard exists) and propagate to logs
- Frontend logs (console/dev) should not expose sensitive data; record minimal error diagnostics

---

## 14. Non-Functional UI Requirements
- **Performance:** initial task load < 2s on typical network; avoid N+1 calls during scanning
- **Accessibility:** all inputs labeled; step changes announced; error messages associated with fields
- **Responsiveness:** optimized for mobile scanner devices; large tap targets; works in portrait
- **i18n/timezone:** timestamps displayed in user locale/timezone if present; no currency handling required

---

## 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide standard empty-state messaging and refresh action on task list; safe because it does not change domain logic; impacts UX Summary, Error Flows.
- SD-UX-MANUAL-ENTRY-FALLBACK: Allow manual entry when scanner is unavailable; safe as itâ€™s purely input modality; impacts UX Summary, Functional Behavior.
- SD-ERR-HTTP-MAP: Standard mapping of 400/403/404/409/500 to banner/inline errors; safe because itâ€™s presentation-only and relies on backend codes; impacts Service Contracts, Error Flows.

---

## 16. Open Questions
1. **Backend contract alignment:** What are the exact Moqui endpoints/services and payload schemas for:
   - loading a PutawayTask
   - executing the putaway (required fields; especially whether `quantity` is required or always implied by task)?
2. **Item/pallet identifier requirement:** Is scanning an item/pallet/container **mandatory** for all putaways, or only for palletized/serialized flows? What field name and format should the frontend use?
3. **Capacity full error:** What error code and response shape represents â€œdestination full capacity,â€ and does the backend support **split quantity across multiple locations** in one task execution?
4. **Overrides UX:** Are compatibility/capacity overrides enabled in v1? If yes:
   - how does frontend discover permissions (`OVERRIDE_LOCATION_COMPATIBILITY`, `OVERRIDE_LOCATION_CAPACITY`)?
   - what reason codes list should be used, and is manager approval captured in the same request?
5. **Task state model:** Are there additional `PutawayTask` states (e.g., `CANCELLED`, `ON_HOLD`) that must be handled explicitly in UI?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Putaway: Execute Put-away Move (Staging â†’ Storage) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/95

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Putaway: Execute Put-away Move (Staging â†’ Storage)  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/95  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Putaway: Execute Put-away Move (Staging â†’ Storage)

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As a **Stock Clerk**, I want to execute put-away moves so that inventory becomes available for picking.

## Details  
- Scan from/to locations.  
- Update ledger with movement PutAway.

## Acceptance Criteria  
- Ledger entry created.  
- On-hand updated per destination.  
- Task marked complete.  
- Audited.

## Integrations  
- Workexec sees accurate pick locations.

## Data / Entities  
- InventoryLedgerEntry(PutAway), PutawayTaskState, AuditLog

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Inventory Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #96: [FRONTEND] [STORY] Putaway: Generate Put-away Tasks from Staging  
File: ./scripts/story-work/frontend/96/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

# 1. Story Header

## Title
[FRONTEND] [STORY] Putaway: Generate Put-away Tasks from Staging

## Primary Persona
Stock Clerk (with supporting personas: Warehouse Manager)

## Business Value
Ensure items received into staging are promptly routed into correct storage locations via generated put-away tasks, improving inventory accuracy, throughput, and auditability.

---

# 2. Story Intent

## As a / I want / So that
**As a** Stock Clerk,  
**I want** to view and claim system-generated put-away tasks created from completed receipts (with suggested destinations and fallback indicators),  
**so that** I can move items from staging to appropriate storage locations efficiently and consistently.

## In-scope
- Frontend screens to:
  - List put-away tasks generated from completed receipts
  - View a put-away taskâ€™s details (source staging, qty, suggested destination, fallback context)
  - Claim / assign tasks (based on permissions)
  - Handle tasks that require manual destination selection (route to destination selection UI entry point; selection UX may be minimal if a dedicated story exists)
- Moqui screen/actions wiring to call backend services/endpoints to load tasks and perform claim/assign operations.
- UI behavior aligned to backend story reference (task statuses, fallback behavior, assignment model).

## Out-of-scope
- Implementing the backend generation of tasks on GoodsReceipt completion (assumed provided by backend).
- Executing put-away (confirming actual movement/completing tasks) unless already supported elsewhere.
- Put-away rule configuration UI (PutawayRule CRUD).
- Designing storage topology management UI.

---

# 3. Actors & Stakeholders
- **Stock Clerk:** views/claims tasks; may select destination when required (if permitted).
- **Warehouse Manager:** assigns/reassigns tasks; monitors task pool.
- **Inventory Controller/Auditor:** expects traceability (who claimed/assigned, what was suggested vs final).
- **System (Inventory backend):** generates tasks and provides suggested/fallback metadata.

---

# 4. Preconditions & Dependencies
- Backend generates `PutawayTask` records when `GoodsReceipt` transitions to `COMPLETED` (per backend story reference).
- Backend exposes APIs/services to:
  - Query tasks (filters by status, assignee, receipt)
  - Claim a task (UNASSIGNED â†’ ASSIGNED with assignee=current user)
  - Assign/reassign a task (manager action)
  - (If supported) resolve/select destination for `REQUIRES_LOCATION_SELECTION`
- AuthN/AuthZ integrated into frontend; permissions are enforced server-side and reflected in UI:
  - `CLAIM_PUTAWAY_TASK`
  - `ASSIGN_PUTAWAY_TASK`
  - `SELECT_PUTAWAY_LOCATION` (only if destination selection is supported in this UI)
- Storage locations exist; task payload includes human-readable refs or IDs resolvable to display names/barcodes.

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Main navigation: **Inventory â†’ Put-away Tasks**
- Contextual link from a completed Goods Receipt detail screen (if exists): â€œView Put-away Tasksâ€ filtered by `sourceReceiptId`.

## Screens to create/modify (Moqui)
1. **Screen:** `Inventory/PutawayTaskList`
   - Lists tasks in shared pool with filters and actions (claim/assign).
2. **Screen:** `Inventory/PutawayTaskDetail`
   - Shows task details and provides claim/assign actions.
3. **(Optional minimal) Screen/dialog:** `Inventory/PutawayTaskSelectDestination`
   - Only used for status `REQUIRES_LOCATION_SELECTION` if backend supports destination resolution via UI.

## Navigation context
- `PutawayTaskList` â†’ `PutawayTaskDetail` via `taskId`.
- From `PutawayTaskDetail`, optionally:
  - â€œSelect destinationâ€ (only if status requires and user permitted)
  - Return to list preserving filters.

## User workflows
### Happy path (Stock Clerk claims)
1. Clerk opens Put-away Tasks list.
2. Filters to `UNASSIGNED`.
3. Opens a task; reviews source staging + qty + suggested destination.
4. Clicks **Claim**.
5. Task updates to `ASSIGNED` to the clerk; list and detail reflect assignment.

### Alternate path (Manager assigns)
1. Manager opens list; selects a task.
2. Clicks **Assign** and chooses a user.
3. Task updates; assignee shown.

### Alternate path (Requires destination selection)
1. Clerk opens task in `REQUIRES_LOCATION_SELECTION`.
2. If permitted, clicks **Select Destination**.
3. Chooses a location and saves; task now has destination and is eligible for downstream execution flow (completion handled elsewhere).

---

# 6. Functional Behavior

## Triggers
- User navigates to task list/detail screens.
- User initiates claim/assign/select-destination actions.

## UI actions
### Putaway Task List
- Search/filter:
  - Status (multi-select)
  - Assignee (Me / Unassigned / specific user if permitted)
  - Source Receipt ID (optional)
  - Product (by name/SKU if backend supports)
- Row actions (enabled by permission + state):
  - **Claim** (if `status=UNASSIGNED` and user has `CLAIM_PUTAWAY_TASK`)
  - **Assign** (if user has `ASSIGN_PUTAWAY_TASK`; opens assignee picker)

### Putaway Task Detail
- Displays:
  - Product
  - Quantity
  - Source location (staging)
  - Suggested destination (final suggested)
  - Original suggested destination + fallback reason when present
  - Status
  - Assignee
  - Links: source receipt (if route exists), locations (if route exists)
- Actions:
  - Claim (UNASSIGNED)
  - Assign/Reassign (manager)
  - Select destination (only when `REQUIRES_LOCATION_SELECTION` and permitted)

## State changes (frontend-observed)
- `UNASSIGNED` â†’ `ASSIGNED` upon claim/assign
- Task remains `REQUIRES_LOCATION_SELECTION` until destination selected (if supported)
- No frontend-driven transitions to `IN_PROGRESS/COMPLETED` in this story unless existing backend supports and is explicitly wired (not assumed).

## Service interactions
- On list load: call backend list/query service with filters + paging.
- On detail load: call backend get-by-id service.
- On claim: call claim service; refresh detail + list row.
- On assign: call assign service; refresh.
- On select destination: call destination resolution service; refresh.

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Claim button only enabled when:
  - task `status == UNASSIGNED`
  - user has permission `CLAIM_PUTAWAY_TASK`
- Assign button only enabled when:
  - user has permission `ASSIGN_PUTAWAY_TASK`
  - task `status` is not terminal (`CANCELLED`, `COMPLETED`) if those exist in UI payload
- Select destination only enabled when:
  - task `status == REQUIRES_LOCATION_SELECTION`
  - user has permission `SELECT_PUTAWAY_LOCATION`

## Enable/disable rules
- If backend returns `403`, show â€œNot authorizedâ€ and do not retry automatically.
- If backend returns validation error (400) on claim/assign due to stale status, show message and refresh task.

## Visibility rules
- Fallback indicators:
  - If `fallbackReason` present, show â€œFallback appliedâ€ and display `originalSuggestedLocation` and `finalSuggestedLocation`.
- Suggested destination display:
  - If `suggestedDestinationLocationId` null, must display â€œDestination selection requiredâ€.

## Error messaging expectations
- Map backend error payload into:
  - Banner error on screen for load failures
  - Inline dialog error for action failures (claim/assign)
- Messages must include task identifier and backend-provided message when available.

---

# 8. Data Requirements

## Entities involved (frontend consumption)
- `PutawayTask`
- `StorageLocationRef` (or storage location summary)
- `GoodsReceipt` reference (read-only link)
- `User` (assignee display/picker)

## Fields (type, required, defaults)
### PutawayTask (minimum UI fields)
- `taskId` (string/UUID, required)
- `sourceReceiptId` (string/UUID, required)
- `productId` (string/UUID, required)
- `productDisplayName` (string, required for UI unless resolvable)
- `productSku` (string, optional)
- `quantity` (decimal/string, required)
- `sourceLocationId` (string/UUID, required)
- `sourceLocationDisplay` (string, required for UI unless resolvable)
- `suggestedDestinationLocationId` (string/UUID, nullable when requires selection)
- `suggestedDestinationDisplay` (string, nullable)
- `originalSuggestedLocationId` (string/UUID, nullable)
- `originalSuggestedLocationDisplay` (string, nullable)
- `finalSuggestedLocationId` (string/UUID, nullable)
- `finalSuggestedLocationDisplay` (string, nullable)
- `fallbackReason` (enum string, nullable: `DESTINATION_FULL|UNAVAILABLE`)
- `status` (enum string: `UNASSIGNED|ASSIGNED|IN_PROGRESS|COMPLETED|CANCELLED|REQUIRES_LOCATION_SELECTION`)
- `assigneeId` (string/UUID, nullable)
- `assigneeDisplayName` (string, nullable)
- `createdAt` (datetime string, required)
- `updatedAt` (datetime string, required)

### Assign action input
- `taskId` (required)
- `assigneeId` (required)

### Select destination input (if supported)
- `taskId` (required)
- `destinationLocationId` (required)
- `reason`/note (optional; only if backend supportsâ€”do not assume)

## Read-only vs editable by state/role
- Read-only always: product, qty, source location, receipt ref, created/updated.
- Editable only via actions:
  - Assignee via claim/assign permissions
  - Destination only when status requires selection and permission granted

## Derived/calculated fields
- â€œFallback appliedâ€ derived from `fallbackReason != null`.
- â€œUnassignedâ€ derived from `assigneeId == null` and `status==UNASSIGNED`.

---

# 9. Service Contracts (Frontend Perspective)

> Note: Exact service names/paths must match backend; below are required capabilities. If Moqui uses entity-find/services rather than REST, implement equivalent Moqui service calls.

## Load/view calls
1. **List tasks**
   - Capability: query by filters + paging/sort
   - Request (conceptual):
     - `status[]`, `assigneeId` (optional), `sourceReceiptId` (optional), `productQuery` (optional)
     - `pageIndex`, `pageSize`, `sortBy`, `sortOrder`
   - Response:
     - `items: PutawayTaskSummary[]`, `totalCount`

2. **Get task detail**
   - Input: `taskId`
   - Output: full `PutawayTask` for display

## Create/update calls
- None (task creation is system-triggered by receipt completion)

## Submit/transition calls
1. **Claim task**
   - Input: `taskId`
   - Server determines assignee = current user
   - Expected result: updated task (or success + refetch)

2. **Assign/Reassign task**
   - Input: `taskId`, `assigneeId`
   - Permission required: `ASSIGN_PUTAWAY_TASK`

3. **Select destination** (only if backend supports)
   - Input: `taskId`, `destinationLocationId`
   - Permission required: `SELECT_PUTAWAY_LOCATION`
   - Expected result: task updated with destination and status no longer `REQUIRES_LOCATION_SELECTION` (exact next status is backend-defined; UI must refetch and display whatever returned)

## Error handling expectations
- `400` validation: show backend message; refresh task.
- `403` forbidden: show authorization error; hide action on subsequent render if permissions endpoint indicates missing perm.
- `404`: show â€œTask not foundâ€ with link back to list.
- Concurrency: if claim conflicts, backend should return validation/conflict; UI must refetch.

---

# 10. State Model & Transitions

## Allowed states (display + filtering)
- `UNASSIGNED`
- `ASSIGNED`
- `IN_PROGRESS`
- `COMPLETED`
- `CANCELLED`
- `REQUIRES_LOCATION_SELECTION`

## Role-based transitions (frontend-initiated)
- Stock Clerk:
  - `UNASSIGNED` â†’ `ASSIGNED` via Claim (requires `CLAIM_PUTAWAY_TASK`)
- Warehouse Manager:
  - `UNASSIGNED/ASSIGNED` â†’ `ASSIGNED` via Assign/Reassign (requires `ASSIGN_PUTAWAY_TASK`)
- Destination selector (could be Stock Clerk if permitted):
  - `REQUIRES_LOCATION_SELECTION` â†’ (backend-defined next state) via Select Destination (requires `SELECT_PUTAWAY_LOCATION`)

## UI behavior per state
- `UNASSIGNED`: show â€œClaimâ€ (if permitted); highlight as available.
- `ASSIGNED`: show assignee; show â€œReassignâ€ for managers.
- `REQUIRES_LOCATION_SELECTION`: show warning; show â€œSelect destinationâ€ if permitted; suggested destination fields may be empty.
- Terminal (`COMPLETED`, `CANCELLED`): actions disabled/hidden; read-only.

---

# 11. Alternate / Error Flows

## Validation failures
- Claim fails because task is no longer UNASSIGNED:
  - UI shows â€œTask already claimed/updated. Refreshingâ€¦â€ then refetch detail/list.
- Assign fails due to invalid assignee:
  - UI shows field-level error from backend; keeps dialog open.

## Concurrency conflicts
- Two users attempt to claim:
  - One succeeds; the other receives error and task refresh shows assignee.

## Unauthorized access
- User without permission:
  - Action buttons not shown if permission is known.
  - If attempted (deep link/action), backend `403` shown and UI remains read-only.

## Empty states
- No tasks match filters:
  - Show empty state with suggestion to clear filters and/or verify receipts are completed.

---

# 12. Acceptance Criteria

## Scenario 1: View generated put-away tasks after receipt completion
**Given** a Goods Receipt has transitioned to `COMPLETED` and backend generated put-away tasks in `UNASSIGNED`  
**When** a Stock Clerk navigates to Inventory â†’ Put-away Tasks  
**Then** the list displays the generated tasks including product, quantity, source staging location, and suggested destination (if present)  
**And** the Stock Clerk can open a task detail screen by selecting a row.

## Scenario 2: Display fallback metadata when destination was adjusted
**Given** a put-away task has `fallbackReason = DESTINATION_FULL`  
**And** the task includes `originalSuggestedLocation` and `finalSuggestedLocation`  
**When** the user views the task detail  
**Then** the UI displays the fallback indicator and shows both original and final suggested destinations.

## Scenario 3: Claim an unassigned task
**Given** a put-away task is in `UNASSIGNED` status  
**And** the current user has permission `CLAIM_PUTAWAY_TASK`  
**When** the user clicks â€œClaimâ€ from the list or detail  
**Then** the UI calls the claim service for that `taskId`  
**And** on success the task is shown as `ASSIGNED` to the current user in both list and detail.

## Scenario 4: Prevent claim when unauthorized
**Given** a put-away task is `UNASSIGNED`  
**And** the current user does not have permission `CLAIM_PUTAWAY_TASK`  
**When** the user views the task list or detail  
**Then** the â€œClaimâ€ action is not displayed  
**And** if the user attempts a direct claim action (e.g., via URL/action) and receives `403`  
**Then** the UI shows a â€œNot authorizedâ€ error and does not change the task state.

## Scenario 5: Manual destination selection required
**Given** a put-away task is in `REQUIRES_LOCATION_SELECTION`  
**When** a user opens the task detail  
**Then** the UI indicates that destination selection is required  
**And** if the user has permission `SELECT_PUTAWAY_LOCATION`, a â€œSelect destinationâ€ action is available  
**And** if the user selects a destination and saves successfully, the UI refreshes and displays the updated destination and status returned by backend.

## Scenario 6: Concurrency on claim
**Given** a put-away task is `UNASSIGNED` and visible to two users  
**When** User A claims the task successfully  
**And** User B attempts to claim the same task afterward  
**Then** User B sees an error indicating the task is no longer available  
**And** the UI refresh shows the task as assigned to User A.

---

# 13. Audit & Observability

## User-visible audit data
- Display created/updated timestamps on detail.
- Display assignee changes implicitly via current assignee and updated time (full history display only if backend provides it; do not assume).

## Status history
- If backend exposes status history/audit entries for tasks, add a read-only â€œHistoryâ€ section (optional; only if endpoint exists).
- Otherwise, show current status and timestamps.

## Traceability expectations
- Task detail must show `sourceReceiptId` and allow navigation to receipt (if receipt screen exists).
- If backend returns applied rule reference or rule name, display it read-only (optional; do not assume presence).

---

# 14. Non-Functional UI Requirements

- **Performance:** Task list initial load should render within 2s for first page under normal conditions; use paging.
- **Accessibility:** All actions keyboard-navigable; dialogs have proper focus management; labels for form controls.
- **Responsiveness:** Works on tablet-sized screens used in warehouse; table can switch to card list at small widths.
- **i18n/timezone:** Display timestamps in user locale/timezone per app standard; do not change stored values.
- **Security:** Never rely on frontend-only permission checks; always handle 403 from backend.

---

# 15. Applied Safe Defaults
- SD-UX-EMPTY-STATE: Provide a standard empty-state message and â€œClear filtersâ€ action when no tasks are returned; safe because it does not alter domain logic. (Impacted: UX Summary, Alternate/Empty states)
- SD-UX-PAGINATION: Default page size 25 with server-side paging; safe UI ergonomics only. (Impacted: UX Summary, Service Contracts)
- SD-ERR-MAP-HTTP: Standard mapping of 400/403/404/5xx to banner/dialog errors; safe because it is generic error presentation. (Impacted: Business Rules, Error Flows)

---

# 16. Open Questions
1. What are the exact backend API endpoints (or Moqui services) for: list tasks, get task, claim, assign, and (if supported) select destination? Provide request/response schemas and error payload format.
2. Is there an existing Goods Receipt detail screen/route in this frontend to deep-link from `sourceReceiptId`? If yes, what is the screen path and parameter name?
3. For `REQUIRES_LOCATION_SELECTION`, does backend provide a â€œsearch locationsâ€ endpoint with compatibility constraints (e.g., allowed locations for this product), or should the UI present a generic location picker?
4. Does backend expose permission/feature flags to allow frontend to hide actions reliably (e.g., `hasPermission()` service), or should UI render actions and rely solely on 403 handling?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Putaway: Generate Put-away Tasks from Staging  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/96  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Putaway: Generate Put-away Tasks from Staging

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As a **Stock Clerk**, I want put-away tasks generated so that received items are placed into proper storage locations.

## Details  
- Rules: default bin by product category, manual destination.  
- Tasks list product, qty, from staging, suggested destination.

## Acceptance Criteria  
- Put-away tasks created after receipt.  
- Suggested destinations provided.  
- Tasks assignable.

## Integrations  
- Uses storage topology and optional replenishment rules.

## Data / Entities  
- PutawayTask, PutawayRule, StorageLocationRef

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Inventory Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #97: [FRONTEND] [STORY] Receiving: Direct-to-Workorder Receiving (Cross-dock) from Distributor â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/97
File: ./scripts/story-work/frontend/97/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] Receiving: Direct-to-Workorder Receiving (Cross-dock) from Distributor

### Primary Persona
Inventory Manager

### Business Value
Enable urgent parts to be received from a distributor and immediately issued to a specific workorder (cross-dock), reducing job lead time by bypassing put-away/pick while preserving an auditable receive+issue trail and notifying Work Execution.

---

## 2. Story Intent

### As a / I want / So that
**As an** Inventory Manager,  
**I want** to receive items from a supplier shipment and link them directly to a workorder line with immediate issue allocation,  
**so that** urgent jobs can be fulfilled without standard put-away and picking delays.

### In-scope
- Frontend screens/flows to:
  - Select an inbound shipment/receipt to receive.
  - Enter/confirm received quantities per receiving line.
  - Link a receiving line to `workorderId` and `workorderLineId`.
  - Execute a â€œcross-dock receive + issueâ€ action (manual confirm or auto-issue depending on policy).
  - Display result (receipt + issue created) and audit-relevant references (supplier shipment ref, workorder refs, issue mode, confirmer).
- Error/alternate flows surfaced to user (mismatch, closed WO, permission denied, notification failures surfaced as non-blocking).
- Moqui screen/form/service wiring consistent with project conventions.

### Out-of-scope
- Defining or changing backend domain logic (ledger posting rules, costing formula, event emission internals).
- Put-away/bin assignment for these lines (explicitly bypassed).
- Creating/editing workorders or workorder demand lines (Workexec-owned).
- Defining substitution mapping behavior beyond what backend supports (UI will only expose if contract exists).
- Accounting UI or job-cost UI.

---

## 3. Actors & Stakeholders
- **Primary user:** Inventory Manager (receives shipments, confirms issuance)
- **Secondary users:** Service Advisor (visibility only), Technician (downstream beneficiary)
- **External systems:**
  - **Workexec** (workorders/demand; must be notified when issue completes)
  - **Distributor/Supplier** (shipment reference)
- **Internal systems:**
  - Inventory services (receipt + issue transaction; inventory ledger)
  - AuthN/AuthZ (permissions to issue/override if applicable)

---

## 4. Preconditions & Dependencies
### Preconditions
- User is authenticated in POS frontend.
- A target workorder exists in Workexec with at least one line demanding a product/SKU.
- An inbound shipment/receiving document exists in inventory/receiving context with at least one line to receive.

### Dependencies (blocking where contract unknown)
- Backend endpoints/services for:
  - Listing/loading receiving shipments and lines
  - Searching/selecting workorders and workorder lines (from Workexec or via POS proxy)
  - Performing cross-dock â€œreceive+issueâ€ transaction atomically
  - Returning validation errors with machine-readable codes
- Backend indicates policy for:
  - manual confirmation vs auto-issue eligibility
  - part mismatch override support and required permission/reason code
- Permissions model: names/scopes for issuing and overrides must match backend.

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main nav: **Receiving** â†’ **Inbound Shipments** (or existing receiving entry in the app)
- From a shipment detail: action **Receive** for a line, with option **Direct-to-Workorder (Cross-dock)**

### Screens to create/modify
1. **Modify** existing receiving shipment detail screen (if present):
   - Add per-line action â€œCross-dock to Workorderâ€
2. **Create** `Receiving/CrossDockReceive` screen (or sub-screen under shipment):
   - Workorder line selection
   - Quantity receive input
   - Confirmation step (if manual)
   - Result summary

> Moqui artifacts expected:
- Screen(s) with transitions for: select WO line â†’ validate â†’ confirm (optional) â†’ submit
- Forms for linking and submission; parameter passing via transition context

### Navigation context
- Breadcrumb: Receiving â†’ Shipment `<shipmentRef>` â†’ Line `<product>` â†’ Cross-dock
- â€œBackâ€ returns to shipment detail with updated line state.

### User workflows
#### Happy path (manual confirm)
1. User opens shipment, chooses a line, clicks **Cross-dock to Workorder**
2. User searches/selects **Workorder** and **Workorder Line**
3. User enters **received quantity**
4. System shows confirmation: what will be issued to which WO/line
5. User confirms â†’ system posts receive+issue
6. UI shows success and audit references; returns to shipment detail

#### Happy path (auto-issue)
Same as above, but after entering quantity + selecting WO line, UI indicates auto-issue will occur and submits without confirmation step (or confirmation screen becomes informational â€œAuto-issuingâ€¦â€).

#### Alternate paths
- Workorder is closed/cancelled â†’ blocked with message
- Product mismatch between receiving line and WO line â†’ blocked or override path (if permitted)
- Network/service error â†’ no partial state shown; actionable error; allow retry safely

---

## 6. Functional Behavior

### Triggers
- User chooses â€œCross-dock to Workorderâ€ on a receiving line.
- User submits cross-dock transaction (manual confirm or auto-submit).

### UI actions (explicit)
- **Search Workorder**: user can query by workorder number/id and optionally customer name (only if backend supports).
- **Select Workorder Line**: user selects a line showing demanded product/SKU, remaining qty, and status.
- **Enter Received Quantity**: numeric input with UoM display.
- **Submit**:
  - If manual confirmation required: â€œReview & Confirm Issueâ€ step required.
  - If auto-issue eligible and policy enabled: submit immediately.

### State changes (frontend-visible)
- Receiving line becomes linked to `workorderId` and `workorderLineId` (persisted by backend).
- Inventory ledger records receive and issue (not editable in UI; visible as references if backend returns).
- UI displays `issueMode` and `confirmedBy` after completion.

### Service interactions (high level)
- Load shipment + lines
- Load workorder + lines (search)
- Validate cross-dock eligibility (may be part of submit response)
- Submit cross-dock transaction (atomic)
- Optionally poll/load updated shipment line status after submit (if backend doesnâ€™t return updated model)

---

## 7. Business Rules (Translated to UI Behavior)

> Note: Backend reference story resolves several policies; frontend must reflect them. Any gaps in frontend/backend contract become Open Questions.

### Validation
- Received quantity:
  - Must be > 0
  - Must not exceed remaining receivable quantity on the receiving line (if provided)
- Workorder eligibility:
  - Workorder must be in an allowed state (e.g., Open/In-Progress); otherwise block submission
- Product match:
  - Default: receiving line product must match selected workorder line product; otherwise block with error code `PART_MISMATCH_WITH_WORKORDER`
  - If override is supported and user has permission: allow override flow with required reason code; override must force manual confirmation (never auto-issue)

### Enable/disable rules
- â€œConfirm Issueâ€ button disabled until:
  - workorder line selected
  - valid quantity entered
  - no blocking validation errors
- Override controls only visible when mismatch occurs *and* backend indicates override is permitted for the current user/session.

### Visibility rules
- Show supplier shipment reference prominently on review/confirm step (audit requirement).
- Show â€œAuto-issue will occurâ€ banner when backend indicates auto-issue eligibility.

### Error messaging expectations
- Permission denied â†’ show â€œYou do not have permission to issue partsâ€ (map 403)
- Validation errors â†’ inline field errors + top summary; include backend error code where safe
- Non-blocking notification failure:
  - If backend returns a warning status, show â€œIssued successfully; notification pending/retryâ€ (must not imply failure of inventory movement)

---

## 8. Data Requirements

### Entities involved (frontend perspective)
- Receiving/Shipment entity (name TBD)
- `ReceivingLine` (must include or be able to display):
  - `receivingLineId`
  - `productId` / SKU / part number display fields
  - `quantityOrdered` (optional)
  - `quantityReceivedToDate` (optional)
  - `quantityRemainingToReceive` (optional)
  - **link fields:** `workorderId` (nullable), `workorderLineId` (nullable)
  - `supplierShipmentRef` or shipment-level ref
- Workorder summary + lines (from Workexec/proxy):
  - `workorderId`
  - `workorderNumber` (display)
  - `status`
  - `workorderLineId`
  - `productId`/SKU/part number
  - `quantityDemanded`, `quantityIssuedToDate` or `quantityRemaining`
- Cross-dock transaction result:
  - receipt identifier(s) (e.g., `receiptId`)
  - issue ledger entry id (optional)
  - `issueMode` (`MANUAL_CONFIRM` | `AUTO_ON_RECEIPT`)
  - `confirmedBy` (userId or SYSTEM)
  - event publication status (success/pending) if available

### Fields (type, required, defaults)
- Input fields:
  - `workorderId` (string/UUID) **required**
  - `workorderLineId` (string/UUID) **required**
  - `quantityReceived` (decimal) **required**
  - `uom` (string) **read-only** (from receiving line/workorder line)
  - `overridePartMismatch` (boolean) optional, default false
  - `overrideReasonCode` (string) required *only if* override is true
- Read-only vs editable
  - Workorder identifiers: read-only after selection; editable via â€œChange selectionâ€
  - Quantity: editable until submit; locked during submission

### Derived/calculated fields (frontend-only)
- `isAutoIssueEligible` (boolean) computed from backend response if provided; do not infer without contract
- `quantityRemainingOnWorkorderLine` computed if backend provides demanded/issued numbers

---

## 9. Service Contracts (Frontend Perspective)

> Moqui typically uses services invoked by transitions/actions. Exact service names must match backend; currently unclear for frontend repo. Contracts below specify required semantics.

### Load/view calls
1. **Get shipment detail + lines**
   - Input: `shipmentId` (or similar)
   - Output: shipment header (incl. supplier shipment ref) + receiving lines
2. **Search workorders**
   - Input: query string, paging
   - Output: list of workorders with status
3. **Get workorder lines**
   - Input: `workorderId`
   - Output: lines with product and remaining qty

### Create/update calls
- **Link receiving line to workorder line (optional pre-save)**
  - If backend requires a separate step, UI must call it before submit.
  - Otherwise include link fields in submit.

### Submit/transition calls (atomic)
- **Cross-dock receive+issue**
  - Input:
    - `receivingLineId`
    - `workorderId`, `workorderLineId`
    - `quantityReceived`
    - `issueModeRequested` (optional; if backend decides, omit)
    - `overrideReasonCode` (if overriding mismatch)
  - Output:
    - success status
    - persisted link fields
    - `issueMode`, `confirmedBy`
    - identifiers (receiptId, ledgerEntryIds) if available
    - optional warning about notification retry

### Error handling expectations
- `400` validation errors return structured field errors and/or `errorCode` values:
  - `PART_MISMATCH_WITH_WORKORDER`
  - `WORKORDER_NOT_ISSUABLE` (example)
  - `QUANTITY_EXCEEDS_REMAINING`
- `403` unauthorized/forbidden for missing permissions (e.g., issue/override)
- `409` conflict for concurrent updates (line already received/linked elsewhere)

---

## 10. State Model & Transitions

### Allowed states (frontend-level, for the cross-dock flow)
- **Draft (local UI state):** user selecting WO line and entering quantity
- **Review (manual confirmation only):** user confirming issuance
- **Submitting:** request in-flight; disable inputs
- **Completed:** show result summary
- **Failed:** show error; allow retry or return

### Role-based transitions
- Inventory Manager with issue permission:
  - Draft â†’ Review â†’ Submitting â†’ Completed
  - Draft â†’ Submitting â†’ Completed (auto-issue path)
- User without issue permission:
  - Draft â†’ (submit) â†’ Failed (403), stay in Draft with error messaging
- Override permission (if supported):
  - Draft (mismatch) â†’ Review (forced manual) when override selected

### UI behavior per state
- Draft: editable; shows live validation
- Review: read-only summary; confirm/cancel
- Submitting: spinner/progress; prevent double-submit
- Completed: show receipt/issue references and â€œReturn to shipmentâ€
- Failed: show error + retry

---

## 11. Alternate / Error Flows

1. **Part mismatch**
   - On selection of WO line, if SKU mismatch detected by backend or by comparing ids provided:
     - Show blocking error
     - If override supported and user permitted: show override controls requiring reason code; force manual confirmation step

2. **Workorder closed/cancelled**
   - Block selection or block submit with clear message
   - Do not proceed to confirmation

3. **Quantity invalid**
   - Inline error; disable submit

4. **Concurrency conflict**
   - If backend responds 409 (e.g., line already received/issued):
     - Show â€œThis line was updated by another user. Reload to continue.â€
     - Provide â€œReload shipmentâ€ action

5. **Notification failure (non-blocking)**
   - If backend indicates inventory transaction succeeded but event publish queued/failed:
     - Show success state with warning banner
     - Do not roll back UI state to failed

6. **Offline/network/server error**
   - Show generic error with request id/correlation id if available
   - Allow retry; must be safe (backend should be idempotentâ€”if not, Open Question)

---

## 12. Acceptance Criteria

### Scenario 1: Manual confirmation cross-dock succeeds
**Given** an inbound supplier shipment has a receiving line for product `P-ABC` with quantity to receive `2`  
**And** a workorder `WO-123` exists in an issuable state with a line demanding `P-ABC` and remaining quantity `2`  
**And** the current policy requires manual confirmation  
**When** the Inventory Manager selects â€œCross-dock to Workorderâ€ on the receiving line  
**And** selects workorder `WO-123` and the matching workorder line  
**And** enters received quantity `2` and proceeds to review  
**Then** the UI shows a confirmation summary including product, quantity, supplier shipment reference, workorder id/number, and workorder line  
**When** the user confirms issuance  
**Then** the UI submits the cross-dock transaction  
**And** on success the UI shows `issueMode = MANUAL_CONFIRM` and `confirmedBy = <currentUser>`  
**And** the shipment detail reflects the receiving line is linked to `workorderId` and `workorderLineId`

### Scenario 2: Partial quantity cross-dock
**Given** a receiving line for `P-ABC` has quantity `1` available to receive  
**And** workorder `WO-123` has remaining demand `2` for `P-ABC`  
**When** the user cross-docks quantity `1` to `WO-123` and confirms  
**Then** the UI shows success for issuing `1`  
**And** the workorder linkage is persisted on the receiving line

### Scenario 3: Auto-issue path
**Given** policy allows auto-issue and backend indicates the selection is eligible for auto-issue  
**When** the user selects the matching workorder line and enters quantity  
**Then** the UI indicates auto-issue will occur  
**And** submitting completes without a manual confirmation step (or confirmation is informational only)  
**And** the result shows `issueMode = AUTO_ON_RECEIPT` and `confirmedBy = SYSTEM`

### Scenario 4: Workorder not issuable (closed/cancelled)
**Given** a workorder `WO-456` is in status `Closed` (or non-issuable)  
**When** the user attempts to link a receiving line to `WO-456`  
**Then** the UI blocks the action with message â€œCannot issue parts to a closed workorder.â€ (or backend-provided message)  
**And** no submit action is performed

### Scenario 5: Product mismatch blocked (no override)
**Given** a receiving line is for product `P-BBB`  
**And** selected workorder line demands product `P-AAA`  
**When** the user attempts to proceed  
**Then** the UI displays an error with code `PART_MISMATCH_WITH_WORKORDER`  
**And** the submit/confirm controls remain disabled

### Scenario 6: Product mismatch override requires permission and reason (if supported)
**Given** a product mismatch exists between receiving line and workorder line  
**And** the current user has permission to override part match  
**When** the user selects â€œOverrideâ€  
**Then** the UI requires a reason code before enabling confirmation  
**And** the flow forces manual confirmation (no auto-issue)  
**When** the user confirms  
**Then** the transaction succeeds and the UI shows success including the override reason in the result/audit view (if returned)

### Scenario 7: Permission denied to issue
**Given** the current user lacks issue permission  
**When** the user attempts to confirm/submits the cross-dock issuance  
**Then** the UI displays a permission error (403)  
**And** remains on the cross-dock screen without marking the line as completed

---

## 13. Audit & Observability

### User-visible audit data
- Show (in result summary and/or shipment line detail):
  - supplier shipment reference
  - workorder/workorder line reference
  - quantity issued
  - issue mode (`MANUAL_CONFIRM` vs `AUTO_ON_RECEIPT`)
  - confirmed by (user vs SYSTEM)
  - timestamp (from backend if available)

### Status history
- If backend exposes ledger/audit entries list, provide a â€œView transaction detailsâ€ link to a read-only view (can be deferred if not available).

### Traceability expectations
- All submissions include correlation id (from frontend header if project standard) and display it on error states.
- Log frontend events (console/app log) for:
  - cross-dock started
  - submit attempted
  - submit success/failure with error code (no sensitive data)

---

## 14. Non-Functional UI Requirements
- **Performance:** Workorder search results should return within 2s for typical queries; paginate results.
- **Accessibility:** All form inputs have labels; errors announced; keyboard navigable confirmation.
- **Responsiveness:** Usable on tablet (receiving dock use case).
- **i18n/timezone/currency:** Dates/times shown in site/user timezone; no currency required.

---

## 15. Applied Safe Defaults
- SD-UI-EMPTY-STATE: Provide empty-state messaging for â€œno workorders foundâ€ and â€œno lines availableâ€ because it is UI ergonomics and does not change domain policy. (Impacted: UX Summary, Alternate/Error Flows)
- SD-UI-PAGINATION: Paginate workorder search results with standard page size to avoid large payloads; purely UX/perf. (Impacted: UX Summary, Service Contracts)
- SD-ERR-MAP-HTTP: Map 400/403/409/500 to inline + banner errors with retry action; standard error-handling mapping. (Impacted: Business Rules, Alternate/Error Flows, Acceptance Criteria)
- SD-OBS-CORRELATION-ID: Include/display correlation/request id when available for supportability; observability boilerplate. (Impacted: Audit & Observability, Alternate/Error Flows)

---

## 16. Open Questions

1. **Backend service/API contract:** What are the exact Moqui service names (or REST endpoints) for:
   - loading shipment + receiving lines,
   - searching workorders and loading workorder lines,
   - submitting the atomic cross-dock receive+issue transaction?
2. **Identifier types:** Are `workorderId`, `workorderLineId`, `receivingLineId`, `receiptId` UUIDv7 strings (as per backend reference) or another format in this frontend/backoffice?
3. **Policy exposure:** How does the frontend determine whether **manual confirm** is required vs **auto-issue** eligible?
   - Is there a policy endpoint/flag returned in the shipment/line payload?
4. **Permissions mapping:** What are the exact permission strings enforced by Moqui/security layer for:
   - issuing parts (backend reference uses `ISSUE_PARTS`),
   - overriding part match (`OVERRIDE_PART_MATCH`)?
5. **Mismatch detection source of truth:** Should the UI do a client-side SKU comparison (best-effort) *in addition to* backend validation, or rely solely on backend validation to avoid false positives?
6. **Notification status surfaced?** Does the submit response include notification/event publication status (success/queued/failed), or is it always asynchronous with no UI feedback?
7. **Idempotency expectations:** If the user retries after a timeout, does the backend support idempotency keys to prevent duplicate receive+issue postings? If yes, what header/field should frontend send?

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Receiving: Direct-to-Workorder Receiving (Cross-dock) from Distributor â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/97

====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Receiving: Direct-to-Workorder Receiving (Cross-dock) from Distributor  
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/97  
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Receiving: Direct-to-Workorder Receiving (Cross-dock) from Distributor

**Domain**: user

### Story Description

/kiro  
# User Story  
## Narrative  
As an **Inventory Manager**, I want to receive items directly against a workorder so that urgent jobs can be fulfilled without normal put-away.

## Details  
- Receiving lines can be linked to workorderId and workorderLineId.  
- Items received can be immediately allocated/issued to that workorder.  
- Optionally bypass storage and go straight to issue.

## Acceptance Criteria  
- Receipt linked to workorder.  
- Allocation/issue auto or confirm.  
- Workexec notified.  
- Audit includes supplier shipment ref.

## Integrations  
- Workexec sends demand; Positivity provides shipment status; inventory posts receive+issue.

## Data / Entities  
- WorkorderReceiptLink, ReceivingLine, InventoryLedgerEntry(Receive/Issue)

## Classification (confirm labels)  
- Type: Story  
- Layer: Domain  
- Domain: Inventory Management

### Frontend Requirements

- Implement Vue.js 3 components with TypeScript  
- Use Quasar framework for UI components  
- Integrate with Moqui Framework backend  
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API  
- TypeScript 5.x  
- Quasar v2.x  
- Moqui Framework integration

---  
*This issue was automatically created by the Durion Workspace Agent*

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #98: [FRONTEND] [STORY] Receiving: Receive Items into Staging (Generate Ledger Entries) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/98
File: ./scripts/story-work/frontend/98/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- blocked:clarification
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

STOP: Clarification required before finalization

---

## 1. Story Header

### Title
[FRONTEND] [STORY] Receiving: Receive Items into Staging (Generate Ledger Entries)

### Primary Persona
Receiver (warehouse receiving clerk)

### Business Value
Accurately increases on-hand inventory in the default Staging location at time of receipt, records variances (over/short), and creates immutable inventory ledger entries so downstream put-away and availability workflows can proceed with auditable data.

---

## 2. Story Intent

### As a / I want / So that
**As a** Receiver,  
**I want** to receive items against a Purchase Order (PO) or ASN into the siteâ€™s default Staging location by entering actual quantities and UOM,  
**so that** on-hand increases immediately in staging, variances are recorded, and put-away can follow using accurate inventory state.

### In-scope
- Moqui screen flow to:
  - search/select a PO/ASN to receive
  - load expected lines (items, expected qty, expected UOM)
  - enter actual received qty (and UOM if selectable) per line
  - finalize/confirm receipt
- Display outcome:
  - lines marked as received states (received / received-short / received-over)
  - confirmation that items are now â€œin stagingâ€
  - show recorded variance summary for the receipt session
- Error handling UX for not found, validation failures, and transaction failure rollback messaging.

### Out-of-scope
- Receiving items **not** on PO/ASN (â€œunplanned receiptâ€)
- Put-away process/UI (moving from staging to final bins)
- Inventory valuation/cost display changes (costing is inventory-owned but not part of this UI story)
- Backorder/substitution policies
- Printing labels, barcode receiving scan flows (unless explicitly confirmed)

---

## 3. Actors & Stakeholders
- **Receiver (Primary):** performs receiving and confirms counts.
- **Warehouse Manager (Stakeholder):** expects auditability and inventory accuracy.
- **System (Moqui app):** enforces validation, calls services, renders states.
- **Downstream Work Execution (Stakeholder/System):** may consume availability/receipt completion signals (frontend only displays results; emission is backend).

---

## 4. Preconditions & Dependencies
- User is authenticated.
- User has permission(s) to perform receiving (exact permission string(s) TBD â†’ Open Question).
- A PO or ASN exists and is in an allowed status (backend reference: Open / In-Transit).
- A default **Staging StorageLocation** is configured for the receiving site/facility.
- Backend endpoints/services exist (or will exist per backend story) to:
  - find PO/ASN and load expected receiving lines
  - submit receipt confirmation and return resulting states/ids

Dependencies:
- Backend story: `[BACKEND] [STORY] Receiving: Receive Items into Staging (Generate Ledger Entries)` (durion-positivity-backend #34)

---

## 5. UX Summary (Moqui-Oriented)

### Entry points
- Main navigation: Inventory â†’ Receiving â†’ â€œReceive into Stagingâ€
- Deep link: `/inventory/receiving/receive` (proposed; final route must match repo conventions)

### Screens to create/modify (Moqui)
1. **Screen:** `apps/pos/screen/inventory/receiving/ReceiveStaging.xml` (new)
   - Subscreens:
     - `FindDocument` (enter PO/ASN identifier)
     - `ReceiveLines` (edit actual quantities)
     - `ReviewConfirm` (summary + confirm)

2. **Screen:** `apps/pos/screen/inventory/receiving/ReceiptResult.xml` (new or embedded section)
   - shows receipt session summary, variances, and staging confirmation

> If the project uses a single-screen pattern with transitions and conditional sections, implement as one screen with transitions; otherwise split as above.

### Navigation context
- Breadcrumb: Inventory / Receiving / Receive into Staging
- Back behavior:
  - From ReceiveLines â†’ back to FindDocument (warn if unsaved edits)
  - After Confirm â†’ go to Result; from Result allow â€œReceive anotherâ€ (returns to FindDocument)

### User workflows
**Happy path**
1. Receiver opens â€œReceive into Stagingâ€
2. Enters PO/ASN number â†’ Search
3. System loads expected lines
4. Receiver enters actual received quantities per line (UOM shown; editable only if allowed)
5. Receiver clicks Review â†’ sees variances preview
6. Receiver clicks Confirm Receipt
7. System shows success + resulting states; indicates items are â€œIn Stagingâ€

**Alternate paths**
- PO/ASN not found â†’ show error and remain on FindDocument
- Under/Over receipt â†’ allowed; show variance preview and confirm still enabled
- Backend rejects due to status/permission â†’ show error; remain on editing screen
- Transaction failure â†’ show failure and no local state changes; allow retry

---

## 6. Functional Behavior

### Triggers
- User submits PO/ASN identifier (search)
- User edits actual quantities
- User confirms receipt

### UI actions
- **Search action:** validate identifier non-empty; call load service; render expected lines.
- **Edit action:** per line:
  - input actualQty (numeric, >= 0; decimals allowed only if UOM supportsâ€”unknown â†’ Open Question)
  - optionally select actualUom (only if backend allows)
- **Review action:** compute client-side variance preview (expected - actual) for display only; authoritative variance is backend.
- **Confirm action:** submit receipt payload; disable confirm button while in-flight; show spinner.

### State changes (frontend)
- Local screen state: Draft edits â†’ Reviewed â†’ Submitted
- After success:
  - display receipt session/correlation id
  - display line states from backend response
  - allow navigation to result

### Service interactions (frontend to Moqui backend)
- Load expected lines for PO/ASN
- Submit receipt confirmation (atomic operation backend-side):
  - ledger entries created
  - on-hand updated in staging
  - variances created
  - receiving line states updated

---

## 7. Business Rules (Translated to UI Behavior)

### Validation
- PO/ASN identifier is required to load lines.
- For each line being received:
  - `actualQty` is required (if line is presented for receiving)
  - `actualQty` must be a number and **>= 0**
- Do not allow manual edits to system-managed outcomes:
  - ledger entries, on-hand, and variance records are not editable in UI (read-only results)

### Enable/disable rules
- **Confirm Receipt** enabled only when:
  - document is loaded
  - all visible lines have valid `actualQty`
  - no in-flight submission
- **Review** enabled when lines are valid; review does not persist.

### Visibility rules
- Default Staging location is displayed (read-only) as the receipt destination.
- Variance preview visible after any line has actual != expected.
- If no lines returned (empty PO/ASN or fully received), show empty-state message and disable confirm.

### Error messaging expectations
- Not found: â€œPO/ASN not found or not eligible for receiving.â€
- Validation: field-level messages, e.g. â€œQuantity must be 0 or greater.â€
- Permission: â€œYou do not have permission to receive inventory.â€
- Status conflict: â€œThis document cannot be received in its current status.â€
- Transaction failure: â€œReceipt failed; no inventory was updated. Please retry.â€

---

## 8. Data Requirements

### Entities involved (conceptual; frontend reads/writes via services)
- `InventoryLedgerEntry` (created by backend; displayed summary only)
- `InventoryVariance` (created by backend; displayed summary)
- `ReceivingLine` (loaded and updated state by backend)
- `StorageLocation` (staging destination; displayed)
- PO/ASN document + lines (source of expected qty/uom)

### Fields (type, required, defaults)
**Document search**
- `documentType` (enum: PO | ASN) â€” *unclear if required* (Open Question)
- `documentId` (string) â€” required
- `siteId` (string) â€” *may be implicit from user context* (Open Question)

**Receiving line (loaded)**
- `receivingLineId` (string) â€” required
- `productId` (string) â€” required
- `productName` (string) â€” required (display)
- `expectedQty` (decimal) â€” required
- `expectedUomId` (string) â€” required
- `state` (string enum) â€” required (display)
- `stagingLocationId` (string) â€” required (display; same for all lines)

**Receiving input (editable)**
- `actualQty` (decimal) â€” required, default = expectedQty (safe UI default)
- `actualUomId` (string) â€” default = expectedUomId; editable only if backend supports

**Receipt result (read-only)**
- `receiptCorrelationId` (string) â€” required
- `receivedAt` (datetime UTC) â€” required
- `receivedByUserId` (string) â€” required
- Per line:
  - `quantityChange` (decimal) â€” required
  - `varianceType` (enum SHORTAGE|OVERAGE|NONE) â€” derived/display
  - `varianceQty` (decimal) â€” derived/display

### Read-only vs editable by state/role
- Before confirm: only `actualQty` (and possibly `actualUomId`) editable.
- After confirm: everything read-only.
- Users without receiving permission: screen loads may be allowed (view) but confirm must be blocked (exact policy unclear â†’ Open Question).

### Derived/calculated fields (frontend)
- Variance preview:
  - `varianceQtyPreview = actualQty - expectedQty`
  - `varianceTypePreview = OVERAGE if >0 else SHORTAGE if <0 else NONE`

Authoritative variance comes from backend response.

---

## 9. Service Contracts (Frontend Perspective)

> Exact Moqui service names are not provided in inputs; to remain buildable, define expected request/response shape and map to Moqui services once confirmed.

### Load/view calls
1. **Service:** `inventory.receiving.findDocument` (proposed)
   - **Input:** `documentId`, optional `documentType`, optional `siteId`
   - **Output:**
     - `documentId`, `documentType`, `status`
     - `stagingLocationId`, `stagingLocationName`
     - `lines[]` with fields listed in Data Requirements

### Create/update calls
- None (draft edits are client-side until confirm)

### Submit/transition calls
2. **Service:** `inventory.receiving.confirmReceipt` (proposed)
   - **Input:**
     - `documentId`, `documentType`
     - `stagingLocationId` (should match default; backend validates)
     - `lines[]`: `{ receivingLineId, productId, actualQty, actualUomId }`
   - **Output:**
     - `receiptCorrelationId`, `receivedAt`, `receivedByUserId`
     - updated `lines[]` including new `state`
     - `variances[]` summary (or per-line variance fields)
     - optional `ledgerEntryIds[]` or counts

### Error handling expectations
- 400 validation errors â†’ map to field errors when possible; otherwise show banner.
- 403 â†’ show permission banner; disable confirm.
- 404 â†’ show not found message on FindDocument.
- 409 conflict (status changed / already received) â†’ show conflict banner and offer â€œReload documentâ€.
- 500/timeout â†’ show retryable error, keep user edits intact.

---

## 10. State Model & Transitions

### Allowed states (ReceivingLineState)
Backend reference suggests:
- `EXPECTED`
- `RECEIVED`
- `RECEIVED_SHORT`
- `RECEIVED_OVER`

(Exact enum values must match backend â†’ Open Question)

### Role-based transitions
- Receiver can transition lines from EXPECTED â†’ one of RECEIVED / RECEIVED_SHORT / RECEIVED_OVER via confirm receipt.
- Other roles not defined (Open Question).

### UI behavior per state
- If line is already in a terminal received state when loaded:
  - show as read-only and exclude from editable inputs
  - show message â€œAlready receivedâ€
- Only EXPECTED (or eligible) lines are editable and included in confirm payload.

---

## 11. Alternate / Error Flows

### Validation failures
- Missing/invalid actualQty:
  - block confirm
  - show inline error per line
- Negative qty:
  - inline error; prevent confirm

### Concurrency conflicts
- If backend returns 409 due to document status/lines changed:
  - show banner â€œDocument changed since loadedâ€
  - provide actions: Reload (re-calls findDocument), Cancel

### Unauthorized access
- If 403 on load: show access denied screen section; no data displayed.
- If 403 on confirm: keep edits, show banner, disable confirm.

### Empty states
- Document found but no receivable lines:
  - show â€œNothing to receiveâ€ with reason if provided (e.g., fully received)
  - disable confirm

---

## 12. Acceptance Criteria

### Scenario 1: Load receivable document and default staging location
**Given** I am logged in as a Receiver with permission to receive inventory  
**When** I enter a valid PO/ASN identifier and search  
**Then** the system displays the document status and its expected receiving lines  
**And** the destination location is shown as the siteâ€™s default Staging location (read-only)

### Scenario 2: Receive exact expected quantity (no variance)
**Given** a document line expects 10 EACH for ITEM-A  
**When** I enter an actual quantity of 10 and confirm receipt  
**Then** the receipt succeeds and a receipt correlation id is shown  
**And** the line state is displayed as Received  
**And** the UI indicates the items are now in Staging  
**And** no variance is shown for that line

### Scenario 3: Short receipt creates variance (UI shows variance result)
**Given** a document line expects 10 EACH for ITEM-A  
**When** I enter an actual quantity of 8 and confirm receipt  
**Then** the receipt succeeds  
**And** the line state is displayed as Received-Short (or equivalent)  
**And** the result includes a SHORTAGE variance of 2 EACH for ITEM-A

### Scenario 4: Over receipt creates variance (UI shows variance result)
**Given** a document line expects 10 EACH for ITEM-A  
**When** I enter an actual quantity of 12 and confirm receipt  
**Then** the receipt succeeds  
**And** the line state is displayed as Received-Over (or equivalent)  
**And** the result includes an OVERAGE variance of 2 EACH for ITEM-A

### Scenario 5: Document not found
**Given** I am on the Receive into Staging screen  
**When** I search for an identifier that does not match an eligible PO/ASN  
**Then** I see a not-found message  
**And** no receiving lines are displayed  
**And** I cannot confirm receipt

### Scenario 6: Validation prevents confirm
**Given** I have loaded a document with at least one receivable line  
**When** I enter a negative quantity for a line  
**Then** I see an inline validation error on that line  
**And** the Confirm Receipt action is disabled

### Scenario 7: Backend conflict on confirm
**Given** I have loaded a document and entered actual quantities  
**When** I confirm receipt and the backend responds with a conflict (409)  
**Then** the UI shows a conflict banner  
**And** I can reload the document  
**And** the UI does not show a success result

---

## 13. Audit & Observability

### User-visible audit data
- On success result, show:
  - `receiptCorrelationId`
  - `receivedAt` (render in user locale; sourced from UTC)
  - `receivedBy` (username/display name if available)
- If backend provides audit trail link/id, display as â€œView receipt detailsâ€ (route TBD).

### Status history
- If backend returns line status history, show in expandable section per line; otherwise out-of-scope.

### Traceability expectations
- All submit requests include a client-generated idempotency key or correlation id header if the system supports it (unknown â†’ Open Question).
- Frontend logs (console/network) must not expose sensitive data; show correlation id in success/error banners for support.

---

## 14. Non-Functional UI Requirements
- **Performance:** Load document and render lines within 2s for up to 200 lines (pagination/virtual scroll allowed).
- **Accessibility:** All inputs labeled; errors announced; keyboard navigable table/form.
- **Responsiveness:** Works on tablet receiving station widths; line editing usable without horizontal scrolling where possible.
- **i18n/timezone:** Display `receivedAt` in local timezone; store/receive UTC from backend.
- **Currency:** Not applicable (no cost display).

---

## 15. Applied Safe Defaults
- SD-UX-01 (Empty State): Show a standard empty-state panel when no receivable lines are returned; safe because it does not change domain logic; impacts UX Summary, Error Flows.
- SD-UX-02 (Default Input Value): Default `actualQty` to `expectedQty` when lines load; safe because user can edit and backend remains authoritative; impacts Data Requirements, UX Summary.
- SD-ERR-01 (HTTPâ†’UI Mapping): Map 400/403/404/409/500 to field errors/banners as described; safe because it only affects presentation and does not invent business policy; impacts Service Contracts, Error Flows.

---

## 16. Open Questions
1. **Permissions:** What exact permission(s)/roles gate receiving into staging (load vs confirm)? (Needed for UI gating and error expectations.)
2. **Document identification:** Do users select **PO vs ASN** explicitly, or is the identifier unique enough to auto-detect? (Affects FindDocument UI and service inputs.)
3. **Eligible statuses:** What exact PO/ASN statuses are allowed for receiving (and are partially received documents allowed)? (Needed for consistent UX errors and test cases.)
4. **UOM behavior:** Is `actualUomId` selectable, and if so what conversions are allowed/handled (decimal quantities, pack sizes)? (Cannot assume conversion policy.)
5. **ReceivingLineState enum:** What are the exact state values returned by backend (strings) and which should be treated as terminal/non-editable? (Needed to implement state-based UI.)
6. **Idempotency:** Does the confirm receipt endpoint support idempotency keys to prevent duplicate ledger entries on retry? If yes, what header/field should frontend send? (Critical for safe retry UX.)
7. **Staging location source:** Is staging location determined by **site**, **facility**, **warehouse**, or **user location** context, and how is that context provided in frontend? (Needed to display correct staging destination.)

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Receiving: Receive Items into Staging (Generate Ledger Entries) â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/98


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Receiving: Receive Items into Staging (Generate Ledger Entries)
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/98
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Receiving: Receive Items into Staging (Generate Ledger Entries)

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Receiver**, I want to receive items into staging so that on-hand increases and put-away can follow.

## Details
- Default to staging location.
- Record qty and UOM; handle over/short.

## Acceptance Criteria
- Ledger entries created for Receive.
- Items visible as 'in staging'.
- Variances recorded.

## Integrations
- Availability updates; workexec may see expected receipts.

## Data / Entities
- InventoryLedgerEntry(Receive), StagingLocation, ReceivingLineState

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ISSUE #99: [FRONTEND] [STORY] Receiving: Create Receiving Session from PO/ASN â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/99
File: ./scripts/story-work/frontend/99/after.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ·ï¸ Labels (Proposed)

### Required
- type:story
- domain:inventory
- status:draft

### Recommended
- agent:inventory-domain-agent
- agent:story-authoring

### Blocking / Risk
- risk:incomplete-requirements

**Rewrite Variant:** inventory-flexible

---

# 1. Story Header

## Title
[FRONTEND] Receiving: Create Receiving Session from PO/ASN

## Primary Persona
Receiver (warehouse/store receiving clerk)

## Business Value
Enables fast, accurate check-in by creating an auditable receiving session pre-populated from an existing PO or ASN, reducing manual entry and setup time.

---

# 2. Story Intent

## As a / I want / So that
**As a** Receiver,  
**I want** to create a receiving session by entering or scanning a PO/ASN identifier,  
**so that** expected items and quantities are pre-loaded and I can begin check-in.

## In-scope
- UI flow to create a new Receiving Session using **exact-match** PO/ASN identifier.
- Support two entry methods:
  - Manual text entry
  - Barcode scan into the same input (scanner acts as keyboard input)
- Validation feedback for:
  - Not found
  - Not receivable (closed/fully received)
  - Missing identifier (blind receiving blocked)
- Creation of session shell + pre-populated lines from source
- Navigate to session detail view after creation
- Display auditable metadata available from create response (session id, source doc, entry method, timestamps/creator when returned)

## Out-of-scope (explicit)
- Counting/confirming received quantities and line-by-line matching workflow
- Capturing variances (over/under/wrong item) and variance approval
- Lot/serial capture (not implemented in v1 here; only tolerate fields if returned)
- Search/browse for POs/ASNs (identifier must be entered/scanned)
- Blind receiving (creating session without PO/ASN)

---

# 3. Actors & Stakeholders

- **Receiver (primary user):** creates sessions during physical receiving.
- **Inventory Manager:** cares about traceability/auditability and operational correctness.
- **Purchasing Manager:** cares about PO receiving progression accuracy.
- **External system (Positivity):** may be source of ASN data (frontend consumes via Moqui/backend APIs; no direct integration UI here).

---

# 4. Preconditions & Dependencies

## Preconditions
- User is authenticated in the frontend and has permission to perform receiving session creation (permission name not specified in provided inputs; enforced by backend; frontend must handle 403).

## Dependencies
- Backend capability to:
  - Validate a PO/ASN identifier for receivability (exact match)
  - Create a ReceivingSession tied to exactly one source document (PO or ASN)
  - Return created session and its expected lines
- Product master mapping exists for items on PO/ASN (backend responsibility; frontend renders lines returned)

---

# 5. UX Summary (Moqui-Oriented)

## Entry points
- Primary navigation: Receiving module landing screen (e.g., `/receiving`)
- Action: â€œCreate New Receiving Sessionâ€

## Screens to create/modify
1. **Screen:** `apps/pos/screen/receiving/CreateReceivingSession.xml` (new)
   - Purpose: enter/scan identifier and submit session creation
2. **Screen:** `apps/pos/screen/receiving/ReceivingSessionDetail.xml` (new or existing if already present)
   - Purpose: show created session header + expected lines (read-only for this story)
3. **Menu/Navigation update:** add route/link from receiving landing screen to create screen

## Navigation context
- Breadcrumb: Receiving â†’ Create Session
- After successful creation: redirect to Receiving â†’ Session â†’ Detail (with `receivingSessionId` parameter)

## User workflows
### Happy path (manual)
1. Receiver opens Create Session screen
2. Enters identifier (e.g., `PO-123`)
3. Clicks â€œCreate Sessionâ€
4. Sees Session Detail with header (supplier, shipment ref if any, source doc) and expected lines

### Happy path (scan)
1. Receiver focuses identifier input
2. Scans barcode; value populates input
3. Auto-submit behavior is **not assumed**; user confirms by clicking Create (unless explicitly supported; see Open Questions)
4. Redirect to Session Detail

### Alternate paths
- Not found â†’ inline error; stay on create screen
- Not receivable â†’ inline error; stay on create screen
- Missing identifier â†’ blocking message; stay on create screen
- Cancel â†’ back to receiving landing screen; no changes persisted

---

# 6. Functional Behavior

## Triggers
- User presses â€œCreate Sessionâ€ (primary trigger)
- (Optional) User presses Enter while in identifier field (treated as Create if non-empty; safe UI default)

## UI actions
- Input field for `sourceDocumentIdentifier` (string)
- Buttons:
  - **Create Session** (primary)
  - **Cancel** (secondary)
- Loading state while calling service
- Disable Create while request in-flight

## State changes (frontend)
- No local state persistence required beyond in-screen form state
- On success: route transition to detail screen with returned `receivingSessionId`

## Service interactions (Moqui)
- Call a backend/Moqui service (or REST endpoint via Moqui) to:
  1. Validate identifier
  2. Create session and lines
- Capture method of entry:
  - `entryMethod=MANUAL` when user typed (or pasted) value and clicked Create
  - `entryMethod=SCAN` when input originated from scan (see Open Questions for detection approach)

---

# 7. Business Rules (Translated to UI Behavior)

## Validation
- Identifier is required:
  - If empty/blank on submit â†’ show blocking error: **â€œReceiving requires a valid PO or ASN. Blind receiving is not supported.â€**
- Exact match required:
  - Backend returns not found â†’ show: **â€œSource document <id> not found.â€**
- Must be receivable:
  - If PO/ASN is Closed/Fully Received â†’ show: **â€œ<id> has already been fully received.â€** (PO vs ASN wording may vary; frontend displays backend-provided message when available)

## Enable/disable rules
- Create button disabled when identifier is blank or request is in-flight
- Identifier field disabled during in-flight request (to prevent concurrent submits)

## Visibility rules
- Error banner/inline message visible only when last submit failed
- Session detail screen displays:
  - Header fields (supplier/distributor, shipment reference, source doc id/type, status)
  - Expected lines list (read-only here)

## Error messaging expectations
- Prefer backend error messages when safe and user-actionable
- Fallback to standard mapped messages by HTTP status:
  - 400: validation error (show message)
  - 403: â€œYou do not have permission to create receiving sessions.â€
  - 404: not found (if used by backend)
  - 409: conflict (e.g., already fully received) show message
  - 500: â€œSomething went wrong creating the receiving session. Try again or contact support.â€

---

# 8. Data Requirements

## Entities involved (conceptual; frontend reads/writes via services)
- `ReceivingSession`
- `ReceivingLine`
- `SupplierRef` (read-only display via session header)
- `VarianceRecord` (mentioned in original, but **out-of-scope** in this story)

## Fields (type, required, defaults)

### Create request (frontend â†’ service)
- `sourceDocumentId` (String, **required**) â€” value user entered/scanned
- `sourceDocumentType` (Enum `PO|ASN`, **optional/derived**) â€” if backend can infer from identifier, frontend may omit; otherwise must be provided (Open Question)
- `entryMethod` (Enum `MANUAL|SCAN`, **required**)

### Create response (service â†’ frontend)
- `receivingSessionId` (String/UUID, required)
- `sourceDocumentId` (String, required)
- `sourceDocumentType` (Enum `PO|ASN`, required)
- `supplierId` (String, required)
- `supplierName` (String, recommended for UI display)
- `shipmentReference` (String, nullable)
- `status` (Enum; expected initial `Open`, required)
- `createdAt` (Timestamp, optional if returned)
- `createdByUserId` (String, optional if returned)
- `lines[]` (required)
  - `receivingLineId` (String/UUID, required)
  - `productId` (String, required)
  - `productName`/`sku` (String, optional if returned)
  - `expectedQuantity` (Decimal, required)
  - `receivedQuantity` (Decimal, required; default 0)

## Read-only vs editable
- Create screen: only `sourceDocumentId` editable
- Detail screen (this story): all fields read-only (no editing of quantities/lines)

## Derived/calculated fields
- Display-only: total expected lines count, total expected quantity (optional UI convenience; safe default)

---

# 9. Service Contracts (Frontend Perspective)

> Note: Concrete endpoint/service names are not provided in inputs; define Moqui service interface names below for frontend integration. If actual backend uses REST, Moqui can wrap via service-call-out; implementer should map accordingly.

## Load/view calls
- `receiving.getReceivingSession`  
  **Input:** `receivingSessionId`  
  **Output:** session header + lines (fields listed above)  
  **Use:** Session Detail screen load/refresh

## Create/update calls
- `receiving.createReceivingSessionFromSource`  
  **Input:**
  - `sourceDocumentId` (required)
  - `entryMethod` (required)
  - `sourceDocumentType` (optional if inferable)
  **Output:**
  - `receivingSessionId` + populated session object + lines

## Submit/transition calls
- None in this story (no state transitions beyond creation)

## Error handling expectations
- Service returns structured errors with:
  - `errorCode` (recommended)
  - `message` (required)
  - `fieldErrors` (optional array: `field`, `message`)
- Frontend maps:
  - fieldErrors for identifier to input helper text
  - message to page-level alert if general

---

# 10. State Model & Transitions

## Allowed states (as displayed)
- `Open` (expected initial)
- `InProgress`, `Completed`, `Cancelled` (may exist; displayed if returned)

## Role-based transitions
- None implemented in UI for this story

## UI behavior per state
- Detail screen:
  - Always read-only in this story regardless of state
  - If session is not found or access denied, show appropriate error state

---

# 11. Alternate / Error Flows

## Validation failures
- Empty identifier â†’ show blind receiving blocked message; no request sent (client-side)
- Backend 400 with field error â†’ show inline; remain on create screen

## Concurrency conflicts
- If backend returns 409 because a session was created concurrently or PO became fully received between validation and create:
  - Show backend message; remain on create screen
  - Allow retry with a different identifier

## Unauthorized access
- Backend 403:
  - Show permission error
  - Do not retry automatically
  - Provide navigation back to Receiving landing

## Empty states
- Detail screen loads but lines array empty:
  - Show message: â€œNo expected lines were provided for this source document.â€
  - Still display session header for auditability

---

# 12. Acceptance Criteria

## Scenario 1: Create session from PO via manual entry
**Given** the Receiver is authenticated  
**And** a Purchase Order with identifier `PO-123` exists and is receivable (Open or Partially Received)  
**When** the Receiver navigates to Receiving â†’ Create Session  
**And** enters `PO-123` in the identifier field  
**And** clicks â€œCreate Sessionâ€  
**Then** the system creates a receiving session with status `Open`  
**And** the created session is tied to source document `PO-123`  
**And** the session detail screen is shown for the returned `receivingSessionId`  
**And** expected lines are displayed with `receivedQuantity = 0` for each line  
**And** the recorded entry method is `MANUAL` (as shown in response data or audit section if displayed)

## Scenario 2: Create session from ASN via scan
**Given** the Receiver is authenticated  
**And** an ASN with identifier `ASN-ABC-789` exists and is receivable  
**When** the Receiver navigates to the Create Session screen  
**And** scans a barcode that inputs `ASN-ABC-789` into the identifier field  
**And** clicks â€œCreate Sessionâ€  
**Then** a receiving session is created and displayed  
**And** the session is tied to `ASN-ABC-789`  
**And** the session lines are pre-populated from ASN expected lines  
**And** the recorded entry method is `SCAN`

## Scenario 3: Identifier not found
**Given** the Receiver is on the Create Session screen  
**When** the Receiver enters `PO-999`  
**And** clicks â€œCreate Sessionâ€  
**Then** the system shows an error message â€œSource document PO-999 not found.â€ (or backend-provided equivalent)  
**And** no navigation to session detail occurs  
**And** no receiving session is created

## Scenario 4: Source document already fully received/closed
**Given** the Receiver is on the Create Session screen  
**And** a Purchase Order `PO-456` exists but is Closed/Fully Received  
**When** the Receiver enters `PO-456` and submits  
**Then** the system shows an error message indicating it has already been fully received  
**And** no session is created

## Scenario 5: Blind receiving blocked
**Given** the Receiver is on the Create Session screen  
**When** the Receiver leaves the identifier blank  
**And** clicks â€œCreate Sessionâ€  
**Then** the system shows â€œReceiving requires a valid PO or ASN. Blind receiving is not supported.â€  
**And** no request is sent to create a session

## Scenario 6: Unauthorized user
**Given** the user lacks permission to create receiving sessions  
**When** they attempt to create a session for a valid identifier  
**Then** the system shows a permission error message  
**And** no session detail is shown

---

# 13. Audit & Observability

## User-visible audit data
- On Session Detail screen, display (if returned by service):
  - `createdAt`
  - `createdBy` (user id or name)
  - `sourceDocumentType` + `sourceDocumentId`
  - `entryMethod`

## Status history
- Out-of-scope to display full history unless backend already exposes it; do not implement new timeline here.

## Traceability expectations
- Frontend must include correlation/request id if Moqui provides it (e.g., via headers) in console logs only (no PII).
- Ensure session id is visible/copyable on detail screen for support/troubleshooting.

---

# 14. Non-Functional UI Requirements

- **Performance:** Create request should show loading state immediately; session detail should load within acceptable POS UX (<2s on typical network; if slower show skeleton/loading).
- **Accessibility:** Identifier input has label; errors announced via aria-live; buttons keyboard accessible; Enter submits when focus in input.
- **Responsiveness:** Works on tablet form factor; no reliance on hover interactions.
- **i18n/timezone/currency:** Timestamps displayed in user locale/timezone if available; no currency handling required.

---

# 15. Applied Safe Defaults

- SD-UX-ENTER-SUBMIT: Allow Enter key in identifier field to trigger Create when non-empty; qualifies as safe ergonomic default; impacts UX Summary, Functional Behavior, Acceptance Criteria (implicit).
- SD-UX-LOADING-DISABLE: Disable inputs/buttons during in-flight request and show loading indicator; safe to prevent duplicate submissions; impacts Functional Behavior, Error Flows.
- SD-ERR-HTTP-MAP: Standard mapping of 400/403/404/409/500 to user-actionable messages when backend message not provided; safe as generic error handling; impacts Business Rules, Service Contracts, Error Flows.

---

# 16. Open Questions

1. **Backend contract details (Moqui service vs REST):** What are the exact Moqui service names/paths and request/response schemas for:
   - create receiving session from source
   - load receiving session detail  
   (Needed to implement screen actions and data bindings precisely.)

2. **Source document type inference:** Should the frontend require the user to specify PO vs ASN, or will the backend infer `sourceDocumentType` from the identifier? If frontend must supply it, what is the UI rule (prefix-based, toggle, etc.)?

3. **Scan detection rule:** How should the frontend distinguish `entryMethod=SCAN` vs `MANUAL`?
   - Is there an existing scanner-input utility/pattern in this repo (e.g., timing-based keystroke heuristic, dedicated scan event)?
   - If none, should we record `MANUAL` always unless a dedicated scan event is wired?

4. **Session detail screen existence:** Is there already a receiving session detail screen/route in `durion-moqui-frontend` that should be extended instead of created anew? If yes, provide its path and parameter naming.

---

## Original Story (Unmodified â€“ For Traceability)

Title: [FRONTEND] [STORY] Receiving: Create Receiving Session from PO/ASN â€” URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/99


====================================================================================================

FRONTEND STORY (FULL CONTEXT)

====================================================================================================

Title: [FRONTEND] [STORY] Receiving: Create Receiving Session from PO/ASN
URL: https://github.com/louisburroughs/durion-moqui-frontend/issues/99
Labels: frontend, story-implementation, user

## Frontend Implementation for Story

**Original Story**: [STORY] Receiving: Create Receiving Session from PO/ASN

**Domain**: user

### Story Description

/kiro
# User Story
## Narrative
As a **Receiver**, I want to create a receiving session from a PO/ASN so that inbound items can be checked in.

## Details
- Session includes supplier/distributor, shipment ref, expected lines.
- Support scanning barcodes and capturing lot/serial (optional v1).

## Acceptance Criteria
- Receiving session created.
- Lines can be matched and variances captured.
- Session auditable.

## Integrations
- Positivity may provide ASN; product master maps items.

## Data / Entities
- ReceivingSession, ReceivingLine, SupplierRef, VarianceRecord

## Classification (confirm labels)
- Type: Story
- Layer: Domain
- Domain: Inventory Management


### Frontend Requirements

- Implement Vue.js 3 components with TypeScript
- Use Quasar framework for UI components
- Integrate with Moqui Framework backend
- Ensure responsive design and accessibility

### Technical Stack

- Vue.js 3 with Composition API
- TypeScript 5.x
- Quasar v2.x
- Moqui Framework integration

---
*This issue was automatically created by the Durion Workspace Agent*

====================================================================================================

