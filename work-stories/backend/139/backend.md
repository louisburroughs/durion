Title: [BACKEND] [STORY] Categories: Define Posting Categories and Mapping Keys
URL: https://github.com/louisburroughs/durion-positivity-backend/issues/139
Labels: general, type:story, domain:accounting, status:ready-for-dev

STOP: Clarification required before finalization
## üè∑Ô∏è Labels (Proposed)
### Required
- type:story
- domain:accounting
- status:draft

### Recommended
- agent:accounting
- agent:story-authoring

### Blocking / Risk
- blocked:clarification

---
**Rewrite Variant:** accounting-strict
---

## Story Intent
**As a** Financial Controller,
**I want to** define a centralized, auditable system of "Posting Categories" and map them to specific General Ledger (GL) accounts,
**so that** all financial events generated by producer systems (like POS) are consistently and accurately classified for automated journal entry creation.

This capability forms the foundational layer of the sub-ledger system, ensuring traceability and correctness for all financial reporting.

## Actors & Stakeholders
- **Financial Controller / Accountant**: The primary user responsible for defining, managing, and auditing the posting category and GL mapping rules.
- **System (Producer)**: Any internal service (e.g., POS, Inventory Management) that generates a financial event and needs to resolve a mapping key to the correct GL posting information.
- **Accounting System**: The consumer of these mappings, responsible for using them to generate journal entries in the General Ledger.
- **Auditor**: A stakeholder who needs a clear, immutable history of how financial mappings were configured and changed over time.

## Preconditions
- A Chart of Accounts (CoA) is defined and accessible within the system.
- The Financial Controller is authenticated and has the necessary permissions (`accounting.mappings.manage`) to configure posting categories and GL mappings.

## Functional Behavior

### 1. Management of Posting Categories
The Financial Controller can perform full CRUD (Create, Read, Update, Deactivate) operations on Posting Categories. A Posting Category is a business-friendly abstraction for a type of financial transaction (e.g., `REVENUE_LABOR`, `COGS_TIRES`, `PAYABLE_SALES_TAX_STATE`).

### 2. Management of Mapping Keys
The Financial Controller can define and manage mapping keys. These are stable, unique string identifiers that producer systems will use to look up posting instructions (e.g., `pos.sale.item.labor.standard_rate`). Each mapping key is deterministically linked to a single Posting Category.

### 3. Management of GL Mappings
The Financial Controller can create and manage the mapping from a Posting Category to a specific GL Account and its required dimensions (e.g., cost center, department).
- Each mapping must have an `effective_start_date`.
- An `effective_end_date` is optional; a null value implies the mapping is active indefinitely.
- The system must enforce that no two mappings for the same Posting Category have overlapping effective date ranges.

### 4. System Resolution of Mapping Keys
A producer system can query an endpoint with a mapping key and a transaction date. The system will:
1. Resolve the mapping key to its corresponding Posting Category.
2. Find the active GL mapping for that Posting Category based on the provided transaction date.
3. Return the correct GL Account and dimension information.

## Alternate / Error Flows
- **Invalid Key Resolution**: If a producer system requests resolution for a mapping key that does not exist, the system shall return a distinct "not found" error.
- **No Active Mapping**: If a key is resolved to a category but no active GL mapping exists for the given transaction date, the system shall return a distinct "unmappable transaction" error.
- **Overlapping Date Range**: If a user attempts to save a new GL mapping that has an effective date range overlapping with an existing mapping for the same Posting Category, the API shall reject the request with a `409 Conflict` error, clearly identifying the conflicting mapping.
- **Invalid GL Account**: If a user attempts to map a category to a GL Account ID that does not exist in the Chart of Accounts, the API shall reject the request with a `400 Bad Request` error.

## Business Rules
- Mapping keys must be unique system-wide.
- All changes to Posting Categories and their GL mappings must be immutable and create a new versioned record. Direct updates or hard deletes are prohibited.
- A Posting Category can only be deactivated, not deleted, to preserve historical integrity.
- A deactivated category cannot be used in new GL mappings.
- The resolution of a mapping key for a given date must be deterministic and idempotent.

## Data Requirements
### PostingCategory
- `posting_category_id` (UUID, PK)
- `category_code` (VARCHAR, UNIQUE, e.g., "REVENUE_LABOR")
- `description` (TEXT)
- `status` (ENUM: `ACTIVE`, `INACTIVE`)
- `created_at`, `updated_at`

### GLMapping
- `gl_mapping_id` (UUID, PK)
- `posting_category_id` (UUID, FK)
- `gl_account_id` (VARCHAR, FK to CoA)
- `dimensions` (JSONB or dedicated columns for e.g., `cost_center_id`, `department_id`)
- `effective_start_date` (DATE)
- `effective_end_date` (DATE, nullable)
- `created_at`
- `superseded_by_mapping_id` (UUID, FK, self-referential, nullable)

*Note: The original proposal of "Mapping Keys" is modeled here as `category_code` to ensure a deterministic 1:1 link between the producer's key and the category.*

## Acceptance Criteria
- **Given** a Financial Controller with valid permissions
  **When** they create a new Posting Category with code `REVENUE_PARTS` and description "Revenue from Parts Sales"
  **Then** the system successfully saves the new category with a status of `ACTIVE`.
- **Given** the `REVENUE_PARTS` posting category exists
  **When** the controller creates a new GL mapping for it to account `40010` with an `effective_start_date` of today
  **Then** the system saves the mapping and an audit event is logged.
- **Given** an active GL mapping exists for `REVENUE_PARTS` starting today
  **When** the controller attempts to create a second mapping for `REVENUE_PARTS` with an `effective_start_date` of yesterday
  **Then** the system rejects the request with a `409 Conflict` error message indicating an overlapping date range.
- **Given** a producer system needs to post a transaction for a parts sale
  **When** it requests the GL mapping for `REVENUE_PARTS` with today's date
  **Then** the system returns the details for GL account `40010`.
- **Given** a producer system requests a mapping for a non-existent code `COGS_WIDGETS`
  **When** the request is processed
  **Then** the system returns a `404 Not Found` error.
- **Given** the `REVENUE_PARTS` category is mapped starting next month
  **When** a producer system requests the mapping for `REVENUE_PARTS` with today's date
  **Then** the system returns an "unmappable transaction" error.

## Audit & Observability
- **Audit Trail**: Every creation or modification of a Posting Category or GL Mapping must generate an immutable audit log entry. The entry must capture the user ID, timestamp, the entity changed, and a snapshot of the change (before/after state or new state).
- **Metrics**: The mapping resolution service must emit metrics for:
  - `mapping.resolution.success.count`
  - `mapping.resolution.failure.count` (tagged by failure reason: `key_not_found`, `mapping_inactive_for_date`)
- **Alerting**: An alert should be configured to trigger if the rate of `mapping.resolution.failure.count` exceeds a predefined threshold over a 5-minute window.

## Open Questions
1.  **Overlap Policy**: What is the precise business policy for handling date-range overlaps? Should creating a new mapping with a start date automatically set the end date of the previous mapping, or should it always be an explicit rejection requiring manual correction?
2.  **Unmappable Transaction Handling**: What is the required system-wide behavior for an unmappable transaction? Should it fail the entire operation at the source (e.g., block the sale at the POS), or should it post to a pre-defined "Suspense Account" for later reconciliation?
3.  **Required Dimensions**: What is the definitive list of financial dimensions that must be captured in a GL mapping alongside the GL Account (e.g., Department, Location, Project Code)?

---
## Original Story (Unmodified ‚Äì For Traceability)
# Issue #139 ‚Äî [BACKEND] [STORY] Categories: Define Posting Categories and Mapping Keys

## Current Labels
- backend
- story-implementation
- general

## Current Body
## Backend Implementation for Story

**Original Story**: [STORY] Categories: Define Posting Categories and Mapping Keys

**Domain**: general

### Story Description

/kiro
# Functional Requirement

## Classification (confirm labels)
- Type: story
- Layer: functional
- Domain: accounting

## Capability
[CAP] Maintain Chart of Accounts and Posting Categories

## Story
Categories: Define Posting Categories and Mapping Keys

## Acceptance Criteria
- [ ] Posting categories exist for business meaning (Labor Revenue, Sales Tax Payable, COGS Tires, etc.)
- [ ] Mapping keys used by producers resolve deterministically to categories
- [ ] Category‚ÜíAccount/Dimensions mappings are effective-dated and audit-logged
- [ ] Invalid/overlapping mappings are rejected per policy


### Backend Requirements

- Implement Spring Boot microservices
- Create REST API endpoints
- Implement business logic and data access
- Ensure proper security and validation

### Technical Stack

- Spring Boot 3.2.6
- Java 21
- Spring Data JPA
- PostgreSQL/MySQL

---
*This issue was automatically created by the Durion Workspace Agent*