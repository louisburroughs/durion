Title: [BACKEND] [STORY] Fulfillment: Mechanic Executes Picking (Scan + Confirm)
URL: https://github.com/louisburroughs/durion-positivity-backend/issues/179
Labels: type:story, domain:workexec, status:needs-review, agent:story-authoring, agent:workexec

## üè∑Ô∏è Labels (Proposed)
### Required
- type:story
- domain:workexec
- status:needs-review

### Recommended
- agent:workexec
- agent:story-authoring

---\n**Rewrite Variant:** workexec-structured\n---\n\n## Story Intent\nAs a Mechanic, I need to scan and confirm the parts from a picking list for a specific work order, so that the parts are accurately tracked, inventory is updated in real-time, and the items are officially assigned to the job before I begin work.\n\n## Actors & Stakeholders\n- **Mechanic (Primary Actor):** The user performing the physical and digital picking process.\n- **System (System Actor):** The Workshop/POS system that facilitates the picking workflow, validates scans, and updates records.\n- **Inventory Manager (Stakeholder):** Relies on accurate, real-time stock level updates resulting from the picking process.\n- **Service Advisor (Stakeholder):** Monitors the work order's progress, which includes the completion of the parts picking stage.\n\n## Preconditions\n1.  The Mechanic is authenticated and has the appropriate permissions to execute work order tasks.\n2.  A `Work Order` exists and is in a state that permits parts picking (e.g., `WORK_AUTHORIZED`).\n3.  A `Picking List` has been generated for the `Work Order` and is in a `PENDING_PICK` state.\n4.  The items on the `Picking List` have a corresponding inventory status of `ALLOCATED` to this `Work Order`.\n\n## Functional Behavior\n1.  **Trigger:** The Mechanic initiates the \"Pick Parts\" action for a specific `Work Order` within the system (e.g., on a mobile terminal or workstation).\n2.  The System displays the `Picking List` associated with the `Work Order`, showing the required items and quantities.\n3.  The Mechanic physically gathers the parts and scans the barcode or QR code of the first item.\n4.  The System receives the scanned identifier and validates it against the `Picking List`.\n5.  **On successful validation:**\n    - The System updates the UI to indicate the item has been successfully scanned.\n    - The system increments the `pickedQuantity` for that `PickingListItem`.\n6.  The Mechanic continues this process until all items and their required quantities are scanned.\n7.  The mechanic can choose to save the current picking session and continue later.\n8.  Once all items are scanned, the Mechanic uses a \"Confirm Pick\" action in the system.\n9.  **On confirmation:**\n    - The System performs a final validation to ensure all required items/quantities are accounted for.\n    - The System transitions the `Picking List` status from `PENDING_PICK` to `COMPLETED`.\n    - The System triggers updates to the `Inventory` service to transition the status of the picked items from `ALLOCATED` to `DISBURSED_TO_WORK_ORDER` and then to `PICKED_TO_WORK_ORDER`.\n    - The System may update the parent `Work Order` status (e.g., to `READY_FOR_WORK`).\n\n## Alternate / Error Flows\n- **Error: Scanned Item Not on Picking List**\n  - **Trigger:** Mechanic scans an item barcode that is not associated with any item on the current `Picking List`.\n  - **System Response:** The System rejects the scan and displays an audible and/or visual error message: \"Invalid Item: This item is not on the picking list.\" The state of the picking list remains unchanged.\n\n- **Error: Quantity Exceeded**\n  - **Trigger:** Mechanic scans an item for which the `pickedQuantity` already equals the `requiredQuantity`.\n  - **System Response:** The System rejects the scan and displays an error: \"Quantity Met: The required quantity for this item has already been picked.\"\n\n- **Error: Attempt to Confirm Incomplete Pick**\n  - **Trigger:** Mechanic selects \"Confirm Pick\" before all required items on the list have been scanned.\n  - **System Response:** The System rejects the confirmation and displays a message indicating which items are still pending: \"Confirmation Failed: Please pick all required items before confirming.\"\n\n- **Error: Item Not Found**\n  - **Trigger:** Mechanic cannot find a part on the shelf that is listed as `ALLOCATED`.\n  - **System Response:** The Mechanic can flag the item as `NOT_FOUND` from the UI. The system will record this exception and notify the Inventory Manager. The `PickingListItem` will be marked as `NOT_FOUND`.\n\n- **User Action: Cancel Picking Process**\n  - **Trigger:** Mechanic cancels the picking session before confirming.\n  - **System Response:** The System discards the current session's progress (i.e., resets any temporarily stored `pickedQuantity` counts) and reverts the `Picking List` to its previous state (`PENDING_PICK`). No inventory changes are committed.\n\n## Business Rules\n- A `Picking List` can be partially picked. The mechanic can save the current progress and continue picking later. Each picking session will be tracked, and the inventory will be updated accordingly.\n- Upon successful confirmation of a `Picking List`, the corresponding inventory records for the picked items must be transactionally updated to reflect their new state.\n- A unique, auditable event must be recorded for every completed picking confirmation.\n- The system must prevent the same physical item from being picked for two different work orders simultaneously.\n\n## Data Requirements\n- **`PickingList`**\n  - `pickingListId` (PK)\n  - `workOrderId` (FK)\n  - `status` (Enum: `PENDING_PICK`, `PARTIALLY_PICKED`, `COMPLETED`, `CANCELLED`)\n  - `assigneeId` (FK to User/Mechanic, optional)\n- **`PickingListItem`**\n  - `pickingListItemId` (PK)\n  - `pickingListId` (FK)\n  - `itemId` (FK)\n  - `requiredQuantity` (Integer)\n  - `pickedQuantity` (Integer)\n  - `status` (Enum: `PENDING`, `PICKED`, `NOT_FOUND`)\n- **Required Input for Endpoint (e.g., `POST /picking-lists/{id}/confirm`)**\n  - `pickingListId`\n  - A collection of picked items with identifiers (e.g., `scannedBarcode`) and quantities.\n\n## Acceptance Criteria\n**AC1: Successful Full Pick and Confirmation**\n- **Given** a `Work Order` with a `Picking List` in `PENDING_PICK` state, requiring 2 units of Item A and 1 unit of Item B.\n- **And** the corresponding inventory for these items is `ALLOCATED`.\n- **When** the Mechanic scans two units of Item A and one unit of Item B.\n- **And** the Mechanic confirms the completed pick.\n- **Then** the System successfully validates the pick.\n- **And** the `Picking List` status transitions to `COMPLETED`.\n- **And** the inventory status for the 3 items transitions from `ALLOCATED` to `DISBURSED_TO_WORK_ORDER` and then to `PICKED_TO_WORK_ORDER`.\n- **And** an audit event for the completed pick is created.\n\n**AC2: Scan of an Item Not on the List**\n- **Given** a `Picking List` that does not include Item C.\n- **When** the Mechanic scans the barcode for Item C.\n- **Then** the System displays an \"Invalid Item\" error message.\n- **And** the state of the `Picking List` and its items remains unchanged.\n\n**AC3: Attempt to Over-Pick an Item**\n- **Given** a `Picking List` requires 1 unit of Item A, and it has already been scanned.\n- **When** the Mechanic scans Item A again.\n- **Then** the System displays a \"Quantity Met\" error message.\n- **And** the `pickedQuantity` for Item A remains 1.\n\n**AC4: Attempt to Confirm an Incomplete Pick**\n- **Given** a `Picking List` requires 2 units of Item A, but only 1 unit has been scanned.\n- **When** the Mechanic attempts to confirm the pick.\n- **Then** the System displays an \"Incomplete Pick\" error message, highlighting that Item A is still pending.\n- **And** the `Picking List` status remains `PENDING_PICK`.\n\n**AC5: Partial Pick and Save**\n- **Given** a `Work Order` with a `Picking List` in `PENDING_PICK` state, requiring 2 units of Item A and 1 unit of Item B.\n- **When** the Mechanic scans one unit of Item A.\n- **And** the Mechanic chooses to save the session.\n- **Then** the `Picking List` status transitions to `PARTIALLY_PICKED`.\n- **And** the `pickedQuantity` for Item A is 1.\n- **And** the inventory status for the picked item is updated.\n\n**AC6: Item Not Found**\n- **Given** a `Picking List` requires 1 unit of Item D.\n- **When** the Mechanic cannot find the item and flags it as `NOT_FOUND`.\n- **Then** the `PickingListItem` for Item D is marked as `NOT_FOUND`.\n- **And** a notification is sent to the Inventory Manager.\n\n## Audit & Observability\n- **Audit Trail:** An immutable audit log entry must be created upon every successful `Picking List` confirmation. The entry must include:\n  - `eventId`\n  - `timestamp`\n  - `eventType`: `PICKING_LIST_CONFIRMED`\n  - `userId` (Mechanic who performed the action)\n  - `workOrderId`\n  - `pickingListId`\n  - `payload`: A list of all `itemId` and `quantity` that were picked.\n- **Logging:** Structured logs (e.g., JSON) should be generated for key steps: `picking_session_started`, `item_scan_validated`, `item_scan_failed`, `picking_confirmation_attempted`, `picking_confirmation_succeeded`, `picking_session_saved`.\n- **Metrics:**\n  - `picking_lists_completed_total`: A counter for successfully completed picking lists.\n  - `picking_lists_partial_total`: A counter for partially picked lists.\n  - `picking_scan_errors_total`: A counter for failed scans, tagged by error type (e.g., `invalid_item`, `quantity_exceeded`).\n  - `picking_item_not_found_total`: A counter for items flagged as not found.\n  - `picking_confirmation_duration_seconds`: A histogram measuring the time from initiation to confirmation.\n- **Events:** A domain event `workexec.PickingListCompleted` should be published to a message bus upon successful completion for consumption by other domains like Inventory and Billing. A `workexec.PickingListPartial` event should be published when a partial pick is saved.