# Domain Business Rules Updater (Consolidated)

## Purpose

Updates or creates domain business rules documentation (`AGENT_GUIDE.md`, `DOMAIN_NOTES.md`, and `STORY_VALIDATION_CHECKLIST.md`) by analyzing consolidated domain story files and existing documentation using OpenAI's LLM.

This version is designed to:
1. Read consolidated stories from `story-output-consolidation/output/domain-*.txt`
2. Load existing business rules from `durion/domains/{domain}/.business-rules/`
3. Extract open questions from the consolidated stories
4. Generate or **enhance** all three business rules documents
5. Output updated documents to `story-output-consolidation/output/{domain}/.business-rules/`

## Key Differences from Original Script

| Aspect | Original | Consolidated |
|--------|----------|--------------|
| **Input stories** | `story-work/output/domain-*.txt` | `story-output-consolidation/output/domain-*.txt` |
| **Output location** | `durion/domains/{domain}/.business-rules/` | `story-output-consolidation/output/{domain}/.business-rules/` |
| **Documents** | AGENT_GUIDE.md + STORY_VALIDATION_CHECKLIST.md | AGENT_GUIDE.md + DOMAIN_NOTES.md + STORY_VALIDATION_CHECKLIST.md |
| **Reference docs** | Uses output location as reference | Uses `durion/domains/` as reference for existing docs |
| **Update mode** | Updates documents in place | Creates output set while preserving reference originals |

## Overview

This script:
1. Reads consolidated frontend stories from `story-output-consolidation/output/domain-*.txt`
2. Loads existing AGENT_GUIDE.md, DOMAIN_NOTES.md, and STORY_VALIDATION_CHECKLIST.md from `durion/domains/{domain}/.business-rules/` (if present)
3. Extracts Open Questions from all stories in the consolidated domain file
4. Calls OpenAI LLM 3 times to generate/enhance each document
5. Writes updated docs to `story-output-consolidation/output/{domain}/.business-rules/`

## Prerequisites

- OpenAI API key (set `OPENAI_API_KEY` environment variable)
- `curl` and `jq` installed
- Consolidated story files in `scripts/story-output-consolidation/output/` (generated by consolidation workflow)
- Existing domain documentation in `durion/domains/{domain}/.business-rules/` (optional; will create new if not present)

## Usage

```bash
cd /home/louisb/Projects/durion/scripts/story-output-consolidation

# Set your OpenAI API key
export OPENAI_API_KEY="sk-..."

# Process all domains with defaults
./update-domain-business-rules-consolidated.sh

# Process a single domain
./update-domain-business-rules-consolidated.sh --domain inventory

# Use custom model and longer delay
./update-domain-business-rules-consolidated.sh \
  --model gpt-4o \
  --delay 5 \
  --max-tokens 20000

# Dry run to see what would be done
./update-domain-business-rules-consolidated.sh --dry-run
```

## Options

| Option | Default | Description |
|--------|---------|-------------|
| `--input-dir DIR` | `./output` | Directory containing consolidated domain-*.txt files |
| `--output-dir DIR` | `./output` | Output directory for updated business rules |
| `--domains-ref DIR` | `../../../domains` | Reference directory containing existing domain docs (durion/domains/) |
| `--model MODEL` | `gpt-5.2` | OpenAI model to use |
| `--api-base URL` | `https://api.openai.com/v1` | OpenAI API base URL |
| `--domain NAME` | (all) | Process only this domain (e.g., `inventory`) |
| `--max-chars N` | `150000` | Max characters from story file to send |
| `--max-tokens N` | `18000` | Max tokens for LLM response |
| `--delay SECONDS` | `2` | Delay between API calls (rate limiting) |
| `--dry-run` | false | Show what would be done without calling API |
| `-h, --help` | - | Show help |

## Environment Variables

- `OPENAI_API_KEY` (required): Your OpenAI API key
- `OPENAI_MODEL` (optional): Default model (can be overridden with `--model`)
- `OPENAI_API_BASE` (optional): Custom API endpoint
- `OPENAI_ORG` (optional): OpenAI organization ID

## Output Structure

For each domain, the script creates:

```
story-output-consolidation/output/{domain}/.business-rules/
├── AGENT_GUIDE.md
├── DOMAIN_NOTES.md
└── STORY_VALIDATION_CHECKLIST.md
```

### AGENT_GUIDE.md

**Normative** guide for domain agents including:
- Domain purpose and boundaries (system of record, owned responsibilities, integration points)
- Key entities and concepts (with authoritative descriptions)
- Business rules and invariants (decision references where applicable)
- Event patterns and integrations (canonical event contracts)
- API expectations and contracts
- Security/authorization guidance
- Observability requirements (metrics, traces, attributes)
- Testing strategies
- Common pitfalls
- **Open Questions from Frontend Stories** (consolidated)

All existing content is preserved; new information is integrated into the structure.

### DOMAIN_NOTES.md

**Non-normative** exploratory and rationale documentation:
- Architectural philosophy and goals
- Decision log with tradeoffs and rejected alternatives
- Institutional memory about why decisions were made
- Known issues and risks
- Future considerations
- Living document capturing exploration

This complements (not duplicates) the normative AGENT_GUIDE.md.

### STORY_VALIDATION_CHECKLIST.md

**Actionable** checklist for validating story implementations:
- Scope and ownership verification
- Data model and validation rules
- API contract compliance
- Event handling and idempotency
- Security checks
- Observability requirements
- Performance and failure mode considerations
- Testing coverage
- Documentation completeness
- **Open Questions to Resolve** (validation-relevant)

Designed as a working checklist for story reviewers.

## How It Works

### 1. Story Input
Reads consolidated stories from `story-output-consolidation/output/domain-{name}.txt`
(created by `consolidate-stories-by-domain.sh`).

### 2. Reference Existing Docs
Loads any existing documentation from `durion/domains/{domain}/.business-rules/`:
- If found: LLM is asked to **enhance** the existing documents
- If not found: LLM is asked to **create new** documents from scratch
- Reference docs are NOT modified; they are only used as input

### 3. Open Questions Extraction
Scans consolidated stories for all `## Open Questions` sections and extracts them
for consolidation into the output documents.

### 4. LLM Processing
Calls OpenAI in sequence (with delays to respect rate limits):
1. **AGENT_GUIDE.md**: Updated normative guidance
2. **DOMAIN_NOTES.md**: Updated non-normative rationale
3. **STORY_VALIDATION_CHECKLIST.md**: Updated actionable checklist

Each call includes:
- System prompt (senior staff engineer persona)
- Existing documentation (if any) for reference
- New consolidated stories
- Consolidated open questions
- Specific instructions for that document type

### 5. Output to Separate Location
All updated documents are written to `story-output-consolidation/output/{domain}/.business-rules/`
while preserving original files in `durion/domains/{domain}/.business-rules/`.

This allows for review and comparison before promoting updates back to the canonical location.

### 6. Rate Limiting
Adds configurable delay between API calls (default: 2 seconds) to respect OpenAI rate limits.

## Example Run

```bash
$ export OPENAI_API_KEY="sk-..."
$ cd /home/louisb/Projects/durion/scripts/story-output-consolidation
$ ./update-domain-business-rules-consolidated.sh --domain inventory --delay 3

═══════════════════════════════════════════════════════════════
Domain Business Rules Updater (Consolidated)
═══════════════════════════════════════════════════════════════
Input: ./output
Output: ./output
Domains reference: ../../../domains
Model: gpt-5.2
Max tokens: 18000
Delay between calls: 3s
═══════════════════════════════════════════════════════════════
Found 1 domain files to process

═══════════════════════════════════════════════════════════════
Processing domain: inventory
═══════════════════════════════════════════════════════════════
[INFO] Reading consolidated stories from: ./output/domain-inventory.txt
[INFO] Output directory: ./output/inventory/.business-rules
[INFO] Found existing AGENT_GUIDE.md (will enhance)
[INFO] Found existing DOMAIN_NOTES.md (will enhance)
[INFO] Found existing STORY_VALIDATION_CHECKLIST.md (will enhance)
[INFO] Extracting open questions from consolidated stories...
[INFO] Found 8 Open Questions sections
[INFO] Calling OpenAI API for AGENT_GUIDE.md...
[OK] Enhanced: ./output/inventory/.business-rules/AGENT_GUIDE.md
[INFO] Waiting 3s before next API call...
[INFO] Calling OpenAI API for DOMAIN_NOTES.md...
[OK] Enhanced: ./output/inventory/.business-rules/DOMAIN_NOTES.md
[INFO] Waiting 3s before next API call...
[INFO] Calling OpenAI API for STORY_VALIDATION_CHECKLIST.md...
[OK] Enhanced: ./output/inventory/.business-rules/STORY_VALIDATION_CHECKLIST.md

═══════════════════════════════════════════════════════════════
Summary
═══════════════════════════════════════════════════════════════
Processed: 1
Failed: 0
═══════════════════════════════════════════════════════════════
Done.
```

## Token Considerations

- Default max_tokens: **18000** (larger than original 16000 to accommodate DOMAIN_NOTES)
- Input is truncated to 150KB per domain file if needed (larger than original 120KB)
- Large domains (e.g., workexec with 53+ stories) may hit token limits
- Consider using `--max-chars` to reduce input size for very large domains

## Cost Estimation

With gpt-5.2 pricing (as of January 2026):
- ~13 domains × 3 API calls = 39 API calls
- Average ~60K input tokens per call (larger due to 3 docs + stories)
- Average ~10K output tokens per call
- Estimated cost: $5-10 per complete run (varies by model and story count)

## Error Handling

The script:
- Validates required dependencies (curl, jq)
- Checks for OPENAI_API_KEY
- Verifies input and output directories exist
- Handles HTTP errors from OpenAI API
- Skips empty domain files
- Reports failed domains at the end
- Exits with code 1 if any failures occurred

## Workflow Integration

This script fits into the larger workflow:

1. **Consolidate stories by domain** (creates `domain-*.txt` files in `story-output-consolidation/output/`)
   ```bash
   cd /home/louisb/Projects/durion/scripts
   ./consolidate-stories-by-domain.sh
   ```

2. **Update business rules** (this script - creates enhanced docs in `story-output-consolidation/output/{domain}/.business-rules/`)
   ```bash
   cd /home/louisb/Projects/durion/scripts/story-output-consolidation
   ./update-domain-business-rules-consolidated.sh
   ```

3. **Review output** - Compare generated docs with originals

4. **Promote updates** (optional) - Copy enhanced docs back to `durion/domains/{domain}/.business-rules/` when ready
   ```bash
   cp -r output/{domain}/.business-rules/* ../../domains/{domain}/.business-rules/
   ```

## Related Scripts

- [consolidate-stories-by-domain.sh](../consolidate-stories-by-domain.sh) - Creates consolidated domain-*.txt files
- [update-domain-business-rules.sh](../update-domain-business-rules.sh) - Original in-place updater
- [publish_stories.py](../publish_stories.py) - Publishes stories to GitHub

## Troubleshooting

### "Missing required env var: OPENAI_API_KEY"
Set your OpenAI API key:
```bash
export OPENAI_API_KEY="sk-..."
```

### "OpenAI API error (HTTP 429)"
Rate limit exceeded. Increase delay:
```bash
./update-domain-business-rules-consolidated.sh --delay 10
```

### "Empty response for domain"
- Check token limits (may need to increase `--max-tokens`)
- Verify API key is valid
- Check OpenAI service status
- Review LLM output in error message for details

### Input/output directory issues
Script runs from `story-output-consolidation` directory by default. Specify paths explicitly if needed:
```bash
./update-domain-business-rules-consolidated.sh \
  --input-dir /absolute/path/to/output \
  --output-dir /absolute/path/to/output \
  --domains-ref /absolute/path/to/durion/domains
```

### No domains to process
Ensure consolidated domain files exist:
```bash
ls story-output-consolidation/output/domain-*.txt
```

If missing, run consolidation script first:
```bash
cd /home/louisb/Projects/durion/scripts
./consolidate-stories-by-domain.sh
```

## Review & Promotion Workflow

After running the script:

1. **Review differences** between output and originals:
   ```bash
   diff -u ../../domains/inventory/.business-rules/AGENT_GUIDE.md \
           output/inventory/.business-rules/AGENT_GUIDE.md
   ```

2. **Test in agents** - Use output docs with domain agents to validate

3. **Promote when ready** - Copy to canonical location:
   ```bash
   cp output/inventory/.business-rules/*.md ../../domains/inventory/.business-rules/
   git add ../../domains/inventory/.business-rules/
   git commit -m "Update inventory domain docs with new questions answered"
   ```

## Future Enhancements

- Add `--compare` flag to automatically show diffs between output and reference
- Add `--promote` flag to auto-copy validated updates to canonical location
- Support for custom LLM prompts (--prompt-guide, --prompt-notes, --prompt-checklist)
- Parallel API calls for domains (with rate limit awareness)
- Metrics output (token usage, cost estimate, etc.)
